const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CQGa4boa.js","assets/matrix-sdk-crypto-wasm-Cv812ZGl.js"])))=>i.map(i=>d[i]);
function sD(i,e){for(var t=0;t<e.length;t++){const n=e[t];if(typeof n!="string"&&!Array.isArray(n)){for(const r in n)if(r!=="default"&&!(r in i)){const a=Object.getOwnPropertyDescriptor(n,r);a&&Object.defineProperty(i,r,a.get?a:{enumerable:!0,get:()=>n[r]})}}}return Object.freeze(Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}))}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();function Cf(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function Tq(i){if(Object.prototype.hasOwnProperty.call(i,"__esModule"))return i;var e=i.default;if(typeof e=="function"){var t=function n(){var r=!1;try{r=this instanceof n}catch{}return r?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(i).forEach(function(n){var r=Object.getOwnPropertyDescriptor(i,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return i[n]}})}),t}var vp={exports:{}},gc={};var JT;function oD(){if(JT)return gc;JT=1;var i=Symbol.for("react.transitional.element"),e=Symbol.for("react.fragment");function t(n,r,a){var o=null;if(a!==void 0&&(o=""+a),r.key!==void 0&&(o=""+r.key),"key"in r){a={};for(var c in r)c!=="key"&&(a[c]=r[c])}else a=r;return r=a.ref,{$$typeof:i,type:n,key:o,ref:r!==void 0?r:null,props:a}}return gc.Fragment=e,gc.jsx=t,gc.jsxs=t,gc}var YT;function lD(){return YT||(YT=1,vp.exports=oD()),vp.exports}var _q=lD();function $T(i,e,t,n,r,a,o){try{var c=i[a](o),d=c.value}catch(h){return void t(h)}c.done?e(d):Promise.resolve(d).then(n,r)}function A(i){return function(){var e=this,t=arguments;return new Promise(function(n,r){var a=i.apply(e,t);function o(d){$T(a,n,r,o,c,"next",d)}function c(d){$T(a,n,r,o,c,"throw",d)}o(void 0)})}}function nu(i){"@babel/helpers - typeof";return nu=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},nu(i)}function cD(i,e){if(nu(i)!="object"||!i)return i;var t=i[Symbol.toPrimitive];if(t!==void 0){var n=t.call(i,e);if(nu(n)!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(i)}function uD(i){var e=cD(i,"string");return nu(e)=="symbol"?e:e+""}function b(i,e,t){return(e=uD(e))in i?Object.defineProperty(i,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):i[e]=t,i}const dD="l",hD="rn",fD={0:"O",1:"l","֭":"֖","֮":"֘","֨":"֙","֤":"֚","᪴":"ۛ","⃛":"ۛ","ؙ":"̓","ࣳ":"̓","̓":"̓","̕":"̓","ُ":"̓","ٝ":"̔","֜":"́","֝":"́","ؘ":"́","݇":"́","́":"́","॔":"́","َ":"́","̀":"̀","॓":"̀","̌":"̆","꙼":"̆","٘":"̆","ٚ":"̆","ͮ":"̆","ۨ":"̆̇","̐":"̆̇","ँ":"̆̇","ঁ":"̆̇","ઁ":"̆̇","ଁ":"̆̇","ఀ":"̆̇","ಁ":"̆̇","ഁ":"̆̇","𑒿":"̆̇","᳐":"̂","̑":"̂","ٛ":"̂","߮":"̂","꛰":"̂","֯":"̊","۟":"̊","៓":"̊","゚":"̊","ْ":"̊","ஂ":"̊","ံ":"̊","ំ":"̊","𑌀":"̊","ํ":"̊","ໍ":"̊","ͦ":"̊","ⷪ":"̊","࣫":"̈","߳":"̈","ً":"̋","ࣰ":"̋","͂":"̃","ٓ":"̃","ׄ":"̇","۬":"̇","݀":"̇","࣪":"̇","݁":"̇","͘":"̇","ֹ":"̇","ֺ":"̇","ׂ":"̇","ׁ":"̇","߭":"̇","ं":"̇","ਂ":"̇","ં":"̇","்":"̇","̷":"̸","᪷":"̨","̢":"̨","ͅ":"̨","᳒":"̄","̅":"̄","ٙ":"̄","߫":"̄","꛱":"̄","᳚":"̎","ٗ":"̒","͗":"͐","ࣿ":"͐","ࣸ":"͐","ऀ":"͒","᳭":"̖","᳜":"̩","ٖ":"̩","᳕":"̫","͇":"̳","ࣹ":"͔","ࣺ":"͕","゛":"ﾞ","゜":"ﾟ","̶":"̵","〬":"̉","ׅ":"̣","࣭":"̣","᳝":"̣","ִ":"̣","ٜ":"̣","़":"̣","়":"̣","਼":"̣","઼":"̣","଼":"̣","𑇊":"̣","𑓃":"̣","𐨺":"̣","࣮":"̤","᳞":"̤","༷":"̥","〭":"̥","̧":"̦","̡":"̦","̹":"̦","᳙":"̭","᳘":"̮","॒":"̱","̠":"̱","ࣱ":"ٌ","ࣨ":"ٌ","ࣥ":"ٌ",ﱞ:"ﹲّ","ࣲ":"ٍ",ﱟ:"ﹴّ",ﳲ:"ﹷّ",ﱠ:"ﹶّ",ﳳ:"ﹹّ",ﱡ:"ﹸّ","ؚ":"ِ","̗":"ِ",ﳴ:"ﹻّ",ﱢ:"ﹺّ",ﱣ:"ﹼٰ","ٟ":"ٕ","̍":"ٰ","݂":"ܼ","ਃ":"ঃ","ః":"ঃ","ಃ":"ঃ","ഃ":"ঃ","ඃ":"ঃ","း":"ঃ","𑓁":"ঃ","់":"่","່":"่","້":"้","໊":"๊","໋":"๋","꙯":"⃩","\u2028":" ","\u2029":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" ","ߺ":"_","﹍":"_","﹎":"_","﹏":"_","‐":"-","‑":"-","‒":"-","–":"-","﹘":"-","۔":"-","⁃":"-","˗":"-","−":"-","➖":"-","Ⲻ":"-","⨩":"-̓","⸚":"-̈","﬩":"-̇","∸":"-̇","⨪":"-̣","꓾":"-.","～":"〜","؍":",","٫":",","‚":",","¸":",","ꓹ":",","⸲":"،","٬":"،",";":";","⸵":"؛","ः":":","ઃ":":","：":":","։":":","܃":":","܄":":","᛬":":","︰":":","᠃":":","᠉":":","⁚":":","׃":":","˸":":","꞉":":","∶":":",ː:":","ꓽ":":","⩴":"::=","⧴":":→","！":"!",ǃ:"!","ⵑ":"!","‼":"!!","⁉":"!?",ʔ:"?","Ɂ":"?","ॽ":"?",Ꭾ:"?","ꛫ":"?","⁈":"?!","⁇":"??","⸮":"؟","𝅭":".","․":".","܁":".","܂":".","꘎":".","𐩐":".","٠":".","۰":".","ꓸ":".","ꓻ":".,","‥":"..","ꓺ":"..","…":"...","꛴":"꛳꛳","・":"·","･":"·","᛫":"·","·":"·","⸱":"·","𐄁":"·","•":"·","‧":"·","∙":"·","⋅":"·","ꞏ":"·",ᐧ:"·","⋯":"···","ⵈ":"···",ᑄ:"·<","⋗":"·>",ᐷ:"·>",ᑀ:"·>",ᔯ:"·4",ᑾ:"·b",ᒀ:"·ḃ",ᑺ:"·d",ᒘ:"·J",ᒶ:"·L",ᑶ:"·P",ᑗ:"·U",ᐺ:"·V",ᐼ:"·Ʌ",ᒮ:"·Γ",ᐎ:"·Δ",ᑙ:"·Ո",ᐌ:"·ᐁ",ᐐ:"·ᐄ",ᐒ:"·ᐅ",ᐔ:"·ᐆ",ᐗ:"·ᐊ",ᐙ:"·ᐋ",ᐾ:"·ᐲ",ᑂ:"·ᐴ",ᑆ:"·ᐹ",ᑛ:"·ᑏ",ᑔ:"·ᑐ",ᑝ:"·ᑐ",ᑟ:"·ᑑ",ᑡ:"·ᑕ",ᑣ:"·ᑖ",ᑴ:"·ᑫ",ᑸ:"·ᑮ",ᑼ:"·ᑰ",ᒒ:"·ᒉ",ᒔ:"·ᒋ",ᒖ:"·ᒌ",ᒚ:"·ᒎ",ᒜ:"·ᒐ",ᒞ:"·ᒑ",ᒬ:"·ᒣ",ᒰ:"·ᒦ",ᒲ:"·ᒧ",ᒴ:"·ᒨ",ᒸ:"·ᒫ",ᓉ:"·ᓀ","ᣆ":"·ᓂ","ᣈ":"·ᓃ","ᣊ":"·ᓄ","ᣌ":"·ᓅ",ᓋ:"·ᓇ",ᓍ:"·ᓈ",ᓜ:"·ᓓ",ᓞ:"·ᓕ",ᓠ:"·ᓖ",ᓢ:"·ᓗ",ᓤ:"·ᓘ",ᓦ:"·ᓚ",ᓨ:"·ᓛ",ᓶ:"·ᓭ",ᓸ:"·ᓯ",ᓺ:"·ᓰ",ᓼ:"·ᓱ",ᓾ:"·ᓲ",ᔀ:"·ᓴ",ᔂ:"·ᓵ",ᔗ:"·ᔐ",ᔙ:"·ᔑ",ᔛ:"·ᔒ",ᔝ:"·ᔓ",ᔟ:"·ᔔ",ᔡ:"·ᔕ",ᔣ:"·ᔖ",ᔱ:"·ᔨ",ᔳ:"·ᔩ",ᔵ:"·ᔪ",ᔷ:"·ᔫ",ᔹ:"·ᔭ",ᔻ:"·ᔮ","ᣎ":"·ᕃ","ᣏ":"·ᕆ","ᣐ":"·ᕇ","ᣑ":"·ᕈ","ᣒ":"·ᕉ","ᣓ":"·ᕋ",ᕎ:"·ᕌ",ᕛ:"·ᕚ",ᕨ:"·ᕧ","ᢳ":"·ᢱ","ᢶ":"·ᢴ","ᢹ":"·ᢸ","ᣂ":"·ᣀ","꠰":"।","॥":"।।","᰼":"᰻᰻","။":"၊၊","᪩":"᪨᪨","᪫":"᪪᪨","᭟":"᭞᭞","𐩗":"𐩖𐩖","𑑌":"𑑋𑑋","𑙂":"𑙁𑙁","𑱂":"𑱁𑱁","᱿":"᱾᱾","՝":"'","＇":"'","‘":"'","’":"'","‛":"'","′":"'","‵":"'","՚":"'","׳":"'","`":"'","`":"'","｀":"'","´":"'","΄":"'","´":"'","᾽":"'","᾿":"'","῾":"'","ʹ":"'","ʹ":"'","ˈ":"'","ˊ":"'","ˋ":"'","˴":"'",ʻ:"'",ʽ:"'",ʼ:"'",ʾ:"'","ꞌ":"'",י:"'","ߴ":"'","ߵ":"'",ᑊ:"'",ᛌ:"'","𖽑":"'","𖽒":"'","᳓":"''",'"':"''","＂":"''","“":"''","”":"''","‟":"''","″":"''","‶":"''","〃":"''","״":"''","˝":"''","ʺ":"''","˶":"''",ˮ:"''",ײ:"''","‴":"'''","‷":"'''","⁗":"''''",Ɓ:"'B",Ɗ:"'D",ŉ:"'n",Ƥ:"'P",Ƭ:"'T",Ƴ:"'Y","［":"(","❨":"(","❲":"(","〔":"(","﴾":"(","⸨":"((","㈠":"(ー)","⑵":"(2)","⒇":"(2O)","⑶":"(3)","⑷":"(4)","⑸":"(5)","⑹":"(6)","⑺":"(7)","⑻":"(8)","⑼":"(9)","⒜":"(a)","🄐":"(A)","⒝":"(b)","🄑":"(B)","⒞":"(c)","🄒":"(C)","⒟":"(d)","🄓":"(D)","⒠":"(e)","🄔":"(E)","⒡":"(f)","🄕":"(F)","⒢":"(g)","🄖":"(G)","⒣":"(h)","🄗":"(H)","⒤":"(i)","⒥":"(j)","🄙":"(J)","⒦":"(k)","🄚":"(K)","⑴":"(l)","🄘":"(l)","⒧":"(l)","🄛":"(L)","⑿":"(l2)","⒀":"(l3)","⒁":"(l4)","⒂":"(l5)","⒃":"(l6)","⒄":"(l7)","⒅":"(l8)","⒆":"(l9)","⑾":"(ll)","⑽":"(lO)","🄜":"(M)","⒩":"(n)","🄝":"(N)","⒪":"(o)","🄞":"(O)","⒫":"(p)","🄟":"(P)","⒬":"(q)","🄠":"(Q)","⒭":"(r)","🄡":"(R)","⒨":"(rn)","⒮":"(s)","🄢":"(S)","🄪":"(S)","⒯":"(t)","🄣":"(T)","⒰":"(u)","🄤":"(U)","⒱":"(v)","🄥":"(V)","⒲":"(w)","🄦":"(W)","⒳":"(x)","🄧":"(X)","⒴":"(y)","🄨":"(Y)","⒵":"(z)","🄩":"(Z)","㈀":"(ᄀ)","㈎":"(가)","㈁":"(ᄂ)","㈏":"(나)","㈂":"(ᄃ)","㈐":"(다)","㈃":"(ᄅ)","㈑":"(라)","㈄":"(ᄆ)","㈒":"(마)","㈅":"(ᄇ)","㈓":"(바)","㈆":"(ᄉ)","㈔":"(사)","㈇":"(ᄋ)","㈕":"(아)","㈝":"(오전)","㈞":"(오후)","㈈":"(ᄌ)","㈖":"(자)","㈜":"(주)","㈉":"(ᄎ)","㈗":"(차)","㈊":"(ᄏ)","㈘":"(카)","㈋":"(ᄐ)","㈙":"(타)","㈌":"(ᄑ)","㈚":"(파)","㈍":"(ᄒ)","㈛":"(하)","㈦":"(七)","㈢":"(三)","🉁":"(三)","㈨":"(九)","㈡":"(二)","🉂":"(二)","㈤":"(五)","㈹":"(代)","㈽":"(企)","㉁":"(休)","㈧":"(八)","㈥":"(六)","㈸":"(労)","🉇":"(勝)","㈩":"(十)","㈿":"(協)","㈴":"(名)","㈺":"(呼)","㈣":"(四)","㈯":"(土)","㈻":"(学)","🉃":"(安)","🉅":"(打)","🉈":"(敗)","㈰":"(日)","㈪":"(月)","㈲":"(有)","㈭":"(木)","🉀":"(本)","㈱":"(株)","㈬":"(水)","㈫":"(火)","🉄":"(点)","㈵":"(特)","🉆":"(盗)","㈼":"(監)","㈳":"(社)","㈷":"(祝)","㉀":"(祭)","㉂":"(自)","㉃":"(至)","㈶":"(財)","㈾":"(資)","㈮":"(金)","］":")","❩":")","❳":")","〕":")","﴿":")","⸩":"))","❴":"{","𝄔":"{","❵":"}","〚":"⟦","〛":"⟧","⟨":"❬","〈":"❬","〈":"❬","㇛":"❬",く:"❬","𡿨":"❬","⟩":"❭","〉":"❭","〉":"❭","＾":"︿","⸿":"¶","⁎":"*","٭":"*","∗":"*","𐌟":"*","᜵":"/","⁁":"/","∕":"/","⁄":"/","╱":"/","⟋":"/","⧸":"/","𝈺":"/","㇓":"/",〳:"/","Ⳇ":"/",ノ:"/",丿:"/","⼃":"/","⧶":"/̄","⫽":"//","⫻":"///","＼":"\\","﹨":"\\","∖":"\\","⟍":"\\","⧵":"\\","⧹":"\\","𝈏":"\\","𝈻":"\\","㇔":"\\",丶:"\\","⼂":"\\","⳹":"\\\\","⑊":"\\\\","⟈":"\\ᑕ","ꝸ":"&","૰":"॰","𑂻":"॰","𑇇":"॰","⚬":"॰","𑇛":"꣼","៙":"๏","៕":"๚","៚":"๛","༌":"་","༎":"།།","˄":"^","ˆ":"^","꙾":"ˇ","˘":"ˇ","‾":"ˉ","﹉":"ˉ","﹊":"ˉ","﹋":"ˉ","﹌":"ˉ","¯":"ˉ","￣":"ˉ","▔":"ˉ",ъ:"ˉb","ꙑ":"ˉbi","͵":"ˏ","˻":"˪","꜖":"˪","꜔":"˫","。":"˳","⸰":"°","˚":"°","∘":"°","○":"°","◦":"°","⍜":"°̲","⍤":"°̈","℃":"°C","℉":"°F","௵":"௳","༛":"༚༚","༟":"༚༝","࿎":"༝༚","༞":"༝༝","Ⓒ":"©","Ⓡ":"®","Ⓟ":"℗","𝈛":"⅄","⯬":"↞","⯭":"↟","⯮":"↠","⯯":"↡","↵":"↲","⥥":"⇃⇂","⥯":"⇃ᛚ","𝛛":"∂","𝜕":"∂","𝝏":"∂","𝞉":"∂","𝟃":"∂","𞣌":"∂","𞣍":"∂̵",ð:"∂̵","⌀":"∅","𝛁":"∇","𝛻":"∇","𝜵":"∇","𝝯":"∇","𝞩":"∇","𑢨":"∇","⍢":"∇̈","⍫":"∇̴","█":"∎","■":"∎","⨿":"∐","᛭":"+","➕":"+","𐊛":"+","⨣":"+̂","⨢":"+̊","⨤":"+̃","∔":"+̇","⨥":"+̣","⨦":"+̰","⨧":"+₂","➗":"÷","‹":"<","❮":"<","˂":"<","𝈶":"<",ᐸ:"<",ᚲ:"<","⋖":"<·","Ⲵ":"<·",ᑅ:"<·","≪":"<<","⋘":"<<<","᐀":"=","⹀":"=","゠":"=","꓿":"=","≚":"=̆","≙":"=̂","≗":"=̊","≐":"=̇","≑":"=̣̇","⩮":"=⃰","⩵":"==","⩶":"===","≞":"=ͫ","›":">","❯":">","˃":">","𝈷":">",ᐳ:">","𖼿":">",ᑁ:">·","⪥":"><","≫":">>","⨠":">>","⋙":">>>","⁓":"~","˜":"~","῀":"~","∼":"~","⍨":"~̈","⸞":"~̇","⩪":"~̇","⸟":"~̣","𞣈":"∠","⋀":"∧","∯":"∮∮","∰":"∮∮∮","⸫":"∴","⸪":"∵","⸬":"∷","𑇞":"≈","♎":"≏","🝞":"≏","≣":"≡","⨃":"⊍","⨄":"⊎","𝈸":"⊏","𝈹":"⊐","⨅":"⊓","⨆":"⊔","⨂":"⊗","⍟":"⊛","🝱":"⊠","🝕":"⊡","◁":"⊲","▷":"⊳","⍣":"⋆̈","︴":"⌇","◠":"⌒","⨽":"⌙","⌥":"⌤","⧇":"⌻","◎":"⌾","⦾":"⌾","⧅":"⍂","⦰":"⍉","⏃":"⍋","⏂":"⍎","⏁":"⍕","⏆":"⍭","☸":"⎈","︵":"⏜","︶":"⏝","︷":"⏞","︸":"⏟","︹":"⏠","︺":"⏡","▱":"⏥","⏼":"⏻","︱":"│","｜":"│","┃":"│","┏":"┌","┣":"├","▐":"▌","▗":"▖","▝":"▘","☐":"□","￭":"▪","▸":"▶","►":"▶","⳩":"☧","🜊":"☩","🌒":"☽","🌙":"☽","⏾":"☾","🌘":"☾","⧙":"⦚","🜺":"⧟","⨾":"⨟","𐆠":"⳨","♩":"𝅘𝅥","♪":"𝅘𝅥𝅮","⓪":"🄍","↺":"🄎","˙":"ॱ","ൎ":"ॱ","－":"ー","—":"ー","―":"ー","─":"ー","━":"ー","㇐":"ー","ꟷ":"ー",ᅳ:"ー",ㅡ:"ー",一:"ー","⼀":"ー",ᆖ:"ーー","ힹ":"ーᅡ","ힺ":"ーᅥ","ힻ":"ーᅥ丨","ힼ":"ーᅩ",ᆕ:"ーᅮ",ᅴ:"ー丨",ㅢ:"ー丨",ᆗ:"ー丨ᅮ","🄏":"$⃠","₤":"£","〒":"₸","〶":"₸","᭜":"᭐","꧆":"꧐","𑓑":"১","೧":"౧","ၥ":"၁","①":"➀","⑩":"➉","⏨":"₁₀","𝟐":"2","𝟚":"2","𝟤":"2","𝟮":"2","𝟸":"2","🯲":"2","Ꝛ":"2",Ƨ:"2",Ϩ:"2","Ꙅ":"2",ᒿ:"2","ꛯ":"2","ꧏ":"٢","۲":"٢","૨":"२","𑓒":"২","೨":"౨","②":"➁",ƻ:"2̵","🄃":"2,","⒉":"2.","㏵":"22日","㍮":"22点","㏶":"23日","㍯":"23点","㏷":"24日","㍰":"24点","㏸":"25日","㏹":"26日","㏺":"27日","㏻":"28日","㏼":"29日","㏴":"2l日","㍭":"2l点","⒛":"2O.","㏳":"2O日","㍬":"2O点","෩":"෨ා","෯":"෨ී","㏡":"2日","㋁":"2月","㍚":"2点","𝈆":"3","𝟑":"3","𝟛":"3","𝟥":"3","𝟯":"3","𝟹":"3","🯳":"3","Ɜ":"3",Ȝ:"3",Ʒ:"3","Ꝫ":"3","Ⳍ":"3",З:"3",Ӡ:"3","𖼻":"3","𑣊":"3","۳":"٣","𞣉":"٣","૩":"३","③":"➂",Ҙ:"3̦","🄄":"3,","⒊":"3.","㏾":"3l日","㏽":"3O日","㏢":"3日","㋂":"3月","㍛":"3点","𝟒":"4","𝟜":"4","𝟦":"4","𝟰":"4","𝟺":"4","🯴":"4",Ꮞ:"4","𑢯":"4","۴":"٤","૪":"४","④":"➃","🄅":"4,","⒋":"4.",ᔰ:"4·","㏣":"4日","㋃":"4月","㍜":"4点","𝟓":"5","𝟝":"5","𝟧":"5","𝟱":"5","𝟻":"5","🯵":"5",Ƽ:"5","𑢻":"5","⑤":"➄","🄆":"5,","⒌":"5.","㏤":"5日","㋄":"5月","㍝":"5点","𝟔":"6","𝟞":"6","𝟨":"6","𝟲":"6","𝟼":"6","🯶":"6","Ⳓ":"6",б:"6",Ꮾ:"6","𑣕":"6","۶":"٦","𑓖":"৬","⑥":"➅","🄇":"6,","⒍":"6.","㏥":"6日","㋅":"6月","㍞":"6点","𝈒":"7","𝟕":"7","𝟟":"7","𝟩":"7","𝟳":"7","𝟽":"7","🯷":"7","𐓒":"7","𑣆":"7","⑦":"➆","🄈":"7,","⒎":"7.","㏦":"7日","㋆":"7月","㍟":"7点","ଃ":"8","৪":"8","੪":"8","𞣋":"8","𝟖":"8","𝟠":"8","𝟪":"8","𝟴":"8","𝟾":"8","🯸":"8",ȣ:"8",Ȣ:"8","𐌚":"8","૮":"८","⑧":"➇","🄉":"8,","⒏":"8.","㏧":"8日","㋇":"8月","㍠":"8点","੧":"9","୨":"9","৭":"9","൭":"9","𝟗":"9","𝟡":"9","𝟫":"9","𝟵":"9","𝟿":"9","🯹":"9","Ꝯ":"9","Ⳋ":"9","𑣌":"9","𑢬":"9","𑣖":"9","१":"٩","𑣤":"٩","۹":"٩","೯":"౯","⑨":"➈","🄊":"9,","⒐":"9.","㏨":"9日","㋈":"9月","㍡":"9点","⍺":"a",ａ:"a","𝐚":"a","𝑎":"a","𝒂":"a","𝒶":"a","𝓪":"a","𝔞":"a","𝕒":"a","𝖆":"a","𝖺":"a","𝗮":"a","𝘢":"a","𝙖":"a","𝚊":"a",ɑ:"a",α:"a","𝛂":"a","𝛼":"a","𝜶":"a","𝝰":"a","𝞪":"a",а:"a","ⷶ":"ͣ",Ａ:"A","𝐀":"A","𝐴":"A","𝑨":"A","𝒜":"A","𝓐":"A","𝔄":"A","𝔸":"A","𝕬":"A","𝖠":"A","𝗔":"A","𝘈":"A","𝘼":"A","𝙰":"A",Α:"A","𝚨":"A","𝛢":"A","𝜜":"A","𝝖":"A","𝞐":"A",А:"A",Ꭺ:"A",ᗅ:"A","ꓮ":"A","𖽀":"A","𐊠":"A","⍶":"a̲",ǎ:"ă",Ǎ:"Ă",ȧ:"å",Ȧ:"Å",ẚ:"ả","℀":"a/c","℁":"a/s","ꜳ":"aa","Ꜳ":"AA",æ:"ae",ӕ:"ae",Æ:"AE",Ӕ:"AE","ꜵ":"ao","Ꜵ":"AO","🜇":"AR","ꜷ":"au","Ꜷ":"AU","ꜹ":"av","ꜻ":"av","Ꜹ":"AV","Ꜻ":"AV","ꜽ":"ay","Ꜽ":"AY","ꭺ":"ᴀ","∀":"Ɐ","𝈗":"Ɐ",ᗄ:"Ɐ","ꓯ":"Ɐ","𐐟":"Ɒ","𝐛":"b","𝑏":"b","𝒃":"b","𝒷":"b","𝓫":"b","𝔟":"b","𝕓":"b","𝖇":"b","𝖻":"b","𝗯":"b","𝘣":"b","𝙗":"b","𝚋":"b",Ƅ:"b",Ь:"b",Ꮟ:"b",ᑲ:"b",ᖯ:"b",Ｂ:"B",ℬ:"B","𝐁":"B","𝐵":"B","𝑩":"B","𝓑":"B","𝔅":"B","𝔹":"B","𝕭":"B","𝖡":"B","𝗕":"B","𝘉":"B","𝘽":"B","𝙱":"B","Ꞵ":"B",Β:"B","𝚩":"B","𝛣":"B","𝜝":"B","𝝗":"B","𝞑":"B",В:"B",Ᏼ:"B",ᗷ:"B","ꓐ":"B","𐊂":"B","𐊡":"B","𐌁":"B",ɓ:"b̔",ᑳ:"ḃ",ƃ:"b̄",Ƃ:"b̄",Б:"b̄",ƀ:"b̵",ҍ:"b̵",Ҍ:"b̵",ѣ:"b̵",Ѣ:"b̵",ᑿ:"b·",ᒁ:"ḃ·",ᒈ:"b'",Ы:"bl",в:"ʙ","ᏼ":"ʙ",ｃ:"c","ⅽ":"c","𝐜":"c","𝑐":"c","𝒄":"c","𝒸":"c","𝓬":"c","𝔠":"c","𝕔":"c","𝖈":"c","𝖼":"c","𝗰":"c","𝘤":"c","𝙘":"c","𝚌":"c","ᴄ":"c",ϲ:"c","ⲥ":"c",с:"c","ꮯ":"c","𐐽":"c","ⷭ":"ͨ","🝌":"C","𑣲":"C","𑣩":"C",Ｃ:"C","Ⅽ":"C",ℂ:"C",ℭ:"C","𝐂":"C","𝐶":"C","𝑪":"C","𝒞":"C","𝓒":"C","𝕮":"C","𝖢":"C","𝗖":"C","𝘊":"C","𝘾":"C","𝙲":"C","Ϲ":"C","Ⲥ":"C",С:"C",Ꮯ:"C","ꓚ":"C","𐊢":"C","𐌂":"C","𐐕":"C","𐔜":"C","¢":"c̸","ȼ":"c̸","₡":"C⃫","🅮":"C⃠",ç:"c̦",ҫ:"c̦",Ç:"C̦",Ҫ:"C̦",Ƈ:"C'","℅":"c/o","℆":"c/u","🅭":"㏄	⃝","⋴":"ꞓ",ɛ:"ꞓ",ε:"ꞓ","ϵ":"ꞓ","𝛆":"ꞓ","𝛜":"ꞓ","𝜀":"ꞓ","𝜖":"ꞓ","𝜺":"ꞓ","𝝐":"ꞓ","𝝴":"ꞓ","𝞊":"ꞓ","𝞮":"ꞓ","𝟄":"ꞓ","ⲉ":"ꞓ",є:"ꞓ","ԑ":"ꞓ","ꮛ":"ꞓ","𑣎":"ꞓ","𐐩":"ꞓ","€":"Ꞓ","Ⲉ":"Ꞓ",Є:"Ꞓ","⍷":"ꞓ̲","ͽ":"ꜿ","Ͽ":"Ꜿ","ⅾ":"d","ⅆ":"d","𝐝":"d","𝑑":"d","𝒅":"d","𝒹":"d","𝓭":"d","𝔡":"d","𝕕":"d","𝖉":"d","𝖽":"d","𝗱":"d","𝘥":"d","𝙙":"d","𝚍":"d","ԁ":"d",Ꮷ:"d",ᑯ:"d","ꓒ":"d","Ⅾ":"D","ⅅ":"D","𝐃":"D","𝐷":"D","𝑫":"D","𝒟":"D","𝓓":"D","𝔇":"D","𝔻":"D","𝕯":"D","𝖣":"D","𝗗":"D","𝘋":"D","𝘿":"D","𝙳":"D",Ꭰ:"D",ᗞ:"D",ᗪ:"D","ꓓ":"D",ɗ:"d̔",ɖ:"d̨",ƌ:"d̄",đ:"d̵",Đ:"D̵",Ð:"D̵",Ɖ:"D̵","₫":"ḏ̵","ꝺ":"Ꝺ",ᑻ:"d·",ᒇ:"d'",ʤ:"dȝ",ǳ:"dz",ʣ:"dz",ǲ:"Dz",Ǳ:"DZ",ǆ:"dž",ǅ:"Dž",Ǆ:"DŽ",ʥ:"dʑ","ꭰ":"ᴅ","⸹":"ẟ",δ:"ẟ","𝛅":"ẟ","𝛿":"ẟ","𝜹":"ẟ","𝝳":"ẟ","𝞭":"ẟ",ծ:"ẟ",ᕷ:"ẟ","℮":"e",ｅ:"e",ℯ:"e","ⅇ":"e","𝐞":"e","𝑒":"e","𝒆":"e","𝓮":"e","𝔢":"e","𝕖":"e","𝖊":"e","𝖾":"e","𝗲":"e","𝘦":"e","𝙚":"e","𝚎":"e","ꬲ":"e",е:"e",ҽ:"e","ⷷ":"ͤ","⋿":"E",Ｅ:"E",ℰ:"E","𝐄":"E","𝐸":"E","𝑬":"E","𝓔":"E","𝔈":"E","𝔼":"E","𝕰":"E","𝖤":"E","𝗘":"E","𝘌":"E","𝙀":"E","𝙴":"E",Ε:"E","𝚬":"E","𝛦":"E","𝜠":"E","𝝚":"E","𝞔":"E",Е:"E","ⴹ":"E",Ꭼ:"E","ꓰ":"E","𑢦":"E","𑢮":"E","𐊆":"E",ě:"ĕ",Ě:"Ĕ","ɇ":"e̸","Ɇ":"E̸",ҿ:"ę","ꭼ":"ᴇ",ə:"ǝ",ә:"ǝ","∃":"Ǝ","ⴺ":"Ǝ","ꓱ":"Ǝ",ɚ:"ǝ˞","ᴔ":"ǝo","ꭁ":"ǝo̸","ꭂ":"ǝo̵",Ә:"Ə","𝈡":"Ɛ",ℇ:"Ɛ","Ԑ":"Ɛ",Ꮛ:"Ɛ","𖼭":"Ɛ","𐐁":"Ɛ","ᶟ":"ᵋ","ᴈ":"ɜ",з:"ɜ",ҙ:"ɜ̦","𐑂":"ɞ","ꞝ":"ʚ","𐐪":"ʚ","𝐟":"f","𝑓":"f","𝒇":"f","𝒻":"f","𝓯":"f","𝔣":"f","𝕗":"f","𝖋":"f","𝖿":"f","𝗳":"f","𝘧":"f","𝙛":"f","𝚏":"f","ꬵ":"f","ꞙ":"f",ſ:"f","ẝ":"f",ք:"f","𝈓":"F",ℱ:"F","𝐅":"F","𝐹":"F","𝑭":"F","𝓕":"F","𝔉":"F","𝔽":"F","𝕱":"F","𝖥":"F","𝗙":"F","𝘍":"F","𝙁":"F","𝙵":"F","Ꞙ":"F",Ϝ:"F","𝟊":"F",ᖴ:"F","ꓝ":"F","𑣂":"F","𑢢":"F","𐊇":"F","𐊥":"F","𐔥":"F",ƒ:"f̦",Ƒ:"F̦","ᵮ":"f̴","℻":"FAX",ﬀ:"ff",ﬃ:"ffi",ﬄ:"ffl",ﬁ:"fi",ﬂ:"fl",ʩ:"fŋ",ᖵ:"Ⅎ","ꓞ":"Ⅎ","𝈰":"ꟻ",ᖷ:"ꟻ",ｇ:"g",ℊ:"g","𝐠":"g","𝑔":"g","𝒈":"g","𝓰":"g","𝔤":"g","𝕘":"g","𝖌":"g","𝗀":"g","𝗴":"g","𝘨":"g","𝙜":"g","𝚐":"g",ɡ:"g","ᶃ":"g",ƍ:"g",ց:"g","𝐆":"G","𝐺":"G","𝑮":"G","𝒢":"G","𝓖":"G","𝔊":"G","𝔾":"G","𝕲":"G","𝖦":"G","𝗚":"G","𝘎":"G","𝙂":"G","𝙶":"G","Ԍ":"G",Ꮐ:"G",Ᏻ:"G","ꓖ":"G","ᶢ":"ᵍ",ɠ:"g̔",ǧ:"ğ",Ǧ:"Ğ",ǵ:"ģ",ǥ:"g̵",Ǥ:"G̵",Ɠ:"G'","ԍ":"ɢ","ꮐ":"ɢ","ᏻ":"ɢ",ｈ:"h",ℎ:"h","𝐡":"h","𝒉":"h","𝒽":"h","𝓱":"h","𝔥":"h","𝕙":"h","𝖍":"h","𝗁":"h","𝗵":"h","𝘩":"h","𝙝":"h","𝚑":"h",һ:"h",հ:"h",Ꮒ:"h",Ｈ:"H",ℋ:"H",ℌ:"H",ℍ:"H","𝐇":"H","𝐻":"H","𝑯":"H","𝓗":"H","𝕳":"H","𝖧":"H","𝗛":"H","𝘏":"H","𝙃":"H","𝙷":"H",Η:"H","𝚮":"H","𝛨":"H","𝜢":"H","𝝜":"H","𝞖":"H","Ⲏ":"H",Н:"H",Ꮋ:"H",ᕼ:"H","ꓧ":"H","𐋏":"H","ᵸ":"ᴴ",ɦ:"h̔","ꚕ":"h̔",Ᏺ:"h̔","Ⱨ":"H̩",Ң:"H̩",ħ:"h̵",ℏ:"h̵",ћ:"h̵",Ħ:"H̵","Ӊ":"H̦",Ӈ:"H̦",н:"ʜ","ꮋ":"ʜ",ң:"ʜ̩","ӊ":"ʜ̦",ӈ:"ʜ̦","Ԋ":"Ƕ","ꮀ":"ⱶ","Ͱ":"Ⱶ",Ꭸ:"Ⱶ",Ꮀ:"Ⱶ","ꚱ":"Ⱶ","ꞕ":"ꜧ","˛":"i","⍳":"i",ｉ:"i","ⅰ":"i",ℹ:"i","ⅈ":"i","𝐢":"i","𝑖":"i","𝒊":"i","𝒾":"i","𝓲":"i","𝔦":"i","𝕚":"i","𝖎":"i","𝗂":"i","𝗶":"i","𝘪":"i","𝙞":"i","𝚒":"i",ı:"i","𝚤":"i",ɪ:"i",ɩ:"i",ι:"i",ι:"i",ͺ:"i","𝛊":"i","𝜄":"i","𝜾":"i","𝝸":"i","𝞲":"i",і:"i","ꙇ":"i","ӏ":"i","ꭵ":"i",Ꭵ:"i","𑣃":"i","ⓛ":"Ⓘ","⍸":"i̲",ǐ:"ĭ",Ǐ:"Ĭ",ɨ:"i̵","ᵻ":"i̵","ᵼ":"i̵","ⅱ":"ii","ⅲ":"iii",ĳ:"ij","ⅳ":"iv","ⅸ":"ix",ｊ:"j","ⅉ":"j","𝐣":"j","𝑗":"j","𝒋":"j","𝒿":"j","𝓳":"j","𝔧":"j","𝕛":"j","𝖏":"j","𝗃":"j","𝗷":"j","𝘫":"j","𝙟":"j","𝚓":"j",ϳ:"j",ј:"j",Ｊ:"J","𝐉":"J","𝐽":"J","𝑱":"J","𝒥":"J","𝓙":"J","𝔍":"J","𝕁":"J","𝕵":"J","𝖩":"J","𝗝":"J","𝘑":"J","𝙅":"J","𝙹":"J","Ʝ":"J","Ϳ":"J",Ј:"J",Ꭻ:"J",ᒍ:"J","ꓙ":"J","ɉ":"j̵","Ɉ":"J̵",ᒙ:"J·","𝚥":"ȷ",յ:"ȷ","ꭻ":"ᴊ","𝐤":"k","𝑘":"k","𝒌":"k","𝓀":"k","𝓴":"k","𝔨":"k","𝕜":"k","𝖐":"k","𝗄":"k","𝗸":"k","𝘬":"k","𝙠":"k","𝚔":"k",K:"K",Ｋ:"K","𝐊":"K","𝐾":"K","𝑲":"K","𝒦":"K","𝓚":"K","𝔎":"K","𝕂":"K","𝕶":"K","𝖪":"K","𝗞":"K","𝘒":"K","𝙆":"K","𝙺":"K",Κ:"K","𝚱":"K","𝛫":"K","𝜥":"K","𝝟":"K","𝞙":"K","Ⲕ":"K",К:"K",Ꮶ:"K",ᛕ:"K","ꓗ":"K","𐔘":"K",ƙ:"k̔","Ⱪ":"K̩",Қ:"K̩","₭":"K̵","Ꝁ":"K̵",Ҟ:"K̵",Ƙ:"K'","׀":"l","|":"l","∣":"l","⏽":"l","￨":"l","١":"l","۱":"l","𐌠":"l","𞣇":"l","𝟏":"l","𝟙":"l","𝟣":"l","𝟭":"l","𝟷":"l","🯱":"l",I:dD,Ｉ:"l","Ⅰ":"l",ℐ:"l",ℑ:"l","𝐈":"l","𝐼":"l","𝑰":"l","𝓘":"l","𝕀":"l","𝕴":"l","𝖨":"l","𝗜":"l","𝘐":"l","𝙄":"l","𝙸":"l",Ɩ:"l",ｌ:"l","ⅼ":"l",ℓ:"l","𝐥":"l","𝑙":"l","𝒍":"l","𝓁":"l","𝓵":"l","𝔩":"l","𝕝":"l","𝖑":"l","𝗅":"l","𝗹":"l","𝘭":"l","𝙡":"l","𝚕":"l",ǀ:"l",Ι:"l","𝚰":"l","𝛪":"l","𝜤":"l","𝝞":"l","𝞘":"l","Ⲓ":"l",І:"l",Ӏ:"l",ו:"l",ן:"l",ا:"l","𞸀":"l","𞺀":"l",ﺎ:"l",ﺍ:"l","ߊ":"l","ⵏ":"l",ᛁ:"l","ꓲ":"l","𖼨":"l","𐊊":"l","𐌉":"l","𝈪":"L","Ⅼ":"L",ℒ:"L","𝐋":"L","𝐿":"L","𝑳":"L","𝓛":"L","𝔏":"L","𝕃":"L","𝕷":"L","𝖫":"L","𝗟":"L","𝘓":"L","𝙇":"L","𝙻":"L","Ⳑ":"L",Ꮮ:"L",ᒪ:"L","ꓡ":"L","𖼖":"L","𑢣":"L","𑢲":"L","𐐛":"L","𐔦":"L",ﴼ:"l̋",ﴽ:"l̋",ł:"l̸",Ł:"L̸",ɭ:"l̨",Ɨ:"l̵",ƚ:"l̵",ɫ:"l̴",إ:"lٕ",ﺈ:"lٕ",ﺇ:"lٕ",ٳ:"lٕ",ŀ:"l·",Ŀ:"l·",ᒷ:"l·","🄂":"l,","⒈":"l.",ױ:"l'","⒓":"l2.","㏫":"l2日","㋋":"l2月","㍤":"l2点","⒔":"l3.","㏬":"l3日","㍥":"l3点","⒕":"l4.","㏭":"l4日","㍦":"l4点","⒖":"l5.","㏮":"l5日","㍧":"l5点","⒗":"l6.","㏯":"l6日","㍨":"l6点","⒘":"l7.","㏰":"l7日","㍩":"l7点","⒙":"l8.","㏱":"l8日","㍪":"l8点","⒚":"l9.","㏲":"l9日","㍫":"l9点",ǉ:"lj",Ĳ:"lJ",ǈ:"Lj",Ǉ:"LJ","‖":"ll","∥":"ll","Ⅱ":"ll",ǁ:"ll",װ:"ll","𐆙":"l̵l̵","⒒":"ll.","Ⅲ":"lll","𐆘":"l̵l̵S̵","㏪":"ll日","㋊":"ll月","㍣":"ll点",Ю:"lO","⒑":"lO.","㏩":"lO日","㋉":"lO月","㍢":"lO点",ʪ:"ls","₶":"lt","Ⅳ":"lV","Ⅸ":"lX",ɮ:"lȝ",ʫ:"lz",أ:"lٴ",ﺄ:"lٴ",ﺃ:"lٴ",ٲ:"lٴ",ٵ:"lٴ",ﷳ:"lكبر",ﷲ:"lللّٰo","㏠":"l日","㋀":"l月","㍙":"l点","ⳑ":"ʟ","ꮮ":"ʟ","𐑃":"ʟ",Ｍ:"M","Ⅿ":"M",ℳ:"M","𝐌":"M","𝑀":"M","𝑴":"M","𝓜":"M","𝔐":"M","𝕄":"M","𝕸":"M","𝖬":"M","𝗠":"M","𝘔":"M","𝙈":"M","𝙼":"M",Μ:"M","𝚳":"M","𝛭":"M","𝜧":"M","𝝡":"M","𝞛":"M","Ϻ":"M","Ⲙ":"M",М:"M",Ꮇ:"M",ᗰ:"M",ᛖ:"M","ꓟ":"M","𐊰":"M","𐌑":"M","Ӎ":"M̦","🝫":"MB","ⷨ":"ᷟ","𝐧":"n","𝑛":"n","𝒏":"n","𝓃":"n","𝓷":"n","𝔫":"n","𝕟":"n","𝖓":"n","𝗇":"n","𝗻":"n","𝘯":"n","𝙣":"n","𝚗":"n",ո:"n",ռ:"n",Ｎ:"N",ℕ:"N","𝐍":"N","𝑁":"N","𝑵":"N","𝒩":"N","𝓝":"N","𝔑":"N","𝕹":"N","𝖭":"N","𝗡":"N","𝘕":"N","𝙉":"N","𝙽":"N",Ν:"N","𝚴":"N","𝛮":"N","𝜨":"N","𝝢":"N","𝞜":"N","Ⲛ":"N","ꓠ":"N","𐔓":"N","𐆎":"N̊",ɳ:"n̨",ƞ:"n̩",η:"n̩","𝛈":"n̩","𝜂":"n̩","𝜼":"n̩","𝝶":"n̩","𝞰":"n̩",Ɲ:"N̦","ᵰ":"n̴",ǌ:"nj",ǋ:"Nj",Ǌ:"NJ","№":"No","ͷ":"ᴎ",и:"ᴎ","𐑍":"ᴎ",ņ:"ɲ","ం":"o","ಂ":"o","ം":"o","ං":"o","०":"o","੦":"o","૦":"o","௦":"o","౦":"o","೦":"o","൦":"o","๐":"o","໐":"o","၀":"o","٥":"o","۵":"o",ｏ:"o",ℴ:"o","𝐨":"o","𝑜":"o","𝒐":"o","𝓸":"o","𝔬":"o","𝕠":"o","𝖔":"o","𝗈":"o","𝗼":"o","𝘰":"o","𝙤":"o","𝚘":"o","ᴏ":"o","ᴑ":"o","ꬽ":"o",ο:"o","𝛐":"o","𝜊":"o","𝝄":"o","𝝾":"o","𝞸":"o",σ:"o","𝛔":"o","𝜎":"o","𝝈":"o","𝞂":"o","𝞼":"o","ⲟ":"o",о:"o","ჿ":"o",օ:"o",ס:"o",ه:"o","𞸤":"o","𞹤":"o","𞺄":"o",ﻫ:"o",ﻬ:"o",ﻪ:"o",ﻩ:"o",ھ:"o",ﮬ:"o",ﮭ:"o",ﮫ:"o",ﮪ:"o",ہ:"o",ﮨ:"o",ﮩ:"o",ﮧ:"o",ﮦ:"o",ە:"o",ഠ:"o",ဝ:"o","𐓪":"o","𑣈":"o","𑣗":"o","𐐬":"o","߀":"O","০":"O","୦":"O","〇":"O","𑓐":"O","𑣠":"O","𝟎":"O","𝟘":"O","𝟢":"O","𝟬":"O","𝟶":"O","🯰":"O",Ｏ:"O","𝐎":"O","𝑂":"O","𝑶":"O","𝒪":"O","𝓞":"O","𝔒":"O","𝕆":"O","𝕺":"O","𝖮":"O","𝗢":"O","𝘖":"O","𝙊":"O","𝙾":"O",Ο:"O","𝚶":"O","𝛰":"O","𝜪":"O","𝝤":"O","𝞞":"O","Ⲟ":"O",О:"O",Օ:"O","ⵔ":"O",ዐ:"O",ଠ:"O","𐓂":"O","ꓳ":"O","𑢵":"O","𐊒":"O","𐊫":"O","𐐄":"O","𐔖":"O","⁰":"º","ᵒ":"º",ǒ:"ŏ",Ǒ:"Ŏ","ۿ":"ô",Ő:"Ö",ø:"o̸","ꬾ":"o̸",Ø:"O̸","ⵁ":"O̸",Ǿ:"Ó̸",ɵ:"o̵","ꝋ":"o̵",ө:"o̵",ѳ:"o̵","ꮎ":"o̵","ꮻ":"o̵","⊖":"O̵","⊝":"O̵","⍬":"O̵","𝈚":"O̵","🜔":"O̵",Ɵ:"O̵","Ꝋ":"O̵",θ:"O̵",ϑ:"O̵","𝛉":"O̵","𝛝":"O̵","𝜃":"O̵","𝜗":"O̵","𝜽":"O̵","𝝑":"O̵","𝝷":"O̵","𝞋":"O̵","𝞱":"O̵","𝟅":"O̵",Θ:"O̵","ϴ":"O̵","𝚯":"O̵","𝚹":"O̵","𝛩":"O̵","𝛳":"O̵","𝜣":"O̵","𝜭":"O̵","𝝝":"O̵","𝝧":"O̵","𝞗":"O̵","𝞡":"O̵",Ө:"O̵",Ѳ:"O̵","ⴱ":"O̵",Ꮎ:"O̵",Ꮻ:"O̵","ꭴ":"ơ",ﳙ:"oٰ","🄁":"O,","🄀":"O.",ơ:"o'",Ơ:"O'",Ꭴ:"O'","%":"º/₀","٪":"º/₀","⁒":"º/₀","‰":"º/₀₀","؉":"º/₀₀","‱":"º/₀₀₀","؊":"º/₀₀₀",œ:"oe",Œ:"OE",ɶ:"oᴇ","∞":"oo","ꝏ":"oo","ꚙ":"oo","Ꝏ":"OO","Ꚙ":"OO",ﳗ:"oج",ﱑ:"oج",ﳘ:"oم",ﱒ:"oم",ﶓ:"oمج",ﶔ:"oمم",ﱓ:"oى",ﱔ:"oى","ൟ":"oരo",တ:"oာ","㍘":"O点","ↄ":"ɔ","ᴐ":"ɔ","ͻ":"ɔ","𐑋":"ɔ","Ↄ":"Ɔ","Ͻ":"Ɔ","ꓛ":"Ɔ","𐐣":"Ɔ","ꬿ":"ɔ̸","ꭢ":"ɔe","𐐿":"ɷ","⍴":"p",ｐ:"p","𝐩":"p","𝑝":"p","𝒑":"p","𝓅":"p","𝓹":"p","𝔭":"p","𝕡":"p","𝖕":"p","𝗉":"p","𝗽":"p","𝘱":"p","𝙥":"p","𝚙":"p",ρ:"p",ϱ:"p","𝛒":"p","𝛠":"p","𝜌":"p","𝜚":"p","𝝆":"p","𝝔":"p","𝞀":"p","𝞎":"p","𝞺":"p","𝟈":"p","ⲣ":"p",р:"p",Ｐ:"P",ℙ:"P","𝐏":"P","𝑃":"P","𝑷":"P","𝒫":"P","𝓟":"P","𝔓":"P","𝕻":"P","𝖯":"P","𝗣":"P","𝘗":"P","𝙋":"P","𝙿":"P",Ρ:"P","𝚸":"P","𝛲":"P","𝜬":"P","𝝦":"P","𝞠":"P","Ⲣ":"P",Р:"P",Ꮲ:"P",ᑭ:"P","ꓑ":"P","𐊕":"P",ƥ:"p̔","ᵽ":"p̵",ᑷ:"p·",ᒆ:"P'","ᴩ":"ᴘ","ꮲ":"ᴘ",φ:"ɸ",ϕ:"ɸ","𝛗":"ɸ","𝛟":"ɸ","𝜑":"ɸ","𝜙":"ɸ","𝝋":"ɸ","𝝓":"ɸ","𝞅":"ɸ","𝞍":"ɸ","𝞿":"ɸ","𝟇":"ɸ","ⲫ":"ɸ",ф:"ɸ","𝐪":"q","𝑞":"q","𝒒":"q","𝓆":"q","𝓺":"q","𝔮":"q","𝕢":"q","𝖖":"q","𝗊":"q","𝗾":"q","𝘲":"q","𝙦":"q","𝚚":"q","ԛ":"q",գ:"q",զ:"q",ℚ:"Q","𝐐":"Q","𝑄":"Q","𝑸":"Q","𝒬":"Q","𝓠":"Q","𝔔":"Q","𝕼":"Q","𝖰":"Q","𝗤":"Q","𝘘":"Q","𝙌":"Q","𝚀":"Q","ⵕ":"Q",ʠ:"q̔","🜀":"QE","ᶐ":"ɋ","ᴋ":"ĸ",κ:"ĸ",ϰ:"ĸ","𝛋":"ĸ","𝛞":"ĸ","𝜅":"ĸ","𝜘":"ĸ","𝜿":"ĸ","𝝒":"ĸ","𝝹":"ĸ","𝞌":"ĸ","𝞳":"ĸ","𝟆":"ĸ","ⲕ":"ĸ",к:"ĸ","ꮶ":"ĸ",қ:"ĸ̩",ҟ:"ĸ̵","𝐫":"r","𝑟":"r","𝒓":"r","𝓇":"r","𝓻":"r","𝔯":"r","𝕣":"r","𝖗":"r","𝗋":"r","𝗿":"r","𝘳":"r","𝙧":"r","𝚛":"r","ꭇ":"r","ꭈ":"r","ᴦ":"r","ⲅ":"r",г:"r","ꮁ":"r","𝈖":"R",ℛ:"R",ℜ:"R",ℝ:"R","𝐑":"R","𝑅":"R","𝑹":"R","𝓡":"R","𝕽":"R","𝖱":"R","𝗥":"R","𝘙":"R","𝙍":"R","𝚁":"R",Ʀ:"R",Ꭱ:"R",Ꮢ:"R","𐒴":"R",ᖇ:"R","ꓣ":"R","𖼵":"R",ɽ:"r̨",ɼ:"r̩","ɍ":"r̵",ғ:"r̵","ᵲ":"r̴",ґ:"r'","𑣣":"rn",m:hD,"ⅿ":"rn","𝐦":"rn","𝑚":"rn","𝒎":"rn","𝓂":"rn","𝓶":"rn","𝔪":"rn","𝕞":"rn","𝖒":"rn","𝗆":"rn","𝗺":"rn","𝘮":"rn","𝙢":"rn","𝚖":"rn","𑜀":"rn","₥":"rn̸",ɱ:"rn̦","ᵯ":"rn̴","₨":"Rs","ꭱ":"ʀ","ꮢ":"ʀ",я:"ᴙ","ᵳ":"ɾ̴","℩":"ɿ",ｓ:"s","𝐬":"s","𝑠":"s","𝒔":"s","𝓈":"s","𝓼":"s","𝔰":"s","𝕤":"s","𝖘":"s","𝗌":"s","𝘀":"s","𝘴":"s","𝙨":"s","𝚜":"s","ꜱ":"s",ƽ:"s",ѕ:"s","ꮪ":"s","𑣁":"s","𐑈":"s",Ｓ:"S","𝐒":"S","𝑆":"S","𝑺":"S","𝒮":"S","𝓢":"S","𝔖":"S","𝕊":"S","𝕾":"S","𝖲":"S","𝗦":"S","𝘚":"S","𝙎":"S","𝚂":"S",Ѕ:"S",Տ:"S",Ꮥ:"S",Ꮪ:"S","ꓢ":"S","𖼺":"S","𐊖":"S","𐐠":"S",ʂ:"s̨","ᵴ":"s̴","ꞵ":"ß",β:"ß",ϐ:"ß","𝛃":"ß","𝛽":"ß","𝜷":"ß","𝝱":"ß","𝞫":"ß",Ᏸ:"ß","🝜":"sss",ﬆ:"st","∫":"ʃ","ꭍ":"ʃ","∑":"Ʃ","⅀":"Ʃ",Σ:"Ʃ","𝚺":"Ʃ","𝛴":"Ʃ","𝜮":"Ʃ","𝝨":"Ʃ","𝞢":"Ʃ","ⵉ":"Ʃ","∬":"ʃʃ","∭":"ʃʃʃ","⨌":"ʃʃʃʃ","𝐭":"t","𝑡":"t","𝒕":"t","𝓉":"t","𝓽":"t","𝔱":"t","𝕥":"t","𝖙":"t","𝗍":"t","𝘁":"t","𝘵":"t","𝙩":"t","𝚝":"t","⊤":"T","⟙":"T","🝨":"T",Ｔ:"T","𝐓":"T","𝑇":"T","𝑻":"T","𝒯":"T","𝓣":"T","𝔗":"T","𝕋":"T","𝕿":"T","𝖳":"T","𝗧":"T","𝘛":"T","𝙏":"T","𝚃":"T",Τ:"T","𝚻":"T","𝛵":"T","𝜯":"T","𝝩":"T","𝞣":"T","Ⲧ":"T",Т:"T",Ꭲ:"T","ꓔ":"T","𖼊":"T","𑢼":"T","𐊗":"T","𐊱":"T","𐌕":"T",ƭ:"t̔","⍡":"T̈","Ⱦ":"T̸",Ț:"Ţ",Ʈ:"T̨",Ҭ:"T̩","₮":"T⃫",ŧ:"t̵",Ŧ:"T̵","ᵵ":"t̴",Ⴀ:"Ꞇ","Ꜩ":"T3",ʨ:"tɕ","℡":"TEL","ꝷ":"tf",ʦ:"ts",ʧ:"tʃ","ꜩ":"tȝ",τ:"ᴛ","𝛕":"ᴛ","𝜏":"ᴛ","𝝉":"ᴛ","𝞃":"ᴛ","𝞽":"ᴛ",т:"ᴛ","ꭲ":"ᴛ",ҭ:"ᴛ̩",ţ:"ƫ",ț:"ƫ",Ꮏ:"ƫ","𝐮":"u","𝑢":"u","𝒖":"u","𝓊":"u","𝓾":"u","𝔲":"u","𝕦":"u","𝖚":"u","𝗎":"u","𝘂":"u","𝘶":"u","𝙪":"u","𝚞":"u","ꞟ":"u","ᴜ":"u","ꭎ":"u","ꭒ":"u",ʋ:"u",υ:"u","𝛖":"u","𝜐":"u","𝝊":"u","𝞄":"u","𝞾":"u",ս:"u","𐓶":"u","𑣘":"u","∪":"U","⋃":"U","𝐔":"U","𝑈":"U","𝑼":"U","𝒰":"U","𝓤":"U","𝔘":"U","𝕌":"U","𝖀":"U","𝖴":"U","𝗨":"U","𝘜":"U","𝙐":"U","𝚄":"U",Ս:"U",ሀ:"U","𐓎":"U",ᑌ:"U","ꓴ":"U","𖽂":"U","𑢸":"U",ǔ:"ŭ",Ǔ:"Ŭ","ᵾ":"u̵","ꮜ":"u̵","Ʉ":"U̵",Ꮜ:"U̵",ᑘ:"U·",ᑧ:"U'","ᵫ":"ue","ꭣ":"uo",ṃ:"ꭑ",պ:"ɰ",ሣ:"ɰ","℧":"Ʊ",ᘮ:"Ʊ",ᘴ:"Ʊ","ᵿ":"ʊ̵","∨":"v","⋁":"v",ｖ:"v","ⅴ":"v","𝐯":"v","𝑣":"v","𝒗":"v","𝓋":"v","𝓿":"v","𝔳":"v","𝕧":"v","𝖛":"v","𝗏":"v","𝘃":"v","𝘷":"v","𝙫":"v","𝚟":"v","ᴠ":"v",ν:"v","𝛎":"v","𝜈":"v","𝝂":"v","𝝼":"v","𝞶":"v",ѵ:"v",ט:"v","𑜆":"v","ꮩ":"v","𑣀":"v","𝈍":"V","٧":"V","۷":"V","Ⅴ":"V","𝐕":"V","𝑉":"V","𝑽":"V","𝒱":"V","𝓥":"V","𝔙":"V","𝕍":"V","𝖁":"V","𝖵":"V","𝗩":"V","𝘝":"V","𝙑":"V","𝚅":"V",Ѵ:"V","ⴸ":"V",Ꮩ:"V",ᐯ:"V","ꛟ":"V","ꓦ":"V","𖼈":"V","𑢠":"V","𐔝":"V","𐆗":"V̵",ᐻ:"V·","🝬":"VB","ⅵ":"vi","ⅶ":"vii","ⅷ":"viii","Ⅵ":"Vl","Ⅶ":"Vll","Ⅷ":"Vlll","🜈":"Vᷤ","ᴧ":"ʌ","𐓘":"ʌ","٨":"Ʌ","۸":"Ʌ",Λ:"Ʌ","𝚲":"Ʌ","𝛬":"Ʌ","𝜦":"Ʌ","𝝠":"Ʌ","𝞚":"Ʌ",Л:"Ʌ","ⴷ":"Ʌ","𐒰":"Ʌ",ᐱ:"Ʌ","ꛎ":"Ʌ","ꓥ":"Ʌ","𖼽":"Ʌ","𐊍":"Ʌ","Ӆ":"Ʌ̦",ᐽ:"Ʌ·",ɯ:"w","𝐰":"w","𝑤":"w","𝒘":"w","𝓌":"w","𝔀":"w","𝔴":"w","𝕨":"w","𝖜":"w","𝗐":"w","𝘄":"w","𝘸":"w","𝙬":"w","𝚠":"w","ᴡ":"w",ѡ:"w","ԝ":"w",ա:"w","𑜊":"w","𑜎":"w","𑜏":"w","ꮃ":"w","𑣯":"W","𑣦":"W","𝐖":"W","𝑊":"W","𝑾":"W","𝒲":"W","𝓦":"W","𝔚":"W","𝕎":"W","𝖂":"W","𝖶":"W","𝗪":"W","𝘞":"W","𝙒":"W","𝚆":"W","Ԝ":"W",Ꮃ:"W",Ꮤ:"W","ꓪ":"W",ѽ:"w҆҇","𑓅":"ẇ","₩":"W̵","ꝡ":"w̦","ᴍ":"ʍ",м:"ʍ","ꮇ":"ʍ","ӎ":"ʍ̦","᙮":"x","×":"x","⤫":"x","⤬":"x","⨯":"x",ｘ:"x","ⅹ":"x","𝐱":"x","𝑥":"x","𝒙":"x","𝓍":"x","𝔁":"x","𝔵":"x","𝕩":"x","𝖝":"x","𝗑":"x","𝘅":"x","𝘹":"x","𝙭":"x","𝚡":"x",х:"x",ᕁ:"x",ᕽ:"x","ⷯ":"ͯ","᙭":"X","╳":"X","𐌢":"X","𑣬":"X",Ｘ:"X","Ⅹ":"X","𝐗":"X","𝑋":"X","𝑿":"X","𝒳":"X","𝓧":"X","𝔛":"X","𝕏":"X","𝖃":"X","𝖷":"X","𝗫":"X","𝘟":"X","𝙓":"X","𝚇":"X","Ꭓ":"X",Χ:"X","𝚾":"X","𝛸":"X","𝜲":"X","𝝬":"X","𝞦":"X","Ⲭ":"X",Х:"X","ⵝ":"X",ᚷ:"X","ꓫ":"X","𐊐":"X","𐊴":"X","𐌗":"X","𐔧":"X","⨰":"ẋ",Ҳ:"X̩","𐆖":"X̵","ⅺ":"xi","ⅻ":"xii","Ⅺ":"Xl","Ⅻ":"Xll",ɣ:"y","ᶌ":"y",ｙ:"y","𝐲":"y","𝑦":"y","𝒚":"y","𝓎":"y","𝔂":"y","𝔶":"y","𝕪":"y","𝖞":"y","𝗒":"y","𝘆":"y","𝘺":"y","𝙮":"y","𝚢":"y",ʏ:"y","ỿ":"y","ꭚ":"y",γ:"y","ℽ":"y","𝛄":"y","𝛾":"y","𝜸":"y","𝝲":"y","𝞬":"y",у:"y",ү:"y",ყ:"y","𑣜":"y",Ｙ:"Y","𝐘":"Y","𝑌":"Y","𝒀":"Y","𝒴":"Y","𝓨":"Y","𝔜":"Y","𝕐":"Y","𝖄":"Y","𝖸":"Y","𝗬":"Y","𝘠":"Y","𝙔":"Y","𝚈":"Y",Υ:"Y",ϒ:"Y","𝚼":"Y","𝛶":"Y","𝜰":"Y","𝝪":"Y","𝞤":"Y","Ⲩ":"Y",У:"Y",Ү:"Y",Ꭹ:"Y",Ꮍ:"Y","ꓬ":"Y","𖽃":"Y","𑢤":"Y","𐊲":"Y",ƴ:"y̔","ɏ":"y̵",ұ:"y̵","¥":"Y̵","Ɏ":"Y̵",Ұ:"Y̵",ʒ:"ȝ","ꝫ":"ȝ","ⳍ":"ȝ",ӡ:"ȝ",ჳ:"ȝ","𝐳":"z","𝑧":"z","𝒛":"z","𝓏":"z","𝔃":"z","𝔷":"z","𝕫":"z","𝖟":"z","𝗓":"z","𝘇":"z","𝘻":"z","𝙯":"z","𝚣":"z","ᴢ":"z","ꮓ":"z","𑣄":"z","𐋵":"Z","𑣥":"Z",Ｚ:"Z",ℤ:"Z",ℨ:"Z","𝐙":"Z","𝑍":"Z","𝒁":"Z","𝒵":"Z","𝓩":"Z","𝖅":"Z","𝖹":"Z","𝗭":"Z","𝘡":"Z","𝙕":"Z","𝚉":"Z",Ζ:"Z","𝚭":"Z","𝛧":"Z","𝜡":"Z","𝝛":"Z","𝞕":"Z",Ꮓ:"Z","ꓜ":"Z","𑢩":"Z",ʐ:"z̨",ƶ:"z̵",Ƶ:"Z̵",ȥ:"z̦",Ȥ:"Z̦","ᵶ":"z̴",ƿ:"þ","ϸ":"þ","Ϸ":"Þ","𐓄":"Þ","⁹":"ꝰ","ᴤ":"ƨ",ϩ:"ƨ","ꙅ":"ƨ",ь:"ƅ","ꮟ":"ƅ",ы:"ƅi","ꭾ":"ɂ",ˤ:"ˁ","ꛍ":"ʡ","⊙":"ʘ","☉":"ʘ","⨀":"ʘ","Ꙩ":"ʘ","ⵙ":"ʘ","𐓃":"ʘ","ℾ":"Γ","𝚪":"Γ","𝛤":"Γ","𝜞":"Γ","𝝘":"Γ","𝞒":"Γ","Ⲅ":"Γ",Г:"Γ",Ꮁ:"Γ",ᒥ:"Γ","𖼇":"Γ",Ғ:"Γ̵",ᒯ:"Γ·",Ґ:"Γ'","∆":"Δ","△":"Δ","🜂":"Δ","𝚫":"Δ","𝛥":"Δ","𝜟":"Δ","𝝙":"Δ","𝞓":"Δ","Ⲇ":"Δ","ⵠ":"Δ",ᐃ:"Δ","𖼚":"Δ","𐊅":"Δ","𐊣":"Δ","⍙":"Δ̲",ᐏ:"Δ·",ᐬ:"Δᐠ","𝟋":"ϝ","𝛇":"ζ","𝜁":"ζ","𝜻":"ζ","𝝵":"ζ","𝞯":"ζ","ⳤ":"ϗ","𝛌":"λ","𝜆":"λ","𝝀":"λ","𝝺":"λ","𝞴":"λ","Ⲗ":"λ","𐓛":"λ",µ:"μ","𝛍":"μ","𝜇":"μ","𝝁":"μ","𝝻":"μ","𝞵":"μ","𝛏":"ξ","𝜉":"ξ","𝝃":"ξ","𝝽":"ξ","𝞷":"ξ","𝚵":"Ξ","𝛯":"Ξ","𝜩":"Ξ","𝝣":"Ξ","𝞝":"Ξ",ϖ:"π","ℼ":"π","𝛑":"π","𝛡":"π","𝜋":"π","𝜛":"π","𝝅":"π","𝝕":"π","𝝿":"π","𝞏":"π","𝞹":"π","𝟉":"π","ᴨ":"π",п:"π","∏":"Π","ℿ":"Π","𝚷":"Π","𝛱":"Π","𝜫":"Π","𝝥":"Π","𝞟":"Π","Ⲡ":"Π",П:"Π","ꛛ":"Π","𐊭":"Ϙ","𐌒":"Ϙ",ϛ:"ς","𝛓":"ς","𝜍":"ς","𝝇":"ς","𝞁":"ς","𝞻":"ς","𝚽":"Φ","𝛷":"Φ","𝜱":"Φ","𝝫":"Φ","𝞥":"Φ","Ⲫ":"Φ",Ф:"Φ",Փ:"Φ",ቀ:"Φ","ᛰ":"Φ","𐊳":"Φ","ꭓ":"χ","ꭕ":"χ","𝛘":"χ","𝜒":"χ","𝝌":"χ","𝞆":"χ","𝟀":"χ","ⲭ":"χ","𝛙":"ψ","𝜓":"ψ","𝝍":"ψ","𝞇":"ψ","𝟁":"ψ",ѱ:"ψ","𐓹":"ψ","𝚿":"Ψ","𝛹":"Ψ","𝜳":"Ψ","𝝭":"Ψ","𝞧":"Ψ","Ⲯ":"Ψ",Ѱ:"Ψ","𐓑":"Ψ",ᛘ:"Ψ","𐊵":"Ψ","⍵":"ω","ꞷ":"ω","𝛚":"ω","𝜔":"ω","𝝎":"ω","𝞈":"ω","𝟂":"ω","ⲱ":"ω","ꙍ":"ω",Ω:"Ω","𝛀":"Ω","𝛺":"Ω","𝜴":"Ω","𝝮":"Ω","𝞨":"Ω",ᘯ:"Ω",ᘵ:"Ω","𐊶":"Ω","⍹":"ω̲",ώ:"ῴ","☰":"Ⲷ","Ⳝ":"Ϭ",җ:"ж̩",Җ:"Ж̩","𝈋":"И","Ͷ":"И","ꚡ":"И","𐐥":"И",Й:"Ѝ","Ҋ":"Ѝ̦",ѝ:"й","ҋ":"й̦","𐒼":"Ӄ","ᴫ":"л","ӆ":"л̦","ꭠ":"љ","𐓫":"ꙩ","ᷮ":"ⷬ","𐓍":"Ћ","𝈂":"Ӿ","𝈢":"Ѡ",Ꮗ:"Ѡ",ᗯ:"Ѡ",Ѽ:"Ѡ҆҇","ᣭ":"Ѡ·","Ꞷ":"Ꙍ",ӌ:"ҷ",Ӌ:"Ҷ",Ҿ:"Ҽ̨","ⲽ":"ш","Ⲽ":"Ш","Ꙑ":"Ъl","℈":"Э","🜁":"Ꙙ","𖼜":"Ꙙ","ꦒ":"ⰿ",և:"եւ",ኔ:"ձ",ﬔ:"մե",ﬕ:"մի",ﬗ:"մխ",ﬓ:"մն","∩":"Ո","⋂":"Ո","𝉅":"Ո",በ:"Ո",ᑎ:"Ո","ꓵ":"Ո",ᑚ:"Ո·",ᑨ:"Ո'",ﬖ:"վն","₽":"Ք","˓":"ՙ",ʿ:"ՙ",ℵ:"א",ﬡ:"א",אָ:"אַ",אּ:"אַ",ﭏ:"אל",ℶ:"ב",ℷ:"ג",ℸ:"ד",ﬢ:"ד",ﬣ:"ה",יּ:"יִ",ﬤ:"כ",ﬥ:"ל",ﬦ:"ם",ﬠ:"ע",ﬧ:"ר",שׂ:"שׁ",שּ:"שׁ",שּׂ:"שּׁ",ﬨ:"ת",ﺀ:"ء","۽":"ء͈",ﺂ:"آ",ﺁ:"آ",ﭑ:"ٱ",ﭐ:"ٱ","𞸁":"ب","𞸡":"ب","𞹡":"ب","𞺁":"ب","𞺡":"ب",ﺑ:"ب",ﺒ:"ب",ﺐ:"ب",ﺏ:"ب","ݑ":"بۛ","ࢶ":"بۢ","ࢡ":"بٔ",ﲠ:"بo",ﳢ:"بo",ﲜ:"بج",ﰅ:"بج",ﲝ:"بح",ﰆ:"بح",ﷂ:"بحى",ﲞ:"بخ",ﰇ:"بخ",ﳒ:"بخ",ﱋ:"بخ",ﶞ:"بخى",ﱪ:"بر",ﱫ:"بز",ﲟ:"بم",ﳡ:"بم",ﱬ:"بم",ﰈ:"بم",ﱭ:"بن",ﱮ:"بى",ﰉ:"بى",ﱯ:"بى",ﰊ:"بى",ﭔ:"ٻ",ﭕ:"ٻ",ﭓ:"ٻ",ﭒ:"ٻ",ې:"ٻ",ﯦ:"ٻ",ﯧ:"ٻ",ﯥ:"ٻ",ﯤ:"ٻ",ﭜ:"ڀ",ﭝ:"ڀ",ﭛ:"ڀ",ﭚ:"ڀ","ࢩ":"ݔ","ݧ":"ݔ","⍥":"ة",ö:"ة",ﺔ:"ة",ﺓ:"ة",ۃ:"ة","𞸕":"ت","𞸵":"ت","𞹵":"ت","𞺕":"ت","𞺵":"ت",ﺗ:"ت",ﺘ:"ت",ﺖ:"ت",ﺕ:"ت",ﲥ:"تo",ﳤ:"تo",ﲡ:"تج",ﰋ:"تج",ﵐ:"تجم",ﶠ:"تجى",ﶟ:"تجى",ﲢ:"تح",ﰌ:"تح",ﵒ:"تحج",ﵑ:"تحج",ﵓ:"تحم",ﲣ:"تخ",ﰍ:"تخ",ﵔ:"تخم",ﶢ:"تخى",ﶡ:"تخى",ﱰ:"تر",ﱱ:"تز",ﲤ:"تم",ﳣ:"تم",ﱲ:"تم",ﰎ:"تم",ﵕ:"تمج",ﵖ:"تمح",ﵗ:"تمخ",ﶤ:"تمى",ﶣ:"تمى",ﱳ:"تن",ﱴ:"تى",ﰏ:"تى",ﱵ:"تى",ﰐ:"تى",ﭠ:"ٺ",ﭡ:"ٺ",ﭟ:"ٺ",ﭞ:"ٺ",ﭤ:"ٿ",ﭥ:"ٿ",ﭣ:"ٿ",ﭢ:"ٿ","𞸂":"ج","𞸢":"ج","𞹂":"ج","𞹢":"ج","𞺂":"ج","𞺢":"ج",ﺟ:"ج",ﺠ:"ج",ﺞ:"ج",ﺝ:"ج",ﲧ:"جح",ﰕ:"جح",ﶦ:"جحى",ﶾ:"جحى",ﷻ:"جل جلlلo",ﲨ:"جم",ﰖ:"جم",ﵙ:"جمح",ﵘ:"جمح",ﶧ:"جمى",ﶥ:"جمى",ﴝ:"جى",ﴁ:"جى",ﴞ:"جى",ﴂ:"جى",ﭸ:"ڃ",ﭹ:"ڃ",ﭷ:"ڃ",ﭶ:"ڃ",ﭴ:"ڄ",ﭵ:"ڄ",ﭳ:"ڄ",ﭲ:"ڄ",ﭼ:"چ",ﭽ:"چ",ﭻ:"چ",ﭺ:"چ",ﮀ:"ڇ",ﮁ:"ڇ",ﭿ:"ڇ",ﭾ:"ڇ","𞸇":"ح","𞸧":"ح","𞹇":"ح","𞹧":"ح","𞺇":"ح","𞺧":"ح",ﺣ:"ح",ﺤ:"ح",ﺢ:"ح",ﺡ:"ح",څ:"حۛ",ځ:"حٔ","ݲ":"حٔ",ﲩ:"حج",ﰗ:"حج",ﶿ:"حجى",ﲪ:"حم",ﰘ:"حم",ﵛ:"حمى",ﵚ:"حمى",ﴛ:"حى",ﳿ:"حى",ﴜ:"حى",ﴀ:"حى","𞸗":"خ","𞸷":"خ","𞹗":"خ","𞹷":"خ","𞺗":"خ","𞺷":"خ",ﺧ:"خ",ﺨ:"خ",ﺦ:"خ",ﺥ:"خ",ﲫ:"خج",ﰙ:"خج",ﰚ:"خح",ﲬ:"خم",ﰛ:"خم",ﴟ:"خى",ﴃ:"خى",ﴠ:"خى",ﴄ:"خى","𐋡":"د","𞸃":"د","𞺃":"د","𞺣":"د",ﺪ:"د",ﺩ:"د",ڈ:"دؕ",ﮉ:"دؕ",ﮈ:"دؕ",ڎ:"دۛ",ﮇ:"دۛ",ﮆ:"دۛ","ۮ":"د̂","ࢮ":"د̤̣","𞸘":"ذ","𞺘":"ذ","𞺸":"ذ",ﺬ:"ذ",ﺫ:"ذ",ﱛ:"ذٰ",ڋ:"ڊؕ",ﮅ:"ڌ",ﮄ:"ڌ",ﮃ:"ڍ",ﮂ:"ڍ","𞸓":"ر","𞺓":"ر","𞺳":"ر",ﺮ:"ر",ﺭ:"ر",ڑ:"رؕ",ﮍ:"رؕ",ﮌ:"رؕ",ژ:"رۛ",ﮋ:"رۛ",ﮊ:"رۛ",ڒ:"ر̆","ࢹ":"ر̆̇","ۯ":"ر̂","ݬ":"رٔ",ﱜ:"رٰ",ﷶ:"رسول","﷼":"رىlل","𞸆":"ز","𞺆":"ز","𞺦":"ز",ﺰ:"ز",ﺯ:"ز","ࢲ":"ز̂","ݱ":"ڗؕ","𞸎":"س","𞸮":"س","𞹎":"س","𞹮":"س","𞺎":"س","𞺮":"س",ﺳ:"س",ﺴ:"س",ﺲ:"س",ﺱ:"س",ش:"سۛ","𞸔":"سۛ","𞸴":"سۛ","𞹔":"سۛ","𞹴":"سۛ","𞺔":"سۛ","𞺴":"سۛ",ﺷ:"سۛ",ﺸ:"سۛ",ﺶ:"سۛ",ﺵ:"سۛ","ݾ":"س̂",ﴱ:"سo",ﳨ:"سo",ﴲ:"سۛo",ﳪ:"سۛo",ﲭ:"سج",ﴴ:"سج",ﰜ:"سج",ﴭ:"سۛج",ﴷ:"سۛج",ﴥ:"سۛج",ﴉ:"سۛج",ﵝ:"سجح",ﵞ:"سجى",ﵩ:"سۛجى",ﲮ:"سح",ﴵ:"سح",ﰝ:"سح",ﴮ:"سۛح",ﴸ:"سۛح",ﴦ:"سۛح",ﴊ:"سۛح",ﵜ:"سحج",ﵨ:"سۛحم",ﵧ:"سۛحم",ﶪ:"سۛحى",ﲯ:"سخ",ﴶ:"سخ",ﰞ:"سخ",ﴯ:"سۛخ",ﴹ:"سۛخ",ﴧ:"سۛخ",ﴋ:"سۛخ",ﶨ:"سخى",ﷆ:"سخى",ﴪ:"سر",ﴎ:"سر",ﴩ:"سۛر",ﴍ:"سۛر",ﲰ:"سم",ﳧ:"سم",ﰟ:"سم",ﴰ:"سۛم",ﳩ:"سۛم",ﴨ:"سۛم",ﴌ:"سۛم",ﵡ:"سمج",ﵠ:"سمح",ﵟ:"سمح",ﵫ:"سۛمخ",ﵪ:"سۛمخ",ﵣ:"سمم",ﵢ:"سمم",ﵭ:"سۛمم",ﵬ:"سۛمم",ﴗ:"سى",ﳻ:"سى",ﴘ:"سى",ﳼ:"سى",ﴙ:"سۛى",ﳽ:"سۛى",ﴚ:"سۛى",ﳾ:"سۛى","𐋲":"ص","𞸑":"ص","𞸱":"ص","𞹑":"ص","𞹱":"ص","𞺑":"ص","𞺱":"ص",ﺻ:"ص",ﺼ:"ص",ﺺ:"ص",ﺹ:"ص",ڞ:"صۛ","ࢯ":"ص̤̣",ﲱ:"صح",ﰠ:"صح",ﵥ:"صحح",ﵤ:"صحح",ﶩ:"صحى",ﲲ:"صخ",ﴫ:"صر",ﴏ:"صر",ﷵ:"صلعم",ﷹ:"صلى",ﷰ:"صلى",ﷺ:"صلى lللo علىo وسلم",ﲳ:"صم",ﰡ:"صم",ﷅ:"صمم",ﵦ:"صمم",ﴡ:"صى",ﴅ:"صى",ﴢ:"صى",ﴆ:"صى","𞸙":"ض","𞸹":"ض","𞹙":"ض","𞹹":"ض","𞺙":"ض","𞺹":"ض",ﺿ:"ض",ﻀ:"ض",ﺾ:"ض",ﺽ:"ض",ﲴ:"ضج",ﰢ:"ضج",ﲵ:"ضح",ﰣ:"ضح",ﵮ:"ضحى",ﶫ:"ضحى",ﲶ:"ضخ",ﰤ:"ضخ",ﵰ:"ضخم",ﵯ:"ضخم",ﴬ:"ضر",ﴐ:"ضر",ﲷ:"ضم",ﰥ:"ضم",ﴣ:"ضى",ﴇ:"ضى",ﴤ:"ضى",ﴈ:"ضى","𐋨":"ط","𞸈":"ط","𞹨":"ط","𞺈":"ط","𞺨":"ط",ﻃ:"ط",ﻄ:"ط",ﻂ:"ط",ﻁ:"ط",ڟ:"طۛ",ﲸ:"طح",ﰦ:"طح",ﴳ:"طم",ﴺ:"طم",ﰧ:"طم",ﵲ:"طمح",ﵱ:"طمح",ﵳ:"طمم",ﵴ:"طمى",ﴑ:"طى",ﳵ:"طى",ﴒ:"طى",ﳶ:"طى","𞸚":"ظ","𞹺":"ظ","𞺚":"ظ","𞺺":"ظ",ﻇ:"ظ",ﻈ:"ظ",ﻆ:"ظ",ﻅ:"ظ",ﲹ:"ظم",ﴻ:"ظم",ﰨ:"ظم","؏":"ع","𞸏":"ع","𞸯":"ع","𞹏":"ع","𞹯":"ع","𞺏":"ع","𞺯":"ع",ﻋ:"ع",ﻌ:"ع",ﻊ:"ع",ﻉ:"ع",ﲺ:"عج",ﰩ:"عج",ﷄ:"عجم",ﵵ:"عجم",ﷷ:"علىo",ﲻ:"عم",ﰪ:"عم",ﵷ:"عمم",ﵶ:"عمم",ﵸ:"عمى",ﶶ:"عمى",ﴓ:"عى",ﳷ:"عى",ﴔ:"عى",ﳸ:"عى","𞸛":"غ","𞸻":"غ","𞹛":"غ","𞹻":"غ","𞺛":"غ","𞺻":"غ",ﻏ:"غ",ﻐ:"غ",ﻎ:"غ",ﻍ:"غ",ﲼ:"غج",ﰫ:"غج",ﲽ:"غم",ﰬ:"غم",ﵹ:"غمم",ﵻ:"غمى",ﵺ:"غمى",ﴕ:"غى",ﳹ:"غى",ﴖ:"غى",ﳺ:"غى","𞸐":"ف","𞸰":"ف","𞹰":"ف","𞺐":"ف","𞺰":"ف",ﻓ:"ف",ﻔ:"ف",ﻒ:"ف",ﻑ:"ف",ڧ:"ف",ﲾ:"فج",ﰭ:"فج",ﲿ:"فح",ﰮ:"فح",ﳀ:"فخ",ﰯ:"فخ",ﵽ:"فخم",ﵼ:"فخم",ﳁ:"فم",ﰰ:"فم",ﷁ:"فمى",ﱼ:"فى",ﰱ:"فى",ﱽ:"فى",ﰲ:"فى","𞸞":"ڡ","𞹾":"ڡ","ࢻ":"ڡ","ٯ":"ڡ","𞸟":"ڡ","𞹟":"ڡ","ࢼ":"ڡ",ڤ:"ڡۛ",ﭬ:"ڡۛ",ﭭ:"ڡۛ",ﭫ:"ڡۛ",ﭪ:"ڡۛ",ڨ:"ڡۛ","ࢤ":"ڢۛ",ﭰ:"ڦ",ﭱ:"ڦ",ﭯ:"ڦ",ﭮ:"ڦ","𞸒":"ق","𞸲":"ق","𞹒":"ق","𞹲":"ق","𞺒":"ق","𞺲":"ق",ﻗ:"ق",ﻘ:"ق",ﻖ:"ق",ﻕ:"ق",ﳂ:"قح",ﰳ:"قح",ﷱ:"قلى",ﳃ:"قم",ﰴ:"قم",ﶴ:"قمح",ﵾ:"قمح",ﵿ:"قمم",ﶲ:"قمى",ﱾ:"قى",ﰵ:"قى",ﱿ:"قى",ﰶ:"قى","𞸊":"ك","𞸪":"ك","𞹪":"ك",ﻛ:"ك",ﻜ:"ك",ﻚ:"ك",ﻙ:"ك",ک:"ك",ﮐ:"ك",ﮑ:"ك",ﮏ:"ك",ﮎ:"ك",ڪ:"ك",ڭ:"كۛ",ﯕ:"كۛ",ﯖ:"كۛ",ﯔ:"كۛ",ﯓ:"كۛ","ݣ":"كۛ",ﲀ:"كl",ﰷ:"كl",ﳄ:"كج",ﰸ:"كج",ﳅ:"كح",ﰹ:"كح",ﳆ:"كخ",ﰺ:"كخ",ﳇ:"كل",ﳫ:"كل",ﲁ:"كل",ﰻ:"كل",ﳈ:"كم",ﳬ:"كم",ﲂ:"كم",ﰼ:"كم",ﷃ:"كمم",ﶻ:"كمم",ﶷ:"كمى",ﲃ:"كى",ﰽ:"كى",ﲄ:"كى",ﰾ:"كى","ݢ":"ڬ",ﮔ:"گ",ﮕ:"گ",ﮓ:"گ",ﮒ:"گ","ࢰ":"گ",ڴ:"گۛ",ﮜ:"ڱ",ﮝ:"ڱ",ﮛ:"ڱ",ﮚ:"ڱ",ﮘ:"ڳ",ﮙ:"ڳ",ﮗ:"ڳ",ﮖ:"ڳ","𞸋":"ل","𞸫":"ل","𞹋":"ل","𞺋":"ل","𞺫":"ل",ﻟ:"ل",ﻠ:"ل",ﻞ:"ل",ﻝ:"ل",ڷ:"لۛ",ڵ:"ل̆",ﻼ:"لl",ﻻ:"لl",ﻺ:"لlٕ",ﻹ:"لlٕ",ﻸ:"لlٴ",ﻷ:"لlٴ",ﳍ:"لo",ﻶ:"لآ",ﻵ:"لآ",ﳉ:"لج",ﰿ:"لج",ﶃ:"لجج",ﶄ:"لجج",ﶺ:"لجم",ﶼ:"لجم",ﶬ:"لجى",ﳊ:"لح",ﱀ:"لح",ﶵ:"لحم",ﶀ:"لحم",ﶂ:"لحى",ﶁ:"لحى",ﳋ:"لخ",ﱁ:"لخ",ﶆ:"لخم",ﶅ:"لخم",ﳌ:"لم",ﳭ:"لم",ﲅ:"لم",ﱂ:"لم",ﶈ:"لمح",ﶇ:"لمح",ﶭ:"لمى",ﲆ:"لى",ﱃ:"لى",ﲇ:"لى",ﱄ:"لى","𞸌":"م","𞸬":"م","𞹬":"م","𞺌":"م","𞺬":"م",ﻣ:"م",ﻤ:"م",ﻢ:"م",ﻡ:"م","ࢧ":"مۛ","۾":"م͈",ﲈ:"مl",ﳎ:"مج",ﱅ:"مج",ﶌ:"مجح",ﶒ:"مجخ",ﶍ:"مجم",ﷀ:"مجى",ﳏ:"مح",ﱆ:"مح",ﶉ:"محج",ﶊ:"محم",ﷴ:"محمد",ﶋ:"محى",ﳐ:"مخ",ﱇ:"مخ",ﶎ:"مخج",ﶏ:"مخم",ﶹ:"مخى",ﳑ:"مم",ﲉ:"مم",ﱈ:"مم",ﶱ:"ممى",ﱉ:"مى",ﱊ:"مى","𞸍":"ن","𞸭":"ن","𞹍":"ن","𞹭":"ن","𞺍":"ن","𞺭":"ن",ﻧ:"ن",ﻨ:"ن",ﻦ:"ن",ﻥ:"ن","ݨ":"نؕ","ݩ":"ن̆",ﳖ:"نo",ﳯ:"نo",ﶸ:"نجح",ﶽ:"نجح",ﶘ:"نجم",ﶗ:"نجم",ﶙ:"نجى",ﷇ:"نجى",ﳓ:"نح",ﱌ:"نح",ﶕ:"نحم",ﶖ:"نحى",ﶳ:"نحى",ﳔ:"نخ",ﱍ:"نخ",ﲊ:"نر",ﲋ:"نز",ﳕ:"نم",ﳮ:"نم",ﲌ:"نم",ﱎ:"نم",ﶛ:"نمى",ﶚ:"نمى",ﲍ:"نن",ﲎ:"نى",ﱏ:"نى",ﲏ:"نى",ﱐ:"نى",ۂ:"ۀ",ﮥ:"ۀ",ﮤ:"ۀ","𐋤":"و","𞸅":"و","𞺅":"و","𞺥":"و",ﻮ:"و",ﻭ:"و","ࢱ":"و",ۋ:"وۛ",ﯟ:"وۛ",ﯞ:"وۛ",ۇ:"و̓",ﯘ:"و̓",ﯗ:"و̓",ۆ:"و̆",ﯚ:"و̆",ﯙ:"و̆",ۉ:"و̂",ﯣ:"و̂",ﯢ:"و̂",ۈ:"وٰ",ﯜ:"وٰ",ﯛ:"وٰ",ؤ:"وٴ",ﺆ:"وٴ",ﺅ:"وٴ",ٶ:"وٴ",ٷ:"و̓ٴ",ﯝ:"و̓ٴ",ﷸ:"وسلم",ﯡ:"ۅ",ﯠ:"ۅ","ٮ":"ى","𞸜":"ى","𞹼":"ى",ں:"ى","𞸝":"ى","𞹝":"ى",ﮟ:"ى",ﮞ:"ى","ࢽ":"ى",ﯨ:"ى",ﯩ:"ى",ﻰ:"ى",ﻯ:"ى",ي:"ى","𞸉":"ى","𞸩":"ى","𞹉":"ى","𞹩":"ى","𞺉":"ى","𞺩":"ى",ﻳ:"ى",ﻴ:"ى",ﻲ:"ى",ﻱ:"ى",ی:"ى",ﯾ:"ى",ﯿ:"ى",ﯽ:"ى",ﯼ:"ى",ے:"ى",ﮯ:"ى",ﮮ:"ى",ٹ:"ىؕ",ﭨ:"ىؕ",ﭩ:"ىؕ",ﭧ:"ىؕ",ﭦ:"ىؕ",ڻ:"ىؕ",ﮢ:"ىؕ",ﮣ:"ىؕ",ﮡ:"ىؕ",ﮠ:"ىؕ",پ:"ىۛ",ﭘ:"ىۛ",ﭙ:"ىۛ",ﭗ:"ىۛ",ﭖ:"ىۛ",ث:"ىۛ","𞸖":"ىۛ","𞸶":"ىۛ","𞹶":"ىۛ","𞺖":"ىۛ","𞺶":"ىۛ",ﺛ:"ىۛ",ﺜ:"ىۛ",ﺚ:"ىۛ",ﺙ:"ىۛ",ڽ:"ىۛ",ۑ:"ىۛ","ؿ":"ىۛ","ࢷ":"ىۛۢ","ݖ":"ى̆",ێ:"ى̆","ࢺ":"ى̆̇","ؽ":"ى̂","ࢨ":"ىٔ",ﲐ:"ىٰ",ﱝ:"ىٰ",ﳞ:"ىo",ﳱ:"ىo",ﳦ:"ىۛo",ئ:"ىٴ",ﺋ:"ىٴ",ﺌ:"ىٴ",ﺊ:"ىٴ",ﺉ:"ىٴ",ٸ:"ىٴ",ﯫ:"ىٴl",ﯪ:"ىٴl",ﲛ:"ىٴo",ﳠ:"ىٴo",ﯭ:"ىٴo",ﯬ:"ىٴo",ﯸ:"ىٴٻ",ﯷ:"ىٴٻ",ﯶ:"ىٴٻ",ﲗ:"ىٴج",ﰀ:"ىٴج",ﲘ:"ىٴح",ﰁ:"ىٴح",ﲙ:"ىٴخ",ﱤ:"ىٴر",ﱥ:"ىٴز",ﲚ:"ىٴم",ﳟ:"ىٴم",ﱦ:"ىٴم",ﰂ:"ىٴم",ﱧ:"ىٴن",ﯯ:"ىٴو",ﯮ:"ىٴو",ﯱ:"ىٴو̓",ﯰ:"ىٴو̓",ﯳ:"ىٴو̆",ﯲ:"ىٴو̆",ﯵ:"ىٴوٰ",ﯴ:"ىٴوٰ",ﯻ:"ىٴى",ﯺ:"ىٴى",ﱨ:"ىٴى",ﯹ:"ىٴى",ﰃ:"ىٴى",ﱩ:"ىٴى",ﰄ:"ىٴى",ﳚ:"ىج",ﱕ:"ىج",ﰑ:"ىۛج",ﶯ:"ىجى",ﳛ:"ىح",ﱖ:"ىح",ﶮ:"ىحى",ﳜ:"ىخ",ﱗ:"ىخ",ﲑ:"ىر",ﱶ:"ىۛر",ﲒ:"ىز",ﱷ:"ىۛز",ﳝ:"ىم",ﳰ:"ىم",ﲓ:"ىم",ﱘ:"ىم",ﲦ:"ىۛم",ﳥ:"ىۛم",ﱸ:"ىۛم",ﰒ:"ىۛم",ﶝ:"ىمم",ﶜ:"ىمم",ﶰ:"ىمى",ﲔ:"ىن",ﱹ:"ىۛن",ﲕ:"ىى",ﱙ:"ىى",ﲖ:"ىى",ﱚ:"ىى",ﱺ:"ىۛى",ﰓ:"ىۛى",ﱻ:"ىۛى",ﰔ:"ىۛى",ﮱ:"ۓ",ﮰ:"ۓ","𐊸":"ⵀ","⁞":"ⵂ","⸽":"ⵂ","⦙":"ⵂ","︙":"ⵗ","⁝":"ⵗ","⋮":"ⵗ",Մ:"ሆ",Ռ:"ቡ",Ի:"ኮ",Պ:"ጣ",आ:"अा",ऒ:"अाॆ",ओ:"अाे",औ:"अाै","ऄ":"अॆ",ऑ:"अॉ",ऍ:"एॅ",ऎ:"एॆ",ऐ:"एे",ई:"र्इ",ઽ:"ऽ","𑇜":"ꣻ","𑇋":"ऺ","ુ":"ु","ૂ":"ू","ੋ":"ॆ","੍":"्","્":"्",আ:"অা",ৠ:"ঋৃ",ৡ:"ঋৃ","𑒒":"ঘ","𑒔":"চ","𑒖":"জ","𑒘":"ঞ","𑒙":"ট","𑒛":"ড","𑒪":"ণ","𑒞":"ত","𑒟":"থ","𑒠":"দ","𑒡":"ধ","𑒢":"ন","𑒣":"প","𑒩":"ব","𑒧":"ম","𑒨":"য","𑒫":"র","𑒝":"ল","𑒭":"ষ","𑒮":"স","𑓄":"ঽ","𑒰":"া","𑒱":"ি","𑒹":"ে","𑒼":"ো","𑒾":"ৌ","𑓂":"্","𑒽":"ৗ",ਉ:"ੳੁ",ਊ:"ੳੂ",ਆ:"ਅਾ",ਐ:"ਅੈ",ਔ:"ਅੌ",ਇ:"ੲਿ",ਈ:"ੲੀ",ਏ:"ੲੇ",આ:"અા",ઑ:"અાૅ",ઓ:"અાે",ઔ:"અાૈ",ઍ:"અૅ",એ:"અે",ઐ:"અૈ",ଆ:"ଅା","௮":"அ",ர:"ஈ","ா":"ஈ","௫":"ஈு","௨":"உ",ഉ:"உ",ஊ:"உள",ഊ:"உൗ","௭":"எ","௷":"எவ",ஜ:"ஐ",ജ:"ஐ","௧":"க","௪":"ச","௬":"சு","௲":"சூ","ഺ":"டி",ണ:"ண","௺":"நீ","௴":"மீ","௰":"ய",ഴ:"ழ","ௗ":"ள","ை":"ன",ശ:"ஶ","௸":"ஷ","ി":"ி","ീ":"ி","ொ":"ெஈ","ௌ":"ெள","ோ":"ேஈ",ಅ:"అ",ಆ:"ఆ",ಇ:"ఇ",ౠ:"ఋా",ౡ:"ఌా",ಒ:"ఒ",ఔ:"ఒౌ",ಔ:"ఒౌ",ఓ:"ఒౕ",ಓ:"ఒౕ",ಜ:"జ",ಞ:"ఞ",ఢ:"డ̣",ಣ:"ణ",థ:"ధּ",భ:"బ̣",ಯ:"య",ఠ:"రּ",ಱ:"ఱ",ಲ:"ల",ష:"వ̣",హ:"వా",మ:"వు","ూ":"ుా","ౄ":"ృా",ೡ:"ಌಾ",ഈ:"ഇൗ",ഐ:"എെ",ഓ:"ഒാ",ഔ:"ഒൗ",ൡ:"ഞ","൫":"ദ്ര","൹":"നു",ഌ:"നു",ങ:"നു","൯":"ന്","ൻ":"ന്","൬":"ന്ന","൚":"ന്മ",റ:"ര","൪":"ര്","ർ":"ര്","൮":"വ്ര","൶":"ഹ്മ","ൂ":"ു","ൃ":"ു","ൈ":"െെ","෪":"ජ","෫":"ද","𑐓":"𑐴𑑂𑐒","𑐙":"𑐴𑑂𑐘","𑐤":"𑐴𑑂𑐣","𑐪":"𑐴𑑂𑐩","𑐭":"𑐴𑑂𑐬","𑐯":"𑐴𑑂𑐮","𑗘":"𑖂","𑗙":"𑖂","𑗚":"𑖃","𑗛":"𑖄","𑗜":"𑖲","𑗝":"𑖳",ฃ:"ข",ด:"ค",ต:"ค",ม:"ฆ",ຈ:"จ",ซ:"ช",ฏ:"ฎ",ท:"ฑ",ບ:"บ",ປ:"ป",ຝ:"ฝ",ພ:"พ",ຟ:"ฟ",ฦ:"ภ",ຍ:"ย","។":"ฯ",ๅ:"า",ำ:"̊า","ិ":"ิ","ី":"ี","ឹ":"ึ","ឺ":"ื","ຸ":"ุ","ູ":"ู",แ:"เเ",ໜ:"ຫນ",ໝ:"ຫມ",ຳ:"̊າ","༂":"འུྂཿ","༃":"འུྂ༔",ཪ:"ར",ༀ:"ཨོཾ","ཷ":"ྲཱྀ","ཹ":"ླཱྀ","𑲲":"𑲪","ႁ":"ဂှ",က:"ဂာ","ၰ":"ဃှ","ၦ":"ပှ",ဟ:"ပာ","ၯ":"ပာှ","ၾ":"ၽှ",ဩ:"သြ",ဪ:"သြော်","႞":"ႃ̊",ឣ:"អ","᧐":"ᦞ","᧑":"ᦱ","᪀":"ᩅ","᪐":"ᩅ","꩓":"ꨁ","꩖":"ꨣ","᭒":"ᬍ","᭓":"ᬑ","᭘":"ᬨ","ꦣ":"ꦝ",ᢖ:"ᡜ",ᡕ:"ᠵ",ῶ:"Ꮿ",ᐍ:"ᐁ·",ᐫ:"ᐁᐠ",ᐑ:"ᐄ·",ᐓ:"ᐅ·",ᐭ:"ᐅᐠ",ᐕ:"ᐆ·",ᐘ:"ᐊ·",ᐮ:"ᐊᐠ",ᐚ:"ᐋ·","ᣝ":"ᐞᣟ",ᓑ:"ᐡ",ᕀ:"ᐩ",ᐿ:"ᐲ·",ᑃ:"ᐴ·","⍩":"ᐵ",ᑇ:"ᐹ·",ᑜ:"ᑏ·","⸧":"ᑐ","⊃":"ᑐ",ᑞ:"ᑐ·",ᑩ:"ᑐ'","⟉":"ᑐ/","⫗":"ᑐᑕ",ᑠ:"ᑑ·","⸦":"ᑕ","⊂":"ᑕ",ᑢ:"ᑕ·",ᑪ:"ᑕ'",ᑤ:"ᑖ·",ᑵ:"ᑫ·",ᒅ:"ᑫ'",ᑹ:"ᑮ·",ᑽ:"ᑰ·",ᘃ:"ᒉ",ᒓ:"ᒉ·",ᒕ:"ᒋ·",ᒗ:"ᒌ·",ᒛ:"ᒎ·",ᘂ:"ᒐ",ᒝ:"ᒐ·",ᒟ:"ᒑ·",ᒭ:"ᒣ·",ᒱ:"ᒦ·",ᒳ:"ᒧ·",ᒵ:"ᒨ·",ᒹ:"ᒫ·",ᓊ:"ᓀ·","ᣇ":"ᓂ·","ᣉ":"ᓃ·","ᣋ":"ᓄ·","ᣍ":"ᓅ·",ᓌ:"ᓇ·",ᓎ:"ᓈ·",ᘄ:"ᓓ",ᓝ:"ᓓ·",ᓟ:"ᓕ·",ᓡ:"ᓖ·",ᓣ:"ᓗ·",ᓥ:"ᓘ·",ᘇ:"ᓚ",ᓧ:"ᓚ·",ᓩ:"ᓛ·",ᓷ:"ᓭ·",ᓹ:"ᓯ·",ᓻ:"ᓰ·",ᓽ:"ᓱ·",ᓿ:"ᓲ·",ᔁ:"ᓴ·",ᔃ:"ᓵ·",ᔌ:"ᔋ<",ᔎ:"ᔋb",ᔍ:"ᔋᑕ",ᔏ:"ᔋᒐ",ᔘ:"ᔐ·",ᔚ:"ᔑ·",ᔜ:"ᔒ·",ᔞ:"ᔓ·",ᔠ:"ᔔ·",ᔢ:"ᔕ·",ᔤ:"ᔖ·",ᔲ:"ᔨ·",ᔴ:"ᔩ·",ᔶ:"ᔪ·",ᔸ:"ᔫ·",ᔺ:"ᔭ·",ᔼ:"ᔮ·",ᘢ:"ᕃ","ᣠ":"ᕃ·",ᘣ:"ᕆ",ᘤ:"ᕊ",ᕏ:"ᕌ·",ᖃ:"ᕐb",ᖄ:"ᕐḃ",ᖁ:"ᕐd",ᕿ:"ᕐP",ᙯ:"ᕐᑫ",ᕾ:"ᕐᑬ",ᖀ:"ᕐᑮ",ᖂ:"ᕐᑰ",ᖅ:"ᕐᒃ",ᕜ:"ᕚ·","ᣣ":"ᕞ·","ᣤ":"ᕦ·",ᕩ:"ᕧ·","ᣥ":"ᕫ·","ᣨ":"ᖆ·",ᖑ:"ᖕJ",ᙰ:"ᖕᒉ",ᖎ:"ᖕᒊ",ᖏ:"ᖕᒋ",ᖐ:"ᖕᒌ",ᖒ:"ᖕᒎ",ᖓ:"ᖕᒐ",ᖔ:"ᖕᒑ",ᙳ:"ᖖJ",ᙱ:"ᖖᒋ",ᙲ:"ᖖᒌ",ᙴ:"ᖖᒎ",ᙵ:"ᖖᒐ",ᙶ:"ᖖᒑ","ᣪ":"ᖗ·","ᙷ":"ᖧ·","ᙸ":"ᖨ·","ᙹ":"ᖩ·","ᙺ":"ᖪ·","ᙻ":"ᖫ·","ᙼ":"ᖬ·","ᙽ":"ᖭ·","⪫":"ᗒ","⪪":"ᗕ","ꓷ":"ᗡ","ᣰ":"ᗴ·","ᣲ":"ᘛ·","ᶻ":"ᙆ","ꓭ":"ᙠ","ᶺ":"ᣔ","ᴾ":"ᣖ","ᣜ":"ᣟᐞ",ˡ:"ᣳ",ʳ:"ᣴ",ˢ:"ᣵ","ᣛ":"ᣵ","ꚰ":"ᚹ",ᛡ:"ᚼ","⍿":"ᚽ",ᛂ:"ᚽ","𝈿":"ᛋ","↑":"ᛏ","↿":"ᛐ","⥮":"ᛐ⇂","⥣":"ᛐᛚ","ⵣ":"ᛯ","↾":"ᛚ","⨡":"ᛚ","⋄":"ᛜ","◇":"ᛜ","◊":"ᛜ","♢":"ᛜ","🝔":"ᛜ","𑢷":"ᛜ","𐊔":"ᛜ","⍚":"ᛜ̲","⋈":"ᛞ","⨝":"ᛞ","𐓐":"ᛦ","↕":"ᛨ","𐳼":"𐲂","𐳺":"𐲥",ㄱ:"ᄀ",ᆨ:"ᄀ",ᄁ:"ᄀᄀ",ㄲ:"ᄀᄀ",ᆩ:"ᄀᄀ","ᇺ":"ᄀᄂ","ᅚ":"ᄀᄃ",ᇃ:"ᄀᄅ","ᇻ":"ᄀᄇ",ᆪ:"ᄀᄉ",ㄳ:"ᄀᄉ",ᇄ:"ᄀᄉᄀ","ᇼ":"ᄀᄎ","ᇽ":"ᄀᄏ","ᇾ":"ᄀᄒ",ㄴ:"ᄂ",ᆫ:"ᄂ",ᄓ:"ᄂᄀ",ᇅ:"ᄂᄀ",ᄔ:"ᄂᄂ",ㅥ:"ᄂᄂ","ᇿ":"ᄂᄂ",ᄕ:"ᄂᄃ",ㅦ:"ᄂᄃ",ᇆ:"ᄂᄃ","ퟋ":"ᄂᄅ",ᄖ:"ᄂᄇ","ᅛ":"ᄂᄉ",ᇇ:"ᄂᄉ",ㅧ:"ᄂᄉ","ᅜ":"ᄂᄌ",ᆬ:"ᄂᄌ",ㄵ:"ᄂᄌ","ퟌ":"ᄂᄎ",ᇉ:"ᄂᄐ","ᅝ":"ᄂᄒ",ᆭ:"ᄂᄒ",ㄶ:"ᄂᄒ",ᇈ:"ᄂᅀ",ㅨ:"ᄂᅀ",ㄷ:"ᄃ",ᆮ:"ᄃ",ᄗ:"ᄃᄀ",ᇊ:"ᄃᄀ",ᄄ:"ᄃᄃ",ㄸ:"ᄃᄃ","ퟍ":"ᄃᄃ","ퟎ":"ᄃᄃᄇ","ᅞ":"ᄃᄅ",ᇋ:"ᄃᄅ","ꥠ":"ᄃᄆ","ꥡ":"ᄃᄇ","ퟏ":"ᄃᄇ","ꥢ":"ᄃᄉ","ퟐ":"ᄃᄉ","ퟑ":"ᄃᄉᄀ","ꥣ":"ᄃᄌ","ퟒ":"ᄃᄌ","ퟓ":"ᄃᄎ","ퟔ":"ᄃᄐ",ㄹ:"ᄅ",ᆯ:"ᄅ","ꥤ":"ᄅᄀ",ᆰ:"ᄅᄀ",ㄺ:"ᄅᄀ","ꥥ":"ᄅᄀᄀ","ퟕ":"ᄅᄀᄀ",ᇌ:"ᄅᄀᄉ",ㅩ:"ᄅᄀᄉ","ퟖ":"ᄅᄀᄒ",ᄘ:"ᄅᄂ",ᇍ:"ᄅᄂ","ꥦ":"ᄅᄃ",ᇎ:"ᄅᄃ",ㅪ:"ᄅᄃ","ꥧ":"ᄅᄃᄃ",ᇏ:"ᄅᄃᄒ",ᄙ:"ᄅᄅ",ᇐ:"ᄅᄅ","ퟗ":"ᄅᄅᄏ","ꥨ":"ᄅᄆ",ᆱ:"ᄅᄆ",ㄻ:"ᄅᄆ",ᇑ:"ᄅᄆᄀ",ᇒ:"ᄅᄆᄉ","ퟘ":"ᄅᄆᄒ","ꥩ":"ᄅᄇ",ᆲ:"ᄅᄇ",ㄼ:"ᄅᄇ","ퟙ":"ᄅᄇᄃ","ꥪ":"ᄅᄇᄇ",ᇓ:"ᄅᄇᄉ",ㅫ:"ᄅᄇᄉ","ꥫ":"ᄅᄇᄋ",ᇕ:"ᄅᄇᄋ","ퟚ":"ᄅᄇᄑ",ᇔ:"ᄅᄇᄒ","ꥬ":"ᄅᄉ",ᆳ:"ᄅᄉ",ㄽ:"ᄅᄉ",ᇖ:"ᄅᄉᄉ",ᄛ:"ᄅᄋ","ퟝ":"ᄅᄋ","ꥭ":"ᄅᄌ","ꥮ":"ᄅᄏ",ᇘ:"ᄅᄏ",ᆴ:"ᄅᄐ",ㄾ:"ᄅᄐ",ᆵ:"ᄅᄑ",ㄿ:"ᄅᄑ",ᄚ:"ᄅᄒ",ㅀ:"ᄅᄒ",ᄻ:"ᄅᄒ",ᆶ:"ᄅᄒ","ퟲ":"ᄅᄒ",ᇗ:"ᄅᅀ",ㅬ:"ᄅᅀ","ퟛ":"ᄅᅌ",ᇙ:"ᄅᅙ",ㅭ:"ᄅᅙ","ퟜ":"ᄅᅙᄒ",ㅁ:"ᄆ",ᆷ:"ᄆ","ꥯ":"ᄆᄀ",ᇚ:"ᄆᄀ","ퟞ":"ᄆᄂ","ퟟ":"ᄆᄂᄂ","ꥰ":"ᄆᄃ",ᇛ:"ᄆᄅ","ퟠ":"ᄆᄆ",ᄜ:"ᄆᄇ",ㅮ:"ᄆᄇ",ᇜ:"ᄆᄇ","ퟡ":"ᄆᄇᄉ","ꥱ":"ᄆᄉ",ᇝ:"ᄆᄉ",ㅯ:"ᄆᄉ",ᇞ:"ᄆᄉᄉ",ᄝ:"ᄆᄋ",ㅱ:"ᄆᄋ",ᇢ:"ᄆᄋ","ퟢ":"ᄆᄌ",ᇠ:"ᄆᄎ",ᇡ:"ᄆᄒ",ᇟ:"ᄆᅀ",ㅰ:"ᄆᅀ",ㅂ:"ᄇ",ᆸ:"ᄇ",ᄞ:"ᄇᄀ",ㅲ:"ᄇᄀ",ᄟ:"ᄇᄂ",ᄠ:"ᄇᄃ",ㅳ:"ᄇᄃ","ퟣ":"ᄇᄃ",ᇣ:"ᄇᄅ","ퟤ":"ᄇᄅᄑ","ퟥ":"ᄇᄆ",ᄈ:"ᄇᄇ",ㅃ:"ᄇᄇ","ퟦ":"ᄇᄇ",ᄬ:"ᄇᄇᄋ",ㅹ:"ᄇᄇᄋ",ᄡ:"ᄇᄉ",ㅄ:"ᄇᄉ",ᆹ:"ᄇᄉ",ᄢ:"ᄇᄉᄀ",ㅴ:"ᄇᄉᄀ",ᄣ:"ᄇᄉᄃ",ㅵ:"ᄇᄉᄃ","ퟧ":"ᄇᄉᄃ",ᄤ:"ᄇᄉᄇ",ᄥ:"ᄇᄉᄉ",ᄦ:"ᄇᄉᄌ","ꥲ":"ᄇᄉᄐ",ᄫ:"ᄇᄋ",ㅸ:"ᄇᄋ",ᇦ:"ᄇᄋ",ᄧ:"ᄇᄌ",ㅶ:"ᄇᄌ","ퟨ":"ᄇᄌ",ᄨ:"ᄇᄎ","ퟩ":"ᄇᄎ","ꥳ":"ᄇᄏ",ᄩ:"ᄇᄐ",ㅷ:"ᄇᄐ",ᄪ:"ᄇᄑ",ᇤ:"ᄇᄑ","ꥴ":"ᄇᄒ",ᇥ:"ᄇᄒ",ㅅ:"ᄉ",ᆺ:"ᄉ",ᄭ:"ᄉᄀ",ㅺ:"ᄉᄀ",ᇧ:"ᄉᄀ",ᄮ:"ᄉᄂ",ㅻ:"ᄉᄂ",ᄯ:"ᄉᄃ",ㅼ:"ᄉᄃ",ᇨ:"ᄉᄃ",ᄰ:"ᄉᄅ",ᇩ:"ᄉᄅ",ᄱ:"ᄉᄆ","ퟪ":"ᄉᄆ",ᄲ:"ᄉᄇ",ㅽ:"ᄉᄇ",ᇪ:"ᄉᄇ",ᄳ:"ᄉᄇᄀ","ퟫ":"ᄉᄇᄋ",ᄊ:"ᄉᄉ",ㅆ:"ᄉᄉ",ᆻ:"ᄉᄉ","ퟬ":"ᄉᄉᄀ","ퟭ":"ᄉᄉᄃ","ꥵ":"ᄉᄉᄇ",ᄴ:"ᄉᄉᄉ",ᄵ:"ᄉᄋ",ᄶ:"ᄉᄌ",ㅾ:"ᄉᄌ","ퟯ":"ᄉᄌ",ᄷ:"ᄉᄎ","ퟰ":"ᄉᄎ",ᄸ:"ᄉᄏ",ᄹ:"ᄉᄐ","ퟱ":"ᄉᄐ",ᄺ:"ᄉᄑ","ퟮ":"ᄉᅀ",ㅇ:"ᄋ",ᆼ:"ᄋ",ᅁ:"ᄋᄀ",ᇬ:"ᄋᄀ",ᇭ:"ᄋᄀᄀ",ᅂ:"ᄋᄃ","ꥶ":"ᄋᄅ",ᅃ:"ᄋᄆ",ᅄ:"ᄋᄇ",ᅅ:"ᄋᄉ",ᇱ:"ᄋᄉ",ㆂ:"ᄋᄉ",ᅇ:"ᄋᄋ",ㆀ:"ᄋᄋ",ᇮ:"ᄋᄋ",ᅈ:"ᄋᄌ",ᅉ:"ᄋᄎ",ᇯ:"ᄋᄏ",ᅊ:"ᄋᄐ",ᅋ:"ᄋᄑ","ꥷ":"ᄋᄒ",ᅆ:"ᄋᅀ",ᇲ:"ᄋᅀ",ㆃ:"ᄋᅀ",ㅈ:"ᄌ",ᆽ:"ᄌ","ퟷ":"ᄌᄇ","ퟸ":"ᄌᄇᄇ",ᅍ:"ᄌᄋ",ᄍ:"ᄌᄌ",ㅉ:"ᄌᄌ","ퟹ":"ᄌᄌ","ꥸ":"ᄌᄌᄒ",ㅊ:"ᄎ",ᆾ:"ᄎ",ᅒ:"ᄎᄏ",ᅓ:"ᄎᄒ",ㅋ:"ᄏ",ᆿ:"ᄏ",ㅌ:"ᄐ",ᇀ:"ᄐ","ꥹ":"ᄐᄐ",ㅍ:"ᄑ",ᇁ:"ᄑ",ᅖ:"ᄑᄇ",ᇳ:"ᄑᄇ","ퟺ":"ᄑᄉ",ᅗ:"ᄑᄋ",ㆄ:"ᄑᄋ",ᇴ:"ᄑᄋ","ퟻ":"ᄑᄐ","ꥺ":"ᄑᄒ",ㅎ:"ᄒ",ᇂ:"ᄒ",ᇵ:"ᄒᄂ",ᇶ:"ᄒᄅ",ᇷ:"ᄒᄆ",ᇸ:"ᄒᄇ","ꥻ":"ᄒᄉ",ᅘ:"ᄒᄒ",ㆅ:"ᄒᄒ",ᄽ:"ᄼᄼ",ᄿ:"ᄾᄾ",ㅿ:"ᅀ",ᇫ:"ᅀ","ퟳ":"ᅀᄇ","ퟴ":"ᅀᄇᄋ",ㆁ:"ᅌ",ᇰ:"ᅌ","ퟵ":"ᅌᄆ","ퟶ":"ᅌᄒ",ᅏ:"ᅎᅎ",ᅑ:"ᅐᅐ",ㆆ:"ᅙ",ᇹ:"ᅙ","ꥼ":"ᅙᅙ",ㅤ:"ᅠ",ㅏ:"ᅡ","ᆣ":"ᅡー",ᅶ:"ᅡᅩ",ᅷ:"ᅡᅮ",ᅢ:"ᅡ丨",ㅐ:"ᅡ丨",ㅑ:"ᅣ",ᅸ:"ᅣᅩ",ᅹ:"ᅣᅭ","ᆤ":"ᅣᅮ",ᅤ:"ᅣ丨",ㅒ:"ᅣ丨",ㅓ:"ᅥ",ᅼ:"ᅥー",ᅺ:"ᅥᅩ",ᅻ:"ᅥᅮ",ᅦ:"ᅥ丨",ㅔ:"ᅥ丨",ㅕ:"ᅧ","ᆥ":"ᅧᅣ",ᅽ:"ᅧᅩ",ᅾ:"ᅧᅮ",ᅨ:"ᅧ丨",ㅖ:"ᅧ丨",ㅗ:"ᅩ",ᅪ:"ᅩᅡ",ㅘ:"ᅩᅡ",ᅫ:"ᅩᅡ丨",ㅙ:"ᅩᅡ丨","ᆦ":"ᅩᅣ","ᆧ":"ᅩᅣ丨",ᅿ:"ᅩᅥ",ᆀ:"ᅩᅥ丨","ힰ":"ᅩᅧ",ᆁ:"ᅩᅧ丨",ᆂ:"ᅩᅩ","ힱ":"ᅩᅩ丨",ᆃ:"ᅩᅮ",ᅬ:"ᅩ丨",ㅚ:"ᅩ丨",ㅛ:"ᅭ","ힲ":"ᅭᅡ","ힳ":"ᅭᅡ丨",ᆄ:"ᅭᅣ",ㆇ:"ᅭᅣ",ᆆ:"ᅭᅣ",ᆅ:"ᅭᅣ丨",ㆈ:"ᅭᅣ丨","ힴ":"ᅭᅥ",ᆇ:"ᅭᅩ",ᆈ:"ᅭ丨",ㆉ:"ᅭ丨",ㅜ:"ᅮ",ᆉ:"ᅮᅡ",ᆊ:"ᅮᅡ丨",ᅯ:"ᅮᅥ",ㅝ:"ᅮᅥ",ᆋ:"ᅮᅥー",ᅰ:"ᅮᅥ丨",ㅞ:"ᅮᅥ丨","ힵ":"ᅮᅧ",ᆌ:"ᅮᅧ丨",ᆍ:"ᅮᅮ",ᅱ:"ᅮ丨",ㅟ:"ᅮ丨","ힶ":"ᅮ丨丨",ㅠ:"ᅲ",ᆎ:"ᅲᅡ","ힷ":"ᅲᅡ丨",ᆏ:"ᅲᅥ",ᆐ:"ᅲᅥ丨",ᆑ:"ᅲᅧ",ㆊ:"ᅲᅧ",ᆒ:"ᅲᅧ丨",ㆋ:"ᅲᅧ丨","ힸ":"ᅲᅩ",ᆓ:"ᅲᅮ",ᆔ:"ᅲ丨",ㆌ:"ᅲ丨",ㆍ:"ᆞ","ퟅ":"ᆞᅡ",ᆟ:"ᆞᅥ","ퟆ":"ᆞᅥ丨",ᆠ:"ᆞᅮ",ᆢ:"ᆞᆞ",ᆡ:"ᆞ丨",ㆎ:"ᆞ丨",ヘ:"へ","⍁":"〼","⧄":"〼","꒞":"ꁊ","꒬":"ꁐ","꒜":"ꃀ","꒨":"ꄲ","꒿":"ꉙ","꒾":"ꊱ","꒔":"ꋍ","꓀":"ꎫ","꓂":"ꎵ","꒺":"ꎿ","꒰":"ꏂ","꒧":"ꑘ","⊥":"ꓕ","⟂":"ꓕ","𝈜":"ꓕ","Ʇ":"ꓕ","Ꞟ":"ꓤ","⅁":"ꓨ","⅂":"ꓶ","𝈕":"ꓶ","𝈫":"ꓶ","𖼦":"ꓶ","𐐑":"ꓶ","⅃":"𖼀","𑫦":"𑫥𑫯","𑫨":"𑫥𑫥","𑫩":"𑫥𑫥𑫯","𑫪":"𑫥𑫥𑫰","𑫧":"𑫥𑫰","𑫴":"𑫳𑫯","𑫶":"𑫳𑫳","𑫷":"𑫳𑫳𑫯","𑫸":"𑫳𑫳𑫰","𑫵":"𑫳𑫰","𑫬":"𑫫𑫯","𑫭":"𑫫𑫫","𑫮":"𑫫𑫫𑫯","⊕":"𐊨","⨁":"𐊨","🜨":"𐊨","Ꚛ":"𐊨","▽":"𐊼","𝈔":"𐊼","🜄":"𐊼","⧖":"𐋀","ꞛ":"𐐺","Ꞛ":"𐐒","𐒠":"𐒆","𐏑":"𐎂","𐏓":"𐎓","𒀸":"𐎚","☥":"𐦞","𓋹":"𐦞","〹":"卄",不:"不","丽":"丽","並":"並","⎜":"丨","⎟":"丨","⎢":"丨","⎥":"丨","⎪":"丨","⎮":"丨","㇑":"丨",ᅵ:"丨",ㅣ:"丨","⼁":"丨",ᆜ:"丨ー",ᆘ:"丨ᅡ",ᆙ:"丨ᅣ","ힽ":"丨ᅣᅩ","ힾ":"丨ᅣ丨","ힿ":"丨ᅧ","ퟀ":"丨ᅧ丨",ᆚ:"丨ᅩ","ퟁ":"丨ᅩ丨","ퟂ":"丨ᅭ",ᆛ:"丨ᅮ","ퟃ":"丨ᅲ",ᆝ:"丨ᆞ","ퟄ":"丨丨",串:"串","丸":"丸",丹:"丹","乁":"乁","㇠":"乙","⼄":"乙","㇟":"乚","⺃":"乚","㇖":"乛","⺂":"乛","⻲":"亀",亂:"亂","㇚":"亅","⼅":"亅",了:"了",ニ:"二","⼆":"二","𠄢":"𠄢","⼇":"亠",亮:"亮","⼈":"人",イ:"亻","⺅":"亻",什:"什","仌":"仌",令:"令","你":"你",倂:"併","倂":"併","侀":"侀",來:"來",例:"例","侮":"侮","侮":"侮","侻":"侻",便:"便",值:"値",倫:"倫","偺":"偺","備":"備","像":"像",僚:"僚","僧":"僧","僧":"僧","㒞":"㒞","⼉":"儿",兀:"兀","⺎":"兀","充":"充","免":"免","免":"免","兔":"兔","兤":"兤","⼊":"入","內":"內","全":"全",兩:"兩",ハ:"八","⼋":"八",六:"六","具":"具","𠔜":"𠔜","𠔥":"𠔥","冀":"冀","㒹":"㒹","⼌":"冂","再":"再","𠕋":"𠕋","冒":"冒","冕":"冕","㒻":"㒻","最":"最","⼍":"冖","冗":"冗","冤":"冤","⼎":"冫","冬":"冬","况":"况","况":"况",冷:"冷",凉:"凉",凌:"凌",凜:"凜",凞:"凞","⼏":"几","𠘺":"𠘺","凵":"凵","⼐":"凵","⼑":"刀","⺉":"刂","刃":"刃",切:"切","切":"切",列:"列",利:"利","㓟":"㓟",刺:"刺","刻":"刻","剆":"剆","割":"割","剷":"剷",劉:"劉","𠠄":"𠠄",カ:"力",力:"力","⼒":"力",劣:"劣","㔕":"㔕","劳":"劳","勇":"勇","勇":"勇","勉":"勉","勉":"勉",勒:"勒",勞:"勞","勤":"勤","勤":"勤",勵:"勵","⼓":"勹","勺":"勺","勺":"勺","包":"包","匆":"匆","𠣞":"𠣞","⼔":"匕",北:"北","北":"北","⼕":"匚","⼖":"匸",匿:"匿","⼗":"十","〸":"十","〺":"卅","卉":"卉","࿖":"卍","࿕":"卐","卑":"卑","卑":"卑","博":"博",ト:"卜","⼘":"卜","⼙":"卩","⺋":"㔾","即":"即",卵:"卵","卽":"卽","卿":"卿","卿":"卿","卿":"卿","⼚":"厂","𠨬":"𠨬","⼛":"厶",參:"參","⼜":"又","及":"及","叟":"叟","𠭣":"𠭣",ロ:"口","⼝":"口",囗:"口","⼞":"口",句:"句","叫":"叫","叱":"叱","吆":"吆",吏:"吏",吝:"吝","吸":"吸",呂:"呂","呈":"呈","周":"周","咞":"咞","咢":"咢",咽:"咽",䎛:"㖈","哶":"哶","唐":"唐","啓":"啓",啟:"啓","啕":"啕","啣":"啣","善":"善","善":"善",喇:"喇","喙":"喙","喙":"喙","喝":"喝","喝":"喝","喫":"喫","喳":"喳",嗀:"嗀","嗂":"嗂","嗢":"嗢","嘆":"嘆","嘆":"嘆","噑":"噑","噴":"噴","器":"器",囹:"囹","圖":"圖","圗":"圗","⼟":"土",士:"土","⼠":"土","型":"型","城":"城",㦳:"㘽","埴":"埴","堍":"堍","報":"報","堲":"堲","塀":"塀",塚:"塚","塚":"塚",塞:"塞",填:"塡",壿:"墫","墬":"墬","墳":"墳",壘:"壘",壟:"壟","𡓤":"𡓤","壮":"壮","売":"売","壷":"壷","⼡":"夂","夆":"夆","⼢":"夊",タ:"夕","⼣":"夕","多":"多","夢":"夢","⼤":"大","奄":"奄",奈:"奈",契:"契","奔":"奔","奢":"奢",女:"女","⼥":"女","𡚨":"𡚨","𡛪":"𡛪","姘":"姘","姬":"姬","娛":"娛","娧":"娧","婢":"婢","婦":"婦",嬀:"媯","㛮":"㛮","㛼":"㛼","媵":"媵","嬈":"嬈","嬨":"嬨","嬾":"嬾","嬾":"嬾","⼦":"子","⼧":"宀",宅:"宅","𡧈":"𡧈","寃":"寃","寘":"寘",寧:"寧",寧:"寧","寧":"寧",寮:"寮","寳":"寳","𡬘":"𡬘","⼨":"寸","寿":"寿","将":"将","⼩":"小","尢":"尢","⺐":"尢","⼪":"尢","⺏":"尣","㞁":"㞁","⼫":"尸",尿:"尿","屠":"屠",屢:"屢","層":"層",履:"履","屮":"屮","屮":"屮","⼬":"屮","𡴋":"𡴋","⼭":"山","峀":"峀","岍":"岍","𡷤":"𡷤","𡷦":"𡷦",崙:"崙","嵃":"嵃",嵐:"嵐","嵫":"嵫","嵮":"嵮","嵼":"嵼","嶲":"嶲",嶺:"嶺","⼮":"巛","巢":"巢",エ:"工","⼯":"工","⼰":"己","⺒":"巳","㠯":"㠯","巽":"巽","⼱":"巾",帲:"帡","帨":"帨","帽":"帽","幩":"幩","㡢":"㡢","𢆃":"𢆃","⼲":"干",年:"年","𢆟":"𢆟","⺓":"幺","⼳":"幺","⼴":"广",度:"度","㡼":"㡼","庰":"庰","庳":"庳","庶":"庶",廊:"廊","廊":"廊",廉:"廉","廒":"廒",廓:"廓","廙":"廙",廬:"廬","⼵":"廴","廾":"廾","⼶":"廾","𢌱":"𢌱","𢌱":"𢌱",弄:"弄","⼷":"弋","⼸":"弓","弢":"弢","弢":"弢","⼹":"彐","⺔":"彑","当":"当","㣇":"㣇","⼺":"彡","形":"形","彩":"彩","彫":"彫","⼻":"彳",律:"律","㣣":"㣣","徚":"徚",復:"復","徭":"徭","⼼":"心","⺖":"忄","⺗":"㣺","忍":"忍","志":"志",念:"念","忹":"忹",怒:"怒",怜:"怜","恵":"恵","㤜":"㤜","㤺":"㤺","悁":"悁","悔":"悔","悔":"悔","惇":"惇","惘":"惘",惡:"惡","𢛔":"𢛔","愈":"愈","慨":"慨",慄:"慄","慈":"慈","慌":"慌","慌":"慌","慎":"慎","慎":"慎","慠":"慠","慺":"慺","憎":"憎","憎":"憎","憎":"憎",憐:"憐","憤":"憤","憯":"憯","憲":"憲","𢡄":"𢡄","𢡊":"𢡊","懞":"懞","懲":"懲","懲":"懲","懲":"懲",懶:"懶","懶":"懶",戀:"戀","⼽":"戈","成":"成","戛":"戛",戮:"戮","戴":"戴","⼾":"戶",戸:"戶","⼿":"手","⺘":"扌","扝":"扝","抱":"抱",拉:"拉",拏:"拏",拓:"拓","拔":"拔","拼":"拼",拾:"拾","𢬌":"𢬌","挽":"挽","捐":"捐","捨":"捨",捻:"捻","掃":"掃",掠:"掠","掩":"掩","揄":"揄","揤":"揤","摒":"摒","𢯱":"𢯱","搜":"搜","搢":"搢","揅":"揅","摩":"摩","摷":"摷","摾":"摾","㨮":"㨮",搉:"㩁",撚:"撚","撝":"撝",擄:"擄","㩬":"㩬","⽀":"支","⽁":"攴","⺙":"攵","敏":"敏","敏":"敏","敖":"敖","敬":"敬",數:"數","𣀊":"𣀊","⽂":"文","⻫":"斉","⽃":"斗",料:"料","⽄":"斤","⽅":"方",旅:"旅","⽆":"无","⺛":"旡","既":"既","旣":"旣","⽇":"日",易:"易",曶:"㫚","㫤":"㫤","晉":"晉",晩:"晚",晴:"晴","晴":"晴","暑":"暑","暑":"暑",暈:"暈","㬈":"㬈","暜":"暜",暴:"暴",曆:"曆","㬙":"㬙","𣊸":"𣊸","⽈":"曰",更:"更","書":"書","⽉":"月","𣍟":"𣍟",肦:"朌",胐:"朏",胊:"朐",脁:"朓",胶:"㬵",朗:"朗","朗":"朗","朗":"朗",脧:"朘","望":"望","望":"望",幐:"㬺",䐠:"㬻","𣎓":"𣎓",膧:"朣","𣎜":"𣎜","⽊":"木",李:"李","杓":"杓","杖":"杖","杞":"杞","𣏃":"𣏃",柿:"杮",杻:"杻","枅":"枅",林:"林","㭉":"㭉","𣏕":"𣏕",柳:"柳","柺":"柺",栗:"栗","栟":"栟","桒":"桒","𣑭":"𣑭",梁:"梁","梅":"梅","梅":"梅","梎":"梎",梨:"梨","椔":"椔","楂":"楂","㮝":"㮝","㮝":"㮝",槩:"㮣",樧:"榝","榣":"榣","槪":"槪",樂:"樂",樂:"樂",樂:"樂",樓:"樓","𣚣":"𣚣","檨":"檨",櫓:"櫓","櫛":"櫛",欄:"欄","㰘":"㰘","⽋":"欠","次":"次","𣢧":"𣢧","歔":"歔","㱎":"㱎","⽌":"止","⻭":"歯","歲":"歲",歷:"歷","歹":"歹","⽍":"歹","⺞":"歺","殟":"殟",殮:"殮","⽎":"殳",殺:"殺","殺":"殺","殺":"殺","殻":"殻","𣪍":"𣪍","⽏":"毋","⺟":"母","𣫺":"𣫺","⽐":"比","⽑":"毛","⽒":"氏","⺠":"民","⽓":"气","⽔":"水","⺡":"氵","⺢":"氺","汎":"汎","汧":"汧",沈:"沈","沿":"沿",泌:"泌","泍":"泍",泥:"泥","𣲼":"𣲼",洛:"洛",洞:"洞","洴":"洴","派":"派",流:"流","流":"流","流":"流","洖":"洖","浩":"浩",浪:"浪","海":"海","海":"海","浸":"浸","涅":"涅","𣴞":"𣴞",淋:"淋",淚:"淚",淪:"淪","淹":"淹","渚":"渚","港":"港","湮":"湮",潙:"溈","滋":"滋","滋":"滋",溜:"溜",溺:"溺","滇":"滇",滑:"滑","滛":"滛","㴳":"㴳",漏:"漏","漢":"漢","漢":"漢",漣:"漣","𣻑":"𣻑","潮":"潮","𣽞":"𣽞","𣾎":"𣾎","濆":"濆",濫:"濫",濾:"濾","瀛":"瀛","瀞":"瀞","瀞":"瀞","瀹":"瀹","灊":"灊","㶖":"㶖","⽕":"火","⺣":"灬","灰":"灰","灷":"灷","災":"災",炙:"炙","炭":"炭",烈:"烈",烙:"烙","煮":"煮","煮":"煮","𤉣":"𤉣","煅":"煅",煉:"煉","𤋮":"𤋮","熜":"熜",燎:"燎",燐:"燐","𤎫":"𤎫",爐:"爐",爛:"爛","爨":"爨","⽖":"爪","爫":"爫","⺤":"爫","爵":"爵","爵":"爵","⽗":"父","⽘":"爻","⺦":"丬","⽙":"爿","⽚":"片","牐":"牐","⽛":"牙","𤘈":"𤘈","⽜":"牛",牢:"牢","犀":"犀","犕":"犕","⽝":"犬","⺨":"犭","犯":"犯",狀:"狀","𤜵":"𤜵",狼:"狼",猪:"猪","猪":"猪","𤠔":"𤠔",獵:"獵","獺":"獺","⽞":"玄",率:"率",率:"率","⽟":"玉","王":"王","㺬":"㺬","玥":"玥",玲:"玲","㺸":"㺸","㺸":"㺸",珞:"珞",琉:"琉",理:"理","琢":"琢","瑇":"瑇","瑜":"瑜",瑩:"瑩","瑱":"瑱","瑱":"瑱","璅":"璅",璉:"璉",璘:"璘","瓊":"瓊","⽠":"瓜","⽡":"瓦","㼛":"㼛","甆":"甆","⽢":"甘","⽣":"生","甤":"甤","⽤":"用","⽥":"田","画":"画","甾":"甾","𤰶":"𤰶",留:"留",略:"略",異:"異","異":"異","𤲒":"𤲒","⽦":"疋","⽧":"疒",痢:"痢","瘐":"瘐","瘟":"瘟","瘝":"瘝",療:"療",癩:"癩","⽨":"癶","⽩":"白","𤾡":"𤾡","𤾸":"𤾸","⽪":"皮","⽫":"皿","𥁄":"𥁄","㿼":"㿼",益:"益","益":"益","盛":"盛",盧:"盧","䀈":"䀈","⽬":"目","直":"直","直":"直","𥃲":"𥃲","𥃳":"𥃳",省:"省","䀘":"䀘","𥄙":"𥄙","眞":"眞","真":"真","真":"真","𥄳":"𥄳","着":"着","睊":"睊","睊":"睊","鿃":"䀹","䀹":"䀹","䀹":"䀹",晣:"䀿","䁆":"䁆","瞋":"瞋","𥉉":"𥉉","瞧":"瞧","⽭":"矛","⽮":"矢","⽯":"石","䂖":"䂖","𥐝":"𥐝",硏:"研","硎":"硎",硫:"硫",碌:"碌","碌":"碌","碑":"碑",磊:"磊","磌":"磌","磌":"磌",磻:"磻","䃣":"䃣",礪:"礪","⽰":"示","⺭":"礻",礼:"礼","社":"社","祈":"祈","祉":"祉","𥘦":"𥘦","祐":"祐","祖":"祖","祖":"祖","祝":"祝",神:"神",祥:"祥","視":"視","視":"視",祿:"祿","𥚚":"𥚚","禍":"禍","禎":"禎",福:"福","福":"福","𥛅":"𥛅",禮:"禮","⽱":"禸","⽲":"禾",秊:"秊","䄯":"䄯","秫":"秫",稜:"稜","穊":"穊","穀":"穀","穀":"穀","穏":"穏","⽳":"穴","突":"突","𥥼":"𥥼","窱":"窱",立:"立","⽴":"立","⻯":"竜","𥪧":"𥪧","𥪧":"𥪧","竮":"竮","⽵":"竹",笠:"笠","節":"節","節":"節","䈂":"䈂","𥮫":"𥮫","篆":"篆","䈧":"䈧","築":"築","𥲀":"𥲀","𥳐":"𥳐",簾:"簾",籠:"籠","⽶":"米","类":"类",粒:"粒",精:"精","糒":"糒",糖:"糖","糨":"糨","䊠":"䊠","糣":"糣",糧:"糧","⽷":"糸","⺯":"糹","𥾆":"𥾆","紀":"紀",紐:"紐",索:"索",累:"累",絶:"絕","絣":"絣","絛":"絛",綠:"綠",綾:"綾","緇":"緇",練:"練","練":"練","練":"練","縂":"縂","䌁":"䌁","縉":"縉",縷:"縷","繁":"繁","繅":"繅","𦇚":"𦇚","䌴":"䌴","⽸":"缶","𦈨":"𦈨","缾":"缾","𦉇":"𦉇","⽹":"网","⺫":"罒","⺲":"罒","⺱":"罓","䍙":"䍙","署":"署","𦋙":"𦋙",罹:"罹","罺":"罺",羅:"羅","𦌾":"𦌾","⽺":"羊","羕":"羕",羚:"羚",羽:"羽","⽻":"羽","翺":"翺",老:"老","⽼":"老","⺹":"耂","者":"者","者":"者","者":"者","⽽":"而","𦓚":"𦓚","⽾":"耒","𦔣":"𦔣","⽿":"耳",聆:"聆","聠":"聠","𦖨":"𦖨",聯:"聯","聰":"聰",聾:"聾","⾀":"聿","⺺":"肀","⾁":"肉",肋:"肋","肭":"肭","育":"育","䏕":"䏕","䏙":"䏙",腁:"胼","脃":"脃","脾":"脾","䐋":"䐋","朡":"朡","𦞧":"𦞧","𦞵":"𦞵",朦:"䑃",臘:"臘","⾂":"臣",臨:"臨","⾃":"自","臭":"臭","⾄":"至","⾅":"臼","舁":"舁","舁":"舁","舄":"舄","⾆":"舌","舘":"舘","⾇":"舛","⾈":"舟","䑫":"䑫","⾉":"艮",良:"良","⾊":"色","⾋":"艸","艹":"艹","艹":"艹","⺾":"艹","⺿":"艹","⻀":"艹","芋":"芋","芑":"芑","芝":"芝","花":"花","芳":"芳","芽":"芽",若:"若","若":"若","苦":"苦","𦬼":"𦬼",茶:"茶","荒":"荒","荣":"荣","茝":"茝","茣":"茣","莽":"莽","荓":"荓",菉:"菉","菊":"菊","菌":"菌","菜":"菜","菧":"菧","華":"華",菱:"菱","著":"著","著":"著","𦰶":"𦰶","莭":"莭",落:"落",葉:"葉",蔿:"蒍","𦳕":"𦳕","𦵫":"𦵫",蓮:"蓮","蓱":"蓱","蓳":"蓳",蓼:"蓼","蔖":"蔖","䔫":"䔫","蕤":"蕤","𦼬":"𦼬",藍:"藍","䕝":"䕝","𦾱":"𦾱","䕡":"䕡",藺:"藺",蘆:"蘆","䕫":"䕫",蘒:"蘒",蘭:"蘭","𧃒":"𧃒",虁:"蘷",蘿:"蘿","⾌":"虍","⻁":"虎","虐":"虐",虜:"虜","虜":"虜","虧":"虧","虩":"虩","⾍":"虫","蚩":"蚩","蚈":"蚈","蛢":"蛢","蜎":"蜎","蜨":"蜨","蝫":"蝫","蟡":"蟡","蝹":"蝹","蝹":"蝹","螆":"螆","䗗":"䗗","𧏊":"𧏊",螺:"螺","蠁":"蠁","䗹":"䗹",蠟:"蠟","⾎":"血",行:"行","⾏":"行","衠":"衠","衣":"衣","⾐":"衣","⻂":"衤",裂:"裂","𧙧":"𧙧",裏:"裏","裗":"裗","裞":"裞",裡:"裡",裸:"裸","裺":"裺","䘵":"䘵","褐":"褐","襁":"襁",襤:"襤","⾑":"襾","⻄":"西","⻃":"覀","覆":"覆",見:"見","⾒":"見","𧢮":"𧢮","⻅":"见","⾓":"角","⾔":"言","𧥦":"𧥦",詽:"訮",訞:"䚶","䚾":"䚾","䛇":"䛇","誠":"誠",說:"說",說:"說","調":"調","請":"請",諒:"諒",論:"論","諭":"諭","諭":"諭",諸:"諸","諸":"諸",諾:"諾","諾":"諾","謁":"謁","謁":"謁","謹":"謹","謹":"謹",識:"識",讀:"讀",讏:"讆","變":"變","變":"變","⻈":"讠","⾕":"谷","⾖":"豆",豈:"豈","豕":"豕","⾗":"豕",豣:"豜","⾘":"豸","𧲨":"𧲨","⾙":"貝","貫":"貫","賁":"賁",賂:"賂",賈:"賈","賓":"賓","贈":"贈","贈":"贈","贛":"贛","⻉":"贝","⾚":"赤","⾛":"走","起":"起",趆:"赿","𧻓":"𧻓","𧼯":"𧼯","⾜":"足","跋":"跋","趼":"趼",跺:"跥",路:"路","跰":"跰",躛:"躗","⾝":"身",車:"車","⾞":"車","軔":"軔",輧:"軿",輦:"輦",輪:"輪","輸":"輸","輸":"輸",輻:"輻",轢:"轢","⻋":"车","⾟":"辛","辞":"辞",辰:"辰","⾠":"辰","⾡":"辵","辶":"辶","⻌":"辶","⻍":"辶","巡":"巡",連:"連",逸:"逸","逸":"逸","遲":"遲",遼:"遼","𨗒":"𨗒","𨗭":"𨗭",邏:"邏","⾢":"邑","邔":"邔",郎:"郎",郞:"郎","郞":"郎","郱":"郱",都:"都","𨜮":"𨜮","鄑":"鄑","鄛":"鄛","⾣":"酉",酪:"酪","醙":"醙",醴:"醴","⾤":"釆",里:"里","⾥":"里",量:"量",金:"金","⾦":"金",鈴:"鈴","鈸":"鈸","鉶":"鉶","鋗":"鋗","鋘":"鋘","鉼":"鉼",錄:"錄",鍊:"鍊",鎮:"鎭","鏹":"鏹","鐕":"鐕","𨯺":"𨯺","⻐":"钅","⻑":"長","⾧":"長","⻒":"镸","⻓":"长","⾨":"門","開":"開","䦕":"䦕",閭:"閭","閷":"閷","𨵷":"𨵷","⻔":"门","⾩":"阜","⻏":"阝","⻖":"阝",阮:"阮",陋:"陋",降:"降",陵:"陵",陸:"陸","陼":"陼",隆:"隆",隣:"隣","䧦":"䧦","⾪":"隶","隷":"隷",隸:"隷",隸:"隷","⾫":"隹","雃":"雃",離:"離","難":"難","難":"難","⾬":"雨",零:"零",雷:"雷","霣":"霣","𩅅":"𩅅",露:"露",靈:"靈","⾭":"靑","⻘":"青",靖:"靖","靖":"靖","𩇟":"𩇟","⾮":"非","⾯":"面","𩈚":"𩈚","⾰":"革","䩮":"䩮","䩶":"䩶","⾱":"韋","韛":"韛","韠":"韠","⻙":"韦","⾲":"韭","𩐊":"𩐊","⾳":"音","響":"響","響":"響","⾴":"頁","䪲":"䪲","頋":"頋","頋":"頋","頋":"頋",領:"領","頩":"頩","𩒖":"𩒖","頻":"頻","頻":"頻",類:"類","⻚":"页","⾵":"風","𩖶":"𩖶","⻛":"风","⾶":"飛","⻜":"飞","⻝":"食","⾷":"食","⻟":"飠","飢":"飢",飯:"飯",飼:"飼","䬳":"䬳",館:"館","餩":"餩","⻠":"饣","⾸":"首","⾹":"香","馧":"馧","⾺":"馬","駂":"駂",駱:"駱","駾":"駾",驪:"驪","⻢":"马","⾻":"骨","䯎":"䯎","⾼":"高","⾽":"髟","𩬰":"𩬰","鬒":"鬒","鬒":"鬒","⾾":"鬥","⾿":"鬯","⿀":"鬲","⿁":"鬼","⻤":"鬼","⿂":"魚",魯:"魯","鱀":"鱀",鱗:"鱗","⻥":"鱼","⿃":"鳥","鳽":"鳽","䳎":"䳎","鵧":"鵧","䳭":"䳭","𪃎":"𪃎",鶴:"鶴","𪄅":"𪄅","䳸":"䳸",鷺:"鷺","𪈎":"𪈎",鸞:"鸞",鹃:"鹂","⿄":"鹵",鹿:"鹿","⿅":"鹿","𪊑":"𪊑",麗:"麗",麟:"麟","⿆":"麥","⻨":"麦","麻":"麻","⿇":"麻","𪎒":"𪎒","⿈":"黃","⻩":"黄","⿉":"黍",黎:"黎","䵖":"䵖","⿊":"黑",黒:"黑","墨":"墨","黹":"黹","⿋":"黹","⿌":"黽","鼅":"鼅","黾":"黾","⿍":"鼎","鼏":"鼏","⿎":"鼓","鼖":"鼖","⿏":"鼠","鼻":"鼻","⿐":"鼻","齃":"齃","⿑":"齊","⻬":"齐","⿒":"齒","𪘀":"𪘀","⻮":"齿",龍:"龍","⿓":"龍","龎":"龎","⻰":"龙",龜:"龜",龜:"龜","龜":"龜","⿔":"龜","⻳":"龟","⿕":"龠"};var mp,XT;function vD(){if(XT)return mp;XT=1;var i=fD;function e(a){return a.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}var t=RegExp(Object.keys(i).map(e).join("|"),"g");function n(a){return i[a]}function r(a){return a.replace(t,n)}return mp=r,mp}var mD=vD();const pD=Cf(mD),gD=Object.prototype.toString,yD=i=>gD.call(i)==="[object Error]",bD=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function SD(i){if(!(i&&yD(i)&&i.name==="TypeError"&&typeof i.message=="string"))return!1;const{message:t,stack:n}=i;return t==="Load failed"?n===void 0||"__sentry_captured__"in i:t.startsWith("error sending request for url")?!0:bD.has(t)}function ED(i){if(typeof i=="number"){if(i<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(i))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(i!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function Zd(i,e,{min:t=0,allowInfinity:n=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${i}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(e))throw new TypeError(`Expected \`${i}\` to be a finite number.`);if(e<t)throw new TypeError(`Expected \`${i}\` to be ≥ ${t}.`)}}class _k extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const TD=(i,e,t)=>{const n=t.retries-(e-1);return Object.freeze({error:i,attemptNumber:e,retriesLeft:n})};function _D(i,e){const t=e.randomize?Math.random()+1:1;let n=Math.round(t*Math.max(e.minTimeout,1)*e.factor**(i-1));return n=Math.min(n,e.maxTimeout),n}async function CD(i,e,t,n,r){let a=i;if(a instanceof Error||(a=new TypeError(`Non-error was thrown: "${a}". You should only throw errors.`)),a instanceof _k)throw a.originalError;if(a instanceof TypeError&&!SD(a))throw a;const o=TD(a,e,t);await t.onFailedAttempt(o);const c=Date.now();if(c-n>=r||e>=t.retries+1||!await t.shouldRetry(o))throw a;const d=_D(e,t),h=r-(c-n);if(h<=0)throw a;const v=Math.min(d,h);v>0&&await new Promise((m,y)=>{const E=()=>{clearTimeout(T),t.signal?.removeEventListener("abort",E),y(t.signal.reason)},T=setTimeout(()=>{t.signal?.removeEventListener("abort",E),m()},v);t.unref&&T.unref?.(),t.signal?.addEventListener("abort",E,{once:!0})}),t.signal?.throwIfAborted()}async function RD(i,e={}){if(e={...e},ED(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??=10,e.factor??=2,e.minTimeout??=1e3,e.maxTimeout??=Number.POSITIVE_INFINITY,e.randomize??=!1,e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,Zd("factor",e.factor,{min:0,allowInfinity:!1}),Zd("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),Zd("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0});const t=e.maxRetryTime??Number.POSITIVE_INFINITY;Zd("maxRetryTime",t,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),e.signal?.throwIfAborted();let n=0;const r=Date.now(),a=t;for(;n<e.retries+1;){n++;try{e.signal?.throwIfAborted();const o=await i(n);return e.signal?.throwIfAborted(),o}catch(o){await CD(o,n,e,r,a)}}throw new Error("Retry attempts exhausted without throwing an error.")}let Sl=class{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){var e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){var t=void 0;return this.name&&(t=e?.[this.name]),!t&&this.altName&&(t=e?.[this.altName]),t}includedIn(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}};class Rf extends Sl{constructor(){super(...arguments),b(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}class Ht extends Sl{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}var ll=(function(i){return i.Self="m.self",i.Pin="m.pin",i})({}),Cu=new Ht("m.asset","org.matrix.msc3488.asset"),Ja=new Ht("m.ts","org.matrix.msc3488.ts"),Ru=new Ht("m.location","org.matrix.msc3488.location"),On=(function(i){return i.Read="m.read",i.FullyRead="m.fully_read",i.ReadPrivate="m.read.private",i})({}),ku="main";function QT(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function ZT(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?QT(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):QT(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}var pp=new Map;function gp(i){return i instanceof String&&(i=i.toString()),pp.has(i)||pp.set(i,i),pp.get(i)}function vg(i,e){var t=e??new URLSearchParams,n=function(c){a!=null&&(Array.isArray(a)?a.forEach(d=>{t.append(c,String(d))}):t.append(c,String(a)))};for(var[r,a]of Object.entries(i))n(r);return t}function e_(i,e,t){var n=ZT(ZT({},t),{},{[e]:t[i]});return delete n[i],n}function he(i,e){for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];n!=null&&(i=i.replace(t,encodeURIComponent(n)))}return i}function Kh(i,e,t){var n;if(t){for(n=i.length-1;n>=0;n--)if(e(i[n],n,i))return i.splice(n,1),!0}else for(n=0;n<i.length;n++)if(e(i[n],n,i))return i.splice(n,1),!0;return!1}function Ck(i,e){for(var t of e)if(!i.hasOwnProperty(t))throw new Error("Missing required key: "+t)}function wu(i){return JSON.parse(JSON.stringify(i))}function cl(i,e){if(i===e)return!0;if(typeof i!=typeof e)return!1;if(typeof i=="number"&&isNaN(i)&&isNaN(e))return!0;if(i===null||e===null)return i===e;if(i.constructor.name!=="Object"&&i.constructor.name!=="RegExp"&&i.constructor.name!=="Date"&&i.constructor.name!=="Array"||i.prototype!==e.prototype)return!1;if(i instanceof RegExp||i instanceof Date)return i.toString()===e.toString();if(Array.isArray(i)){if(i.length!==e.length)return!1;for(var t=0;t<i.length;t++)if(!cl(i[t],e[t]))return!1}else{for(var n in e)if(e.hasOwnProperty(n)!==i.hasOwnProperty(n))return!1;for(var r in i)if(e.hasOwnProperty(r)!==i.hasOwnProperty(r)||!cl(i[r],e[r]))return!1}return!0}function mg(i){if(typeof i!="object"||i==null||Array.isArray(i))return i;var e=[];for(var[t,n]of Object.entries(i))e.push([t,mg(n)]);return e.sort((r,a)=>yh(r[0],a[0])),e}function t_(i){return typeof i=="number"&&isFinite(i)}function Ns(i){return typeof i=="string"?pD(i.normalize("NFD").replace(wD,"")):""}function pg(i){return typeof i=="string"?i.replace(/[\u202d-\u202e]/g,""):""}function kD(i){return Ns(i.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}var wD=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function Rk(i){return i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function kk(i){return Rk(i).replace(/\\\*/g,".*").replace(/\?/g,".")}function yp(i){return i!=null&&i.endsWith("/")?i.slice(0,-1):i}function Iu(i,e){return new Promise(t=>{setTimeout(t,i,e)})}function Rq(i,e,t){return gg.apply(this,arguments)}function gg(){return gg=A(function*(i,e,t){var n=Date.now();try{return yield t()}finally{var r=Date.now();i.debug("[Perf]: ".concat(e," took ").concat(r-n,"ms"))}}),gg.apply(this,arguments)}function ID(i,e,t){var n=Date.now();try{return t()}finally{var r=Date.now();i.debug("[Perf]: ".concat(e," took ").concat(r-n,"ms"))}}function wk(i){return i==null}function n_(i,e){return yg.apply(this,arguments)}function yg(){return yg=A(function*(i,e){for(var t of i)yield e(yield t)}),yg.apply(this,arguments)}function Ao(i){return Promise.resolve(i())}function OD(i,e){return RD(t=>i(t),{retries:1/0,shouldRetry:e?t=>{var{error:n}=t;return e(n)}:void 0,factor:2,minTimeout:3e3,maxTimeout:15e3})}var Ga=(()=>{for(var i="",e=32;e<=126;e++)i+=String.fromCharCode(e);return i})();function i_(i,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ga;return i.padEnd(e,t[0])}function iu(i){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ga,t=BigInt(e.length);if(i<=t){var n;return(n=e[Number(i)-1])!==null&&n!==void 0?n:""}var r=i/t,a=Number(i%t)-1;return a<0&&(r-=BigInt(Math.abs(a)),a=Number(t)-1),iu(r,e)+e[a]}function Hh(i){for(var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ga,t=BigInt(e.length),n=BigInt(0),r=i.length-1,a=BigInt(0);r>=0;r--,a++){var o=i.charCodeAt(r)-e.charCodeAt(0);n+=BigInt(1+o)*t**a}return n}function MD(i,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ga,n=Math.max(i.length,e.length),r=Hh(i_(i,n,t),t),a=Hh(i_(e,n,t),t),o=(r+a)/BigInt(2);return o===r||o==a?iu(o,t)+t[0]:iu(o,t)}function yc(i){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ga;return iu(Hh(i,e)+BigInt(1),e)}function r_(i){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ga;return iu(Hh(i,e)-BigInt(1),e)}function yh(i,e){return i<e?-1:i>e?1:0}function Ik(i,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;for(var[n,r]of Object.entries(e)){if(i[n]instanceof Object&&r){Ik(i[n],r);continue}if(r!=null||!t){Gh(i,n,r);continue}}return i}function a_(i){var e;return(e=Ja.findIn(i.getContent()))!==null&&e!==void 0?e:-1}function PD(i,e){return a_(e)-a_(i)}function By(i){return[On.Read,On.ReadPrivate].includes(i)}function s_(i,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:(o,c)=>o===c;if(i.size!==e.size)return!1;for(var[n,r]of i){var a=e.get(n);if(a===void 0||!t(r,a))return!1}return!0}function Ok(i){return i instanceof Map?Ps(i):Array.isArray(i)?i.map(e=>Ok(e)):i}function Ps(i){var e=new Map;for(var[t,n]of i)e.set(t,Ok(n));return Object.fromEntries(e.entries())}function Gc(i){return i==="__proto__"||i==="prototype"||i==="constructor"}function Gh(i,e,t){if(Gc(e))throw new Error("Trying to modify prototype or constructor");i[e]=t}function ji(i){return!(Gc(i.room_id)||Gc(i.sender)||Gc(i.event_id))}class Yr extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}}var bg="migrationState",ul=(function(i){return i[i.NOT_STARTED=0]="NOT_STARTED",i[i.INITIAL_DATA_MIGRATED=1]="INITIAL_DATA_MIGRATED",i[i.OLM_SESSIONS_MIGRATED=2]="OLM_SESSIONS_MIGRATED",i[i.MEGOLM_SESSIONS_MIGRATED=3]="MEGOLM_SESSIONS_MIGRATED",i[i.ROOM_SETTINGS_MIGRATED=4]="ROOM_SETTINGS_MIGRATED",i[i.INITIAL_OWN_KEY_QUERY_DONE=5]="INITIAL_OWN_KEY_QUERY_DONE",i})({}),dl=50;function o_(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function l_(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?o_(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):o_(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}function eh(i,e){return encodeURIComponent(i)+"/"+encodeURIComponent(e)}function AD(i){var e=i.split("/"),t=decodeURIComponent(e[0]),n=decodeURIComponent(e[1]);return{senderKey:t,sessionId:n}}class kf{constructor(){b(this,"migrationState",ul.NOT_STARTED),b(this,"account",null),b(this,"crossSigningKeys",null),b(this,"privateKeys",{}),b(this,"sessions",{}),b(this,"inboundGroupSessions",{}),b(this,"inboundGroupSessionsWithheld",{}),b(this,"rooms",{}),b(this,"sessionsNeedingBackup",{})}containsData(){var e=this;return A(function*(){return e.account!==null})()}startup(){var e=this;return A(function*(){return e})()}deleteAllData(){return Promise.resolve()}getMigrationState(){var e=this;return A(function*(){return e.migrationState})()}setMigrationState(e){var t=this;return A(function*(){t.migrationState=e})()}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,n){var r=this.privateKeys[n];t(r||null)}storeSecretStorePrivateKey(e,t,n){this.privateKeys[t]=n}countEndToEndSessions(e,t){var n=0;for(var r of Object.values(this.sessions))n+=Object.keys(r).length;t(n)}getEndToEndSession(e,t,n,r){var a=this.sessions[e]||{};r(a[t]||null)}getEndToEndSessions(e,t,n){n(this.sessions[e]||{})}storeEndToEndSession(e,t,n,r){var a=this.sessions[e];a===void 0&&(a={},this.sessions[e]=a),Gh(a,t,n)}getEndToEndSessionsBatch(){var e=this;return A(function*(){var t=[];for(var n of Object.values(e.sessions))for(var r of Object.values(n))if(t.push(r),t.length>=dl)return t;return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return A(function*(){for(var{deviceKey:n,sessionId:r}of e){var a=t.sessions[n]||{};delete a[r],Object.keys(a).length===0&&delete t.sessions[n]}})()}getEndToEndInboundGroupSession(e,t,n,r){var a=eh(e,t);r(this.inboundGroupSessions[a]||null,this.inboundGroupSessionsWithheld[a]||null)}storeEndToEndInboundGroupSession(e,t,n,r){var a=eh(e,t);this.inboundGroupSessions[a]=n}countEndToEndInboundGroupSessions(){var e=this;return A(function*(){return Object.keys(e.inboundGroupSessions).length})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return A(function*(){var t=[];for(var[n,r]of Object.entries(e.inboundGroupSessions))if(t.push(l_(l_({},AD(n)),{},{sessionData:r,needsBackup:n in e.sessionsNeedingBackup})),t.length>=dl)return t;return t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return A(function*(){for(var{senderKey:n,sessionId:r}of e){var a=eh(n,r);delete t.inboundGroupSessions[a]}})()}getEndToEndRooms(e,t){t(this.rooms)}markSessionsNeedingBackup(e){for(var t of e){var n=eh(t.senderKey,t.sessionId);this.sessionsNeedingBackup[n]=!0}return Promise.resolve()}doTxn(e,t,n){return Promise.resolve(n(null))}}var DD=/^(?:(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|(?:\[[\dA-Fa-f:.]{2,45}])|(?:[A-Za-z\d\-.]{1,255}))(?::\d{1,5})?$/;function ND(i){var e=DD.exec(i);return e?.[0]===i}var xD=/^[\w-]+$/;function LD(i){var e=xD.exec(i);return e?.[0]===i}function wf(i,e,t,n,r){var a=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,o=arguments.length>6?arguments[6]:void 0,c=arguments.length>7?arguments[7]:void 0;if(typeof e!="string"||!e)return"";if(!e.startsWith("mxc://"))return a?e:"";var[d,h,...v]=e.slice(6).split("/");if(v.length>0||!ND(d)||!LD(h))return"";c&&(o=!0);var m,y=!!t||!!n||!!r,E=y?"thumbnail":"download";c?m="/_matrix/client/v1/media/".concat(E):m="/_matrix/media/v3/".concat(E);var T=new URL("".concat(m,"/").concat(d,"/").concat(h),i);return t&&T.searchParams.set("width",Math.round(t).toString()),n&&T.searchParams.set("height",Math.round(n).toString()),r&&T.searchParams.set("method",r),typeof o=="boolean"&&T.searchParams.set("allow_redirect",JSON.stringify(o)),T.href}var bh={exports:{}},UD=bh.exports,c_;function BD(){return c_||(c_=1,(function(i){(function(e,t){i.exports?i.exports=t():e.log=t()})(UD,function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],a={},o=null;function c(S,O){var R=S[O];if(typeof R.bind=="function")return R.bind(S);try{return Function.prototype.bind.call(R,S)}catch{return function(){return Function.prototype.apply.apply(R,[S,arguments])}}}function d(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function h(S){return S==="debug"&&(S="log"),typeof console===t?!1:S==="trace"&&n?d:console[S]!==void 0?c(console,S):console.log!==void 0?c(console,"log"):e}function v(){for(var S=this.getLevel(),O=0;O<r.length;O++){var R=r[O];this[R]=O<S?e:this.methodFactory(R,S,this.name)}if(this.log=this.debug,typeof console===t&&S<this.levels.SILENT)return"No console available for logging"}function m(S){return function(){typeof console!==t&&(v.call(this),this[S].apply(this,arguments))}}function y(S,O,R){return h(S)||m.apply(this,arguments)}function E(S,O){var R=this,I,M,C,k="loglevel";typeof S=="string"?k+=":"+S:typeof S=="symbol"&&(k=void 0);function _(K){var Z=(r[K]||"silent").toUpperCase();if(!(typeof window===t||!k)){try{window.localStorage[k]=Z;return}catch{}try{window.document.cookie=encodeURIComponent(k)+"="+Z+";"}catch{}}}function P(){var K;if(!(typeof window===t||!k)){try{K=window.localStorage[k]}catch{}if(typeof K===t)try{var Z=window.document.cookie,be=encodeURIComponent(k),Pe=Z.indexOf(be+"=");Pe!==-1&&(K=/^([^;]+)/.exec(Z.slice(Pe+be.length+1))[1])}catch{}return R.levels[K]===void 0&&(K=void 0),K}}function x(){if(!(typeof window===t||!k)){try{window.localStorage.removeItem(k)}catch{}try{window.document.cookie=encodeURIComponent(k)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function U(K){var Z=K;if(typeof Z=="string"&&R.levels[Z.toUpperCase()]!==void 0&&(Z=R.levels[Z.toUpperCase()]),typeof Z=="number"&&Z>=0&&Z<=R.levels.SILENT)return Z;throw new TypeError("log.setLevel() called with invalid level: "+K)}R.name=S,R.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},R.methodFactory=O||y,R.getLevel=function(){return C??M??I},R.setLevel=function(K,Z){return C=U(K),Z!==!1&&_(C),v.call(R)},R.setDefaultLevel=function(K){M=U(K),P()||R.setLevel(K,!1)},R.resetLevel=function(){C=null,x(),v.call(R)},R.enableAll=function(K){R.setLevel(R.levels.TRACE,K)},R.disableAll=function(K){R.setLevel(R.levels.SILENT,K)},R.rebuild=function(){if(o!==R&&(I=U(o.getLevel())),v.call(R),o===R)for(var K in a)a[K].rebuild()},I=U(o?o.getLevel():"WARN");var j=P();j!=null&&(C=U(j)),v.call(R)}o=new E,o.getLogger=function(O){if(typeof O!="symbol"&&typeof O!="string"||O==="")throw new TypeError("You must supply a name when creating a logger.");var R=a[O];return R||(R=a[O]=new E(O,o.methodFactory)),R};var T=typeof window!==t?window.log:void 0;return o.noConflict=function(){return typeof window!==t&&window.log===o&&(window.log=T),o},o.getLoggers=function(){return a},o.default=o,o})})(bh)),bh.exports}var FD=BD();const Sg=Cf(FD);var jD="matrix";Sg.methodFactory=function(i,e,t){return function(){for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];this.prefix&&r.unshift(this.prefix);var o=i==="error"||i==="warn"||i==="trace"||i==="info"||i==="debug";return o?console[i](...r):console.log(...r)}};function Mk(i){var e=jD+(i===void 0?"":"-".concat(i)),t=Sg.getLogger(e);return t.getChild===void 0&&(t.prefix=i,t.getChild=n=>{var r=Mk((i??"")+n);return r.methodFactory=t.methodFactory,r.rebuild(),r},t.setLevel(Sg.levels.DEBUG,!1)),t}var D=Mk();class kq{constructor(e,t){this.parent=e,b(this,"name",void 0),this.name=t+":"}trace(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.trace(this.name,...t)}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.debug(this.name,...t)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.info(this.name,...t)}warn(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.warn(this.name,...t)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.error(this.name,...t)}}class Fy{constructor(e){this.debugInstance=e}trace(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[TRACE]",...t)}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[DEBUG]",...t)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[INFO]",...t)}warn(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[WARN]",...t)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[ERROR]",...t)}getChild(e){return new Fy(this.debugInstance.extend(e))}debugWithPrefix(e){for(var t,n=arguments.length,r=new Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];if(r.length===0)t="";else if(r[0]instanceof Error){var o=r.shift();t=o.stack||o.message}else typeof r[0]=="string"?t=r.shift():t="%O";this.debugInstance(e+" "+t,...r)}}var th={exports:{}},u_;function qD(){if(u_)return th.exports;u_=1;var i=typeof Reflect=="object"?Reflect:null,e=i&&typeof i.apply=="function"?i.apply:function(k,_,P){return Function.prototype.apply.call(k,_,P)},t;i&&typeof i.ownKeys=="function"?t=i.ownKeys:Object.getOwnPropertySymbols?t=function(k){return Object.getOwnPropertyNames(k).concat(Object.getOwnPropertySymbols(k))}:t=function(k){return Object.getOwnPropertyNames(k)};function n(C){console&&console.warn&&console.warn(C)}var r=Number.isNaN||function(k){return k!==k};function a(){a.init.call(this)}th.exports=a,th.exports.once=R,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var o=10;function c(C){if(typeof C!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof C)}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(C){if(typeof C!="number"||C<0||r(C))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+C+".");o=C}}),a.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(k){if(typeof k!="number"||k<0||r(k))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+k+".");return this._maxListeners=k,this};function d(C){return C._maxListeners===void 0?a.defaultMaxListeners:C._maxListeners}a.prototype.getMaxListeners=function(){return d(this)},a.prototype.emit=function(k){for(var _=[],P=1;P<arguments.length;P++)_.push(arguments[P]);var x=k==="error",U=this._events;if(U!==void 0)x=x&&U.error===void 0;else if(!x)return!1;if(x){var j;if(_.length>0&&(j=_[0]),j instanceof Error)throw j;var K=new Error("Unhandled error."+(j?" ("+j.message+")":""));throw K.context=j,K}var Z=U[k];if(Z===void 0)return!1;if(typeof Z=="function")e(Z,this,_);else for(var be=Z.length,Pe=T(Z,be),P=0;P<be;++P)e(Pe[P],this,_);return!0};function h(C,k,_,P){var x,U,j;if(c(_),U=C._events,U===void 0?(U=C._events=Object.create(null),C._eventsCount=0):(U.newListener!==void 0&&(C.emit("newListener",k,_.listener?_.listener:_),U=C._events),j=U[k]),j===void 0)j=U[k]=_,++C._eventsCount;else if(typeof j=="function"?j=U[k]=P?[_,j]:[j,_]:P?j.unshift(_):j.push(_),x=d(C),x>0&&j.length>x&&!j.warned){j.warned=!0;var K=new Error("Possible EventEmitter memory leak detected. "+j.length+" "+String(k)+" listeners added. Use emitter.setMaxListeners() to increase limit");K.name="MaxListenersExceededWarning",K.emitter=C,K.type=k,K.count=j.length,n(K)}return C}a.prototype.addListener=function(k,_){return h(this,k,_,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(k,_){return h(this,k,_,!0)};function v(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function m(C,k,_){var P={fired:!1,wrapFn:void 0,target:C,type:k,listener:_},x=v.bind(P);return x.listener=_,P.wrapFn=x,x}a.prototype.once=function(k,_){return c(_),this.on(k,m(this,k,_)),this},a.prototype.prependOnceListener=function(k,_){return c(_),this.prependListener(k,m(this,k,_)),this},a.prototype.removeListener=function(k,_){var P,x,U,j,K;if(c(_),x=this._events,x===void 0)return this;if(P=x[k],P===void 0)return this;if(P===_||P.listener===_)--this._eventsCount===0?this._events=Object.create(null):(delete x[k],x.removeListener&&this.emit("removeListener",k,P.listener||_));else if(typeof P!="function"){for(U=-1,j=P.length-1;j>=0;j--)if(P[j]===_||P[j].listener===_){K=P[j].listener,U=j;break}if(U<0)return this;U===0?P.shift():S(P,U),P.length===1&&(x[k]=P[0]),x.removeListener!==void 0&&this.emit("removeListener",k,K||_)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(k){var _,P,x;if(P=this._events,P===void 0)return this;if(P.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):P[k]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete P[k]),this;if(arguments.length===0){var U=Object.keys(P),j;for(x=0;x<U.length;++x)j=U[x],j!=="removeListener"&&this.removeAllListeners(j);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(_=P[k],typeof _=="function")this.removeListener(k,_);else if(_!==void 0)for(x=_.length-1;x>=0;x--)this.removeListener(k,_[x]);return this};function y(C,k,_){var P=C._events;if(P===void 0)return[];var x=P[k];return x===void 0?[]:typeof x=="function"?_?[x.listener||x]:[x]:_?O(x):T(x,x.length)}a.prototype.listeners=function(k){return y(this,k,!0)},a.prototype.rawListeners=function(k){return y(this,k,!1)},a.listenerCount=function(C,k){return typeof C.listenerCount=="function"?C.listenerCount(k):E.call(C,k)},a.prototype.listenerCount=E;function E(C){var k=this._events;if(k!==void 0){var _=k[C];if(typeof _=="function")return 1;if(_!==void 0)return _.length}return 0}a.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function T(C,k){for(var _=new Array(k),P=0;P<k;++P)_[P]=C[P];return _}function S(C,k){for(;k+1<C.length;k++)C[k]=C[k+1];C.pop()}function O(C){for(var k=new Array(C.length),_=0;_<k.length;++_)k[_]=C[_].listener||C[_];return k}function R(C,k){return new Promise(function(_,P){function x(j){C.removeListener(k,U),P(j)}function U(){typeof C.removeListener=="function"&&C.removeListener("error",x),_([].slice.call(arguments))}M(C,k,U,{once:!0}),k!=="error"&&I(C,x,{once:!0})})}function I(C,k,_){typeof C.on=="function"&&M(C,"error",k,_)}function M(C,k,_,P){if(typeof C.on=="function")P.once?C.once(k,_):C.on(k,_);else if(typeof C.addEventListener=="function")C.addEventListener(k,function x(U){P.once&&C.removeEventListener(k,x),_(U)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof C)}return th.exports}var If=qD();const wq=Cf(If);var Pk=(function(i){return i.NewListener="newListener",i.RemoveListener="removeListener",i.Error="error",i})({});class Ot extends If.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return super.emit(e,...n)}emitPromised(e){var t=arguments,n=this;return A(function*(){for(var r=t.length,a=new Array(r>1?r-1:0),o=1;o<r;o++)a[o-1]=t[o];var c=n.listeners(e);return Promise.allSettled(c.map(d=>d(...a))).then(()=>c.length>0)})()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return e===void 0?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}var G=(function(i){return i.RoomCanonicalAlias="m.room.canonical_alias",i.RoomCreate="m.room.create",i.RoomJoinRules="m.room.join_rules",i.RoomMember="m.room.member",i.RoomThirdPartyInvite="m.room.third_party_invite",i.RoomPowerLevels="m.room.power_levels",i.RoomName="m.room.name",i.RoomTopic="m.room.topic",i.RoomAvatar="m.room.avatar",i.RoomPinnedEvents="m.room.pinned_events",i.RoomEncryption="m.room.encryption",i.RoomHistoryVisibility="m.room.history_visibility",i.RoomGuestAccess="m.room.guest_access",i.RoomServerAcl="m.room.server_acl",i.RoomTombstone="m.room.tombstone",i.RoomPredecessor="org.matrix.msc3946.room_predecessor",i.PolicyRuleUser="m.policy.rule.user",i.PolicyRuleRoom="m.policy.rule.room",i.PolicyRuleServer="m.policy.rule.server",i.SpaceChild="m.space.child",i.SpaceParent="m.space.parent",i.RoomRedaction="m.room.redaction",i.RoomMessage="m.room.message",i.RoomMessageEncrypted="m.room.encrypted",i.Sticker="m.sticker",i.CallInvite="m.call.invite",i.CallCandidates="m.call.candidates",i.CallAnswer="m.call.answer",i.CallHangup="m.call.hangup",i.CallReject="m.call.reject",i.CallSelectAnswer="m.call.select_answer",i.CallNegotiate="m.call.negotiate",i.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",i.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",i.CallReplaces="m.call.replaces",i.CallAssertedIdentity="m.call.asserted_identity",i.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",i.CallEncryptionKeysPrefix="io.element.call.encryption_keys",i.KeyVerificationRequest="m.key.verification.request",i.KeyVerificationStart="m.key.verification.start",i.KeyVerificationCancel="m.key.verification.cancel",i.KeyVerificationMac="m.key.verification.mac",i.KeyVerificationDone="m.key.verification.done",i.KeyVerificationKey="m.key.verification.key",i.KeyVerificationAccept="m.key.verification.accept",i.KeyVerificationReady="m.key.verification.ready",i.RoomMessageFeedback="m.room.message.feedback",i.Reaction="m.reaction",i.PollStart="org.matrix.msc3381.poll.start",i.Typing="m.typing",i.Receipt="m.receipt",i.Presence="m.presence",i.FullyRead="m.fully_read",i.Tag="m.tag",i.SpaceOrder="org.matrix.msc3230.space_order",i.PushRules="m.push_rules",i.Direct="m.direct",i.IgnoredUserList="m.ignored_user_list",i.InvitePermissionConfig="m.invite_permission_config",i.RoomKey="m.room_key",i.RoomKeyRequest="m.room_key_request",i.ForwardedRoomKey="m.forwarded_room_key",i.Dummy="m.dummy",i.SecretRequest="m.secret.request",i.SecretSend="m.secret.send",i.GroupCallPrefix="org.matrix.msc3401.call",i.GroupCallMemberPrefix="org.matrix.msc3401.call.member",i.RTCMembership="org.matrix.msc4143.rtc.member",i.CallNotify="org.matrix.msc4075.call.notify",i.RTCNotification="org.matrix.msc4075.rtc.notification",i.RTCDecline="org.matrix.msc4310.rtc.decline",i.RoomPolicy="org.matrix.msc4284.policy",i})({}),Et=(function(i){return i.Annotation="m.annotation",i.Replace="m.replace",i.Reference="m.reference",i.Thread="m.thread",i})({}),hr=(function(i){return i.Text="m.text",i.Emote="m.emote",i.Notice="m.notice",i.Image="m.image",i.File="m.file",i.Audio="m.audio",i.Location="m.location",i.Video="m.video",i.KeyVerificationRequest="m.key.verification.request",i})({}),zh="type",Yo=(function(i){return i.Space="m.space",i.UnstableCall="org.matrix.msc3417.call",i.ElementVideo="io.element.video",i})({}),Of="org.matrix.msgid",Eg=new Ht("m.room.purpose","org.matrix.msc3088.purpose"),Tg=new Ht("m.enabled","org.matrix.msc3088.enabled"),_g=new Ht("m.data_tree","org.matrix.msc3089.data_tree"),Ak=new Ht("m.leaf","org.matrix.msc3089.leaf"),jr=new Ht("m.branch","org.matrix.msc3089.branch"),Dk=new Ht("m.room.marker","org.matrix.msc2716.marker"),Cg=new Ht("with_rel_types","org.matrix.msc3912.with_relations"),Nk=new Ht("io.element.functional_members","io.element.functional_members"),As=new Ht("m.visibility","org.matrix.msc3531.visibility"),Rg=new Ht("enabled","org.matrix.msc3881.enabled"),VD=new Ht("device_id","org.matrix.msc3881.device_id"),xk=new Ht("m.local_notification_settings","org.matrix.msc3890.local_notification_settings"),Wh=new Ht("thread_id","org.matrix.msc4023.thread_id"),Lk=new Sl("membership","io.element.msc4115.membership"),Ne=(function(i){return i.Ban="ban",i.Invite="invite",i.Join="join",i.Knock="knock",i.Leave="leave",i})({}),Hn=(function(i){return i.Membership="RoomMember.membership",i.Name="RoomMember.name",i.PowerLevel="RoomMember.powerLevel",i.Typing="RoomMember.typing",i})({});class ru extends Ot{constructor(e,t){super(),this.roomId=e,this.userId=t,b(this,"_isOutOfBand",!1),b(this,"modified",-1),b(this,"requestedProfileInfo",!1),b(this,"typing",!1),b(this,"name",void 0),b(this,"rawDisplayName",void 0),b(this,"powerLevel",0),b(this,"user",void 0),b(this,"membership",void 0),b(this,"disambiguate",!1),b(this,"events",{}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){var n,r,a=(n=e.getDirectionalContent().displayname)!==null&&n!==void 0?n:"";if(e.getType()===G.RoomMember){this._isOutOfBand=!1,this.events.member=e;var o=this.membership;this.membership=e.getDirectionalContent().membership,this.membership===void 0&&D.trace("membership event with membership undefined (forwardLooking: ".concat(e.forwardLooking,")!"),e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=HD(this.userId,a,t);var c=this.name;this.name=GD(this.userId,a,this.disambiguate),this.rawDisplayName=pg((r=e.getDirectionalContent().displayname)!==null&&r!==void 0?r:""),(!this.rawDisplayName||!Ns(this.rawDisplayName))&&(this.rawDisplayName=this.userId),o!==this.membership&&(this.updateModifiedTime(),this.emit(Hn.Membership,e,this,o)),c!==this.name&&(this.updateModifiedTime(),this.emit(Hn.Name,e,this,c))}}setPowerLevel(e,t){var n=this.powerLevel;this.powerLevel=e,n!==this.powerLevel&&(this.updateModifiedTime(),this.emit(Hn.PowerLevel,t,this))}setTypingEvent(e){if(e.getType()==="m.typing"){var t=this.typing;this.typing=!1;var n=e.getContent().user_ids;Array.isArray(n)&&(n.indexOf(this.userId)!==-1&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(Hn.Typing,e,this)))}}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return this.membership===Ne.Leave&&this.events.member!==void 0&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){var e=this.events.member,t=e.getContent(),n=e.getSender();if(t.membership===Ne.Join&&(t=e.getPrevContent(),n=e.getUnsigned().prev_sender),t.membership===Ne.Invite&&t.is_direct)return n}}getAvatarUrl(e,t,n,r){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,o=arguments.length>5?arguments[5]:void 0,c=arguments.length>6&&arguments[6]!==void 0?arguments[6]:!1,d=this.getMxcAvatarUrl();if(!d&&!a)return null;var h=wf(e,d,t,n,r,o,void 0,c);return h||null}getMxcAvatarUrl(){if(this.events.member)return this.events.member.getDirectionalContent().avatar_url;if(this.user)return this.user.avatarUrl}}var jy=/@.+:.+/,KD=/[\u200E\u200F\u202A-\u202F]/;function HD(i,e,t){if(!e||e===i||!t)return!1;var n=Ns(e);if(!n)return!1;if(jy.test(n)||KD.test(e))return!0;var r=t.getUserIdsWithDisplayName(e);return!!r.some(a=>a!==i)}function GD(i,e,t){return!e||e===i?i:t?pg(e)+" ("+i+")":Ns(e)?pg(e):i}var bp={},bc={},Sc={},d_;function Uk(){if(d_)return Sc;d_=1,Object.defineProperty(Sc,"__esModule",{value:!0}),Sc.NamespacedMap=void 0;function i(d,h){var v=typeof Symbol<"u"&&d[Symbol.iterator]||d["@@iterator"];if(!v){if(Array.isArray(d)||(v=e(d))||h){v&&(d=v);var m=0,y=function(){};return{s:y,n:function(){return m>=d.length?{done:!0}:{done:!1,value:d[m++]}},e:function(R){throw R},f:y}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var E=!0,T=!1,S;return{s:function(){v=v.call(d)},n:function(){var R=v.next();return E=R.done,R},e:function(R){T=!0,S=R},f:function(){try{!E&&v.return!=null&&v.return()}finally{if(T)throw S}}}}function e(d,h){if(d){if(typeof d=="string")return t(d,h);var v=Object.prototype.toString.call(d).slice(8,-1);if(v==="Object"&&d.constructor&&(v=d.constructor.name),v==="Map"||v==="Set")return Array.from(d);if(v==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(v))return t(d,h)}}function t(d,h){(h==null||h>d.length)&&(h=d.length);for(var v=0,m=new Array(h);v<h;v++)m[v]=d[v];return m}function n(d,h){if(!(d instanceof h))throw new TypeError("Cannot call a class as a function")}function r(d,h){for(var v=0;v<h.length;v++){var m=h[v];m.enumerable=m.enumerable||!1,m.configurable=!0,"value"in m&&(m.writable=!0),Object.defineProperty(d,m.key,m)}}function a(d,h,v){return h&&r(d.prototype,h),Object.defineProperty(d,"prototype",{writable:!1}),d}function o(d,h,v){return h in d?Object.defineProperty(d,h,{value:v,enumerable:!0,configurable:!0,writable:!0}):d[h]=v,d}var c=(function(){function d(h){if(n(this,d),o(this,"internalMap",new Map),h){var v=i(h),m;try{for(v.s();!(m=v.n()).done;){var y=m.value;this.set(y[0],y[1])}}catch(E){v.e(E)}finally{v.f()}}}return a(d,[{key:"get",value:function(v){return v.name&&this.internalMap.has(v.name)?this.internalMap.get(v.name):v.altName&&this.internalMap.has(v.altName)?this.internalMap.get(v.altName):null}},{key:"set",value:function(v,m){v.name&&this.internalMap.set(v.name,m),v.altName&&this.internalMap.set(v.altName,m)}},{key:"has",value:function(v){return!!this.get(v)}},{key:"delete",value:function(v){v.name&&this.internalMap.delete(v.name),v.altName&&this.internalMap.delete(v.altName)}},{key:"hasNamespaced",value:function(v){return this.internalMap.has(v)}},{key:"getNamespaced",value:function(v){return this.internalMap.get(v)}}]),d})();return Sc.NamespacedMap=c,Sc}var Ec={},h_;function El(){if(h_)return Ec;h_=1;function i(T){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(S){return typeof S}:function(S){return S&&typeof Symbol=="function"&&S.constructor===Symbol&&S!==Symbol.prototype?"symbol":typeof S},i(T)}Object.defineProperty(Ec,"__esModule",{value:!0}),Ec.InvalidEventError=void 0;function e(T,S,O){return Object.defineProperty(T,"prototype",{writable:!1}),T}function t(T,S){if(!(T instanceof S))throw new TypeError("Cannot call a class as a function")}function n(T,S){if(typeof S!="function"&&S!==null)throw new TypeError("Super expression must either be null or a function");T.prototype=Object.create(S&&S.prototype,{constructor:{value:T,writable:!0,configurable:!0}}),Object.defineProperty(T,"prototype",{writable:!1}),S&&m(T,S)}function r(T){var S=h();return function(){var R=y(T),I;if(S){var M=y(this).constructor;I=Reflect.construct(R,arguments,M)}else I=R.apply(this,arguments);return a(this,I)}}function a(T,S){if(S&&(i(S)==="object"||typeof S=="function"))return S;if(S!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return o(T)}function o(T){if(T===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return T}function c(T){var S=typeof Map=="function"?new Map:void 0;return c=function(R){if(R===null||!v(R))return R;if(typeof R!="function")throw new TypeError("Super expression must either be null or a function");if(typeof S<"u"){if(S.has(R))return S.get(R);S.set(R,I)}function I(){return d(R,arguments,y(this).constructor)}return I.prototype=Object.create(R.prototype,{constructor:{value:I,enumerable:!1,writable:!0,configurable:!0}}),m(I,R)},c(T)}function d(T,S,O){return h()?d=Reflect.construct:d=function(I,M,C){var k=[null];k.push.apply(k,M);var _=Function.bind.apply(I,k),P=new _;return C&&m(P,C.prototype),P},d.apply(null,arguments)}function h(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function v(T){return Function.toString.call(T).indexOf("[native code]")!==-1}function m(T,S){return m=Object.setPrototypeOf||function(R,I){return R.__proto__=I,R},m(T,S)}function y(T){return y=Object.setPrototypeOf?Object.getPrototypeOf:function(O){return O.__proto__||Object.getPrototypeOf(O)},y(T)}var E=(function(T){n(O,T);var S=r(O);function O(R){return t(this,O),S.call(this,R)}return e(O)})(c(Error));return Ec.InvalidEventError=E,Ec}var Do={},Tc={},_c={},f_;function Ou(){if(f_)return _c;f_=1,Object.defineProperty(_c,"__esModule",{value:!0}),_c.ExtensibleEvent=void 0;function i(r,a){if(!(r instanceof a))throw new TypeError("Cannot call a class as a function")}function e(r,a){for(var o=0;o<a.length;o++){var c=a[o];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(r,c.key,c)}}function t(r,a,o){return a&&e(r.prototype,a),Object.defineProperty(r,"prototype",{writable:!1}),r}var n=(function(){function r(a){i(this,r),this.wireFormat=a}return t(r,[{key:"wireContent",get:function(){return this.wireFormat.content}}]),r})();return _c.ExtensibleEvent=n,_c}var Cc={},v_;function Bk(){if(v_)return Cc;v_=1,Object.defineProperty(Cc,"__esModule",{value:!0}),Cc.isOptionalAString=i,Cc.isProvided=e;function i(t){return e(t)&&typeof t=="string"}function e(t){return t!=null}return Cc}var ri={},ps={},m_;function Tl(){if(m_)return ps;m_=1;function i(E){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(T){return typeof T}:function(T){return T&&typeof Symbol=="function"&&T.constructor===Symbol&&T!==Symbol.prototype?"symbol":typeof T},i(E)}Object.defineProperty(ps,"__esModule",{value:!0}),ps.UnstableValue=ps.NamespacedValue=void 0;function e(E,T){if(typeof T!="function"&&T!==null)throw new TypeError("Super expression must either be null or a function");E.prototype=Object.create(T&&T.prototype,{constructor:{value:E,writable:!0,configurable:!0}}),Object.defineProperty(E,"prototype",{writable:!1}),T&&t(E,T)}function t(E,T){return t=Object.setPrototypeOf||function(O,R){return O.__proto__=R,O},t(E,T)}function n(E){var T=o();return function(){var O=c(E),R;if(T){var I=c(this).constructor;R=Reflect.construct(O,arguments,I)}else R=O.apply(this,arguments);return r(this,R)}}function r(E,T){if(T&&(i(T)==="object"||typeof T=="function"))return T;if(T!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return a(E)}function a(E){if(E===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return E}function o(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function c(E){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(S){return S.__proto__||Object.getPrototypeOf(S)},c(E)}function d(E,T){if(!(E instanceof T))throw new TypeError("Cannot call a class as a function")}function h(E,T){for(var S=0;S<T.length;S++){var O=T[S];O.enumerable=O.enumerable||!1,O.configurable=!0,"value"in O&&(O.writable=!0),Object.defineProperty(E,O.key,O)}}function v(E,T,S){return T&&h(E.prototype,T),Object.defineProperty(E,"prototype",{writable:!1}),E}var m=(function(){function E(T,S){if(d(this,E),this.stable=T,this.unstable=S,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return v(E,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(S){return!!this.name&&this.name===S||!!this.altName&&this.altName===S}},{key:"findIn",value:function(S){var O;return this.name&&(O=S?.[this.name]),!O&&this.altName&&(O=S?.[this.altName]),O}},{key:"includedIn",value:function(S){var O=!1;return this.name&&(O=S.includes(this.name)),!O&&this.altName&&(O=S.includes(this.altName)),O}}]),E})();ps.NamespacedValue=m;var y=(function(E){e(S,E);var T=n(S);function S(O,R){var I;if(d(this,S),I=T.call(this,O,R),!I.unstable)throw new Error("Unstable value must be supplied");return I}return v(S,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),S})(m);return ps.UnstableValue=y,ps}var p_;function fr(){if(p_)return ri;p_=1,Object.defineProperty(ri,"__esModule",{value:!0}),ri.M_TEXT=ri.M_NOTICE=ri.M_MESSAGE=ri.M_HTML=ri.M_EMOTE=void 0;var i=Tl(),e=new i.UnstableValue("m.message","org.matrix.msc1767.message");ri.M_MESSAGE=e;var t=new i.UnstableValue("m.text","org.matrix.msc1767.text");ri.M_TEXT=t;var n=new i.UnstableValue("m.html","org.matrix.msc1767.html");ri.M_HTML=n;var r=new i.UnstableValue("m.emote","org.matrix.msc1767.emote");ri.M_EMOTE=r;var a=new i.UnstableValue("m.notice","org.matrix.msc1767.notice");return ri.M_NOTICE=a,ri}var nh={},g_;function Ks(){if(g_)return nh;g_=1,Object.defineProperty(nh,"__esModule",{value:!0}),nh.isEventTypeSame=i;function i(e,t){if(typeof e=="string")return typeof t=="string"?t===e:t.matches(e);if(typeof t=="string")return e.matches(t);var n=t,r=e;return n.matches(r.name)||n.matches(r.altName)}return nh}var y_;function Hs(){if(y_)return Tc;y_=1;function i(C){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(k){return typeof k}:function(k){return k&&typeof Symbol=="function"&&k.constructor===Symbol&&k!==Symbol.prototype?"symbol":typeof k},i(C)}Object.defineProperty(Tc,"__esModule",{value:!0}),Tc.MessageEvent=void 0;var e=Ou(),t=Bk(),n=El(),r=fr(),a=Ks();function o(C,k){var _=Object.keys(C);if(Object.getOwnPropertySymbols){var P=Object.getOwnPropertySymbols(C);k&&(P=P.filter(function(x){return Object.getOwnPropertyDescriptor(C,x).enumerable})),_.push.apply(_,P)}return _}function c(C){for(var k=1;k<arguments.length;k++){var _=arguments[k]!=null?arguments[k]:{};k%2?o(Object(_),!0).forEach(function(P){I(C,P,_[P])}):Object.getOwnPropertyDescriptors?Object.defineProperties(C,Object.getOwnPropertyDescriptors(_)):o(Object(_)).forEach(function(P){Object.defineProperty(C,P,Object.getOwnPropertyDescriptor(_,P))})}return C}function d(C,k){if(!(C instanceof k))throw new TypeError("Cannot call a class as a function")}function h(C,k){for(var _=0;_<k.length;_++){var P=k[_];P.enumerable=P.enumerable||!1,P.configurable=!0,"value"in P&&(P.writable=!0),Object.defineProperty(C,P.key,P)}}function v(C,k,_){return k&&h(C.prototype,k),_&&h(C,_),Object.defineProperty(C,"prototype",{writable:!1}),C}function m(C,k){if(typeof k!="function"&&k!==null)throw new TypeError("Super expression must either be null or a function");C.prototype=Object.create(k&&k.prototype,{constructor:{value:C,writable:!0,configurable:!0}}),Object.defineProperty(C,"prototype",{writable:!1}),k&&y(C,k)}function y(C,k){return y=Object.setPrototypeOf||function(P,x){return P.__proto__=x,P},y(C,k)}function E(C){var k=O();return function(){var P=R(C),x;if(k){var U=R(this).constructor;x=Reflect.construct(P,arguments,U)}else x=P.apply(this,arguments);return T(this,x)}}function T(C,k){if(k&&(i(k)==="object"||typeof k=="function"))return k;if(k!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return S(C)}function S(C){if(C===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return C}function O(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function R(C){return R=Object.setPrototypeOf?Object.getPrototypeOf:function(_){return _.__proto__||Object.getPrototypeOf(_)},R(C)}function I(C,k,_){return k in C?Object.defineProperty(C,k,{value:_,enumerable:!0,configurable:!0,writable:!0}):C[k]=_,C}var M=(function(C){m(_,C);var k=E(_);function _(P){var x;d(this,_),x=k.call(this,P),I(S(x),"text",void 0),I(S(x),"html",void 0),I(S(x),"renderings",void 0);var U=r.M_MESSAGE.findIn(x.wireContent),j=r.M_TEXT.findIn(x.wireContent),K=r.M_HTML.findIn(x.wireContent);if((0,t.isProvided)(U)){if(!Array.isArray(U))throw new n.InvalidEventError("m.message contents must be an array");var Z=U.find(function(Pe){return!(0,t.isProvided)(Pe.mimetype)||Pe.mimetype==="text/plain"}),be=U.find(function(Pe){return Pe.mimetype==="text/html"});if(!Z)throw new n.InvalidEventError("m.message is missing a plain text representation");x.text=Z.body,x.html=be?.body,x.renderings=U}else if((0,t.isOptionalAString)(j))x.text=j,x.html=K,x.renderings=[{body:j,mimetype:"text/plain"}],x.html&&x.renderings.push({body:x.html,mimetype:"text/html"});else throw new n.InvalidEventError("Missing textual representation for event");return x}return v(_,[{key:"isEmote",get:function(){return r.M_EMOTE.matches(this.wireFormat.type)||(0,t.isProvided)(r.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return r.M_NOTICE.matches(this.wireFormat.type)||(0,t.isProvided)(r.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(x){return(0,a.isEventTypeSame)(x,r.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var x=I({},r.M_MESSAGE.name,this.renderings);if(this.renderings.length===1){var U=this.renderings[0].mimetype;(U===void 0||U==="text/plain")&&(x=I({},r.M_TEXT.name,this.renderings[0].body))}return x}},{key:"serialize",value:function(){var x;return{type:"m.room.message",content:c(c({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:(x=this.html)!==null&&x!==void 0?x:void 0})}}}],[{key:"from",value:function(x,U){var j;return new _({type:r.M_MESSAGE.name,content:(j={},I(j,r.M_TEXT.name,x),I(j,r.M_HTML.name,U),j)})}}]),_})(e.ExtensibleEvent);return Tc.MessageEvent=M,Tc}var Rc={},b_;function qy(){if(b_)return Rc;b_=1;function i(I){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(M){return typeof M}:function(M){return M&&typeof Symbol=="function"&&M.constructor===Symbol&&M!==Symbol.prototype?"symbol":typeof M},i(I)}Object.defineProperty(Rc,"__esModule",{value:!0}),Rc.NoticeEvent=void 0;var e=Hs(),t=fr(),n=Ks();function r(I,M,C){return M in I?Object.defineProperty(I,M,{value:C,enumerable:!0,configurable:!0,writable:!0}):I[M]=C,I}function a(I,M){if(!(I instanceof M))throw new TypeError("Cannot call a class as a function")}function o(I,M){for(var C=0;C<M.length;C++){var k=M[C];k.enumerable=k.enumerable||!1,k.configurable=!0,"value"in k&&(k.writable=!0),Object.defineProperty(I,k.key,k)}}function c(I,M,C){return M&&o(I.prototype,M),C&&o(I,C),Object.defineProperty(I,"prototype",{writable:!1}),I}function d(){return typeof Reflect<"u"&&Reflect.get?d=Reflect.get:d=function(M,C,k){var _=h(M,C);if(_){var P=Object.getOwnPropertyDescriptor(_,C);return P.get?P.get.call(arguments.length<3?M:k):P.value}},d.apply(this,arguments)}function h(I,M){for(;!Object.prototype.hasOwnProperty.call(I,M)&&(I=O(I),I!==null););return I}function v(I,M){if(typeof M!="function"&&M!==null)throw new TypeError("Super expression must either be null or a function");I.prototype=Object.create(M&&M.prototype,{constructor:{value:I,writable:!0,configurable:!0}}),Object.defineProperty(I,"prototype",{writable:!1}),M&&m(I,M)}function m(I,M){return m=Object.setPrototypeOf||function(k,_){return k.__proto__=_,k},m(I,M)}function y(I){var M=S();return function(){var k=O(I),_;if(M){var P=O(this).constructor;_=Reflect.construct(k,arguments,P)}else _=k.apply(this,arguments);return E(this,_)}}function E(I,M){if(M&&(i(M)==="object"||typeof M=="function"))return M;if(M!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return T(I)}function T(I){if(I===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return I}function S(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function O(I){return O=Object.setPrototypeOf?Object.getPrototypeOf:function(C){return C.__proto__||Object.getPrototypeOf(C)},O(I)}var R=(function(I){v(C,I);var M=y(C);function C(k){return a(this,C),M.call(this,k)}return c(C,[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(_){return(0,n.isEventTypeSame)(_,t.M_NOTICE)||d(O(C.prototype),"isEquivalentTo",this).call(this,_)}},{key:"serialize",value:function(){var _=d(O(C.prototype),"serialize",this).call(this);return _.content.msgtype="m.notice",_}}],[{key:"from",value:function(_,P){var x;return new C({type:t.M_NOTICE.name,content:(x={},r(x,t.M_TEXT.name,_),r(x,t.M_HTML.name,P),x)})}}]),C})(e.MessageEvent);return Rc.NoticeEvent=R,Rc}var kc={},S_;function Vy(){if(S_)return kc;S_=1;function i(I){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(M){return typeof M}:function(M){return M&&typeof Symbol=="function"&&M.constructor===Symbol&&M!==Symbol.prototype?"symbol":typeof M},i(I)}Object.defineProperty(kc,"__esModule",{value:!0}),kc.EmoteEvent=void 0;var e=Hs(),t=fr(),n=Ks();function r(I,M,C){return M in I?Object.defineProperty(I,M,{value:C,enumerable:!0,configurable:!0,writable:!0}):I[M]=C,I}function a(I,M){if(!(I instanceof M))throw new TypeError("Cannot call a class as a function")}function o(I,M){for(var C=0;C<M.length;C++){var k=M[C];k.enumerable=k.enumerable||!1,k.configurable=!0,"value"in k&&(k.writable=!0),Object.defineProperty(I,k.key,k)}}function c(I,M,C){return M&&o(I.prototype,M),C&&o(I,C),Object.defineProperty(I,"prototype",{writable:!1}),I}function d(){return typeof Reflect<"u"&&Reflect.get?d=Reflect.get:d=function(M,C,k){var _=h(M,C);if(_){var P=Object.getOwnPropertyDescriptor(_,C);return P.get?P.get.call(arguments.length<3?M:k):P.value}},d.apply(this,arguments)}function h(I,M){for(;!Object.prototype.hasOwnProperty.call(I,M)&&(I=O(I),I!==null););return I}function v(I,M){if(typeof M!="function"&&M!==null)throw new TypeError("Super expression must either be null or a function");I.prototype=Object.create(M&&M.prototype,{constructor:{value:I,writable:!0,configurable:!0}}),Object.defineProperty(I,"prototype",{writable:!1}),M&&m(I,M)}function m(I,M){return m=Object.setPrototypeOf||function(k,_){return k.__proto__=_,k},m(I,M)}function y(I){var M=S();return function(){var k=O(I),_;if(M){var P=O(this).constructor;_=Reflect.construct(k,arguments,P)}else _=k.apply(this,arguments);return E(this,_)}}function E(I,M){if(M&&(i(M)==="object"||typeof M=="function"))return M;if(M!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return T(I)}function T(I){if(I===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return I}function S(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function O(I){return O=Object.setPrototypeOf?Object.getPrototypeOf:function(C){return C.__proto__||Object.getPrototypeOf(C)},O(I)}var R=(function(I){v(C,I);var M=y(C);function C(k){return a(this,C),M.call(this,k)}return c(C,[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(_){return(0,n.isEventTypeSame)(_,t.M_EMOTE)||d(O(C.prototype),"isEquivalentTo",this).call(this,_)}},{key:"serialize",value:function(){var _=d(O(C.prototype),"serialize",this).call(this);return _.content.msgtype="m.emote",_}}],[{key:"from",value:function(_,P){var x;return new C({type:t.M_EMOTE.name,content:(x={},r(x,t.M_TEXT.name,_),r(x,t.M_HTML.name,P),x)})}}]),C})(e.MessageEvent);return kc.EmoteEvent=R,kc}var E_;function Fk(){if(E_)return Do;E_=1,Object.defineProperty(Do,"__esModule",{value:!0}),Do.LEGACY_M_ROOM_MESSAGE=void 0,Do.parseMRoomMessage=h;var i=Hs(),e=qy(),t=Vy(),n=Tl(),r=fr();function a(v,m){var y=Object.keys(v);if(Object.getOwnPropertySymbols){var E=Object.getOwnPropertySymbols(v);m&&(E=E.filter(function(T){return Object.getOwnPropertyDescriptor(v,T).enumerable})),y.push.apply(y,E)}return y}function o(v){for(var m=1;m<arguments.length;m++){var y=arguments[m]!=null?arguments[m]:{};m%2?a(Object(y),!0).forEach(function(E){c(v,E,y[E])}):Object.getOwnPropertyDescriptors?Object.defineProperties(v,Object.getOwnPropertyDescriptors(y)):a(Object(y)).forEach(function(E){Object.defineProperty(v,E,Object.getOwnPropertyDescriptor(y,E))})}return v}function c(v,m,y){return m in v?Object.defineProperty(v,m,{value:y,enumerable:!0,configurable:!0,writable:!0}):v[m]=y,v}var d=new n.NamespacedValue("m.room.message");Do.LEGACY_M_ROOM_MESSAGE=d;function h(v){var m,y,E;if(r.M_MESSAGE.findIn(v.content)||r.M_TEXT.findIn(v.content))return new i.MessageEvent(v);var T=(m=v.content)===null||m===void 0?void 0:m.msgtype,S=(y=v.content)===null||y===void 0?void 0:y.body,O=((E=v.content)===null||E===void 0?void 0:E.format)==="org.matrix.custom.html"?v.content.formatted_body:null;if(T==="m.text"){var R;return new i.MessageEvent(o(o({},v),{},{content:o(o({},v.content),{},(R={},c(R,r.M_TEXT.name,S),c(R,r.M_HTML.name,O),R))}))}else if(T==="m.notice"){var I;return new e.NoticeEvent(o(o({},v),{},{content:o(o({},v.content),{},(I={},c(I,r.M_TEXT.name,S),c(I,r.M_HTML.name,O),I))}))}else if(T==="m.emote"){var M;return new t.EmoteEvent(o(o({},v),{},{content:o(o({},v.content),{},(M={},c(M,r.M_TEXT.name,S),c(M,r.M_HTML.name,O),M))}))}else return null}return Do}var ih={},T_;function jk(){if(T_)return ih;T_=1,Object.defineProperty(ih,"__esModule",{value:!0}),ih.parseMMessage=r;var i=Hs(),e=fr(),t=Vy(),n=qy();function r(a){return e.M_EMOTE.matches(a.type)?new t.EmoteEvent(a):e.M_NOTICE.matches(a.type)?new n.NoticeEvent(a):new i.MessageEvent(a)}return ih}var ai={},__;function _l(){if(__)return ai;__=1,Object.defineProperty(ai,"__esModule",{value:!0}),ai.M_POLL_START=ai.M_POLL_RESPONSE=ai.M_POLL_KIND_UNDISCLOSED=ai.M_POLL_KIND_DISCLOSED=ai.M_POLL_END=void 0;var i=Tl(),e=new i.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");ai.M_POLL_KIND_DISCLOSED=e;var t=new i.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");ai.M_POLL_KIND_UNDISCLOSED=t;var n=new i.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");ai.M_POLL_START=n;var r=new i.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");ai.M_POLL_RESPONSE=r;var a=new i.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");return ai.M_POLL_END=a,ai}var rh={},gs={},C_;function qk(){if(C_)return gs;C_=1;function i(ce){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(V){return typeof V}:function(V){return V&&typeof Symbol=="function"&&V.constructor===Symbol&&V!==Symbol.prototype?"symbol":typeof V},i(ce)}Object.defineProperty(gs,"__esModule",{value:!0}),gs.PollStartEvent=gs.PollAnswerSubevent=void 0;var e=_l(),t=Hs(),n=fr(),r=El(),a=Tl(),o=Ks(),c=Ou();function d(ce){return y(ce)||m(ce)||v(ce)||h()}function h(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function v(ce,V){if(ce){if(typeof ce=="string")return E(ce,V);var Q=Object.prototype.toString.call(ce).slice(8,-1);if(Q==="Object"&&ce.constructor&&(Q=ce.constructor.name),Q==="Map"||Q==="Set")return Array.from(ce);if(Q==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(Q))return E(ce,V)}}function m(ce){if(typeof Symbol<"u"&&ce[Symbol.iterator]!=null||ce["@@iterator"]!=null)return Array.from(ce)}function y(ce){if(Array.isArray(ce))return E(ce)}function E(ce,V){(V==null||V>ce.length)&&(V=ce.length);for(var Q=0,le=new Array(V);Q<V;Q++)le[Q]=ce[Q];return le}function T(ce,V){var Q=Object.keys(ce);if(Object.getOwnPropertySymbols){var le=Object.getOwnPropertySymbols(ce);V&&(le=le.filter(function(ve){return Object.getOwnPropertyDescriptor(ce,ve).enumerable})),Q.push.apply(Q,le)}return Q}function S(ce){for(var V=1;V<arguments.length;V++){var Q=arguments[V]!=null?arguments[V]:{};V%2?T(Object(Q),!0).forEach(function(le){j(ce,le,Q[le])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ce,Object.getOwnPropertyDescriptors(Q)):T(Object(Q)).forEach(function(le){Object.defineProperty(ce,le,Object.getOwnPropertyDescriptor(Q,le))})}return ce}function O(ce,V){if(!(ce instanceof V))throw new TypeError("Cannot call a class as a function")}function R(ce,V){for(var Q=0;Q<V.length;Q++){var le=V[Q];le.enumerable=le.enumerable||!1,le.configurable=!0,"value"in le&&(le.writable=!0),Object.defineProperty(ce,le.key,le)}}function I(ce,V,Q){return V&&R(ce.prototype,V),Q&&R(ce,Q),Object.defineProperty(ce,"prototype",{writable:!1}),ce}function M(ce,V){if(typeof V!="function"&&V!==null)throw new TypeError("Super expression must either be null or a function");ce.prototype=Object.create(V&&V.prototype,{constructor:{value:ce,writable:!0,configurable:!0}}),Object.defineProperty(ce,"prototype",{writable:!1}),V&&C(ce,V)}function C(ce,V){return C=Object.setPrototypeOf||function(le,ve){return le.__proto__=ve,le},C(ce,V)}function k(ce){var V=x();return function(){var le=U(ce),ve;if(V){var Te=U(this).constructor;ve=Reflect.construct(le,arguments,Te)}else ve=le.apply(this,arguments);return _(this,ve)}}function _(ce,V){if(V&&(i(V)==="object"||typeof V=="function"))return V;if(V!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return P(ce)}function P(ce){if(ce===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return ce}function x(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function U(ce){return U=Object.setPrototypeOf?Object.getPrototypeOf:function(Q){return Q.__proto__||Object.getPrototypeOf(Q)},U(ce)}function j(ce,V,Q){return V in ce?Object.defineProperty(ce,V,{value:Q,enumerable:!0,configurable:!0,writable:!0}):ce[V]=Q,ce}var K=(function(ce){M(Q,ce);var V=k(Q);function Q(le){var ve;O(this,Q),ve=V.call(this,le),j(P(ve),"id",void 0);var Te=le.content.id;if(!Te||typeof Te!="string")throw new r.InvalidEventError("Answer ID must be a non-empty string");return ve.id=Te,ve}return I(Q,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:S({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(ve,Te){return new Q({type:"org.matrix.sdk.poll.answer",content:j({id:ve},n.M_TEXT.name,Te)})}}]),Q})(t.MessageEvent);gs.PollAnswerSubevent=K;var Z=(function(ce){M(Q,ce);var V=k(Q);function Q(le){var ve;O(this,Q),ve=V.call(this,le),j(P(ve),"question",void 0),j(P(ve),"kind",void 0),j(P(ve),"rawKind",void 0),j(P(ve),"maxSelections",void 0),j(P(ve),"answers",void 0);var Te=e.M_POLL_START.findIn(ve.wireContent);if(!Te.question)throw new r.InvalidEventError("A question is required");if(ve.question=new t.MessageEvent({type:"org.matrix.sdk.poll.question",content:Te.question}),ve.rawKind=Te.kind,e.M_POLL_KIND_DISCLOSED.matches(ve.rawKind)?ve.kind=e.M_POLL_KIND_DISCLOSED:ve.kind=e.M_POLL_KIND_UNDISCLOSED,ve.maxSelections=Number.isFinite(Te.max_selections)&&Te.max_selections>0?Te.max_selections:1,!Array.isArray(Te.answers))throw new r.InvalidEventError("Poll answers must be an array");var F=Te.answers.slice(0,20).map(function(ee){return new K({type:"org.matrix.sdk.poll.answer",content:ee})});if(F.length<=0)throw new r.InvalidEventError("No answers available");return ve.answers=F,ve}return I(Q,[{key:"isEquivalentTo",value:function(ve){return(0,o.isEventTypeSame)(ve,e.M_POLL_START)}},{key:"serialize",value:function(){var ve;return{type:e.M_POLL_START.name,content:(ve={},j(ve,e.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map(function(Te){return Te.serialize().content})}),j(ve,n.M_TEXT.name,"".concat(this.question.text,`
`).concat(this.answers.map(function(Te,F){return"".concat(F+1,". ").concat(Te.text)}).join(`
`))),ve)}}}],[{key:"from",value:function(ve,Te,F){var ee,de=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;return new Q({type:e.M_POLL_START.name,content:(ee={},j(ee,n.M_TEXT.name,ve),j(ee,e.M_POLL_START.name,{question:j({},n.M_TEXT.name,ve),kind:F instanceof a.NamespacedValue?F.name:F,max_selections:de,answers:Te.map(function(pe){return j({id:Pe()},n.M_TEXT.name,pe)})}),ee)})}}]),Q})(c.ExtensibleEvent);gs.PollStartEvent=Z;var be="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function Pe(){return d(Array(16)).map(function(){return be.charAt(Math.floor(Math.random()*be.length))}).join("")}return gs}var wc={},Ic={},R_;function Ky(){if(R_)return Ic;R_=1,Object.defineProperty(Ic,"__esModule",{value:!0}),Ic.REFERENCE_RELATION=void 0;var i=Tl(),e=new i.NamespacedValue("m.reference");return Ic.REFERENCE_RELATION=e,Ic}var k_;function Vk(){if(k_)return wc;k_=1;function i(I){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(M){return typeof M}:function(M){return M&&typeof Symbol=="function"&&M.constructor===Symbol&&M!==Symbol.prototype?"symbol":typeof M},i(I)}Object.defineProperty(wc,"__esModule",{value:!0}),wc.PollResponseEvent=void 0;var e=Ou(),t=_l(),n=El(),r=Ky(),a=Ks();function o(I,M){if(!(I instanceof M))throw new TypeError("Cannot call a class as a function")}function c(I,M){for(var C=0;C<M.length;C++){var k=M[C];k.enumerable=k.enumerable||!1,k.configurable=!0,"value"in k&&(k.writable=!0),Object.defineProperty(I,k.key,k)}}function d(I,M,C){return M&&c(I.prototype,M),C&&c(I,C),Object.defineProperty(I,"prototype",{writable:!1}),I}function h(I,M){if(typeof M!="function"&&M!==null)throw new TypeError("Super expression must either be null or a function");I.prototype=Object.create(M&&M.prototype,{constructor:{value:I,writable:!0,configurable:!0}}),Object.defineProperty(I,"prototype",{writable:!1}),M&&v(I,M)}function v(I,M){return v=Object.setPrototypeOf||function(k,_){return k.__proto__=_,k},v(I,M)}function m(I){var M=T();return function(){var k=S(I),_;if(M){var P=S(this).constructor;_=Reflect.construct(k,arguments,P)}else _=k.apply(this,arguments);return y(this,_)}}function y(I,M){if(M&&(i(M)==="object"||typeof M=="function"))return M;if(M!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return E(I)}function E(I){if(I===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return I}function T(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function S(I){return S=Object.setPrototypeOf?Object.getPrototypeOf:function(C){return C.__proto__||Object.getPrototypeOf(C)},S(I)}function O(I,M,C){return M in I?Object.defineProperty(I,M,{value:C,enumerable:!0,configurable:!0,writable:!0}):I[M]=C,I}var R=(function(I){h(C,I);var M=m(C);function C(k){var _;o(this,C),_=M.call(this,k),O(E(_),"internalAnswerIds",void 0),O(E(_),"internalSpoiled",void 0),O(E(_),"pollEventId",void 0);var P=_.wireContent["m.relates_to"];if(!r.REFERENCE_RELATION.matches(P?.rel_type)||typeof P?.event_id!="string")throw new n.InvalidEventError("Relationship must be a reference to an event");return _.pollEventId=P.event_id,_.validateAgainst(null),_}return d(C,[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(_){var P=t.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(P?.answers)){this.internalSpoiled=!0,this.internalAnswerIds=[];return}var x=P.answers;if(x.some(function(U){return typeof U!="string"})||x.length===0){this.internalSpoiled=!0,this.internalAnswerIds=[];return}if(_){if(x.some(function(U){return!_.answers.some(function(j){return j.id===U})})){this.internalSpoiled=!0,this.internalAnswerIds=[];return}x=x.slice(0,_.maxSelections)}this.internalAnswerIds=x,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(_){return(0,a.isEventTypeSame)(_,t.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:t.M_POLL_RESPONSE.name,content:O({"m.relates_to":{rel_type:r.REFERENCE_RELATION.name,event_id:this.pollEventId}},t.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}],[{key:"from",value:function(_,P){return new C({type:t.M_POLL_RESPONSE.name,content:O({"m.relates_to":{rel_type:r.REFERENCE_RELATION.name,event_id:P}},t.M_POLL_RESPONSE.name,{answers:_})})}}]),C})(e.ExtensibleEvent);return wc.PollResponseEvent=R,wc}var Oc={},w_;function Kk(){if(w_)return Oc;w_=1;function i(_){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(P){return typeof P}:function(P){return P&&typeof Symbol=="function"&&P.constructor===Symbol&&P!==Symbol.prototype?"symbol":typeof P},i(_)}Object.defineProperty(Oc,"__esModule",{value:!0}),Oc.PollEndEvent=void 0;var e=_l(),t=El(),n=Ky(),r=Hs(),a=fr(),o=Ks(),c=Ou();function d(_,P){var x=Object.keys(_);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(_);P&&(U=U.filter(function(j){return Object.getOwnPropertyDescriptor(_,j).enumerable})),x.push.apply(x,U)}return x}function h(_){for(var P=1;P<arguments.length;P++){var x=arguments[P]!=null?arguments[P]:{};P%2?d(Object(x),!0).forEach(function(U){C(_,U,x[U])}):Object.getOwnPropertyDescriptors?Object.defineProperties(_,Object.getOwnPropertyDescriptors(x)):d(Object(x)).forEach(function(U){Object.defineProperty(_,U,Object.getOwnPropertyDescriptor(x,U))})}return _}function v(_,P){if(!(_ instanceof P))throw new TypeError("Cannot call a class as a function")}function m(_,P){for(var x=0;x<P.length;x++){var U=P[x];U.enumerable=U.enumerable||!1,U.configurable=!0,"value"in U&&(U.writable=!0),Object.defineProperty(_,U.key,U)}}function y(_,P,x){return P&&m(_.prototype,P),x&&m(_,x),Object.defineProperty(_,"prototype",{writable:!1}),_}function E(_,P){if(typeof P!="function"&&P!==null)throw new TypeError("Super expression must either be null or a function");_.prototype=Object.create(P&&P.prototype,{constructor:{value:_,writable:!0,configurable:!0}}),Object.defineProperty(_,"prototype",{writable:!1}),P&&T(_,P)}function T(_,P){return T=Object.setPrototypeOf||function(U,j){return U.__proto__=j,U},T(_,P)}function S(_){var P=I();return function(){var U=M(_),j;if(P){var K=M(this).constructor;j=Reflect.construct(U,arguments,K)}else j=U.apply(this,arguments);return O(this,j)}}function O(_,P){if(P&&(i(P)==="object"||typeof P=="function"))return P;if(P!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return R(_)}function R(_){if(_===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return _}function I(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function M(_){return M=Object.setPrototypeOf?Object.getPrototypeOf:function(x){return x.__proto__||Object.getPrototypeOf(x)},M(_)}function C(_,P,x){return P in _?Object.defineProperty(_,P,{value:x,enumerable:!0,configurable:!0,writable:!0}):_[P]=x,_}var k=(function(_){E(x,_);var P=S(x);function x(U){var j;v(this,x),j=P.call(this,U),C(R(j),"pollEventId",void 0),C(R(j),"closingMessage",void 0);var K=j.wireContent["m.relates_to"];if(!n.REFERENCE_RELATION.matches(K?.rel_type)||typeof K?.event_id!="string")throw new t.InvalidEventError("Relationship must be a reference to an event");return j.pollEventId=K.event_id,j.closingMessage=new r.MessageEvent(j.wireFormat),j}return y(x,[{key:"isEquivalentTo",value:function(j){return(0,o.isEventTypeSame)(j,e.M_POLL_END)}},{key:"serialize",value:function(){return{type:e.M_POLL_END.name,content:h(C({"m.relates_to":{rel_type:n.REFERENCE_RELATION.name,event_id:this.pollEventId}},e.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}],[{key:"from",value:function(j,K){var Z;return new x({type:e.M_POLL_END.name,content:(Z={"m.relates_to":{rel_type:n.REFERENCE_RELATION.name,event_id:j}},C(Z,e.M_POLL_END.name,{}),C(Z,a.M_TEXT.name,K),Z)})}}]),x})(c.ExtensibleEvent);return Oc.PollEndEvent=k,Oc}var I_;function Hk(){if(I_)return rh;I_=1,Object.defineProperty(rh,"__esModule",{value:!0}),rh.parseMPoll=r;var i=_l(),e=qk(),t=Vk(),n=Kk();function r(a){return i.M_POLL_START.matches(a.type)?new e.PollStartEvent(a):i.M_POLL_RESPONSE.matches(a.type)?new t.PollResponseEvent(a):i.M_POLL_END.matches(a.type)?new n.PollEndEvent(a):null}return rh}var O_;function zD(){if(O_)return bc;O_=1,Object.defineProperty(bc,"__esModule",{value:!0}),bc.ExtensibleEvents=void 0;var i=Uk(),e=El(),t=Fk(),n=jk(),r=fr(),a=_l(),o=Hk();function c(S,O){var R=typeof Symbol<"u"&&S[Symbol.iterator]||S["@@iterator"];if(!R){if(Array.isArray(S)||(R=d(S))||O){R&&(S=R);var I=0,M=function(){};return{s:M,n:function(){return I>=S.length?{done:!0}:{done:!1,value:S[I++]}},e:function(x){throw x},f:M}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var C=!0,k=!1,_;return{s:function(){R=R.call(S)},n:function(){var x=R.next();return C=x.done,x},e:function(x){k=!0,_=x},f:function(){try{!C&&R.return!=null&&R.return()}finally{if(k)throw _}}}}function d(S,O){if(S){if(typeof S=="string")return h(S,O);var R=Object.prototype.toString.call(S).slice(8,-1);if(R==="Object"&&S.constructor&&(R=S.constructor.name),R==="Map"||R==="Set")return Array.from(S);if(R==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(R))return h(S,O)}}function h(S,O){(O==null||O>S.length)&&(O=S.length);for(var R=0,I=new Array(O);R<O;R++)I[R]=S[R];return I}function v(S,O){if(!(S instanceof O))throw new TypeError("Cannot call a class as a function")}function m(S,O){for(var R=0;R<O.length;R++){var I=O[R];I.enumerable=I.enumerable||!1,I.configurable=!0,"value"in I&&(I.writable=!0),Object.defineProperty(S,I.key,I)}}function y(S,O,R){return O&&m(S.prototype,O),R&&m(S,R),Object.defineProperty(S,"prototype",{writable:!1}),S}function E(S,O,R){return O in S?Object.defineProperty(S,O,{value:R,enumerable:!0,configurable:!0,writable:!0}):S[O]=R,S}var T=(function(){function S(){v(this,S),E(this,"interpreters",new i.NamespacedMap([[t.LEGACY_M_ROOM_MESSAGE,t.parseMRoomMessage],[r.M_MESSAGE,n.parseMMessage],[r.M_EMOTE,n.parseMMessage],[r.M_NOTICE,n.parseMMessage],[a.M_POLL_START,o.parseMPoll],[a.M_POLL_RESPONSE,o.parseMPoll],[a.M_POLL_END,o.parseMPoll]])),E(this,"_unknownInterpretOrder",[r.M_MESSAGE])}return y(S,[{key:"unknownInterpretOrder",get:function(){var R;return(R=this._unknownInterpretOrder)!==null&&R!==void 0?R:[]},set:function(R){this._unknownInterpretOrder=R}},{key:"registerInterpreter",value:function(R,I){this.interpreters.set(R,I)}},{key:"parse",value:function(R){try{if(this.interpreters.hasNamespaced(R.type))return this.interpreters.getNamespaced(R.type)(R);var I=c(this.unknownInterpretOrder),M;try{for(I.s();!(M=I.n()).done;){var C=M.value;if(this.interpreters.has(C)){var k=this.interpreters.get(C)(R);if(k)return k}}}catch(_){I.e(_)}finally{I.f()}return null}catch(_){if(_ instanceof e.InvalidEventError)return null;throw _}}}],[{key:"defaultInstance",get:function(){return S._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return S.defaultInstance.unknownInterpretOrder},set:function(R){S.defaultInstance.unknownInterpretOrder=R}},{key:"registerInterpreter",value:function(R,I){S.defaultInstance.registerInterpreter(R,I)}},{key:"parse",value:function(R){return S.defaultInstance.parse(R)}}]),S})();return bc.ExtensibleEvents=T,E(T,"_defaultInstance",new T),bc}var Sp={},M_;function WD(){return M_||(M_=1,Object.defineProperty(Sp,"__esModule",{value:!0})),Sp}var ys={},P_;function JD(){if(P_)return ys;P_=1,Object.defineProperty(ys,"__esModule",{value:!0}),ys.LegacyMsgType=void 0,ys.isEventLike=t;var i=fr(),e;ys.LegacyMsgType=e,(function(n){n.Text="m.text",n.Notice="m.notice",n.Emote="m.emote"})(e||(ys.LegacyMsgType=e={}));function t(n,r){var a=n.content;return r===e.Text?i.M_MESSAGE.matches(n.type)||n.type==="m.room.message"&&a?.msgtype==="m.text":r===e.Emote?i.M_EMOTE.matches(n.type)||n.type==="m.room.message"&&a?.msgtype==="m.emote":r===e.Notice?i.M_NOTICE.matches(n.type)||n.type==="m.room.message"&&a?.msgtype==="m.notice":!1}return ys}var A_;function YD(){return A_||(A_=1,(function(i){Object.defineProperty(i,"__esModule",{value:!0});var e=zD();Object.keys(e).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===e[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return e[_]}})});var t=WD();Object.keys(t).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===t[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return t[_]}})});var n=El();Object.keys(n).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===n[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return n[_]}})});var r=Tl();Object.keys(r).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===r[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return r[_]}})});var a=Uk();Object.keys(a).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===a[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return a[_]}})});var o=Bk();Object.keys(o).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===o[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return o[_]}})});var c=JD();Object.keys(c).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===c[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return c[_]}})});var d=Ks();Object.keys(d).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===d[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return d[_]}})});var h=Fk();Object.keys(h).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===h[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return h[_]}})});var v=jk();Object.keys(v).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===v[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return v[_]}})});var m=Hk();Object.keys(m).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===m[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return m[_]}})});var y=Ky();Object.keys(y).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===y[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return y[_]}})});var E=Ou();Object.keys(E).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===E[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return E[_]}})});var T=fr();Object.keys(T).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===T[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return T[_]}})});var S=Hs();Object.keys(S).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===S[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return S[_]}})});var O=Vy();Object.keys(O).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===O[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return O[_]}})});var R=qy();Object.keys(R).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===R[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return R[_]}})});var I=_l();Object.keys(I).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===I[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return I[_]}})});var M=qk();Object.keys(M).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===M[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return M[_]}})});var C=Vk();Object.keys(C).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===C[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return C[_]}})});var k=Kk();Object.keys(k).forEach(function(_){_==="default"||_==="__esModule"||_ in i&&i[_]===k[_]||Object.defineProperty(i,_,{enumerable:!0,get:function(){return k[_]}})})})(bp)),bp}var Wn=YD();const $D="modulepreload",XD=function(i){return"/"+i},D_={},QD=function(e,t,n){let r=Promise.resolve();if(t&&t.length>0){let d=function(h){return Promise.all(h.map(v=>Promise.resolve(v).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),c=o?.nonce||o?.getAttribute("nonce");r=d(t.map(h=>{if(h=XD(h),h in D_)return;D_[h]=!0;const v=h.endsWith(".css"),m=v?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${h}"]${m}`))return;const y=document.createElement("link");if(y.rel=v?"stylesheet":$D,v||(y.as="script"),y.crossOrigin="",y.href=h,c&&y.setAttribute("nonce",c),document.head.appendChild(y),v)return new Promise((E,T)=>{y.addEventListener("load",E),y.addEventListener("error",()=>T(new Error(`Unable to preload CSS for ${h}`)))})}))}function a(o){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=o,window.dispatchEvent(c),!c.defaultPrevented)throw o}return r.then(o=>{for(const c of o||[])c.status==="rejected"&&a(c.reason);return e().catch(a)})};function ZD(i,e){if(i==null)return{};var t={};for(var n in i)if({}.hasOwnProperty.call(i,n)){if(e.includes(n))continue;t[n]=i[n]}return t}function e1(i,e){if(i==null)return{};var t,n,r=ZD(i,e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(i);for(n=0;n<a.length;n++)t=a[n],e.includes(t)||{}.propertyIsEnumerable.call(i,t)&&(r[t]=i[t])}return r}var ci=(function(i){return i.DisplayName="User.displayName",i.AvatarUrl="User.avatarUrl",i.Presence="User.presence",i.CurrentlyActive="User.currentlyActive",i.LastPresenceTs="User.lastPresenceTs",i})({});class $r extends Ot{constructor(e){super(),this.userId=e,b(this,"modified",-1),b(this,"displayName",void 0),b(this,"rawDisplayName",void 0),b(this,"avatarUrl",void 0),b(this,"presenceStatusMsg",void 0),b(this,"presence","offline"),b(this,"lastActiveAgo",0),b(this,"lastPresenceTs",0),b(this,"currentlyActive",!1),b(this,"events",{}),this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}static createUser(e,t){var n=new $r(e);return t.reEmitter.reEmit(n,[ci.AvatarUrl,ci.DisplayName,ci.Presence,ci.CurrentlyActive,ci.LastPresenceTs]),n}setPresenceEvent(e){if(e.getType()==="m.presence"){var t=this.events.presence===null;this.events.presence=e;var n=[];(e.getContent().presence!==this.presence||t)&&n.push(ci.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&n.push(ci.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&n.push(ci.DisplayName),e.getContent().currently_active!==void 0&&e.getContent().currently_active!==this.currentlyActive&&n.push(ci.CurrentlyActive),this.presence=e.getContent().presence,n.push(ci.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(var r of n)this.emit(r,e,this)}}setDisplayName(e){var t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){var t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}var Be=(function(i){return i.Backward="b",i.Forward="f",i})({});class me{static setEventMetadata(e,t,n){e.setMetadata(t,n)}constructor(e){var t,n;this.eventTimelineSet=e,b(this,"roomId",void 0),b(this,"name",void 0),b(this,"events",[]),b(this,"baseIndex",0),b(this,"startState",void 0),b(this,"endState",void 0),b(this,"startToken",null),b(this,"endToken",null),b(this,"prevTimeline",null),b(this,"nextTimeline",null),b(this,"paginationRequests",{[Be.Backward]:null,[Be.Forward]:null}),this.roomId=(t=(n=e.room)===null||n===void 0?void 0:n.roomId)!==null&&t!==void 0?t:null,this.roomId&&(this.startState=new mu(this.roomId),this.endState=new mu(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+new Date().toISOString()}initialiseState(e){var t,n,{timelineWasEmpty:r}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.events.length>0)throw new Error("Cannot initialise state after events are added");(t=this.startState)===null||t===void 0||t.setStateEvents(e,{timelineWasEmpty:r}),(n=this.endState)===null||n===void 0||n.setStateEvents(e,{timelineWasEmpty:r})}forkLive(e){var t=this.getState(e),n=new me(this.eventTimelineSet);return n.startState=t?.clone(),n.endState=t,this.endState=t?.clone(),n}fork(e){var t=this.getState(e),n=new me(this.eventTimelineSet);return n.startState=t?.clone(),n.endState=t?.clone(),n}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==me.BACKWARDS)return this.startState;if(e==me.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e===Be.Backward?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t===Be.Backward?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==me.BACKWARDS)return this.prevTimeline;if(e==me.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==me.BACKWARDS)this.prevTimeline=e;else if(t==me.FORWARDS)this.nextTimeline=e;else throw new Error("Invalid direction '"+t+"'");this.setPaginationToken(null,t)}addEvent(e,t){var{toStartOfTimeline:n,roomState:r,timelineWasEmpty:a,addToState:o}=t;r||(r=n?this.startState:this.endState);var c=this.getTimelineSet();if(c.room&&(me.setEventMetadata(e,r,n),o&&e.isState()&&c.room.getUnfilteredTimelineSet()===c)){var d;(d=r)===null||d===void 0||d.setStateEvents([e],{timelineWasEmpty:a}),(!e.sender||e.getType()===G.RoomMember&&!n)&&me.setEventMetadata(e,r,n)}var h;n?h=0:h=this.events.length,this.events.splice(h,0,e),n&&this.baseIndex++}insertEvent(e,t,n,r){var a=this.getTimelineSet();a.room&&(me.setEventMetadata(e,n,!1),r&&e.isState()&&a.room.getUnfilteredTimelineSet()===a&&(n.setStateEvents([e],{}),(!e.sender||e.getType()===G.RoomMember)&&me.setEventMetadata(e,n,!1))),this.events.splice(t,0,e)}removeEvent(e){for(var t=this.events.length-1;t>=0;t--){var n=this.events[t];if(n.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,n}return null}toString(){return this.name}}b(me,"BACKWARDS",Be.Backward);b(me,"FORWARDS",Be.Forward);var Sh=(function(i){return i.Add="Relations.add",i.Remove="Relations.remove",i.Redaction="Relations.redaction",i})({}),t1=function(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[];return[t,...n].includes(e)};class Hy extends Ot{constructor(e,t,n,r){var a;super(),a=this,this.relationType=e,this.eventType=t,this.altEventTypes=r,b(this,"relationEventIds",new Set),b(this,"relations",new Set),b(this,"annotationsByKey",{}),b(this,"annotationsBySender",{}),b(this,"sortedAnnotationsByKey",[]),b(this,"targetEvent",null),b(this,"creationEmitted",!1),b(this,"client",void 0),b(this,"onEventStatus",(o,c)=>{if(!o.isSending()){o.removeListener(ot.Status,this.onEventStatus);return}c===Ie.CANCELLED&&(o.removeListener(ot.Status,this.onEventStatus),this.removeEvent(o))}),b(this,"onBeforeRedaction",(function(){var o=A(function*(c){if(a.relations.has(c)){if(a.relations.delete(c),a.relationType===Et.Annotation)a.removeAnnotationFromAggregation(c);else if(a.relationType===Et.Replace&&a.targetEvent&&!a.targetEvent.isState()){var d=yield a.getLastReplacement();a.targetEvent.makeReplaced(d)}c.removeListener(ot.BeforeRedaction,a.onBeforeRedaction),a.emit(Sh.Redaction,c)}});return function(c){return o.apply(this,arguments)}})()),this.client=n instanceof Pf?n.client:n}addEvent(e){var t=this;return A(function*(){if(!t.relationEventIds.has(e.getId())){var n=e.getRelation();if(!n){D.error("Event must have relation info");return}var r=n.rel_type,a=e.getType();if(t.relationType!==r||!t1(a,t.eventType,t.altEventTypes)){D.error("Event relation info doesn't match this container");return}if(e.isSending()&&e.on(ot.Status,t.onEventStatus),t.relations.add(e),t.relationEventIds.add(e.getId()),t.relationType===Et.Annotation)t.addAnnotationToAggregation(e);else if(t.relationType===Et.Replace&&t.targetEvent&&!t.targetEvent.isState()){var o=yield t.getLastReplacement();t.targetEvent.makeReplaced(o)}e.on(ot.BeforeRedaction,t.onBeforeRedaction),t.emit(Sh.Add,e),t.maybeEmitCreated()}})()}removeEvent(e){var t=this;return A(function*(){if(t.relations.has(e)){if(t.relations.delete(e),t.relationType===Et.Annotation)t.removeAnnotationFromAggregation(e);else if(t.relationType===Et.Replace&&t.targetEvent&&!t.targetEvent.isState()){var n=yield t.getLastReplacement();t.targetEvent.makeReplaced(n)}t.emit(Sh.Remove,e)}})()}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t,{key:n}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(n){var r=this.annotationsByKey[n];r||(r=this.annotationsByKey[n]=new Set,this.sortedAnnotationsByKey.push([n,r])),r.add(e),this.sortedAnnotationsByKey.sort((c,d)=>{var h=c[1],v=d[1];return v.size-h.size});var a=e.getSender(),o=this.annotationsBySender[a];o||(o=this.annotationsBySender[a]=new Set),o.add(e)}}removeAnnotationFromAggregation(e){var t,{key:n}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(n){var r=this.annotationsByKey[n];r&&(r.delete(e),this.sortedAnnotationsByKey.sort((c,d)=>{var h=c[1],v=d[1];return v.size-h.size}));var a=e.getSender(),o=this.annotationsBySender[a];o&&o.delete(e)}}getSortedAnnotationsByKey(){return this.relationType!==Et.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==Et.Annotation?null:this.annotationsBySender}getLastReplacement(){var e=this;return A(function*(){if(e.relationType!==Et.Replace||!e.targetEvent)return null;var t=e.targetEvent.getServerAggregatedRelation(Et.Replace),n=t?.origin_server_ts,r=e.getRelations().reduce((a,o)=>o.getSender()!==e.targetEvent.getSender()||n&&n>o.getTs()||a&&a.getTs()>o.getTs()?a:o,null);return r!=null&&r.shouldAttemptDecryption()&&e.client.getCrypto()?yield r.attemptDecryption(e.client.getCrypto()):r!=null&&r.isBeingDecrypted()&&(yield r.getDecryptionPromise()),r})()}setTargetEvent(e){var t=this;return A(function*(){if(!t.targetEvent){if(t.targetEvent=e,t.relationType===Et.Replace&&!t.targetEvent.isState()){var n=yield t.getLastReplacement();n&&t.targetEvent.makeReplaced(n)}t.maybeEmitCreated()}})()}maybeEmitCreated(){this.creationEmitted||!this.targetEvent||!this.relations.size||(this.creationEmitted=!0,this.targetEvent.emit(ot.RelationsCreated,this.relationType,this.eventType))}}class Gk{constructor(e,t){this.client=e,this.room=t,b(this,"relations",new Map)}getChildEventsForEvent(e,t,n){var r;return(r=this.relations.get(e))===null||r===void 0||(r=r.get(t))===null||r===void 0?void 0:r.get(n)}getAllChildEventsForEvent(e){var t,n=(t=this.relations.get(e))!==null&&t!==void 0?t:new Map,r=[];for(var a of n.values())for(var o of a.values())r.push(...o.getRelations());return r}aggregateParentEvent(e){var t=this.relations.get(e.getId());if(t)for(var n of t.values())for(var r of n.values())r.setTargetEvent(e)}aggregateChildEvent(e,t){if(!(e.isRedacted()||e.status===Ie.CANCELLED)){var n=e.getRelation();if(n){var r=()=>{if(e.isDecryptionFailure()){e.once(ot.Decrypted,r);return}this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption()){e.once(ot.Decrypted,r);return}var{event_id:a,rel_type:o}=n,c=e.getType(),d=this.relations.get(a);d||(d=new Map,this.relations.set(a,d));var h=d.get(o);h||(h=new Map,d.set(o,h));var v=h.get(c);if(!v){var m,y,E;v=new Hy(o,c,this.client),h.set(c,v);var T=(m=this.room)!==null&&m!==void 0?m:t?.room,S=(y=(E=t?.findEventById(a))!==null&&E!==void 0?E:T?.findEventById(a))!==null&&y!==void 0?y:T?.getPendingEvent(a);S&&v.setTargetEvent(S)}v.addEvent(e)}}}}var qo;qo=D.log.bind(D);var zc=(function(i){return i.Ignore="ignore",i.Replace="replace",i})({});class Ho extends Ot{constructor(e){var t,n,r,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},o=arguments.length>2?arguments[2]:void 0,c=arguments.length>3?arguments[3]:void 0,d=arguments.length>4&&arguments[4]!==void 0?arguments[4]:null;super(),this.room=e,this.thread=c,this.threadListType=d,b(this,"relations",void 0),b(this,"timelineSupport",void 0),b(this,"displayPendingEvents",void 0),b(this,"liveTimeline",void 0),b(this,"timelines",void 0),b(this,"_eventIdToTimeline",new Map),b(this,"filter",void 0),this.timelineSupport=!!a.timelineSupport,this.liveTimeline=new me(this),this.displayPendingEvents=a.pendingEvents!==!1,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=a.filter,this.relations=(t=(n=this.room)===null||n===void 0?void 0:n.relations)!==null&&t!==void 0?t:new Gk((r=e?.client)!==null&&r!==void 0?r:o)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return!this.room||!this.displayPendingEvents?[]:this.room.getPendingEvents()}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){var n=this._eventIdToTimeline.get(e);n&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,n))}resetLiveTimeline(e,t){var n=!this.timelineSupport||!t,r=this.liveTimeline,a=n?r.forkLive(me.FORWARDS):r.fork(me.FORWARDS);n?(this.timelines=[a],this._eventIdToTimeline=new Map):this.timelines.push(a),t&&r.setPaginationToken(t,me.FORWARDS),a.setPaginationToken(e??null,me.BACKWARDS),this.liveTimeline=a,this.emit(ge.TimelineReset,this.room,this,n)}getTimelineForEvent(e){if(e==null)return null;var t=this._eventIdToTimeline.get(e);return t===void 0?null:t}findEventById(e){var t=this.getTimelineForEvent(e);if(t)return t.getEvents().find(function(n){return n.getId()==e})}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");var e=new me(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,n,r,a){if(!r)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&r==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(!(this.filter&&(e=this.filter.filterRoomTimeline(e),!e.length))){var o=t?me.BACKWARDS:me.FORWARDS,c=t?me.FORWARDS:me.BACKWARDS,d=!1,h=!1;for(var v of e){var m=v.getId(),y=this._eventIdToTimeline.get(m);if(!y){this.addEventToTimeline(v,r,{toStartOfTimeline:t,addToState:n}),h=!0,d=!0;continue}if(h=!1,y==r){qo("Event "+m+" already in timeline "+r);continue}var E=r.getNeighbouringTimeline(o);if(E){y==E?qo("Event "+m+" in neighbouring timeline - switching to "+y):qo("Event "+m+" already in a different timeline "+y),r=y;continue}D.info("Already have timeline for "+m+" - joining timeline "+r+" to "+y);var T=y===this.liveTimeline,S=r===this.liveTimeline,O=o===me.BACKWARDS&&T,R=o===me.FORWARDS&&S;if(O||R){O&&D.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+y+")"),R&&D.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+r+")");continue}r.setNeighbouringTimeline(y,o),y.setNeighbouringTimeline(r,c),r=y,d=!0}if(h||!d){if(o===me.FORWARDS&&r===this.liveTimeline){D.warn({lastEventWasNew:h,didUpdate:d}),D.warn("Refusing to set forwards pagination token of live timeline "+"".concat(r," to ").concat(a));return}r.setPaginationToken(a??null,o)}}}addLiveEvent(e,t){var{duplicateStrategy:n,fromCache:r,roomState:a,timelineWasEmpty:o,addToState:c}=t;if(this.filter){var d=this.filter.filterRoomTimeline([e]);if(!d.length)return}var h=this._eventIdToTimeline.get(e.getId());if(h){if(n===zc.Replace){qo("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());for(var v=h.getEvents(),m=0;m<v.length;m++)if(v[m].getId()===e.getId()){a||(a=h.getState(me.FORWARDS)),me.setEventMetadata(e,a,!1),v[m]=e;break}}else qo("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());return}this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:r,roomState:a,timelineWasEmpty:o,addToState:c})}addEventToTimeline(e,t,n){var{toStartOfTimeline:r,fromCache:a=!1,roomState:o,timelineWasEmpty:c,addToState:d}=n;if(t.getTimelineSet()!==this){var h;throw new Error("EventTimelineSet.addEventToTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((h=this.thread)===null||h===void 0?void 0:h.id,")"))}var v=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var m,y="event=".concat(v);e.threadRootId&&(y+="(belongs to thread=".concat(e.threadRootId,")")),D.warn("EventTimelineSet.addEventToTimeline: Ignoring ".concat(y," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((m=this.thread)===null||m===void 0?void 0:m.id,")"));return}t.addEvent(e,{toStartOfTimeline:r,roomState:o,timelineWasEmpty:c,addToState:d}),this._eventIdToTimeline.set(v,t);var E={timeline:t,liveEvent:!r&&t==this.liveTimeline&&!a};this.emit(ge.Timeline,e,this.room,!!r,!1,E)}insertEventIntoTimeline(e,t,n,r){if(t.getTimelineSet()!==this){var a;throw new Error("EventTimelineSet.insertEventIntoTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((a=this.thread)===null||a===void 0?void 0:a.id,")"))}var o=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var c,d="event=".concat(o);e.threadRootId&&(d+="(belongs to thread=".concat(e.threadRootId,")")),D.warn("EventTimelineSet.insertEventIntoTimeline: Ignoring ".concat(d," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((c=this.thread)===null||c===void 0?void 0:c.id,")"));return}var h=e.relationEventId;if(!h){this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,timelineWasEmpty:!1,roomState:n,addToState:r});return}for(var v=this.findEventById(h),m=t.getEvents(),y=v!==void 0?m.indexOf(v):0,E=y;E<m.length;E++){var T=m[E];if(T.getTs()>e.getTs())break}t.insertEvent(e,E,n,r),this._eventIdToTimeline.set(o,t);var S={timeline:t,liveEvent:!1};this.emit(ge.Timeline,e,this.room,!1,!1,S)}handleRemoteEcho(e,t,n){var r=this._eventIdToTimeline.get(t);r?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(n,r)):(!this.filter||this.filter.filterRoomTimeline([e]).length)&&this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,addToState:!1})}removeEvent(e){var t=this._eventIdToTimeline.get(e);if(!t)return null;var n=t.removeEvent(e);if(n){this._eventIdToTimeline.delete(e);var r={timeline:t};this.emit(ge.Timeline,n,this.room,void 0,!0,r)}return n}compareEventOrdering(e,t){if(e==t)return 0;var n=this._eventIdToTimeline.get(e),r=this._eventIdToTimeline.get(t);if(n===void 0||r===void 0)return null;if(n===r){for(var a=void 0,o=void 0,c=n.getEvents(),d=0;d<c.length&&(a===void 0||o===void 0);d++){var h=c[d].getId();h==e&&(a=d),h==t&&(o=d)}var v=a-o;return v<0?-1:v>0?1:0}for(var m=n;m;){if(m===r)return-1;m=m.getNeighbouringTimeline(me.FORWARDS)}for(m=n;m;){if(m===r)return 1;m=m.getNeighbouringTimeline(me.BACKWARDS)}return null}canContain(e){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");var{threadId:t,shouldLiveInRoom:n,shouldLiveInThread:r}=this.room.eventShouldLiveIn(e);if(this.thread)return this.thread.id===t;if(!n&&!r){var a;D.warn("EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=".concat((a=this.room)===null||a===void 0?void 0:a.roomId," eventId=").concat(e.getId()," threadId=").concat(e.threadRootId))}return n}}var Ie=(function(i){return i.NOT_SENT="not_sent",i.ENCRYPTING="encrypting",i.SENDING="sending",i.QUEUED="queued",i.SENT="sent",i.CANCELLED="cancelled",i})({});class zk{constructor(e,t){this.roomId=e}}class Wk{constructor(e){this.target=e,b(this,"reEmitters",new WeakMap)}reEmit(e,t){var n=this,r=this.reEmitters.get(e);r||(r=new Map,this.reEmitters.set(e,r));var a=function(d){if(r.has(d))return 1;var h=function(){if(!(d==="error"&&n.target.listenerCount("error")===0)){for(var m=arguments.length,y=new Array(m),E=0;E<m;E++)y[E]=arguments[E];n.target.emit(d,...y,e)}};e.on(d,h),r.set(d,h)};for(var o of t)a(o)}stopReEmitting(e,t){var n=this.reEmitters.get(e);if(n){for(var r of t)e.off(r,n.get(r)),n.delete(r);n.size===0&&this.reEmitters.delete(e)}}}class Cl extends Wk{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}}var au=new Rf("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications");function n1(i,e){if(e.endsWith("*")){var t=e.slice(0,-1);return i.slice(0,t.length)===t}else return i===e}class N_{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,n,r=((t=e.getUnsigned())===null||t===void 0?void 0:t["m.relations"])||{},a=Object.keys(r),o=[];return this.userId&&r!==null&&r!==void 0&&(n=r[mt.name])!==null&&n!==void 0&&n.current_user_participated&&o.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),e.getContent()?e.getContent().url!==void 0:!1,a,o)}toJSON(){return Object.fromEntries(Object.entries({types:this.filterJson.types,not_types:this.filterJson.not_types,rooms:this.filterJson.rooms,not_rooms:this.filterJson.not_rooms,senders:this.filterJson.senders,not_senders:this.filterJson.not_senders,contains_url:this.filterJson.contains_url,[Zo.name]:this.filterJson[Zo.name],[el.name]:this.filterJson[el.name]}).filter(e=>{var[t,n]=e;return n}))}checkFields(e,t,n,r,a,o){var c={rooms:function(R){return e===R},senders:function(R){return t===R},types:function(R){return n1(n,R)}};for(var d in c){var h=c[d],v="not_"+d,m=this.filterJson[v];if(m!=null&&m.some(h))return!1;var y=this.filterJson[d];if(y&&!y.some(h))return!1}var E=this.filterJson.contains_url;if(E!==void 0&&E!==r)return!1;var T=this.filterJson[el.name];if(T!==void 0&&!this.arrayMatchesFilter(T,a))return!1;var S=this.filterJson[Zo.name];return!(S!==void 0&&!this.arrayMatchesFilter(S,o))}arrayMatchesFilter(e,t){return t.length>0&&e.every(n=>t.includes(n))}filter(e){return e.filter(this.check,this)}limit(){return this.filterJson.limit!==void 0?this.filterJson.limit:10}}function x_(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function No(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?x_(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):x_(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}function Ep(i,e,t){for(var n=e.split("."),r=i,a=0;a<n.length-1;a++)r[n[a]]||(r[n[a]]={}),r=r[n[a]];r[n[n.length-1]]=t}class di{static fromJson(e,t,n){var r=new di(e,t);return r.setDefinition(n),r}constructor(e,t){this.userId=e,this.filterId=t,b(this,"definition",{}),b(this,"roomFilter",void 0),b(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;var t=e.room,n={};t&&(t.rooms&&(n.rooms=t.rooms),t.rooms&&(n.not_rooms=t.not_rooms)),this.roomFilter=new N_(n,this.userId),this.roomTimelineFilter=new N_(t?.timeline||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){Ep(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,n;this.definition=No(No({},this.definition),{},{room:No(No({},(t=this.definition)===null||t===void 0?void 0:t.room),{},{timeline:No(No({},(n=this.definition)===null||n===void 0||(n=n.room)===null||n===void 0?void 0:n.timeline),{},{[au.name]:e})})})}setLazyLoadMembers(e){Ep(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){Ep(this.definition,"room.include_leave",e)}}b(di,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0});function Jh(i){return i!=null}var i1=new Wn.UnstableValue("m.message","org.matrix.msc1767.message"),Gy=new Wn.UnstableValue("m.text","org.matrix.msc1767.text"),r1=new Wn.UnstableValue("m.html","org.matrix.msc1767.html"),Jk=new Wn.NamespacedValue("m.reference");function a1(i,e){if(typeof i=="string")return typeof e=="string"?e===i:e.matches(i);if(typeof e=="string")return i.matches(e);var t=e,n=i;return t.matches(n.name)||Jh(n.altName)&&t.matches(n.altName)}var zy=new Sl("m.topic");function L_(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function s1(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?L_(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):L_(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}function Yk(i,e){return{msgtype:hr.Text,format:"org.matrix.custom.html",body:i,formatted_body:e}}function $k(i,e){return{msgtype:hr.Notice,format:"org.matrix.custom.html",body:i,formatted_body:e}}function Xk(i,e){return{msgtype:hr.Emote,format:"org.matrix.custom.html",body:i,formatted_body:e}}function Qk(i){return{msgtype:hr.Text,body:i}}function Zk(i){return{msgtype:hr.Notice,body:i}}function ew(i){return{msgtype:hr.Emote,body:i}}var tw=(i,e,t,n)=>{var r="at ".concat(new Date(t).toISOString()),a=e===ll.Self?"User":void 0,o=n?'"'.concat(n,'"'):void 0;return[a,"Location",o,i,r].filter(Boolean).join(" ")},nw=(i,e,t,n,r)=>{var a=i??tw(e,r||ll.Self,t,n),o=t?{[Ja.name]:t}:{};return s1({msgtype:hr.Location,body:a,geo_uri:e,[Ru.name]:{description:n,uri:e},[Cu.name]:{type:r||ll.Self},[Gy.name]:a},o)},o1=i=>{var e,t,n=Ru.findIn(i),r=Cu.findIn(i),a=Ja.findIn(i),o=Gy.findIn(i),c=(e=n?.uri)!==null&&e!==void 0?e:i?.geo_uri,d=n?.description,h=(t=r?.type)!==null&&t!==void 0?t:ll.Self,v=o??i.body;return nw(v,c,a??void 0,d,h)},iw=(i,e)=>{var t=[];return Jh(e)&&t.push({body:e,mimetype:"text/html"}),Jh(i)&&t.push({body:i,mimetype:"text/plain"}),{topic:i,[zy.name]:{"m.text":t}}},l1=i=>{var e,t,n,r,a=zy.findIn(i),o=Array.isArray(a)?a:a?.["m.text"];if(!Array.isArray(o)){var c;return{text:(c=i.topic)!==null&&c!==void 0?c:void 0}}var d=(e=(t=o==null||(n=o.find(v=>!Jh(v.mimetype)||v.mimetype==="text/plain"))===null||n===void 0?void 0:n.body)!==null&&t!==void 0?t:i.topic)!==null&&e!==void 0?e:void 0,h=o==null||(r=o.find(v=>v.mimetype==="text/html"))===null||r===void 0?void 0:r.body;return{text:d,html:h}},c1=(i,e,t,n,r)=>({description:t,timeout:i,live:e,[Ja.name]:r||Date.now(),[Cu.name]:{type:n??ll.Self}}),rw=i=>{var e,{description:t,timeout:n,live:r}=i,a=(e=Ja.findIn(i))!==null&&e!==void 0?e:void 0,o=Cu.findIn(i);return{description:t,timeout:n,live:r,assetType:o?.type,timestamp:a}},u1=(i,e,t,n)=>({[Ru.name]:{description:n,uri:i},[Ja.name]:e,"m.relates_to":{rel_type:Jk.name,event_id:t}}),kg=i=>{var e,t=Ru.findIn(i),n=(e=Ja.findIn(i))!==null&&e!==void 0?e:void 0;return{description:t?.description,uri:t?.uri,timestamp:n}};const d1=Object.freeze(Object.defineProperty({__proto__:null,getTextForLocationEvent:tw,makeBeaconContent:u1,makeBeaconInfoContent:c1,makeEmoteMessage:ew,makeHtmlEmote:Xk,makeHtmlMessage:Yk,makeHtmlNotice:$k,makeLocationContent:nw,makeNotice:Zk,makeTextMessage:Qk,makeTopicContent:iw,parseBeaconContent:kg,parseBeaconInfoContent:rw,parseLocationEvent:o1,parseTopicContent:l1},Symbol.toStringTag,{value:"Module"}));var It=(function(i){return i.New="Beacon.new",i.Update="Beacon.update",i.LivenessChange="Beacon.LivenessChange",i.Destroy="Beacon.Destroy",i.LocationUpdate="Beacon.LocationUpdate",i})({}),wg=(i,e,t)=>t>=i&&i+e>=t,Yh=i=>"".concat(i.getRoomId(),"_").concat(i.getStateKey());class aw extends Ot{constructor(e){super(),this.rootEvent=e,b(this,"roomId",void 0),b(this,"_beaconInfo",void 0),b(this,"_isLive",void 0),b(this,"livenessWatchTimeout",void 0),b(this,"_latestLocationEvent",void 0),b(this,"clearLatestLocation",()=>{this._latestLocationEvent=void 0,this.emit(It.LocationUpdate,this.latestLocationState)}),this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return Yh(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&kg(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(Yh(e)!==this.identifier)throw new Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(It.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(It.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),!!this.beaconInfo)if(this.isLive){var e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},this.beaconInfo.timestamp-Date.now()))}addLocations(e){var t;if(this.isLive){var n=e.filter(a=>{var o=a.getContent(),c=kg(o);if(!c.uri||!c.timestamp)return!1;var{timestamp:d}=c;return this._beaconInfo.timestamp&&wg(this._beaconInfo.timestamp,this._beaconInfo.timeout,d)&&(!this.latestLocationState||d>this.latestLocationState.timestamp)}),r=(t=n.sort(PD))===null||t===void 0?void 0:t[0];r&&(this._latestLocationEvent=r,this.emit(It.LocationUpdate,this.latestLocationState))}}setBeaconInfo(e){this._beaconInfo=rw(e.getContent()),this.checkLiveness()}checkLiveness(){var e=this.isLive;if(this.beaconInfo){var t=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!t&&wg(t,this._beaconInfo.timeout,Date.now()),e!==this.isLive&&this.emit(It.LivenessChange,this.isLive,this)}}}function U_(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function h1(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?U_(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):U_(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}function sw(i,e,t){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return new Sn({content:{[e.getId()]:{[t]:{[i]:h1({ts:e.getTs()},!n&&{thread_id:pl(e)})}}},type:G.Receipt,room_id:e.getRoomId()})}var xo=0,Lo=1;class ow extends Ot{constructor(){super(...arguments),b(this,"receipts",new Yr(()=>new Map)),b(this,"receiptCacheByEventId",new Map)}getReadReceiptForUserId(e){var t,n,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:On.Read,[o,c]=(t=(n=this.receipts.get(a))===null||n===void 0?void 0:n.get(e))!==null&&t!==void 0?t:[null,null];return r?o:c??o}compareReceipts(e,t){var n;return(n=this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId))!==null&&n!==void 0?n:e.data.ts-t.data.ts}getEventReadUpTo(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=this.getLatestReceipt(e,t);return n&&this.receiptPointsAtConsistentEvent(n)?n.eventId:null}receiptPointsAtConsistentEvent(e){var t,n=this.findEventById(e.eventId);if(!n)return!1;if(!((t=e.data)!==null&&t!==void 0&&t.thread_id))return!0;if(e.data.thread_id===ku){var r=vu(n);if(r)return!0}else if(n.threadRootId===e.data.thread_id)return!0;return D.warn("Ignoring receipt because its thread_id (".concat(e.data.thread_id,") disagrees ")+"with the thread root (".concat(n.threadRootId,") of the referenced event ")+"(event ID = ".concat(e.eventId,")")),!1}getLatestReceipt(e,t){var n,r,a=this.getReadReceiptForUserId(e,t,On.Read),o=this.getReadReceiptForUserId(e,t,On.ReadPrivate),c;return a!=null&&a.eventId&&o!==null&&o!==void 0&&o.eventId&&(c=this.compareReceipts(a,o)),c?(r=c<0?o:a)!==null&&r!==void 0?r:null:(n=o??a)!==null&&n!==void 0?n:null}addReceiptToStructure(e,t,n,r,a){var o,c,d=this.receipts.getOrCreate(t),h=d.get(n);h||(h=[null,null],d.set(n,h));var v=h[xo];if(a){var m;v=(m=h[Lo])!==null&&m!==void 0?m:h[xo]}var y={eventId:e,data:r};if(v){var E=this.compareReceipts(v,y);if(E>=0)return}var T=a?h[xo]:y,S=a?y:h[Lo],O=null;T&&S&&(O=this.getUnfilteredTimelineSet().compareEventOrdering(T.eventId,S.eventId));var R=O===null||O<0,I=(o=h[Lo])!==null&&o!==void 0?o:h[xo];a&&R?h[Lo]=y:a||(h[xo]=y,R||(h[Lo]=null));var M=(c=h[Lo])!==null&&c!==void 0?c:h[xo];if(I!==M){if(I&&this.receiptCacheByEventId.get(I.eventId)){var C=I.eventId;this.receiptCacheByEventId.set(C,this.receiptCacheByEventId.get(C).filter(k=>k.type!==t||k.userId!==n)),this.receiptCacheByEventId.get(C).length<1&&this.receiptCacheByEventId.delete(C)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:n,type:t,data:r})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){var t=this.getReadReceiptForUserId(e,!1),n=this.timeline[this.timeline.length-1];n&&t?.eventId===n.getId()&&e===n.getSender()&&(this.setUnread(it.Total,0),this.setUnread(it.Highlight,0))}addLocalEchoReceipt(e,t,n){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.addReceipt(sw(e,t,n,r),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter(function(t){return By(t.type)}).map(function(t){return t.userId})}}var f1=new Wn.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),v1=new Wn.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),m1=new Wn.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start"),su=new Wn.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),$h=new Wn.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end"),Pa=(function(i){return i.New="Poll.new",i.End="Poll.end",i.Update="Poll.update",i.Responses="Poll.Responses",i.Destroy="Poll.Destroy",i.UndecryptableRelations="Poll.UndecryptableRelations",i})({}),B_=(i,e)=>{var t=i.filter(n=>{if(!n.isDecryptionFailure())return su.matches(n.getType())&&n.getTs()<=e});return{responseEvents:t}};class lw extends Ot{constructor(e,t,n){if(super(),this.rootEvent=e,this.matrixClient=t,this.room=n,b(this,"roomId",void 0),b(this,"pollEvent",void 0),b(this,"_isFetchingResponses",!1),b(this,"relationsNextBatch",void 0),b(this,"responses",null),b(this,"endEvent",void 0),b(this,"undecryptableRelationEventIds",new Set),b(this,"countUndecryptableEvents",r=>{var a=r.filter(c=>c.isDecryptionFailure()).map(c=>c.getId()),o=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...a]),this.undecryptableRelationsCount!==o&&this.emit(Pa.UndecryptableRelations,this.undecryptableRelationsCount)}),!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw new Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return(e=this.endEvent)===null||e===void 0?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}getResponses(){var e=this;return A(function*(){return e.responses||e.isFetchingResponses||(yield e.fetchResponses()),e.responses})()}onNewRelation(e){var t;if($h.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit(Pa.End)),!!this.responses){var n=((t=this.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:r}=B_([e],n);this.countUndecryptableEvents([e]),r.length&&(r.forEach(a=>{this.responses.addEvent(a)}),this.emit(Pa.Responses,this.responses))}}fetchResponses(){var e=this;return A(function*(){var t,n;e._isFetchingResponses=!0;var r=yield e.matrixClient.relations(e.roomId,e.rootEvent.getId(),"m.reference",void 0,{from:e.relationsNextBatch||void 0});yield Promise.all(r.events.map(h=>e.matrixClient.decryptEventIfNeeded(h)));var a=e.responses||new Hy("m.reference",su.name,e.matrixClient,[su.altName]),o=r.events.find(h=>$h.matches(h.getType()));e.validateEndEvent(o)&&(e.endEvent=o,e.refilterResponsesOnEnd(),e.emit(Pa.End));var c=((t=e.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:d}=B_(r.events,c);d.forEach(h=>{a.addEvent(h)}),e.relationsNextBatch=(n=r.nextBatch)!==null&&n!==void 0?n:void 0,e.responses=a,e.countUndecryptableEvents(r.events),e.relationsNextBatch?e.fetchResponses():e._isFetchingResponses=!1,e.emit(Pa.Responses,e.responses)})()}refilterResponsesOnEnd(){var e;if(this.responses){var t=((e=this.endEvent)===null||e===void 0?void 0:e.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach(n=>{if(n.getTs()>t){var r;(r=this.responses)===null||r===void 0||r.removeEvent(n)}}),this.emit(Pa.Responses,this.responses)}}validateEndEvent(e){if(!e||this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;var t=this.room.currentState,n=e.getSender();return!!n&&(n===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,n))}}var cw=i=>{var e=i.getType();return Wn.M_POLL_START.matches(e)||su.matches(e)||$h.matches(e)};class p1{constructor(e){b(this,"room",void 0),b(this,"threadedReceipts",void 0),b(this,"unthreadedReceipts",void 0),b(this,"danglingReceipts",void 0),b(this,"onTimelineEvent",t=>{var n=t.getId();if(n){var r=this.danglingReceipts.remove(n);r?.forEach(a=>{a.receipt.thread_id?this.threadedReceipts.set(a.receipt.thread_id,a.eventId,a.receiptType,a.userId,a.receipt.ts,a.synthetic):this.unthreadedReceipts.set(n,a.receiptType,a.userId,a.receipt.ts,a.synthetic)})}}),this.room=e,this.threadedReceipts=new S1(e),this.unthreadedReceipts=new uw(e),this.danglingReceipts=new E1,e.on(ge.Timeline,this.onTimelineEvent)}add(e,t){for(var[n,r]of Object.entries(e))for(var[a,o]of Object.entries(r))for(var[c,d]of Object.entries(o)){var h=this.room.findEventById(n);h?d.thread_id?this.threadedReceipts.set(d.thread_id,n,a,c,d.ts,t):this.unthreadedReceipts.set(n,a,c,d.ts,t):this.danglingReceipts.add(new y1(n,a,c,d,t))}}hasUserReadEvent(e,t){var n=this.unthreadedReceipts.get(e);if(n&&Ig(n.eventId,t,this.room))return!0;var r=this.room.findEventById(t);if(!r)return D.warn("hasUserReadEvent event ID ".concat(t," not found in room ").concat(this.room.roomId,": this shouldn't happen!")),!1;var a=pl(r),o=this.threadedReceipts.get(a,e);return!!(o&&Ig(o.eventId,t,this.room)||this.userSentLatestEventInThread(a,e))}userSentLatestEventInThread(e,t){var n,r=e===ku?this.room.getLiveTimeline().getEvents():(n=this.room.getThread(e))===null||n===void 0?void 0:n.timeline;return!!(r&&r.length>0&&r[r.length-1].getSender()===t)}}class g1{constructor(e,t,n){this.eventId=e,this.receiptType=t,this.ts=n}}class y1{constructor(e,t,n,r,a){this.eventId=e,this.receiptType=t,this.userId=n,this.receipt=r,this.synthetic=a}}class b1{constructor(e){b(this,"room",void 0),b(this,"real",void 0),b(this,"synthetic",void 0),this.room=e,this.real=void 0,this.synthetic=void 0}set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&Ig(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){var e;return(e=this.synthetic)!==null&&e!==void 0?e:this.real}getByType(e){return e?this.synthetic:this.real}}class uw{constructor(e){b(this,"room",void 0),b(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,n,r,a){var o=Wy(this.data,n,()=>new b1(this.room)),c=o.getByType(a);c&&T1(c.eventId,e,this.room)||o.set(a,new g1(e,t,r))}get(e){var t;return(t=this.data.get(e))===null||t===void 0?void 0:t.get()}}class S1{constructor(e){b(this,"room",void 0),b(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,n,r,a,o){var c=Wy(this.data,e,()=>new uw(this.room));c.set(t,n,r,a,o)}get(e,t){var n;return(n=this.data.get(e))===null||n===void 0?void 0:n.get(t)}}class E1{constructor(){b(this,"data",new Map)}add(e){var t=Wy(this.data,e.eventId,()=>[]);t.push(e)}remove(e){var t=this.data.get(e);return this.data.delete(e),t}}function Wy(i,e,t){var n=i.get(e);if(n)return n;var r=t();return i.set(e,r),r}function Ig(i,e,t){var n=t.compareEventOrdering(i,e);return n!==null&&n>=0}function T1(i,e,t){var n=t.compareEventOrdering(i,e);return n!==null&&n>0}function _1(i,e,t){var n=i.findEventById(e),r=i.findEventById(t);if(!n||!r)return null;var a=vu(n),o=vu(r);return a&&o?C1(i,e,t,n,r):R1(e,t,n,r)}function C1(i,e,t,n,r){var a=i.getUnfilteredTimelineSet(),o=a.compareEventOrdering(e,t);if(o!==null)return o;var c=a.getTimelineForEvent(e);if(c===a.getLiveTimeline())return 1;var d=a.getTimelineForEvent(t);return d===a.getLiveTimeline()?-1:dw(n,r)}function R1(i,e,t,n){var r=pl(t),a=pl(n),o=t.getThread();return o&&r===a?o.timelineSet.compareEventOrdering(i,e):dw(t,n)}function dw(i,e){var t=i.getTs(),n=e.getTs();return t<n?-1:t>n?1:0}var $=(function(i){return i.Get="GET",i.Put="PUT",i.Post="POST",i.Delete="DELETE",i.Options="OPTIONS",i.Head="HEAD",i.Patch="PATCH",i})({});function F_(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function k1(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?F_(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):F_(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}class Fs extends Error{constructor(e,t,n){super(e),this.httpStatus=t,this.httpHeaders=n}isRateLimitError(){return this.httpStatus===429}getRetryAfterMs(){var e,t=(e=this.httpHeaders)===null||e===void 0?void 0:e.get("Retry-After");if(t!=null){if(/^\d+$/.test(t)){var n=Number.parseInt(t)*1e3;if(!Number.isFinite(n))throw new Error("Retry-After header integer value is too large");return n}var r=new Date(t);if(r.toUTCString()!==t)throw new Error("Retry-After header value is not a valid HTTP-date or non-negative decimal integer");return r.getTime()-Date.now()}return null}}class Ct extends Fs{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0,o=e.error||"Unknown message";t&&(o="[".concat(t,"] ").concat(o)),n&&(o="".concat(o," (").concat(n,")")),super("MatrixError: ".concat(o),t,a),this.url=n,this.event=r,b(this,"errcode",void 0),b(this,"error",void 0),b(this,"data",void 0),this.errcode=e.errcode,this.error=e.error,this.name=e.errcode||"Unknown error code",this.data=e}isRateLimitError(){return this.errcode==="M_LIMIT_EXCEEDED"||(this.errcode==="M_UNKNOWN"||this.errcode===void 0)&&super.isRateLimitError()}getRetryAfterMs(){var e=super.getRetryAfterMs();if(e!==null)return e;if(this.errcode==="M_LIMIT_EXCEEDED"&&"retry_after_ms"in this.data){if(!Number.isInteger(this.data.retry_after_ms))throw new Error("retry_after_ms is not an integer");return this.data.retry_after_ms}return null}asWidgetApiErrorData(){var e,t,n,r,a={};if(this.httpHeaders)for(var[o,c]of this.httpHeaders)a[o]=c;return{http_status:(e=this.httpStatus)!==null&&e!==void 0?e:400,http_headers:a,url:(t=this.url)!==null&&t!==void 0?t:"",response:k1({errcode:(n=this.errcode)!==null&&n!==void 0?n:"M_UNKNOWN",error:(r=this.data.error)!==null&&r!==void 0?r:"Unknown message"},this.data)}}static fromWidgetApiErrorData(e){return new Ct(e.response,e.http_status,e.url,void 0,new Headers(e.http_headers))}}function Jy(i,e){if(!(i instanceof Fs)||!i.isRateLimitError())return e;try{var t;return(t=i.getRetryAfterMs())!==null&&t!==void 0?t:e}catch{return e}}let Gs=class extends Error{constructor(e,t){super(e+(t?": ".concat(t.message):""))}get name(){return"ConnectionError"}};class hw extends Error{constructor(e){var t;super((t=e?.message)!==null&&t!==void 0?t:"")}get name(){return"TokenRefreshError"}}class Yy extends Error{constructor(e){var t;super((t=e?.message)!==null&&t!==void 0?t:"")}get name(){return"TokenRefreshLogoutError"}}var fw=new Sl(null,"ORG.MATRIX.MSC4387_SAFETY");class vw extends Ct{constructor(){super(...arguments),b(this,"harms",void 0),b(this,"expiry",void 0);var e=arguments.length<=0?void 0:arguments[0];this.harms=new Set(e&&"harms"in e&&Array.isArray(e.harms)?e.harms:[]),this.message="".concat(super.message," (").concat([...this.harms].join(", "),")"),e&&"expiry"in e&&typeof e.expiry=="number"&&(this.expiry=new Date(e.expiry))}}var Og=(function(i){return i.SessionLoggedOut="Session.logged_out",i.NoConsent="no_consent",i})({}),ah={};var j_;function w1(){if(j_)return ah;j_=1;var i=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,e=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,t=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,n=/\\([\u000b\u0020-\u00ff])/g,r=/([\\"])/g,a=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;ah.format=o,ah.parse=c;function o(m){if(!m||typeof m!="object")throw new TypeError("argument obj is required");var y=m.parameters,E=m.type;if(!E||!a.test(E))throw new TypeError("invalid type");var T=E;if(y&&typeof y=="object")for(var S,O=Object.keys(y).sort(),R=0;R<O.length;R++){if(S=O[R],!t.test(S))throw new TypeError("invalid parameter name");T+="; "+S+"="+h(y[S])}return T}function c(m){if(!m)throw new TypeError("argument string is required");var y=typeof m=="object"?d(m):m;if(typeof y!="string")throw new TypeError("argument string is required to be a string");var E=y.indexOf(";"),T=E!==-1?y.slice(0,E).trim():y.trim();if(!a.test(T))throw new TypeError("invalid media type");var S=new v(T.toLowerCase());if(E!==-1){var O,R,I;for(i.lastIndex=E;R=i.exec(y);){if(R.index!==E)throw new TypeError("invalid parameter format");E+=R[0].length,O=R[1].toLowerCase(),I=R[2],I.charCodeAt(0)===34&&(I=I.slice(1,-1),I.indexOf("\\")!==-1&&(I=I.replace(n,"$1"))),S.parameters[O]=I}if(E!==y.length)throw new TypeError("invalid parameter format")}return S}function d(m){var y;if(typeof m.getHeader=="function"?y=m.getHeader("content-type"):typeof m.headers=="object"&&(y=m.headers&&m.headers["content-type"]),typeof y!="string")throw new TypeError("content-type header is missing from object");return y}function h(m){var y=String(m);if(t.test(y))return y;if(y.length>0&&!e.test(y))throw new TypeError("invalid parameter value");return'"'+y.replace(r,"\\$1")+'"'}function v(m){this.parameters=Object.create(null),this.type=m}return ah}var I1=w1();function Mf(i){var e=new AbortController;return setTimeout(()=>{e.abort()},i),e.signal}function mw(i){var e=new AbortController;function t(){for(var a of i)a.removeEventListener("abort",n)}function n(){e.abort(),t()}for(var r of i){if(r.aborted){n();break}r.addEventListener("abort",n)}return{signal:e.signal,cleanup:t}}function $y(i,e){var t,n,r=Tp(i)?new Headers(i.getAllResponseHeaders().trim().split(/[\r\n]+/).map(c=>{var d=c.indexOf(":");return[c.substring(0,d),c.substring(d+1)]})):i.headers,a;try{a=O1(r)}catch(c){return c}if(((t=a)===null||t===void 0?void 0:t.type)==="application/json"&&e){var o=JSON.parse(e);return o.errcode&&fw.matches(o.errcode)?new vw(o,i.status,Tp(i)?i.responseURL:i.url,void 0,r):new Ct(o,i.status,Tp(i)?i.responseURL:i.url,void 0,r)}return((n=a)===null||n===void 0?void 0:n.type)==="text/plain"?new Fs("Server returned ".concat(i.status," error: ").concat(e),i.status,r):new Fs("Server returned ".concat(i.status," error"),i.status,r)}function Tp(i){return"getResponseHeader"in i}function O1(i){var e=i.get("Content-Type");if(e===null)return null;try{return I1.parse(e)}catch(t){throw new Error("Error parsing Content-Type '".concat(e,"': ").concat(t))}}function Mg(i,e){return Pg.apply(this,arguments)}function Pg(){return Pg=A(function*(i,e){for(var t=0,n=null;t<i;)try{if(t>0){var r=1e3*Math.pow(2,t);D.log("network operation failed ".concat(t," times, retrying in ").concat(r,"ms...")),yield Iu(r)}return yield e()}catch(a){if(a instanceof Gs)t+=1,n=a;else throw a}throw n}),Pg.apply(this,arguments)}function pw(i,e,t){return e>4||i instanceof Gs&&!t||i.httpStatus&&Math.floor(i.httpStatus/100)===4&&i.httpStatus!==429||i.name==="AbortError"||i.name==="M_TOO_LARGE"?-1:Jy(i,1e3*Math.pow(2,e))}var Aa=(function(i){return i.Success="success",i.Failure="failure",i.Logout="logout",i})({}),M1=500,P1=60*1e3;class A1{constructor(e){this.opts=e,b(this,"tokenRefreshPromise",void 0),b(this,"latestTokenRefreshExpiry",void 0)}prepareForRequest(){var e=this;return A(function*(){return yield e.refreshIfNeeded(),{accessToken:e.opts.accessToken,refreshToken:e.opts.refreshToken,expiry:e.latestTokenRefreshExpiry}})()}refreshIfNeeded(){var e=this;return A(function*(){if(e.tokenRefreshPromise)return e.tokenRefreshPromise;if(e.latestTokenRefreshExpiry){var t=e.latestTokenRefreshExpiry.getTime()-Date.now();t<=M1&&(yield e._handleUnknownToken())}})()}handleUnknownToken(e,t){var n=this;return A(function*(){return n._handleUnknownToken(e,t)})()}_handleUnknownToken(e,t){var n=this;return A(function*(){if(e!=null&&e.expiry){var r=e.expiry.getTime()-Date.now();if(r>=P1)return Aa.Logout}if(!e||e?.accessToken===n.opts.accessToken){var a;(a=n.tokenRefreshPromise)!==null&&a!==void 0||(n.tokenRefreshPromise=n.doTokenRefresh(t));try{return yield n.tokenRefreshPromise}finally{n.tokenRefreshPromise=void 0}}return Aa.Success})()}doTokenRefresh(e){var t=this;return A(function*(){if(!t.opts.refreshToken||!t.opts.tokenRefreshFunction){var n;return(n=t.opts.logger)===null||n===void 0||n.error("Unable to refresh token - no refresh token or refresh function"),Aa.Logout}e&&e>1&&(yield Iu(1e3*Math.min(32,2**e)));try{var r,a;(r=t.opts.logger)===null||r===void 0||r.debug("Attempting to refresh token");var{accessToken:o,refreshToken:c,expiry:d}=yield t.opts.tokenRefreshFunction(t.opts.refreshToken);return t.opts.accessToken=o,t.opts.refreshToken=c,t.latestTokenRefreshExpiry=d,(a=t.opts.logger)===null||a===void 0||a.debug("... token refresh complete, new token expiry:",d),Aa.Success}catch(m){var h;if(m instanceof Yy||m instanceof Ct){var v;return(v=t.opts.logger)===null||v===void 0||v.error("Failed to refresh token",m),Aa.Logout}return(h=t.opts.logger)===null||h===void 0||h.warn("Failed to refresh token",m),Aa.Failure}})()}}function q_(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function V_(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?q_(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):q_(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}class D1{constructor(e,t){var n;if(this.eventEmitter=e,this.opts=t,b(this,"abortController",new AbortController),b(this,"tokenRefresher",void 0),Ck(t,["baseUrl","prefix"]),!t.onlyData)throw new Error("Constructing FetchHttpApi without `onlyData=true` is no longer supported.");t.useAuthorizationHeader=(n=t.useAuthorizationHeader)!==null&&n!==void 0?n:!0,this.tokenRefresher=new A1(t)}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):globalThis.fetch(e,t)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,n,r,a){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");var o=void 0,c=void 0;e===$.Get?o=n:c=n;var d=this.getUrl(t,o,r,this.opts.idBaseUrl),h={json:!0,headers:{}};return a&&(h.headers.Authorization="Bearer ".concat(a)),this.requestOtherUrl(e,d,c,h)}authedRequest(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},r=arguments.length>3?arguments[3]:void 0,a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{};return this.doAuthedRequest(1,e,t,n,r,a)}doAuthedRequest(e,t,n,r,a){var o=arguments,c=this;return A(function*(){var d=o.length>5&&o[5]!==void 0?o[5]:{},h=wu(d);h.abortSignal=d.abortSignal;var v=yield c.tokenRefresher.prepareForRequest();v.accessToken&&(c.opts.useAuthorizationHeader?(h.headers||(h.headers={}),h.headers.Authorization||(h.headers.Authorization="Bearer ".concat(v.accessToken)),r.access_token&&delete r.access_token):r.access_token||(r.access_token=v.accessToken));try{var m=yield c.request(t,n,r,a,h);return m}catch(E){if(!(E instanceof Ct))throw E;if(E.errcode==="M_UNKNOWN_TOKEN"){var y=yield c.tokenRefresher.handleUnknownToken(v,e);if(y===Aa.Success)return c.doAuthedRequest(e+1,t,n,r,a,d);if(y===Aa.Failure)throw new hw(E);h!=null&&h.inhibitLogoutEmit||c.eventEmitter.emit(Og.SessionLoggedOut,E)}else E.errcode=="M_CONSENT_NOT_GIVEN"&&c.eventEmitter.emit(Og.NoConsent,E.message,E.data.consent_uri);throw E}})()}request(e,t,n,r,a){var o=this.getUrl(t,n,a?.prefix,a?.baseUrl);return this.requestOtherUrl(e,o,r,a)}requestOtherUrl(e,t,n){var r=arguments,a=this;return A(function*(){var o,c,d,h,v=r.length>3&&r[3]!==void 0?r[3]:{};if(v.json!==void 0&&v.rawResponseBody!==void 0)throw new Error("Invalid call to `FetchHttpApi` sets both `opts.json` and `opts.rawResponseBody`");var m=a.sanitizeUrlForLogs(t);(o=a.opts.logger)===null||o===void 0||o.debug("FetchHttpApi: --> ".concat(e," ").concat(m));var y=Object.assign({},v.headers||{}),E=!v.rawResponseBody&&v.json!==!1;E&&(y.Accept||(y.Accept="application/json"));var T=(c=v.localTimeoutMs)!==null&&c!==void 0?c:a.opts.localTimeoutMs,S=(d=v.keepAlive)!==null&&d!==void 0?d:!1,O=[a.abortController.signal];T!==void 0&&O.push(Mf(T)),v.abortSignal&&O.push(v.abortSignal);var R;v.json!==!1&&(n==null||(h=n.constructor)===null||h===void 0?void 0:h.name)===Object.name?(R=JSON.stringify(n),y["Content-Type"]||(y["Content-Type"]="application/json")):R=n;var{signal:I,cleanup:M}=mw(O),C="Authorization"in y?void 0:"no-cache",k,_=Date.now();try{var P;k=yield a.fetch(t,{signal:I,method:e,body:R,headers:y,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:C,credentials:"omit",keepalive:S,priority:v.priority}),(P=a.opts.logger)===null||P===void 0||P.debug("FetchHttpApi: <-- ".concat(e," ").concat(m," [").concat(Date.now()-_,"ms ").concat(k.status,"]"))}catch(U){var x;throw(x=a.opts.logger)===null||x===void 0||x.debug("FetchHttpApi: <-- ".concat(e," ").concat(m," [").concat(Date.now()-_,"ms ").concat(U,"]")),U.name==="AbortError"?U:new Gs("fetch failed",U)}finally{M()}if(!k.ok)throw $y(k,yield k.text());return v.rawResponseBody?yield k.blob():E?yield k.json():yield k.text()})()}sanitizeUrlForLogs(e){try{var t;typeof e=="string"?t=new URL(e):t=e;var n=new URLSearchParams;for(var r of t.searchParams.keys())n.append(r,"xxx");var a=n.toString(),o=a?"?".concat(a):"";return t.origin+t.pathname+o}catch{return"??"}}getUrl(e,t,n,r){var a=r??this.opts.baseUrl,o=a.endsWith("/")?a.slice(0,-1):a,c=new URL(o+(n??this.opts.prefix)+e);if(this.opts.extraParams||t){var d=V_(V_({},this.opts.extraParams),t);vg(d,c.searchParams)}return c}}var At=(function(i){return i.V1="/_matrix/client/v1",i.V3="/_matrix/client/v3",i.Unstable="/_matrix/client/unstable",i})({}),Nr=(function(i){return i.V2="/_matrix/identity/v2",i})({}),$o=(function(i){return i.V1="/_matrix/media/v1",i.V3="/_matrix/media/v3",i})({}),N1=1e3,x1=0,_p,zr=[],L1=function(){};function K_(i,e){for(var t=arguments.length,n=new Array(t>2?t-2:0),r=2;r<t;r++)n[r-2]=arguments[r];e=e||0,e<0&&(e=0);var a=Date.now()+e,o=x1++,c={runAt:a,func:i,params:n,key:o},d=B1(zr,function(h){return h.runAt-a});return zr.splice(d,0,c),Xy(),o}function H_(i){if(zr.length!==0){var e;for(e=0;e<zr.length;e++){var t=zr[e];if(t.key==i){zr.splice(e,1);break}}e===0&&Xy()}}function Xy(){_p&&globalThis.clearTimeout(_p);var i=zr[0];if(i){var e=Date.now(),t=Math.min(i.runAt-e,N1);_p=globalThis.setTimeout(U1,t)}}function U1(){for(var i=Date.now(),e=[];;){var t=zr[0];if(!t||t.runAt>i)break;var n=zr.shift();L1("runCallbacks: popping",n.key),e.push(n)}Xy();for(var r of e)try{r.func.apply(globalThis,r.params)}catch(a){D.error("Uncaught exception in callback function",a)}}function B1(i,e){for(var t=0,n=i.length;t<n;){var r=t+n>>1,a=e(i[r]);a>0?n=r:t=r+1}return t}class gw extends D1{constructor(){super(...arguments),b(this,"uploads",[])}uploadContent(e){var t,n,r,a,o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},c=(t=o.includeFilename)!==null&&t!==void 0?t:!0,d=(n=o.abortController)!==null&&n!==void 0?n:new AbortController,h=((r=o.type)!==null&&r!==void 0?r:e.type)||"application/octet-stream",v=(a=o.name)!==null&&a!==void 0?a:e.name,m={loaded:0,total:0,abortController:d},y=Promise.withResolvers();if(globalThis.XMLHttpRequest){var E=new globalThis.XMLHttpRequest,T=function(){E.abort(),y.reject(new Error("Timeout"))},S=K_(T,3e4);E.onreadystatechange=function(){switch(E.readyState){case globalThis.XMLHttpRequest.DONE:H_(S);try{if(E.status===0)throw new DOMException(E.statusText,"AbortError");if(!E.responseText)throw new Error("No response body.");E.status>=400?y.reject($y(E,E.responseText)):y.resolve(JSON.parse(E.responseText))}catch(M){if(M.name==="AbortError"){y.reject(M);return}y.reject(new Gs("request failed",M))}break}},E.upload.onprogress=M=>{var C;H_(S),m.loaded=M.loaded,m.total=M.total,S=K_(T,3e4),(C=o.progressHandler)===null||C===void 0||C.call(o,{loaded:M.loaded,total:M.total})};var O=this.getUrl("/upload",void 0,$o.V3);c&&v&&O.searchParams.set("filename",encodeURIComponent(v)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&O.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),E.open($.Post,O.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&E.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),E.setRequestHeader("Content-Type",h),E.send(e),d.signal.addEventListener("abort",()=>{E.abort()})}else{var R={};c&&v&&(R.filename=v);var I={"Content-Type":h};this.authedRequest($.Post,"/upload",R,e,{prefix:$o.V3,headers:I,abortSignal:d.signal}).then(y.resolve,y.reject)}return m.promise=y.promise.finally(()=>{Kh(this.uploads,M=>M===m)}),d.signal.addEventListener("abort",()=>{Kh(this.uploads,M=>M===m),y.reject(new DOMException("Aborted","AbortError"))}),this.uploads.push(m),m.promise}cancelUpload(e){var t=this.uploads.find(n=>n.promise===e);return t?(t.abortController.abort(),!0):!1}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:$o.V3+"/upload",params:{access_token:this.opts.accessToken}}}}var F1=360*60*1e3,j1=30*1e3,yw=(function(i){return i.Stable="stable",i.Unstable="unstable",i})({});class bw{constructor(e,t){var n=this;this.logger=e,this.http=t,b(this,"capabilities",void 0),b(this,"retryTimeout",void 0),b(this,"refreshTimeout",void 0),b(this,"fetchCapabilities",A(function*(){var r=yield n.http.authedRequest($.Get,"/capabilities");return n.capabilities=r.capabilities,n.capabilities})),b(this,"poll",A(function*(){try{yield n.fetchCapabilities(),n.clearTimeouts(),n.refreshTimeout=setTimeout(n.poll,F1),n.logger.debug("Fetched new server capabilities")}catch(a){n.clearTimeouts();var r=Math.floor(j1+Math.random()*5e3);n.retryTimeout=setTimeout(n.poll,r),n.logger.warn("Failed to refresh capabilities: retrying in ".concat(r,"ms"),a)}}))}start(){this.poll().then()}stop(){this.clearTimeouts()}getCachedCapabilities(){return this.capabilities}clearTimeouts(){this.refreshTimeout&&(clearInterval(this.refreshTimeout),this.refreshTimeout=void 0),this.retryTimeout&&(clearTimeout(this.retryTimeout),this.retryTimeout=void 0)}}var Mc=D.getChild("RoomStickyEvents"),Na=(function(i){return i.Update="RoomStickyEvents.Update",i})({});function Cp(i){if(typeof i!="string")throw new Error("Not a string");if(!i.startsWith("@"))throw new Error("Not a userId")}class Ms extends Ot{constructor(){super(...arguments),b(this,"stickyEventsMap",new Map),b(this,"unkeyedStickyEvents",new Set),b(this,"stickyEventTimer",void 0),b(this,"nextStickyEventExpiryTs",Number.MAX_SAFE_INTEGER),b(this,"cleanExpiredStickyEvents",()=>{var e=Date.now(),t=[];this.nextStickyEventExpiryTs=Number.MAX_SAFE_INTEGER;for(var[n,r]of this.stickyEventsMap.entries()){var a;for(var[o,[c,...d]]of r)e>=c.unstableStickyExpiresAt?(Mc.debug("Expiring sticky event",c.getId()),t.push(c),this.stickyEventsMap.get(n).delete(o)):(this.stickyEventsMap.get(n).set(o,[c,...d.filter(v=>v.unstableStickyExpiresAt<=e)]),this.nextStickyEventExpiryTs=Math.min(this.nextStickyEventExpiryTs,c.unstableStickyExpiresAt));((a=this.stickyEventsMap.get(n))===null||a===void 0?void 0:a.size)===0&&this.stickyEventsMap.delete(n)}for(var h of this.unkeyedStickyEvents)e>=h.unstableStickyExpiresAt?(Mc.debug("Expiring sticky event",h.getId()),this.unkeyedStickyEvents.delete(h),t.push(h)):this.nextStickyEventExpiryTs=Math.min(this.nextStickyEventExpiryTs,h.unstableStickyExpiresAt);t.length&&this.emit(Na.Update,[],[],t),this.scheduleStickyTimer()})}static sortStickyEvent(e,t){var n,r;if(t.getTs()!==e.getTs())return t.getTs()-e.getTs();if(((n=t.getId())!==null&&n!==void 0?n:"")>((r=e.getId())!==null&&r!==void 0?r:""))return 1;throw Error("Comparing two sticky events with the same event ID is not allowed.")}static stickyMapKey(e,t){return"".concat(e).concat(t)}*getStickyEvents(){yield*this.unkeyedStickyEvents;for(var e of this.stickyEventsMap.values())for(var t of e.values())yield t[0]}getKeyedStickyEvent(e,t,n){var r;return Cp(e),(r=this.stickyEventsMap.get(t))===null||r===void 0||(r=r.get(Ms.stickyMapKey(n,e)))===null||r===void 0?void 0:r[0]}getUnkeyedStickyEvent(e,t){return[...this.unkeyedStickyEvents].filter(n=>n.getType()===t&&n.getSender()===e)}addStickyEvent(e){var t,n,r,a=e.getContent().msc4354_sticky_key;if(typeof a!="string"&&a!==void 0)throw new Error("".concat(e.getId()," is missing msc4354_sticky_key"));if(e.unstableStickyExpiresAt===void 0)throw new Error("".concat(e.getId()," is missing msc4354_sticky.duration_ms"));var o=e.getSender(),c=e.getType();if(Cp(o),e.unstableStickyExpiresAt<=Date.now())return Mc.info("ignored sticky event with older expiration time than current time",a),{added:!1};if(!o.startsWith("@"))throw new Error("Expected sender to start with @");var d=e;if(a===void 0)return this.unkeyedStickyEvents.add(d),this.nextStickyEventExpiryTs=Math.min(e.unstableStickyExpiresAt,this.nextStickyEventExpiryTs),this.scheduleStickyTimer(),{added:!0};var h=Ms.stickyMapKey(a,o),v=[d,...(t=(n=this.stickyEventsMap.get(c))===null||n===void 0?void 0:n.get(h))!==null&&t!==void 0?t:[]].sort(Ms.sortStickyEvent);return this.stickyEventsMap.has(c)||this.stickyEventsMap.set(c,new Map),(r=this.stickyEventsMap.get(c))===null||r===void 0||r.set(h,v),this.nextStickyEventExpiryTs=Math.min(d.unstableStickyExpiresAt,this.nextStickyEventExpiryTs),this.scheduleStickyTimer(),{added:v[0]===d,prevEvent:v?.[1]}}addStickyEvents(e){var t=[],n=[];for(var r of e)try{var a=this.addStickyEvent(r);a.added&&(a.prevEvent?n.push({current:r,previous:a.prevEvent}):t.push(r))}catch(o){Mc.warn("ignored invalid sticky event",o)}(t.length||n.length)&&this.emit(Na.Update,t,n,[]),this.scheduleStickyTimer()}scheduleStickyTimer(){this.stickyEventTimer&&(clearTimeout(this.stickyEventTimer),this.stickyEventTimer=void 0),this.nextStickyEventExpiryTs!==Number.MAX_SAFE_INTEGER&&(this.stickyEventTimer=setTimeout(this.cleanExpiredStickyEvents,this.nextStickyEventExpiryTs-Date.now()))}handleRedaction(e){var t=typeof e=="string"?e:e.getId();for(var n of this.unkeyedStickyEvents)if(n.getId()===t){this.unkeyedStickyEvents.delete(n),this.emit(Na.Update,[],[],[n]);return}if(typeof e!="string"&&!e.isRedacted()){var r,a,o=e.getContent().msc4354_sticky_key;if(typeof o!="string"&&o!==void 0)return;var c=e.getType(),d=e.getSender();Cp(d);var h=this.stickyEventsMap.get(c);if(!h)return;var v=Ms.stickyMapKey(o,d),[m,...y]=(r=h.get(v))!==null&&r!==void 0?r:[];if(!m)return;Mc.debug("Redaction for ".concat(t," under sticky key ").concat(o));var E=y.filter(O=>!O.isRedacted()).sort(Ms.sortStickyEvent);(a=this.stickyEventsMap.get(c))===null||a===void 0||a.set(v,E),E.length?this.emit(Na.Update,[],[{previous:m,current:E[0]}],[]):(h.delete(v),h.size===0&&this.stickyEventsMap.delete(c),this.emit(Na.Update,[],[],[m]));return}for(var T of this.stickyEventsMap.values())for(var[S]of T.values())if(S.getId()===t)return this.handleRedaction(S)}clear(){this.stickyEventsMap.clear(),this.nextStickyEventExpiryTs=Number.MAX_SAFE_INTEGER,this.scheduleStickyTimer()}}function G_(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function Pc(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?G_(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):G_(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}var Sw="10",q1=["1","2","3","4","5","6","7","8","9","10"],V1=30,it=(function(i){return i.Highlight="highlight",i.Total="total",i})({}),ge=(function(i){return i.MyMembership="Room.myMembership",i.Tags="Room.tags",i.AccountData="Room.accountData",i.Receipt="Room.receipt",i.Name="Room.name",i.Redaction="Room.redaction",i.RedactionCancelled="Room.redactionCancelled",i.LocalEchoUpdated="Room.localEchoUpdated",i.Timeline="Room.timeline",i.TimelineReset="Room.timelineReset",i.TimelineRefresh="Room.TimelineRefresh",i.OldStateUpdated="Room.OldStateUpdated",i.CurrentStateUpdated="Room.CurrentStateUpdated",i.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",i.UnreadNotifications="Room.UnreadNotifications",i.Summary="Room.Summary",i})({});let Pf=class extends ow{constructor(e,t,n){var r,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};super(),r=this,this.roomId=e,this.client=t,this.myUserId=n,this.opts=a,b(this,"reEmitter",void 0),b(this,"txnToEvent",new Map),b(this,"notificationCounts",{}),b(this,"bumpStamp",void 0),b(this,"threadNotifications",new Map),b(this,"cachedThreadReadReceipts",new Map),b(this,"oldestThreadedReceiptTs",1/0),b(this,"unthreadedReceipts",new Map),b(this,"timelineSets",void 0),b(this,"polls",new Map),b(this,"threadsTimelineSets",[]),b(this,"filteredTimelineSets",{}),b(this,"timelineNeedsRefresh",!1),b(this,"pendingEventList",void 0),b(this,"blacklistUnverifiedDevices",void 0),b(this,"selfMembership",void 0),b(this,"heroes",null),b(this,"getTypeWarning",!1),b(this,"membersPromise",void 0),b(this,"name",void 0),b(this,"normalizedName",void 0),b(this,"tags",{}),b(this,"accountData",new Map),b(this,"summary",null),b(this,"oldState",void 0),b(this,"currentState",void 0),b(this,"relations",void 0),b(this,"threads",new Map),b(this,"visibilityEvents",new Map),b(this,"roomReceipts",new p1(this)),b(this,"stickyEvents",new Ms),b(this,"threadTimelineSetsPromise",null),b(this,"threadsReady",!1),b(this,"updateThreadRootEvents",(o,c,d)=>{if(o.length){var h;if(this.updateThreadRootEvent((h=this.threadsTimelineSets)===null||h===void 0?void 0:h[0],o,c,d),o.hasCurrentUserParticipated){var v;this.updateThreadRootEvent((v=this.threadsTimelineSets)===null||v===void 0?void 0:v[1],o,c,d)}}}),b(this,"updateThreadRootEvent",(o,c,d,h)=>{o&&c.rootEvent&&(h&&o.removeEvent(c.id),_t.hasServerSideSupport?o.addLiveEvent(c.rootEvent,{duplicateStrategy:zc.Replace,fromCache:!1,roomState:this.currentState,addToState:!1}):o.addEventToTimeline(c.rootEvent,o.getLiveTimeline(),{toStartOfTimeline:d,addToState:!1}))}),b(this,"tryApplyRedaction",o=>{if(o.isRedaction()){var c=o.event.redacts,d=c?this.findEventById(c):void 0;if(c)try{this.stickyEvents.handleRedaction(d||c)}catch(T){D.error("Failed to handle redaction for sticky event",T)}d&&this.applyEventAsRedaction(o,d)}else if(o.getType()===G.RoomMember){var h=o.getContent().membership;if(h!==Ne.Ban&&!(h===Ne.Leave&&o.getStateKey()!==o.getSender()))return;var v=o.getContent()["org.matrix.msc4293.redact_events"];if(v!==!0)return;var m=this.getLiveTimeline().getState(Be.Forward);if(!m.maySendRedactionForEvent(o,o.getSender()))return;var y=this.getTimelineSets().map(T=>T.getTimelines()).reduce((T,S)=>(T.push(...S),T),[]).map(T=>T.getEvents().filter(S=>S.getSender()===o.getStateKey())).reduce((T,S)=>(T.push(...S),S),[]);for(var E of y)this.applyEventAsRedaction(o,E)}}),this.setMaxListeners(100),this.reEmitter=new Cl(this),a.pendingEventOrdering=a.pendingEventOrdering||ml.Chronological,this.name=e,this.normalizedName=e,this.relations=new Gk(this.client,this),this.on(ge.Receipt,this.onReceipt),this.reEmitter.reEmit(this.stickyEvents,[Na.Update]),this.timelineSets=[new Ho(this,a)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[ge.Timeline,ge.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===ml.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then(o=>{var c=this.client.getEventMapper({decrypt:!1});o.forEach((function(){var d=A(function*(h){var v=c(h);yield t.decryptEventIfNeeded(v),v.setStatus(Ie.NOT_SENT),r.addPendingEvent(v,v.getTxnId())});return function(h){return d.apply(this,arguments)}})())})),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}createThreadsTimelineSets(){var e=this;return A(function*(){var t;if(e.threadTimelineSetsPromise)return e.threadTimelineSetsPromise;if((t=e.client)!==null&&t!==void 0&&t.supportsThreads())try{e.threadTimelineSetsPromise=Promise.all([e.createThreadTimelineSet(),e.createThreadTimelineSet(Ui.My)]);var n=yield e.threadTimelineSetsPromise;return e.threadsTimelineSets[0]=n[0],e.threadsTimelineSets[1]=n[1],n}catch{return e.threadTimelineSetsPromise=null,null}return null})()}decryptCriticalEvents(){var e=this;return A(function*(){if(e.client.getCrypto()){var t=e.getEventReadUpTo(e.client.getUserId(),!0),n=e.getLiveTimeline().getEvents(),r=n.findIndex(o=>o.event.event_id===t),a=n.slice(r).reverse().map(o=>e.client.decryptEventIfNeeded(o));yield Promise.allSettled(a)}})()}decryptAllEvents(){var e=this;return A(function*(){if(e.client.getCrypto()){var t=e.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map(n=>e.client.decryptEventIfNeeded(n));yield Promise.allSettled(t)}})()}getCreator(){var e,t=this.currentState.getStateEvents(G.RoomCreate,"");return(e=t?.getSender())!==null&&e!==void 0?e:null}getVersion(){return this.currentState.getRoomVersion()}getRecommendedVersion(){var e=this;return A(function*(){var t={};try{t=yield e.client.getCapabilities()}catch{}var n=t["m.room_versions"];if(!n){n={default:Sw,available:{}};for(var r of q1)n.available[r]=yw.Stable}var a=e.checkVersionAgainstCapability(n);if(a.urgent&&a.needsUpgrade){D.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");try{t=yield e.client.fetchCapabilities()}catch(o){D.warn("Failed to refresh room version capabilities",o)}if(n=t["m.room_versions"],n)a=e.checkVersionAgainstCapability(n);else return D.warn("No room version capability - assuming upgrade required."),a}return a})()}checkVersionAgainstCapability(e){var t=this.getVersion();D.log("[".concat(this.roomId,"] Current version: ").concat(t)),D.log("[".concat(this.roomId,"] Version capability: "),e);var n={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return n;var r=Object.keys(e.available).filter(a=>e.available[a]==="stable");return r.includes(t)||(n.version=e.default,n.needsUpgrade=!0,n.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),n.urgent?D.warn("URGENT upgrade required on ".concat(this.roomId)):D.warn("Non-urgent upgrade required on ".concat(this.roomId))),n}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(G.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);var t=Kh(this.pendingEventList,function(n){return n.getId()==e},!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,n;return(t=(n=this.pendingEventList)===null||n===void 0?void 0:n.some(r=>r.getId()===e))!==null&&t!==void 0?t:!1}getPendingEvent(e){var t,n;return(t=(n=this.pendingEventList)===null||n===void 0?void 0:n.find(r=>r.getId()===e))!==null&&t!==void 0?t:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}get timeline(){return this.getLiveTimeline().getEvents()}getLastActiveTimestamp(){var e=this.getLiveTimeline(),t=e.getEvents();if(t.length){var n=t[t.length-1];return n.getTs()}else return Number.MIN_SAFE_INTEGER}getLastLiveEvent(){var e,t,n=this.getLiveTimeline().getEvents(),r=n[n.length-1],a=this.getLastThread();if(!a)return r;var o=a.events[a.events.length-1];return((e=r?.getTs())!==null&&e!==void 0?e:0)>((t=o?.getTs())!==null&&t!==void 0?t:0)?r:o}getLastThread(){return this.getThreads().reduce((e,t)=>{var n,r;if(!e)return t;var a=t.events[t.events.length-1],o=e.events[e.events.length-1];return((n=a?.getTs())!==null&&n!==void 0?n:0)>=((r=o?.getTs())!==null&&r!==void 0?r:0)?t:e},void 0)}getMyMembership(){var e;return(e=this.selfMembership)!==null&&e!==void 0?e:Ne.Leave}getDMInviter(){var e=this.getMember(this.myUserId);if(e)return e.getDMInviter();if(this.selfMembership===Ne.Invite){var t=this.getInvitedAndJoinedMemberCount();if(t===2){var n;return(n=this.heroes)===null||n===void 0||(n=n[0])===null||n===void 0?void 0:n.userId}}}guessDMUserId(){var e=this.getMember(this.myUserId);if(e){var t=e.getDMInviter();if(t)return t}if(Array.isArray(this.heroes)&&this.heroes.length)return this.heroes[0].userId;var n=this.currentState.getMembers(),r=n.find(a=>a.userId!==this.myUserId);return r?r.userId:this.myUserId}getFunctionalMembers(){var e=this.currentState.getStateEvents(Nk.name,"");return Array.isArray(e?.getContent().service_members)?e.getContent().service_members:[]}getAvatarFallbackMember(){var e,t=this.getFunctionalMembers(),n=0;if(this.getMembers().forEach(S=>{S.membership!=="join"&&S.membership!=="invite"||t.includes(S.userId)||n++}),!(n>2)){var r=(e=this.heroes)===null||e===void 0?void 0:e.filter(S=>!t.includes(S.userId)),a=Array.isArray(r)&&r.length;if(a){for(var o of r)if(o.fromMSC4186){var d=new ru(this.roomId,o.userId);return d.setMembershipEvent(new Sn({event_id:"$"+this.roomId+o.userId+new Date().getTime(),type:G.RoomMember,state_key:o.userId,content:{displayname:o.displayName,avatar_url:o.avatarUrl}})),d}else{var c=this.getMember(o.userId);if(c)return c}var h=r.map(S=>this.getMember(S.userId)).find(S=>!!S);if(h)return h}var v=this.getMembers(),m=v?.filter(S=>!t.includes(S.userId));if(m.length<=2){var y=m.find(S=>S.userId!==this.myUserId);if(y)return y}if(a){var E=r.map(S=>this.client.getUser(S.userId)).find(S=>!!S);if(E){var T=new ru(this.roomId,E.userId);return T.user=E,T}}}}updateMyMembership(e){var t=this.selfMembership;this.selfMembership=e,t!==e&&(e===Ne.Leave&&this.cleanupAfterLeaving(),this.emit(ge.MyMembership,this,e,t))}loadMembersFromServer(){var e=this;return A(function*(){var t=e.client.store.getSyncToken(),n=yield e.client.members(e.roomId,void 0,Ne.Leave,t??void 0);return n.chunk})()}loadMembers(){var e=this;return A(function*(){var t=!1,n=yield e.client.store.getOutOfBandMembers(e.roomId);(n===null||e.hasEncryptionStateEvent())&&(t=!0,n=yield e.loadMembersFromServer(),D.log("LL: got ".concat(n.length," ")+"members from server for room ".concat(e.roomId)));var r=n.filter(ji).map(e.client.getEventMapper());return{memberEvents:r,fromServer:t}})()}membersLoaded(){return this.opts.lazyLoadMembers?this.currentState.outOfBandMembersReady():!0}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();var e=this.loadMembers().then(t=>(this.currentState.setOutOfBandMembers(t.memberEvents),this.recalculate(),t.fromServer)).catch(t=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),t});return e.then(t=>{if(t){var n=this.currentState.getMembers().filter(a=>a.isOutOfBand()).map(a=>{var o;return(o=a.events.member)===null||o===void 0?void 0:o.event});D.log("LL: telling store to write ".concat(n.length)+" members for room ".concat(this.roomId));var r=this.client.store;return r.setOutOfBandMembers(this.roomId,n).catch(a=>{D.log("LL: storing OOB room members failed, oh well",a)})}}).catch(t=>{D.error(t)}),this.membersPromise=e,this.membersPromise}clearLoadedMembersIfNeeded(){var e=this;return A(function*(){e.opts.lazyLoadMembers&&e.membersPromise&&(yield e.loadMembersIfNeeded(),yield e.client.store.clearOutOfBandMembers(e.roomId),e.currentState.clearOutOfBandMembers(),e.membersPromise=void 0)})()}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(e=>{D.error("error after clearing loaded members from "+"room ".concat(this.roomId," after leaving")),D.log(e)})}refreshLiveTimeline(){var e=this;return A(function*(){var t=e.getLiveTimeline(),n=t.getPaginationToken(me.FORWARDS),r=t.getPaginationToken(me.BACKWARDS),a=t.getEvents(),o=a[a.length-1];D.log("[refreshLiveTimeline for ".concat(e.roomId,"] at ")+"mostRecentEventInTimeline=".concat(o&&o.getId()," ")+"liveTimelineBefore=".concat(t.toString()," ")+"forwardPaginationToken=".concat(n," ")+"backwardPaginationToken=".concat(r));var c=e.getUnfilteredTimelineSet(),d=null;o?(e.resetLiveTimeline(null,null),e.emit(ge.TimelineRefresh,e,c),d=yield e.client.getEventTimeline(c,o.getId())):d=yield e.client.getLatestTimeline(c);var h=c.getLiveTimeline();!h||h.getPaginationToken(Be.Forward)===null&&h.getPaginationToken(Be.Backward)===null&&h.getEvents().length===0?(D.log("[refreshLiveTimeline for ".concat(e.roomId,"] using our new live timeline")),d.setPaginationToken(n,me.FORWARDS),c.setLiveTimeline(d),e.fixUpLegacyTimelineFields()):D.log("[refreshLiveTimeline for ".concat(e.roomId,"] `/sync` or some other request beat us to creating a new ")+"live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history."),e.setTimelineNeedsRefresh(!1),e.emit(ge.TimelineRefresh,e,c)})()}resetLiveTimeline(e,t){for(var n of this.timelineSets)n.resetLiveTimeline(e??void 0,t??void 0);for(var r of this.threads.values())r.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){var e=this.oldState,t=this.currentState;this.oldState=this.getLiveTimeline().getState(me.BACKWARDS),this.currentState=this.getLiveTimeline().getState(me.FORWARDS),e!==this.oldState&&this.emit(ge.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit(ge.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[Ke.Events,Ke.Members,Ke.NewMember,Ke.Update,Ke.Marker,It.New,It.Update,It.Destroy,It.LivenessChange]),this.reEmitter.reEmit(this.currentState,[Ke.Events,Ke.Members,Ke.NewMember,Ke.Update,Ke.Marker,It.New,It.Update,It.Destroy,It.LivenessChange]))}onReceipt(e){this.hasEncryptionStateEvent()&&this.clearNotificationsOnReceipt(e)}clearNotificationsOnReceipt(e){var t=[],n=!1,r=e.getContent();for(var a of Object.values(r))for(var[o,c]of Object.entries(a))if(By(o)&&c){for(var[d,h]of Object.entries(c))if(!(!h||typeof h!="object")){var v=h;d===this.client.getUserId()&&(v.thread_id===void 0?n=!0:typeof v.thread_id=="string"&&t.push(v.thread_id))}}n&&(t=this.getThreads().filter(k=>this.getThreadUnreadNotificationCount(k.id,it.Total)>0||this.getThreadUnreadNotificationCount(k.id,it.Highlight)>0).map(k=>k.id),t.push("main"));for(var m of t){var y,E=20,T=m==="main"?this.getLiveTimeline():(y=this.getThread(m))===null||y===void 0?void 0:y.liveTimeline;if(!T){D.warn("Couldn't find timeline for thread ID ".concat(m," in room ").concat(this.roomId));continue}for(var S=T.getEvents(),O=0,R=S.length-1;R>=0;R--){var I;if(R===S.length-E)return;var M=S[R];if(this.hasUserReadEvent(this.client.getUserId(),M.getId()))break;var C=this.client.getPushActionsForEvent(M);O+=C!=null&&(I=C.tweaks)!==null&&I!==void 0&&I.highlight?1:0}m==="main"?this.setUnreadNotificationCount(it.Highlight,O):this.setThreadUnreadNotificationCount(m,it.Highlight,O)}}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){var t=this.findEventById(e),n=this.findThreadForEvent(t);return n?n.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){var t=this.getUnfilteredTimelineSet().findEventById(e);if(!t)for(var n=this.getThreads(),r=0;r<n.length;r++){var a=n[r];if(t=a.findEventById(e),t)return t}return t}getUnreadNotificationCount(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:it.Total,t=this.getRoomUnreadNotificationCount(e);for(var n of this.threadNotifications.values()){var r;t+=(r=n[e])!==null&&r!==void 0?r:0}return t}getUnreadCountForEventContext(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:it.Total,n=arguments.length>1?arguments[1]:void 0,r=!!n.threadRootId&&!n.isThreadRoot;return(e=r?this.getThreadUnreadNotificationCount(n.threadRootId,t):this.getRoomUnreadNotificationCount(t))!==null&&e!==void 0?e:0}getRoomUnreadNotificationCount(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:it.Total;return(e=this.notificationCounts[t])!==null&&e!==void 0?e:0}getThreadUnreadNotificationCount(e){var t,n,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:it.Total;return(t=(n=this.threadNotifications.get(e))===null||n===void 0?void 0:n[r])!==null&&t!==void 0?t:0}hasThreadUnreadNotification(){for(var e of this.threadNotifications.values()){var t,n;if(((t=e.highlight)!==null&&t!==void 0?t:0)>0||((n=e.total)!==null&&n!==void 0?n:0)>0)return!0}return!1}setThreadUnreadNotificationCount(e,t,n){var r,a,o=Pc({highlight:(r=this.threadNotifications.get(e))===null||r===void 0?void 0:r.highlight,total:(a=this.threadNotifications.get(e))===null||a===void 0?void 0:a.total},{[t]:n});this.threadNotifications.set(e,o),this.emit(ge.UnreadNotifications,o,e)}get threadsAggregateNotificationType(){var e=null;for(var t of this.threadNotifications.values()){var n,r;if(((n=t.highlight)!==null&&n!==void 0?n:0)>0)return it.Highlight;((r=t.total)!==null&&r!==void 0?r:0)>0&&!e&&(e=it.Total)}return e}resetThreadUnreadNotificationCountFromSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],t=this.hasEncryptionStateEvent();for(var[n,r]of this.threadNotifications)e.includes(n)||(r.total=0,t||(r.highlight=0));this.emit(ge.UnreadNotifications)}setBumpStamp(e){this.bumpStamp=e}getBumpStamp(){return this.bumpStamp}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit(ge.UnreadNotifications,this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){var t,n=(t=e["m.heroes"])===null||t===void 0?void 0:t.map(o=>({userId:o,fromMSC4186:!1})),r=e["m.joined_member_count"],a=e["m.invited_member_count"];Number.isInteger(r)&&this.currentState.setJoinedMemberCount(r),Number.isInteger(a)&&this.currentState.setInvitedMemberCount(a),Array.isArray(n)&&(this.heroes=n.filter(o=>o.userId!=this.myUserId)),this.emit(ge.Summary,e)}setMSC4186SummaryData(e,t,n){e&&(this.heroes=e.filter(r=>r.user_id!==this.myUserId).map(r=>({userId:r.user_id,displayName:r.displayname,avatarUrl:r.avatar_url,fromMSC4186:!0}))),t!==void 0&&Number.isInteger(t)&&this.currentState.setJoinedMemberCount(t),n!==void 0&&Number.isInteger(n)&&this.currentState.setInvitedMemberCount(n),this.emit(ge.Summary,{"m.heroes":this.heroes?this.heroes.map(r=>r.userId):[],"m.joined_member_count":t,"m.invited_member_count":n})}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return this.blacklistUnverifiedDevices===void 0?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,n,r){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,o=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,c=this.getMxcAvatarUrl();return!c&&!a?null:c?wf(e,c,t,n,r,void 0,void 0,o):null}getMxcAvatarUrl(){var e,t=(e=this.currentState.getStateEvents(G.RoomAvatar,""))===null||e===void 0?void 0:e.getContent().url;return t&&typeof t=="string"?t:null}getCanonicalAlias(){var e,t=(e=this.currentState.getStateEvents(G.RoomCanonicalAlias,""))===null||e===void 0?void 0:e.getContent().alias;return t&&typeof t=="string"?t:null}getAltAliases(){var e,t=(e=this.currentState.getStateEvents(G.RoomCanonicalAlias,""))===null||e===void 0?void 0:e.getContent().alt_aliases;return Array.isArray(t)?t.filter(n=>typeof n=="string"):[]}addEventsToTimeline(e,t,n,r,a){r.getTimelineSet().addEventsToTimeline(e,t,n,r,a)}getThread(e){var t;return(t=this.threads.get(e))!==null&&t!==void 0?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership(Ne.Join)}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter(function(t){return t.membership===e})}getEncryptionTargetMembers(){var e=this;return A(function*(){yield e.loadMembersIfNeeded();var t=e.getMembersWithMembership(Ne.Join);return e.shouldEncryptForInvitedMembers()&&(t=t.concat(e.getMembersWithMembership(Ne.Invite))),t})()}shouldEncryptForInvitedMembers(){var e,t=this.currentState.getStateEvents(G.RoomHistoryVisibility,"");return(t==null||(e=t.getContent())===null||e===void 0?void 0:e.history_visibility)!=="joined"}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){var n=this.getMember(e);return n?n.membership===t:!1}getOrCreateFilteredTimelineSet(e){var{prepopulateTimeline:t=!0,useSyncEvents:n=!0,pendingEvents:r=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];var a=Object.assign({filter:e,pendingEvents:r},this.opts),o=new Ho(this,a);this.reEmitter.reEmit(o,[ge.Timeline,ge.TimelineReset]),n&&(this.filteredTimelineSets[e.filterId]=o,this.timelineSets.push(o));var c=this.getLiveTimeline();if(t){c.getEvents().forEach(function(v){o.addLiveEvent(v,{addToState:!1})});for(var d=c;d.getNeighbouringTimeline(me.BACKWARDS);)d=d.getNeighbouringTimeline(me.BACKWARDS);o.getLiveTimeline().setPaginationToken(d.getPaginationToken(me.BACKWARDS),me.BACKWARDS)}else if(n){var h=c.getPaginationToken(Be.Forward);o.getLiveTimeline().setPaginationToken(h,Be.Backward)}return o}getThreadListFilter(){var e=arguments,t=this;return A(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:Ui.All,r=t.client.getUserId(),a=new di(r),o={room:{timeline:{[el.name]:[mt.name]}}};n===Ui.My&&(o.room.timeline[Zo.name]=[r]),a.setDefinition(o);var c=yield t.client.getOrCreateFilter("THREAD_PANEL_".concat(t.roomId,"_").concat(n),a);return a.filterId=c,a})()}createThreadTimelineSet(e){var t=this;return A(function*(){var n;if(_t.hasServerSideListSupport)n=new Ho(t,Pc(Pc({},t.opts),{},{pendingEvents:!1}),void 0,void 0,e??Ui.All),t.reEmitter.reEmit(n,[ge.Timeline,ge.TimelineReset]);else if(_t.hasServerSideSupport){var r=yield t.getThreadListFilter(e);n=t.getOrCreateFilteredTimelineSet(r,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else n=new Ho(t,{pendingEvents:!1}),Array.from(t.threads).forEach(a=>{var[,o]=a;if(o.length!==0){var c=o.timeline.some(d=>d.getSender()===t.client.getUserId());(e!==Ui.My||c)&&n.getLiveTimeline().addEvent(o.rootEvent,{toStartOfTimeline:!1,addToState:!1})}});return n})()}processThreadRoots(e,t){if(this.client.supportsThreads())for(var n of e)me.setEventMetadata(n,this.currentState,t),this.getThread(n.getId())||this.createThread(n.getId(),n,[],t)}fetchRoomThreads(){var e=this;return A(function*(){if(!(e.threadsReady||!e.client.supportsThreads())){if(_t.hasServerSideListSupport)yield Promise.all([e.fetchRoomThreadList(Ui.All),e.fetchRoomThreadList(Ui.My)]);else{var t=yield e.getThreadListFilter(),{chunk:n}=yield e.client.createMessagesRequest(e.roomId,"",Number.MAX_SAFE_INTEGER,Be.Backward,t);if(!n.length)return;var r=n.map(e.client.getEventMapper()).sort((y,E)=>{var T=y.getServerAggregatedRelation(mt.name),S=E.getServerAggregatedRelation(mt.name);return T.latest_event.origin_server_ts-S.latest_event.origin_server_ts}),a,o=e.getLiveTimeline().getState(me.FORWARDS);for(var c of r){var d,h={duplicateStrategy:zc.Ignore,fromCache:!1,addToState:!1,roomState:o};(d=e.threadsTimelineSets[0])===null||d===void 0||d.addLiveEvent(c,h);var v=c.getServerAggregatedRelation(mt.name);if(v!=null&&v.current_user_participated){var m;(m=e.threadsTimelineSets[1])===null||m===void 0||m.addLiveEvent(c,h),a=c}}e.processThreadRoots(r,!0),e.client.decryptEventIfNeeded(r[r.length-1]),a&&e.client.decryptEventIfNeeded(a)}e.on(Mn.NewReply,e.onThreadReply),e.on(Mn.Update,e.onThreadUpdate),e.on(Mn.Delete,e.onThreadDelete),e.threadsReady=!0}})()}processPollEvents(e){var t=this;return A(function*(){for(var n of e)try{if(!n.isEncrypted()&&!cw(n))continue;yield t.client.decryptEventIfNeeded(n),t.processPollEvent(n)}catch(r){D.warn("Error processing poll event",n.getId(),r)}})()}processPollEvent(e){var t=this;return A(function*(){if(e.isDecryptionFailure()){e.once(ot.Decrypted,o=>{t.processPollEvent(o)});return}if(Wn.M_POLL_START.matches(e.getType())){try{var n=new lw(e,t.client,t);t.polls.set(e.getId(),n),t.emit(Pa.New,n),e.once(ot.BeforeRedaction,o=>{t.polls.delete(o.getId())})}catch{}return}var r=e.relationEventId;if(r&&t.polls.has(r)){var a=t.polls.get(r);a?.onNewRelation(e)}})()}fetchRoomThreadList(e){var t=this;return A(function*(){if(t.client.supportsThreads()&&t.threadsTimelineSets.length!==0){var n=e===Ui.My?t.threadsTimelineSets[1]:t.threadsTimelineSets[0],{chunk:r,end:a}=yield t.client.createThreadListMessagesRequest(t.roomId,null,void 0,Be.Backward,n.threadListType,n.getFilter());if(n.getLiveTimeline().setPaginationToken(a??null,Be.Backward),!!r.length){var o=r.map(t.client.getEventMapper());t.processThreadRoots(o,!0);var c=t.getLiveTimeline().getState(me.FORWARDS);for(var d of o)n.addLiveEvent(d,{duplicateStrategy:zc.Replace,fromCache:!1,roomState:c,addToState:!1})}}})()}onThreadUpdate(e){this.updateThreadRootEvents(e,!1,!1)}onThreadReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){var t;this.threads.delete(e.id);var n=this.getTimelineForEvent(e.id),r=n==null||(t=n.getEvents())===null||t===void 0?void 0:t.find(o=>o.getId()===e.id);r?e.clearEventMetadata(r):D.debug("onThreadDelete: Could not find root event in room timeline");for(var a of this.threadsTimelineSets)a.removeEvent(e.id)}removeFilteredTimelineSet(e){var t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];var n=this.timelineSets.indexOf(t);n>-1&&this.timelineSets.splice(n,1)}eventShouldLiveIn(e,t,n){var r;if(!((r=this.client)!==null&&r!==void 0&&r.supportsThreads()))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||n!=null&&n.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};var a=e.isRelation(mt.name),o=e.getAssociatedId(),c=e.threadRootId;if(o&&!a&&(c===o||n!=null&&n.has(o)))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};var d;if(o){var h;d=(h=this.findEventById(o))!==null&&h!==void 0?h:t?.find(v=>v.getId()===o)}return d&&!a?this.eventShouldLiveIn(d,t,n):c!=null?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:c}:!o||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;var{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,r=this.getThread(e);if(r)r.addEvents(t,n);else{var a,o=(a=this.findEventById(e))!==null&&a!==void 0?a:t.find(c=>c.getId()===e);this.createThread(e,o,t,n)}}processThreadedEvents(e,t){e.forEach(this.tryApplyRedaction);var n={};for(var r of e){var a,{threadId:o,shouldLiveInThread:c}=this.eventShouldLiveIn(r);c&&!n[o]&&(n[o]=[]),(a=n[o])===null||a===void 0||a.push(r)}Object.entries(n).map(d=>{var[h,v]=d;return this.addThreadedEvents(h,v,t)})}createThread(e,t){var n,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],a=arguments.length>3?arguments[3]:void 0;if(this.threads.has(e))return this.threads.get(e);if(t){var o=this.relations.getAllChildEventsForEvent(t.getId());o!=null&&o.length&&(r=r.concat(o.filter(d=>!d.isRelation(Et.Replace))))}var c=new _t(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:(n=this.cachedThreadReadReceipts.get(e))!==null&&n!==void 0?n:[]});return this.reEmitter.reEmit(c,[Mn.Delete,Mn.Update,Mn.NewReply,ge.Timeline,ge.TimelineReset]),this.cachedThreadReadReceipts.delete(e),this.threads.set(c.id,c),c.addEvents(r,!1),this.threadsReady&&c.initialEventsFetched&&this.updateThreadRootEvents(c,a,!1),this.emit(Mn.New,c,a),c}applyEventAsRedaction(e,t){var n=t.threadRootId;if(t.makeRedacted(e,this),t.isState()){var r=this.currentState.getStateEvents(t.getType(),t.getStateKey());r?.getId()===t.getId()&&this.currentState.setStateEvents([t])}this.emit(ge.Redaction,e,this,n),this.visibilityEvents.delete(t.getId()),t.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}processLiveEvent(e){this.tryApplyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e);var t=e.getUnsigned().transaction_id;if(!t&&e.getSender()===this.myUserId){for(var[n,r]of this.txnToEvent)if(r.getId()===e.getId()){D.debug("processLiveEvent: found sent event without txn ID: ",n,e.getId());var a=e.getUnsigned();a.transaction_id=n,e.setUnsigned(a);break}}}addLiveEvent(e,t){var{duplicateStrategy:n,timelineWasEmpty:r,fromCache:a,addToState:o}=t;for(var c of this.timelineSets)c.addLiveEvent(e,{duplicateStrategy:n,fromCache:a,timelineWasEmpty:r,addToState:o});e.sender&&e.getType()!==G.RoomRedaction&&this.addReceipt(sw(e.sender.userId,e,On.Read),!0)}addPendingEvent(e,t){if(e.status!==Ie.SENDING&&e.status!==Ie.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw new Error("addPendingEvent called on an event with known txnId "+t);if(me.setEventMetadata(e,this.getLiveTimeline().getState(me.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some(o=>o.status===Ie.NOT_SENT)&&(D.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(Ie.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){var n=e.event.redacts,r=this.pendingEventList.find(o=>o.getId()===n);!r&&n&&(r=this.findEventById(n)),r&&(r.markLocallyRedacted(e),this.emit(ge.Redaction,e,this,r.threadRootId))}}else for(var a of this.timelineSets)a.getFilter()?a.getFilter().filterRoomTimeline([e]).length&&a.addEventToTimeline(e,a.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1}):a.addEventToTimeline(e,a.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1});this.emit(ge.LocalEchoUpdated,e,this)}savePendingEvents(){if(this.pendingEventList){var e=this.pendingEventList.map(t=>Pc(Pc({},t.event),{},{txn_id:t.getTxnId()})).filter(t=>{var n=t.type===G.RoomMessageEncrypted,r=this.hasEncryptionStateEvent();return n||!r});this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){var n=t.getId(),r=e.getId(),a=t.status;D.debug("Got remote echo for event ".concat(n," -> ").concat(r," old status ").concat(a)),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(n),t.handleRemoteEcho(e.event);var{shouldLiveInRoom:o,threadId:c}=this.eventShouldLiveIn(e),d=c?this.getThread(c):null;if(d?.setEventMetadata(t),d?.timelineSet.handleRemoteEcho(t,n,r),o)for(var h of this.timelineSets)h.handleRemoteEcho(t,n,r);this.emit(ge.LocalEchoUpdated,t,this,n,a)}updatePendingEvent(e,t,n){if(D.log("setting pendingEvent status to ".concat(t," in ").concat(e.getRoomId()," ")+"event ID ".concat(e.getId()," -> ").concat(n)),t==Ie.SENT&&!n)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==Ie.SENT){var r=this.getTimelineForEvent(n);if(r){var a=this.findEventById(n),o=a?.getUnsigned().transaction_id;if(!o&&a){var c=a.getUnsigned();c.transaction_id=e.getTxnId(),a.setUnsigned(c),this.removeEvent(a.getId()),this.handleRemoteEcho(a,e)}return}}var d=e.status,h=e.getId();if(!d)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");var v=K1[d];if(!(v!=null&&v.includes(t)))throw new Error("Invalid EventStatus transition ".concat(d,"->").concat(t));if(e.setStatus(t),t==Ie.SENT){e.replaceLocalEventId(n);var{shouldLiveInRoom:m,threadId:y}=this.eventShouldLiveIn(e),E=y?this.getThread(y):void 0;if(E?.setEventMetadata(e),E?.timelineSet.replaceEventId(h,n),m)for(var T of this.timelineSets)T.replaceEventId(h,n)}else if(t==Ie.CANCELLED){if(this.pendingEventList){var S=this.getPendingEvent(h);this.removePendingEvent(h),S!=null&&S.isRedaction()&&this.revertRedactionLocalEcho(S)}this.removeEvent(h)}this.savePendingEvents(),this.emit(ge.LocalEchoUpdated,e,this,h,d)}revertRedactionLocalEcho(e){var t=e.event.redacts;if(t){var n=this.getUnfilteredTimelineSet().findEventById(t);n&&(n.unmarkLocallyRedacted(),this.emit(ge.RedactionCancelled,e,this),n.isRelation()&&this.aggregateNonLiveRelation(n))}}assertTimelineSetsAreLive(){for(var e=0;e<this.timelineSets.length;e++){var t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(me.FORWARDS))throw new Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(me.FORWARDS)+")");if(t.getNeighbouringTimeline(me.FORWARDS))throw new Error("live timeline ".concat(e," is no longer live - it has a neighbouring timeline"))}}addLiveEvents(e,t){var n=this;return A(function*(){var{duplicateStrategy:r,fromCache:a,timelineWasEmpty:o=!1,addToState:c}=t;if(r&&["replace","ignore"].indexOf(r)===-1)throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");n.assertTimelineSetsAreLive();var d=n.findThreadRoots(e),h={},v={duplicateStrategy:r,fromCache:a,timelineWasEmpty:o,addToState:c},m=[...e];for(var y of e){var E;if(n.processLiveEvent(y),y.getUnsigned().transaction_id){var T=n.txnToEvent.get(y.getUnsigned().transaction_id);if(T){n.handleRemoteEcho(y,T);continue}}var{shouldLiveInRoom:S,shouldLiveInThread:O,threadId:R=""}=n.eventShouldLiveIn(y,m,d);if(!O&&!S&&y.isRelation())try{var I=new Sn(yield n.client.fetchRoomEvent(n.roomId,y.relationEventId));if(m.push(I),I.threadRootId){d.add(I.threadRootId);var M=y.getUnsigned();M[Wh.name]=I.threadRootId,y.setUnsigned(M)}({shouldLiveInRoom:S,shouldLiveInThread:O,threadId:R=""}=n.eventShouldLiveIn(y,m,d))}catch(C){D.error("Failed to load parent event of unhandled relation",C)}O&&!h[R]&&(h[R]=[]),(E=h[R])===null||E===void 0||E.push(y),S?n.addLiveEvent(y,v):!O&&y.isRelation()&&n.relations.aggregateChildEvent(y)}Object.entries(h).forEach(C=>{var[k,_]=C;n.addThreadedEvents(k,_,!1)})})()}partitionThreadedEvents(e){var t=0,n=1,r=2;if(this.client.supportsThreads()){var a=this.findThreadRoots(e);return e.reduce((o,c)=>{var{shouldLiveInRoom:d,shouldLiveInThread:h,threadId:v}=this.eventShouldLiveIn(c,e,a);return d&&o[t].push(c),h&&(c.setThreadId(v??""),o[n].push(c)),!h&&!d&&o[r].push(c),o},[[],[],[]])}else return[e,[],[]]}findThreadRoots(e){var t=new Set;for(var n of e){var r=n.threadRootId;r!=null&&t.add(r)}return t}addReceipt(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=e.getContent();this.roomReceipts.add(n,t),Object.keys(n).forEach(r=>{Object.keys(n[r]).forEach(a=>{Object.keys(n[r][a]).forEach(o=>{var c,d,h,v=n[r][a][o],m=!v.thread_id||v.thread_id===ku,y=m?this:this.threads.get((c=v.thread_id)!==null&&c!==void 0?c:"");if(y){if(y.addReceiptToStructure(r,a,o,v,t),!t&&this.client.isInitialSyncComplete()&&o===this.client.getUserId()){var E=y.timeline[y.timeline.length-1];E&&r===E.getId()&&o===E.getSender()&&(y.setUnread(it.Total,0),y.setUnread(it.Highlight,0))}}else{var T;this.cachedThreadReadReceipts.set(v.thread_id,[...(T=this.cachedThreadReadReceipts.get(v.thread_id))!==null&&T!==void 0?T:[],{eventId:r,receiptType:a,userId:o,receipt:v,synthetic:t}])}var S=this.client.getUserId();o===S&&!m&&v.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=v.ts),!v.thread_id&&v.ts>((d=(h=this.unthreadedReceipts.get(o))===null||h===void 0?void 0:h.ts)!==null&&d!==void 0?d:0)&&this.unthreadedReceipts.set(o,v)})})}),this.emit(ge.Receipt,e,this)}addEphemeralEvents(e){for(var t of e)t.getType()===G.Typing?this.currentState.setTypingEvent(t):t.getType()===G.Receipt&&this.addReceipt(t)}removeEvents(e){for(var t of e)this.removeEvent(t)}removeEvent(e){var t=!1;for(var n of this.timelineSets){var r=n.removeEvent(e);r&&(r.isRedaction()&&this.revertRedactionLocalEcho(r),t=!0)}return t}recalculate(){var e=this.currentState.getStateEvents(G.RoomMember,this.myUserId);if(e){var t=e.getContent().membership;if(this.updateMyMembership(t),t===Ne.Invite){var n=e.getUnsigned().invite_room_state||[];n.forEach(a=>{var o=this.currentState.getStateEvents(a.type,a.state_key);o||this.currentState.setStateEvents([new Sn({type:a.type,state_key:a.state_key,content:a.content,event_id:"$fake"+Date.now(),room_id:this.roomId,sender:this.myUserId})])})}}var r=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=kD(this.name),this.summary=new zk(this.roomId,{title:this.name}),r!==this.name&&this.emit(ge.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit(ge.Tags,e,this)}addAccountData(e){for(var t of e){t.getType()==="m.tag"&&this.addTags(t);var n=t.getType(),r=this.accountData.get(n);this.accountData.set(n,t),this.emit(ge.AccountData,t,this,r)}}getAccountData(e){return this.accountData.get(e)}_unstable_getStickyEvents(){return this.stickyEvents.getStickyEvents()}_unstable_getKeyedStickyEvent(e,t,n){return this.stickyEvents.getKeyedStickyEvent(e,t,n)}_unstable_getUnkeyedStickyEvent(e,t){return this.stickyEvents.getUnkeyedStickyEvent(e,t)}_unstable_addStickyEvents(e){return this.stickyEvents.addStickyEvents(e)}maySendMessage(){return this.getMyMembership()===Ne.Join&&(this.hasEncryptionStateEvent()?this.currentState.maySendEvent(G.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(G.RoomMessage,this.myUserId))}canInvite(e){var t=this.getMyMembership()===Ne.Join,n=this.currentState.getStateEvents(G.RoomPowerLevels,""),r=n&&n.getContent(),a=this.getMember(e);return r&&a&&r.invite>a.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){var e=this.currentState.getStateEvents(G.RoomCreate,"");if(!e){this.getTypeWarning||(D.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0);return}return e.getContent()[zh]}isSpaceRoom(){return this.getType()===Yo.Space}isCallRoom(){return this.getType()===Yo.UnstableCall}isElementVideoRoom(){return this.getType()===Yo.ElementVideo}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.getLiveTimeline().getState(me.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){var t=this.client.roomNameGenerator(this.roomId,e);if(t!==null)return t}switch(e.type){case er.Actual:return e.name;case er.Generated:return e.subtype==="Inviting"?"Inviting ".concat(z_(e.names,e.count)):z_(e.names,e.count);case er.EmptyRoom:return e.oldName?"Empty room (was ".concat(e.oldName,")"):"Empty room"}}calculateRoomName(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!t){var n,r=(n=this.currentState.getStateEvents(G.RoomName,""))===null||n===void 0?void 0:n.getContent().name;if(r&&typeof r=="string")return this.roomNameGenerator({type:er.Actual,name:r})}var a=this.getCanonicalAlias();if(a)return this.roomNameGenerator({type:er.Actual,name:a});var o=this.currentState.getJoinedMemberCount(),c=this.currentState.getInvitedMemberCount(),d=o+c-1,h=this.getFunctionalMembers(),v=[];if(this.heroes)this.heroes.forEach(I=>{if(h.includes(I.userId)){d--;return}if(I.displayName)v.push(I.displayName);else{var M=this.getMember(I.userId);v.push(M?M.name:I.userId)}});else{var m=this.currentState.getMembers().filter(I=>I.userId!==e&&(I.membership===Ne.Invite||I.membership===Ne.Join));m=m.filter(I=>{var{userId:M}=I;return h.includes(M)?(d--,!1):!0});var y=new Intl.Collator;m.sort((I,M)=>y.compare(I.userId,M.userId)),m=m.slice(0,5),v=m.map(I=>I.name)}if(d)return this.roomNameGenerator({type:er.Generated,names:v,count:d});var E=this.getMyMembership();if(E==Ne.Join){var T=this.currentState.getStateEvents(G.RoomThirdPartyInvite);if(T!=null&&T.length){var S=T.map(I=>I.getContent().display_name);return this.roomNameGenerator({type:er.Generated,subtype:"Inviting",names:S,count:S.length+1})}}var O=v;O.length||(O=this.currentState.getMembers().filter(I=>I.userId!==e&&I.membership!==Ne.Invite&&I.membership!==Ne.Join).map(I=>I.name));var R;return O.length&&(R=this.roomNameGenerator({type:er.Generated,names:O,count:O.length+1})),this.roomNameGenerator({type:er.EmptyRoom,oldName:R})}applyNewVisibilityEvent(e){var t=e.asVisibilityChange();if(t){var n=e.getSender();if(n){var r=As.name&&this.currentState.maySendStateEvent(As.name,n)||As.altName&&this.currentState.maySendStateEvent(As.altName,n);if(r){var a=this.visibilityEvents.get(t.eventId);if(a){for(var o=a.length-1,c=Math.max(0,a.length-V1);o>=c;--o){var d=a[o];if(d.getTs()<e.getTs())break}o===-1?a.unshift(e):a.splice(o+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);var h=this.findEventById(t.eventId);h&&h.applyVisibilityEvent(t)}}}}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");var t=e.getRelation(),n=t?.event_id,r=this.visibilityEvents.get(n);if(r){var a=r.findIndex(h=>h.getId()===e.getId());if(a!==-1&&(r.splice(a,1),a===r.length)){var o=this.findEventById(n);if(!o)return;if(a===0)this.visibilityEvents.delete(n),o.applyVisibilityEvent();else{var c=r[r.length-1],d=c.asVisibilityChange();if(!d)throw new Error("at this stage, visibility changes should be well-formed");o.applyVisibilityEvent(d)}}}}applyPendingVisibilityEvents(e){var t=this.visibilityEvents.get(e.getId());if(!(!t||t.length==0)){var n=t[t.length-1],r=n.asVisibilityChange();r&&(r.visible,!(n.getTs()<e.getTs())&&e.applyVisibilityEvent(r))}}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){super.fixupNotifications(e);var t=this.getThreads().filter(r=>this.getThreadUnreadNotificationCount(r.id,it.Total)>0);for(var n of t)n.fixupNotifications(e)}compareEventOrdering(e,t){return _1(this,e,t)}hasEncryptionStateEvent(){var e;return!!(!((e=this.getLiveTimeline().getState(me.FORWARDS))===null||e===void 0)&&e.getStateEvents(G.RoomEncryption,""))}};var K1={[Ie.ENCRYPTING]:[Ie.SENDING,Ie.NOT_SENT,Ie.CANCELLED],[Ie.SENDING]:[Ie.ENCRYPTING,Ie.QUEUED,Ie.NOT_SENT,Ie.SENT],[Ie.QUEUED]:[Ie.SENDING,Ie.NOT_SENT,Ie.CANCELLED],[Ie.SENT]:[],[Ie.NOT_SENT]:[Ie.SENDING,Ie.QUEUED,Ie.CANCELLED],[Ie.CANCELLED]:[]},er=(function(i){return i[i.EmptyRoom=0]="EmptyRoom",i[i.Generated=1]="Generated",i[i.Actual=2]="Actual",i})({});function z_(i,e){var t=e-1;if(i.length){if(i.length===1&&t<=1)return i[0];if(i.length===2&&t<=2)return"".concat(i[0]," and ").concat(i[1]);var n=t>1;return n?"".concat(i[0]," and ").concat(t," others"):"".concat(i[0]," and 1 other")}else return"Empty room"}var tn=(function(i){return i[i.Stable=0]="Stable",i[i.Unstable=1]="Unstable",i[i.Unsupported=2]="Unsupported",i})({}),nn=(function(i){return i.Thread="Thread",i.ThreadUnreadNotifications="ThreadUnreadNotifications",i.LoginTokenRequest="LoginTokenRequest",i.RelationBasedRedactions="RelationBasedRedactions",i.AccountDataDeletion="AccountDataDeletion",i.RelationsRecursion="RelationsRecursion",i.IntentionalMentions="IntentionalMentions",i})({}),H1={[nn.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[nn.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[nn.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[nn.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[nn.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]},[nn.RelationsRecursion]:{unstablePrefixes:["org.matrix.msc3981"],matrixVersion:"v1.10"},[nn.IntentionalMentions]:{unstablePrefixes:["org.matrix.msc3952_intentional_mentions"],matrixVersion:"v1.7"}};function G1(i){return Ag.apply(this,arguments)}function Ag(){return Ag=A(function*(i){var e=new Map;for(var[t,n]of Object.entries(H1)){var r,a,o,c,d=(r=(a=i.versions)===null||a===void 0?void 0:a.includes(n.matrixVersion||""))!==null&&r!==void 0?r:!1,h=(o=(c=n.unstablePrefixes)===null||c===void 0?void 0:c.every(v=>{var m;return((m=i.unstable_features)===null||m===void 0?void 0:m[v])===!0}))!==null&&o!==void 0?o:!1;d?e.set(t,tn.Stable):h?e.set(t,tn.Unstable):e.set(t,tn.Unsupported)}return e}),Ag.apply(this,arguments)}function W_(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function Xh(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?W_(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):W_(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}var J_=80*1e3,z1=3,ct=(function(i){return i.Error="ERROR",i.Prepared="PREPARED",i.Stopped="STOPPED",i.Syncing="SYNCING",i.Catchup="CATCHUP",i.Reconnecting="RECONNECTING",i})({}),W1=["org.matrix.msc2716v3"];function Y_(i,e){return"FILTER_SYNC_".concat(i)+(e?"_"+e:"")}var Ew=(function(i){return i.Offline="offline",i.Online="online",i.Unavailable="unavailable",i})({});function Tw(i){return Xh({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:30*1e3,pendingEventOrdering:ml.Chronological,threadSupport:!1},i)}function _w(i){return Xh({canResetEntireTimeline:e=>!1},i)}class La{constructor(e,t,n){var r=this;this.client=e,b(this,"opts",void 0),b(this,"syncOpts",void 0),b(this,"_peekRoom",null),b(this,"currentSyncRequest",void 0),b(this,"abortController",void 0),b(this,"syncState",null),b(this,"syncStateData",void 0),b(this,"catchingUp",!1),b(this,"running",!1),b(this,"keepAliveTimer",void 0),b(this,"connectionReturnedResolvers",void 0),b(this,"notifEvents",[]),b(this,"failedSyncCount",0),b(this,"storeIsInvalid",!1),b(this,"presence",void 0),b(this,"getPushRules",A(function*(){try{r.syncOpts.logger.debug("Getting push rules...");var a=yield r.client.getPushRules();r.syncOpts.logger.debug("Got push rules"),r.client.pushRules=a}catch(o){return r.syncOpts.logger.error("Getting push rules failed",o),r.shouldAbortSync(o)?void 0:(r.syncOpts.logger.debug("Waiting for saved sync before retrying push rules..."),yield r.recoverFromSyncStartupError(r.savedSyncPromise,o),r.getPushRules())}})),b(this,"buildDefaultFilter",()=>{var a=new di(this.client.credentials.userId);return this.client.canSupport.get(nn.ThreadUnreadNotifications)!==tn.Unsupported&&a.setUnreadThreadNotifications(!0),a}),b(this,"prepareLazyLoadingForSync",A(function*(){r.syncOpts.logger.debug("Prepare lazy loading for sync..."),r.client.isGuest()&&(r.opts.lazyLoadMembers=!1),r.opts.lazyLoadMembers&&(r.syncOpts.logger.debug("Enabling lazy load on sync filter..."),r.opts.filter||(r.opts.filter=r.buildDefaultFilter()),r.opts.filter.setLazyLoadMembers(!0))})),b(this,"storeClientOptions",A(function*(){try{r.syncOpts.logger.debug("Storing client options..."),yield r.client.storeClientOptions(),r.syncOpts.logger.debug("Stored client options")}catch(a){throw r.syncOpts.logger.error("Storing client options failed",a),a}})),b(this,"getFilter",A(function*(){r.syncOpts.logger.debug("Getting filter...");var a;r.opts.filter?a=r.opts.filter:a=r.buildDefaultFilter();var o;try{o=yield r.client.getOrCreateFilter(Y_(r.client.credentials.userId),a)}catch(c){return r.syncOpts.logger.error("Getting filter failed",c),r.shouldAbortSync(c)?{}:(r.syncOpts.logger.debug("Waiting for saved sync before retrying filter..."),yield r.recoverFromSyncStartupError(r.savedSyncPromise,c),r.getFilter())}return{filter:a,filterId:o}})),b(this,"savedSyncPromise",void 0),b(this,"onOnline",()=>{this.syncOpts.logger.debug("Browser thinks we are back online"),this.startKeepAlives(0)}),this.opts=Tw(t),this.syncOpts=_w(n),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[ge.Timeline,ge.TimelineReset])}createRoom(e){var t=Cw(this.client,e,this.opts);return t.on(Ke.Marker,(n,r)=>{this.onMarkerStateEvent(t,n,r)}),t}onMarkerStateEvent(e,t){var{timelineWasEmpty:n}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(n){this.syncOpts.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," ")+"because the timeline was empty before the marker arrived which means there is nothing to refresh.");return}var r=W1.includes(e.getVersion())||t.getSender()===e.getCreator();r?(this.syncOpts.logger.debug("MarkerState: Timeline needs to be refreshed because "+"a new markerEventId=".concat(t.getId()," was sent in roomId=").concat(e.roomId)),e.setTimelineNeedsRefresh(!0),e.emit(ge.HistoryImportedWithinTimeline,t,e)):this.syncOpts.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," because ")+"MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.")}syncLeftRooms(){var e=this;return A(function*(){var t,n=e.client,r=new di(e.client.credentials.userId);r.setTimelineLimit(1),r.setIncludeLeaveRooms(!0);var a=e.opts.pollTimeout+J_,o=yield n.getOrCreateFilter(Y_(n.credentials.userId,"LEFT_ROOMS"),r),c={timeout:0,filter:o,"org.matrix.msc4222.use_state_after":!0},d=yield n.http.authedRequest($.Get,"/sync",c,void 0,{localTimeoutMs:a}),h=[];(t=d.rooms)!==null&&t!==void 0&&t.leave&&(h=e.mapSyncResponseToRoomArray(d.rooms.leave));var v=yield Promise.all(h.map((function(){var m=A(function*(y){var E=y.room;if(y.isBrandNewRoom){y.timeline=y.timeline||{prev_batch:null,events:[]},E.getLiveTimeline().setPaginationToken(y.timeline.prev_batch,me.BACKWARDS);var{timelineEvents:T}=yield e.mapAndInjectRoomEvents(y);return E.recalculate(),n.store.storeRoom(E),n.emit(ye.Room,E),e.processEventsForNotifs(E,T),E}});return function(y){return m.apply(this,arguments)}})()));return v.filter(Boolean)})()}peek(e){var t,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20;if(((t=this._peekRoom)===null||t===void 0?void 0:t.roomId)===e)return Promise.resolve(this._peekRoom);var r=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,n).then(a=>{var o;if(((o=this._peekRoom)===null||o===void 0?void 0:o.roomId)!==e)throw new Error("Peeking aborted");a.messages=a.messages||{chunk:[]},a.messages.chunk=a.messages.chunk||[],a.state=a.state||[];var c=wu(a.state).map(r.getEventMapper()),d=a.state.map(r.getEventMapper()),h=a.messages.chunk.map(r.getEventMapper());return Array.isArray(a.presence)&&a.presence.map(r.getEventMapper()).forEach(function(v){var m=r.store.getUser(v.getContent().user_id);m?m.setPresenceEvent(v):(m=$r.createUser(v.getContent().user_id,r),m.setPresenceEvent(v),r.store.storeUser(m)),r.emit(ye.Event,v)}),a.messages.start&&(this._peekRoom.oldState.paginationToken=a.messages.start),this._peekRoom.oldState.setStateEvents(c),this._peekRoom.currentState.setStateEvents(d),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(h.reverse(),!0,!0,this._peekRoom.getLiveTimeline(),a.messages.start),r.store.storeRoom(this._peekRoom),r.emit(ye.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var n,r=this;if(this._peekRoom!==e){this.syncOpts.logger.debug("Stopped peeking in room %s",e.roomId);return}this.client.http.authedRequest($.Get,"/events",{room_id:e.roomId,timeout:String(30*1e3),from:t},void 0,{localTimeoutMs:50*1e3,abortSignal:(n=this.abortController)===null||n===void 0?void 0:n.signal}).then((function(){var a=A(function*(o){if(r._peekRoom!==e){r.syncOpts.logger.debug("Stopped peeking in room %s",e.roomId);return}o.chunk.filter(function(d){return d.type==="m.presence"}).map(r.client.getEventMapper()).forEach(d=>{var h=r.client.store.getUser(d.getContent().user_id);h?h.setPresenceEvent(d):(h=$r.createUser(d.getContent().user_id,r.client),h.setPresenceEvent(d),r.client.store.storeUser(h)),r.client.emit(ye.Event,d)});var c=o.chunk.filter(function(d){return d.room_id===e.roomId&&d.event_id}).map(r.client.getEventMapper());yield e.addLiveEvents(c,{addToState:!0}),r.peekPoll(e,o.end)});return function(o){return a.apply(this,arguments)}})(),a=>{this.syncOpts.logger.error("[%s] Peek poll failed: %s",e.roomId,a),setTimeout(()=>{this.peekPoll(e,t)},30*1e3)})}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}recoverFromSyncStartupError(e,t){var n=this;return A(function*(){yield e;var r=n.startKeepAlives();n.updateSyncState(ct.Error,{error:t}),yield r})()}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(this.syncOpts.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(ct.Error,{error:e}),!0):!1}sync(){var e=this;return A(function*(){var t,n;if(e.running=!0,e.abortController=new AbortController,(t=globalThis.window)===null||t===void 0||(n=t.addEventListener)===null||n===void 0||n.call(t,"online",e.onOnline,!1),e.client.isGuest())return e.doSync({});e.syncOpts.logger.debug("Getting saved sync token...");var r=e.client.store.getSavedSyncToken().then(v=>(e.syncOpts.logger.debug("Got saved sync token"),v));e.savedSyncPromise=e.client.store.getSavedSync().then(v=>{if(e.syncOpts.logger.debug("Got reply from saved sync, exists? ".concat(!!v)),v)return e.syncFromCache(v)}).catch(v=>{e.syncOpts.logger.error("Getting saved sync failed",v)}),yield e.getPushRules(),yield e.prepareLazyLoadingForSync(),yield e.storeClientOptions();var{filterId:a,filter:o}=yield e.getFilter();if(o){if(e.client.resetNotifTimelineSet(),!e.currentSyncRequest){var c=a,d=yield r;if(d)e.syncOpts.logger.debug("Sending first sync request...");else{e.syncOpts.logger.debug("Sending initial sync request...");var h=e.buildDefaultFilter();h.setDefinition(o.getDefinition()),h.setTimelineLimit(e.opts.initialSyncLimit),c=JSON.stringify(h.getDefinition())}e.currentSyncRequest=e.doSyncRequest({filter:c},d)}return e.syncOpts.logger.debug("Waiting for saved sync before starting sync processing..."),yield e.savedSyncPromise,e.doSync({filter:a})}})()}stop(){var e,t,n;this.syncOpts.logger.debug("SyncApi.stop"),(e=globalThis.window)===null||e===void 0||(t=e.removeEventListener)===null||t===void 0||t.call(e,"online",this.onOnline,!1),this.running=!1,(n=this.abortController)===null||n===void 0||n.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return this.connectionReturnedResolvers?(this.startKeepAlives(0),!0):!1}syncFromCache(e){var t=this;return A(function*(){t.syncOpts.logger.debug("sync(): not doing HTTP hit, instead returning stored /sync data");var n=e.nextBatch;t.client.store.setSyncToken(n);var r={nextSyncToken:n,catchingUp:!1,fromCache:!0},a={next_batch:n,rooms:e.roomsData,account_data:{events:e.accountData}};try{yield t.processSyncResponse(r,a)}catch(o){t.syncOpts.logger.error("Error processing cached sync",o)}t.storeIsInvalid||t.updateSyncState(ct.Prepared,r)})()}doSync(e){var t=this;return A(function*(){for(;t.running;){var n=t.client.store.getSyncToken(),r=void 0;try{t.currentSyncRequest||(t.currentSyncRequest=t.doSyncRequest(e,n)),r=yield t.currentSyncRequest}catch(c){var a=yield t.onSyncError(c);if(a)return;continue}finally{t.currentSyncRequest=void 0}t.client.store.setSyncToken(r.next_batch),t.failedSyncCount=0;var o={oldSyncToken:n??void 0,nextSyncToken:r.next_batch,catchingUp:t.catchingUp};try{yield t.processSyncResponse(o,r)}catch(c){t.syncOpts.logger.error("Caught /sync error",c),t.client.emit(ye.SyncUnexpectedError,c)}yield t.client.store.setSyncData(r),o.catchingUp=t.catchingUp,e.hasSyncedBefore||(t.updateSyncState(ct.Prepared,o),e.hasSyncedBefore=!0),t.syncOpts.cryptoCallbacks&&(yield t.syncOpts.cryptoCallbacks.onSyncCompleted(o)),t.updateSyncState(ct.Syncing,o),t.client.store.wantsSave()&&(yield t.client.store.save())}t.running||(t.syncOpts.logger.debug("Sync no longer running: exiting."),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(ct.Stopped))})()}doSyncRequest(e,t){var n,r=this.getSyncParams(e,t);return this.client.http.authedRequest($.Get,"/sync",r,void 0,{localTimeoutMs:r.timeout+J_,abortSignal:(n=this.abortController)===null||n===void 0?void 0:n.signal})}getSyncParams(e,t){var n=this.opts.pollTimeout;(this.getSyncState()!==ct.Syncing||this.catchingUp)&&(this.catchingUp=!0,n=0);var r=e.filter;this.client.isGuest()&&!r&&(r=this.getGuestFilter());var a={filter:r,timeout:n,"org.matrix.msc4222.use_state_after":!0};return this.opts.disablePresence?a.set_presence=Ew.Offline:this.presence!==void 0&&(a.set_presence=this.presence),t?a.since=t:a._cacheBuster=Date.now(),[ct.Reconnecting,ct.Error].includes(this.getSyncState())&&(a.timeout=0),a}setPresence(e){this.presence=e}onSyncError(e){var t=this;return A(function*(){if(!t.running)return t.syncOpts.logger.debug("Sync no longer running: exiting"),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(ct.Stopped),!0;if(t.syncOpts.logger.error("/sync error %s",e),t.shouldAbortSync(e))return!0;t.failedSyncCount++,t.syncOpts.logger.debug("Number of consecutive failed sync requests:",t.failedSyncCount),t.syncOpts.logger.debug("Starting keep-alive");var n=t.startKeepAlives();t.currentSyncRequest=void 0,t.updateSyncState(t.failedSyncCount>=z1?ct.Error:ct.Reconnecting,{error:e});var r=yield n;return r&&t.getSyncState()===ct.Error&&t.updateSyncState(ct.Catchup,{catchingUp:!0}),!1})()}processSyncResponse(e,t){var n=this;return A(function*(){var r,a,o,c,d=n.client;if(Array.isArray((r=t.presence)===null||r===void 0?void 0:r.events)&&t.presence.events.filter(ji).map(d.getEventMapper()).forEach(function(R){var I=d.store.getUser(R.getSender());I?I.setPresenceEvent(R):(I=$r.createUser(R.getSender(),d),I.setPresenceEvent(R),d.store.storeUser(I)),d.emit(ye.Event,R)}),Array.isArray((a=t.account_data)===null||a===void 0?void 0:a.events)){var h=t.account_data.events.filter(ji).map(d.getEventMapper()),v=h.reduce((R,I)=>(R[I.getType()]=d.store.getAccountData(I.getType()),R),{});d.store.storeAccountDataEvents(h),h.forEach(function(R){if(R.getType()===G.PushRules){var I=R.getContent();d.setPushRules(I)}var M=v[R.getType()];return d.emit(ye.AccountData,R,M),R})}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){var m=t.to_device.events.filter(ji),y;n.syncOpts.cryptoCallbacks?y=yield n.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(m):y=m.map(R=>({message:R,encryptionInfo:null})),Rw(y,d)}else n.catchingUp=!1;var E=[],T=[],S=[],O=[];t.rooms&&(t.rooms.invite&&(E=n.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(T=n.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(S=n.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.knock&&(O=n.mapSyncResponseToRoomArray(t.rooms.knock))),n.notifEvents=[],yield Promise.all(E.map((function(){var R=A(function*(I){var M=I.room,C=n.mapSyncEventsFormat(I.invite_state,M);yield n.injectRoomEvents(M,C,void 0),I.isBrandNewRoom?(M.recalculate(),d.store.storeRoom(M),d.emit(ye.Room,M)):M.recalculate(),C.forEach(function(k){d.emit(ye.Event,k)})});return function(I){return R.apply(this,arguments)}})())),yield Promise.all(T.map((function(){var R=A(function*(I){var M,C=I.room,k=n.mapSyncEventsFormat(I.state,C),_=n.mapSyncEventsFormat(I["org.matrix.msc4222.state_after"],C),P=n.mapSyncEventsFormat(I.timeline,C,!1),x=n.mapSyncEventsFormat(I.ephemeral),U=n.mapSyncEventsFormat(I.account_data),j=n.mapSyncEventsFormat(I.msc4354_sticky),K=I["org.matrix.msc4222.state_after"]?_:k.concat(P),Z=n.isRoomEncrypted(C,K);if(I.unread_notifications){if(!Z||I.unread_notifications.notification_count===0){var be;C.setUnreadNotificationCount(it.Total,(be=I.unread_notifications.notification_count)!==null&&be!==void 0?be:0)}if(!Z||C.getUnreadNotificationCount(it.Highlight)<=0){var Pe;C.setUnreadNotificationCount(it.Highlight,(Pe=I.unread_notifications.highlight_count)!==null&&Pe!==void 0?Pe:0)}}var ce=(M=I[au.name])!==null&&M!==void 0?M:I[au.altName];if(ce){C.resetThreadUnreadNotificationCountFromSync(Object.keys(ce));for(var[V,Q]of Object.entries(ce)){if(!Z||Q.notification_count===0){var le;C.setThreadUnreadNotificationCount(V,it.Total,(le=Q.notification_count)!==null&&le!==void 0?le:0)}var ve=C.getThreadUnreadNotificationCount(V,it.Highlight)<=0;if(!Z||Z&&ve){var Te;C.setThreadUnreadNotificationCount(V,it.Highlight,(Te=Q.highlight_count)!==null&&Te!==void 0?Te:0)}}}else C.resetThreadUnreadNotificationCountFromSync();if(I.timeline=I.timeline||{},I.isBrandNewRoom)I.timeline.prev_batch!==null&&C.getLiveTimeline().setPaginationToken(I.timeline.prev_batch,me.BACKWARDS);else if(I.timeline.limited){for(var F=!0,ee=P.length-1;ee>=0;ee--){var de=P[ee].getId();if(C.getTimelineForEvent(de)){n.syncOpts.logger.debug("Already have event ".concat(de," in limited sync - not resetting")),F=!1,P.splice(0,ee);break}}if(F){var pe;C.resetLiveTimeline(I.timeline.prev_batch,n.syncOpts.canResetEntireTimeline(C.roomId)?null:(pe=e.oldSyncToken)!==null&&pe!==void 0?pe:null),d.resetNotifTimelineSet()}}if(n.syncOpts.cryptoCallbacks)for(var Re of K)Re.isState()&&Re.getType()===G.RoomEncryption&&Re.getStateKey()===""&&(yield n.syncOpts.cryptoCallbacks.onCryptoEvent(C,Re));for(var Ae of P.filter(He=>He.isState()))yield n.client.decryptEventIfNeeded(Ae);try{"org.matrix.msc4222.state_after"in I?yield n.injectRoomEvents(C,void 0,_,P,e.fromCache):yield n.injectRoomEvents(C,k,void 0,P,e.fromCache)}catch(He){n.syncOpts.logger.error("Failed to process events on room ".concat(C.roomId,":"),He)}I.summary&&C.setSummary(I.summary),C.addEphemeralEvents(x),C.addAccountData(U);var ke=j.concat(P.filter(He=>He.unstableStickyInfo!==void 0));C._unstable_addStickyEvents(ke),C.recalculate(),I.isBrandNewRoom&&(d.store.storeRoom(C),d.emit(ye.Room,C)),n.processEventsForNotifs(C,P);var lt=He=>d.emit(ye.Event,He);k.forEach(lt),P.forEach(lt),x.forEach(lt),U.forEach(lt),j.filter(He=>!P.some(Ji=>Ji.getId()===He.getId())).forEach(lt),C.decryptCriticalEvents()});return function(I){return R.apply(this,arguments)}})())),yield Promise.all(S.map((function(){var R=A(function*(I){var M=I.room,{timelineEvents:C,stateEvents:k,stateAfterEvents:_}=yield n.mapAndInjectRoomEvents(I),P=n.mapSyncEventsFormat(I.account_data);M.addAccountData(P),M.recalculate(),I.isBrandNewRoom&&(d.store.storeRoom(M),d.emit(ye.Room,M)),n.processEventsForNotifs(M,C),k?.forEach(function(x){d.emit(ye.Event,x)}),_?.forEach(function(x){d.emit(ye.Event,x)}),C.forEach(function(x){d.emit(ye.Event,x)}),P.forEach(function(x){d.emit(ye.Event,x)})});return function(I){return R.apply(this,arguments)}})())),yield Promise.all(O.map((function(){var R=A(function*(I){var M=I.room,C=n.mapSyncEventsFormat(I.knock_state,M);yield n.injectRoomEvents(M,C,void 0),I.isBrandNewRoom?(M.recalculate(),d.store.storeRoom(M),d.emit(ye.Room,M)):M.recalculate(),C.forEach(function(k){d.emit(ye.Event,k)})});return function(I){return R.apply(this,arguments)}})())),e.oldSyncToken&&n.notifEvents.length&&(n.notifEvents.sort(function(R,I){return R.getTs()-I.getTs()}),n.notifEvents.forEach(function(R){var I;(I=d.getNotifTimelineSet())===null||I===void 0||I.addLiveEvent(R,{addToState:!0})})),t.device_lists&&n.syncOpts.cryptoCallbacks&&(yield n.syncOpts.cryptoCallbacks.processDeviceLists(t.device_lists)),yield(o=n.syncOpts.cryptoCallbacks)===null||o===void 0?void 0:o.processKeyCounts(t.device_one_time_keys_count,(c=t.device_unused_fallback_key_types)!==null&&c!==void 0?c:t["org.matrix.msc2732.device_unused_fallback_key_types"])})()}startKeepAlives(e){return e===void 0&&(e=2e3+Math.floor(Math.random()*5e3)),this.keepAliveTimer!==null&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedResolvers||(this.connectionReturnedResolvers=Promise.withResolvers()),this.connectionReturnedResolvers.promise}pokeKeepAlive(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(!this.running){clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.reject("SyncApi.stop() was called"),this.connectionReturnedResolvers=void 0);return}var n=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.resolve(t),this.connectionReturnedResolvers=void 0)};this.client.http.request($.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15*1e3,abortSignal:(e=this.abortController)===null||e===void 0?void 0:e.signal}).then(()=>{n()},r=>{r.httpStatus==400||r.httpStatus==404?this.keepAliveTimer=setTimeout(n,2e3):(t=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,t),5e3+Math.floor(Math.random()*5e3)),this.updateSyncState(ct.Error,{error:r}))})}mapSyncResponseToRoomArray(e){var t=this.client;return Object.keys(e).filter(n=>!Gc(n)).map(n=>{var r=t.store.getRoom(n),a=!1;return r||(r=this.createRoom(n),a=!0),Xh(Xh({},e[n]),{},{room:r,isBrandNewRoom:a})})}mapSyncEventsFormat(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;if(!e||!Array.isArray(e.events))return[];var r=this.client.getEventMapper({decrypt:n});return e.events.filter(ji).map(function(a){return t&&(a.room_id=t.roomId),r(a)})}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(Ne.Invite).forEach(function(n){if(!n.requestedProfileInfo){n.requestedProfileInfo=!0;var r=t.getUser(n.userId),a;r?a=Promise.resolve({avatar_url:r.avatarUrl,displayname:r.displayName}):a=t.getProfileInfo(n.userId),a.then(function(o){var c=n.events.member;c?.getContent().membership===Ne.Invite&&(c.getContent().avatar_url=o.avatar_url,c.getContent().displayname=o.displayname,n.setMembershipEvent(c,e.currentState))},function(o){})}})}}findEncryptionEvent(e){return e?.find(t=>t.getType()===G.RoomEncryption&&t.getStateKey()==="")}isRoomEncrypted(e,t){return e.hasEncryptionStateEvent()||!!this.findEncryptionEvent(t)}mapAndInjectRoomEvents(e){var t=this;return A(function*(){var n=t.mapSyncEventsFormat(e.state,e.room),r=t.mapSyncEventsFormat(e["org.matrix.msc4222.state_after"],e.room),a=t.mapSyncEventsFormat(e.timeline,e.room);return"org.matrix.msc4222.state_after"in e?yield t.injectRoomEvents(e.room,void 0,r,a):yield t.injectRoomEvents(e.room,n,void 0,a),{timelineEvents:a,stateEvents:n,stateAfterEvents:r}})()}injectRoomEvents(e,t,n,r){var a=arguments,o=this;return A(function*(){var c=a.length>4&&a[4]!==void 0?a[4]:!1,d=n??t,h=e.getLiveTimeline(),v=h.getEvents().length==0;if(v){for(var m of d)o.client.getPushActionsForEvent(m);h.initialiseState(d,{timelineWasEmpty:v})}o.resolveInvites(e),e.recalculate(),v||(e.oldState.setStateEvents(d),e.currentState.setStateEvents(d)),yield e.addLiveEvents(r||[],{fromCache:c,timelineWasEmpty:v,addToState:n===void 0}),o.client.processBeaconEvents(e,r)})()}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(var n of t){var r,a=this.client.getPushActionsForEvent(n);a!=null&&a.notify&&(r=a.tweaks)!==null&&r!==void 0&&r.highlight&&this.notifEvents.push(n)}}getGuestFilter(){return"{}"}updateSyncState(e,t){var n=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(ye.Sync,this.syncState,n,t)}}function Cw(i,e,t){var{timelineSupport:n}=i,r=new Pf(e,i,i.getUserId(),{lazyLoadMembers:t.lazyLoadMembers,pendingEventOrdering:t.pendingEventOrdering,timelineSupport:n});return i.reEmitter.reEmit(r,[ge.Name,ge.Redaction,ge.RedactionCancelled,ge.Receipt,ge.Tags,ge.LocalEchoUpdated,ge.AccountData,ge.MyMembership,ge.Timeline,ge.TimelineReset,Ke.Events,Ke.Members,Ke.NewMember,Ke.Update,It.New,It.Update,It.Destroy,It.LivenessChange]),r.on(Ke.NewMember,(a,o,c)=>{var d;c.user=(d=i.getUser(c.userId))!==null&&d!==void 0?d:void 0,i.reEmitter.reEmit(c,[Hn.Name,Hn.Typing,Hn.PowerLevel,Hn.Membership])}),r}function Rw(i,e){var t=[];i.map(n=>{if(n.message.type==="m.key.verification.cancel"){var r=n.message.content.transaction_id;r&&t.push(r)}return n}).forEach(function(n){{var r=n.message,a=r.content,o=new Sn(Object.assign({},r));if(r.type==="m.key.verification.start"||r.type==="m.key.verification.request"){var c=a.transaction_id;t.includes(c)&&o.flagCancelled()}n.encryptionInfo&&o.makeEncrypted(G.RoomMessageEncrypted,{ciphertext:""},n.encryptionInfo.senderCurve25519KeyBase64,""),e.emit(ye.ToDeviceEvent,o)}e.emit(ye.ReceivedToDeviceMessage,n)})}class J1{constructor(){b(this,"accountData",new Map),b(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}storeEvents(e,t,n,r){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}getPendingEvents(e){return A(function*(){return[]})()}setPendingEvents(e,t){return Promise.resolve()}saveToDeviceBatches(e){return A(function*(){return Promise.resolve()})()}getOldestToDeviceBatch(){return Promise.resolve(null)}removeToDeviceBatch(e){return A(function*(){return Promise.resolve()})()}destroy(){return A(function*(){})()}}const yn=[];for(let i=0;i<256;++i)yn.push((i+256).toString(16).slice(1));function Y1(i,e=0){return(yn[i[e+0]]+yn[i[e+1]]+yn[i[e+2]]+yn[i[e+3]]+"-"+yn[i[e+4]]+yn[i[e+5]]+"-"+yn[i[e+6]]+yn[i[e+7]]+"-"+yn[i[e+8]]+yn[i[e+9]]+"-"+yn[i[e+10]]+yn[i[e+11]]+yn[i[e+12]]+yn[i[e+13]]+yn[i[e+14]]+yn[i[e+15]]).toLowerCase()}let Rp;const $1=new Uint8Array(16);function X1(){if(!Rp){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Rp=crypto.getRandomValues.bind(crypto)}return Rp($1)}const Q1=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),$_={randomUUID:Q1};function Z1(i,e,t){i=i||{};const n=i.random??i.rng?.()??X1();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,Y1(n)}function eN(i,e,t){return $_.randomUUID&&!i?$_.randomUUID():Z1(i)}var Ni={},kp={},wp={exports:{}},X_;function Qy(){if(X_)return wp.exports;X_=1;var i=wp.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return e.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return e.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{push:"msid",reg:/^msid:([\w-]+)(?: ([\w-]+))?/,names:["id","appdata"],format:"msid:%s %s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=e.raddr!=null?" raddr %s rport %d":"%v%v",t+=e.tcptype!=null?" tcptype %s":"%v",e.generation!=null&&(t+=" generation %d"),t+=e["network-id"]!=null?" network-id %d":"%v",t+=e["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return e.attribute!=null&&(t+=" %s",e.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return e.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(e.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=e.id!=null?"id=%s %s":"%v%s",t+=e.mediaClockValue!=null?"=%s":"",t+=e.rateNumerator!=null?" rate=%s":"",t+=e.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(i).forEach(function(e){var t=i[e];t.forEach(function(n){n.reg||(n.reg=/(.*)/),n.format||(n.format="%s")})}),wp.exports}var Q_;function tN(){return Q_||(Q_=1,(function(i){var e=function(c){return String(Number(c))===c?Number(c):c},t=function(c,d,h,v){if(v&&!h)d[v]=e(c[1]);else for(var m=0;m<h.length;m+=1)c[m+1]!=null&&(d[h[m]]=e(c[m+1]))},n=function(c,d,h){var v=c.name&&c.names;c.push&&!d[c.push]?d[c.push]=[]:v&&!d[c.name]&&(d[c.name]={});var m=c.push?{}:v?d[c.name]:d;t(h.match(c.reg),m,c.names,c.name),c.push&&d[c.push].push(m)},r=Qy(),a=RegExp.prototype.test.bind(/^([a-z])=(.*)/);i.parse=function(c){var d={},h=[],v=d;return c.split(/(\r\n|\r|\n)/).filter(a).forEach(function(m){var y=m[0],E=m.slice(2);y==="m"&&(h.push({rtp:[],fmtp:[]}),v=h[h.length-1]);for(var T=0;T<(r[y]||[]).length;T+=1){var S=r[y][T];if(S.reg.test(E))return n(S,v,E)}}),d.media=h,d};var o=function(c,d){var h=d.split(/=(.+)/,2);return h.length===2?c[h[0]]=e(h[1]):h.length===1&&d.length>1&&(c[h[0]]=void 0),c};i.parseParams=function(c){return c.split(/;\s?/).reduce(o,{})},i.parseFmtpConfig=i.parseParams,i.parsePayloads=function(c){return c.toString().split(" ").map(Number)},i.parseRemoteCandidates=function(c){for(var d=[],h=c.split(" ").map(e),v=0;v<h.length;v+=3)d.push({component:h[v],ip:h[v+1],port:h[v+2]});return d},i.parseImageAttributes=function(c){return c.split(" ").map(function(d){return d.substring(1,d.length-1).split(",").reduce(o,{})})},i.parseSimulcastStreamList=function(c){return c.split(";").map(function(d){return d.split(",").map(function(h){var v,m=!1;return h[0]!=="~"?v=e(h):(v=e(h.substring(1,h.length)),m=!0),{scid:v,paused:m}})})}})(kp)),kp}var Ip,Z_;function nN(){if(Z_)return Ip;Z_=1;var i=Qy(),e=/%[sdv%]/g,t=function(o){var c=1,d=arguments,h=d.length;return o.replace(e,function(v){if(c>=h)return v;var m=d[c];switch(c+=1,v){case"%%":return"%";case"%s":return String(m);case"%d":return Number(m);case"%v":return""}})},n=function(o,c,d){var h=c.format instanceof Function?c.format(c.push?d:d[c.name]):c.format,v=[o+"="+h];if(c.names)for(var m=0;m<c.names.length;m+=1){var y=c.names[m];c.name?v.push(d[c.name][y]):v.push(d[c.names[m]])}else v.push(d[c.name]);return t.apply(null,v)},r=["v","o","s","i","u","e","p","c","b","t","r","z","a"],a=["i","c","b","a"];return Ip=function(o,c){c=c||{},o.version==null&&(o.version=0),o.name==null&&(o.name=" "),o.media.forEach(function(m){m.payloads==null&&(m.payloads="")});var d=c.outerOrder||r,h=c.innerOrder||a,v=[];return d.forEach(function(m){i[m].forEach(function(y){y.name in o&&o[y.name]!=null?v.push(n(m,y,o)):y.push in o&&o[y.push]!=null&&o[y.push].forEach(function(E){v.push(n(m,y,E))})})}),o.media.forEach(function(m){v.push(n("m",i.m[0],m)),h.forEach(function(y){i[y].forEach(function(E){E.name in m&&m[E.name]!=null?v.push(n(y,E,m)):E.push in m&&m[E.push]!=null&&m[E.push].forEach(function(T){v.push(n(y,E,T))})})})}),v.join(`\r
`)+`\r
`},Ip}var eC;function iN(){if(eC)return Ni;eC=1;var i=tN(),e=nN(),t=Qy();return Ni.grammar=t,Ni.write=e,Ni.parse=i.parse,Ni.parseParams=i.parseParams,Ni.parseFmtpConfig=i.parseFmtpConfig,Ni.parsePayloads=i.parsePayloads,Ni.parseRemoteCandidates=i.parseRemoteCandidates,Ni.parseImageAttributes=i.parseImageAttributes,Ni.parseSimulcastStreamList=i.parseSimulcastStreamList,Ni}var Dg=iN();function Zy(i,e){if(typeof i.toBase64=="function")return i.toBase64(e);var t=btoa(i.reduce((n,r)=>n+String.fromCharCode(r),""));return e.omitPadding&&(t=t.replace(/={1,2}$/,"")),e.alphabet==="base64url"&&(t=t.replace(/\+/g,"-").replace(/\//g,"_")),t}function Wc(i){return Zy(i,{alphabet:"base64",omitPadding:!1})}function eb(i){return Zy(i,{alphabet:"base64",omitPadding:!0})}function Af(i){return Zy(i,{alphabet:"base64url",omitPadding:!0})}function rN(i,e){return typeof Uint8Array.fromBase64=="function"?Uint8Array.fromBase64(i,e):Uint8Array.from(atob(i),t=>t.charCodeAt(0))}function xs(i){return rN(i.replace(/-/g,"+").replace(/_/g,"/"),{alphabet:"base64",lastChunkHandling:"loose"})}var aN="abcdefghijklmnopqrstuvwxyz",sN="ABCDEFGHIJKLMNOPQRSTUVWXYZ",oN="0123456789";function lN(i){var e=new Uint8Array(i);return globalThis.crypto.getRandomValues(e),Af(e)}function Fa(i){return cN(i,sN+aN+oN)}function cN(i,e){if(e.length<2||e.length>256)throw new Error("Character set must be between 2 and 256 characters long");if(i<1||i>32768)throw new Error("Requested random string length must be between 1 and 32768");for(var t=256-256%e.length,n=new Uint8Array(Math.floor(i*1.3)),r=n.length,a=[];a.length<i;){r===n.length&&(globalThis.crypto.getRandomValues(n),r=0);var o=n[r++];o<t&&a.push(e[o%e.length])}return a.join("")}var Ra="org.matrix.msc3077.sdp_stream_metadata",bt=(function(i){return i.Usermedia="m.usermedia",i.Screenshare="m.screenshare",i})({}),Jc=null,Ng=0,uN=()=>(Jc===null&&(Jc=new AudioContext),Ng++,Jc),dN=()=>{if(Ng--,Ng===0){var i;(i=Jc)===null||i===void 0||i.close(),Jc=null}},hN=200,xg=-60,fN=8,tr=(function(i){return i.NewStream="new_stream",i.MuteStateChanged="mute_state_changed",i.LocalVolumeChanged="local_volume_changed",i.VolumeChanged="volume_changed",i.ConnectedChanged="connected_changed",i.Speaking="speaking",i.Disposed="disposed",i})({});class qr extends Ot{constructor(e){super(),b(this,"stream",void 0),b(this,"sdpMetadataStreamId",void 0),b(this,"userId",void 0),b(this,"deviceId",void 0),b(this,"purpose",void 0),b(this,"speakingVolumeSamples",void 0),b(this,"client",void 0),b(this,"call",void 0),b(this,"roomId",void 0),b(this,"audioMuted",void 0),b(this,"videoMuted",void 0),b(this,"localVolume",1),b(this,"measuringVolumeActivity",!1),b(this,"audioContext",void 0),b(this,"analyser",void 0),b(this,"frequencyBinCount",void 0),b(this,"speakingThreshold",xg),b(this,"speaking",!1),b(this,"volumeLooperTimeout",void 0),b(this,"_disposed",!1),b(this,"_connected",!1),b(this,"onAddTrack",()=>{this.emit(tr.NewStream,this.stream)}),b(this,"onCallState",t=>{t===Me.Connected?this.connected=!0:t===Me.Connecting&&(this.connected=!1)}),b(this,"volumeLooper",()=>{if(this.analyser&&this.measuringVolumeActivity){this.analyser.getFloatFrequencyData(this.frequencyBinCount);var t=-1/0;for(var n of this.frequencyBinCount)n>t&&(t=n);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(t),this.emit(tr.VolumeChanged,t);var r=!1;for(var a of this.speakingVolumeSamples)if(a>this.speakingThreshold){r=!0;break}this.speaking!==r&&(this.speaking=r,this.emit(tr.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,hN)}}),this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(fN).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(qe.State,this.onCallState),this.onCallState(e.call.state))}get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit(tr.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){if(t!==e){var n=this.measuringVolumeActivity;e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?(this.initVolumeMeasuring(),n&&this.measureVolumeActivity(!0)):this.measureVolumeActivity(!1),this.emit(tr.NewStream,this.stream)}}initVolumeMeasuring(){if(this.hasAudioTrack){this.audioContext||(this.audioContext=uN()),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;var e=this.audioContext.createMediaStreamSource(this.stream);e.connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}}getMember(){var e,t=this.client.getRoom(this.roomId);return(e=t?.getMember(this.userId))!==null&&e!==void 0?e:null}isLocal(){return this.userId===this.client.getUserId()&&(this.deviceId===void 0||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return this.stream.getAudioTracks().length===0||this.audioMuted}isVideoMuted(){return this.stream.getVideoTracks().length===0||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){e!==null&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),t!==null&&(this.videoMuted=t),this.emit(tr.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(tr.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){var e=this.client.getMediaHandler(),t=this.stream.clone();return D.log("CallFeed clone() cloning stream (originalStreamId=".concat(this.stream.id,", newStreamId").concat(t.id,")")),this.purpose===bt.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new qr({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t;clearTimeout(this.volumeLooperTimeout),(e=this.stream)===null||e===void 0||e.removeEventListener("addtrack",this.onAddTrack),(t=this.call)===null||t===void 0||t.removeListener(qe.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,dN()),this._disposed=!0,this.emit(tr.Disposed)}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit(tr.LocalVolumeChanged,e)}}var vN=3e3,Lg=(function(i){return i.Incoming="Call.incoming",i})({});class mN{constructor(e){b(this,"calls",void 0),b(this,"callEventBuffer",void 0),b(this,"nextSeqByCall",new Map),b(this,"toDeviceEventBuffers",new Map),b(this,"client",void 0),b(this,"candidateEventsByCall",void 0),b(this,"eventBufferPromiseChain",void 0),b(this,"onSync",()=>{var t=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then(()=>this.evaluateEventBuffer(t)):this.eventBufferPromiseChain=this.evaluateEventBuffer(t)}),b(this,"onRoomTimeline",t=>{this.callEventBuffer.push(t)}),b(this,"onToDeviceEvent",t=>{var n=t.getContent();if(!n.call_id){this.callEventBuffer.push(t);return}if(this.nextSeqByCall.has(n.call_id)||this.nextSeqByCall.set(n.call_id,0),n.seq===void 0){this.callEventBuffer.push(t);return}var r=this.nextSeqByCall.get(n.call_id)||0;if(n.seq!==r){this.toDeviceEventBuffers.has(n.call_id)||this.toDeviceEventBuffers.set(n.call_id,[]);var a=this.toDeviceEventBuffers.get(n.call_id),o=a.findIndex(v=>v.getContent().seq>n.seq);o===-1?a.push(t):a.splice(o,0,t)}else{var c=n.call_id;this.callEventBuffer.push(t),this.nextSeqByCall.set(c,n.seq+1);for(var d=this.toDeviceEventBuffers.get(c),h=d&&d.shift();h&&h.getContent().seq===this.nextSeqByCall.get(c);)this.callEventBuffer.push(h),this.nextSeqByCall.set(c,h.getContent().seq+1),h=d.shift()}}),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(ye.Sync,this.onSync),this.client.on(ge.Timeline,this.onRoomTimeline),this.client.on(ye.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(ye.Sync,this.onSync),this.client.removeListener(ge.Timeline,this.onRoomTimeline),this.client.removeListener(ye.ToDeviceEvent,this.onToDeviceEvent)}evaluateEventBuffer(e){var t=this;return A(function*(){yield Promise.all(e.map(v=>t.client.decryptEventIfNeeded(v)));var n=e.filter(v=>{var m=v.getType();return m.startsWith("m.call.")||m.startsWith("org.matrix.call.")}),r=new Set;for(var a of n){var o=a.getType();(o===G.CallAnswer||o===G.CallHangup)&&r.add(a.getContent().call_id)}for(var c of n){var d=c.getType(),h=c.getContent().call_id;if(!(d===G.CallInvite&&r.has(h)))try{yield t.handleCallEvent(c)}catch(v){D.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",v)}}})()}handleCallEvent(e){var t=this;return A(function*(){var n;t.client.emit(ye.ReceivedVoipEvent,e);var r=e.getContent(),a=e.getRoomId()||((n=t.client.groupCallEventHandler.getGroupCallById(r.conf_id))===null||n===void 0||(n=n.room)===null||n===void 0?void 0:n.roomId),o=r.conf_id,c=e.getType(),d=e.getSender(),h=r.call_id?t.calls.get(r.call_id):void 0,v,m;if(o){if(m=t.client.groupCallEventHandler.getGroupCallById(o),!m){D.warn("CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=".concat(o,", type=").concat(c,")"));return}if(v=r.device_id,!v){D.warn("CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=".concat(d,")")),m.emit(yt.Error,new Iw(d));return}if(r.dest_session_id!==t.client.getSessionId()){D.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring");return}}var y=d===t.client.credentials.userId&&(v===void 0||v===t.client.getDeviceId());if(a){if(c===G.CallInvite){var E,T,S;if(y||e.getLocalAge()>r.lifetime-vN||h&&h.state===Me.Ended||(h&&D.warn("CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=".concat(r.call_id,")")),r.invitee&&r.invitee!==t.client.getUserId()))return;var O=((E=t.client.getTurnServersExpiry())!==null&&E!==void 0?E:0)-Date.now();if(D.info("CallEventHandler handleCallEvent() current turn creds expire in "+O+" ms"),h=(T=ou(t.client,a,{forceTURN:t.client.forceTURN,opponentDeviceId:v,groupCallId:o,opponentSessionId:r.sender_session_id}))!==null&&T!==void 0?T:void 0,!h){D.log("CallEventHandler handleCallEvent() this client does not support WebRTC (callId=".concat(r.call_id,")"));return}h.callId=r.call_id;var R=(S=m)===null||S===void 0?void 0:S.getGroupCallStats();R&&h.initStats(R);try{yield h.initWithInvite(e)}catch(U){if(U instanceof Ur)if(U.code===$c.UnknownDevice){var I;(I=m)===null||I===void 0||I.emit(yt.Error,U)}else D.error(U)}if(t.calls.set(h.callId,h),t.candidateEventsByCall.get(h.callId))for(var M of t.candidateEventsByCall.get(h.callId))h.onRemoteIceCandidatesReceived(M);var C;for(var k of t.calls.values()){var _,P=[Me.WaitLocalMedia,Me.CreateOffer,Me.InviteSent].includes(k.state);if(h.roomId===k.roomId&&k.direction===Oa.Outbound&&((_=h.getOpponentMember())===null||_===void 0?void 0:_.userId)===k.invitee&&P){C=k;break}}C?C.callId>h.callId?(D.log("CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=".concat(h.callId,", outgoingId=").concat(C.callId,")")),C.replacedBy(h)):(D.log("CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=".concat(h.callId,", outgoingId=").concat(C.callId,")")),h.hangup(Ue.Replaced,!0)):t.client.emit(Lg.Incoming,h);return}else if(c===G.CallCandidates){if(y)return;h?h.onRemoteIceCandidatesReceived(e):(t.candidateEventsByCall.has(r.call_id)||t.candidateEventsByCall.set(r.call_id,[]),t.candidateEventsByCall.get(r.call_id).push(e));return}else if([G.CallHangup,G.CallReject].includes(c)){if(h)h.state!==Me.Ended&&(c===G.CallHangup?h.onHangupReceived(r):h.onRejectReceived(r),h.state===Me.Ended&&t.calls.delete(r.call_id));else{var x;h=(x=ou(t.client,a,{opponentDeviceId:v,opponentSessionId:r.sender_session_id}))!==null&&x!==void 0?x:void 0,h&&(h.callId=r.call_id,h.initWithHangup(e),t.calls.set(r.call_id,h))}return}if(!h||!h.hasPeerConnection){D.info("CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=".concat(c,")"));return}if(e.getContent().party_id!==h.ourPartyId)switch(c){case G.CallAnswer:y?h.state===Me.Ringing&&h.onAnsweredElsewhere(r):h.onAnswerReceived(e);break;case G.CallSelectAnswer:h.onSelectAnswerReceived(e);break;case G.CallNegotiate:h.onNegotiateReceived(e);break;case G.CallAssertedIdentity:case G.CallAssertedIdentityPrefix:h.onAssertedIdentityReceived(e);break;case G.CallSDPStreamMetadataChanged:case G.CallSDPStreamMetadataChangedPrefix:h.onSDPStreamMetadataChangedReceived(e);break}}})()}}var Ug=(function(i){return i.Incoming="GroupCall.incoming",i.Outgoing="GroupCall.outgoing",i.Ended="GroupCall.ended",i.Participants="GroupCall.participants",i})({});class pN{constructor(e){this.client=e,b(this,"groupCalls",new Map),b(this,"roomDeferreds",new Map),b(this,"onRoomsChanged",t=>{this.createGroupCallForRoom(t)}),b(this,"onRoomStateChanged",(t,n)=>{var r=t.getType();if(r===G.GroupCallPrefix){var a=t.getStateKey(),o=t.getContent(),c=this.groupCalls.get(n.roomId);!c&&!o["m.terminated"]&&!t.isRedacted()?this.createGroupCallFromRoomStateEvent(t):c&&c.groupCallId===a?o["m.terminated"]||t.isRedacted()?c.terminate(!1):o["m.type"]!==c.type&&D.warn("GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=".concat(n.roomId,")")):c&&c.groupCallId!==a&&D.warn("GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=".concat(n.roomId,")"))}})}start(){var e=this;return A(function*(){e.client.getSyncState()!==ct.Syncing&&(D.debug("GroupCallEventHandler start() waiting for client to start syncing"),yield new Promise(r=>{var a=()=>{if(e.client.getSyncState()===ct.Syncing)return e.client.off(ye.Sync,a),r()};e.client.on(ye.Sync,a)}));var t=e.client.getRooms();for(var n of t)e.createGroupCallForRoom(n);e.client.on(ye.Room,e.onRoomsChanged),e.client.on(Ke.Events,e.onRoomStateChanged)})()}stop(){this.client.removeListener(ye.Room,this.onRoomsChanged),this.client.removeListener(Ke.Events,this.onRoomStateChanged)}getRoomDeferred(e){var t=this.roomDeferreds.get(e);if(t===void 0){var n;t={prom:new Promise(r=>{n=r})},t.resolve=n,this.roomDeferreds.set(e,t)}return t}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find(t=>t.groupCallId===e)}createGroupCallForRoom(e){var t=e.currentState.getStateEvents(G.GroupCallPrefix),n=t.sort((o,c)=>c.getTs()-o.getTs());for(var r of n){var a=r.getContent();if(!(a["m.terminated"]||r.isRedacted())){D.debug("GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=".concat(r.getStateKey(),", ts=").concat(r.getTs(),", roomId=").concat(e.roomId,", numOfPossibleCalls=").concat(t.length,")")),this.createGroupCallFromRoomStateEvent(r);break}}this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){var t=e.getRoomId(),n=e.getContent(),r=this.client.getRoom(t);if(!r){D.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=".concat(t,")"));return}var a=e.getStateKey(),o=n["m.type"];if(!Object.values(Df).includes(o)){D.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=".concat(o,", roomId=").concat(t,")"));return}var c=n["m.intent"];if(!Object.values(ww).includes(c)){D.warn("Received invalid group call intent (type=".concat(o,", roomId=").concat(t,")"));return}var d=!!n["io.element.ptt"],h;if(n!=null&&n.dataChannelsEnabled&&n!==null&&n!==void 0&&n.dataChannelOptions){var{ordered:v,maxPacketLifeTime:m,maxRetransmits:y,protocol:E}=n.dataChannelOptions;h={ordered:v,maxPacketLifeTime:m,maxRetransmits:y,protocol:E}}var T=new tb(this.client,r,o,d,c,a,n?.dataChannelsEnabled||this.client.isVoipWithNoMediaAllowed,h,this.client.isVoipWithNoMediaAllowed,this.client.useLivekitForGroupCalls,n["io.element.livekit_service_url"]);return this.groupCalls.set(r.roomId,T),this.client.emit(Ug.Incoming,T),T}}class gN{constructor(){b(this,"bandwidth",{}),b(this,"bitrate",{}),b(this,"packetLoss",{}),b(this,"transport",[])}}class yN{static buildBandwidthReport(e){var t=e.availableIncomingBitrate,n=e.availableOutgoingBitrate;return{download:t?Math.round(t/1e3):0,upload:n?Math.round(n/1e3):0}}}class bN{static buildReport(e,t,n,r){var a=e?.get(t.localCandidateId),o=e?.get(t.remoteCandidateId);if(o&&a){var c=o.ip!==void 0?o.ip:o.address,d=o.port,h="".concat(c,":").concat(d),v=a.ip!==void 0?a.ip:a.address,m=a.port,y="".concat(v,":").concat(m),E=o.protocol;n.some(T=>T.ip===h&&T.type===E&&T.localIp===y)||n.push({ip:h,type:E,localIp:y,isFocus:r,localCandidateType:a.candidateType,remoteCandidateType:o.candidateType,networkType:a.networkType,rtt:t.currentRoundTripTime?t.currentRoundTripTime*1e3:NaN})}return n}}class SN{constructor(){b(this,"ssrcToMid",{local:new Map,remote:new Map})}findMidBySsrc(e,t){var n;return this.ssrcToMid[t].forEach((r,a)=>{if(r.find(o=>o==e)){n=a;return}}),n}parse(e,t){var n=Dg.parse(e),r=new Map;n.media.forEach(a=>{if(a.mid&&a.type==="video"||a.type==="audio"){var o,c=[];(o=a.ssrcs)===null||o===void 0||o.forEach(d=>{d.attribute==="cname"&&c.push("".concat(d.id))}),r.set("".concat(a.mid),c)}}),this.ssrcToMid[t]=r}getSsrcToMidMap(e){return this.ssrcToMid[e]}}class EN{constructor(e){this.pc=e}getLocalTracks(e){var t=n=>n!==null&&n.kind===e;return this.pc.getTransceivers().filter(n=>n.currentDirection==="sendonly"||n.currentDirection==="sendrecv").filter(n=>n.sender!==null).map(n=>n.sender).map(n=>n.track).filter(t)}getTackById(e){return this.pc.getTransceivers().map(t=>{if(t?.sender.track!==null&&t.sender.track.id===e)return t.sender.track;if(t?.receiver.track!==null&&t.receiver.track.id===e)return t.receiver.track}).find(t=>t!==void 0)}getLocalTrackIdByMid(e){var t,n=this.pc.getTransceivers().find(r=>r.mid===e);return n==null||(t=n.sender)===null||t===void 0||(t=t.track)===null||t===void 0?void 0:t.id}getRemoteTrackIdByMid(e){var t,n=this.pc.getTransceivers().find(r=>r.mid===e);return n==null||(t=n.receiver)===null||t===void 0||(t=t.track)===null||t===void 0?void 0:t.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(e){return this.pc.getTransceivers().find(t=>t.receiver.track.id===e||t.sender.track!==null&&t.sender.track.id===e)}}class TN{constructor(e,t,n){this.trackId=e,this.type=t,this.kind=n,b(this,"loss",{packetsTotal:0,packetsLost:0,isDownloadStream:!1}),b(this,"bitrate",{download:0,upload:0}),b(this,"resolution",{width:-1,height:-1}),b(this,"audioConcealment",{concealedAudio:0,totalAudioDuration:0}),b(this,"framerate",0),b(this,"jitter",0),b(this,"codec",""),b(this,"isAlive",!0),b(this,"isMuted",!1),b(this,"isEnabled",!0)}getType(){return this.type}setLoss(e){this.loss=e}getLoss(){return this.loss}setResolution(e){this.resolution=e}getResolution(){return this.resolution}setFramerate(e){this.framerate=e}getFramerate(){return this.framerate}setBitrate(e){this.bitrate=e}getBitrate(){return this.bitrate}setCodec(e){return this.codec=e,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(e){this.isAlive=e}get alive(){return this.isAlive}set muted(e){this.isMuted=e}get muted(){return this.isMuted}set enabled(e){this.isEnabled=e}get enabled(){return this.isEnabled}setJitter(e){this.jitter=e}getJitter(){return this.jitter}setAudioConcealment(e,t){this.audioConcealment.concealedAudio=e,this.audioConcealment.totalAudioDuration=t}getAudioConcealment(){return this.audioConcealment}}class _N{constructor(e,t){this.mediaSsrcHandler=e,this.mediaTrackHandler=t,b(this,"track2stats",new Map)}findTrack2Stats(e,t){var n;if(e.trackIdentifier)n=e.trackIdentifier;else if(e.mid)n=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid);else if(e.ssrc){var r=this.mediaSsrcHandler.findMidBySsrc(e.ssrc,t);if(!r)return;n=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid)}if(n){var a=this.track2stats.get(n);if(!a){var o=this.mediaTrackHandler.getTackById(n);if(o!==void 0){var c=o.kind==="audio"?o.kind:"video";a=new TN(n,t,c),this.track2stats.set(n,a)}else return}return a}}findLocalVideoTrackStats(e){var t=this.mediaTrackHandler.getLocalTracks("video");if(t.length!==0)return this.findTrack2Stats(e,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(e){return this.mediaTrackHandler.getTransceiverByTrackId(e)}}class _s{static getNonNegativeValue(e){var t=e;return typeof t!="number"&&(t=Number(t)),isNaN(t)?0:Math.max(0,t)}}class li{static buildFramerateResolution(e,t){var n={height:t.frameHeight,width:t.frameWidth},r=t.framesPerSecond;n.height&&n.width&&e.setResolution(n),e.setFramerate(Math.round(r||0))}static calculateSimulcastFramerate(e,t,n,r){var a=e.getFramerate();if(!a){if(n){var o=t.timestamp-n.timestamp;if(o>0&&t.framesSent){var c=t.framesSent-n.framesSent;a=c/o*1e3}}if(!a)return}a=r?Math.round(a/r):0,e.setFramerate(a)}static buildCodec(e,t,n){var r=e?.get(n.codecId);if(r){var a=r.mimeType.split("/")[1];a&&t.setCodec(a)}}static buildBitrateReceived(e,t,n){e.setBitrate({download:li.calculateBitrate(t.bytesReceived,n.bytesReceived,t.timestamp,n.timestamp),upload:0})}static buildBitrateSend(e,t,n){e.setBitrate({download:0,upload:this.calculateBitrate(t.bytesSent,n.bytesSent,t.timestamp,n.timestamp)})}static buildPacketsLost(e,t,n){var r=t.type==="outbound-rtp"?"packetsSent":"packetsReceived",a=t[r];(!a||a<0)&&(a=0);var o=_s.getNonNegativeValue(n[r]),c=Math.max(0,a-o),d=_s.getNonNegativeValue(t.packetsLost),h=_s.getNonNegativeValue(n.packetsLost),v=Math.max(0,d-h);e.setLoss({packetsTotal:c+v,packetsLost:v,isDownloadStream:t.type!=="outbound-rtp"})}static calculateBitrate(e,t,n,r){var a=_s.getNonNegativeValue(e),o=_s.getNonNegativeValue(t),c=Math.max(0,a-o),d=n-r,h=0;return d>0&&(h=Math.round(c*8/d)),h}static setTrackStatsState(e,t){var n;if(t===void 0){e.alive=!1;return}var r=e.getType()==="remote"?t.receiver.track:t==null||(n=t.sender)===null||n===void 0?void 0:n.track;if(r==null){e.alive=!1;return}if(r.readyState==="ended"){e.alive=!1;return}e.muted=r.muted,e.enabled=r.enabled,e.alive=!0}static buildTrackSummary(e){var t={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},n={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},r=e.filter(o=>o.getType()==="remote"),a=r.filter(o=>o.kind==="audio");return r.forEach(o=>{var c=o.kind==="video"?t:n;if(c.count++,o.alive&&o.muted&&c.muted++,c.maxJitter<o.getJitter()&&(c.maxJitter=o.getJitter()),c.maxPacketLoss<o.getLoss().packetsLost&&(c.maxPacketLoss=o.getLoss().packetsLost),a.length>0){var d,h;c.concealedAudio+=(d=o.getAudioConcealment())===null||d===void 0?void 0:d.concealedAudio,c.totalAudio+=(h=o.getAudioConcealment())===null||h===void 0?void 0:h.totalAudioDuration}}),{audioTrackSummary:n,videoTrackSummary:t}}static buildJitter(e,t){if(t.type==="inbound-rtp"){var n=t?.jitter;if(n!==void 0){var r=_s.getNonNegativeValue(n);e.setJitter(Math.round(r*1e3))}else e.setJitter(-1)}}static buildAudioConcealment(e,t){if(t.type==="inbound-rtp"){var n=1e3*t?.totalSamplesDuration/t?.totalSamplesReceived,r=n*t?.concealedSamples,a=1e3*t?.totalSamplesDuration;e.setAudioConcealment(r,a)}}}class Yc{static build(e){var t={},n={download:0,upload:0},r={download:0,upload:0},a=0,o=0,c={local:new Map,remote:new Map},d={local:new Map,remote:new Map},h={local:new Map,remote:new Map},v=new Map,m=new Map,y=0,E=0,T=0,S=0,O=0,R=0;for(var[I,M]of e){var C=M.getLoss(),k=C.isDownloadStream?"download":"upload";if(n[k]+=C.packetsTotal,r[k]+=C.packetsLost,a+=M.getBitrate().download,o+=M.getBitrate().upload,M.kind==="audio"){var _=M.getAudioConcealment();O+=_.concealedAudio,R+=_.totalAudioDuration,y+=M.getBitrate().download,E+=M.getBitrate().upload}else T+=M.getBitrate().download,S+=M.getBitrate().upload;c[M.getType()].set(I,M.getResolution()),d[M.getType()].set(I,M.getFramerate()),h[M.getType()].set(I,M.getCodec()),M.getType()==="remote"&&(v.set(I,M.getJitter()),M.kind==="audio"&&m.set(I,M.getAudioConcealment())),M.resetBitrate()}return t.bitrate={upload:o,download:a},t.bitrate.audio={upload:E,download:y},t.bitrate.video={upload:S,download:T},t.packetLoss={total:Yc.calculatePacketLoss(r.download+r.upload,n.download+n.upload),download:Yc.calculatePacketLoss(r.download,n.download),upload:Yc.calculatePacketLoss(r.upload,n.upload)},t.audioConcealment=m,t.totalAudioConcealment={concealedAudio:O,totalAudioDuration:R},t.framerate=d,t.resolution=c,t.codec=h,t.jitter=v,t}static calculatePacketLoss(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}}class Ua{static buildCallFeedReport(e,t,n){var r=n.getTransceivers(),a=[],o=[];return r.forEach(c=>{var d,h=(d=c.sender)!==null&&d!==void 0&&d.track?Ua.buildTrackStats(c.sender.track,"sender"):null,v=Ua.buildTrackStats(c.receiver.track,"receiver");a.push({mid:c.mid==null?"null":c.mid,direction:c.direction,currentDirection:c.currentDirection==null?"null":c.currentDirection,sender:h,receiver:v})}),{callId:e,opponentMemberId:t,transceiver:a,callFeeds:o}}static buildTrackStats(e){var t,n,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"--",a=(t=e.getSettings())===null||t===void 0?void 0:t.deviceId,o=(n=e.getConstraints())===null||n===void 0?void 0:n.deviceId;return{id:e.id,kind:e.kind,settingDeviceId:a??"unknown",constrainDeviceId:o??"unknown",muted:e.muted,enabled:e.enabled,readyState:e.readyState,label:r}}static expandCallFeedReport(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unknown";return t.forEach(r=>{var a=r.stream.getAudioTracks(),o=r.stream.getVideoTracks(),c=a.length>0?Ua.buildTrackStats(r.stream.getAudioTracks()[0],r.purpose):null,d=o.length>0?Ua.buildTrackStats(r.stream.getVideoTracks()[0],r.purpose):null,h={stream:r.stream.id,type:r.isLocal()?"local":"remote",audio:c,video:d,purpose:r.purpose,prefix:n,isVideoMuted:r.isVideoMuted(),isAudioMuted:r.isAudioMuted()};e.callFeeds.push(h)}),e}}function tC(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function sh(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?tC(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):tC(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}class CN{constructor(e,t,n,r){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;this.callId=e,this.opponentMemberId=t,this.pc=n,this.emitter=r,this.isFocus=a,b(this,"isActive",!0),b(this,"previousStatsReport",void 0),b(this,"currentStatsReport",void 0),b(this,"connectionStats",new gN),b(this,"trackStats",void 0),n.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new _N(new SN,new EN(n))}processStats(e,t){var n=this;return A(function*(){var r={isFirstCollection:n.previousStatsReport===void 0,receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0},videoTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0}};if(n.isActive){var a=n.pc.getStats();if(typeof a?.then=="function")return a.then(o=>{var c,d;n.currentStatsReport=typeof o?.result=="function"?o.result():o;try{n.processStatsReport(e,t)}catch(v){return n.handleError(v),r}n.previousStatsReport=n.currentStatsReport,r.receivedMedia=n.connectionStats.bitrate.download,r.receivedAudioMedia=((c=n.connectionStats.bitrate.audio)===null||c===void 0?void 0:c.download)||0,r.receivedVideoMedia=((d=n.connectionStats.bitrate.video)===null||d===void 0?void 0:d.download)||0;var h=li.buildTrackSummary(Array.from(n.trackStats.getTrack2stats().values()));return sh(sh({},r),{},{audioTrackSummary:h.audioTrackSummary,videoTrackSummary:h.videoTrackSummary})}).catch(o=>(n.handleError(o),r));n.isActive=!1}return Promise.resolve(r)})()}processStatsReport(e,t){var n,r=new Map;r.callId=this.callId,r.opponentMemberId=this.opponentMemberId,(n=this.currentStatsReport)===null||n===void 0||n.forEach(a=>{var o=this.previousStatsReport?this.previousStatsReport.get(a.id):null;if(a.type==="candidate-pair"&&a.nominated&&a.state==="succeeded")this.connectionStats.bandwidth=yN.buildBandwidthReport(a),this.connectionStats.transport=bN.buildReport(this.currentStatsReport,a,this.connectionStats.transport,this.isFocus);else if(a.type==="inbound-rtp"||a.type==="outbound-rtp"){var c=this.trackStats.findTrack2Stats(a,a.type==="inbound-rtp"?"remote":"local");if(!c)return;if(o&&li.buildPacketsLost(c,a,o),a.type==="inbound-rtp"){li.buildFramerateResolution(c,a),o&&li.buildBitrateReceived(c,a,o);var d=this.trackStats.findTransceiverByTrackId(c.trackId);li.setTrackStatsState(c,d),li.buildJitter(c,a),li.buildAudioConcealment(c,a)}else o&&(r.set(c.trackId,_s.getNonNegativeValue(a.bytesSent)),li.buildBitrateSend(c,a,o));li.buildCodec(this.currentStatsReport,c,a)}else if(a.type==="track"&&a.kind==="video"&&!a.remoteSource){var h=this.trackStats.findLocalVideoTrackStats(a);if(!h)return;li.buildFramerateResolution(h,a),li.calculateSimulcastFramerate(h,a,o,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}}),this.emitter.emitByteSendReport(r),this.emitter.emitCallFeedReport(Ua.buildCallFeedReport(this.callId,this.opponentMemberId,this.pc)),this.processAndEmitConnectionStatsReport()}setActive(e){this.isActive=e}getActive(){return this.isActive}handleError(e){this.isActive=!1,D.warn("CallStatsReportGatherer ".concat(this.callId," processStatsReport fails and set to inactive ").concat(e))}processAndEmitConnectionStatsReport(){var e=Yc.build(this.trackStats.getTrack2stats());e.callId=this.callId,e.opponentMemberId=this.opponentMemberId,this.connectionStats.bandwidth=e.bandwidth,this.connectionStats.bitrate=e.bitrate,this.connectionStats.packetLoss=e.packetLoss,this.emitter.emitConnectionStatsReport(sh(sh({},e),{},{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){this.pc.signalingState==="stable"&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}setOpponentMemberId(e){this.opponentMemberId=e}}var Wr=(function(i){return i.CONNECTION_STATS="StatsReport.connection_stats",i.CALL_FEED_REPORT="StatsReport.call_feed_report",i.BYTE_SENT_STATS="StatsReport.byte_sent_stats",i.SUMMARY_STATS="StatsReport.summary_stats",i})({});class RN extends Ot{emitByteSendReport(e){this.emit(Wr.BYTE_SENT_STATS,e)}emitConnectionStatsReport(e){this.emit(Wr.CONNECTION_STATS,e)}emitCallFeedReport(e){this.emit(Wr.CALL_FEED_REPORT,e)}emitSummaryStatsReport(e){this.emit(Wr.SUMMARY_STATS,e)}}class kw{constructor(e){this.emitter=e}build(e){var t=e.filter(v=>!v.isFirstCollection),n=t.length,r=e.length;if(n!==0){var a={receivedAudio:0,receivedVideo:0,receivedMedia:0,concealedAudio:0,totalAudio:0},o=0,c=0;t.forEach(v=>{this.countTrackListReceivedMedia(a,v),this.countConcealedAudio(a,v),o=this.buildMaxJitter(o,v),c=this.buildMaxPacketLoss(c,v)});var d=5,h={percentageReceivedMedia:Number((a.receivedMedia/n).toFixed(d)),percentageReceivedVideoMedia:Number((a.receivedVideo/n).toFixed(d)),percentageReceivedAudioMedia:Number((a.receivedAudio/n).toFixed(d)),maxJitter:o,maxPacketLoss:c,percentageConcealedAudio:Number(a.totalAudio>0?(a.concealedAudio/a.totalAudio).toFixed(d):0),peerConnections:r};this.emitter.emitSummaryStatsReport(h)}}static extendSummaryReport(e,t){var n=[],r=[];for(var a of t){r.push(a);for(var o of a[1])n.push(o)}e.opponentDevicesInCall=Math.max(0,n.length-1),e.opponentUsersInCall=Math.max(0,r.length-1),e.diffDevicesToPeerConnections=Math.max(0,n.length-1)-e.peerConnections,e.ratioPeerConnectionToDevices=Math.max(0,n.length-1)==0?0:e.peerConnections/(n.length-1)}countTrackListReceivedMedia(e,t){var n=!1,r=!1;(t.receivedAudioMedia>0||t.audioTrackSummary.count===0)&&(e.receivedAudio++,n=!0),(t.receivedVideoMedia>0||t.videoTrackSummary.count===0||t.videoTrackSummary.muted>0&&t.videoTrackSummary.muted===t.videoTrackSummary.count)&&(e.receivedVideo++,r=!0),r&&n&&e.receivedMedia++}buildMaxJitter(e,t){return e<t.videoTrackSummary.maxJitter&&(e=t.videoTrackSummary.maxJitter),e<t.audioTrackSummary.maxJitter&&(e=t.audioTrackSummary.maxJitter),e}buildMaxPacketLoss(e,t){return e<t.videoTrackSummary.maxPacketLoss&&(e=t.videoTrackSummary.maxPacketLoss),e<t.audioTrackSummary.maxPacketLoss&&(e=t.audioTrackSummary.maxPacketLoss),e}countConcealedAudio(e,t){e.concealedAudio+=t.audioTrackSummary.concealedAudio,e.totalAudio+=t.audioTrackSummary.totalAudio}}class kN{constructor(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1e4;this.groupCallId=e,this.userId=t,this.interval=n,b(this,"timer",void 0),b(this,"gatherers",new Map),b(this,"reports",new RN),b(this,"summaryStatsReportGatherer",new kw(this.reports))}start(){this.timer===void 0&&this.interval>0&&(this.timer=setInterval(()=>{this.processStats()},this.interval))}stop(){this.timer!==void 0&&(clearInterval(this.timer),this.gatherers.forEach(e=>e.stopProcessingStats()))}hasStatsReportGatherer(e){return this.gatherers.has(e)}addStatsReportGatherer(e,t,n){return this.hasStatsReportGatherer(e)?!1:(this.gatherers.set(e,new CN(e,t,n,this.reports)),!0)}removeStatsReportGatherer(e){return this.gatherers.delete(e)}getStatsReportGatherer(e){return this.hasStatsReportGatherer(e)?this.gatherers.get(e):void 0}updateOpponentMember(e,t){var n;(n=this.getStatsReportGatherer(e))===null||n===void 0||n.setOpponentMemberId(t)}processStats(){var e=[];this.gatherers.forEach(t=>{e.push(t.processStats(this.groupCallId,this.userId))}),Promise.all(e).then(t=>this.summaryStatsReportGatherer.build(t)).catch(t=>{D.error("Could not build summary stats report",t)})}setInterval(e){this.interval=e}}function nC(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function oh(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?nC(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):nC(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}var ww=(function(i){return i.Ring="m.ring",i.Prompt="m.prompt",i.Room="m.room",i})({}),Df=(function(i){return i.Video="m.video",i.Voice="m.voice",i})({}),wN=(function(i){return i.CallEnded="call_ended",i})({}),yt=(function(i){return i.GroupCallStateChanged="group_call_state_changed",i.ActiveSpeakerChanged="active_speaker_changed",i.CallsChanged="calls_changed",i.UserMediaFeedsChanged="user_media_feeds_changed",i.ScreenshareFeedsChanged="screenshare_feeds_changed",i.LocalScreenshareStateChanged="local_screenshare_state_changed",i.LocalMuteStateChanged="local_mute_state_changed",i.ParticipantsChanged="participants_changed",i.Error="group_call_error",i})({}),qc=(function(i){return i.ConnectionStats="GroupCall.connection_stats",i.ByteSentStats="GroupCall.byte_sent_stats",i.SummaryStats="GroupCall.summary_stats",i.CallFeedStats="GroupCall.call_feed_stats",i})({}),$c=(function(i){return i.NoUserMedia="no_user_media",i.UnknownDevice="unknown_device",i.PlaceCallFailed="place_call_failed",i})({});class Bg extends Error{constructor(e,t,n){n?(super(t+": "+n),b(this,"code",void 0)):(super(t),b(this,"code",void 0)),this.code=e}}class Iw extends Bg{constructor(e){super($c.UnknownDevice,"No device found for "+e),this.userId=e}}var Dt=(function(i){return i.LocalCallFeedUninitialized="local_call_feed_uninitialized",i.InitializingLocalCallFeed="initializing_local_call_feed",i.LocalCallFeedInitialized="local_call_feed_initialized",i.Entered="entered",i.Ended="ended",i})({}),iC=1e3*60*60;function lh(i){var e;return((e=i.getOpponentMember())===null||e===void 0?void 0:e.userId)||i.invitee||null}class tb extends Ot{constructor(e,t,n,r,a,o,c,d,h){var v,m,y=arguments.length>9&&arguments[9]!==void 0?arguments[9]:!1,E=arguments.length>10?arguments[10]:void 0;super(),this.client=e,this.room=t,this.type=n,this.isPtt=r,this.intent=a,this.dataChannelsEnabled=c,this.dataChannelOptions=d,this.useLivekit=y,b(this,"activeSpeakerInterval",1e3),b(this,"retryCallInterval",5e3),b(this,"participantTimeout",1e3*15),b(this,"pttMaxTransmitTime",1e3*20),b(this,"activeSpeaker",void 0),b(this,"localCallFeed",void 0),b(this,"localScreenshareFeed",void 0),b(this,"localDesktopCapturerSourceId",void 0),b(this,"userMediaFeeds",[]),b(this,"screenshareFeeds",[]),b(this,"groupCallId",void 0),b(this,"allowCallWithoutVideoAndAudio",void 0),b(this,"calls",new Map),b(this,"callHandlers",new Map),b(this,"activeSpeakerLoopInterval",void 0),b(this,"retryCallLoopInterval",void 0),b(this,"retryCallCounts",new Map),b(this,"reEmitter",void 0),b(this,"transmitTimer",null),b(this,"participantsExpirationTimer",null),b(this,"resendMemberStateTimer",null),b(this,"initWithAudioMuted",!1),b(this,"initWithVideoMuted",!1),b(this,"initCallFeedPromise",void 0),b(this,"_livekitServiceURL",void 0),b(this,"stats",void 0),b(this,"statsCollectIntervalTime",0),b(this,"onConnectionStats",T=>{this.emit(qc.ConnectionStats,{report:T})}),b(this,"onByteSentStats",T=>{this.emit(qc.ByteSentStats,{report:T})}),b(this,"onSummaryStats",T=>{kw.extendSummaryReport(T,this.participants),this.emit(qc.SummaryStats,{report:T})}),b(this,"onCallFeedReport",T=>{this.localCallFeed&&(T=Ua.expandCallFeedReport(T,[this.localCallFeed],"from-local-feed"));var S=[];this.forEachCall(O=>{O.callId===T.callId&&O.getFeeds().forEach(R=>S.push(R))}),T=Ua.expandCallFeedReport(T,S,"from-call-feed"),this.emit(qc.CallFeedStats,{report:T})}),b(this,"_state",Dt.LocalCallFeedUninitialized),b(this,"_participants",new Map),b(this,"_creationTs",null),b(this,"_enteredViaAnotherSession",!1),b(this,"onIncomingCall",T=>{var S,O;if(T.roomId===this.room.roomId){if(T.state!==Me.Ringing){D.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call no longer in ringing state - ignoring"));return}if(!T.groupCallId||T.groupCallId!==this.groupCallId){D.log("GroupCall ".concat(this.groupCallId," onIncomingCall() ignored because it doesn't match the current group call")),T.reject();return}var R=(S=T.getOpponentMember())===null||S===void 0?void 0:S.userId;if(R===void 0){D.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call with no member - ignoring"));return}if(this.useLivekit){D.info("Received incoming call whilst in signaling-only mode! Ignoring.");return}var I=(O=this.calls.get(R))!==null&&O!==void 0?O:new Map,M=I.get(T.getOpponentDeviceId());if(M?.callId!==T.callId){D.log("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call (userId=").concat(R,", callId=").concat(T.callId,")")),M&&M.hangup(Ue.Replaced,!1),I.set(T.getOpponentDeviceId(),T),this.calls.set(R,I),this.initCall(T);var C=this.getLocalFeeds().map(_=>_.clone());if(!this.callExpected(T))for(var k of C)Yt(k.stream.getAudioTracks(),!1),Yt(k.stream.getVideoTracks(),!1);T.answerWithCallFeeds(C),this.emit(yt.CallsChanged,this.calls)}}}),b(this,"onRetryCallLoop",()=>{var T=!1;for(var[{userId:S},O]of this.participants){var R=this.calls.get(S),I=this.retryCallCounts.get(S);for(var[M,C]of O){var k,_,P=R?.get(M),x=(k=(_=I)===null||_===void 0?void 0:_.get(M))!==null&&k!==void 0?k:0;P?.getOpponentSessionId()!==C.sessionId&&this.wantsOutgoingCall(S,M)&&x<3&&(I===void 0&&(I=new Map,this.retryCallCounts.set(S,I)),I.set(M,x+1),T=!0)}}T&&this.placeOutgoingCalls()}),b(this,"onCallFeedsChanged",T=>{var S=lh(T),O=T.getOpponentDeviceId();if(!S)throw new Error("Cannot change call feeds without user id");var R=this.getUserMediaFeed(S,O),I=T.remoteUsermediaFeed,M=I!==R,C=this.calls.get(S),k=C?.get(O);if(k?.callId===T.callId){M&&(!R&&I?this.addUserMediaFeed(I):R&&I?this.replaceUserMediaFeed(R,I):R&&!I&&this.removeUserMediaFeed(R));var _=this.getScreenshareFeed(S,O),P=T.remoteScreensharingFeed,x=P!==_;x&&(!_&&P?this.addScreenshareFeed(P):_&&P?this.replaceScreenshareFeed(_,P):_&&!P&&this.removeScreenshareFeed(_))}}),b(this,"onCallStateChanged",(T,S,O)=>{var R;if(S!==Me.Ended){var I=this.localCallFeed.isAudioMuted();T.localUsermediaStream&&T.isMicrophoneMuted()!==I&&T.setMicrophoneMuted(I);var M=this.localCallFeed.isVideoMuted();T.localUsermediaStream&&T.isLocalVideoMuted()!==M&&T.setLocalVideoMuted(M);var C=(R=T.getOpponentMember())===null||R===void 0?void 0:R.userId;if(S===Me.Connected&&C){var k=this.retryCallCounts.get(C);k?.delete(T.getOpponentDeviceId()),k?.size===0&&this.retryCallCounts.delete(C)}}}),b(this,"onCallHangup",T=>{var S,O;if(T.hangupReason!==Ue.Replaced){var R=(S=(O=T.getOpponentMember())===null||O===void 0?void 0:O.userId)!==null&&S!==void 0?S:this.room.getMember(T.invitee).userId,I=this.calls.get(R);I?.get(T.getOpponentDeviceId())===T&&(this.disposeCall(T,T.hangupReason),I.delete(T.getOpponentDeviceId()),I.size===0&&this.calls.delete(R),this.emit(yt.CallsChanged,this.calls))}}),b(this,"onCallReplaced",(T,S)=>{var O=T.getOpponentMember().userId,R=this.calls.get(O);R===void 0&&(R=new Map,this.calls.set(O,R)),T.hangup(Ue.Replaced,!1),this.initCall(S),R.set(T.getOpponentDeviceId(),S),this.emit(yt.CallsChanged,this.calls)}),b(this,"onActiveSpeakerLoop",()=>{var T=void 0,S=void 0;for(var O of this.userMediaFeeds)if(!(O.isLocal()&&this.userMediaFeeds.length>1)){var R=O.speakingVolumeSamples.reduce((M,C)=>M+Math.max(C,xg)),I=R/O.speakingVolumeSamples.length;(!T||I>T)&&(T=I,S=O)}S&&this.activeSpeaker!==S&&T&&T>xg&&(this.activeSpeaker=S,this.emit(yt.ActiveSpeakerChanged,this.activeSpeaker))}),b(this,"onRoomState",()=>this.updateParticipants()),b(this,"onParticipantsChanged",()=>{this.forEachCall(T=>{var S=this.callExpected(T);for(var O of T.getLocalFeeds())Yt(O.stream.getAudioTracks(),!O.isAudioMuted()&&S),Yt(O.stream.getVideoTracks(),!O.isVideoMuted()&&S)}),this.state===Dt.Entered&&!this.useLivekit&&this.placeOutgoingCalls()}),b(this,"onStateChanged",(T,S)=>{(T===Dt.Entered||S===Dt.Entered||T===Dt.Ended)&&(this.updateParticipants(),this.updateMemberState().catch(O=>D.error("GroupCall ".concat(this.groupCallId,' onStateChanged() failed to update member state devices"'),O)))}),b(this,"onLocalFeedsChanged",()=>{this.state===Dt.Entered&&this.updateMemberState().catch(T=>D.error("GroupCall ".concat(this.groupCallId," onLocalFeedsChanged() failed to update member state feeds"),T))}),this.reEmitter=new Wk(this),this.groupCallId=o??Cs(),this._livekitServiceURL=E,this.creationTs=(v=(m=t.currentState.getStateEvents(G.GroupCallPrefix,this.groupCallId))===null||m===void 0?void 0:m.getTs())!==null&&v!==void 0?v:null,this.updateParticipants(),t.on(Ke.Update,this.onRoomState),this.on(yt.ParticipantsChanged,this.onParticipantsChanged),this.on(yt.GroupCallStateChanged,this.onStateChanged),this.on(yt.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!h}create(){var e=this;return A(function*(){return e.creationTs=Date.now(),e.client.groupCallEventHandler.groupCalls.set(e.room.roomId,e),e.client.emit(Ug.Outgoing,e),yield e.sendCallStateEvent(),e})()}sendCallStateEvent(){var e=this;return A(function*(){var t={"m.intent":e.intent,"m.type":e.type,"io.element.ptt":e.isPtt,dataChannelsEnabled:e.dataChannelsEnabled,dataChannelOptions:e.dataChannelsEnabled?e.dataChannelOptions:void 0};e.livekitServiceURL&&(t["io.element.livekit_service_url"]=e.livekitServiceURL),yield e.client.sendStateEvent(e.room.roomId,G.GroupCallPrefix,t,e.groupCallId)})()}get livekitServiceURL(){return this._livekitServiceURL}updateLivekitServiceURL(e){return this._livekitServiceURL=e,this.sendCallStateEvent()}get state(){return this._state}set state(e){var t=this._state;e!==t&&(this._state=e,this.emit(yt.GroupCallStateChanged,e,t))}get participants(){return this._participants}set participants(e){var t=this._participants,n=(a,o)=>a.sessionId===o.sessionId&&a.screensharing===o.screensharing,r=(a,o)=>s_(a,o,n);s_(e,t,r)||(this._participants=e,this.emit(yt.ParticipantsChanged,e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(var t of this.calls.values())for(var n of t.values())e(n)}getLocalFeeds(){var e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e,t;return(e=(t=this.participants.get(this.room.getMember(this.client.getUserId())))===null||t===void 0?void 0:t.has(this.client.getDeviceId()))!==null&&e!==void 0?e:!1}callExpected(e){var t,n=lh(e),r=n===null?null:this.room.getMember(n),a=e.getOpponentDeviceId();return r!==null&&a!==void 0&&((t=this.participants.get(r))===null||t===void 0?void 0:t.get(a))!==void 0}initLocalCallFeed(){var e=this;return A(function*(){if(e.useLivekit){D.info("Livekit group call: not starting local call feed.");return}if(e.state!==Dt.LocalCallFeedUninitialized)throw new Error('Cannot initialize local call feed in the "'.concat(e.state,'" state.'));if(e.state=Dt.InitializingLocalCallFeed,e.initCallFeedPromise)return e.initCallFeedPromise;try{e.initCallFeedPromise=e.initLocalCallFeedInternal(),yield e.initCallFeedPromise}finally{e.initCallFeedPromise=void 0}})()}initLocalCallFeedInternal(){var e=this;return A(function*(){D.log("GroupCall ".concat(e.groupCallId," initLocalCallFeedInternal() running"));var t;try{t=yield e.client.getMediaHandler().getUserMediaStream(!0,e.type===Df.Video)}catch(r){if(e.allowCallWithoutVideoAndAudio)t=new MediaStream;else throw e.state=Dt.LocalCallFeedUninitialized,r}if(e._state!==Dt.InitializingLocalCallFeed)throw e.client.getMediaHandler().stopUserMediaStream(t),new Error("Group call disposed while gathering media stream");var n=new qr({client:e.client,roomId:e.room.roomId,userId:e.client.getUserId(),deviceId:e.client.getDeviceId(),stream:t,purpose:bt.Usermedia,audioMuted:e.initWithAudioMuted||t.getAudioTracks().length===0||e.isPtt,videoMuted:e.initWithVideoMuted||t.getVideoTracks().length===0});Yt(t.getAudioTracks(),!n.isAudioMuted()),Yt(t.getVideoTracks(),!n.isVideoMuted()),e.localCallFeed=n,e.addUserMediaFeed(n),e.state=Dt.LocalCallFeedInitialized})()}updateLocalUsermediaStream(e){var t=this;return A(function*(){if(t.localCallFeed){var n=t.localCallFeed.stream;t.localCallFeed.setNewStream(e);var r=t.localCallFeed.isAudioMuted(),a=t.localCallFeed.isVideoMuted();D.log("GroupCall ".concat(t.groupCallId," updateLocalUsermediaStream() (oldStreamId=").concat(n.id,", newStreamId=").concat(e.id,", micShouldBeMuted=").concat(r,", vidShouldBeMuted=").concat(a,")")),Yt(e.getAudioTracks(),!r),Yt(e.getVideoTracks(),!a),t.client.getMediaHandler().stopUserMediaStream(n)}})()}enter(){var e=this;return A(function*(){if(e.state===Dt.LocalCallFeedUninitialized)yield e.initLocalCallFeed();else if(e.state!==Dt.LocalCallFeedInitialized)throw new Error('Cannot enter call in the "'.concat(e.state,'" state'));D.log("GroupCall ".concat(e.groupCallId," enter() running")),e.state=Dt.Entered,e.client.on(Lg.Incoming,e.onIncomingCall);for(var t of e.client.callEventHandler.calls.values())e.onIncomingCall(t);e.useLivekit||(e.retryCallLoopInterval=setInterval(e.onRetryCallLoop,e.retryCallInterval),e.activeSpeaker=void 0,e.onActiveSpeakerLoop(),e.activeSpeakerLoopInterval=setInterval(e.onActiveSpeakerLoop,e.activeSpeakerInterval))})()}dispose(){var e;this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),this.transmitTimer!==null&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),this.retryCallLoopInterval!==void 0&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===Dt.Entered&&(this.forEachCall(t=>t.hangup(Ue.UserHangup,!1)),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(Lg.Incoming,this.onIncomingCall),(e=this.stats)===null||e===void 0||e.stop())}leave(){this.dispose(),this.state=Dt.LocalCallFeedUninitialized}terminate(){var e=arguments,t=this;return A(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:!0;if(t.dispose(),t.room.off(Ke.Update,t.onRoomState),t.client.groupCallEventHandler.groupCalls.delete(t.room.roomId),t.client.emit(Ug.Ended,t),t.state=Dt.Ended,n){var r=t.room.currentState.getStateEvents(G.GroupCallPrefix,t.groupCallId);yield t.client.sendStateEvent(t.room.roomId,G.GroupCallPrefix,oh(oh({},r.getContent()),{},{"m.terminated":wN.CallEnded}),t.groupCallId)}})()}isLocalVideoMuted(){return this.localCallFeed?this.localCallFeed.isVideoMuted():!0}isMicrophoneMuted(){return this.localCallFeed?this.localCallFeed.isAudioMuted():!0}setMicrophoneMuted(e){var t=this;return A(function*(){if(!e&&!(yield t.client.getMediaHandler().hasAudioDevice()))return!1;var n=!e&&t.isPtt;t.isPtt&&(!e&&t.isMicrophoneMuted()?t.transmitTimer=setTimeout(()=>{t.setMicrophoneMuted(!0)},t.pttMaxTransmitTime):e&&!t.isMicrophoneMuted()&&(t.transmitTimer!==null&&clearTimeout(t.transmitTimer),t.transmitTimer=null)),t.forEachCall(o=>{var c;return(c=o.localUsermediaFeed)===null||c===void 0?void 0:c.setAudioVideoMuted(e,null)});var r=(function(){var o=A(function*(){var c=[];t.forEachCall(d=>c.push(d.sendMetadataUpdate())),yield Promise.all(c).catch(d=>D.info("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() failed to send some metadata updates"),d))});return function(){return o.apply(this,arguments)}})();if(n&&(yield r()),t.localCallFeed){D.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() (streamId=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));var a=yield t.checkAudioPermissionIfNecessary(e);if(!a)return!1;t.localCallFeed.setAudioVideoMuted(e,null),Yt(t.localCallFeed.stream.getAudioTracks(),!e)}else D.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no stream muted (muted=").concat(e,")")),t.initWithAudioMuted=e;return t.forEachCall(o=>Yt(o.localUsermediaFeed.stream.getAudioTracks(),!e&&t.callExpected(o))),t.emit(yt.LocalMuteStateChanged,e,t.isLocalVideoMuted()),n||(yield r()),!0})()}checkAudioPermissionIfNecessary(e){var t=this;return A(function*(){try{if(!e&&t.localCallFeed&&!t.localCallFeed.hasAudioTrack){var n=yield t.client.getMediaHandler().getUserMediaStream(!0,!t.localCallFeed.isVideoMuted());if(n?.getTracks().length===0)return D.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device to receive local stream, muted=").concat(e)),!1}}catch{return D.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device or permission to receive local stream, muted=").concat(e)),!1}return!0})()}setLocalVideoMuted(e){var t=this;return A(function*(){if(!e&&!(yield t.client.getMediaHandler().hasVideoDevice()))return!1;if(t.localCallFeed){D.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() (stream=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));try{var n=yield t.client.getMediaHandler().getUserMediaStream(!0,!e);yield t.updateLocalUsermediaStream(n),t.localCallFeed.setAudioVideoMuted(null,e),Yt(t.localCallFeed.stream.getVideoTracks(),!e)}catch{return D.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no device or permission to receive local stream, muted=").concat(e)),!1}}else D.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no stream muted (muted=").concat(e,")")),t.initWithVideoMuted=e;var r=[];return t.forEachCall(a=>r.push(a.setLocalVideoMuted(e))),yield Promise.all(r),t.forEachCall(a=>Yt(a.localUsermediaFeed.stream.getVideoTracks(),!e&&t.callExpected(a))),t.emit(yt.LocalMuteStateChanged,t.isMicrophoneMuted(),e),!0})()}setScreensharingEnabled(e){var t=arguments,n=this;return A(function*(){var r=t.length>1&&t[1]!==void 0?t[1]:{};if(e===n.isScreensharing())return e;if(e)try{D.log("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() is asking for screensharing permissions"));var a=yield n.client.getMediaHandler().getScreensharingStream(r),o=function*(h){var v=()=>{n.setScreensharingEnabled(!1),h.removeEventListener("ended",v)};h.addEventListener("ended",v)};for(var c of a.getTracks())yield*o(c);return D.log("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls")),n.localDesktopCapturerSourceId=r.desktopCapturerSourceId,n.localScreenshareFeed=new qr({client:n.client,roomId:n.room.roomId,userId:n.client.getUserId(),deviceId:n.client.getDeviceId(),stream:a,purpose:bt.Screenshare,audioMuted:!1,videoMuted:!1}),n.addScreenshareFeed(n.localScreenshareFeed),n.emit(yt.LocalScreenshareStateChanged,!0,n.localScreenshareFeed,n.localDesktopCapturerSourceId),n.forEachCall(d=>d.pushLocalFeed(n.localScreenshareFeed.clone())),!0}catch(d){if(r.throwOnFail)throw d;return D.error("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() enabling screensharing error"),d),n.emit(yt.Error,new Bg($c.NoUserMedia,"Failed to get screen-sharing stream: ",d)),!1}else return n.forEachCall(d=>{d.localScreensharingFeed&&d.removeLocalFeed(d.localScreensharingFeed)}),n.client.getMediaHandler().stopScreensharingStream(n.localScreenshareFeed.stream),n.removeScreenshareFeed(n.localScreenshareFeed),n.localScreenshareFeed=void 0,n.localDesktopCapturerSourceId=void 0,n.emit(yt.LocalScreenshareStateChanged,!1,void 0,void 0),!1})()}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){var n=this.client.getUserId(),r=this.client.getDeviceId();return e>=n&&(e!==n||t>r)}placeOutgoingCalls(){var e=this,t=!1,n=function(c){var d,h=(d=e.calls.get(c))!==null&&d!==void 0?d:new Map,v=function(T){var S=h.get(T);if(S?.getOpponentSessionId()!==y.sessionId&&e.wantsOutgoingCall(c,T)){t=!0,S!==void 0&&(D.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() replacing call (userId=").concat(c,", deviceId=").concat(T,", callId=").concat(S.callId,")")),S.hangup(Ue.NewSession,!1));var O=ou(e.client,e.room.roomId,{invitee:c,opponentDeviceId:T,opponentSessionId:y.sessionId,groupCallId:e.groupCallId});O===null?(D.error("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to create call (userId=").concat(c,", device=").concat(T,")")),h.delete(T)):(e.initCall(O),h.set(T,O),D.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() placing call (userId=").concat(c,", deviceId=").concat(T,", sessionId=").concat(y.sessionId,")")),O.placeCallWithCallFeeds(e.getLocalFeeds().map(R=>R.clone()),y.screensharing).then(()=>{e.dataChannelsEnabled&&O.createDataChannel("datachannel",e.dataChannelOptions)}).catch(R=>{D.warn("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to place call (userId=").concat(c,")"),R),R instanceof Ur&&R.code===$c.UnknownDevice?e.emit(yt.Error,R):e.emit(yt.Error,new Bg($c.PlaceCallFailed,"Failed to place call to ".concat(c))),O.hangup(Ue.SignallingFailed,!1),h.get(T)===O&&h.delete(T)}))}};for(var[m,y]of a)v(m);h.size>0?e.calls.set(c,h):e.calls.delete(c)};for(var[{userId:r},a]of this.participants)n(r);t&&this.emit(yt.CallsChanged,this.calls)}getMemberStateEvents(e){return e===void 0?this.room.currentState.getStateEvents(G.GroupCallMemberPrefix):this.room.currentState.getStateEvents(G.GroupCallMemberPrefix,e)}initCall(e){var t=lh(e);if(!t)throw new Error("Cannot init call without user id");var n=()=>this.onCallFeedsChanged(e),r=(d,h)=>this.onCallStateChanged(e,d,h),a=this.onCallHangup,o=d=>this.onCallReplaced(e,d),c=this.callHandlers.get(t);c===void 0&&(c=new Map,this.callHandlers.set(t,c)),c.set(e.getOpponentDeviceId(),{onCallFeedsChanged:n,onCallStateChanged:r,onCallHangup:a,onCallReplaced:o}),e.on(qe.FeedsChanged,n),e.on(qe.State,r),e.on(qe.Hangup,a),e.on(qe.Replaced,o),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(qe)),e.initStats(this.getGroupCallStats()),n()}disposeCall(e,t){var n=lh(e),r=e.getOpponentDeviceId();if(!n)throw new Error("Cannot dispose call without user id");var a=this.callHandlers.get(n),{onCallFeedsChanged:o,onCallStateChanged:c,onCallHangup:d,onCallReplaced:h}=a.get(r);if(e.removeListener(qe.FeedsChanged,o),e.removeListener(qe.State,c),e.removeListener(qe.Hangup,d),e.removeListener(qe.Replaced,h),a.delete(n),a.size===0&&this.callHandlers.delete(n),e.hangupReason!==Ue.Replaced){var v=this.getUserMediaFeed(n,r);v&&this.removeUserMediaFeed(v);var m=this.getScreenshareFeed(n,r);m&&this.removeScreenshareFeed(m)}}getUserMediaFeed(e,t){return this.userMediaFeeds.find(n=>n.userId===e&&n.deviceId===t)}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit(yt.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(e,t){var n=this.userMediaFeeds.findIndex(r=>r.userId===e.userId&&r.deviceId===e.deviceId);if(n===-1)throw new Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(n,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit(yt.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(e){var t=this.userMediaFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit(yt.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(yt.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find(n=>n.userId===e&&n.deviceId===t)}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit(yt.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(e,t){var n=this.screenshareFeeds.findIndex(r=>r.userId===e.userId&&r.deviceId===e.deviceId);if(n===-1)throw new Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(n,1,t),e.dispose(),this.emit(yt.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(e){var t=this.screenshareFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit(yt.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){var e=this.room.getMember(this.client.getSafeUserId());if(!e){D.warn("GroupCall ".concat(this.groupCallId," updateParticipants() tried to update participants before local room member is available"));return}if(this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===Dt.Ended){this.participants=new Map;return}var t=new Map,n=Date.now(),r=this.state===Dt.Entered||this.enteredViaAnotherSession,a=1/0;for(var o of this.getMemberStateEvents()){var c=this.room.getMember(o.getStateKey()),d=o.getContent(),h=Array.isArray(d["m.calls"])?d["m.calls"]:[],v=h.find(O=>O["m.call_id"]===this.groupCallId),m=Array.isArray(v?.["m.devices"])?v["m.devices"]:[],y=m.filter(O=>typeof O.device_id=="string"&&typeof O.session_id=="string"&&typeof O.expires_ts=="number"&&O.expires_ts>n&&Array.isArray(O.feeds));if(!r&&c?.userId===this.client.getUserId()&&(y=y.filter(O=>O.device_id!==this.client.getDeviceId())),y.length>0&&c?.membership===Ne.Join){var E=new Map;t.set(c,E);for(var T of y)E.set(T.device_id,{sessionId:T.session_id,screensharing:T.feeds.some(O=>O.purpose===bt.Screenshare)}),T.expires_ts<a&&(a=T.expires_ts)}}if(r){var S=t.get(e);S===void 0&&(S=new Map,t.set(e,S)),S.has(this.client.getDeviceId())||S.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some(O=>O.purpose===bt.Screenshare)})}this.participants=t,a<1/0&&(this.participantsExpirationTimer=setTimeout(()=>this.updateParticipants(),a-n))}updateDevices(e){var t=arguments,n=this;return A(function*(){var r,a=t.length>1&&t[1]!==void 0?t[1]:!1,o=Date.now(),c=n.client.getUserId(),d=n.getMemberStateEvents(c),h=(r=d?.getContent())!==null&&r!==void 0?r:{},v=Array.isArray(h["m.calls"])?h["m.calls"]:[],m=null,y=[];for(var E of v)E["m.call_id"]===n.groupCallId?m=E:y.push(E);m===null&&(m={});var T=Array.isArray(m["m.devices"])?m["m.devices"]:[],S=T.filter(M=>typeof M.device_id=="string"&&typeof M.session_id=="string"&&typeof M.expires_ts=="number"&&M.expires_ts>o&&Array.isArray(M.feeds)),O=e(S);if(O!==null){var R=[...y];O.length>0&&R.push(oh(oh({},m),{},{"m.call_id":n.groupCallId,"m.devices":O}));var I={"m.calls":R};yield n.client.sendStateEvent(n.room.roomId,G.GroupCallMemberPrefix,I,c,{keepAlive:a})}})()}addDeviceToMemberState(){var e=this;return A(function*(){yield e.updateDevices(t=>[...t.filter(n=>n.device_id!==e.client.getDeviceId()),{device_id:e.client.getDeviceId(),session_id:e.client.getSessionId(),expires_ts:Date.now()+iC,feeds:e.getLocalFeeds().map(n=>({purpose:n.purpose}))}])})()}updateMemberState(){var e=this;return A(function*(){e.resendMemberStateTimer!==null&&(clearInterval(e.resendMemberStateTimer),e.resendMemberStateTimer=null),e.state===Dt.Entered?(yield e.addDeviceToMemberState(),e.resendMemberStateTimer=setInterval(A(function*(){D.log("GroupCall ".concat(e.groupCallId,' updateMemberState() resending call member state"'));try{yield e.addDeviceToMemberState()}catch(t){D.error("GroupCall ".concat(e.groupCallId," updateMemberState() failed to resend call member state"),t)}}),iC*3/4)):yield e.updateDevices(t=>t.filter(n=>n.device_id!==e.client.getDeviceId()),!0)})()}cleanMemberState(){var e=this;return A(function*(){var{devices:t}=yield e.client.getDevices(),n=new Map(t.map(r=>[r.device_id,r]));yield e.updateDevices(r=>{var a=r.filter(o=>{var c=n.get(o.device_id);return c?.last_seen_ts!==void 0&&!(o.device_id===e.client.getDeviceId()&&e.state!==Dt.Entered&&!e.enteredViaAnotherSession)});return a.length===r.length?null:a})})()}getGroupCallStats(){if(this.stats===void 0){var e=this.client.getUserId()||"unknown";this.stats=new kN(this.groupCallId,e,this.statsCollectIntervalTime),this.stats.reports.on(Wr.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(Wr.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(Wr.SUMMARY_STATS,this.onSummaryStats),this.stats.reports.on(Wr.CALL_FEED_REPORT,this.onCallFeedReport)}return this.stats}setGroupCallStatsInterval(e){this.statsCollectIntervalTime=e,this.stats!==void 0&&(this.stats.stop(),this.stats.setInterval(e),e>0&&this.stats.start())}}function rC(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function ch(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?rC(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):rC(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}var Me=(function(i){return i.Fledgling="fledgling",i.InviteSent="invite_sent",i.WaitLocalMedia="wait_local_media",i.CreateOffer="create_offer",i.CreateAnswer="create_answer",i.Connecting="connecting",i.Connected="connected",i.Ringing="ringing",i.Ended="ended",i})({}),aC=(function(i){return i.Voice="voice",i.Video="video",i})({}),Oa=(function(i){return i.Inbound="inbound",i.Outbound="outbound",i})({}),Lt=(function(i){return i.Local="local",i.Remote="remote",i})({}),qe=(function(i){return i.Hangup="hangup",i.State="state",i.Error="error",i.Replaced="replaced",i.LocalHoldUnhold="local_hold_unhold",i.RemoteHoldUnhold="remote_hold_unhold",i.HoldUnhold="hold_unhold",i.FeedsChanged="feeds_changed",i.AssertedIdentityChanged="asserted_identity_changed",i.LengthChanged="length_changed",i.DataChannel="datachannel",i.SendVoipEvent="send_voip_event",i.PeerConnectionCreated="peer_connection_created",i})({}),Ue=(function(i){return i.UserHangup="user_hangup",i.LocalOfferFailed="local_offer_failed",i.NoUserMedia="no_user_media",i.UnknownDevices="unknown_devices",i.SendInvite="send_invite",i.CreateAnswer="create_answer",i.CreateOffer="create_offer",i.SendAnswer="send_answer",i.SetRemoteDescription="set_remote_description",i.SetLocalDescription="set_local_description",i.AnsweredElsewhere="answered_elsewhere",i.IceFailed="ice_failed",i.InviteTimeout="invite_timeout",i.Replaced="replaced",i.SignallingFailed="signalling_timeout",i.UserBusy="user_busy",i.Transferred="transferred",i.NewSession="new_session",i})({}),IN="1",ON="stun:turn.matrix.org",Op=60*1e3,MN=1e3,PN=30*1e3,AN=2*1e3;class Ur extends Error{constructor(e,t,n){super(t+": "+n),b(this,"code",void 0),this.code=e}}function Cs(){return Date.now().toString()+Fa(16)}function sC(i){var e=[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:i?12e3:void 0}];return e}function xi(i,e){return i+":"+e}class DN extends Ot{constructor(e){var t,n;if(super(),t=this,b(this,"roomId",void 0),b(this,"callId",void 0),b(this,"invitee",void 0),b(this,"hangupParty",void 0),b(this,"hangupReason",void 0),b(this,"direction",void 0),b(this,"ourPartyId",void 0),b(this,"peerConn",void 0),b(this,"toDeviceSeq",0),b(this,"isPtt",!1),b(this,"_state",Me.Fledgling),b(this,"client",void 0),b(this,"forceTURN",void 0),b(this,"turnServers",void 0),b(this,"candidateSendQueue",[]),b(this,"candidateSendTries",0),b(this,"candidatesEnded",!1),b(this,"feeds",[]),b(this,"transceivers",new Map),b(this,"inviteOrAnswerSent",!1),b(this,"waitForLocalAVStream",!1),b(this,"successor",void 0),b(this,"opponentMember",void 0),b(this,"opponentVersion",void 0),b(this,"opponentPartyId",void 0),b(this,"opponentCaps",void 0),b(this,"iceDisconnectedTimeout",void 0),b(this,"iceReconnectionTimeOut",void 0),b(this,"inviteTimeout",void 0),b(this,"removeTrackListeners",new Map),b(this,"remoteOnHold",!1),b(this,"callStatsAtEnd",void 0),b(this,"makingOffer",!1),b(this,"ignoreOffer",!1),b(this,"isSettingRemoteAnswerPending",!1),b(this,"responsePromiseChain",void 0),b(this,"remoteCandidateBuffer",new Map),b(this,"remoteAssertedIdentity",void 0),b(this,"remoteSDPStreamMetadata",void 0),b(this,"callLengthInterval",void 0),b(this,"callStartTime",void 0),b(this,"opponentDeviceId",void 0),b(this,"hasOpponentDeviceInfo",void 0),b(this,"opponentSessionId",void 0),b(this,"groupCallId",void 0),b(this,"stopVideoTrackTimer",void 0),b(this,"isOnlyDataChannelAllowed",void 0),b(this,"stats",void 0),b(this,"gotLocalIceCandidate",a=>{if(a.candidate){if(this.candidatesEnded&&D.warn("Call ".concat(this.callId," gotLocalIceCandidate() got candidate after candidates have ended!")),D.debug("Call ".concat(this.callId," got local ICE ").concat(a.candidate.sdpMid," ").concat(a.candidate.candidate)),this.callHasEnded())return;a.candidate.candidate===""?this.queueCandidate(null):this.queueCandidate(a.candidate)}}),b(this,"onIceGatheringStateChange",a=>{var o;D.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state changed to ").concat(this.peerConn.iceGatheringState)),((o=this.peerConn)===null||o===void 0?void 0:o.iceGatheringState)==="complete"&&(this.queueCandidate(null),D.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state complete, set candidates have ended")))}),b(this,"getLocalOfferFailed",a=>{D.error("Call ".concat(this.callId," getLocalOfferFailed() running"),a),this.emit(qe.Error,new Ur(Ue.LocalOfferFailed,"Failed to get local offer!",a),this),this.terminate(Lt.Local,Ue.LocalOfferFailed,!1)}),b(this,"getUserMediaFailed",a=>{if(this.successor){this.successor.getUserMediaFailed(a);return}D.warn("Call ".concat(this.callId," getUserMediaFailed() failed to get user media - ending call"),a),this.emit(qe.Error,new Ur(Ue.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",a),this),this.terminate(Lt.Local,Ue.NoUserMedia,!1)}),b(this,"placeCallFailed",a=>{if(this.successor){this.successor.placeCallFailed(a);return}D.warn("Call ".concat(this.callId," placeCallWithCallFeeds() failed - ending call"),a),this.emit(qe.Error,new Ur(Ue.IceFailed,"Couldn't start call! Invalid ICE server configuration.",a),this),this.terminate(Lt.Local,Ue.IceFailed,!1)}),b(this,"onIceConnectionStateChanged",()=>{var a,o,c,d,h,v;if(!this.callHasEnded()){if(D.debug("Call ".concat(this.callId," onIceConnectionStateChanged() running (state=").concat((a=this.peerConn)===null||a===void 0?void 0:a.iceConnectionState,", conn=").concat((o=this.peerConn)===null||o===void 0?void 0:o.connectionState,")")),["connected","completed"].includes((c=(d=this.peerConn)===null||d===void 0?void 0:d.iceConnectionState)!==null&&c!==void 0?c:""))clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.iceReconnectionTimeOut&&clearTimeout(this.iceReconnectionTimeOut),this.state=Me.Connected,!this.callLengthInterval&&!this.callStartTime&&(this.callStartTime=Date.now(),this.callLengthInterval=setInterval(()=>{this.emit(qe.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)},MN));else if(((h=this.peerConn)===null||h===void 0?void 0:h.iceConnectionState)=="failed"){var m;if(this.candidatesEnded=!1,(m=this.peerConn)!==null&&m!==void 0&&m.restartIce){var y;this.candidatesEnded=!1,D.debug("Call ".concat(this.callId," onIceConnectionStateChanged() ice restart (state=").concat((y=this.peerConn)===null||y===void 0?void 0:y.iceConnectionState,")")),this.peerConn.restartIce()}else D.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)")),this.hangup(Ue.IceFailed,!1)}else((v=this.peerConn)===null||v===void 0?void 0:v.iceConnectionState)=="disconnected"&&(this.candidatesEnded=!1,this.iceReconnectionTimeOut=setTimeout(()=>{var T,S,O;D.info("Call ".concat(this.callId," onIceConnectionStateChanged() ICE restarting because of ICE disconnected, (state=").concat((T=this.peerConn)===null||T===void 0?void 0:T.iceConnectionState,", conn=").concat((S=this.peerConn)===null||S===void 0?void 0:S.connectionState,")")),(O=this.peerConn)!==null&&O!==void 0&&O.restartIce&&(this.candidatesEnded=!1,this.peerConn.restartIce()),this.iceReconnectionTimeOut=void 0},AN),this.iceDisconnectedTimeout=setTimeout(()=>{D.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)")),this.hangup(Ue.IceFailed,!1)},PN),this.state=Me.Connecting);if(this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState))for(var E of this.getRemoteFeeds())E.setAudioVideoMuted(!0,!0)}}),b(this,"onSignallingStateChanged",()=>{var a;D.debug("Call ".concat(this.callId," onSignallingStateChanged() running (state=").concat((a=this.peerConn)===null||a===void 0?void 0:a.signalingState,")"))}),b(this,"onTrack",a=>{if(a.streams.length===0){D.warn("Call ".concat(this.callId," onTrack() called with streamless track streamless (kind=").concat(a.track.kind,")"));return}var o=a.streams[0];if(this.pushRemoteFeed(o),!this.removeTrackListeners.has(o)){var c=()=>{o.getTracks().length===0&&(D.info("Call ".concat(this.callId," onTrack() removing track (streamId=").concat(o.id,")")),this.deleteFeedByStream(o),o.removeEventListener("removetrack",c),this.removeTrackListeners.delete(o))};o.addEventListener("removetrack",c),this.removeTrackListeners.set(o,c)}}),b(this,"onDataChannel",a=>{this.emit(qe.DataChannel,a.channel,this)}),b(this,"onNegotiationNeeded",A(function*(){if(D.info("Call ".concat(t.callId," onNegotiationNeeded() negotiation is needed!")),t.state!==Me.CreateOffer&&t.opponentVersion===0){D.info("Call ".concat(t.callId," onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event"));return}t.queueGotLocalOffer()})),b(this,"onHangupReceived",a=>{D.debug("Call ".concat(this.callId," onHangupReceived() running")),this.partyIdMatches(a)||this.state===Me.Ringing?this.terminate(Lt.Remote,a.reason||Ue.UserHangup,!0):D.info("Call ".concat(this.callId," onHangupReceived() ignoring message from party ID ").concat(a.party_id,": our partner is ").concat(this.opponentPartyId))}),b(this,"onRejectReceived",a=>{D.debug("Call ".concat(this.callId," onRejectReceived() running"));var o=[Me.InviteSent,Me.Ringing].includes(this.state)||this.state===Me.Fledgling&&this.direction===Oa.Inbound;o?this.terminate(Lt.Remote,a.reason||Ue.UserHangup,!0):D.debug("Call ".concat(this.callId," onRejectReceived() called in wrong state (state=").concat(this.state,")"))}),b(this,"onAnsweredElsewhere",a=>{D.debug("Call ".concat(this.callId," onAnsweredElsewhere() running")),this.terminate(Lt.Remote,Ue.AnsweredElsewhere,!0)}),this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw new Error("Client must have a device ID to start calls");this.forceTURN=(n=e.forceTURN)!==null&&n!==void 0?n:!1,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],this.turnServers.length===0&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[ON]});for(var r of this.turnServers)Ck(r,["urls"]);this.callId=Cs(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}placeVoiceCall(){var e=this;return A(function*(){yield e.placeCall(!0,!1)})()}placeVideoCall(){var e=this;return A(function*(){yield e.placeCall(!0,!0)})()}createDataChannel(e,t){var n=this.peerConn.createDataChannel(e,t);return this.emit(qe.DataChannel,n,this),n}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return!!(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return!!(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){var t=this._state;this._state=e,this.emit(qe.State,e,t,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?aC.Video:aC.Voice}get hasLocalUserMediaVideoTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===bt.Usermedia&&((t=e.stream)===null||t===void 0?void 0:t.getVideoTracks().length)})}get hasLocalUserMediaAudioTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===bt.Usermedia&&!!((t=e.stream)!==null&&t!==void 0&&t.getAudioTracks().length)})}get hasUserMediaAudioSender(){var e;return!!(!((e=this.transceivers.get(xi(bt.Usermedia,"audio")))===null||e===void 0)&&e.sender)}get hasUserMediaVideoSender(){var e;return!!(!((e=this.transceivers.get(xi(bt.Usermedia,"video")))===null||e===void 0)&&e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find(e=>e.purpose===bt.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(e=>e.purpose===bt.Screenshare)}get localUsermediaStream(){var e;return(e=this.localUsermediaFeed)===null||e===void 0?void 0:e.stream}get localScreensharingStream(){var e;return(e=this.localScreensharingFeed)===null||e===void 0?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(e=>e.purpose===bt.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(e=>e.purpose===bt.Screenshare)}get remoteUsermediaStream(){var e;return(e=this.remoteUsermediaFeed)===null||e===void 0?void 0:e.stream}get remoteScreensharingStream(){var e;return(e=this.remoteScreensharingFeed)===null||e===void 0?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find(t=>t.stream.id===e)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(e=>e.isLocal())}getRemoteFeeds(){return this.feeds.filter(e=>!e.isLocal())}initOpponentCrypto(){var e=this;return A(function*(){var t;if(e.opponentDeviceId&&e.client.getUseE2eForGroupCall()){if(!e.client.getCrypto()){e.hasOpponentDeviceInfo=!0;return}var n=e.invitee||((t=e.getOpponentMember())===null||t===void 0?void 0:t.userId);throw n?(e.hasOpponentDeviceInfo=!1,new Iw(n)):new Error("Couldn't find opponent user ID to init crypto")}})()}getLocalSDPStreamMetadata(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={};for(var n of this.getLocalFeeds())e&&(n.sdpMetadataStreamId=n.stream.id),t[n.sdpMetadataStreamId]={purpose:n.purpose,audio_muted:n.isAudioMuted(),video_muted:n.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some(e=>!e.isLocal())}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata()){this.pushRemoteFeedWithoutMetadata(e);return}var t=this.getOpponentMember().userId,n=this.remoteSDPStreamMetadata[e.id].purpose,r=this.remoteSDPStreamMetadata[e.id].audio_muted,a=this.remoteSDPStreamMetadata[e.id].video_muted;if(!n){D.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){D.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new qr({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:n,audioMuted:r,videoMuted:a})),this.emit(qe.FeedsChanged,this.feeds,this),D.info("Call ".concat(this.callId," pushRemoteFeed() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,", purpose=").concat(n,")"))}pushRemoteFeedWithoutMetadata(e){var t,n=this.getOpponentMember().userId,r=bt.Usermedia,a=(t=this.feeds.find(o=>!o.isLocal()))===null||t===void 0?void 0:t.stream;if(a&&e.id!==a.id){D.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){D.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new qr({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,deviceId:this.getOpponentDeviceId(),stream:e,purpose:r})),this.emit(qe.FeedsChanged,this.feeds,this),D.info("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,")"))}pushNewLocalFeed(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r=this.client.getUserId();if(Yt(e.getAudioTracks(),!0),Yt(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)){D.warn("Call ".concat(this.callId," pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.pushLocalFeed(new qr({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:r,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),n)}pushLocalFeed(e){var t=this,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(this.feeds.some(o=>e.stream.id===o.stream.id)){D.info("Call ".concat(this.callId," pushLocalFeed() ignoring duplicate local stream (streamId=").concat(e.stream.id,")"));return}if(this.feeds.push(e),n){var r=function(){D.info("Call ".concat(t.callId," pushLocalFeed() adding track to peer connection (id=").concat(a.id,", kind=").concat(a.kind,", streamId=").concat(e.stream.id,", streamPurpose=").concat(e.purpose,", enabled=").concat(a.enabled,")"));var c=xi(e.purpose,a.kind);if(t.transceivers.has(c)){var d=t.transceivers.get(c);d.sender.replaceTrack(a),d.direction=d.direction==="inactive"?"sendonly":"sendrecv"}else{var h=t.peerConn.addTrack(a,e.stream),v=t.peerConn.getTransceivers().find(m=>m.sender===h);v?t.transceivers.set(c,v):D.warn("Call ".concat(t.callId," pushLocalFeed() didn't find a matching transceiver after adding track!"))}};for(var a of e.stream.getTracks())r()}D.info("Call ".concat(this.callId," pushLocalFeed() pushed stream (id=").concat(e.stream.id,", active=").concat(e.stream.active,", purpose=").concat(e.purpose,")")),this.emit(qe.FeedsChanged,this.feeds,this)}removeLocalFeed(e){var t=xi(e.purpose,"audio"),n=xi(e.purpose,"video");for(var r of[t,n])if(this.transceivers.has(r)){var a=this.transceivers.get(r);a.sender&&this.peerConn.removeTrack(a.sender)}e.purpose===bt.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(var e of this.feeds)(!e.isLocal()||!this.groupCallId)&&e.dispose();this.feeds=[],this.emit(qe.FeedsChanged,this.feeds,this)}deleteFeedByStream(e){var t=this.getFeedByStreamId(e.id);if(!t){D.warn("Call ".concat(this.callId," deleteFeedByStream() didn't find the feed to delete (streamId=").concat(e.id,")"));return}this.deleteFeed(t)}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit(qe.FeedsChanged,this.feeds,this)}getCurrentCallStats(){var e=this;return A(function*(){return e.callHasEnded()?e.callStatsAtEnd:e.collectCallStats()})()}collectCallStats(){var e=this;return A(function*(){if(e.peerConn){var t=yield e.peerConn.getStats(),n=[];return t.forEach(r=>{n.push(r)}),n}})()}initWithInvite(e){var t=this;return A(function*(){var n,r=e.getContent();t.direction=Oa.Inbound;var a=yield t.client.checkTurnServers();a||D.warn("Call ".concat(t.callId," initWithInvite() failed to get TURN credentials! Proceeding with call anyway..."));var o=r[Ra];o?t.updateRemoteSDPStreamMetadata(o):D.debug("Call ".concat(t.callId," initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams")),t.peerConn=t.createPeerConnection(),t.emit(qe.PeerConnectionCreated,t.peerConn,t),t.chooseOpponent(e),yield t.initOpponentCrypto();try{yield t.peerConn.setRemoteDescription(r.offer),D.debug("Call ".concat(t.callId," initWithInvite() set remote description: ").concat(r.offer.type)),yield t.addBufferedIceCandidates()}catch(v){D.debug("Call ".concat(t.callId," initWithInvite() failed to set remote description"),v),t.terminate(Lt.Local,Ue.SetRemoteDescription,!1);return}var c=(n=t.feeds.find(v=>!v.isLocal()))===null||n===void 0?void 0:n.stream;if(!t.isOnlyDataChannelAllowed&&(!c||c.getTracks().length===0)){D.error("Call ".concat(t.callId," initWithInvite() no remote stream or no tracks after setting remote description!")),t.terminate(Lt.Local,Ue.SetRemoteDescription,!1);return}if(t.state=Me.Ringing,e.getLocalAge()){var d=setTimeout(()=>{if(t.state==Me.Ringing){var v;D.debug("Call ".concat(t.callId," initWithInvite() invite has expired. Hanging up.")),t.hangupParty=Lt.Remote,t.state=Me.Ended,t.stopAllMedia(),t.peerConn.signalingState!="closed"&&t.peerConn.close(),(v=t.stats)===null||v===void 0||v.removeStatsReportGatherer(t.callId),t.emit(qe.Hangup,t)}},r.lifetime-e.getLocalAge()),h=v=>{v!==Me.Ringing&&(clearTimeout(d),t.off(qe.State,h))};t.on(qe.State,h)}})()}initWithHangup(e){this.state=Me.Ended}shouldAnswerWithMediaType(e,t,n){return e&&!t?(D.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(n," because the other side isn't sending it either.")),!1):!wk(e)&&e!==t&&!this.opponentSupportsSDPStreamMetadata()?(D.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(n,"=").concat(e," because the other side doesn't support it. Answering with ").concat(n,"=").concat(t,".")),t):e??t}answer(e,t){var n=this;return A(function*(){if(!n.inviteOrAnswerSent){if(e===!1&&t===!1)throw new Error("You CANNOT answer a call without media");if(!n.localUsermediaStream&&!n.waitForLocalAVStream){var r=n.state,a=n.shouldAnswerWithMediaType(e,n.hasRemoteUserMediaAudioTrack,"audio"),o=n.shouldAnswerWithMediaType(t,n.hasRemoteUserMediaVideoTrack,"video");n.state=Me.WaitLocalMedia,n.waitForLocalAVStream=!0;try{var c,d=yield n.client.getMediaHandler().getUserMediaStream(a,o);n.waitForLocalAVStream=!1;var h=new qr({client:n.client,roomId:n.roomId,userId:n.client.getUserId(),deviceId:(c=n.client.getDeviceId())!==null&&c!==void 0?c:void 0,stream:d,purpose:bt.Usermedia,audioMuted:!1,videoMuted:!1}),v=[h];n.localScreensharingFeed&&v.push(n.localScreensharingFeed),n.answerWithCallFeeds(v)}catch(m){if(o)D.warn("Call ".concat(n.callId," answer() failed to getUserMedia(), trying to getUserMedia() without video")),n.state=r,n.waitForLocalAVStream=!1,yield n.answer(a,!1);else{n.getUserMediaFailed(m);return}}}else n.waitForLocalAVStream&&(n.state=Me.WaitLocalMedia)}})()}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){D.debug("Call ".concat(this.callId," replacedBy() running (newCallId=").concat(e.callId,")")),this.state===Me.WaitLocalMedia?(D.debug("Call ".concat(this.callId," replacedBy() telling new call to wait for local media (newCallId=").concat(e.callId,")")),e.waitForLocalAVStream=!0):[Me.CreateOffer,Me.InviteSent].includes(this.state)&&(e.direction===Oa.Outbound?e.queueGotCallFeedsForAnswer([]):(D.debug("Call ".concat(this.callId," replacedBy() handing local stream to new call(newCallId=").concat(e.callId,")")),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map(t=>t.clone())))),this.successor=e,this.emit(qe.Replaced,e,this),this.hangup(Ue.Replaced,!0)}hangup(e,t){if(!this.callHasEnded()&&(D.debug("Call ".concat(this.callId," hangup() ending call (reason=").concat(e,")")),this.terminate(Lt.Local,e,!t),![Me.Fledgling,Me.WaitLocalMedia].includes(this.state))){var n={};(this.opponentVersion&&this.opponentVersion!==0||e!==Ue.UserHangup)&&(n.reason=e),this.sendVoipEvent(G.CallHangup,n)}}reject(){if(this.state!==Me.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(this.opponentVersion===0){D.info("Call ".concat(this.callId," reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=").concat(this.opponentVersion,")")),this.hangup(Ue.UserHangup,!0);return}D.debug("Rejecting call: "+this.callId),this.terminate(Lt.Local,Ue.UserHangup,!0),this.sendVoipEvent(G.CallReject,{})}upgradeCall(e,t){var n=this;return A(function*(){if(!(!e&&!t)&&n.opponentSupportsSDPStreamMetadata())try{D.debug("Call ".concat(n.callId," upgradeCall() upgrading call (audio=").concat(e,", video=").concat(t,")"));var r=e||n.hasLocalUserMediaAudioTrack,a=t||n.hasLocalUserMediaVideoTrack,o=yield n.client.getMediaHandler().getUserMediaStream(r,a,!1);yield n.updateLocalUsermediaStream(o,e,t)}catch(c){D.error("Call ".concat(n.callId," upgradeCall() failed to upgrade the call"),c),n.emit(qe.Error,new Ur(Ue.NoUserMedia,"Failed to get camera access: ",c),n)}})()}opponentSupportsSDPStreamMetadata(){return!!this.remoteSDPStreamMetadata}isScreensharing(){return!!this.localScreensharingStream}setScreensharingEnabled(e,t){var n=this;return A(function*(){if(e&&n.isScreensharing())return D.warn("Call ".concat(n.callId," setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!")),!0;if(!e&&!n.isScreensharing())return D.warn("Call ".concat(n.callId," setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!")),!1;if(!n.opponentSupportsSDPStreamMetadata())return n.setScreensharingEnabledWithoutMetadataSupport(e,t);if(D.debug("Call ".concat(n.callId," setScreensharingEnabled() running (enabled=").concat(e,")")),e)try{var r=yield n.client.getMediaHandler().getScreensharingStream(t);return r?(n.pushNewLocalFeed(r,bt.Screenshare),!0):!1}catch(d){return D.error("Call ".concat(n.callId," setScreensharingEnabled() failed to get screen-sharing stream:"),d),!1}else{var a=n.transceivers.get(xi(bt.Screenshare,"audio")),o=n.transceivers.get(xi(bt.Screenshare,"video"));for(var c of[a,o])c&&c.sender&&n.peerConn.removeTrack(c.sender);return n.client.getMediaHandler().stopScreensharingStream(n.localScreensharingStream),n.deleteFeedByStream(n.localScreensharingStream),!1}})()}setScreensharingEnabledWithoutMetadataSupport(e,t){var n=this;return A(function*(){if(D.debug("Call ".concat(n.callId," setScreensharingEnabledWithoutMetadataSupport() running (enabled=").concat(e,")")),e)try{var r,a=yield n.client.getMediaHandler().getScreensharingStream(t);if(!a)return!1;var o=a.getTracks().find(y=>y.kind==="video"),c=(r=n.transceivers.get(xi(bt.Usermedia,"video")))===null||r===void 0?void 0:r.sender;return c?.replaceTrack(o??null),n.pushNewLocalFeed(a,bt.Screenshare,!1),!0}catch(y){return D.error("Call ".concat(n.callId," setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:"),y),!1}else{var d,h,v=(d=n.localUsermediaStream)===null||d===void 0?void 0:d.getTracks().find(y=>y.kind==="video"),m=(h=n.transceivers.get(xi(bt.Usermedia,"video")))===null||h===void 0?void 0:h.sender;return m?.replaceTrack(v??null),n.client.getMediaHandler().stopScreensharingStream(n.localScreensharingStream),n.deleteFeedByStream(n.localScreensharingStream),!1}})()}updateLocalUsermediaStream(e){var t=arguments,n=this;return A(function*(){var r=t.length>1&&t[1]!==void 0?t[1]:!1,a=t.length>2&&t[2]!==void 0?t[2]:!1,o=n.localUsermediaFeed,c=r||!o.isAudioMuted()&&!n.remoteOnHold,d=a||!o.isVideoMuted()&&!n.remoteOnHold;D.log("Call ".concat(n.callId," updateLocalUsermediaStream() running (streamId=").concat(e.id,", audio=").concat(c,", video=").concat(d,")")),Yt(e.getAudioTracks(),c),Yt(e.getVideoTracks(),d);for(var h of n.localUsermediaStream.getTracks())n.localUsermediaStream.removeTrack(h),h.stop();for(var v of e.getTracks())n.localUsermediaStream.addTrack(v);var m=function*(){var T=xi(bt.Usermedia,y.kind),S=n.transceivers.get(T),O=S?.sender,R=!1;if(O)try{D.info("Call ".concat(n.callId," updateLocalUsermediaStream() replacing track (id=").concat(y.id,", kind=").concat(y.kind,", streamId=").concat(e.id,", streamPurpose=").concat(o.purpose,")")),yield O.replaceTrack(y),S.direction=S.direction==="inactive"?"sendonly":"sendrecv",R=!0}catch(C){D.warn("Call ".concat(n.callId," updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead"),C)}if(!R){D.info("Call ".concat(n.callId," updateLocalUsermediaStream() adding track to peer connection (id=").concat(y.id,", kind=").concat(y.kind,", streamId=").concat(e.id,", streamPurpose=").concat(o.purpose,")"));var I=n.peerConn.addTrack(y,n.localUsermediaStream),M=n.peerConn.getTransceivers().find(C=>C.sender===I);M?n.transceivers.set(T,M):D.warn("Call ".concat(n.callId," updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!"))}};for(var y of e.getTracks())yield*m()})()}setLocalVideoMuted(e){var t=this;return A(function*(){var n;if(D.log("Call ".concat(t.callId," setLocalVideoMuted() running ").concat(e)),!e&&t.stopVideoTrackTimer!==void 0&&(clearTimeout(t.stopVideoTrackTimer),t.stopVideoTrackTimer=void 0),!(yield t.client.getMediaHandler().hasVideoDevice()))return t.isLocalVideoMuted();if(!t.hasUserMediaVideoSender&&!e){var r;return(r=t.localUsermediaFeed)===null||r===void 0||r.setAudioVideoMuted(null,e),yield t.upgradeCall(!1,!0),t.isLocalVideoMuted()}if(!e&&t.localUsermediaStream.getVideoTracks().length===0){var a=yield t.client.getMediaHandler().getUserMediaStream(!0,!0);yield t.updateLocalUsermediaStream(a)}return(n=t.localUsermediaFeed)===null||n===void 0||n.setAudioVideoMuted(null,e),t.updateMuteStatus(),yield t.sendMetadataUpdate(),e&&(t.stopVideoTrackTimer=setTimeout(()=>{for(var o of t.localUsermediaStream.getVideoTracks())o.stop(),t.localUsermediaStream.removeTrack(o)},120)),t.isLocalVideoMuted()})()}isLocalVideoMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isVideoMuted())!==null&&e!==void 0?e:!1}setMicrophoneMuted(e){var t=this;return A(function*(){var n;return D.log("Call ".concat(t.callId," setMicrophoneMuted() running ").concat(e)),(yield t.client.getMediaHandler().hasAudioDevice())?!e&&(!t.hasUserMediaAudioSender||!t.hasLocalUserMediaAudioTrack)?(yield t.upgradeCall(!0,!1),t.isMicrophoneMuted()):((n=t.localUsermediaFeed)===null||n===void 0||n.setAudioVideoMuted(e,null),t.updateMuteStatus(),yield t.sendMetadataUpdate(),t.isMicrophoneMuted()):t.isMicrophoneMuted()})()}isMicrophoneMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isAudioMuted())!==null&&e!==void 0?e:!1}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(var t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(qe.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==Me.Connected)return!1;var e=!0;for(var t of this.peerConn.getTransceivers()){var n=["inactive","recvonly"].includes(t.currentDirection);n||(e=!1)}return e}sendDtmfDigit(e){for(var t of this.peerConn.getSenders()){var n;if(((n=t.track)===null||n===void 0?void 0:n.kind)==="audio"&&t.dtmf){t.dtmf.insertDTMF(e);return}}throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){var e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;D.log("Call ".concat(this.callId," updateMuteStatus stream ").concat(this.localUsermediaStream.id," micShouldBeMuted ").concat(e," vidShouldBeMuted ").concat(t)),Yt(this.localUsermediaStream.getAudioTracks(),!e),Yt(this.localUsermediaStream.getVideoTracks(),!t)}sendMetadataUpdate(){var e=this;return A(function*(){yield e.sendVoipEvent(G.CallSDPStreamMetadataChangedPrefix,{[Ra]:e.getLocalSDPStreamMetadata()})})()}gotCallFeedsForInvite(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(this.successor){this.successor.queueGotCallFeedsForAnswer(e);return}if(this.callHasEnded()){this.stopAllMedia();return}for(var n of e)this.pushLocalFeed(n);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=Me.CreateOffer,D.debug("Call ".concat(this.callId," gotUserMediaForInvite() run"))}sendAnswer(){var e=this;return A(function*(){var t={answer:{sdp:e.peerConn.localDescription.sdp,type:e.peerConn.localDescription.type},[Ra]:e.getLocalSDPStreamMetadata(!0)};t.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1};var n=e.discardDuplicateCandidates();D.info("Call ".concat(e.callId," sendAnswer() discarding ").concat(n," candidates that will be sent in answer"));try{yield e.sendVoipEvent(G.CallAnswer,t),e.inviteOrAnswerSent=!0}catch(o){e.state=Me.Ringing,o instanceof Ct&&o.event&&e.client.cancelPendingEvent(o.event);var r=Ue.SendAnswer,a="Failed to send answer";throw o.name=="UnknownDeviceError"&&(r=Ue.UnknownDevices,a="Unknown devices present in the room"),e.emit(qe.Error,new Ur(r,a,o),e),o}e.sendCandidateQueue()})()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.gotCallFeedsForAnswer(e)):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){var n=Dg.parse(e.sdp);n.media.forEach(r=>{var a=new Map,o=new Map;for(var c of r.rtp)a.set(c.payload,c.codec),o.set(c.codec,c.payload);for(var d of t)if(d.mediaType===r.type){if(!o.has(d.codec)){D.info("Call ".concat(this.callId," mungeSdp() ignoring SDP modifications for ").concat(d.codec," as it's not present."));continue}var h=[];d.enableDtx!==void 0&&h.push("usedtx=".concat(d.enableDtx?"1":"0")),d.maxAverageBitrate!==void 0&&h.push("maxaveragebitrate=".concat(d.maxAverageBitrate));var v=!1;for(var m of r.fmtp)a.get(m.payload)===d.codec&&(v=!0,m.config+=";"+h.join(";"));v||r.fmtp.push({payload:o.get(d.codec),config:h.join(";")})}}),e.sdp=Dg.write(n)}createOffer(){var e=this;return A(function*(){var t=yield e.peerConn.createOffer();return e.mungeSdp(t,sC(e.isPtt)),t})()}createAnswer(){var e=this;return A(function*(){var t=yield e.peerConn.createAnswer();return e.mungeSdp(t,sC(e.isPtt)),t})()}gotCallFeedsForAnswer(e){var t=this;return A(function*(){if(!t.callHasEnded()){t.waitForLocalAVStream=!1;for(var n of e)t.pushLocalFeed(n);t.state=Me.CreateAnswer;var r;try{t.getRidOfRTXCodecs(),r=yield t.createAnswer()}catch(a){D.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() failed to create answer: "),a),t.terminate(Lt.Local,Ue.CreateAnswer,!0);return}try{if(yield t.peerConn.setLocalDescription(r),t.callHasEnded()||(t.state=Me.Connecting,yield new Promise(a=>{setTimeout(a,200)}),t.callHasEnded()))return;t.sendAnswer()}catch(a){D.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() error setting local description!"),a),t.terminate(Lt.Local,Ue.SetLocalDescription,!0);return}}})()}onRemoteIceCandidatesReceived(e){var t=this;return A(function*(){if(!t.callHasEnded()){var n=e.getContent(),r=n.candidates;if(!r){D.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!"));return}var a=n.version===0?null:n.party_id||null;if(t.opponentPartyId===void 0){if(a){D.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() buffering ").concat(r.length," candidates until we pick an opponent"));var o=t.remoteCandidateBuffer.get(a)||[];o.push(...r),t.remoteCandidateBuffer.set(a,o)}return}if(!t.partyIdMatches(n)){D.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates from party ID ").concat(n.party_id,": we have chosen party ID ").concat(t.opponentPartyId));return}yield t.addIceCandidates(r)}})()}onAnswerReceived(e){var t=this;return A(function*(){var n=e.getContent();if(D.debug("Call ".concat(t.callId," onAnswerReceived() running (hangupParty=").concat(n.party_id,")")),t.callHasEnded()){D.debug("Call ".concat(t.callId," onAnswerReceived() ignoring answer because call has ended"));return}if(t.opponentPartyId!==void 0){D.info("Call ".concat(t.callId," onAnswerReceived() ignoring answer from party ID ").concat(n.party_id,": we already have an answer/reject from ").concat(t.opponentPartyId));return}t.chooseOpponent(e),yield t.addBufferedIceCandidates(),t.state=Me.Connecting;var r=n[Ra];r?t.updateRemoteSDPStreamMetadata(r):D.warn("Call ".concat(t.callId," onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams"));try{t.isSettingRemoteAnswerPending=!0,yield t.peerConn.setRemoteDescription(n.answer),t.isSettingRemoteAnswerPending=!1,D.debug("Call ".concat(t.callId," onAnswerReceived() set remote description: ").concat(n.answer.type))}catch(a){t.isSettingRemoteAnswerPending=!1,D.debug("Call ".concat(t.callId," onAnswerReceived() failed to set remote description"),a),t.terminate(Lt.Local,Ue.SetRemoteDescription,!1);return}if(t.opponentPartyId!==null)try{yield t.sendVoipEvent(G.CallSelectAnswer,{selected_party_id:t.opponentPartyId})}catch(a){D.warn("Call ".concat(t.callId," onAnswerReceived() failed to send select_answer event"),a)}})()}onSelectAnswerReceived(e){var t=this;return A(function*(){if(t.direction!==Oa.Inbound){D.warn("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for an outbound call: ignoring"));return}var n=e.getContent().selected_party_id;if(n==null){D.warn("Call ".concat(t.callId," onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring"));return}n!==t.ourPartyId&&(D.info("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for party ID ").concat(n,": we are party ID ").concat(t.ourPartyId,".")),yield t.terminate(Lt.Remote,Ue.AnsweredElsewhere,!0))})()}onNegotiateReceived(e){var t=this;return A(function*(){var n=e.getContent(),r=n.description;if(!r||!r.sdp||!r.type){D.info("Call ".concat(t.callId," onNegotiateReceived() ignoring invalid m.call.negotiate event"));return}var a=t.direction===Oa.Inbound,o=!t.makingOffer&&(t.peerConn.signalingState==="stable"||t.isSettingRemoteAnswerPending),c=r.type==="offer"&&!o;if(t.ignoreOffer=!a&&c,t.ignoreOffer){D.info("Call ".concat(t.callId," onNegotiateReceived() ignoring colliding negotiate event because we're impolite"));return}var d=t.isLocalOnHold(),h=n[Ra];h?t.updateRemoteSDPStreamMetadata(h):D.warn("Call ".concat(t.callId," onNegotiateReceived() received negotiation event without SDPStreamMetadata!"));try{if(t.isSettingRemoteAnswerPending=r.type=="answer",yield t.peerConn.setRemoteDescription(r),t.isSettingRemoteAnswerPending=!1,D.debug("Call ".concat(t.callId," onNegotiateReceived() set remote description: ").concat(r.type)),r.type==="offer"){var v,m;try{t.getRidOfRTXCodecs(),m=yield t.createAnswer()}catch(E){D.debug("Call ".concat(t.callId," onNegotiateReceived() failed to create answer: "),E),t.terminate(Lt.Local,Ue.CreateAnswer,!0);return}yield t.peerConn.setLocalDescription(m),D.debug("Call ".concat(t.callId," onNegotiateReceived() create an answer")),t.sendVoipEvent(G.CallNegotiate,{lifetime:Op,description:(v=t.peerConn.localDescription)===null||v===void 0?void 0:v.toJSON(),[Ra]:t.getLocalSDPStreamMetadata(!0)})}}catch(E){t.isSettingRemoteAnswerPending=!1,D.warn("Call ".concat(t.callId," onNegotiateReceived() failed to complete negotiation"),E)}var y=t.isLocalOnHold();d!==y&&(t.emit(qe.LocalHoldUnhold,y,t),t.emit(qe.HoldUnhold,y))})()}updateRemoteSDPStreamMetadata(e){this.remoteSDPStreamMetadata=Ik(this.remoteSDPStreamMetadata||{},e,!0);for(var t of this.getRemoteFeeds()){var n,r=t.stream.id,a=this.remoteSDPStreamMetadata[r];t.setAudioVideoMuted(a?.audio_muted,a?.video_muted),t.purpose=(n=this.remoteSDPStreamMetadata[r])===null||n===void 0?void 0:n.purpose}}onSDPStreamMetadataChangedReceived(e){var t=e.getContent(),n=t[Ra];this.updateRemoteSDPStreamMetadata(n)}onAssertedIdentityReceived(e){var t=this;return A(function*(){var n=e.getContent();n.asserted_identity&&(t.remoteAssertedIdentity={id:n.asserted_identity.id,displayName:n.asserted_identity.display_name},t.emit(qe.AssertedIdentityChanged,t))})()}callHasEnded(){return this.state===Me.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.wrappedGotLocalOffer()):this.responsePromiseChain=this.wrappedGotLocalOffer()}wrappedGotLocalOffer(){var e=this;return A(function*(){e.makingOffer=!0;try{yield e.gotLocalOffer()}catch(t){e.getLocalOfferFailed(t);return}finally{e.makingOffer=!1}})()}gotLocalOffer(){var e=this;return A(function*(){if(D.debug("Call ".concat(e.callId," gotLocalOffer() running")),e.callHasEnded()){D.debug("Call ".concat(e.callId,' gotLocalOffer() ignoring newly created offer because the call has ended"'));return}var t;try{e.getRidOfRTXCodecs(),t=yield e.createOffer()}catch(v){D.debug("Call ".concat(e.callId," gotLocalOffer() failed to create offer: "),v),e.terminate(Lt.Local,Ue.CreateOffer,!0);return}try{yield e.peerConn.setLocalDescription(t)}catch(v){D.debug("Call ".concat(e.callId," gotLocalOffer() error setting local description!"),v),e.terminate(Lt.Local,Ue.SetLocalDescription,!0);return}if(e.peerConn.iceGatheringState==="gathering"&&(yield new Promise(v=>{setTimeout(v,200)})),!e.callHasEnded()){var n=e.state===Me.CreateOffer?G.CallInvite:G.CallNegotiate,r={lifetime:Op};if(n===G.CallInvite&&e.invitee&&(r.invitee=e.invitee),e.state===Me.CreateOffer){var a;r.offer=(a=e.peerConn.localDescription)===null||a===void 0?void 0:a.toJSON()}else{var o;r.description=(o=e.peerConn.localDescription)===null||o===void 0?void 0:o.toJSON()}r.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1},r[Ra]=e.getLocalSDPStreamMetadata(!0);var c=e.discardDuplicateCandidates();D.info("Call ".concat(e.callId," gotLocalOffer() discarding ").concat(c," candidates that will be sent in offer"));try{yield e.sendVoipEvent(n,r)}catch(v){D.error("Call ".concat(e.callId," gotLocalOffer() failed to send invite"),v),v instanceof Ct&&v.event&&e.client.cancelPendingEvent(v.event);var d=Ue.SignallingFailed,h="Signalling failed";e.state===Me.CreateOffer&&(d=Ue.SendInvite,h="Failed to send invite"),v.name=="UnknownDeviceError"&&(d=Ue.UnknownDevices,h="Unknown devices present in the room"),e.emit(qe.Error,new Ur(d,h,v),e),e.terminate(Lt.Local,d,!1);return}e.sendCandidateQueue(),e.state===Me.CreateOffer&&(e.inviteOrAnswerSent=!0,e.state=Me.InviteSent,e.inviteTimeout=setTimeout(()=>{e.inviteTimeout=void 0,e.state===Me.InviteSent&&e.hangup(Ue.InviteTimeout,!1)},Op))}})()}getRidOfRTXCodecs(){if(!(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)){var e=this.transceivers.get(xi(bt.Screenshare,"video"));if(!(!e||!e.setCodecPreferences)){var t=RTCRtpReceiver.getCapabilities("video").codecs,n=RTCRtpSender.getCapabilities("video").codecs,r=[];for(var a of[...t,...n])if(a.mimeType!=="video/rtx"){r.push(a);try{e.setCodecPreferences(r)}catch(o){D.info("Working around buggy WebRTC impl: claimed to support codec but threw when setting codec preferences",a,o),r.pop()}}}}}sendVoipEvent(e,t){var n=this;return A(function*(){var r=ch(ch({},t),{},{version:IN,call_id:n.callId,party_id:n.ourPartyId,conf_id:n.groupCallId});if(n.opponentDeviceId){var a,o=n.toDeviceSeq++,c=ch(ch({},r),{},{device_id:n.client.deviceId,sender_session_id:n.client.getSessionId(),dest_session_id:n.opponentSessionId,seq:o,[Of]:eN()});n.emit(qe.SendVoipEvent,{type:"toDevice",eventType:e,userId:n.invitee||((a=n.getOpponentMember())===null||a===void 0?void 0:a.userId),opponentDeviceId:n.opponentDeviceId,content:c},n);var d=n.invitee||n.getOpponentMember().userId;if(n.client.getUseE2eForGroupCall()){if(!n.hasOpponentDeviceInfo){D.warn("Call ".concat(n.callId," sendVoipEvent() failed: we do not have opponentDeviceInfo"));return}throw new Error("Unimplemented")}else yield n.client.sendToDevice(e,new Map([[d,new Map([[n.opponentDeviceId,c]])]]))}else{var h;n.emit(qe.SendVoipEvent,{type:"sendEvent",eventType:e,roomId:n.roomId,content:r,userId:n.invitee||((h=n.getOpponentMember())===null||h===void 0?void 0:h.userId)},n),yield n.client.sendEvent(n.roomId,e,r)}})()}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,!(this.state===Me.Ringing||!this.inviteOrAnswerSent)){var t=this.direction===Oa.Inbound?500:2e3;this.candidateSendTries===0&&setTimeout(()=>{this.sendCandidateQueue()},t)}}discardDuplicateCandidates(){for(var e=0,t=[],n=0;n<this.candidateSendQueue.length;n++){var r=this.candidateSendQueue[n];r.candidate===""?t.push(r):e++}return this.candidateSendQueue=t,e}transfer(e){var t=this;return A(function*(){var n=yield t.client.getProfileInfo(e),r=Cs(),a={replacement_id:Cs(),target_user:{id:e,display_name:n.displayname,avatar_url:n.avatar_url},create_call:r};yield t.sendVoipEvent(G.CallReplaces,a),yield t.terminate(Lt.Local,Ue.Transferred,!0)})()}transferToCall(e){var t=this;return A(function*(){var n,r,a=(n=e.getOpponentMember())===null||n===void 0?void 0:n.userId,o=a?yield t.client.getProfileInfo(a):void 0,c=(r=t.getOpponentMember())===null||r===void 0?void 0:r.userId,d=c?yield t.client.getProfileInfo(c):void 0,h=Cs(),v={replacement_id:Cs(),target_user:{id:c,display_name:d?.displayname,avatar_url:d?.avatar_url},await_call:h};yield e.sendVoipEvent(G.CallReplaces,v);var m={replacement_id:Cs(),target_user:{id:a,display_name:o?.displayname,avatar_url:o?.avatar_url},create_call:h};yield t.sendVoipEvent(G.CallReplaces,m),yield t.terminate(Lt.Local,Ue.Transferred,!0),yield e.terminate(Lt.Local,Ue.Transferred,!0)})()}terminate(e,t,n){var r=this;return A(function*(){var a;if(!r.callHasEnded()){r.hangupParty=e,r.hangupReason=t,r.state=Me.Ended,r.inviteTimeout&&(clearTimeout(r.inviteTimeout),r.inviteTimeout=void 0),r.iceDisconnectedTimeout!==void 0&&(clearTimeout(r.iceDisconnectedTimeout),r.iceDisconnectedTimeout=void 0),r.callLengthInterval&&(clearInterval(r.callLengthInterval),r.callLengthInterval=void 0),r.stopVideoTrackTimer!==void 0&&(clearTimeout(r.stopVideoTrackTimer),r.stopVideoTrackTimer=void 0);for(var[o,c]of r.removeTrackListeners)o.removeEventListener("removetrack",c);r.removeTrackListeners.clear(),r.callStatsAtEnd=yield r.collectCallStats(),r.stopAllMedia(),r.deleteAllFeeds(),r.peerConn&&r.peerConn.signalingState!=="closed"&&r.peerConn.close(),(a=r.stats)===null||a===void 0||a.removeStatsReportGatherer(r.callId),n&&r.emit(qe.Hangup,r),r.client.callEventHandler.calls.delete(r.callId)}})()}stopAllMedia(){D.debug("Call ".concat(this.callId," stopAllMedia() running"));for(var e of this.feeds)if(e.isLocal()&&e.purpose===bt.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===bt.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal()){D.debug("Call ".concat(this.callId," stopAllMedia() stopping stream (streamId=").concat(e.stream.id,")"));for(var t of e.stream.getTracks())t.stop()}}checkForErrorListener(){if(this.listeners(Pk.Error).length===0)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}sendCandidateQueue(){var e=this;return A(function*(){if(!(e.candidateSendQueue.length===0||e.callHasEnded())){var t=e.candidateSendQueue;e.candidateSendQueue=[],++e.candidateSendTries;var n={candidates:t.map(c=>c.toJSON())};e.candidatesEnded&&n.candidates.push({candidate:""}),D.debug("Call ".concat(e.callId," sendCandidateQueue() attempting to send ").concat(t.length," candidates"));try{yield e.sendVoipEvent(G.CallCandidates,n),e.candidateSendTries=0,e.sendCandidateQueue()}catch(c){if(c instanceof Ct&&c.event&&e.client.cancelPendingEvent(c.event),e.candidateSendQueue.push(...t),e.candidateSendTries>5){D.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates on attempt ").concat(e.candidateSendTries,". Giving up on this call."),c);var r=Ue.SignallingFailed,a="Signalling failed";e.emit(qe.Error,new Ur(r,a,c),e),e.hangup(r,!1);return}var o=500*Math.pow(2,e.candidateSendTries);++e.candidateSendTries,D.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates. Retrying in ").concat(o,"ms"),c),setTimeout(()=>{e.sendCandidateQueue()},o)}}})()}placeCall(e,t){var n=this;return A(function*(){if(!e)throw new Error("You CANNOT start a call without audio");n.state=Me.WaitLocalMedia;var r;try{var a,o=yield n.client.getMediaHandler().getUserMediaStream(e,t);Yt(o.getAudioTracks(),!0),Yt(o.getVideoTracks(),!0),r=new qr({client:n.client,roomId:n.roomId,userId:n.client.getUserId(),deviceId:(a=n.client.getDeviceId())!==null&&a!==void 0?a:void 0,stream:o,purpose:bt.Usermedia,audioMuted:!1,videoMuted:!1})}catch(c){n.getUserMediaFailed(c);return}try{yield n.placeCallWithCallFeeds([r])}catch(c){n.placeCallFailed(c);return}})()}placeCallWithCallFeeds(e){var t=arguments,n=this;return A(function*(){var r=t.length>1&&t[1]!==void 0?t[1]:!1;n.checkForErrorListener(),n.direction=Oa.Outbound,yield n.initOpponentCrypto(),n.client.callEventHandler.calls.set(n.callId,n);var a=yield n.client.checkTurnServers();a||D.warn("Call ".concat(n.callId," placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...")),n.peerConn=n.createPeerConnection(),n.emit(qe.PeerConnectionCreated,n.peerConn,n),n.gotCallFeedsForInvite(e,r)})()}createPeerConnection(){var e,t=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers.length?this.turnServers:void 0,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});t.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),t.addEventListener("signalingstatechange",this.onSignallingStateChanged),t.addEventListener("icecandidate",this.gotLocalIceCandidate),t.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),t.addEventListener("track",this.onTrack),t.addEventListener("negotiationneeded",this.onNegotiationNeeded),t.addEventListener("datachannel",this.onDataChannel);var n=this.getOpponentMember(),r=n?n.userId:"unknown";return(e=this.stats)===null||e===void 0||e.addStatsReportGatherer(this.callId,r,t),t}partyIdMatches(e){var t=e.version===0?null:e.party_id||null;return t===this.opponentPartyId}chooseOpponent(e){var t,n=e.getContent();if(D.debug("Call ".concat(this.callId," chooseOpponent() running (partyId=").concat(n.party_id,")")),this.opponentVersion=n.version,this.opponentVersion===0?this.opponentPartyId=null:this.opponentPartyId=n.party_id||null,this.opponentCaps=n.capabilities||{},this.opponentMember=(t=this.client.getRoom(this.roomId).getMember(e.getSender()))!==null&&t!==void 0?t:void 0,this.opponentMember){var r;(r=this.stats)===null||r===void 0||r.updateOpponentMember(this.callId,this.opponentMember.userId)}}addBufferedIceCandidates(){var e=this;return A(function*(){var t=e.remoteCandidateBuffer.get(e.opponentPartyId);t&&(D.info("Call ".concat(e.callId," addBufferedIceCandidates() adding ").concat(t.length," buffered candidates for opponent ").concat(e.opponentPartyId)),yield e.addIceCandidates(t)),e.remoteCandidateBuffer.clear()})()}addIceCandidates(e){var t=this;return A(function*(){for(var n of e){(n.sdpMid===null||n.sdpMid===void 0)&&(n.sdpMLineIndex===null||n.sdpMLineIndex===void 0)?D.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE end-of-candidates")):D.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE candidate (sdpMid=").concat(n.sdpMid,", candidate=").concat(n.candidate,")"));try{yield t.peerConn.addIceCandidate(n)}catch(r){t.ignoreOffer?D.debug("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate because ignoring offer"),r):D.info("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate"),r)}}})()}get hasPeerConnection(){return!!this.peerConn}initStats(e){this.stats=e,this.stats.start()}}function Yt(i,e){for(var t of i)t.enabled=e}function Fg(){if(typeof window>"u"||typeof document>"u")return!1;try{var i,e,t,n=!!((i=(e=(t=window.RTCPeerConnection)!==null&&t!==void 0?t:window.RTCSessionDescription)!==null&&e!==void 0?e:window.RTCIceCandidate)!==null&&i!==void 0?i:navigator.mediaDevices);if(!n)return D.error("WebRTC is not supported in this browser / environment"),!1}catch(r){return D.error("Exception thrown when trying to access WebRTC",r),!1}return!0}function ou(i,e,t){if(!Fg())return null;var n=t?t.forceTURN:!1,r={client:i,roomId:e,invitee:t?.invitee,turnServers:i.getTurnServers(),forceTURN:i.forceTURN||n,opponentDeviceId:t?.opponentDeviceId,opponentSessionId:t?.opponentSessionId,groupCallId:t?.groupCallId},a=new DN(r);return i.reEmitter.reEmit(a,Object.values(qe)),a}var ja=(function(i){return i.DontNotify="dont_notify",i.Notify="notify",i.Coalesce="coalesce",i})({}),nb=(function(i){return i.Highlight="highlight",i.Sound="sound",i})({}),NN=(function(i){return i.ExactEquals="==",i.LessThan="<",i.GreaterThan=">",i.GreaterThanOrEqual=">=",i.LessThanOrEqual="<=",i})({}),xN="2";function LN(i){return i==="==2"||i==="2"}var $t=(function(i){return i.EventMatch="event_match",i.EventPropertyIs="event_property_is",i.EventPropertyContains="event_property_contains",i.ContainsDisplayName="contains_display_name",i.RoomMemberCount="room_member_count",i.SenderNotificationPermission="sender_notification_permission",i.CallStarted="call_started",i.CallStartedPrefix="org.matrix.msc3914.call_started",i})({}),un=(function(i){return i.Override="override",i.ContentSpecific="content",i.RoomSpecific="room",i.SenderSpecific="sender",i.Underride="underride",i})({}),cn=(function(i){return i.Master=".m.rule.master",i.IsUserMention=".m.rule.is_user_mention",i.IsRoomMention=".m.rule.is_room_mention",i.ContainsDisplayName=".m.rule.contains_display_name",i.ContainsUserName=".m.rule.contains_user_name",i.AtRoomNotification=".m.rule.roomnotif",i.DM=".m.rule.room_one_to_one",i.EncryptedDM=".m.rule.encrypted_room_one_to_one",i.Message=".m.rule.message",i.EncryptedMessage=".m.rule.encrypted",i.InviteToSelf=".m.rule.invite_for_me",i.MemberEvent=".m.rule.member_event",i.IncomingCall=".m.rule.call",i.SuppressNotices=".m.rule.suppress_notices",i.Tombstone=".m.rule.tombstone",i.PollStart=".m.rule.poll_start",i.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",i.PollEnd=".m.rule.poll_end",i.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",i.PollStartOneToOne=".m.rule.poll_start_one_to_one",i.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",i.PollEndOneToOne=".m.rule.poll_end_one_to_one",i.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",i})({});function oC(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function lC(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?oC(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):oC(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}var cC=[un.Override,un.ContentSpecific,un.RoomSpecific,un.SenderSpecific,un.Underride],UN={".m.rule.is_room_mention":{rule_id:".m.rule.is_room_mention",default:!0,enabled:!0,conditions:[{kind:$t.EventPropertyIs,key:"content.m\\.mentions.room",value:!0},{kind:$t.SenderNotificationPermission,key:"room"}],actions:[ja.Notify,{set_tweak:nb.Highlight}]},".m.rule.reaction":{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:$t.EventMatch,key:"type",pattern:"m.reaction"}],actions:[ja.DontNotify]},".org.matrix.msc3786.rule.room.server_acl":{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:$t.EventMatch,key:"type",pattern:G.RoomServerAcl},{kind:$t.EventMatch,key:"state_key",pattern:""}],actions:[]}},ib=Symbol("UserDefinedRules"),BN=[cn.Master,ib,cn.SuppressNotices,cn.InviteToSelf,cn.MemberEvent,cn.IsUserMention,cn.ContainsDisplayName,cn.IsRoomMention,cn.AtRoomNotification,cn.Tombstone,".m.rule.reaction",".m.rule.room.server_acl",".org.matrix.msc3786.rule.room.server_acl",".m.rule.suppress_edits"],FN={".org.matrix.msc3914.rule.room.call":{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:$t.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:$t.CallStarted}],actions:[ja.Notify,{set_tweak:nb.Sound,value:"default"}]}},jN=[ib,cn.IncomingCall,".org.matrix.msc3914.rule.room.call",cn.EncryptedDM,cn.DM,cn.Message,cn.EncryptedMessage];function uC(i,e,t,n,r){var a=t.filter(T=>T.default),o=t.filter(T=>!T.default);function c(T){T===ib?h.push(...o):T in n?(i.warn("Adding default global ".concat(e," push rule ").concat(T)),h.push(n[T])):i.warn("Missing default global ".concat(e," push rule ").concat(T))}var d=0,h=[];for(var v of a){var m=r.indexOf(v.rule_id);if(m===-1){h.push(v);continue}for(;m>d;){var y=r[d];c(y),d+=1}h.push(v),d+=1}for(var E of r.slice(d))c(E);return h}class Bi{constructor(e){this.client=e,b(this,"parsedKeys",new Map)}static actionListToActionsObject(e){var t={notify:!1,tweaks:{}};for(var n of e)n===ja.Notify?t.notify=!0:typeof n=="object"&&(n.value===void 0&&(n.value=!0),t.tweaks[n.set_tweak]=n.value);return t}static rewriteDefaultRules(e,t){var n=JSON.parse(JSON.stringify(t));return n||(n={}),n.global||(n.global={}),n.global.override||(n.global.override=[]),n.global.underride||(n.global.underride=[]),n.global.override=uC(e,un.Override,n.global.override,UN,BN),n.global.underride=uC(e,un.Underride,n.global.underride,FN,jN),n}static getPushRuleGlobRegex(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"i",[r,a]=t?["(?<=^|\\W)","(?=\\W|$)"]:["^","$"],o="".concat(t,"-").concat(n,"-").concat(e);return Bi.cachedGlobToRegex[o]||(Bi.cachedGlobToRegex[o]=new RegExp(r+"("+kk(e)+")"+a,n)),Bi.cachedGlobToRegex[o]}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);var t=new Set(this.parsedKeys.keys());for(var n of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(var r of n)if(r.conditions)for(var a of r.conditions)a.kind===$t.EventMatch&&(t.delete(a.key),this.parsedKeys.set(a.key,Bi.partsForDottedKey(a.key)));t.forEach(o=>this.parsedKeys.delete(o))}matchingRuleFromKindSet(e,t){for(var n of cC){var r=t[n];if(r){for(var a of r)if(a.enabled){var o=this.templateRuleToRaw(n,a);if(o&&this.ruleMatchesEvent(o,e))return lC(lC({},a),{},{kind:n})}}}return null}templateRuleToRaw(e,t){var n={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case un.Underride:case un.Override:n.conditions=t.conditions;break;case un.RoomSpecific:if(!t.rule_id)return null;n.conditions.push({kind:$t.EventMatch,key:"room_id",value:t.rule_id});break;case un.SenderSpecific:if(!t.rule_id)return null;n.conditions.push({kind:$t.EventMatch,key:"user_id",value:t.rule_id});break;case un.ContentSpecific:if(!t.pattern)return null;n.conditions.push({kind:$t.EventMatch,key:"content.body",pattern:t.pattern});break}return n}eventFulfillsCondition(e,t){switch(e.kind){case $t.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case $t.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case $t.EventPropertyContains:return this.eventFulfillsEventPropertyContains(e,t);case $t.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case $t.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case $t.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case $t.CallStarted:case $t.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){var n=e.key;if(!n)return!1;var r=this.client.getRoom(t.getRoomId());return r!=null&&r.currentState?r.currentState.mayTriggerNotifOfType(n,t.getSender()):!1}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;var n=this.client.getRoom(t.getRoomId());if(!n||!n.currentState||!n.currentState.members)return!1;var r=n.currentState.getJoinedMemberCount(),a=e.is.match(/^([=<>]*)(\d*)$/);if(!a)return!1;var o=a[1],c=parseInt(a[2]);if(isNaN(c))return!1;switch(o){case"":case"==":return r==c;case"<":return r<c;case">":return r>c;case"<=":return r<=c;case">=":return r>=c;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var n,r=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(r=t.getClearContent()),!r||!r.body||typeof r.body!="string")return!1;var a=this.client.getRoom(t.getRoomId()),o=a==null||(n=a.currentState)===null||n===void 0?void 0:n.getMember(this.client.credentials.userId);if(!o)return!1;var c=o.name,d=new RegExp("(^|\\W)"+Rk(c)+"(\\W|$)","i");return r.body.search(d)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;var n=this.valueForDottedKey(e.key,t);if(typeof n!="string")return!1;if(e.value)return e.value===n;if(typeof e.pattern!="string")return!1;var r=Bi.getPushRuleGlobRegex(e.pattern,e.key==="content.body");return!!n.match(r)}eventFulfillsEventPropertyIsCondition(e,t){return!e.key||e.value===void 0?!1:e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||e.value===void 0)return!1;var n=this.valueForDottedKey(e.key,t);return Array.isArray(n)?n.includes(e.value):!1}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||cl(t.getPrevContent(),{}))}static partsForDottedKey(e){var t=[],n="",r=!1;for(var a of e){if(r){a==="\\"||a==="."?n+=a:n+="\\"+a,r=!1;continue}a=="."?(t.push(n),n=""):a=="\\"?r=!0:n+=a}return r&&(n+="\\"),t.push(n),t}valueForDottedKey(e,t){var n=this.parsedKeys.get(e);n===void 0&&(n=Bi.partsForDottedKey(e),this.parsedKeys.set(e,n));var r,a=n[0],o=0;for(a==="content"?(r=t.getContent(),++o):a==="type"?(r=t.getType(),++o):r=t.event;o<n.length;++o){if(wk(r))return;var c=n[o];r=r[c]}return r}matchingRuleForEventWithRulesets(e,t){return!t||e.getSender()===this.client.getSafeUserId()?null:this.matchingRuleFromKindSet(e,t.global)}pushActionsForEventAndRulesets(e,t){var n=this.matchingRuleForEventWithRulesets(e,t);if(!n)return{};var r=Bi.actionListToActionsObject(n.actions);return r.tweaks.highlight===void 0&&(r.tweaks.highlight=n.kind==un.ContentSpecific),{actions:r,rule:n}}ruleMatchesEvent(e,t){var n;return this.client.supportsIntentionalMentions()&&t.getContent()["m.mentions"]!==void 0&&(e.rule_id===cn.ContainsUserName||e.rule_id===cn.ContainsDisplayName||e.rule_id===cn.AtRoomNotification)?!1:!((n=e.conditions)!==null&&n!==void 0&&n.some(r=>!this.eventFulfillsCondition(r,t)))}actionsForEvent(e){var{actions:t}=this.pushActionsForEventAndRulesets(e,this.client.pushRules);return t||{}}actionsAndRuleForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){var t,n=this.getPushRuleAndKindById(e);return(t=n?.rule)!==null&&t!==void 0?t:null}getPushRuleAndKindById(e){for(var t of["global"]){var n;if(((n=this.client.pushRules)===null||n===void 0?void 0:n[t])!==void 0){for(var r of cC)if(this.client.pushRules[t][r]!==void 0){for(var a of this.client.pushRules[t][r])if(a.rule_id===e)return{rule:a,kind:r}}}}return null}}b(Bi,"cachedGlobToRegex",{});var lu=["v1.1","v1.2","v1.3","v1.4","v1.5","v1.6","v1.7","v1.8","v1.9"],qN=lu[0],VN=lu[lu.length-1],ui=(function(i){return i.SUCCESS="SUCCESS",i.IGNORE="IGNORE",i.PROMPT="PROMPT",i.FAIL_PROMPT="FAIL_PROMPT",i.FAIL_ERROR="FAIL_ERROR",i})({}),Mi=(function(i){return i.Invalid="Invalid homeserver discovery response",i.GenericFailure="Failed to get autodiscovery configuration from server",i.InvalidHsBaseUrl="Invalid base_url for m.homeserver",i.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",i.InvalidIsBaseUrl="Invalid base_url for m.identity_server",i.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",i.InvalidIs="Invalid identity server discovery response",i.MissingWellknown="No .well-known JSON file found",i.InvalidJson="Invalid JSON",i.UnsupportedHomeserverSpecVersion="The homeserver does not meet the version requirements",i})({});class De{static fromDiscoveryConfig(e){var t=this;return A(function*(){var n,r={"m.homeserver":{state:De.FAIL_ERROR,error:De.ERROR_INVALID,base_url:null},"m.identity_server":{state:De.PROMPT,error:null,base_url:null}};if(!(e!=null&&e["m.homeserver"]))return D.error("No m.homeserver key in config"),r["m.homeserver"].state=De.FAIL_PROMPT,r["m.homeserver"].error=De.ERROR_INVALID,Promise.resolve(r);if(!e["m.homeserver"].base_url)return D.error("No m.homeserver base_url in config"),r["m.homeserver"].state=De.FAIL_PROMPT,r["m.homeserver"].error=De.ERROR_INVALID_HS_BASE_URL,Promise.resolve(r);var a=t.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!a)return D.error("Invalid base_url for m.homeserver"),r["m.homeserver"].error=De.ERROR_INVALID_HS_BASE_URL,Promise.resolve(r);var o=yield t.fetchWellKnownObject("".concat(a,"/_matrix/client/versions"));if(!o||!Array.isArray((n=o.raw)===null||n===void 0?void 0:n.versions))return D.error("Invalid /versions response"),r["m.homeserver"].error=De.ERROR_INVALID_HOMESERVER,r["m.homeserver"].base_url=a,Promise.resolve(r);var c=new Set(o.raw.versions),d=!1;for(var h of lu)if(c.has(h)){d=!0;break}if(!d)return D.error("Homeserver does not meet version requirements"),r["m.homeserver"].error=De.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,r["m.homeserver"].base_url=a,Promise.resolve(r);r["m.homeserver"]={state:De.SUCCESS,error:null,base_url:a};var v="";if(e["m.identity_server"]){var m={"m.homeserver":r["m.homeserver"],"m.identity_server":{state:De.FAIL_PROMPT,error:De.ERROR_INVALID_IS,base_url:null}};if(v=t.sanitizeWellKnownUrl(e["m.identity_server"].base_url),!v)return D.error("Invalid base_url for m.identity_server"),m["m.identity_server"].error=De.ERROR_INVALID_IS_BASE_URL,Promise.resolve(m);var y=yield t.fetchWellKnownObject("".concat(v,"/_matrix/identity/v2"));if(!(y!=null&&y.raw)||y.action!==ui.SUCCESS)return D.error("Invalid /v2 response"),m["m.identity_server"].error=De.ERROR_INVALID_IDENTITY_SERVER,m["m.identity_server"].base_url=v,Promise.resolve(m)}return v&&v.toString().length>0&&(r["m.identity_server"]={state:De.SUCCESS,error:null,base_url:v}),Object.keys(e).forEach(E=>{if(E==="m.homeserver"||E==="m.identity_server"){var T=["error","state","base_url"];for(var S of Object.keys(e[E]))T.includes(S)||(r[E][S]=e[E][S])}else r[E]=e[E]}),Promise.resolve(r)})()}static findClientConfig(e){var t=this;return A(function*(){if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var n={"m.homeserver":{state:De.FAIL_ERROR,error:De.ERROR_INVALID,base_url:null},"m.identity_server":{state:De.PROMPT,error:null,base_url:null}},r=e.includes("://")?e:"https://".concat(e),a=yield t.fetchWellKnownObject("".concat(r,"/.well-known/matrix/client"));return!a||a.action!==ui.SUCCESS?(D.error("No response or error when parsing .well-known"),a.reason&&D.error(a.reason),a.action===ui.IGNORE?n["m.homeserver"]={state:De.PROMPT,error:null,base_url:null}:(n["m.homeserver"].state=De.FAIL_PROMPT,n["m.homeserver"].error=De.ERROR_INVALID),Promise.resolve(n)):De.fromDiscoveryConfig(a.raw)})()}static getRawClientConfig(e){var t=this;return A(function*(){var n;if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var r=yield t.fetchWellKnownObject("https://".concat(e,"/.well-known/matrix/client"));return r?(n=r.raw)!==null&&n!==void 0?n:{}:{}})()}static sanitizeWellKnownUrl(e){if(!e)return!1;try{var t,n;try{n=new URL(e)}catch(c){D.error("Could not parse url",c)}if(!((t=n)!==null&&t!==void 0&&t.hostname)||n.protocol!=="http:"&&n.protocol!=="https:")return!1;var r=n.port?":".concat(n.port):"",a=n.pathname?n.pathname:"",o="".concat(n.protocol,"//").concat(n.hostname).concat(r).concat(a);return o.endsWith("/")&&(o=o.substring(0,o.length-1)),o}catch(c){return D.error(c),!1}}static fetch(e,t){return this.fetchFn?this.fetchFn(e,t):globalThis.fetch(e,t)}static setFetchFn(e){De.fetchFn=e}static fetchWellKnownObject(e){return A(function*(){var t;try{if(t=yield De.fetch(e,{method:$.Get,signal:Mf(5e3)}),t.status===404)return{raw:{},action:ui.IGNORE,reason:De.ERROR_MISSING_WELLKNOWN};if(t.status!==200)return{raw:{},action:ui.FAIL_PROMPT,reason:"General failure"}}catch(o){var n=o,r="";return typeof n=="object"&&(r=n?.message),{error:n,raw:{},action:ui.FAIL_PROMPT,reason:r||"General failure"}}try{return{raw:yield t.json(),action:ui.SUCCESS}}catch(o){var a=o;return{error:a,raw:{},action:ui.FAIL_PROMPT,reason:a?.name==="SyntaxError"?De.ERROR_INVALID_JSON:De.ERROR_INVALID}}})()}}b(De,"ERROR_INVALID",Mi.Invalid);b(De,"ERROR_GENERIC_FAILURE",Mi.GenericFailure);b(De,"ERROR_INVALID_HS_BASE_URL",Mi.InvalidHsBaseUrl);b(De,"ERROR_INVALID_HOMESERVER",Mi.InvalidHomeserver);b(De,"ERROR_INVALID_IS_BASE_URL",Mi.InvalidIsBaseUrl);b(De,"ERROR_INVALID_IDENTITY_SERVER",Mi.InvalidIdentityServer);b(De,"ERROR_INVALID_IS",Mi.InvalidIs);b(De,"ERROR_MISSING_WELLKNOWN",Mi.MissingWellknown);b(De,"ERROR_INVALID_JSON",Mi.InvalidJson);b(De,"ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION",Mi.UnsupportedHomeserverSpecVersion);b(De,"ALL_ERRORS",Object.keys(Mi));b(De,"FAIL_ERROR",ui.FAIL_ERROR);b(De,"FAIL_PROMPT",ui.FAIL_PROMPT);b(De,"PROMPT",ui.PROMPT);b(De,"SUCCESS",ui.SUCCESS);b(De,"fetchFn",void 0);var jg=(function(i){return i.IS="SERVICE_TYPE_IS",i.IM="SERVICE_TYPE_IM",i})({});class KN{constructor(e){this.ourEvent=e,b(this,"timeline",void 0),b(this,"ourEventIndex",0),b(this,"paginateTokens",{[Be.Backward]:null,[Be.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return this.paginateTokens[e?Be.Backward:Be.Forward]}setPaginateToken(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.paginateTokens[t?Be.Backward:Be.Forward]=e??null}addEvents(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}class Nf{static fromJson(e,t){var n=e.context||{},r=(n.events_before||[]).map(t),a=(n.events_after||[]).map(t),o=new KN(t(e.result)),c=o.ourEvent.threadRootId;return r=r.filter(d=>d.threadRootId===c),a=a.filter(d=>d.threadRootId===c),o.setPaginateToken(n.start,!0),o.addEvents(r,!0),o.addEvents(a,!1),o.setPaginateToken(n.end,!1),new Nf(e.rank,o)}constructor(e,t){this.rank=e,this.context=t}}function Qh(i){return"parent_delay_id"in i&&typeof i.parent_delay_id!="string"?!1:"delay"in i&&typeof i.delay!="number"?!0:"delay"in i||"parent_delay_id"in i}var Ls=(function(i){return i.Cancel="cancel",i.Restart="restart",i.Send="send",i})({}),HN=(function(i){return i.Public="public",i.Private="private",i})({}),rb=(function(i){return i.PrivateChat="private_chat",i.TrustedPrivateChat="trusted_private_chat",i.PublicChat="public_chat",i})({}),Ow=(function(i){return i.Public="public",i.Invite="invite",i.Private="private",i.Knock="knock",i.Restricted="restricted",i})({}),GN=(function(i){return i.RoomMembership="m.room_membership",i})({}),Zh=(function(i){return i.CanJoin="can_join",i.Forbidden="forbidden",i})({}),ab=(function(i){return i.Invited="invited",i.Joined="joined",i.Shared="shared",i.WorldReadable="world_readable",i})({});function dC(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function hC(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?dC(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):dC(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}function zN(i,e){var t=!!e.preventReEmit,n=e.decrypt!==!1;function r(a){var o=i.getRoom(a.room_id),c;o&&a.state_key===void 0&&(c=o.findEventById(a.event_id)),!c||c.status?c=new Sn(a):(c.setUnsigned(hC(hC({},c.getUnsigned()),a.unsigned)),t=!0);var d=c.getServerAggregatedRelation(Et.Replace);if(d!=null&&d.content){var h=r(d);c.makeReplaced(h)}var v=o?.findThreadForEvent(c);return v&&c.setThread(v),c.isEncrypted()&&(t||i.reEmitter.reEmit(c,[ot.Decrypted]),n&&i.decryptEventIfNeeded(c)),t||(i.reEmitter.reEmit(c,[ot.Replaced,ot.VisibilityChange]),o?.reEmitter.reEmit(c,[ot.BeforeRedaction])),c}return r}function fC(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function ka(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?fC(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):fC(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}class vC{constructor(e,t,n){this.client=e,this.indexEvent=t,this.directory=n}get id(){var e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return this.indexEvent.getContent().active===!0}get version(){var e;return(e=this.indexEvent.getContent().version)!==null&&e!==void 0?e:1}get roomId(){return this.indexEvent.getRoomId()}delete(){var e=this;return A(function*(){yield e.client.sendStateEvent(e.roomId,jr.name,{},e.id),yield e.client.redactEvent(e.roomId,e.id);var t=(yield e.getVersionHistory())[1];t&&(yield t.delete())})()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}setName(e){var t=this;return A(function*(){yield t.client.sendStateEvent(t.roomId,jr.name,ka(ka({},t.indexEvent.getContent()),{},{name:e}),t.id)})()}isLocked(){return this.indexEvent.getContent().locked||!1}setLocked(e){var t=this;return A(function*(){yield t.client.sendStateEvent(t.roomId,jr.name,ka(ka({},t.indexEvent.getContent()),{},{locked:e}),t.id)})()}getFileInfo(){var e=this;return A(function*(){var t=yield e.getFileEvent(),n=t.getOriginalContent().file,r=e.client.mxcUrlToHttp(n.url);if(!r)throw new Error("No HTTP URL available for ".concat(n.url));return{info:n,httpUrl:r}})()}getFileEvent(){var e=this;return A(function*(){var t=e.client.getRoom(e.roomId);if(!t)throw new Error("Unknown room");for(var n=t.getUnfilteredTimelineSet().findEventById(e.id);!n&&t.getLiveTimeline().getState(me.BACKWARDS).paginationToken;)yield e.client.scrollback(t,100),n=t.getUnfilteredTimelineSet().findEventById(e.id);if(!n)throw new Error("Failed to find event");return yield e.client.decryptEventIfNeeded(n),n})()}createNewVersion(e,t,n,r){var a=this;return A(function*(){var o=yield a.directory.createFile(e,t,n,ka(ka({},r??{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:Et.Replace,event_id:a.id}}));return yield a.client.sendStateEvent(a.roomId,jr.name,{active:!0,name:e,version:a.version+1},o.event_id),yield a.client.sendStateEvent(a.roomId,jr.name,ka(ka({},a.indexEvent.getContent()),{},{active:!1}),a.id),o})()}getVersionHistory(){var e=this;return A(function*(){var t=[];t.push(e);var n=e.client.getRoom(e.roomId);if(!n)throw new Error("Invalid or unknown room");var r=[...n.getLiveTimeline().getEvents()].reverse(),a,o=yield e.getFileEvent();do if(a=r.find(d=>d.replacingEventId()===o.getId()),a){var c=e.directory.getFile(a.getId());if(c)t.push(c),o=a;else break}while(a);return t})()}}function mC(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function bs(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?mC(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):mC(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}var WN={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[G.RoomPowerLevels]:100,[G.RoomHistoryVisibility]:100,[G.RoomTombstone]:100,[G.RoomEncryption]:100,[G.RoomName]:50,[G.RoomMessage]:50,[G.RoomMessageEncrypted]:50,[G.Sticker]:50},users:{}},Uo=(function(i){return i.Viewer="viewer",i.Editor="editor",i.Owner="owner",i})({});class pC{constructor(e,t){if(this.client=e,this.roomId=t,b(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){var e=this.room.currentState.getStateEvents(G.SpaceParent);return e!=null&&e.length?e.every(t=>{var n;return!((n=t.getContent())!==null&&n!==void 0&&n.via)}):!0}setName(e){var t=this;return A(function*(){yield t.client.sendStateEvent(t.roomId,G.RoomName,{name:e},"")})()}invite(e){var t=arguments,n=this;return A(function*(){var r=t.length>1&&t[1]!==void 0?t[1]:!0,a=[n.retryInvite(e)];r&&a.push(...n.getDirectories().map(o=>o.invite(e,r))),yield Promise.all(a)})()}retryInvite(e){var t=this;return A(function*(){yield OD(()=>t.client.invite(t.roomId,e),n=>!(n instanceof Ct&&n.errcode==="M_FORBIDDEN"))})()}setPermissions(e,t){var n=this;return A(function*(){var r,a=n.room.currentState.getStateEvents(G.RoomPowerLevels,"");if(Array.isArray(a))throw new Error("Unexpected return type for power levels");var o=a?.getContent()||{},c=o.users_default||0,d=o.events_default||50,h=((r=o.events)===null||r===void 0?void 0:r[G.RoomPowerLevels])||100,v=o.users||{};switch(t){case Uo.Viewer:v[e]=c;break;case Uo.Editor:v[e]=d;break;case Uo.Owner:v[e]=h;break;default:throw new Error("Invalid role: "+t)}o.users=v,yield n.client.sendStateEvent(n.roomId,G.RoomPowerLevels,o,"")})()}getPermissions(e){var t,n,r=this.room.currentState.getStateEvents(G.RoomPowerLevels,"");if(Array.isArray(r))throw new Error("Unexpected return type for power levels");var a=r?.getContent()||{},o=a.users_default||0,c=a.events_default||50,d=((t=a.events)===null||t===void 0?void 0:t[G.RoomPowerLevels])||100,h=((n=a.users)===null||n===void 0?void 0:n[e])||o;return h>=d?Uo.Owner:h>=c?Uo.Editor:Uo.Viewer}createDirectory(e){var t=this;return A(function*(){var n=yield t.client.unstableCreateFileTree(e);return yield t.client.sendStateEvent(t.roomId,G.SpaceChild,{via:[t.client.getDomain()]},n.roomId),yield t.client.sendStateEvent(n.roomId,G.SpaceParent,{via:[t.client.getDomain()]},t.roomId),n})()}getDirectories(){var e=[],t=this.room.currentState.getStateEvents(G.SpaceChild);for(var n of t)try{var r=n.getStateKey();if(r){var a=this.client.unstableGetFileTreeSpace(r);a&&e.push(a)}}catch(o){D.warn("Unable to create tree space instance for listing. Are we joined?",o)}return e}getDirectory(e){return this.getDirectories().find(t=>t.roomId===e)}delete(){var e=this;return A(function*(){var t=e.getDirectories();for(var n of t)yield n.delete();var r=[Ne.Invite,Ne.Knock,Ne.Join],a=e.room.currentState.getStateEvents(G.RoomMember);for(var o of a){var c=o.getStateKey()!==e.client.getUserId();if(c&&r.includes(o.getContent().membership)){var d=o.getStateKey();if(!d)throw new Error("State key not found for branch");yield e.client.kick(e.roomId,d,"Room deleted")}}yield e.client.leave(e.roomId)})()}getOrderedChildren(e){var t=e.map(n=>({roomId:n.getStateKey(),order:n.getContent().order})).filter(n=>n.roomId);return t.sort((n,r)=>{if(n.order&&!r.order)return-1;if(!n.order&&r.order)return 1;if(!n.order&&!r.order){var a,o,c,d,h=this.client.getRoom(n.roomId),v=this.client.getRoom(r.roomId);if(!h||!v)return yh(n.roomId,r.roomId);var m=(a=(o=h.currentState.getStateEvents(G.RoomCreate,""))===null||o===void 0?void 0:o.getTs())!==null&&a!==void 0?a:0,y=(c=(d=v.currentState.getStateEvents(G.RoomCreate,""))===null||d===void 0?void 0:d.getTs())!==null&&c!==void 0?c:0;return m===y?yh(n.roomId,r.roomId):m-y}else return yh(n.order,r.order)}),t}getParentRoom(){var e=this.room.currentState.getStateEvents(G.SpaceParent),t=e[0];if(!t)throw new Error("Expected to have a parent in a non-top level space");var n=t.getStateKey();if(!n)throw new Error("No state key found for parent");var r=this.client.getRoom(n);if(!r)throw new Error("Unable to locate room for parent");return r}getOrder(){if(this.isTopLevel)return-1;var e=this.getParentRoom(),t=e.currentState.getStateEvents(G.SpaceChild),n=this.getOrderedChildren(t);return n.findIndex(r=>r.roomId===this.roomId)}setOrder(e){var t=this;return A(function*(){var n;if(t.isTopLevel)throw new Error("Cannot set order of top level spaces currently");var r=t.getParentRoom(),a=r.currentState.getStateEvents(G.SpaceChild),o=t.getOrderedChildren(a);e=Math.max(Math.min(e,o.length-1),0);var c=t.getOrder(),d=c<e;d&&e===o.length-1?e--:!d&&e===0&&e++;var h=o[d?e:e-1],v=o[d?e+1:e],m=Ga[0],y=!1;if(!h)v!=null&&v.order&&(m=r_(v.order));else if(e===o.length-1)v!=null&&v.order&&(m=yc(v.order));else{var E=h?.order,T=v?.order;E&&T?E===T?m=yc(E):m=MD(E,T):E?m=yc(E):T?m=r_(T):y=!0}if(y){for(var S,O=0;O<=e;O++){var R=o[O];if(O===0&&(S=R.order),R.order)S=R.order;else{var I;S=S?yc(S):Ga[0];var M=r.currentState.getStateEvents(G.SpaceChild,R.roomId),C=(I=M?.getContent())!==null&&I!==void 0?I:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(r.roomId,G.SpaceChild,bs(bs({},C),{},{order:S}),R.roomId)}}S&&(m=yc(S))}var k=r.currentState.getStateEvents(G.SpaceChild,t.roomId),_=(n=k?.getContent())!==null&&n!==void 0?n:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(r.roomId,G.SpaceChild,bs(bs({},_),{},{order:m}),t.roomId)})()}createFile(e,t,n,r){var a=this;return A(function*(){var{content_uri:o}=yield a.client.uploadContent(t,{includeFilename:!1});n.url=o;var c={msgtype:hr.File,body:e,url:o,file:n};r=r??{},r["m.new_content"]&&(r["m.new_content"]=c);var d=yield a.client.sendMessage(a.roomId,bs(bs(bs({},r),c),{},{[Ak.name]:{}}));return yield a.client.sendStateEvent(a.roomId,jr.name,{active:!0,name:e},d.event_id),d})()}getFile(e){var t=this.room.currentState.getStateEvents(jr.name,e);return t?new vC(this.client,t,this):null}listFiles(){return this.listAllFiles().filter(e=>e.isActive)}listAllFiles(){var e,t=(e=this.room.currentState.getStateEvents(jr.name))!==null&&e!==void 0?e:[];return t.map(n=>new vC(this.client,n,this))}}var Mw=(function(i){return i.Recent="recent",i.Rank="rank",i})({}),Rs=(function(i){return i.LocalStreamsChanged="local_streams_changed",i})({});class JN extends Ot{constructor(e){super(),this.client=e,b(this,"audioInput",void 0),b(this,"audioSettings",void 0),b(this,"videoInput",void 0),b(this,"localUserMediaStream",void 0),b(this,"userMediaStreams",[]),b(this,"screensharingStreams",[]),b(this,"getMediaStreamPromise",void 0)}restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}setAudioInput(e){var t=this;return A(function*(){D.info("MediaHandler setAudioInput() running (deviceId=".concat(e,")")),t.audioInput!==e&&(t.audioInput=e,yield t.updateLocalUsermediaStreams())})()}setAudioSettings(e){var t=this;return A(function*(){D.info("MediaHandler setAudioSettings() running (opts=".concat(JSON.stringify(e),")")),t.audioSettings=Object.assign({},e),yield t.updateLocalUsermediaStreams()})()}setVideoInput(e){var t=this;return A(function*(){D.info("MediaHandler setVideoInput() running (deviceId=".concat(e,")")),t.videoInput!==e&&(t.videoInput=e,yield t.updateLocalUsermediaStreams())})()}setMediaInputs(e,t){var n=this;return A(function*(){D.log("MediaHandler setMediaInputs() running (audioInput: ".concat(e," videoInput: ").concat(t,")")),n.audioInput=e,n.videoInput=t,yield n.updateLocalUsermediaStreams()})()}updateLocalUsermediaStreams(){var e=this;return A(function*(){if(e.userMediaStreams.length!==0){var t=new Map;for(var n of e.client.callEventHandler.calls.values())t.set(n.callId,{audio:n.hasLocalUserMediaAudioTrack,video:n.hasLocalUserMediaVideoTrack});for(var r of e.userMediaStreams){D.log("MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=".concat(r.id,")"));for(var a of r.getTracks())a.stop()}e.userMediaStreams=[],e.localUserMediaStream=void 0;for(var o of e.client.callEventHandler.calls.values())if(!(o.callHasEnded()||!t.has(o.callId))){var{audio:c,video:d}=t.get(o.callId);D.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=".concat(o.callId,")"));var h=yield e.getUserMediaStream(c,d);o.callHasEnded()||(yield o.updateLocalUsermediaStream(h))}for(var v of e.client.groupCallEventHandler.groupCalls.values())if(v.localCallFeed){D.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=".concat(v.groupCallId,")"));var m=yield e.getUserMediaStream(!0,v.type===Df.Video);v.state!==Dt.Ended&&(yield v.updateLocalUsermediaStream(m))}e.emit(Rs.LocalStreamsChanged)}})()}hasAudioDevice(){return A(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="audioinput").length>0}catch(t){return D.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}hasVideoDevice(){return A(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="videoinput").length>0}catch(t){return D.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}getUserMediaStream(e,t){var n=arguments,r=this;return A(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:!0;return r.getMediaStreamPromise?r.getMediaStreamPromise=r.getMediaStreamPromise.then(()=>r.getUserMediaStreamInternal(e,t,a)):r.getMediaStreamPromise=r.getUserMediaStreamInternal(e,t,a),r.getMediaStreamPromise})()}getUserMediaStreamInternal(e,t,n){var r=this;return A(function*(){var a=e&&(yield r.hasAudioDevice()),o=t&&(yield r.hasVideoDevice()),c,d=!0;if(r.localUserMediaStream){var h,v;a!==r.localUserMediaStream.getAudioTracks().length>0&&(d=!1),o!==r.localUserMediaStream.getVideoTracks().length>0&&(d=!1),a&&((h=r.localUserMediaStream.getAudioTracks()[0])===null||h===void 0||(h=h.getSettings())===null||h===void 0?void 0:h.deviceId)!==r.audioInput&&(d=!1),o&&((v=r.localUserMediaStream.getVideoTracks()[0])===null||v===void 0||(v=v.getSettings())===null||v===void 0?void 0:v.deviceId)!==r.videoInput&&(d=!1)}else d=!1;if(d){var T;if(c=r.localUserMediaStream.clone(),D.log("MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=".concat((T=r.localUserMediaStream)===null||T===void 0?void 0:T.id," newStreamId=").concat(c.id," shouldRequestAudio=").concat(a," shouldRequestVideo=").concat(o,")")),!a)for(var S of c.getAudioTracks())c.removeTrack(S);if(!o)for(var O of c.getVideoTracks())c.removeTrack(O)}else{var m;try{m=r.getUserMediaContraints(a,o,!0),c=yield navigator.mediaDevices.getUserMedia(m)}catch(R){D.warn("MediaHandler getUserMediaStreamInternal() error (e=".concat(R,"), retrying without exact deviceId")),m=r.getUserMediaContraints(a,o,!1),c=yield navigator.mediaDevices.getUserMedia(m)}D.log("MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=".concat(c.id,", shouldRequestAudio=").concat(a,", shouldRequestVideo=").concat(o,", constraints=").concat(JSON.stringify(m),")"));for(var y of c.getTracks()){var E=y.getSettings();y.kind==="audio"?r.audioInput=E.deviceId:y.kind==="video"&&(r.videoInput=E.deviceId)}n&&(r.localUserMediaStream=c)}return n&&r.userMediaStreams.push(c),r.emit(Rs.LocalStreamsChanged),c})()}stopUserMediaStream(e){D.log("MediaHandler stopUserMediaStream() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var n=this.userMediaStreams.indexOf(e);if(n!==-1&&(D.debug("MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=".concat(e.id,")"),e.id),this.userMediaStreams.splice(n,1)),this.emit(Rs.LocalStreamsChanged),this.localUserMediaStream===e)this.localUserMediaStream=void 0;else for(var r of e.getTracks()){var a;if((a=this.localUserMediaStream)!==null&&a!==void 0&&a.getTrackById(r.id)){this.stopUserMediaStream(this.localUserMediaStream);break}}}getScreensharingStream(){var e=arguments,t=this;return A(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:{},r=e.length>1&&e[1]!==void 0?e[1]:!0,a;if(t.screensharingStreams.length===0){var o=t.getScreenshareContraints(n);n.desktopCapturerSourceId?(D.debug("MediaHandler getScreensharingStream() calling getUserMedia() (opts=".concat(JSON.stringify(n),")")),a=yield navigator.mediaDevices.getUserMedia(o)):(D.debug("MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=".concat(JSON.stringify(n),")")),a=yield navigator.mediaDevices.getDisplayMedia(o))}else{var c=t.screensharingStreams[t.screensharingStreams.length-1];D.log("MediaHandler getScreensharingStream() cloning (streamId=".concat(c.id,")")),a=c.clone()}return r&&t.screensharingStreams.push(a),t.emit(Rs.LocalStreamsChanged),a})()}stopScreensharingStream(e){D.debug("MediaHandler stopScreensharingStream() stopping stream (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var n=this.screensharingStreams.indexOf(e);n!==-1&&(D.debug("MediaHandler stopScreensharingStream() splicing stream out (streamId=".concat(e.id,")")),this.screensharingStreams.splice(n,1)),this.emit(Rs.LocalStreamsChanged)}stopAllStreams(){for(var e of this.userMediaStreams){D.log("MediaHandler stopAllStreams() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop()}for(var n of this.screensharingStreams)for(var r of n.getTracks())r.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(Rs.LocalStreamsChanged)}getUserMediaContraints(e,t,n){var r=!!navigator.webkitGetUserMedia,a=n?"exact":"ideal",o={};this.audioInput&&(o.deviceId={[a]:this.audioInput}),this.audioSettings&&(o.autoGainControl={ideal:this.audioSettings.autoGainControl},o.echoCancellation={ideal:this.audioSettings.echoCancellation},o.noiseSuppression={ideal:this.audioSettings.noiseSuppression});var c={width:r?{exact:640}:{ideal:640},height:r?{exact:360}:{ideal:360}};return this.videoInput&&(c.deviceId={[a]:this.videoInput}),{audio:e?o:!1,video:t?c:!1}}getScreenshareContraints(e){var{desktopCapturerSourceId:t,audio:n}=e;return t?{audio:n??!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:n??!1,video:!0}}}var gC=(function(i){return i.RequestFinished="FINISHED",i.Complete="COMPLETE",i})({}),Mu=(function(i){return i.PreProcess="ExtState.PreProcess",i.PostProcess="ExtState.PostProcess",i})({}),qg=(function(i){return i.RoomData="SlidingSync.RoomData",i.Lifecycle="SlidingSync.Lifecycle",i})({}),YN=3;class $N{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return Mu.PreProcess}onRequest(e){var t=this;return A(function*(){return e&&(D.log("ExtensionE2EE: invalidating all device lists due to missing 'pos'"),yield t.crypto.markAllTrackedUsersAsDirty()),{enabled:!0}})()}onResponse(e){var t=this;return A(function*(){e.device_lists&&(yield t.crypto.processDeviceLists(e.device_lists)),yield t.crypto.processKeyCounts(e.device_one_time_keys_count,e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]),t.crypto.onSyncCompleted({})})()}}class XN{constructor(e,t){this.client=e,this.cryptoCallbacks=t,b(this,"nextBatch",null)}name(){return"to_device"}when(){return Mu.PreProcess}onRequest(e){var t=this;return A(function*(){return{since:t.nextBatch!==null?t.nextBatch:void 0,limit:100,enabled:!0}})()}onResponse(e){var t=this;return A(function*(){var n=e.events||[],r;t.cryptoCallbacks?r=yield t.cryptoCallbacks.preprocessToDeviceMessages(n):r=n.map(a=>({message:a,encryptionInfo:null})),Rw(r,t.client),t.nextBatch=e.next_batch})()}}class QN{constructor(e){this.client=e}name(){return"account_data"}when(){return Mu.PostProcess}onRequest(e){return A(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return A(function*(){e.global&&e.global.length>0&&t.processGlobalAccountData(e.global);for(var n in e.rooms){var r=Xo(t.client,n,e.rooms[n]),a=t.client.getRoom(n);if(!a){D.warn("got account data for room but room doesn't exist on client:",n);continue}a.addAccountData(r),r.forEach(o=>{t.client.emit(ye.Event,o)})}})()}processGlobalAccountData(e){var t=Xo(this.client,void 0,e),n=t.reduce((r,a)=>(r[a.getType()]=this.client.store.getAccountData(a.getType()),r),{});this.client.store.storeAccountDataEvents(t),t.forEach(r=>{if(r.getType()===G.PushRules){var a=r.getContent();this.client.setPushRules(a)}var o=n[r.getType()];return this.client.emit(ye.AccountData,r,o),r})}}class ZN{constructor(e){this.client=e}name(){return"typing"}when(){return Mu.PostProcess}onRequest(e){return A(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return A(function*(){if(e!=null&&e.rooms)for(var n in e.rooms)Aw(t.client,n,[e.rooms[n]])})()}}class ex{constructor(e){this.client=e}name(){return"receipts"}when(){return Mu.PostProcess}onRequest(e){return A(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return A(function*(){if(e!=null&&e.rooms)for(var n in e.rooms)Aw(t.client,n,[e.rooms[n]])})()}}class Pw{constructor(e,t,n,r){this.slidingSync=e,this.client=t,b(this,"opts",void 0),b(this,"syncOpts",void 0),b(this,"syncState",null),b(this,"syncStateData",void 0),b(this,"lastPos",null),b(this,"failCount",0),b(this,"notifEvents",[]),this.opts=Tw(n),this.syncOpts=_w(r),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[ge.Timeline,ge.TimelineReset]),this.slidingSync.on(qg.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(qg.RoomData,this.onRoomData.bind(this));var a=[new XN(this.client,this.syncOpts.cryptoCallbacks),new QN(this.client),new ZN(this.client),new ex(this.client)];this.syncOpts.cryptoCallbacks&&a.push(new $N(this.syncOpts.cryptoCallbacks)),a.forEach(o=>{this.slidingSync.registerExtension(o)})}onRoomData(e,t){var n=this;return A(function*(){var r=n.client.store.getRoom(e);if(!r){if(!t.initial){n.syncOpts.logger.debug("initial flag not set but no stored room exists for room ",e,t);return}r=Cw(n.client,e,n.opts)}yield n.processRoomData(n.client,r,t)})()}onLifecycle(e,t,n){switch(n&&this.syncOpts.logger.debug("onLifecycle",e,n),e){case gC.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(ct.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(ct.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case gC.RequestFinished:if(n){if(this.failCount+=1,this.updateSyncState(this.failCount>YN?ct.Error:ct.Reconnecting,{error:new Ct(n)}),this.shouldAbortSync(new Ct(n)))return}else this.failCount=0,this.syncOpts.logger.debug("SlidingSyncState.RequestFinished with ".concat(Object.keys(t?.rooms||[]).length," rooms"));break}}syncLeftRooms(){return A(function*(){return[]})()}peek(e){return A(function*(){return null})()}stopPeeking(){}setPresence(e){}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}createRoom(e){var{timelineSupport:t}=this.client,n=new Pf(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(n,[ge.Name,ge.Redaction,ge.RedactionCancelled,ge.Receipt,ge.Tags,ge.LocalEchoUpdated,ge.AccountData,ge.MyMembership,ge.Timeline,ge.TimelineReset]),this.registerStateListeners(n),n}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[Ke.Events,Ke.Members,Ke.NewMember,Ke.Update]),e.currentState.on(Ke.NewMember,(t,n,r)=>{var a;r.user=(a=this.client.getUser(r.userId))!==null&&a!==void 0?a:void 0,this.client.reEmitter.reEmit(r,[Hn.Name,Hn.Typing,Hn.PowerLevel,Hn.Membership])})}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(this.syncOpts.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(ct.Error,{error:e}),!0):!1}processRoomData(e,t,n){var r=this;return A(function*(){n=tx(e,t.roomId,n);var a=Xo(r.client,t.roomId,n.required_state),o=Xo(r.client,t.roomId,n.timeline,!1),c=[];if(n.limited||n.initial){var d=new Set;t.getLiveTimeline().getEvents().forEach(I=>{d.add(I.getId())});for(var h=[],v=[],m=!1,y=o.length-1;y>=0;y--){var E=o[y];if(d.has(E.getId())){m=!0;continue}m?h.push(E):v.unshift(E)}o=v,h.length>0&&t.addEventsToTimeline(h,!0,!1,t.getLiveTimeline(),n.prev_batch)}var T=t.hasEncryptionStateEvent();if(n.notification_count!=null&&t.setUnreadNotificationCount(it.Total,n.notification_count),n.highlight_count!=null&&(!T||T&&t.getUnreadNotificationCount(it.Highlight)<=0)&&t.setUnreadNotificationCount(it.Highlight,n.highlight_count),n.bump_stamp&&t.setBumpStamp(n.bump_stamp),Number.isInteger(n.invited_count)&&t.currentState.setInvitedMemberCount(n.invited_count),Number.isInteger(n.joined_count)&&t.currentState.setJoinedMemberCount(n.joined_count),n.invite_state){var S=Xo(r.client,t.roomId,n.invite_state);yield r.injectRoomEvents(t,S),n.initial&&(t.recalculate(),r.client.store.storeRoom(t),r.client.emit(ye.Room,t)),S.forEach(I=>{r.client.emit(ye.Event,I)});return}if(n.limited){var O;t.getLiveTimeline().setPaginationToken((O=n.prev_batch)!==null&&O!==void 0?O:null,me.BACKWARDS)}yield r.injectRoomEvents(t,a,o,n.num_live),t.addEphemeralEvents(c),t.updateMyMembership(Ne.Join),t.setMSC4186SummaryData(n.heroes,n.joined_count,n.invited_count),t.recalculate(),n.initial&&(e.store.storeRoom(t),e.emit(ye.Room,t)),r.addNotifications(o);var R=(function(){var I=A(function*(M){e.emit(ye.Event,M),M.isState()&&M.getType()==G.RoomEncryption&&r.syncOpts.cryptoCallbacks&&(yield r.syncOpts.cryptoCallbacks.onCryptoEvent(t,M))});return function(C){return I.apply(this,arguments)}})();yield n_(a,R),yield n_(o,R),c.forEach(function(I){e.emit(ye.Event,I)}),t.decryptCriticalEvents()})()}injectRoomEvents(e,t){var n=arguments,r=this;return A(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:[],o=n.length>3&&n[3]!==void 0?n[3]:0,c=e.getLiveTimeline(),d=c.getEvents().length==0;if(d){for(var h of t)r.client.getPushActionsForEvent(h);c.initialiseState(t)}d||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));var v=[];o>0&&(v=a.slice(-1*o),a=a.slice(0,-1*v.length)),yield e.addLiveEvents(a,{fromCache:!0,addToState:!1}),v.length>0&&(yield e.addLiveEvents(v,{fromCache:!1,addToState:!1})),e.recalculate(),r.resolveInvites(e)})()}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(Ne.Invite).forEach(function(n){if(!n.requestedProfileInfo){n.requestedProfileInfo=!0;var r=t.getUser(n.userId),a;r?a=Promise.resolve({avatar_url:r.avatarUrl,displayname:r.displayName}):a=t.getProfileInfo(n.userId),a.then(function(o){var c=n.events.member;c.getContent().membership===Ne.Invite&&(c.getContent().avatar_url=o.avatar_url,c.getContent().displayname=o.displayname,n.setMembershipEvent(c,e.currentState))},function(o){})}})}}retryImmediately(){return!0}sync(){var e=this;return A(function*(){for(e.syncOpts.logger.debug("Sliding sync init loop");!e.client.isGuest();)try{e.syncOpts.logger.debug("Getting push rules...");var t=yield e.client.getPushRules();e.syncOpts.logger.debug("Got push rules"),e.client.pushRules=t;break}catch(n){if(e.syncOpts.logger.error("Getting push rules failed",n),e.shouldAbortSync(n))return}yield e.slidingSync.start()})()}stop(){this.syncOpts.logger.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){var n=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(ye.Sync,this.syncState,n,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(var t of e){var n=this.client.getPushActionsForEvent(t);n&&n.notify&&n.tweaks&&n.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),this.notifEvents.forEach(e=>{var t;(t=this.client.getNotifTimelineSet())===null||t===void 0||t.addLiveEvent(e,{addToState:!1})}),this.notifEvents=[]}}function tx(i,e,t){if(!t.name)return t;for(var n of t.required_state)if(n.type===G.RoomName&&n.state_key==="")return n.content={name:t.name},t;return t.required_state.push({event_id:"$fake-sliding-sync-name-event-"+e,state_key:"",type:G.RoomName,content:{name:t.name},sender:i.getUserId(),origin_server_ts:new Date().getTime()}),t}function Xo(i,e,t){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!0,r=i.getEventMapper({decrypt:n});return t.map(function(a){return a.room_id=e,r(a)})}function Aw(i,e,t){var n=Xo(i,e,t),r=i.getRoom(e);if(!r){D.warn("got ephemeral events for room but room doesn't exist on client:",e);return}r.addEphemeralEvents(n),n.forEach(a=>{i.emit(ye.Event,a)})}var sb=new Ht("m.beacon_info","org.matrix.msc3672.beacon_info"),Vg=new Ht("m.beacon","org.matrix.msc3672.beacon");class hl{static RETRY_BACKOFF_RATELIMIT(e,t,n){return pw(n,t,!1)}static QUEUE_MESSAGES(e){return e.getType()===G.RoomMessage||e.hasAssociation()?"message":null}constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:hl.RETRY_BACKOFF_RATELIMIT,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:hl.QUEUE_MESSAGES;this.retryAlgorithm=e,this.queueAlgorithm=t,b(this,"queues",{}),b(this,"activeQueues",[]),b(this,"procFn",null),b(this,"processQueue",n=>{var r=this.peekNextEvent(n);if(!r){this.disableQueue(n);return}this.queues[n].length,Promise.resolve().then(()=>this.procFn(r.event)).then(a=>{this.removeNextEvent(n),r.event.getId(),r.resolvers.resolve(a),this.processQueue(n)},a=>{r.attempts+=1;var o=this.retryAlgorithm(r.event,r.attempts,a);r.attempts,r.event.getId(),o===-1?(D.info("Queue '%s' giving up on event %s",n,r.event.getId()),this.clearQueue(n,a)):setTimeout(this.processQueue,o,n)})})}getQueueForEvent(e){var t=this.queueAlgorithm(e);return!t||!this.queues[t]?null:this.queues[t].map(function(n){return n.event})}removeEventFromQueue(e){var t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;var n=!1;return Kh(this.queues[t],r=>r.event.getId()===e.getId()?(n=!0,!0):!1),n}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){var t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);var n=Promise.withResolvers();return this.queues[t].push({event:e,resolvers:n,attempts:0}),e.getId(),this.startProcessingQueues(),n.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(e=>this.activeQueues.indexOf(e)===-1&&this.queues[e].length>0).forEach(e=>{this.activeQueues.push(e),this.processQueue(e)})}disableQueue(e){var t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),D.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){D.info("clearing queue '%s'",e);for(var n;n=this.removeNextEvent(e);)n.resolvers.reject(t);this.disableQueue(e)}peekNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t.shift()}}var yC=20;class nx{constructor(e,t){var n=this;this.client=e,this.logger=t,b(this,"sending",!1),b(this,"running",!0),b(this,"retryTimeout",null),b(this,"retryAttempts",0),b(this,"sendQueue",A(function*(){if(n.retryTimeout!==null&&clearTimeout(n.retryTimeout),n.retryTimeout=null,!(n.sending||!n.running)){n.logger.debug("Attempting to send queued to-device messages"),n.sending=!0;var r;try{for(;n.running&&(r=yield n.client.store.getOldestToDeviceBatch(),r!==null);)yield n.sendBatch(r),yield n.client.store.removeToDeviceBatch(r.id),n.retryAttempts=0;if(!n.running)return;n.logger.debug("All queued to-device messages sent")}catch(o){++n.retryAttempts;var a=hl.RETRY_BACKOFF_RATELIMIT(null,n.retryAttempts,o);if(a===-1){Math.floor(o.httpStatus/100)===4?(n.logger.error("Fatal error when sending to-device message - dropping to-device batch!",o),yield n.client.store.removeToDeviceBatch(r.id)):n.logger.info("Automatic retry limit reached for to-device messages.");return}n.logger.info("Failed to send batch of to-device messages. Will retry in ".concat(a,"ms"),o),n.retryTimeout=setTimeout(n.sendQueue,a)}finally{n.sending=!1}}})),b(this,"onResumedSync",(r,a)=>{r===ct.Syncing&&a!==ct.Syncing&&(this.logger.info("Resuming queue after resumed sync"),this.sendQueue())})}start(){this.running=!0,this.sendQueue(),this.client.on(ye.Sync,this.onResumedSync)}stop(){this.running=!1,this.retryTimeout!==null&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(ye.Sync,this.onResumedSync)}queueBatch(e){var t=this;return A(function*(){for(var n=[],r=0;r<e.batch.length;r+=yC){var a={eventType:e.eventType,batch:e.batch.slice(r,r+yC),txnId:t.client.makeTxnId()};n.push(a);var o=a.batch.map(c=>"".concat(c.userId,"/").concat(c.deviceId," (msgid ").concat(c.payload[Of],")"));t.logger.info("Enqueuing batch of to-device messages. type=".concat(e.eventType," txnid=").concat(a.txnId),o)}yield t.client.store.saveToDeviceBatches(n),t.sendQueue()})()}sendBatch(e){var t=this;return A(function*(){var n=new Yr(()=>new Map);for(var r of e.batch)n.getOrCreate(r.userId).set(r.deviceId,r.payload);t.logger.info("Sending batch of ".concat(e.batch.length," to-device messages with ID ").concat(e.id," and txnId ").concat(e.txnId)),yield t.client.sendToDevice(e.eventType,n,e.txnId)})()}}var Mp=new Wn.UnstableValue("m.policies","org.matrix.msc3847.policies"),uh=new Wn.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites"),bC=(function(i){return i.Ban="m.ban",i})({}),Qo=(function(i){return i.User="m.policy.user",i.Room="m.policy.room",i.Server="m.policy.server",i})({}),SC={[Qo.User]:G.PolicyRuleUser,[Qo.Room]:G.PolicyRuleRoom,[Qo.Server]:G.PolicyRuleServer};class ix{constructor(e){this.client=e}addRule(e,t,n){var r=this;return A(function*(){var a=yield r.getOrCreateTargetRoom(),o=yield r.client.sendStateEvent(a.roomId,SC[e],{entity:t,reason:n,recommendation:bC.Ban});return o.event_id})()}removeRule(e){var t=this;return A(function*(){yield t.client.redactEvent(e.getRoomId(),e.getId())})()}addSource(e){var t=this;return A(function*(){yield t.client.joinRoom(e);var n=(yield t.getOrCreateSourceRooms()).map(r=>r.roomId);return n.includes(e)?!1:(n.push(e),yield t.withIgnoreInvitesPolicies(r=>{r.sources=n}),!0)})()}getRuleForInvite(e){var t=this;return A(function*(){var{sender:n,roomId:r}=e,a=yield t.getOrCreateSourceRooms(),o=n.split(":")[1],c=r.split(":")[1];for(var d of a){var h=d.getUnfilteredTimelineSet().getLiveTimeline().getState(me.FORWARDS);for(var{scope:v,entities:m}of[{scope:Qo.Room,entities:[r]},{scope:Qo.User,entities:[n]},{scope:Qo.Server,entities:[o,c]}]){var y=h.getStateEvents(SC[v]);for(var E of y){var T=E.getContent();if(T?.recommendation==bC.Ban){var S=T?.entity;if(S){var O=void 0;try{O=new RegExp(kk(S))}catch{continue}for(var R of m)if(R&&O.test(R))return E}}}}}return null})()}getOrCreateTargetRoom(){var e=this;return A(function*(){var t=e.getIgnoreInvitesPolicies(),n=t.target;if(typeof n!="string"&&(n=null),n){var r=e.client.getRoom(n);if(r)return r;n=null}return n=(yield e.client.createRoom({name:"Individual Policy Room",preset:rb.PrivateChat})).room_id,yield e.withIgnoreInvitesPolicies(a=>{a.target=n}),e.client.getRoom(n)})()}getOrCreateSourceRooms(){var e=this;return A(function*(){var t=e.getIgnoreInvitesPolicies(),n=t.sources,r=!1;Array.isArray(n)||(r=!0,n=[]);var a=n.filter(c=>typeof c=="string").map(c=>e.client.getRoom(c)).filter(c=>!!c);if(a.length!=n.length&&(r=!0),a.length==0){var o=yield e.getOrCreateTargetRoom();r=!0,a=[o]}return r&&(yield e.withIgnoreInvitesPolicies(c=>{c.sources=n})),a})()}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}withIgnoreInvitesPolicies(e){var t=this;return A(function*(){var{policies:n,ignoreInvitesPolicies:r}=t.getPoliciesAndIgnoreInvitesPolicies();e(r),n[uh.name]=r,yield t.client.setAccountData(Mp.name,n)})()}getPoliciesAndIgnoreInvitesPolicies(){var e={};for(var t of[Mp.name,Mp.altName]){var n;if(t){var r=(n=this.client.getAccountData(t))===null||n===void 0?void 0:n.getContent();if(r){e=r;break}}}var a={},o=!1;for(var c of[uh.name,uh.altName])if(c){var d=e[c];if(d&&typeof d=="object"){a=d,o=!0;break}}return o||(e[uh.name]=a),{policies:e,ignoreInvitesPolicies:a}}}var Pp="matrix-js-sdk";function rx(i){if(i.length>=255)throw new TypeError("Alphabet too long");const e=new Uint8Array(256);for(let h=0;h<e.length;h++)e[h]=255;for(let h=0;h<i.length;h++){const v=i.charAt(h),m=v.charCodeAt(0);if(e[m]!==255)throw new TypeError(v+" is ambiguous");e[m]=h}const t=i.length,n=i.charAt(0),r=Math.log(t)/Math.log(256),a=Math.log(256)/Math.log(t);function o(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";let v=0,m=0,y=0;const E=h.length;for(;y!==E&&h[y]===0;)y++,v++;const T=(E-y)*a+1>>>0,S=new Uint8Array(T);for(;y!==E;){let I=h[y],M=0;for(let C=T-1;(I!==0||M<m)&&C!==-1;C--,M++)I+=256*S[C]>>>0,S[C]=I%t>>>0,I=I/t>>>0;if(I!==0)throw new Error("Non-zero carry");m=M,y++}let O=T-m;for(;O!==T&&S[O]===0;)O++;let R=n.repeat(v);for(;O<T;++O)R+=i.charAt(S[O]);return R}function c(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;let v=0,m=0,y=0;for(;h[v]===n;)m++,v++;const E=(h.length-v)*r+1>>>0,T=new Uint8Array(E);for(;v<h.length;){const I=h.charCodeAt(v);if(I>255)return;let M=e[I];if(M===255)return;let C=0;for(let k=E-1;(M!==0||C<y)&&k!==-1;k--,C++)M+=t*T[k]>>>0,T[k]=M%256>>>0,M=M/256>>>0;if(M!==0)throw new Error("Non-zero carry");y=C,v++}let S=E-y;for(;S!==E&&T[S]===0;)S++;const O=new Uint8Array(m+(E-S));let R=m;for(;S!==E;)O[R++]=T[S++];return O}function d(h){const v=c(h);if(v)return v;throw new Error("Non-base"+t+" character")}return{encode:o,decodeUnsafe:c,decode:d}}var ax="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";const Mq=rx(ax);var ln=(function(i){return i.UserTrustStatusChanged="userTrustStatusChanged",i.KeyBackupStatus="crypto.keyBackupStatus",i.KeyBackupFailed="crypto.keyBackupFailed",i.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",i.KeyBackupDecryptionKeyCached="crypto.keyBackupDecryptionKeyCached",i.VerificationRequestReceived="crypto.verificationRequestReceived",i.WillUpdateDevices="crypto.willUpdateDevices",i.DevicesUpdated="crypto.devicesUpdated",i.KeysChanged="crossSigning.keysChanged",i.LegacyCryptoStoreMigrationProgress="crypto.legacyCryptoStoreMigrationProgress",i.DehydratedDeviceCreated="dehydration.DehydratedDeviceCreated",i.DehydratedDeviceUploaded="dehydration.DehydratedDeviceUploaded",i.RehydrationStarted="dehydration.RehydrationStarted",i.RehydrationProgress="dehydration.RehydrationProgress",i.RehydrationCompleted="dehydration.RehydrationCompleted",i.RehydrationError="dehydration.RehydrationError",i.DehydrationKeyCached="dehydration.DehydrationKeyCached",i.DehydratedDeviceRotationError="dehydration.DehydratedDeviceRotationError",i})({}),sx=(function(i){return i.MEGOLM_UNKNOWN_INBOUND_SESSION_ID="MEGOLM_UNKNOWN_INBOUND_SESSION_ID",i.MEGOLM_KEY_WITHHELD="MEGOLM_KEY_WITHHELD",i.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE="MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE",i.OLM_UNKNOWN_MESSAGE_INDEX="OLM_UNKNOWN_MESSAGE_INDEX",i.HISTORICAL_MESSAGE_NO_KEY_BACKUP="HISTORICAL_MESSAGE_NO_KEY_BACKUP",i.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED="HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED",i.HISTORICAL_MESSAGE_WORKING_BACKUP="HISTORICAL_MESSAGE_WORKING_BACKUP",i.HISTORICAL_MESSAGE_USER_NOT_JOINED="HISTORICAL_MESSAGE_USER_NOT_JOINED",i.SENDER_IDENTITY_PREVIOUSLY_VERIFIED="SENDER_IDENTITY_PREVIOUSLY_VERIFIED",i.UNSIGNED_SENDER_DEVICE="UNSIGNED_SENDER_DEVICE",i.UNKNOWN_SENDER_DEVICE="UNKNOWN_SENDER_DEVICE",i.UNKNOWN_ERROR="UNKNOWN_ERROR",i})({}),ox=(function(i){return i[i.AllDevicesIsolationMode=0]="AllDevicesIsolationMode",i[i.OnlySignedDevicesIsolationMode=1]="OnlySignedDevicesIsolationMode",i})({});class Pq{constructor(e){this.errorOnVerifiedUserProblems=e,b(this,"kind",ox.AllDevicesIsolationMode)}}class Aq{constructor(e,t,n){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=n,b(this,"needsUserApproval",void 0),this.needsUserApproval=r}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class Dq{constructor(e){var t,n,r,a,o;b(this,"signedByOwner",void 0),b(this,"crossSigningVerified",void 0),b(this,"tofu",void 0),b(this,"localVerified",void 0),b(this,"trustCrossSignedDevices",void 0),this.signedByOwner=(t=e.signedByOwner)!==null&&t!==void 0?t:!1,this.crossSigningVerified=(n=e.crossSigningVerified)!==null&&n!==void 0?n:!1,this.tofu=(r=e.tofu)!==null&&r!==void 0?r:!1,this.localVerified=(a=e.localVerified)!==null&&a!==void 0?a:!1,this.trustCrossSignedDevices=(o=e.trustCrossSignedDevices)!==null&&o!==void 0?o:!1}isVerified(){return this.localVerified||this.trustCrossSignedDevices&&this.crossSigningVerified}}var Nq=(function(i){return i.Fetch="fetch",i.LoadKeys="load_keys",i})({}),xq=(function(i){return i.Master="master",i.SelfSigning="self_signing",i.UserSigning="user_signing",i})({}),Lq=(function(i){return i[i.NONE=0]="NONE",i[i.GREY=1]="GREY",i[i.RED=2]="RED",i})({}),Uq=(function(i){return i[i.UNKNOWN=0]="UNKNOWN",i[i.UNVERIFIED_IDENTITY=1]="UNVERIFIED_IDENTITY",i[i.UNSIGNED_DEVICE=2]="UNSIGNED_DEVICE",i[i.UNKNOWN_DEVICE=3]="UNKNOWN_DEVICE",i[i.AUTHENTICITY_NOT_GUARANTEED=4]="AUTHENTICITY_NOT_GUARANTEED",i[i.MISMATCHED_SENDER_KEY=5]="MISMATCHED_SENDER_KEY",i[i.SENT_IN_CLEAR=6]="SENT_IN_CLEAR",i[i.VERIFICATION_VIOLATION=7]="VERIFICATION_VIOLATION",i[i.MISMATCHED_SENDER=8]="MISMATCHED_SENDER",i})({}),lx=new Uint8Array(8);function Dw(i,e){return Kg.apply(this,arguments)}function Kg(){return Kg=A(function*(i,e){var t=yield globalThis.crypto.subtle.importKey("raw",i,{name:"HKDF"},!1,["deriveBits"]),n=yield globalThis.crypto.subtle.deriveBits({name:"HKDF",salt:lx,info:new TextEncoder().encode(e),hash:"SHA-256"},t,512),r=n.slice(0,32),a=n.slice(32),o=globalThis.crypto.subtle.importKey("raw",r,{name:"AES-CTR"},!1,["encrypt","decrypt"]),c=globalThis.crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([o,c])}),Kg.apply(this,arguments)}function Nw(i,e,t,n){return Hg.apply(this,arguments)}function Hg(){return Hg=A(function*(i,e,t,n){var r;n?r=xs(n):(r=new Uint8Array(16),globalThis.crypto.getRandomValues(r),r[8]&=127);var[a,o]=yield Dw(e,t),c=new TextEncoder().encode(i),d=yield globalThis.crypto.subtle.encrypt({name:"AES-CTR",counter:r,length:64},a,c),h=yield globalThis.crypto.subtle.sign({name:"HMAC"},o,d);return{iv:Wc(r),ciphertext:Wc(new Uint8Array(d)),mac:Wc(new Uint8Array(h))}}),Hg.apply(this,arguments)}function cx(i,e,t){return Gg.apply(this,arguments)}function Gg(){return Gg=A(function*(i,e,t){var[n,r]=yield Dw(e,t),a=xs(i.ciphertext);if(!(yield globalThis.crypto.subtle.verify({name:"HMAC"},r,xs(i.mac),a)))throw new Error("Error decrypting secret ".concat(t,": bad MAC"));var o=yield globalThis.crypto.subtle.decrypt({name:"AES-CTR",counter:xs(i.iv),length:64},n,a);return new TextDecoder().decode(new Uint8Array(o))}),Gg.apply(this,arguments)}var ks="m.secret_storage.v1.aes-hmac-sha2";class xw{constructor(e,t){this.accountDataAdapter=e,this.callbacks=t}getDefaultKeyId(){var e=this;return A(function*(){var t,n=yield e.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return n&&(t=n.key)!==null&&t!==void 0?t:null})()}setDefaultKeyId(e){return new Promise((t,n)=>{var r=o=>{if(o.getType()==="m.secret_storage.default_key"){var c=o.getContent(),d=e===null?Object.keys(c).length===0:c.key===e;d&&(this.accountDataAdapter.removeListener(ye.AccountData,r),t())}};this.accountDataAdapter.on(ye.AccountData,r);var a=e===null?{}:{key:e};this.accountDataAdapter.setAccountData("m.secret_storage.default_key",a).catch(o=>{this.accountDataAdapter.removeListener(ye.AccountData,r),n(o)})})}addKey(e,t,n){var r=this;return A(function*(){if(e!==ks)throw new Error("Unknown key algorithm ".concat(e));var a={algorithm:e};t.name&&(a.name=t.name),t.passphrase&&(a.passphrase=t.passphrase);var{iv:o,mac:c}=yield Wg(t.key);if(a.iv=o,a.mac=c,!n)do n=Fa(32);while(yield r.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(n)));return yield r.accountDataAdapter.setAccountData("m.secret_storage.key.".concat(n),a),{keyId:n,keyInfo:a}})()}getKey(e){var t=this;return A(function*(){if(e||(e=yield t.getDefaultKeyId()),!e)return null;var n=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(e));return n?[e,n]:null})()}hasKey(e){var t=this;return A(function*(){var n=yield t.getKey(e);return!!n})()}checkKey(e,t){return A(function*(){if(t.algorithm===ks)if(t.mac){var{mac:n}=yield Wg(e,t.iv);return zg(t.mac)===zg(n)}else return!0;else throw new Error("Unknown algorithm")})()}store(e,t,n){var r=this;return A(function*(){if(t===null){yield r.accountDataAdapter.setAccountData(e,{});return}var a={};if(!n){var o=yield r.getDefaultKeyId();if(!o)throw new Error("No keys specified and no default key present");n=[o]}if(n.length===0)throw new Error("Zero keys given to encrypt with!");for(var c of n){var d=yield r.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(c));if(!d)throw new Error("Unknown key: "+c);if(d.algorithm===ks){var h={[c]:d},[,v]=yield r.getSecretStorageKey(h,e);a[c]=yield v.encrypt(t)}else D.warn("unknown algorithm for secret storage key "+c+": "+d.algorithm)}yield r.accountDataAdapter.setAccountData(e,{encrypted:a})})()}get(e){var t=this;return A(function*(){var n=yield t.accountDataAdapter.getAccountDataFromServer(e);if(n){if(!n.encrypted)throw new Error("Content is not encrypted!");var r={};for(var a of Object.keys(n.encrypted)){var o=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(a)),c=n.encrypted[a];o?.algorithm===ks&&c.iv&&c.ciphertext&&c.mac&&(r[a]=o)}if(Object.keys(r).length===0)throw new Error("Could not decrypt ".concat(e," because none of ")+"the keys it is encrypted with are for a supported algorithm");var[d,h]=yield t.getSecretStorageKey(r,e),v=n.encrypted[d];return h.decrypt(v)}})()}isStored(e){var t=this;return A(function*(){var n=yield t.accountDataAdapter.getAccountDataFromServer(e);if(!(n!=null&&n.encrypted))return null;var r={};for(var a of Object.keys(n.encrypted)){var o=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(a));if(o){var c=n.encrypted[a];o.algorithm===ks&&c.iv&&c.ciphertext&&c.mac&&(r[a]=o)}}return Object.keys(r).length?r:null})()}getSecretStorageKey(e,t){var n=this;return A(function*(){if(!n.callbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");var r=yield n.callbacks.getSecretStorageKey({keys:e},t);if(!r)throw new Error("getSecretStorageKey callback returned falsey");if(r.length<2)throw new Error("getSecretStorageKey callback returned invalid data");var[a,o]=r;if(!e[a])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[a].algorithm===ks){var c={encrypt:function(h){return Nw(h,o,t)},decrypt:function(h){return cx(h,o,t)}};return[a,c]}else throw new Error("Unknown key type: "+e[a].algorithm)})()}}function zg(i){for(var e=i.length;e>=1&&i.charCodeAt(e-1)==61;)e--;return e<i.length?i.substring(0,e):i}var ux="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function Wg(i,e){return Nw(ux,i,"",e)}const dx=Object.freeze(Object.defineProperty({__proto__:null,SECRET_STORAGE_ALGORITHM_V1_AES:ks,ServerSideSecretStorageImpl:xw,calculateKeyCheck:Wg,trimTrailingEquals:zg},Symbol.toStringTag,{value:"Module"}));function ob(i){return Jg.apply(this,arguments)}function Jg(){return Jg=A(function*(i){if(!globalThis.crypto.subtle)throw new Error("Crypto.subtle is not available: insecure context?");var e=new TextEncoder().encode(i),t=yield globalThis.crypto.subtle.digest("SHA-256",e);return new Uint8Array(t)}),Jg.apply(this,arguments)}var Lw=1e3*60*60*4,hx=(i,e,t)=>{var n,r=" - ";if(typeof i.slot_id!="string"?e.push(r+"slot_id must be string"):i.slot_id.split("#").length!==2&&e.push(r+'slot_id must include exactly one "#"'),typeof i.member!="object"||i.member===null?e.push(r+"member must be an object"):(typeof i.member.user_id!="string"?e.push(r+"member.user_id must be string"):jy.test(i.member.user_id)?i.member.user_id!==t&&e.push(r+"member.user_id must match the sender"):e.push(r+"member.user_id must be a valid mxid"),typeof i.member.device_id!="string"&&e.push(r+"member.device_id must be string"),typeof i.member.id!="string"&&e.push(r+"member.id must be string")),typeof i.application!="object"||i.application===null?e.push(r+"application must be an object"):typeof i.application.type!="string"?e.push(r+"application.type must be a string"):i.application.type.includes("#")&&e.push(r+'application.type must not include "#"'),i.rtc_transports===void 0||!Array.isArray(i.rtc_transports))e.push(r+"rtc_transports must be an array");else for(var a of i.rtc_transports)if(typeof a!="object"||a===null||typeof a.type!="string"){e.push(r+"rtc_transports entries must be objects with a string type");break}if(i.versions===void 0||!Array.isArray(i.versions)?e.push(r+"versions must be an array"):i.versions.every(c=>typeof c=="string")||e.push(r+"versions must be an array of strings"),((n=i.sticky_key)!==null&&n!==void 0?n:i.msc4354_sticky_key)===void 0&&e.push(r+"sticky_key or msc4354_sticky_key must be a defined"),i.sticky_key!==void 0&&typeof i.sticky_key!="string"&&e.push(r+"sticky_key must be a string"),i.msc4354_sticky_key!==void 0&&typeof i.msc4354_sticky_key!="string"&&e.push(r+"msc4354_sticky_key must be a string"),i.sticky_key!==void 0&&i.msc4354_sticky_key!==void 0&&i.sticky_key!==i.msc4354_sticky_key&&e.push(r+"sticky_key and msc4354_sticky_key must be equal if both are defined"),i["m.relates_to"]!==void 0){var o=i["m.relates_to"];typeof o!="object"||o===null?e.push(r+"m.relates_to must be an object if provided"):(typeof o.event_id!="string"&&e.push(r+"m.relates_to.event_id must be a string"),o.rel_type!=="m.reference"&&e.push(r+"m.relates_to.rel_type must be m.reference"))}return e.length===0},fx=(i,e)=>{var t,n=" - ";return typeof i.device_id!="string"&&e.push(n+"device_id must be string"),typeof i.call_id!="string"&&e.push(n+"call_id must be string"),typeof i.application!="string"&&e.push(n+"application must be a string"),typeof((t=i.focus_active)===null||t===void 0?void 0:t.type)!="string"&&e.push(n+"focus_active.type must be a string"),i.focus_active===void 0&&e.push(n+"focus_active has an invalid type"),i.foci_preferred!==void 0&&!(Array.isArray(i.foci_preferred)&&i.foci_preferred.every(r=>typeof r=="object"&&r!==null&&typeof r.type=="string"))&&e.push(n+"foci_preferred must be an array of transport objects"),i.created_ts!==void 0&&typeof i.created_ts!="number"&&e.push(n+"created_ts must be number"),i.scope!==void 0&&typeof i.scope!="string"&&e.push(n+"scope must be string"),i["m.call.intent"]!==void 0&&typeof i["m.call.intent"]!="string"&&e.push(n+"m.call.intent must be a string"),e.length===0};class qa{static equal(e,t){return cl(e?.membershipData,t?.membershipData)}constructor(e,t,n,r){this.membershipData=t,this.rtcBackendIdentity=n,b(this,"logger",void 0),b(this,"matrixEventData",void 0);var[a,o,c]=[e.getId(),e.getSender(),e.getTs()];if(a===void 0)throw new Error("parentEvent is missing eventId field");if(o===void 0)throw new Error("parentEvent is missing sender field");this.matrixEventData={eventId:a,sender:o,ts:c},this.logger=r?.getChild("[CallMembership ".concat(o,":").concat(this.deviceId,"]"))}static computeRtcBackendIdentity(e,t){return A(function*(){var{kind:n,data:r}=t;switch(n){case"rtc":return qa.computeRtcIdentityRaw(r.member.user_id,r.member.device_id,r.member.id);case"session":return"".concat(e.getSender(),":").concat(r.device_id)}})()}static computeRtcIdentityRaw(e,t,n){return A(function*(){return eb(yield ob("".concat(e,"|").concat(t,"|").concat(n)))})()}static membershipDataFromMatrixEvent(e){var[t,n,r]=[e.getId(),e.getSender(),e.getContent()];if(t===void 0)throw new Error("parentEvent is missing eventId field");if(n===void 0)throw new Error("parentEvent is missing sender field");var a=[],o=[];if(fx(r,a))return{kind:"session",data:r};if(hx(r,o,n))return{kind:"rtc",data:r};var c=a.length<o.length?`Does not match MSC4143 m.call.member:
`.concat(a.join(`
`),`

`):`Does not match MSC4143 m.rtc.member:
`.concat(o.join(`
`),`

`),d=`
event:
`+JSON.stringify(r).replaceAll('"',"'");throw Error(`unknown CallMembership data.
`+c+d)}get sender(){return this.userId}get userId(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.member.user_id:this.matrixEventData.sender}get eventId(){return this.matrixEventData.eventId}get slotId(){var e,{kind:t,data:n}=this.membershipData;if(n.application==="m.call")switch(t){case"rtc":return n.slot_id;default:{var[r,a]=[this.application,n.call_id],o;if(a===""){var c;o="ROOM",(c=this.logger)===null||c===void 0||c.info("use slotId compat hack emptyString -> ROOM")}else o=a;return uu({application:r,id:o})}}if((e=this.logger)===null||e===void 0||e.info("NOT using slotId compat hack emptyString -> ROOM"),t==="rtc")return n.slot_id;var[d,h]=[this.application,n.call_id];return uu({application:d,id:h})}get deviceId(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.member.device_id:t.device_id}get callIntent(){var{kind:e,data:t}=this.membershipData;switch(e){case"rtc":{var n,r=t.application["m.call.intent"];if(typeof r=="string")return r;(n=this.logger)===null||n===void 0||n.warn("RTC membership has invalid m.call.intent");return}default:return t["m.call.intent"]}}get slotDescription(){return Rx(this.slotId)}get application(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.application.type:t.application}get applicationData(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.application:{type:t.application,"m.call.intent":t["m.call.intent"]}}get scope(){var{kind:e,data:t}=this.membershipData;if(e!=="rtc")return t.scope}get membershipID(){return this.memberId}get memberId(){var e,{kind:t,data:n}=this.membershipData;return t==="rtc"?n.member.id:(e=n.membershipID)!==null&&e!==void 0?e:"".concat(this.matrixEventData.sender,":").concat(n.device_id)}createdTs(){var e,{kind:t,data:n}=this.membershipData;return t==="rtc"?this.matrixEventData.ts:(e=n.created_ts)!==null&&e!==void 0?e:this.matrixEventData.ts}getAbsoluteExpiry(){var e,{kind:t,data:n}=this.membershipData;if(t!=="rtc")return this.createdTs()+((e=n.expires)!==null&&e!==void 0?e:Lw)}getMsUntilExpiry(){var{kind:e}=this.membershipData;if(e!=="rtc")return this.getAbsoluteExpiry()-Date.now()}isExpired(){var{kind:e}=this.membershipData;return e==="rtc"?!1:this.getMsUntilExpiry()<=0}getTransport(e){var{kind:t,data:n}=this.membershipData;switch(t){case"rtc":return n.rtc_transports[0];case"session":switch(n.focus_active.focus_selection){case"multi_sfu":return n.foci_preferred[0];case"oldest_membership":if(qa.equal(this,e))return n.foci_preferred[0];if(e!==void 0)return e.getTransport(e);break}}}getFocusActive(){var{kind:e,data:t}=this.membershipData;if(e==="session")return t.focus_active}get transports(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.rtc_transports:t.foci_preferred}get kind(){return this.membershipData.kind}}var Ss=(function(i){return i.Disconnected="Disconnected",i.Connecting="Connecting",i.Connected="Connected",i.Disconnecting="Disconnecting",i.Unknown="Unknown",i})({}),Eh=(i,e,t)=>i.sender===e&&i.deviceId===t;class vx{constructor(e,t){this.membershipLoopHandler=e,b(this,"logger",void 0),b(this,"running",!1),b(this,"wakeup",n=>{this.logger.error("Cannot call wakeup before calling `startWithJoin()`")}),b(this,"_actions",[]),this.logger=(t??D).getChild("[NewMembershipActionScheduler]")}get actions(){return this._actions}startWithJoin(){var e=this;return A(function*(){if(e.running){e.logger.error("Cannot call startWithJoin() on NewMembershipActionScheduler while already running");return}e.running=!0,e._actions=[{ts:Date.now(),type:Oe.SendDelayedEvent}];try{for(var t=function*(){e._actions.sort((h,v)=>h.ts-v.ts);var r=e._actions[0],a=void 0,o=new Promise(h=>{e.wakeup=v=>{a=v,h()}});r.ts>Date.now()&&(yield Promise.race([o,Iu(r.ts-Date.now())]));var c={};if(!a){e.logger.debug("Current MembershipManager processing: ".concat(r.type,`
Queue:`),e._actions,`
Date.now: "`.concat(Date.now()));try{c=yield e.membershipLoopHandler(r.type)}catch(h){throw Error("The MembershipManager shut down because of the end condition: ".concat(h))}}e._actions.splice(0,1);var d=a??c;"replace"in d?e._actions=d.replace:"insert"in d&&e._actions.push(...d.insert)};e._actions.length>0;)yield*t()}finally{e.running=!1}e.logger.debug("Leave MembershipManager ActionScheduler loop (no more actions)")})()}initiateJoin(){var e;(e=this.wakeup)===null||e===void 0||e.call(this,{replace:[{ts:Date.now(),type:Oe.SendDelayedEvent}]})}initiateLeave(){var e;(e=this.wakeup)===null||e===void 0||e.call(this,{replace:[{ts:Date.now(),type:Oe.SendScheduledDelayedLeaveEvent}]})}}var lb=(function(i){return i.TooNew="TOO_NEW",i})({});class cb extends Error{constructor(e){var t="Crypto store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again";super(t),this.reason=e,this.name="InvalidCryptoStoreError"}}b(cb,"TOO_NEW",lb.TooNew);class mx extends Error{constructor(e,t){super(e),this.value=t}}class px extends Error{constructor(){super("MatrixClient has been stopped")}}class hi extends Error{constructor(e,t){super(e),this.clientEndpoint=t,this.name="UnsupportedDelayedEventsEndpointError"}}class Yg extends Error{constructor(e,t){super(e),this.clientEndpoint=t,this.name="UnsupportedStickyEventsEndpointError"}}var Ds=(function(i){return i.StatusChanged="StatusChanged",i.ProbablyLeft="ProbablyLeft",i.DelayIdChanged="DelayIdChanged",i})({}),gx=i=>i.type==="livekit"&&"livekit_service_url"in i;function EC(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function Go(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?EC(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):EC(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}var $g=3600*1e3,Oe=(function(i){return i.SendDelayedEvent="SendDelayedEvent",i.SendJoinEvent="SendJoinEvent",i.RestartDelayedEvent="RestartDelayedEvent",i.UpdateExpiry="UpdateExpiry",i.SendScheduledDelayedLeaveEvent="SendScheduledDelayedLeaveEvent",i.SendLeaveEvent="SendLeaveEvent",i})({});function Ri(i,e){return{insert:[{ts:Date.now()+(e??0),type:i}]}}function Ap(i,e){return{replace:[{ts:Date.now()+0,type:i}]}}class cu extends Ot{isActivated(){return this.activated}isJoined(){return this.isActivated()}join(e,t,n){if(this.scheduler.running){this.logger.error("MembershipManager is already running. Ignoring join request.");return}this.fociPreferred=e,this.rtcTransport=t,this.leavePromiseResolvers=void 0,this.activated=!0,this.oldStatus=this.status,this.state=cu.defaultState,this.scheduler.startWithJoin().catch(r=>{this.logger.error("MembershipManager stopped because: ",r),n?.(r)}).finally(()=>{if(this.activated=!1,this.oldStatus&&this.oldStatus!==this.status&&this.emit(Ds.StatusChanged,this.oldStatus,this.status),!this.scheduler.running){var r;(r=this.leavePromiseResolvers)===null||r===void 0||r.resolve(!0),this.leavePromiseResolvers=void 0}})}leave(e){return this.scheduler.running?(this.leavePromiseResolvers||(this.leavePromiseResolvers=Promise.withResolvers(),this.activated=!1,this.scheduler.initiateLeave(),e&&setTimeout(()=>{var t;return(t=this.leavePromiseResolvers)===null||t===void 0?void 0:t.resolve(!1)},e)),this.leavePromiseResolvers.promise):(this.logger.warn("Called MembershipManager.leave() even though the MembershipManager is not running"),Promise.resolve(!0))}onRTCSessionMemberUpdate(e){if(!this.isActivated())return Promise.resolve();if(this._ownMembership=e.find(n=>Eh(n,this.userId,this.deviceId)),!this._ownMembership){var t=[Oe.SendDelayedEvent,Oe.SendJoinEvent];this.logger.warn("Missing own membership: force re-join"),this.state.hasMemberStateEvent=!1,this.scheduler.actions.some(n=>t.includes(n.type))?this.logger.error("tried adding another `SendDelayedEvent` actions even though we already have one in the Queue\nActionQueueOnMemberUpdate:",this.scheduler.actions):this.scheduler.initiateJoin()}return Promise.resolve()}updateCallIntent(e){var t=this;return A(function*(){if(!t.activated||!t.ownMembership)throw Error("You cannot update your intent before joining the call");t.ownMembership.callIntent!==e&&(t.callIntent=e,yield t.sendJoinEvent())})()}constructor(e,t,n,r,a){super(),this.joinConfig=e,this.room=t,this.client=n,this.slotDescription=r,b(this,"activated",!1),b(this,"logger",void 0),b(this,"callIntent",void 0),b(this,"leavePromiseResolvers",void 0),b(this,"_ownMembership",void 0),b(this,"oldStatus",void 0),b(this,"scheduler",void 0),b(this,"state",void 0),b(this,"deviceId",void 0),b(this,"userId",void 0),b(this,"stateKey",void 0),b(this,"rtcTransport",void 0),b(this,"fociPreferred",void 0),b(this,"delayedLeaveEventDelayMsOverride",void 0),b(this,"clientSendDelayedDisconnectMembership",()=>this.client._unstable_sendDelayedStateEvent(this.room.roomId,{delay:this.delayedLeaveEventDelayMs},G.GroupCallMemberPrefix,{},this.stateKey)),b(this,"clientSendMembership",d=>this.client.sendStateEvent(this.room.roomId,G.GroupCallMemberPrefix,d,this.stateKey)),this.logger=(a??D).getChild("[MembershipManager]");var[o,c]=[this.client.getUserId(),this.client.getDeviceId()];if(o===null)throw Error("Missing userId in client");if(c===null)throw Error("Missing deviceId in client");this.deviceId=c,this.userId=o,this.stateKey=this.makeMembershipStateKey(o,c),this.state=cu.defaultState,this.callIntent=e?.callIntent,this.scheduler=new vx(d=>(this.oldStatus&&(this.logger.debug("MembershipManager applied action changes. Status: ".concat(this.oldStatus," -> ").concat(this.status)),this.oldStatus!==this.status&&this.emit(Ds.StatusChanged,this.oldStatus,this.status)),this.oldStatus=this.status,this.logger.debug("MembershipManager before processing action. status=".concat(this.oldStatus)),this.membershipLoopHandler(d)),this.logger)}get ownMembership(){return this._ownMembership}static get defaultState(){return{hasMemberStateEvent:!1,delayId:void 0,startTime:0,rateLimitRetries:new Map,networkErrorRetries:new Map,expireUpdateIterations:1,probablyLeft:!1}}get networkErrorRetryMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.networkErrorRetryMs)!==null&&e!==void 0?e:3e3}get membershipEventExpiryMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.membershipEventExpiryMs)!==null&&e!==void 0?e:Lw}get membershipEventExpiryHeadroomMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.membershipEventExpiryHeadroomMs)!==null&&e!==void 0?e:5e3}computeNextExpiryActionTs(e){return this.state.startTime+Math.min(this.membershipEventExpiryMs,$g)*e-this.membershipEventExpiryHeadroomMs}get delayedLeaveEventDelayMs(){var e,t,n;return(e=(t=this.delayedLeaveEventDelayMsOverride)!==null&&t!==void 0?t:(n=this.joinConfig)===null||n===void 0?void 0:n.delayedLeaveEventDelayMs)!==null&&e!==void 0?e:8e3}get delayedLeaveEventRestartMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.delayedLeaveEventRestartMs)!==null&&e!==void 0?e:5e3}get maximumRateLimitRetryCount(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.maximumRateLimitRetryCount)!==null&&e!==void 0?e:10}get maximumNetworkErrorRetryCount(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.maximumNetworkErrorRetryCount)!==null&&e!==void 0?e:10}get delayedLeaveEventRestartLocalTimeoutMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.delayedLeaveEventRestartLocalTimeoutMs)!==null&&e!==void 0?e:2e3}membershipLoopHandler(e){var t=this;return A(function*(){switch(e){case Oe.SendDelayedEvent:return t.state.delayId?t.cancelKnownDelayIdBeforeSendDelayedEvent(t.state.delayId):t.sendOrResendDelayedLeaveEvent();case Oe.RestartDelayedEvent:return t.state.delayId?t.restartDelayedEvent(t.state.delayId):Ri(Oe.SendDelayedEvent);case Oe.SendScheduledDelayedLeaveEvent:return t.state.hasMemberStateEvent?t.state.delayId?t.sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(t.state.delayId):Ri(Oe.SendLeaveEvent):{replace:[]};case Oe.SendJoinEvent:return t.sendJoinEvent();case Oe.UpdateExpiry:return t.updateExpiryOnJoinedEvent();case Oe.SendLeaveEvent:return t.state.hasMemberStateEvent?t.sendFallbackLeaveEvent():{replace:[]}}})()}sendOrResendDelayedLeaveEvent(){var e=this;return A(function*(){return yield e.clientSendDelayedDisconnectMembership().then(t=>(e.state.expectedServerDelayLeaveTs=Date.now()+e.delayedLeaveEventDelayMs,e.setAndEmitProbablyLeft(!1),e.resetRateLimitCounter(Oe.SendDelayedEvent),e.setAndEmitDelayId(t.delay_id),e.state.hasMemberStateEvent?Ri(Oe.RestartDelayedEvent,e.delayedLeaveEventRestartMs):Ri(Oe.SendJoinEvent))).catch(t=>{var n=Oe.SendDelayedEvent;if(e.manageMaxDelayExceededSituation(t))return Ri(n);var r=e.actionUpdateFromErrors(t,n,"_unstable_sendDelayedStateEvent");if(r)return r;if(e.state.hasMemberStateEvent){if(e.isUnsupportedDelayedEndpoint(t))return{};throw Error("Could not send delayed event, even though delayed events are supported. "+t)}else return e.isUnsupportedDelayedEndpoint(t)?e.logger.info("Not using delayed event because the endpoint is not supported"):e.logger.info("Not using delayed event because: "+t),Ri(Oe.SendJoinEvent)})})()}cancelKnownDelayIdBeforeSendDelayedEvent(e){var t=this;return A(function*(){return yield t.client._unstable_cancelScheduledDelayedEvent(e).then(()=>(t.setAndEmitDelayId(void 0),t.resetRateLimitCounter(Oe.SendDelayedEvent),Ap(Oe.SendDelayedEvent))).catch(n=>{var r=Oe.SendDelayedEvent,a=t.actionUpdateFromErrors(n,r,"cancelScheduledDelayedEvent");if(a)return a;if(t.isNotFoundError(n))return t.setAndEmitDelayId(void 0),Ap(r);if(t.isUnsupportedDelayedEndpoint(n))return Ap(Oe.SendJoinEvent);throw Error("We failed to cancel a delayed event where we already had a delay id with an error we cannot automatically handle")})})()}setAndEmitProbablyLeft(e){this.state.probablyLeft!==e&&(this.state.probablyLeft=e,this.emit(Ds.ProbablyLeft,this.state.probablyLeft))}setAndEmitDelayId(e){this.state.delayId!==e&&(this.state.delayId=e,this.emit(Ds.DelayIdChanged,this.state.delayId))}restartDelayedEvent(e){var t=this;return A(function*(){var n=t.state.expectedServerDelayLeaveTs?t.state.expectedServerDelayLeaveTs-Date.now():void 0,r=new Promise((a,o)=>{setTimeout(()=>{o(new _k("Restart delayed event timed out before the HS responded"))},n!==void 0&&!t.state.probablyLeft?Math.min(t.delayedLeaveEventRestartLocalTimeoutMs,n):t.delayedLeaveEventRestartLocalTimeoutMs)});return yield Promise.race([t.client._unstable_restartScheduledDelayedEvent(e),r]).then(()=>(t.state.expectedServerDelayLeaveTs=Date.now()+t.delayedLeaveEventDelayMs,t.resetRateLimitCounter(Oe.RestartDelayedEvent),t.setAndEmitProbablyLeft(!1),Ri(Oe.RestartDelayedEvent,t.delayedLeaveEventRestartMs))).catch(a=>{t.state.expectedServerDelayLeaveTs&&t.state.expectedServerDelayLeaveTs<=Date.now()&&t.setAndEmitProbablyLeft(!0);var o=Oe.RestartDelayedEvent;if(t.isNotFoundError(a))return t.setAndEmitDelayId(void 0),Ri(Oe.SendDelayedEvent);if(t.isUnsupportedDelayedEndpoint(a))return{};var c=t.actionUpdateFromErrors(a,o,"restartScheduledDelayedEvent");if(c)return c;throw Error("Could not restart delayed event, even though delayed events are supported. "+a)})})()}sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(e){var t=this;return A(function*(){return yield t.client._unstable_sendScheduledDelayedEvent(e).then(()=>(t.state.hasMemberStateEvent=!1,t.setAndEmitDelayId(void 0),t.resetRateLimitCounter(Oe.SendScheduledDelayedLeaveEvent),{replace:[]})).catch(n=>{var r=Oe.SendLeaveEvent;if(t.isUnsupportedDelayedEndpoint(n))return{};if(t.isNotFoundError(n))return t.setAndEmitDelayId(void 0),Ri(r);var a=t.actionUpdateFromErrors(n,r,"sendScheduledDelayedEvent");return a||(t.logger.warn("Encountered unexpected error during SendScheduledDelayedLeaveEvent. Falling back to SendLeaveEvent",n),Ri(r))})})()}sendJoinEvent(){var e=this;return A(function*(){return yield e.clientSendMembership(e.makeMyMembership(e.membershipEventExpiryMs)).then(()=>{e.setAndEmitProbablyLeft(!1),e.state.startTime=Date.now(),e.state.expireUpdateIterations=1,e.state.hasMemberStateEvent=!0,e.resetRateLimitCounter(Oe.SendJoinEvent);var t=e.scheduler.actions.filter(n=>n.type!==Oe.UpdateExpiry&&n.type!==Oe.SendJoinEvent);return{replace:[...t,{ts:Date.now(),type:Oe.RestartDelayedEvent},{ts:e.computeNextExpiryActionTs(e.state.expireUpdateIterations),type:Oe.UpdateExpiry}]}}).catch(t=>{var n=e.actionUpdateFromErrors(t,Oe.SendJoinEvent,"sendStateEvent");if(n)return n;throw t})})()}updateExpiryOnJoinedEvent(){var e=this;return A(function*(){var t=e.state.expireUpdateIterations+1;return yield e.clientSendMembership(e.makeMyMembership(e.membershipEventExpiryMs*t)).then(()=>(e.resetRateLimitCounter(Oe.UpdateExpiry),e.state.expireUpdateIterations=t,{insert:[{ts:e.computeNextExpiryActionTs(t),type:Oe.UpdateExpiry}]})).catch(n=>{var r=e.actionUpdateFromErrors(n,Oe.UpdateExpiry,"sendStateEvent");if(r)return r;throw n})})()}sendFallbackLeaveEvent(){var e=this;return A(function*(){return yield e.clientSendMembership({}).then(()=>(e.resetRateLimitCounter(Oe.SendLeaveEvent),e.state.hasMemberStateEvent=!1,{replace:[]})).catch(t=>{var n=e.actionUpdateFromErrors(t,Oe.SendLeaveEvent,"sendStateEvent");if(n)return n;throw t})})()}makeMembershipStateKey(e,t){var n=this.slotDescription.application,r=n==="m.call"&&this.slotDescription.id==="ROOM",a=r?"":this.slotDescription.id,o="".concat(e,"_").concat(t,"_").concat(n).concat(a);return/^org\.matrix\.msc(3757|3779)\b/.exec(this.room.getVersion())?o:"_".concat(o)}makeMyMembership(e){var t,n,r=this.ownMembership,a=this.slotDescription.application==="m.call"&&this.slotDescription.id==="ROOM",o=this.rtcTransport===void 0?{focus_active:{type:"livekit",focus_selection:"oldest_membership"},foci_preferred:(t=this.fociPreferred)!==null&&t!==void 0?t:[]}:{focus_active:{type:"livekit",focus_selection:"multi_sfu"},foci_preferred:[this.rtcTransport,...(n=this.fociPreferred)!==null&&n!==void 0?n:[]]};return Go(Go({application:this.slotDescription.application,call_id:a?"":this.slotDescription.id,scope:"m.room",device_id:this.deviceId,membershipID:"".concat(this.userId,":").concat(this.deviceId),expires:e,"m.call.intent":this.callIntent},o),r!==void 0?{created_ts:r.createdTs()}:void 0)}isNotFoundError(e){return e instanceof Ct&&e.errcode==="M_NOT_FOUND"}manageMaxDelayExceededSituation(e){if(e instanceof Ct&&e.errcode==="M_UNKNOWN"&&e.data["org.matrix.msc4140.errcode"]==="M_MAX_DELAY_EXCEEDED"){var t=e.data["org.matrix.msc4140.max_delay"];return typeof t=="number"&&this.delayedLeaveEventDelayMs>t&&(this.delayedLeaveEventDelayMsOverride=t),this.logger.warn("Retry sending delayed disconnection event due to server timeout limitations:",e),!0}return!1}actionUpdateFromErrors(e,t,n){var r=this.actionUpdateFromRateLimitError(e,n,t);if(r)return r;var a=this.actionUpdateFromNetworkErrorRetry(e,t);if(a)return a}actionUpdateFromRateLimitError(e,t,n){var r;if((e instanceof Fs||e instanceof Ct)&&e.isRateLimitError()){var a=(r=this.state.rateLimitRetries.get(n))!==null&&r!==void 0?r:0;if(a<this.maximumRateLimitRetryCount){var o,c=5e3;try{var d;o=(d=e.getRetryAfterMs())!==null&&d!==void 0?d:c,this.logger.info("Rate limited by server, retrying in ".concat(o,"ms"))}catch(h){this.logger.warn("Error while retrieving a rate-limit retry delay, retrying after default delay of ".concat(c),h),o=c}return this.state.rateLimitRetries.set(n,a+1),Ri(n,o)}throw Error("Exceeded maximum retries for "+n+" attempts (client."+t+")",{cause:e})}}actionUpdateFromNetworkErrorRetry(e,t){var n,r=(n=this.state.networkErrorRetries.get(t))!==null&&n!==void 0?n:0,a=this.networkErrorRetryMs/1e3+"s",o="("+r+"/"+this.maximumNetworkErrorRetryCount+")",c=this.networkErrorRetryMs;if(e instanceof Error&&e.name==="AbortError")c=0,this.logger.warn("Network local timeout error while sending event, immediate retry ("+o+")",e);else if(e instanceof Error&&e.message.includes("updating delayed event"))this.logger.warn("delayed event update timeout error, retrying in "+a+" "+o,e);else if(e instanceof Gs)this.logger.warn("Network connection error while sending event, retrying in "+a+" "+o,e);else if((e instanceof Fs||e instanceof Ct)&&typeof e.httpStatus=="number"&&e.httpStatus>=500&&e.httpStatus<600)this.logger.warn("Server error while sending event, retrying in "+a+" "+o,e);else return;if(r<this.maximumNetworkErrorRetryCount)return this.state.networkErrorRetries.set(t,r+1),Ri(t,c);throw Error("Reached maximum ("+this.maximumNetworkErrorRetryCount+") retries cause by: "+e)}isUnsupportedDelayedEndpoint(e){return e instanceof hi}resetRateLimitCounter(e){this.state.rateLimitRetries.set(e,0),this.state.networkErrorRetries.set(e,0)}get status(){var e=this.scheduler.actions;if(e.length===1){var{type:t}=e[0];switch(t){case Oe.SendDelayedEvent:case Oe.SendJoinEvent:return Ss.Connecting;case Oe.UpdateExpiry:return Ss.Connected;case Oe.SendScheduledDelayedLeaveEvent:case Oe.SendLeaveEvent:return Ss.Disconnecting}}else if(e.length===2){var n=e.map(a=>a.type);if((n.includes(Oe.RestartDelayedEvent)||n.includes(Oe.SendDelayedEvent)&&this.state.hasMemberStateEvent)&&n.includes(Oe.UpdateExpiry))return Ss.Connected}else if(e.length===3){var r=e.map(a=>a.type);if(r.filter(a=>a===Oe.RestartDelayedEvent).length===2&&r.includes(Oe.UpdateExpiry))return Ss.Connected}return this.scheduler.running?(this.logger.error("MembershipManager has an unknown state. Actions: ",e),Ss.Unknown):Ss.Disconnected}get probablyLeft(){return this.state.probablyLeft}get delayId(){return this.state.delayId}}class xf extends cu{constructor(e,t,n,r,a,o){super(e,t,n,r,o),this.clientWithSticky=n,this.memberId=a,b(this,"clientSendDelayedDisconnectMembership",()=>this.clientWithSticky._unstable_sendStickyDelayedEvent(this.room.roomId,$g,{delay:this.delayedLeaveEventDelayMs},null,G.RTCMembership,{msc4354_sticky_key:this.memberId})),b(this,"clientSendMembership",c=>this.clientWithSticky._unstable_sendStickyEvent(this.room.roomId,$g,null,G.RTCMembership,Go(Go({},c),{},{msc4354_sticky_key:this.memberId})))}actionUpdateFromErrors(e,t,n){var r;return super.actionUpdateFromErrors(e,t,(r=xf.nameMap.get(n))!==null&&r!==void 0?r:"unknown")}makeMyMembership(e){var t=this.ownMembership,n=gx(this.rtcTransport)?this.rtcTransport:void 0,r=t!=null&&t.eventId?{"m.relation":{rel_type:Et.Reference,event_id:t?.eventId}}:{};return Go({application:Go({type:this.slotDescription.application},this.callIntent?{"m.call.intent":this.callIntent}:{}),slot_id:uu(this.slotDescription),rtc_transports:n?[{type:n.type,livekit_service_url:n.livekit_service_url}]:[],member:{device_id:this.deviceId,user_id:this.userId,id:this.memberId},versions:[]},r)}}b(xf,"nameMap",new Map([["sendStateEvent","_unstable_sendStickyEvent"],["sendDelayedStateEvent","_unstable_sendStickyDelayedEvent"]]));var fl=(function(i){return i.ReceivedKeys="received_keys",i.NotSupportedError="not_supported_error",i})({});function Da(i){return"".concat(i.userId,":").concat(i.deviceId,"(").concat(i.memberId,")")}class yx{get updateEncryptionKeyThrottle(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.updateEncryptionKeyThrottle)!==null&&e!==void 0?e:3e3}get makeKeyDelay(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.makeKeyDelay)!==null&&e!==void 0?e:3e3}get useKeyDelay(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.useKeyDelay)!==null&&e!==void 0?e:5e3}constructor(e,t,n,r,a,o){var c=this;this.membership=e,this.getMemberships=t,this.transport=n,this.statistics=r,this.onEncryptionKeysChanged=a,b(this,"manageMediaKeys",!1),b(this,"keysEventUpdateTimeout",void 0),b(this,"makeNewKeyTimeout",void 0),b(this,"setNewKeyTimeouts",new Set),b(this,"encryptionKeys",new Map),b(this,"lastEncryptionKeyUpdateRequest",void 0),b(this,"lastMembershipFingerprints",void 0),b(this,"latestGeneratedKeyIndex",-1),b(this,"joinConfig",void 0),b(this,"logger",void 0),b(this,"joined",!1),b(this,"sendEncryptionKeysEvent",(function(){var d=A(function*(h){if(c.keysEventUpdateTimeout!==void 0&&(clearTimeout(c.keysEventUpdateTimeout),c.keysEventUpdateTimeout=void 0),c.lastEncryptionKeyUpdateRequest=Date.now(),!!c.joined){var v=c.getKeysForParticipant(c.membership);if(!v){c.logger.warn("Tried to send encryption keys event but no keys found!");return}if(typeof h!="number"&&c.latestGeneratedKeyIndex===-1){c.logger.warn("Tried to send encryption keys event but no current key index found!");return}var m=h??c.latestGeneratedKeyIndex;c.logger.info("Try sending encryption keys event. keyIndexToSend=".concat(m," (method parameter: ").concat(h,")"));var y=v[m];try{c.statistics.counters.roomEventEncryptionKeysSent+=1;var E=c.getMemberships().filter(S=>S.sender!=null).map(S=>({userId:S.sender,deviceId:S.deviceId,membershipTs:S.createdTs()}));yield c.transport.sendKey(eb(y),m,E),c.logger.debug("sendEncryptionKeysEvent participantId=".concat(c.membership.userId,":").concat(c.membership.deviceId," numKeys=").concat(v.length," currentKeyIndex=").concat(c.latestGeneratedKeyIndex," keyIndexToSend=").concat(m))}catch(S){if(c.keysEventUpdateTimeout===void 0){var T=Jy(S,5e3);c.logger.warn("Failed to send m.call.encryption_key, retrying in ".concat(T),S),c.keysEventUpdateTimeout=setTimeout(()=>{c.sendEncryptionKeysEvent()},T)}else c.logger.info("Not scheduling key resend as another re-send is already pending")}}});return function(h){return d.apply(this,arguments)}})()),b(this,"onNewKeyReceived",(d,h,v,m)=>{this.logger.debug("Received key over key transport ".concat(d.userId,":").concat(d.deviceId," at index ").concat(v)),this.setEncryptionKey(d,v,h,m)}),b(this,"onRotateKeyTimeout",()=>{if(this.manageMediaKeys){this.makeNewKeyTimeout=void 0,this.logger.info("Making new sender key for key rotation");var d=this.makeNewSenderKey(!0);this.sendEncryptionKeysEvent(d)}}),this.logger=(o??D).getChild("[EncryptionManager]")}rtcBackendIdentityFromMembershipParts(e){return"".concat(e.userId,":").concat(e.deviceId)}getEncryptionKeys(){var e=new Map;for(var[t,n]of this.encryptionKeys){var r=n.map((a,o)=>({key:a.key,membership:a.membership,keyIndex:o,rtcBackendIdentity:this.rtcBackendIdentityFromMembershipParts(a.membership)}));e.set(t,r)}return e}join(e){var t,n,r;this.joinConfig=e,this.joined=!0,this.manageMediaKeys=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.manageMediaKeys)!==null&&t!==void 0?t:this.manageMediaKeys,this.transport.on(fl.ReceivedKeys,this.onNewKeyReceived),this.transport.start(),(r=this.joinConfig)!==null&&r!==void 0&&r.manageMediaKeys&&(this.makeNewSenderKey(),this.requestSendCurrentKey())}leave(){this.encryptionKeys.set(Da(this.membership),[]),this.transport.off(fl.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),this.makeNewKeyTimeout!==void 0&&(clearTimeout(this.makeNewKeyTimeout),this.makeNewKeyTimeout=void 0);for(var e of this.setNewKeyTimeouts)clearTimeout(e);this.setNewKeyTimeouts.clear(),this.manageMediaKeys=!1,this.joined=!1}onMembershipsUpdate(e){if(this.manageMediaKeys&&this.joined){var t=new Set(e.filter(h=>!Eh(h,this.membership.userId,this.membership.deviceId)).map(Da)),n=new Set(this.getMemberships().filter(h=>!Eh(h,this.membership.userId,this.membership.deviceId)).map(Da)),r=Array.from(t).some(h=>!n.has(h)),a=Array.from(n).some(h=>!t.has(h)),o=this.lastMembershipFingerprints;if(this.storeLastMembershipFingerprints(),r)this.makeNewKeyTimeout||(this.logger.debug("Member(s) have left: queueing sender key rotation"),this.makeNewKeyTimeout=setTimeout(this.onRotateKeyTimeout,this.makeKeyDelay));else if(a)this.logger.debug("New member(s) have joined: re-sending keys"),this.requestSendCurrentKey();else if(o){var c=this.lastMembershipFingerprints,d=Array.from(o).some(h=>!c.has(h))||Array.from(c).some(h=>!o.has(h));d&&(this.logger.debug("Member(s) have updated/reconnected: re-sending keys to everyone"),this.requestSendCurrentKey())}}}makeNewSenderKey(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=lN(16),n=this.getNewEncryptionKeyIndex();return this.logger.info("Generated new key at index "+n),this.setEncryptionKey(this.membership,n,t,Date.now(),e),n}requestSendCurrentKey(){if(this.manageMediaKeys){if(this.lastEncryptionKeyUpdateRequest&&this.lastEncryptionKeyUpdateRequest+this.updateEncryptionKeyThrottle>Date.now()){this.logger.info("Last encryption key event sent too recently: postponing"),this.keysEventUpdateTimeout===void 0&&(this.keysEventUpdateTimeout=setTimeout(()=>{this.sendEncryptionKeysEvent()},this.updateEncryptionKeyThrottle));return}this.sendEncryptionKeysEvent()}}getKeysForParticipant(e){var t;return(t=this.encryptionKeys.get(Da(e)))===null||t===void 0?void 0:t.map(n=>n.key)}storeLastMembershipFingerprints(){this.lastMembershipFingerprints=new Set(this.getMemberships().filter(e=>!Eh(e,this.membership.userId,this.membership.deviceId)).map(e=>"".concat(Da(e),":").concat(e.createdTs())))}getNewEncryptionKeyIndex(){return this.latestGeneratedKeyIndex===-1?0:(this.latestGeneratedKeyIndex+1)%256}setEncryptionKey(e,t,n,r){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!1;this.logger.debug("Setting encryption key for ".concat(e.userId,":").concat(e.deviceId," at index ").concat(t));var o=xs(n),c=Da(e);this.encryptionKeys.has(c)||this.encryptionKeys.set(c,[]);var d=this.encryptionKeys.get(c),h=d[t];if(h){if(h.timestamp>r){this.logger.info("Ignoring new key at index ".concat(t," for ").concat(c," as it is older than existing known key"));return}if(bx(h.key,o)){h.timestamp=r;return}}if(e.userId===this.membership.userId&&e.deviceId===this.membership.deviceId&&(this.latestGeneratedKeyIndex=t),d[t]={key:o,timestamp:r,membership:e},a){var v=setTimeout(()=>{this.setNewKeyTimeouts.delete(v),this.logger.info("Delayed-emitting key changed event for ".concat(c," index ").concat(t)),this.onEncryptionKeysChanged(o,t,e,this.rtcBackendIdentityFromMembershipParts(e))},this.useKeyDelay);this.setNewKeyTimeouts.add(v)}else this.onEncryptionKeysChanged(o,t,e,this.rtcBackendIdentityFromMembershipParts(e))}}function bx(i,e){return i===e?!0:!!i&&!!e&&i.length===e.length&&i.every((t,n)=>t===e[n])}class Sx{constructor(){b(this,"tsBuffer",new Map)}isOutdated(e,t){var n,r=Da(e);this.tsBuffer.has(r)||this.tsBuffer.set(r,new Map);var a=(n=this.tsBuffer.get(r))===null||n===void 0?void 0:n.get(t.keyIndex);return a&&a>t.creationTS?!0:(this.tsBuffer.get(r).set(t.keyIndex,t.creationTS),!1)}}class Ex{constructor(e,t,n,r,a,o,c){this.ownMembership=e,this.getMemberships=t,this.transport=n,this.statistics=r,this.onEncryptionKeysChanged=a,b(this,"manageMediaKeys",!1),b(this,"useHashedRtcBackendIdentity",!1),b(this,"ownRtcBackendIdentityCache",void 0),b(this,"participantKeyRings",new Map),b(this,"outboundSession",null),b(this,"currentKeyDistributionPromise",null),b(this,"useKeyDelay",5e3),b(this,"keyRotationGracePeriodMs",1e4),b(this,"needToEnsureKeyAgain",!1),b(this,"keyBuffer",new Sx),b(this,"logger",void 0),b(this,"rtcIdentityProvider",void 0),b(this,"keysWithoutMatchingRTCMembership",[]),b(this,"onNewKeyReceived",(d,h,v,m)=>{var y;if(!this.manageMediaKeys){var E;(E=this.logger)===null||E===void 0||E.warn("Received key over transport ".concat(d.userId,":").concat(d.deviceId," at index ").concat(v," but media keys are disabled"));return}(y=this.logger)===null||y===void 0||y.debug("Received key over transport ".concat(d.userId,":").concat(d.deviceId," at index ").concat(v));var T=xs(h),S={key:T,membership:d,keyIndex:v,creationTS:m},O=this.keyBuffer.isOutdated(d,S);if(!O)this.addKeyToParticipant(S.key,S.keyIndex,S.membership),this.statistics.counters.roomEventEncryptionKeysReceived+=1;else{var R;(R=this.logger)===null||R===void 0||R.info("Received an out of order key for ".concat(d.userId,":").concat(d.deviceId,", dropping it"))}}),this.logger=o?.getChild("[EncryptionManager]"),this.rtcIdentityProvider=c??qa.computeRtcIdentityRaw}getOwnRtcBackendIdentity(){var e=this;return A(function*(){if(e.ownRtcBackendIdentityCache)return e.ownRtcBackendIdentityCache;if(e.useHashedRtcBackendIdentity){var t,{userId:n,deviceId:r,memberId:a}=e.ownMembership;(t=e.logger)===null||t===void 0||t.info("Computing RTC backend identity for ".concat(n,":").concat(r,":").concat(a," (SHOULD ONLY BE CALLED ONCE)")),e.ownRtcBackendIdentityCache=yield e.rtcIdentityProvider(n,r,a)}else e.ownRtcBackendIdentityCache="".concat(e.ownMembership.userId,":").concat(e.ownMembership.deviceId);return e.ownRtcBackendIdentityCache})()}getEncryptionKeys(){return new Map(this.participantKeyRings)}checkKeysWithoutMatchingRTCMembership(){var e=this.keysWithoutMatchingRTCMembership;this.keysWithoutMatchingRTCMembership=[],e.forEach(t=>{this.addKeyToParticipant(t.key,t.keyIndex,t.membership)})}addKeyToParticipant(e,t,n){var r=this.getMemberships(),a=r.find(c=>c.userId===n.userId&&c.deviceId===n.deviceId);if(!a){var o;(o=this.logger)===null||o===void 0||o.info("No matching RTC membership for key from ".concat(n.userId,":").concat(n.deviceId,", delaying key addition")),this.keysWithoutMatchingRTCMembership.push({key:e,keyIndex:t,membership:n});return}this.addKeyToParticipantWithBackendIdentity(e,t,n,a.rtcBackendIdentity)}addKeyToParticipantWithBackendIdentity(e,t,n,r){var a=Da(n);this.participantKeyRings.has(a)||this.participantKeyRings.set(a,[]),this.participantKeyRings.get(a).push({key:e,keyIndex:t,membership:n,rtcBackendIdentity:r}),this.onEncryptionKeysChanged(e,t,n,r)}join(e){var t,n,r,a,o;this.manageMediaKeys=(t=e?.manageMediaKeys)!==null&&t!==void 0?t:!0,this.useHashedRtcBackendIdentity=(n=e?.unstableSendStickyEvents)!==null&&n!==void 0?n:!1,this.useKeyDelay=(r=e?.useKeyDelay)!==null&&r!==void 0?r:1e3,this.keyRotationGracePeriodMs=(a=e?.keyRotationGracePeriodMs)!==null&&a!==void 0?a:1e4,this.transport.on(fl.ReceivedKeys,this.onNewKeyReceived),this.getOwnRtcBackendIdentity(),(o=this.logger)===null||o===void 0||o.info("Joining room"),this.transport.start()}leave(){this.transport.off(fl.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),this.participantKeyRings.clear()}ensureKeyDistribution(){if(this.manageMediaKeys)if(this.currentKeyDistributionPromise==null){var e;(e=this.logger)===null||e===void 0||e.debug("No active rollout, start a new one"),this.currentKeyDistributionPromise=this.rolloutOutboundKey().then(()=>{var n;if((n=this.logger)===null||n===void 0||n.debug("Rollout completed"),this.currentKeyDistributionPromise=null,this.needToEnsureKeyAgain){var r;(r=this.logger)===null||r===void 0||r.debug("New Rollout needed"),this.needToEnsureKeyAgain=!1,this.ensureKeyDistribution()}})}else{var t;(t=this.logger)===null||t===void 0||t.debug("Rollout in progress, a new rollout will be started after the current one"),this.needToEnsureKeyAgain=!0}}onMembershipsUpdate(){var e;(e=this.logger)===null||e===void 0||e.trace("onMembershipsUpdate"),this.ensureKeyDistribution(),this.checkKeysWithoutMatchingRTCMembership()}rolloutOutboundKey(){var e=this;return A(function*(){var t,n,r=e.outboundSession==null;if(r){var a={key:e.generateRandomKey(),creationTS:Date.now(),sharedWith:[],keyId:0};e.outboundSession=a,e.addKeyToParticipantWithBackendIdentity(a.key,a.keyId,e.ownMembership,yield e.getOwnRtcBackendIdentity())}var o=e.getMemberships().filter(x=>x.sender!=null).map(x=>({userId:x.sender,deviceId:x.deviceId,membershipTs:x.createdTs()})),c=(t=(n=e.outboundSession)===null||n===void 0?void 0:n.sharedWith)!==null&&t!==void 0?t:[];c=c.filter(x=>!o.some(U=>x.userId==U.userId&&x.deviceId==U.deviceId&&x.membershipTs!=U.membershipTs));var d=c.filter(x=>!o.some(U=>x.userId==U.userId&&x.deviceId==U.deviceId&&x.membershipTs==U.membershipTs)),h=o.filter(x=>!c.some(U=>x.userId==U.userId&&x.deviceId==U.deviceId&&x.membershipTs==U.membershipTs)),v=[],m,y=!1;if(d.length>0){var E=e.createNewOutboundSession();y=!0,v=o,m=E}else if(h.length>0){var T=Date.now(),S=T-e.outboundSession.creationTS;if(S<e.keyRotationGracePeriodMs){var O;(O=e.logger)===null||O===void 0||O.debug("New joiners detected, but the key is recent enough (age:".concat(S,"), keeping it")),v=h,m=e.outboundSession}else{var R;(R=e.logger)===null||R===void 0||R.debug("New joiners detected, rotating the key");var I=e.createNewOutboundSession();y=!0,v=o,m=I}}else return;try{var M,C;if((M=e.logger)===null||M===void 0||M.trace("Sending key..."),yield e.transport.sendKey(Wc(m.key),m.keyId,v),e.statistics.counters.roomEventEncryptionKeysSent+=1,m.sharedWith.push(...v),(C=e.logger)===null||C===void 0||C.trace("key index:".concat(m.keyId," sent to ").concat(m.sharedWith.map(x=>"".concat(x.userId,":").concat(x.deviceId)).join(","))),y){var k,_;(k=e.logger)===null||k===void 0||k.trace("Delay Rollout for key:".concat(m.keyId,"...")),yield Iu(e.useKeyDelay),(_=e.logger)===null||_===void 0||_.trace("...Delayed rollout of index:".concat(m.keyId," ")),e.addKeyToParticipantWithBackendIdentity(m.key,m.keyId,e.ownMembership,yield e.getOwnRtcBackendIdentity())}}catch(x){var P;(P=e.logger)===null||P===void 0||P.error("Failed to rollout key",x)}})()}createNewOutboundSession(){var e,t={key:this.generateRandomKey(),creationTS:Date.now(),sharedWith:[],keyId:this.nextKeyIndex()};return(e=this.logger)===null||e===void 0||e.info("creating new outbound key index:".concat(t.keyId)),this.outboundSession=t,t}nextKeyIndex(){return this.outboundSession?(this.outboundSession.keyId+1)%256:0}generateRandomKey(){var e=new Uint8Array(16);return globalThis.crypto.getRandomValues(e),e}}class Tx extends Error{constructor(e){super(e)}get name(){return"NotSupportedError"}}class _x extends Ot{setParentLogger(e){this.logger=e.getChild("[ToDeviceKeyTransport]")}constructor(e,t,n,r,a){super(),this.membership=e,this.roomId=t,this.client=n,this.statistics=r,b(this,"logger",D),b(this,"onToDeviceEvent",o=>{if(o.getType()===G.CallEncryptionKeysPrefix){var c=this.getValidEventContent(o);c&&o.getSender()&&this.receiveCallKeyEvent(o.getSender(),c)}}),this.setParentLogger(a??D)}start(){this.client.on(ye.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.off(ye.ToDeviceEvent,this.onToDeviceEvent)}sendKey(e,t,n){var r=this;return A(function*(){var a={keys:{index:t,key:e},room_id:r.roomId,member:{claimed_device_id:r.membership.deviceId,id:r.membership.memberId},session:{call_id:"",application:"m.call",scope:"m.room"},sent_ts:Date.now()},o=n.map(c=>({userId:c.userId,deviceId:c.deviceId})).filter(c=>!(c.userId==r.membership.userId&&c.deviceId==r.membership.deviceId));o.length>0?(yield r.client.encryptAndSendToDevice(G.CallEncryptionKeysPrefix,o,a).catch(c=>{var d=c.message;if(d.includes("unknown variant")&&d.includes("send_to_device")||d.includes("not supported"))throw new Tx("The widget driver does not support to-device encryption")}),r.statistics.counters.roomEventEncryptionKeysSent+=1):r.logger.warn("No targets found for sending key")})()}receiveCallKeyEvent(e,t){var n;this.statistics.counters.roomEventEncryptionKeysReceived+=1;var r=Date.now(),a=r-(typeof t.sent_ts=="number"?t.sent_ts:r);this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=a;var o="".concat(e,":").concat(t.member.claimed_device_id);this.emit(fl.ReceivedKeys,{userId:e,deviceId:t.member.claimed_device_id,memberId:(n=t.member.id)!==null&&n!==void 0?n:o},t.keys.key,t.keys.index,r)}getValidEventContent(e){var t=e.getContent(),n=t.room_id;if(!n){this.logger.warn("Malformed Event: invalid call encryption keys event, no roomId");return}if(n!==this.roomId){this.logger.warn("Malformed Event: Mismatch roomId");return}if(!t.keys||!t.keys.key||typeof t.keys.index!="number"){this.logger.warn("Malformed Event: Missing keys field");return}if(!t.member||!t.member.claimed_device_id){this.logger.warn("Malformed Event: Missing claimed_device_id");return}return t}}class Cx extends Ot{setParentLogger(e){this.logger=e.getChild("[RoomKeyTransport]")}constructor(e,t,n,r){super(),this.room=e,this.client=t,this.statistics=n,b(this,"logger",D),this.setParentLogger(r??D)}start(){this.room.on(ge.Timeline,e=>{this.consumeCallEncryptionEvent(e)})}stop(){this.room.off(ge.Timeline,e=>{this.consumeCallEncryptionEvent(e)})}consumeCallEncryptionEvent(e){var t=arguments,n=this;return A(function*(){var r=t.length>1&&t[1]!==void 0?t[1]:!1;if(yield n.client.decryptEventIfNeeded(e),e.isDecryptionFailure()){r?n.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason)):(n.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason," will retry once only")),setTimeout(()=>{n.consumeCallEncryptionEvent(e,!0)},1e3));return}else r&&n.logger.info("Decryption succeeded for event ".concat(e.getId()," after retry"));if(e.getType()!==G.CallEncryptionKeysPrefix)return Promise.resolve();if(!n.room)return n.logger.error("Got room state event for unknown room ".concat(e.getRoomId(),"!")),Promise.resolve();n.onEncryptionEvent(e)})()}sendKey(e,t,n){var r=this;return A(function*(){var a={keys:[{index:t,key:e}],device_id:r.client.getDeviceId(),call_id:"",sent_ts:Date.now()};try{yield r.client.sendEvent(r.room.roomId,G.CallEncryptionKeysPrefix,a)}catch(c){r.logger.error("Failed to send call encryption keys",c);var o=c;throw o.event&&r.client.cancelPendingEvent(o.event),c}})()}onEncryptionEvent(e){var t=e.getSender(),n=e.getContent(),r=n.device_id,a=n.call_id;if(!t){this.logger.warn("Received m.call.encryption_keys with no userId: callId=".concat(a));return}if(a!==""){this.logger.warn("Received m.call.encryption_keys with unsupported callId: userId=".concat(t,", deviceId=").concat(r,", callId=").concat(a));return}if(!Array.isArray(n.keys)){this.logger.warn("Received m.call.encryption_keys where keys wasn't an array: callId=".concat(a));return}if(t===this.client.getUserId()&&r===this.client.getDeviceId()){this.logger.info("Ignoring our own keys event");return}this.statistics.counters.roomEventEncryptionKeysReceived+=1;var o=Date.now()-(typeof n.sent_ts=="number"?n.sent_ts:e.getTs());this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=o;for(var c of n.keys){if(!c){this.logger.info("Ignoring false-y key in keys event");continue}var d=c.key,h=c.index;!d||h===void 0||h===null||a===void 0||a===null||typeof r!="string"||typeof a!="string"||typeof d!="string"||typeof h!="number"?this.logger.warn("Malformed call encryption_key: userId=".concat(t,", deviceId=").concat(r,", encryptionKeyIndex=").concat(h," callId=").concat(a)):(this.logger.debug("onCallEncryption userId=".concat(t,":").concat(r," encryptionKeyIndex=").concat(h," age=").concat(o,"ms")),this.emit(fl.ReceivedKeys,{userId:t,deviceId:r,memberId:"".concat(t,":").concat(r)},d,h,e.getTs()))}}}function TC(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function _C(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?TC(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):TC(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}var Dr=(function(i){return i.MembershipsChanged="memberships_changed",i.JoinStateChanged="join_state_changed",i.EncryptionKeyChanged="encryption_key_changed",i.MembershipManagerError="membership_manager_error",i.DidSendCallNotification="did_send_call_notification",i})({});function Rx(i){var[e,t]=i.split("#");return{application:e,id:t}}function uu(i){return"".concat(i.application,"#").concat(i.id)}var kx={listenForStickyEvents:!0,listenForMemberStateEvents:!0};class du extends Ot{get membershipStatus(){var e;return(e=this.membershipManager)===null||e===void 0?void 0:e.status}get probablyLeft(){var e;return(e=this.membershipManager)===null||e===void 0?void 0:e.probablyLeft}get delayId(){var e;return(e=this.membershipManager)===null||e===void 0?void 0:e.delayId}get callId(){var e;return(e=this.slotDescription)===null||e===void 0?void 0:e.id}get slotId(){return uu(this.slotDescription)}static sessionMembershipsForSlot(e,t){var n=arguments;return A(function*(){var r=n.length>2&&n[2]!==void 0?n[2]:kx,a=D.getChild("[MatrixRTCSession ".concat(e.roomId,"]")),o=Mx(e,r,a),c=yield wx(e,o,t,a);return c.sort((d,h)=>d.createdTs()-h.createdTs()),c.length>1&&a.debug("Call memberships in room ".concat(e.roomId,", in order: "),c.map(d=>[d.createdTs(),d.userId])),c})()}static sessionForSlot(e,t,n,r){return new du(e,t,n,r)}get room(){return this.roomSubset}constructor(e,t,n,r){var a;super(),a=this,this.client=e,this.roomSubset=t,this.slotDescription=n,this.calculateMembershipsOpts=r,b(this,"membershipManager",void 0),b(this,"encryptionManager",void 0),b(this,"joinConfig",void 0),b(this,"logger",void 0),b(this,"pendingNotificationToSend",void 0),b(this,"expiryTimeout",void 0),b(this,"memberships",[]),b(this,"statistics",{counters:{roomEventEncryptionKeysSent:0,roomEventEncryptionKeysReceived:0},totals:{roomEventEncryptionKeysReceivedTotalAge:0}}),b(this,"reEmitter",new Cl(this)),b(this,"onRoomMemberUpdate",()=>{this.ensureRecalculateSessionMembers()}),b(this,"onStickyEventUpdate",(o,c,d)=>{[...o,...d,...c.flatMap(h=>[h.current,h.previous])].some(h=>h.getType()===G.RTCMembership)&&this.ensureRecalculateSessionMembers()}),b(this,"_onRTCSessionMemberUpdate",A(function*(){yield a.recalculateSessionMembers()})),b(this,"recalculateSessionMembersDirty",!1),b(this,"recalculateSessionMembersPromise",void 0),b(this,"recalculateSessionMembers",A(function*(){var o,c=a.memberships;a.memberships=yield du.sessionMembershipsForSlot(a.room,uu(a.slotDescription),a.calculateMembershipsOpts);var d=c.length!=a.memberships.length||c.some((E,T)=>!qa.equal(E,a.memberships[T]));if(d){var h,v;a.logger.info("Memberships for call in room ".concat(a.roomSubset.roomId," have changed: emitting (").concat(a.memberships.length," members)")),ID(a.logger,"emit MatrixRTCSessionEvent.MembershipsChanged",()=>{a.emit(Dr.MembershipsChanged,c,a.memberships)}),(h=a.membershipManager)===null||h===void 0||h.onRTCSessionMemberUpdate(a.memberships);var m=(v=a.membershipManager)===null||v===void 0?void 0:v.ownMembership;if(a.pendingNotificationToSend&&m&&c.length===0){var y;m.eventId&&(y=a.joinConfig)!==null&&y!==void 0&&y.notificationType?a.sendCallNotify(m.eventId,a.joinConfig.notificationType,m.callIntent):a.logger.warn("Own membership eventId is undefined, cannot send call notification")}a.memberships.length>0&&(a.pendingNotificationToSend=void 0)}else a.logger.debug("No membership changes detected for room ".concat(a.roomSubset.roomId));(o=a.encryptionManager)===null||o===void 0||o.onMembershipsUpdate(c),a.setExpiryTimer()})),this.logger=D.getChild("[MatrixRTCSession ".concat(t.roomId,"]")),this.roomSubset.on(Ke.Members,this.onRoomMemberUpdate),this.roomSubset.on(Na.Update,this.onStickyEventUpdate),this.ensureRecalculateSessionMembers(),this.setExpiryTimer()}isJoined(){var e,t;return(e=(t=this.membershipManager)===null||t===void 0?void 0:t.isJoined())!==null&&e!==void 0?e:!1}stop(){var e=this;return A(function*(){var t;yield(t=e.membershipManager)===null||t===void 0?void 0:t.leave(1e3),e.expiryTimeout&&(clearTimeout(e.expiryTimeout),e.expiryTimeout=void 0),e.roomSubset.off(Ke.Members,e.onRoomMemberUpdate),e.roomSubset.off(Na.Update,e.onStickyEventUpdate)})()}joinRTCSession(e,t,n,r){var a;if(this.isJoined()){this.logger.info("Already joined to session in room ".concat(this.roomSubset.roomId,": ignoring join call"));return}else{this.membershipManager=r!=null&&r.unstableSendStickyEvents?new xf(r,this.roomSubset,this.client,this.slotDescription,e.memberId,this.logger):new cu(r,this.roomSubset,this.client,this.slotDescription,this.logger),this.reEmitter.reEmit(this.membershipManager,[Ds.ProbablyLeft,Ds.StatusChanged,Ds.DelayIdChanged]);var o;if(r!=null&&r.useExperimentalToDeviceTransport){this.logger.info("Using experimental to-device transport for encryption keys"),this.logger.info("Using to-device with room fallback transport for encryption keys");var[c,d,h]=[this.roomSubset,this.client,this.statistics],v=new _x(e,c.roomId,d,h);this.encryptionManager=new Ex(e,()=>this.memberships,v,this.statistics,(m,y,E,T)=>{this.emit(Dr.EncryptionKeyChanged,m,y,E,T)},this.logger)}else o=new Cx(this.roomSubset,this.client,this.statistics),this.encryptionManager=new yx(e,()=>this.memberships,o,this.statistics,(m,y,E,T)=>{this.emit(Dr.EncryptionKeyChanged,m,y,E,T)})}this.joinConfig=r,this.pendingNotificationToSend=(a=this.joinConfig)===null||a===void 0?void 0:a.notificationType,this.membershipManager.join(t,n,m=>{this.logger.error("MembershipManager encountered an unrecoverable error: ",m),this.emit(Dr.MembershipManagerError,m),this.emit(Dr.JoinStateChanged,this.isJoined())}),this.encryptionManager.join(r),this.emit(Dr.JoinStateChanged,!0)}joinRoomSession(e,t,n){var[r,a]=[this.client.getUserId(),this.client.getDeviceId()],o="".concat(r,":").concat(a);this.joinRTCSession({userId:r,deviceId:a,memberId:o},e,t,n)}leaveRoomSession(){var e=arguments,t=this;return A(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:void 0;if(!t.isJoined())return t.logger.info("Not joined to session in room ".concat(t.roomSubset.roomId,": ignoring leave call")),!1;t.logger.info("Leaving call session in room ".concat(t.roomSubset.roomId)),t.encryptionManager.leave();var r=t.membershipManager.leave(n);return t.emit(Dr.JoinStateChanged,!1),yield r})()}getFocusInUse(){var e=this.getOldestMembership();return e?.getTransport(e)}getActiveFocus(){var e;return(e=this.getOldestMembership())===null||e===void 0?void 0:e.getFocusActive()}getOldestMembership(){return this.memberships[0]}getConsensusCallIntent(){var e,t=(e=this.memberships.find(n=>!!n.callIntent))===null||e===void 0?void 0:e.callIntent;if(t&&this.memberships.every(n=>!n.callIntent||n.callIntent===t))return t}updateCallIntent(e){var t=this;return A(function*(){var n,r,a=(n=t.membershipManager)===null||n===void 0?void 0:n.ownMembership;if(!a)throw Error("Not connected yet");yield(r=t.membershipManager)===null||r===void 0?void 0:r.updateCallIntent(e)})()}reemitEncryptionKeys(){var e;(e=this.encryptionManager)===null||e===void 0||e.getEncryptionKeys().forEach((t,n)=>{t.forEach(r=>{this.emit(Dr.EncryptionKeyChanged,r.key,r.keyIndex,r.membership,r.rtcBackendIdentity)})})}setExpiryTimer(){this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0);var e;for(var t of this.memberships){var n=t.getMsUntilExpiry();n!==void 0&&(e===void 0||n<e)&&(e=n)}e!=null&&(this.expiryTimeout=setTimeout(this.ensureRecalculateSessionMembers.bind(this),e))}sendCallNotify(e,t,n){var r=this,a=(function(){var o=A(function*(){var c={"m.mentions":{user_ids:[],room:!0},notification_type:t,"m.relates_to":{event_id:e,rel_type:Et.Reference},sender_ts:Date.now(),lifetime:3e4};n&&(c["m.call.intent"]=n);var d=yield r.client.sendEvent(r.roomSubset.roomId,G.RTCNotification,c);return{response:d,content:c}});return function(){return o.apply(this,arguments)}})();a().then(o=>{var c=_C(_C({},o.response),o.content);this.emit(Dr.DidSendCallNotification,c)}).catch(o=>{var[c,d]=o;return this.logger.error("Failed to send call notification",c,d)})}ensureRecalculateSessionMembers(){this.recalculateSessionMembersPromise===void 0?this.recalculateSessionMembersPromise=this.recalculateSessionMembers().then(()=>{this.recalculateSessionMembersPromise=void 0,this.recalculateSessionMembersDirty&&(this.ensureRecalculateSessionMembers(),this.recalculateSessionMembersDirty=!1)}):this.recalculateSessionMembersDirty=!0}}function wx(i,e,t,n){return Xg.apply(this,arguments)}function Xg(){return Xg=A(function*(i,e,t,n){var r=[];for(var a of e){var o=a.getContent();if(Ix(o,n))try{var c=qa.membershipDataFromMatrixEvent(a),d=new qa(a,c,yield qa.computeRtcBackendIdentity(a,c),n);Ox(d,i,t,n)&&r.push(d)}catch(h){n.warn("Couldn't construct call membership: ",h)}}return r}),Xg.apply(this,arguments)}function Ix(i,e){var t=Object.keys(i).filter(n=>n!=="msc4354_sticky_key").length;return t===0?!1:t>1&&"application"in i?!0:(t===1&&"memberships"in i&&e.warn("Legacy event found. Those are ignored, they do not contribute to the MatrixRTC session"),!1)}function Ox(i,e,t,n){var r;return i.slotId!==t?(n.info("Ignoring membership of user ".concat(i.userId," for a different slot:  user: ").concat(JSON.stringify(i.slotDescription),", slotId: ").concat(t,")")),!1):i.isExpired()?(n.info("Ignoring expired device membership ".concat(i.userId,"/").concat(i.deviceId)),!1):e.hasMembershipState((r=i.userId)!==null&&r!==void 0?r:"",Ne.Join)?!0:(n.info("Ignoring membership of user ".concat(i.userId," who is not in the room.")),!1)}function Mx(i,e,t){var{listenForStickyEvents:n,listenForMemberStateEvents:r}=e,a=[];if(n&&(a=[...i._unstable_getStickyEvents()].filter(d=>d.getType()===G.RTCMembership)),r){var o=i.getLiveTimeline().getState(me.FORWARDS);if(!o)return t.warn("Couldn't get state for room "+i.roomId+"using empty membership array"),[];var c=o.getStateEvents(G.GroupCallMemberPrefix);a=a.concat(c.filter(d=>!a.some(h=>h.getContent().msc4354_sticky_key===d.getStateKey())))}return a}var CC=(function(i){return i.SessionStarted="session_started",i.SessionEnded="session_ended",i})({});class Px extends Ot{constructor(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{application:"m.call",id:"ROOM"};super(),this.client=t,this.slotDescription=n,b(this,"roomSessions",new Map),b(this,"logger",void 0),b(this,"onRoom",r=>{this.refreshRoom(r)}),b(this,"onEvent",r=>{if(r.unstableStickyExpiresAt&&r.getType()===G.RTCMembership){var a=this.client.getRoom(r.getRoomId());a&&this.refreshRoom(a)}}),b(this,"onRoomState",r=>{if(r.getType()===G.GroupCallMemberPrefix){var a=this.client.getRoom(r.getRoomId());if(!a){this.logger.error("Got room state event for unknown room ".concat(r.getRoomId(),"!"));return}this.refreshRoom(a)}}),this.logger=e.getChild("[MatrixRTCSessionManager]")}start(){for(var e of(t=this.client.getRooms())!==null&&t!==void 0?t:[]){var t,n=du.sessionForSlot(this.client,e,this.slotDescription);n.memberships.length>0&&this.roomSessions.set(e.roomId,n)}this.client.on(ye.Room,this.onRoom),this.client.on(ye.Event,this.onEvent),this.client.on(Ke.Events,this.onRoomState)}stop(){for(var e of this.roomSessions.values())e.stop();this.roomSessions.clear(),this.client.off(ye.Room,this.onRoom),this.client.off(ye.Event,this.onEvent),this.client.off(Ke.Events,this.onRoomState)}getActiveRoomSession(e){return this.roomSessions.get(e.roomId)}getRoomSession(e){return this.roomSessions.has(e.roomId)||this.roomSessions.set(e.roomId,du.sessionForSlot(this.client,e,this.slotDescription)),this.roomSessions.get(e.roomId)}refreshRoom(e){var t=this;return A(function*(){var n=!t.roomSessions.has(e.roomId),r=t.getRoomSession(e),a=r.memberships.length>0&&!n;yield r._onRTCSessionMemberUpdate().catch(c=>{t.logger.error("Error updating RTC session members for ".concat(e.roomId,": ").concat(c))});var o=r.memberships.length>0;a&&!o?(t.logger.trace("Session ended for ".concat(e.roomId," (").concat(r.memberships.length," members)")),t.emit(CC.SessionEnded,e.roomId,t.roomSessions.get(e.roomId))):!a&&o&&(t.logger.trace("Session started for ".concat(e.roomId," (").concat(r.memberships.length," members)")),t.emit(CC.SessionStarted,e.roomId,t.roomSessions.get(e.roomId)))})()}}function Dp(i){return e=>{var t,n;return((t=e.content)===null||t===void 0||(t=t["m.relates_to"])===null||t===void 0?void 0:t.event_id)!==i||((n=e.content)===null||n===void 0||(n=n["m.relates_to"])===null||n===void 0?void 0:n.rel_type)===mt.name}}class Vc extends Error{}Vc.prototype.name="InvalidTokenError";function Ax(i){return decodeURIComponent(atob(i).replace(/(.)/g,(e,t)=>{let n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}function Dx(i){let e=i.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return Ax(e)}catch{return atob(e)}}function Uw(i,e){if(typeof i!="string")throw new Vc("Invalid token specified: must be a string");e||(e={});const t=e.header===!0?0:1,n=i.split(".")[t];if(typeof n!="string")throw new Vc(`Invalid token specified: missing part #${t+1}`);let r;try{r=Dx(n)}catch(a){throw new Vc(`Invalid token specified: invalid base64 for part #${t+1} (${a.message})`)}try{return JSON.parse(r)}catch(a){throw new Vc(`Invalid token specified: invalid json for part #${t+1} (${a.message})`)}}var Nx={debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}},sr,or,hu=(i=>(i[i.NONE=0]="NONE",i[i.ERROR=1]="ERROR",i[i.WARN=2]="WARN",i[i.INFO=3]="INFO",i[i.DEBUG=4]="DEBUG",i))(hu||{});(i=>{function e(){sr=3,or=Nx}i.reset=e;function t(r){if(!(0<=r&&r<=4))throw new Error("Invalid log level");sr=r}i.setLevel=t;function n(r){or=r}i.setLogger=n})(hu||(hu={}));var Kt=class nr{constructor(e){this._name=e}debug(...e){sr>=4&&or.debug(nr._format(this._name,this._method),...e)}info(...e){sr>=3&&or.info(nr._format(this._name,this._method),...e)}warn(...e){sr>=2&&or.warn(nr._format(this._name,this._method),...e)}error(...e){sr>=1&&or.error(nr._format(this._name,this._method),...e)}throw(e){throw this.error(e),e}create(e){const t=Object.create(this);return t._method=e,t.debug("begin"),t}static createStatic(e,t){const n=new nr(`${e}.${t}`);return n.debug("begin"),n}static _format(e,t){const n=`[${e}]`;return t?`${n} ${t}:`:n}static debug(e,...t){sr>=4&&or.debug(nr._format(e),...t)}static info(e,...t){sr>=3&&or.info(nr._format(e),...t)}static warn(e,...t){sr>=2&&or.warn(nr._format(e),...t)}static error(e,...t){sr>=1&&or.error(nr._format(e),...t)}};hu.reset();var ef=class{static decode(i){try{return Uw(i)}catch(e){throw Kt.error("JwtUtils.decode",e),e}}static async generateSignedJwt(i,e,t){const n=Gi.encodeBase64Url(new TextEncoder().encode(JSON.stringify(i))),r=Gi.encodeBase64Url(new TextEncoder().encode(JSON.stringify(e))),a=`${n}.${r}`,o=await window.crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},t,new TextEncoder().encode(a)),c=Gi.encodeBase64Url(new Uint8Array(o));return`${a}.${c}`}},xx="10000000-1000-4000-8000-100000000000",Qg=i=>btoa([...new Uint8Array(i)].map(e=>String.fromCharCode(e)).join("")),Bw=class ir{static _randomWord(){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}static generateUUIDv4(){return xx.replace(/[018]/g,t=>(+t^ir._randomWord()&15>>+t/4).toString(16)).replace(/-/g,"")}static generateCodeVerifier(){return ir.generateUUIDv4()+ir.generateUUIDv4()+ir.generateUUIDv4()}static async generateCodeChallenge(e){if(!crypto.subtle)throw new Error("Crypto.subtle is available only in secure contexts (HTTPS).");try{const n=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",n);return Qg(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(t){throw Kt.error("CryptoUtils.generateCodeChallenge",t),t}}static generateBasicAuth(e,t){const r=new TextEncoder().encode([e,t].join(":"));return Qg(r)}static async hash(e,t){const n=new TextEncoder().encode(t),r=await crypto.subtle.digest(e,n);return new Uint8Array(r)}static async customCalculateJwkThumbprint(e){let t;switch(e.kty){case"RSA":t={e:e.e,kty:e.kty,n:e.n};break;case"EC":t={crv:e.crv,kty:e.kty,x:e.x,y:e.y};break;case"OKP":t={crv:e.crv,kty:e.kty,x:e.x};break;case"oct":t={crv:e.k,kty:e.kty};break;default:throw new Error("Unknown jwk type")}const n=await ir.hash("SHA-256",JSON.stringify(t));return ir.encodeBase64Url(n)}static async generateDPoPProof({url:e,accessToken:t,httpMethod:n,keyPair:r,nonce:a}){let o,c;const d={jti:window.crypto.randomUUID(),htm:n??"GET",htu:e,iat:Math.floor(Date.now()/1e3)};t&&(o=await ir.hash("SHA-256",t),c=ir.encodeBase64Url(o),d.ath=c),a&&(d.nonce=a);try{const h=await crypto.subtle.exportKey("jwk",r.publicKey),v={alg:"ES256",typ:"dpop+jwt",jwk:{crv:h.crv,kty:h.kty,x:h.x,y:h.y}};return await ef.generateSignedJwt(v,d,r.privateKey)}catch(h){throw h instanceof TypeError?new Error(`Error exporting dpop public key: ${h.message}`):h}}static async generateDPoPJkt(e){try{const t=await crypto.subtle.exportKey("jwk",e.publicKey);return await ir.customCalculateJwkThumbprint(t)}catch(t){throw t instanceof TypeError?new Error(`Could not retrieve dpop keys from storage: ${t.message}`):t}}static async generateDPoPKeys(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!1,["sign","verify"])}};Bw.encodeBase64Url=i=>Qg(i).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");var Gi=Bw,Lx=class{constructor(e){this._name=e,this._callbacks=[],this._logger=new Kt(`Event('${this._name}')`)}addHandler(e){return this._callbacks.push(e),()=>this.removeHandler(e)}removeHandler(e){const t=this._callbacks.lastIndexOf(e);t>=0&&this._callbacks.splice(t,1)}async raise(...e){this._logger.debug("raise:",...e);for(const t of this._callbacks)await t(...e)}},tf=class Th extends Lx{constructor(){super(...arguments),this._logger=new Kt(`Timer('${this._name}')`),this._timerHandle=null,this._expiration=0,this._callback=()=>{const e=this._expiration-Th.getEpochTime();this._logger.debug("timer completes in",e),this._expiration<=Th.getEpochTime()&&(this.cancel(),super.raise())}}static getEpochTime(){return Math.floor(Date.now()/1e3)}init(e){const t=this._logger.create("init");e=Math.max(Math.floor(e),1);const n=Th.getEpochTime()+e;if(this.expiration===n&&this._timerHandle){t.debug("skipping since already initialized for expiration at",this.expiration);return}this.cancel(),t.debug("using duration",e),this._expiration=n;const r=Math.min(e,5);this._timerHandle=setInterval(this._callback,r*1e3)}get expiration(){return this._expiration}cancel(){this._logger.create("cancel"),this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}},RC=class{static readParams(i,e="query"){if(!i)throw new TypeError("Invalid URL");const n=new URL(i,"http://127.0.0.1")[e==="fragment"?"hash":"search"];return new URLSearchParams(n.slice(1))}},Zg=";",vl=class extends Error{constructor(i,e){var t,n,r;if(super(i.error_description||i.error||""),this.form=e,this.name="ErrorResponse",!i.error)throw Kt.error("ErrorResponse","No error passed"),new Error("No error passed");this.error=i.error,this.error_description=(t=i.error_description)!=null?t:null,this.error_uri=(n=i.error_uri)!=null?n:null,this.state=i.userState,this.session_state=(r=i.session_state)!=null?r:null,this.url_state=i.url_state}},Ux=class extends Error{constructor(i){super(i),this.name="ErrorTimeout"}},Bx=class{constructor(){this._logger=new Kt("InMemoryWebStorage"),this._data={}}clear(){this._logger.create("clear"),this._data={}}getItem(i){return this._logger.create(`getItem('${i}')`),this._data[i]}setItem(i,e){this._logger.create(`setItem('${i}')`),this._data[i]=e}removeItem(i){this._logger.create(`removeItem('${i}')`),delete this._data[i]}get length(){return Object.getOwnPropertyNames(this._data).length}key(i){return Object.getOwnPropertyNames(this._data)[i]}},ey=class extends Error{constructor(i,e){super(e),this.name="ErrorDPoPNonce",this.nonce=i}},ub=class{constructor(i=[],e=null,t={}){this._jwtHandler=e,this._extraHeaders=t,this._logger=new Kt("JsonService"),this._contentTypes=[],this._contentTypes.push(...i,"application/json"),e&&this._contentTypes.push("application/jwt")}async fetchWithTimeout(i,e={}){const{timeoutInSeconds:t,...n}=e;if(!t)return await fetch(i,n);const r=new AbortController,a=setTimeout(()=>r.abort(),t*1e3);try{return await fetch(i,{...e,signal:r.signal})}catch(o){throw o instanceof DOMException&&o.name==="AbortError"?new Ux("Network timed out"):o}finally{clearTimeout(a)}}async getJson(i,{token:e,credentials:t,timeoutInSeconds:n}={}){const r=this._logger.create("getJson"),a={Accept:this._contentTypes.join(", ")};e&&(r.debug("token passed, setting Authorization header"),a.Authorization="Bearer "+e),this.appendExtraHeaders(a);let o;try{r.debug("url:",i),o=await this.fetchWithTimeout(i,{method:"GET",headers:a,timeoutInSeconds:n,credentials:t})}catch(h){throw r.error("Network Error"),h}r.debug("HTTP response received, status",o.status);const c=o.headers.get("Content-Type");if(c&&!this._contentTypes.find(h=>c.startsWith(h))&&r.throw(new Error(`Invalid response Content-Type: ${c??"undefined"}, from URL: ${i}`)),o.ok&&this._jwtHandler&&c?.startsWith("application/jwt"))return await this._jwtHandler(await o.text());let d;try{d=await o.json()}catch(h){throw r.error("Error parsing JSON response",h),o.ok?h:new Error(`${o.statusText} (${o.status})`)}if(!o.ok)throw r.error("Error from server:",d),d.error?new vl(d):new Error(`${o.statusText} (${o.status}): ${JSON.stringify(d)}`);return d}async postForm(i,{body:e,basicAuth:t,timeoutInSeconds:n,initCredentials:r,extraHeaders:a}){const o=this._logger.create("postForm"),c={Accept:this._contentTypes.join(", "),"Content-Type":"application/x-www-form-urlencoded",...a};t!==void 0&&(c.Authorization="Basic "+t),this.appendExtraHeaders(c);let d;try{o.debug("url:",i),d=await this.fetchWithTimeout(i,{method:"POST",headers:c,body:e,timeoutInSeconds:n,credentials:r})}catch(y){throw o.error("Network error"),y}o.debug("HTTP response received, status",d.status);const h=d.headers.get("Content-Type");if(h&&!this._contentTypes.find(y=>h.startsWith(y)))throw new Error(`Invalid response Content-Type: ${h??"undefined"}, from URL: ${i}`);const v=await d.text();let m={};if(v)try{m=JSON.parse(v)}catch(y){throw o.error("Error parsing JSON response",y),d.ok?y:new Error(`${d.statusText} (${d.status})`)}if(!d.ok){if(o.error("Error from server:",m),d.headers.has("dpop-nonce")){const y=d.headers.get("dpop-nonce");throw new ey(y,`${JSON.stringify(m)}`)}throw m.error?new vl(m,e):new Error(`${d.statusText} (${d.status}): ${JSON.stringify(m)}`)}return m}appendExtraHeaders(i){const e=this._logger.create("appendExtraHeaders"),t=Object.keys(this._extraHeaders),n=["authorization","accept","content-type"];t.length!==0&&t.forEach(r=>{if(n.includes(r.toLocaleLowerCase())){e.warn("Protected header could not be overridden",r,n);return}const a=typeof this._extraHeaders[r]=="function"?this._extraHeaders[r]():this._extraHeaders[r];a&&a!==""&&(i[r]=a)})}},Fw=class{constructor(i){this._settings=i,this._logger=new Kt("MetadataService"),this._signingKeys=null,this._metadata=null,this._metadataUrl=this._settings.metadataUrl,this._jsonService=new ub(["application/jwk-set+json"],null,this._settings.extraHeaders),this._settings.signingKeys&&(this._logger.debug("using signingKeys from settings"),this._signingKeys=this._settings.signingKeys),this._settings.metadata&&(this._logger.debug("using metadata from settings"),this._metadata=this._settings.metadata),this._settings.fetchRequestCredentials&&(this._logger.debug("using fetchRequestCredentials from settings"),this._fetchRequestCredentials=this._settings.fetchRequestCredentials)}resetSigningKeys(){this._signingKeys=null}async getMetadata(){const i=this._logger.create("getMetadata");if(this._metadata)return i.debug("using cached values"),this._metadata;if(!this._metadataUrl)throw i.throw(new Error("No authority or metadataUrl configured on settings")),null;i.debug("getting metadata from",this._metadataUrl);const e=await this._jsonService.getJson(this._metadataUrl,{credentials:this._fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return i.debug("merging remote JSON with seed metadata"),this._metadata=Object.assign({},this._settings.metadataSeed,e),this._metadata}getIssuer(){return this._getMetadataProperty("issuer")}getAuthorizationEndpoint(){return this._getMetadataProperty("authorization_endpoint")}getUserInfoEndpoint(){return this._getMetadataProperty("userinfo_endpoint")}getTokenEndpoint(i=!0){return this._getMetadataProperty("token_endpoint",i)}getCheckSessionIframe(){return this._getMetadataProperty("check_session_iframe",!0)}getEndSessionEndpoint(){return this._getMetadataProperty("end_session_endpoint",!0)}getRevocationEndpoint(i=!0){return this._getMetadataProperty("revocation_endpoint",i)}getKeysEndpoint(i=!0){return this._getMetadataProperty("jwks_uri",i)}async _getMetadataProperty(i,e=!1){const t=this._logger.create(`_getMetadataProperty('${i}')`),n=await this.getMetadata();if(t.debug("resolved"),n[i]===void 0){if(e===!0){t.warn("Metadata does not contain optional property");return}t.throw(new Error("Metadata does not contain property "+i))}return n[i]}async getSigningKeys(){const i=this._logger.create("getSigningKeys");if(this._signingKeys)return i.debug("returning signingKeys from cache"),this._signingKeys;const e=await this.getKeysEndpoint(!1);i.debug("got jwks_uri",e);const t=await this._jsonService.getJson(e,{timeoutInSeconds:this._settings.requestTimeoutInSeconds});if(i.debug("got key set",t),!Array.isArray(t.keys))throw i.throw(new Error("Missing keys on keyset")),null;return this._signingKeys=t.keys,this._signingKeys}},Lf=class{constructor({prefix:i="oidc.",store:e=localStorage}={}){this._logger=new Kt("WebStorageStateStore"),this._store=e,this._prefix=i}async set(i,e){this._logger.create(`set('${i}')`),i=this._prefix+i,await this._store.setItem(i,e)}async get(i){return this._logger.create(`get('${i}')`),i=this._prefix+i,await this._store.getItem(i)}async remove(i){this._logger.create(`remove('${i}')`),i=this._prefix+i;const e=await this._store.getItem(i);return await this._store.removeItem(i),e}async getAllKeys(){this._logger.create("getAllKeys");const i=await this._store.length,e=[];for(let t=0;t<i;t++){const n=await this._store.key(t);n&&n.indexOf(this._prefix)===0&&e.push(n.substr(this._prefix.length))}return e}},Fx="code",jx="openid",qx="client_secret_post",Vx=900,ty=class{constructor({authority:i,metadataUrl:e,metadata:t,signingKeys:n,metadataSeed:r,client_id:a,client_secret:o,response_type:c=Fx,scope:d=jx,redirect_uri:h,post_logout_redirect_uri:v,client_authentication:m=qx,prompt:y,display:E,max_age:T,ui_locales:S,acr_values:O,resource:R,response_mode:I,filterProtocolClaims:M=!0,loadUserInfo:C=!1,requestTimeoutInSeconds:k,staleStateAgeInSeconds:_=Vx,mergeClaimsStrategy:P={array:"replace"},disablePKCE:x=!1,stateStore:U,revokeTokenAdditionalContentTypes:j,fetchRequestCredentials:K,refreshTokenAllowedScope:Z,extraQueryParams:be={},extraTokenParams:Pe={},extraHeaders:ce={},dpop:V,omitScopeWhenRequesting:Q=!1}){var le;if(this.authority=i,e?this.metadataUrl=e:(this.metadataUrl=i,i&&(this.metadataUrl.endsWith("/")||(this.metadataUrl+="/"),this.metadataUrl+=".well-known/openid-configuration")),this.metadata=t,this.metadataSeed=r,this.signingKeys=n,this.client_id=a,this.client_secret=o,this.response_type=c,this.scope=d,this.redirect_uri=h,this.post_logout_redirect_uri=v,this.client_authentication=m,this.prompt=y,this.display=E,this.max_age=T,this.ui_locales=S,this.acr_values=O,this.resource=R,this.response_mode=I,this.filterProtocolClaims=M??!0,this.loadUserInfo=!!C,this.staleStateAgeInSeconds=_,this.mergeClaimsStrategy=P,this.omitScopeWhenRequesting=Q,this.disablePKCE=!!x,this.revokeTokenAdditionalContentTypes=j,this.fetchRequestCredentials=K||"same-origin",this.requestTimeoutInSeconds=k,U)this.stateStore=U;else{const ve=typeof window<"u"?window.localStorage:new Bx;this.stateStore=new Lf({store:ve})}if(this.refreshTokenAllowedScope=Z,this.extraQueryParams=be,this.extraTokenParams=Pe,this.extraHeaders=ce,this.dpop=V,this.dpop&&!((le=this.dpop)!=null&&le.store))throw new Error("A DPoPStore is required when dpop is enabled")}},Kx=class{constructor(i,e){this._settings=i,this._metadataService=e,this._logger=new Kt("UserInfoService"),this._getClaimsFromJwt=async t=>{const n=this._logger.create("_getClaimsFromJwt");try{const r=ef.decode(t);return n.debug("JWT decoding successful"),r}catch(r){throw n.error("Error parsing JWT response"),r}},this._jsonService=new ub(void 0,this._getClaimsFromJwt,this._settings.extraHeaders)}async getClaims(i){const e=this._logger.create("getClaims");i||this._logger.throw(new Error("No token passed"));const t=await this._metadataService.getUserInfoEndpoint();e.debug("got userinfo url",t);const n=await this._jsonService.getJson(t,{token:i,credentials:this._settings.fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return e.debug("got claims",n),n}},jw=class{constructor(i,e){this._settings=i,this._metadataService=e,this._logger=new Kt("TokenClient"),this._jsonService=new ub(this._settings.revokeTokenAdditionalContentTypes,null,this._settings.extraHeaders)}async exchangeCode({grant_type:i="authorization_code",redirect_uri:e=this._settings.redirect_uri,client_id:t=this._settings.client_id,client_secret:n=this._settings.client_secret,extraHeaders:r,...a}){const o=this._logger.create("exchangeCode");t||o.throw(new Error("A client_id is required")),e||o.throw(new Error("A redirect_uri is required")),a.code||o.throw(new Error("A code is required"));const c=new URLSearchParams({grant_type:i,redirect_uri:e});for(const[m,y]of Object.entries(a))y!=null&&c.set(m,y);let d;switch(this._settings.client_authentication){case"client_secret_basic":if(!n)throw o.throw(new Error("A client_secret is required")),null;d=Gi.generateBasicAuth(t,n);break;case"client_secret_post":c.append("client_id",t),n&&c.append("client_secret",n);break}const h=await this._metadataService.getTokenEndpoint(!1);o.debug("got token endpoint");const v=await this._jsonService.postForm(h,{body:c,basicAuth:d,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:r});return o.debug("got response"),v}async exchangeCredentials({grant_type:i="password",client_id:e=this._settings.client_id,client_secret:t=this._settings.client_secret,scope:n=this._settings.scope,...r}){const a=this._logger.create("exchangeCredentials");e||a.throw(new Error("A client_id is required"));const o=new URLSearchParams({grant_type:i});this._settings.omitScopeWhenRequesting||o.set("scope",n);for(const[v,m]of Object.entries(r))m!=null&&o.set(v,m);let c;switch(this._settings.client_authentication){case"client_secret_basic":if(!t)throw a.throw(new Error("A client_secret is required")),null;c=Gi.generateBasicAuth(e,t);break;case"client_secret_post":o.append("client_id",e),t&&o.append("client_secret",t);break}const d=await this._metadataService.getTokenEndpoint(!1);a.debug("got token endpoint");const h=await this._jsonService.postForm(d,{body:o,basicAuth:c,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials});return a.debug("got response"),h}async exchangeRefreshToken({grant_type:i="refresh_token",client_id:e=this._settings.client_id,client_secret:t=this._settings.client_secret,timeoutInSeconds:n,extraHeaders:r,...a}){const o=this._logger.create("exchangeRefreshToken");e||o.throw(new Error("A client_id is required")),a.refresh_token||o.throw(new Error("A refresh_token is required"));const c=new URLSearchParams({grant_type:i});for(const[m,y]of Object.entries(a))Array.isArray(y)?y.forEach(E=>c.append(m,E)):y!=null&&c.set(m,y);let d;switch(this._settings.client_authentication){case"client_secret_basic":if(!t)throw o.throw(new Error("A client_secret is required")),null;d=Gi.generateBasicAuth(e,t);break;case"client_secret_post":c.append("client_id",e),t&&c.append("client_secret",t);break}const h=await this._metadataService.getTokenEndpoint(!1);o.debug("got token endpoint");const v=await this._jsonService.postForm(h,{body:c,basicAuth:d,timeoutInSeconds:n,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:r});return o.debug("got response"),v}async revoke(i){var e;const t=this._logger.create("revoke");i.token||t.throw(new Error("A token is required"));const n=await this._metadataService.getRevocationEndpoint(!1);t.debug(`got revocation endpoint, revoking ${(e=i.token_type_hint)!=null?e:"default token type"}`);const r=new URLSearchParams;for(const[a,o]of Object.entries(i))o!=null&&r.set(a,o);r.set("client_id",this._settings.client_id),this._settings.client_secret&&r.set("client_secret",this._settings.client_secret),await this._jsonService.postForm(n,{body:r,timeoutInSeconds:this._settings.requestTimeoutInSeconds}),t.debug("got response")}},Hx=class{constructor(i,e,t){this._settings=i,this._metadataService=e,this._claimsService=t,this._logger=new Kt("ResponseValidator"),this._userInfoService=new Kx(this._settings,this._metadataService),this._tokenClient=new jw(this._settings,this._metadataService)}async validateSigninResponse(i,e,t){const n=this._logger.create("validateSigninResponse");this._processSigninState(i,e),n.debug("state processed"),await this._processCode(i,e,t),n.debug("code processed"),i.isOpenId&&this._validateIdTokenAttributes(i),n.debug("tokens validated"),await this._processClaims(i,e?.skipUserInfo,i.isOpenId),n.debug("claims processed")}async validateCredentialsResponse(i,e){const t=this._logger.create("validateCredentialsResponse");i.isOpenId&&i.id_token&&this._validateIdTokenAttributes(i),t.debug("tokens validated"),await this._processClaims(i,e,i.isOpenId),t.debug("claims processed")}async validateRefreshResponse(i,e){var t,n;const r=this._logger.create("validateRefreshResponse");i.userState=e.data,(t=i.session_state)!=null||(i.session_state=e.session_state),(n=i.scope)!=null||(i.scope=e.scope),i.isOpenId&&i.id_token&&(this._validateIdTokenAttributes(i,e.id_token),r.debug("ID Token validated")),i.id_token||(i.id_token=e.id_token,i.profile=e.profile);const a=i.isOpenId&&!!i.id_token;await this._processClaims(i,!1,a),r.debug("claims processed")}validateSignoutResponse(i,e){const t=this._logger.create("validateSignoutResponse");if(e.id!==i.state&&t.throw(new Error("State does not match")),t.debug("state validated"),i.userState=e.data,i.error)throw t.warn("Response was error",i.error),new vl(i)}_processSigninState(i,e){var t;const n=this._logger.create("_processSigninState");if(e.id!==i.state&&n.throw(new Error("State does not match")),e.client_id||n.throw(new Error("No client_id on state")),e.authority||n.throw(new Error("No authority on state")),this._settings.authority!==e.authority&&n.throw(new Error("authority mismatch on settings vs. signin state")),this._settings.client_id&&this._settings.client_id!==e.client_id&&n.throw(new Error("client_id mismatch on settings vs. signin state")),n.debug("state validated"),i.userState=e.data,i.url_state=e.url_state,(t=i.scope)!=null||(i.scope=e.scope),i.error)throw n.warn("Response was error",i.error),new vl(i);e.code_verifier&&!i.code&&n.throw(new Error("Expected code in response"))}async _processClaims(i,e=!1,t=!0){const n=this._logger.create("_processClaims");if(i.profile=this._claimsService.filterProtocolClaims(i.profile),e||!this._settings.loadUserInfo||!i.access_token){n.debug("not loading user info");return}n.debug("loading user info");const r=await this._userInfoService.getClaims(i.access_token);n.debug("user info claims received from user info endpoint"),t&&r.sub!==i.profile.sub&&n.throw(new Error("subject from UserInfo response does not match subject in ID Token")),i.profile=this._claimsService.mergeClaims(i.profile,this._claimsService.filterProtocolClaims(r)),n.debug("user info claims received, updated profile:",i.profile)}async _processCode(i,e,t){const n=this._logger.create("_processCode");if(i.code){n.debug("Validating code");const r=await this._tokenClient.exchangeCode({client_id:e.client_id,client_secret:e.client_secret,code:i.code,redirect_uri:e.redirect_uri,code_verifier:e.code_verifier,extraHeaders:t,...e.extraTokenParams});Object.assign(i,r)}else n.debug("No code to process")}_validateIdTokenAttributes(i,e){var t;const n=this._logger.create("_validateIdTokenAttributes");n.debug("decoding ID Token JWT");const r=ef.decode((t=i.id_token)!=null?t:"");if(r.sub||n.throw(new Error("ID Token is missing a subject claim")),e){const a=ef.decode(e);r.sub!==a.sub&&n.throw(new Error("sub in id_token does not match current sub")),r.auth_time&&r.auth_time!==a.auth_time&&n.throw(new Error("auth_time in id_token does not match original auth_time")),r.azp&&r.azp!==a.azp&&n.throw(new Error("azp in id_token does not match original azp")),!r.azp&&a.azp&&n.throw(new Error("azp not in id_token, but present in original id_token"))}i.profile=r}},nf=class ny{constructor(e){this.id=e.id||Gi.generateUUIDv4(),this.data=e.data,e.created&&e.created>0?this.created=e.created:this.created=tf.getEpochTime(),this.request_type=e.request_type,this.url_state=e.url_state}toStorageString(){return new Kt("State").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state})}static fromStorageString(e){return Kt.createStatic("State","fromStorageString"),Promise.resolve(new ny(JSON.parse(e)))}static async clearStaleState(e,t){const n=Kt.createStatic("State","clearStaleState"),r=tf.getEpochTime()-t,a=await e.getAllKeys();n.debug("got keys",a);for(let o=0;o<a.length;o++){const c=a[o],d=await e.get(c);let h=!1;if(d)try{const v=await ny.fromStorageString(d);n.debug("got item from key:",c,v.created),v.created<=r&&(h=!0)}catch(v){n.error("Error parsing state for key:",c,v),h=!0}else n.debug("no item in storage for key:",c),h=!0;h&&(n.debug("removed item for key:",c),e.remove(c))}}},db=class iy extends nf{constructor(e){super(e),this.code_verifier=e.code_verifier,this.code_challenge=e.code_challenge,this.authority=e.authority,this.client_id=e.client_id,this.redirect_uri=e.redirect_uri,this.scope=e.scope,this.client_secret=e.client_secret,this.extraTokenParams=e.extraTokenParams,this.response_mode=e.response_mode,this.skipUserInfo=e.skipUserInfo}static async create(e){const t=e.code_verifier===!0?Gi.generateCodeVerifier():e.code_verifier||void 0,n=t?await Gi.generateCodeChallenge(t):void 0;return new iy({...e,code_verifier:t,code_challenge:n})}toStorageString(){return new Kt("SigninState").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(e){Kt.createStatic("SigninState","fromStorageString");const t=JSON.parse(e);return iy.create(t)}},qw=class Vw{constructor(e){this.url=e.url,this.state=e.state}static async create({url:e,authority:t,client_id:n,redirect_uri:r,response_type:a,scope:o,state_data:c,response_mode:d,request_type:h,client_secret:v,nonce:m,url_state:y,resource:E,skipUserInfo:T,extraQueryParams:S,extraTokenParams:O,disablePKCE:R,dpopJkt:I,omitScopeWhenRequesting:M,...C}){if(!e)throw this._logger.error("create: No url passed"),new Error("url");if(!n)throw this._logger.error("create: No client_id passed"),new Error("client_id");if(!r)throw this._logger.error("create: No redirect_uri passed"),new Error("redirect_uri");if(!a)throw this._logger.error("create: No response_type passed"),new Error("response_type");if(!o)throw this._logger.error("create: No scope passed"),new Error("scope");if(!t)throw this._logger.error("create: No authority passed"),new Error("authority");const k=await db.create({data:c,request_type:h,url_state:y,code_verifier:!R,client_id:n,authority:t,redirect_uri:r,response_mode:d,client_secret:v,scope:o,extraTokenParams:O,skipUserInfo:T}),_=new URL(e);_.searchParams.append("client_id",n),_.searchParams.append("redirect_uri",r),_.searchParams.append("response_type",a),M||_.searchParams.append("scope",o),m&&_.searchParams.append("nonce",m),I&&_.searchParams.append("dpop_jkt",I);let P=k.id;y&&(P=`${P}${Zg}${y}`),_.searchParams.append("state",P),k.code_challenge&&(_.searchParams.append("code_challenge",k.code_challenge),_.searchParams.append("code_challenge_method","S256")),E&&(Array.isArray(E)?E:[E]).forEach(U=>_.searchParams.append("resource",U));for(const[x,U]of Object.entries({response_mode:d,...C,...S}))U!=null&&_.searchParams.append(x,U.toString());return new Vw({url:_.href,state:k})}};qw._logger=new Kt("SigninRequest");var Gx=qw,zx="openid",_h=class{constructor(i){if(this.access_token="",this.token_type="",this.profile={},this.state=i.get("state"),this.session_state=i.get("session_state"),this.state){const e=decodeURIComponent(this.state).split(Zg);this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(Zg))}this.error=i.get("error"),this.error_description=i.get("error_description"),this.error_uri=i.get("error_uri"),this.code=i.get("code")}get expires_in(){if(this.expires_at!==void 0)return this.expires_at-tf.getEpochTime()}set expires_in(i){typeof i=="string"&&(i=Number(i)),i!==void 0&&i>=0&&(this.expires_at=Math.floor(i)+tf.getEpochTime())}get isOpenId(){var i;return((i=this.scope)==null?void 0:i.split(" ").includes(zx))||!!this.id_token}},Wx=class{constructor({url:i,state_data:e,id_token_hint:t,post_logout_redirect_uri:n,extraQueryParams:r,request_type:a,client_id:o}){if(this._logger=new Kt("SignoutRequest"),!i)throw this._logger.error("ctor: No url passed"),new Error("url");const c=new URL(i);t&&c.searchParams.append("id_token_hint",t),o&&c.searchParams.append("client_id",o),n&&(c.searchParams.append("post_logout_redirect_uri",n),e&&(this.state=new nf({data:e,request_type:a}),c.searchParams.append("state",this.state.id)));for(const[d,h]of Object.entries({...r}))h!=null&&c.searchParams.append(d,h.toString());this.url=c.href}},Jx=class{constructor(i){this.state=i.get("state"),this.error=i.get("error"),this.error_description=i.get("error_description"),this.error_uri=i.get("error_uri")}},Yx=["nbf","jti","auth_time","nonce","acr","amr","azp","at_hash"],$x=["sub","iss","aud","exp","iat"],Xx=class{constructor(i){this._settings=i,this._logger=new Kt("ClaimsService")}filterProtocolClaims(i){const e={...i};if(this._settings.filterProtocolClaims){let t;Array.isArray(this._settings.filterProtocolClaims)?t=this._settings.filterProtocolClaims:t=Yx;for(const n of t)$x.includes(n)||delete e[n]}return e}mergeClaims(i,e){const t={...i};for(const[n,r]of Object.entries(e))if(t[n]!==r)if(Array.isArray(t[n])||Array.isArray(r))if(this._settings.mergeClaimsStrategy.array=="replace")t[n]=r;else{const a=Array.isArray(t[n])?t[n]:[t[n]];for(const o of Array.isArray(r)?r:[r])a.includes(o)||a.push(o);t[n]=a}else typeof t[n]=="object"&&typeof r=="object"?t[n]=this.mergeClaims(t[n],r):t[n]=r;return t}},Qx=class{constructor(i,e){this.keys=i,this.nonce=e}},hb=class{constructor(i,e){this._logger=new Kt("OidcClient"),this.settings=i instanceof ty?i:new ty(i),this.metadataService=e??new Fw(this.settings),this._claimsService=new Xx(this.settings),this._validator=new Hx(this.settings,this.metadataService,this._claimsService),this._tokenClient=new jw(this.settings,this.metadataService)}async createSigninRequest({state:i,request:e,request_uri:t,request_type:n,id_token_hint:r,login_hint:a,skipUserInfo:o,nonce:c,url_state:d,response_type:h=this.settings.response_type,scope:v=this.settings.scope,redirect_uri:m=this.settings.redirect_uri,prompt:y=this.settings.prompt,display:E=this.settings.display,max_age:T=this.settings.max_age,ui_locales:S=this.settings.ui_locales,acr_values:O=this.settings.acr_values,resource:R=this.settings.resource,response_mode:I=this.settings.response_mode,extraQueryParams:M=this.settings.extraQueryParams,extraTokenParams:C=this.settings.extraTokenParams,dpopJkt:k,omitScopeWhenRequesting:_=this.settings.omitScopeWhenRequesting}){const P=this._logger.create("createSigninRequest");if(h!=="code")throw new Error("Only the Authorization Code flow (with PKCE) is supported");const x=await this.metadataService.getAuthorizationEndpoint();P.debug("Received authorization endpoint",x);const U=await Gx.create({url:x,authority:this.settings.authority,client_id:this.settings.client_id,redirect_uri:m,response_type:h,scope:v,state_data:i,url_state:d,prompt:y,display:E,max_age:T,ui_locales:S,id_token_hint:r,login_hint:a,acr_values:O,dpopJkt:k,resource:R,request:e,request_uri:t,extraQueryParams:M,extraTokenParams:C,request_type:n,response_mode:I,client_secret:this.settings.client_secret,skipUserInfo:o,nonce:c,disablePKCE:this.settings.disablePKCE,omitScopeWhenRequesting:_});await this.clearStaleState();const j=U.state;return await this.settings.stateStore.set(j.id,j.toStorageString()),U}async readSigninResponseState(i,e=!1){const t=this._logger.create("readSigninResponseState"),n=new _h(RC.readParams(i,this.settings.response_mode));if(!n.state)throw t.throw(new Error("No state in response")),null;const r=await this.settings.stateStore[e?"remove":"get"](n.state);if(!r)throw t.throw(new Error("No matching state found in storage")),null;return{state:await db.fromStorageString(r),response:n}}async processSigninResponse(i,e){const t=this._logger.create("processSigninResponse"),{state:n,response:r}=await this.readSigninResponseState(i,!0);if(t.debug("received state from storage; validating response"),this.settings.dpop&&this.settings.dpop.store){const a=await this.getDpopProof(this.settings.dpop.store);e={...e,DPoP:a}}try{await this._validator.validateSigninResponse(r,n,e)}catch(a){if(a instanceof ey&&this.settings.dpop){const o=await this.getDpopProof(this.settings.dpop.store,a.nonce);e.DPoP=o,await this._validator.validateSigninResponse(r,n,e)}else throw a}return r}async getDpopProof(i,e){let t,n;return(await i.getAllKeys()).includes(this.settings.client_id)?(n=await i.get(this.settings.client_id),n.nonce!==e&&e&&(n.nonce=e,await i.set(this.settings.client_id,n))):(t=await Gi.generateDPoPKeys(),n=new Qx(t,e),await i.set(this.settings.client_id,n)),await Gi.generateDPoPProof({url:await this.metadataService.getTokenEndpoint(!1),httpMethod:"POST",keyPair:n.keys,nonce:n.nonce})}async processResourceOwnerPasswordCredentials({username:i,password:e,skipUserInfo:t=!1,extraTokenParams:n={}}){const r=await this._tokenClient.exchangeCredentials({username:i,password:e,...n}),a=new _h(new URLSearchParams);return Object.assign(a,r),await this._validator.validateCredentialsResponse(a,t),a}async useRefreshToken({state:i,redirect_uri:e,resource:t,timeoutInSeconds:n,extraHeaders:r,extraTokenParams:a}){var o;const c=this._logger.create("useRefreshToken");let d;if(this.settings.refreshTokenAllowedScope===void 0)d=i.scope;else{const m=this.settings.refreshTokenAllowedScope.split(" ");d=(((o=i.scope)==null?void 0:o.split(" "))||[]).filter(E=>m.includes(E)).join(" ")}if(this.settings.dpop&&this.settings.dpop.store){const m=await this.getDpopProof(this.settings.dpop.store);r={...r,DPoP:m}}let h;try{h=await this._tokenClient.exchangeRefreshToken({refresh_token:i.refresh_token,scope:d,redirect_uri:e,resource:t,timeoutInSeconds:n,extraHeaders:r,...a})}catch(m){if(m instanceof ey&&this.settings.dpop)r.DPoP=await this.getDpopProof(this.settings.dpop.store,m.nonce),h=await this._tokenClient.exchangeRefreshToken({refresh_token:i.refresh_token,scope:d,redirect_uri:e,resource:t,timeoutInSeconds:n,extraHeaders:r,...a});else throw m}const v=new _h(new URLSearchParams);return Object.assign(v,h),c.debug("validating response",v),await this._validator.validateRefreshResponse(v,{...i,scope:d}),v}async createSignoutRequest({state:i,id_token_hint:e,client_id:t,request_type:n,post_logout_redirect_uri:r=this.settings.post_logout_redirect_uri,extraQueryParams:a=this.settings.extraQueryParams}={}){const o=this._logger.create("createSignoutRequest"),c=await this.metadataService.getEndSessionEndpoint();if(!c)throw o.throw(new Error("No end session endpoint")),null;o.debug("Received end session endpoint",c),!t&&r&&!e&&(t=this.settings.client_id);const d=new Wx({url:c,id_token_hint:e,client_id:t,post_logout_redirect_uri:r,state_data:i,extraQueryParams:a,request_type:n});await this.clearStaleState();const h=d.state;return h&&(o.debug("Signout request has state to persist"),await this.settings.stateStore.set(h.id,h.toStorageString())),d}async readSignoutResponseState(i,e=!1){const t=this._logger.create("readSignoutResponseState"),n=new Jx(RC.readParams(i,this.settings.response_mode));if(!n.state){if(t.debug("No state in response"),n.error)throw t.warn("Response was error:",n.error),new vl(n);return{state:void 0,response:n}}const r=await this.settings.stateStore[e?"remove":"get"](n.state);if(!r)throw t.throw(new Error("No matching state found in storage")),null;return{state:await nf.fromStorageString(r),response:n}}async processSignoutResponse(i){const e=this._logger.create("processSignoutResponse"),{state:t,response:n}=await this.readSignoutResponseState(i,!0);return t?(e.debug("Received state from storage; validating response"),this._validator.validateSignoutResponse(n,t)):e.debug("No state from storage; skipping response validation"),n}clearStaleState(){return this._logger.create("clearStaleState"),nf.clearStaleState(this.settings.stateStore,this.settings.staleStateAgeInSeconds)}async revokeToken(i,e){return this._logger.create("revokeToken"),await this._tokenClient.revoke({token:i,token_type_hint:e})}},kn=(function(i){return i.NotSupported="OIDC authentication not supported",i.Misconfigured="OIDC is misconfigured",i.General="Something went wrong with OIDC discovery",i.OpSupport="Configured OIDC OP does not support required functions",i.DynamicRegistrationNotSupported="Dynamic registration not supported",i.DynamicRegistrationFailed="Dynamic registration failed",i.DynamicRegistrationInvalid="Dynamic registration invalid response",i.CodeExchangeFailed="Failed to exchange code for token",i.InvalidBearerTokenResponse="Invalid bearer token response",i.InvalidIdToken="Invalid ID token",i.MissingOrInvalidStoredState="State required to finish logging in is not found in storage.",i})({}),fb=i=>!!i&&typeof i=="object"&&!Array.isArray(i),Jr=(i,e)=>!i[e]||!Xc(i,e)?(D.error("Missing or invalid property: ".concat(e)),!1):!0,Xc=(i,e)=>i[e]&&typeof i[e]!="string"?(D.error("Invalid property: ".concat(e)),!1):!0,kC=(i,e)=>i[e]&&(!Array.isArray(i[e])||!i[e].every(t=>typeof t=="string"))?(D.error("Invalid property: ".concat(e)),!1):!0,Np=(i,e,t)=>{var n=i[e];return!n||!Array.isArray(n)||!n.includes(t)?(D.error("Invalid property: ".concat(e,". ").concat(t," is required.")),!1):!0},Kw=i=>{if(!fb(i))throw D.error("Issuer configuration not found or malformed"),new Error(kn.OpSupport);var e=[Jr(i,"issuer"),Jr(i,"authorization_endpoint"),Jr(i,"token_endpoint"),Jr(i,"revocation_endpoint"),Xc(i,"registration_endpoint"),Xc(i,"account_management_uri"),Xc(i,"device_authorization_endpoint"),kC(i,"account_management_actions_supported"),Np(i,"response_types_supported","code"),Np(i,"grant_types_supported",fu.AuthorizationCode),Np(i,"code_challenge_methods_supported","S256"),kC(i,"prompt_values_supported")].some(t=>!t);if(!e)return i;throw D.error("Issuer configuration not valid"),new Error(kn.OpSupport)},Hw=i=>{try{return Uw(i)}catch(e){throw D.error("Could not decode id_token",e),e}},Gw=(i,e,t,n)=>{try{if(!i)throw new Error("No ID token");var r=Hw(i);if(r.iss!==e)throw new Error("Invalid issuer");var a=typeof r.aud=="string"?[r.aud]:r.aud;if(!a.includes(t))throw new Error("Invalid audience");if(n!==void 0&&r.nonce!==n)throw new Error("Invalid nonce");if(!r.exp||Date.now()>r.exp*1e3)throw new Error("Invalid expiry")}catch(o){throw D.error("Invalid ID token",o),new Error(kn.InvalidIdToken)}};function zw(i){if(!fb(i))throw D.error("Stored user state not found"),new Error(kn.MissingOrInvalidStoredState);var e=[Jr(i,"homeserverUrl"),Jr(i,"nonce"),Xc(i,"identityServerUrl")].some(t=>!t);if(e)throw new Error(kn.MissingOrInvalidStoredState)}var Zx=i=>fb(i)&&Jr(i,"token_type")&&i.token_type.toLowerCase()==="bearer"&&Jr(i,"access_token")&&Jr(i,"refresh_token")&&(!("expires_in"in i)||typeof i.expires_in=="number");function Ww(i){if(!Zx(i))throw new Error(kn.InvalidBearerTokenResponse)}function wC(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function rf(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?wC(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):wC(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}var Uf=i=>{var e=i??Fa(10);return"openid urn:matrix:org.matrix.msc2967.client:api:* urn:matrix:org.matrix.msc2967.client:device:".concat(e)},eL=(function(){var i=A(function*(e){if(!globalThis.crypto.subtle)return D.warn("A secure context is required to generate code challenge. Using plain text code challenge"),e;var t=yield ob(e);return Af(t)});return function(t){return i.apply(this,arguments)}})(),tL=i=>{var{redirectUri:e}=i;return{scope:Uf(),redirectUri:e,state:Fa(8),nonce:Fa(8),codeVerifier:Fa(64)}},nL=(function(){var i=A(function*(e,t,n){var{scope:r,redirectUri:a,state:o,nonce:c,codeVerifier:d}=n,h=new URL(e);return h.searchParams.append("response_mode","query"),h.searchParams.append("response_type","code"),h.searchParams.append("redirect_uri",a),h.searchParams.append("client_id",t),h.searchParams.append("state",o),h.searchParams.append("scope",r),h.searchParams.append("nonce",c),h.searchParams.append("code_challenge_method","S256"),h.searchParams.append("code_challenge",yield eL(d)),h.toString()});return function(t,n,r){return i.apply(this,arguments)}})(),iL=(function(){var i=A(function*(e){var{metadata:t,redirectUri:n,clientId:r,homeserverUrl:a,identityServerUrl:o,nonce:c,prompt:d,urlState:h,loginHint:v}=e,m=Uf(),y=new hb(rf(rf({},t),{},{client_id:r,redirect_uri:n,authority:t.issuer,response_mode:"query",response_type:"code",scope:m,stateStore:new Lf({prefix:"mx_oidc_",store:window.sessionStorage})})),E={homeserverUrl:a,nonce:c,identityServerUrl:o},T=yield y.createSigninRequest({state:E,nonce:c,prompt:d,url_state:h,login_hint:v});return T.url});return function(t){return i.apply(this,arguments)}})(),rL=i=>({id_token:i.id_token,scope:i.scope,expires_at:i.expires_at,refresh_token:i.refresh_token,access_token:i.access_token,token_type:"Bearer"}),aL=(function(){var i=A(function*(e,t){var n=new URL(window.location.origin);n.searchParams.append("code",e),n.searchParams.append("state",t),hu.setLogger(D);try{var r=new _h(n.searchParams),a=new Lf({prefix:"mx_oidc_",store:window.sessionStorage}),o=yield a.get(r.state);if(!o)throw new Error(kn.MissingOrInvalidStoredState);var c=yield db.fromStorageString(o),d=new hb(rf(rf({},c),{},{stateStore:a})),h=yield d.processSigninResponse(n.href),v=h.userState;zw(v),Ww(h),Gw(h.id_token,d.settings.authority,d.settings.client_id,v.nonce);var m=rL(h);return{oidcClientSettings:{clientId:d.settings.client_id,issuer:d.settings.authority},tokenResponse:m,homeserverUrl:v.homeserverUrl,identityServerUrl:v.identityServerUrl,idTokenClaims:h.profile}}catch(E){D.error("Oidc login failed",E);var y=E.message;throw Object.values(kn).includes(y)?E:new Error(kn.CodeExchangeFailed)}});return function(t,n){return i.apply(this,arguments)}})();function IC(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function OC(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?IC(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):IC(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}var vb=(function(){var i=A(function*(e){var t=new URL(".well-known/openid-configuration",e),n=yield fetch(t,{method:$.Get,signal:Mf(5e3)}),r=yield n.json();return mb(r)});return function(t){return i.apply(this,arguments)}})(),mb=(function(){var i=A(function*(e){var t=Kw(e),n=new ty({authority:t.issuer,metadata:t,redirect_uri:"",client_id:""}),r=new Fw(n);return OC(OC({},t),{},{signingKeys:yield r.getSigningKeys()})});return function(t){return i.apply(this,arguments)}})(),fu=(function(i){return i.AuthorizationCode="authorization_code",i.RefreshToken="refresh_token",i.DeviceAuthorization="urn:ietf:params:oauth:grant-type:device_code",i})({}),sL=fu.DeviceAuthorization,xp=(i,e)=>{if(!e)return!1;var t=new URL(e);return!(t.protocol!==i.protocol||t.hostname!==i.hostname&&!t.hostname.endsWith(".".concat(i.hostname)))},oL=(function(){var i=A(function*(e,t){if(!e.registration_endpoint)throw new Error(kn.DynamicRegistrationNotSupported);var n=[fu.AuthorizationCode,fu.RefreshToken];if(n.some(v=>!e.grant_types_supported.includes(v)))throw new Error(kn.DynamicRegistrationNotSupported);var r=new URL(t.clientUri),a={client_name:t.clientName,client_uri:t.clientUri,response_types:["code"],grant_types:n,redirect_uris:t.redirectUris,id_token_signed_response_alg:"RS256",token_endpoint_auth_method:"none",application_type:t.applicationType,contacts:t.contacts,logo_uri:xp(r,t.logoUri)?t.logoUri:void 0,policy_uri:xp(r,t.policyUri)?t.policyUri:void 0,tos_uri:xp(r,t.tosUri)?t.tosUri:void 0},o={Accept:"application/json","Content-Type":"application/json"};try{var c=yield fetch(e.registration_endpoint,{method:$.Post,headers:o,body:JSON.stringify(a)});if(c.status>=400)throw new Error(kn.DynamicRegistrationFailed);var d=yield c.json(),h=d.client_id;if(!h||typeof h!="string")throw new Error(kn.DynamicRegistrationInvalid);return h}catch(v){throw Object.values(kn).includes(v.message)?v:(D.error("Dynamic registration request failed",v),new Error(kn.DynamicRegistrationFailed))}});return function(t,n){return i.apply(this,arguments)}})();class lL{constructor(e,t,n,r,a){this.issuer=e,this.clientId=t,this.redirectUri=n,this.deviceId=r,this.idTokenClaims=a,b(this,"oidcClientReady",void 0),b(this,"initPromise",void 0),b(this,"oidcClient",void 0),b(this,"inflightRefreshRequest",void 0),this.oidcClientReady=Promise.resolve()}ensureInit(){var e=this;return A(function*(){if(!e.oidcClient){if(e.initPromise)return e.initPromise;e.initPromise=e.initialiseOidcClient(e.issuer,e.clientId,e.deviceId,e.redirectUri);try{yield e.initPromise}finally{e.initPromise=void 0}}})()}initialiseOidcClient(e,t,n,r){var a=this;return A(function*(){try{var o,c=yield vb(e),d=Uf(n);a.oidcClient=new hb({metadata:c,signingKeys:(o=c.signingKeys)!==null&&o!==void 0?o:void 0,client_id:t,scope:d,redirect_uri:r,authority:c.issuer,stateStore:new Lf({prefix:"mx_oidc_",store:window.sessionStorage})})}catch(h){throw D.error("Failed to initialise OIDC client.",h),new Error("Failed to initialise OIDC client.")}})()}doRefreshAccessToken(e){var t=this;return A(function*(){yield t.ensureInit(),t.inflightRefreshRequest||(t.inflightRefreshRequest=t.getNewTokens(e));try{var n=yield t.inflightRefreshRequest;return n}catch(r){throw r instanceof vl?new Yy(r):r}finally{t.inflightRefreshRequest=void 0}})()}persistTokens(e){return A(function*(){})()}getNewTokens(e){var t=this;return A(function*(){if(!t.oidcClient)throw new Error("Cannot get new token before OIDC client is initialised.");var n={refresh_token:e,session_state:"test",data:void 0,profile:t.idTokenClaims},r=Date.now(),a=yield t.oidcClient.useRefreshToken({state:n,timeoutInSeconds:300}),o={accessToken:a.access_token,refreshToken:a.refresh_token,expiry:a.expires_in?new Date(r+a.expires_in*1e3):void 0};return yield t.persistTokens(o),o})()}}var cL=["server","limit","since"];function MC(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function wt(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?MC(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):MC(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}var uL=3e3,PC=600*1e3,dL=new Ht("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent"),ml=(function(i){return i.Chronological="chronological",i.Detached="detached",i})({}),hL=new Sl("m.get_login_token","org.matrix.msc3882.get_login_token"),Jw="uk.half-shot.msc2666",Yw="uk.half-shot.msc2666.mutual_rooms",$w="uk.half-shot.msc2666.query_mutual_rooms",bn="org.matrix.msc4140",ry="org.matrix.msc4354",Xw="uk.tcpip.msc4133",Qw="uk.tcpip.msc4133.stable",Zi="$",ye=(function(i){return i.Sync="sync",i.Event="event",i.ToDeviceEvent="toDeviceEvent",i.ReceivedToDeviceMessage="receivedToDeviceMessage",i.AccountData="accountData",i.Room="Room",i.DeleteRoom="deleteRoom",i.SyncUnexpectedError="sync.unexpectedError",i.ClientWellKnown="WellKnown.client",i.ReceivedVoipEvent="received_voip_event",i.TurnServers="turnServers",i.TurnServersError="turnServers.error",i})({}),AC=new Ht("action","org.matrix.msc3824.action");class Bf extends Ot{constructor(e){var t,n,r,a,o,c;super(),r=this,b(this,"logger",void 0),b(this,"reEmitter",new Cl(this)),b(this,"olmVersion",null),b(this,"usingExternalCrypto",!1),b(this,"_store",void 0),b(this,"deviceId",void 0),b(this,"credentials",void 0),b(this,"legacyPickleKey",void 0),b(this,"scheduler",void 0),b(this,"clientRunning",!1),b(this,"timelineSupport",!1),b(this,"urlPreviewCache",{}),b(this,"identityServer",void 0),b(this,"http",void 0),b(this,"cryptoBackend",void 0),b(this,"enableEncryptedStateEvents",void 0),b(this,"cryptoCallbacks",void 0),b(this,"callEventHandler",void 0),b(this,"groupCallEventHandler",void 0),b(this,"supportsCallTransfer",!1),b(this,"forceTURN",!1),b(this,"iceCandidatePoolSize",0),b(this,"idBaseUrl",void 0),b(this,"baseUrl",void 0),b(this,"isVoipWithNoMediaAllowed",void 0),b(this,"disableVoip",void 0),b(this,"useLivekitForGroupCalls",void 0),b(this,"canSupportVoip",!1),b(this,"peekSync",null),b(this,"isGuestAccount",!1),b(this,"ongoingScrollbacks",{}),b(this,"notifTimelineSet",null),b(this,"legacyCryptoStore",void 0),b(this,"verificationMethods",void 0),b(this,"fallbackICEServerAllowed",!1),b(this,"syncApi",void 0),b(this,"roomNameGenerator",void 0),b(this,"pushRules",void 0),b(this,"syncLeftRoomsPromise",void 0),b(this,"syncedLeftRooms",!1),b(this,"clientOpts",void 0),b(this,"clientWellKnownIntervalID",void 0),b(this,"canResetTimelineCallback",void 0),b(this,"canSupport",new Map),b(this,"pushProcessor",new Bi(this)),b(this,"serverVersionsPromise",void 0),b(this,"clientWellKnown",void 0),b(this,"clientWellKnownPromise",void 0),b(this,"turnServers",[]),b(this,"turnServersExpiry",0),b(this,"checkTurnServersIntervalID",void 0),b(this,"txnCtr",0),b(this,"mediaHandler",new JN(this)),b(this,"sessionId",void 0),b(this,"eventsBeingEncrypted",new Set),b(this,"useE2eForGroupCall",!0),b(this,"toDeviceMessageQueue",void 0),b(this,"livekitServiceURL",void 0),b(this,"_secretStorage",void 0),b(this,"ignoredInvites",void 0),b(this,"matrixRTC",void 0),b(this,"serverCapabilitiesService",void 0),b(this,"startCallEventHandler",()=>{this.isInitialSyncComplete()&&(Fg()&&(this.callEventHandler.start(),this.groupCallEventHandler.start()),this.off(ye.Sync,this.startCallEventHandler))}),b(this,"startMatrixRTC",()=>{this.isInitialSyncComplete()&&(this.matrixRTC.start(),this.off(ye.Sync,this.startMatrixRTC))}),b(this,"fixupRoomNotifications",()=>{if(this.isInitialSyncComplete()){var h,v=((h=this.getRooms())!==null&&h!==void 0?h:[]).filter(E=>E.getUnreadNotificationCount(it.Total)>0);for(var m of v){var y=this.getSafeUserId();m.fixupNotifications(y)}this.off(ye.Sync,this.fixupRoomNotifications)}}),this.logger=(t=e.logger)!==null&&t!==void 0?t:D,e.baseUrl=yp(e.baseUrl),e.idBaseUrl=yp(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=(n=e.usingExternalCrypto)!==null&&n!==void 0?n:!1,this.store=e.store||new J1,this.deviceId=e.deviceId||null,this.sessionId=Fa(10);var d=e.userId||null;this.credentials={userId:d},this.http=new gw(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:At.V3,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader,logger:this.logger}),e.pickleKey&&(this.legacyPickleKey=e.pickleKey),this.useLivekitForGroupCalls=!!e.useLivekitForGroupCalls,this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction((function(){var h=A(function*(v){var m=r.getRoom(v.getRoomId());v.status!==Ie.SENDING&&r.updatePendingEventStatus(m,v,Ie.SENDING);var y=yield r.sendEventHttpRequest(v);return m&&m.updatePendingEvent(v,Ie.SENT,y.event_id),y});return function(v){return h.apply(this,arguments)}})()),this.disableVoip=(a=e.disableVoip)!==null&&a!==void 0?a:!1,!this.disableVoip&&Fg()&&(this.callEventHandler=new mN(this),this.groupCallEventHandler=new pN(this),this.canSupportVoip=!0,this.on(ye.Sync,this.startCallEventHandler)),this.matrixRTC=new Px(this.logger,this),this.serverCapabilitiesService=new bw(this.logger,this.http),this.on(ye.Sync,this.fixupRoomNotifications),this.timelineSupport=!!e.timelineSupport,this.legacyCryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.enableEncryptedStateEvents=(o=e.enableEncryptedStateEvents)!==null&&o!==void 0?o:!1,this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=e.iceCandidatePoolSize===void 0?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,e.useE2eForGroupCall!==void 0&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.livekitServiceURL=e.livekitServiceURL,this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new nx(this,this.logger),this.on(ot.Decrypted,h=>{Zw(this,h)}),this.ignoredInvites=new ix(this),this._secretStorage=new xw(this,(c=e.cryptoCallbacks)!==null&&c!==void 0?c:{}),this.setMaxListeners(0)}set store(e){this._store=e,this._store.setUserCreator(t=>$r.createUser(t,this))}get store(){return this._store}startClient(e){var t=this;return A(function*(){if(!t.clientRunning){t.clientRunning=!0,t.on(ye.Sync,t.startMatrixRTC);var n=t.getUserId();n&&t.store.storeUser(new $r(n)),t.supportsVoip()&&(t.checkTurnServersIntervalID=setInterval(()=>{t.checkTurnServers()},PC),t.checkTurnServers()),t.syncApi&&(t.logger.error("Still have sync object whilst not running: stopping old one"),t.syncApi.stop());try{yield t.getVersions();var{threads:r,list:a,fwdPagination:o}=yield t.doesServerSupportThread();_t.setServerSideSupport(r),_t.setServerSideListSupport(a),_t.setServerSideFwdPaginationSupport(o)}catch(c){t.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",c)}t.clientOpts=e??{},t.clientOpts.slidingSync?t.syncApi=new Pw(t.clientOpts.slidingSync,t,t.clientOpts,t.buildSyncApiOptions()):t.syncApi=new La(t,t.clientOpts,t.buildSyncApiOptions()),t.syncApi.sync().catch(c=>t.logger.info("Sync startup aborted with an error:",c)),t.clientOpts.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*t.clientOpts.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.toDeviceMessageQueue.start(),t.serverCapabilitiesService.start()}})()}buildSyncApiOptions(){return{cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:e=>this.canResetTimelineCallback?this.canResetTimelineCallback(e):!1,logger:this.logger.getChild("sync")}}stopClient(){var e,t,n,r,a;(e=this.cryptoBackend)===null||e===void 0||e.stop(),this.off(ye.Sync,this.startMatrixRTC),this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,(t=this.syncApi)===null||t===void 0||t.stop(),this.syncApi=void 0,(n=this.peekSync)===null||n===void 0||n.stopPeeking(),(r=this.callEventHandler)===null||r===void 0||r.stop(),(a=this.groupCallEventHandler)===null||a===void 0||a.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,globalThis.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.clientWellKnownIntervalID!==void 0&&globalThis.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop(),this.matrixRTC.stop(),this.serverCapabilitiesService.stop())}clearStores(){var e=this,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(this.clientRunning)throw new Error("Cannot clear stores while client is running");var n=[];n.push(this.store.deleteAllData()),this.legacyCryptoStore&&n.push(this.legacyCryptoStore.deleteAllData());var r=(function(){var a=A(function*(){var o;try{if(o=globalThis.indexedDB,!o)return}catch{return}var c=function*(y){var E=new Promise((T,S)=>{e.logger.info("Removing IndexedDB instance ".concat(y));var O=o.deleteDatabase(y);O.onsuccess=R=>{e.logger.info("Removed IndexedDB instance ".concat(y)),T(0)},O.onerror=R=>{e.logger.warn("Failed to remove IndexedDB instance ".concat(y,":"),R),T(0)},O.onblocked=R=>{e.logger.info("cannot yet remove IndexedDB instance ".concat(y))}});yield E};for(var d of["".concat((h=t.cryptoDatabasePrefix)!==null&&h!==void 0?h:Pp,"::matrix-sdk-crypto"),"".concat((v=t.cryptoDatabasePrefix)!==null&&v!==void 0?v:Pp,"::matrix-sdk-crypto-meta")]){var h,v;yield*c(d)}});return function(){return a.apply(this,arguments)}})();return n.push(r()),Promise.all(n).then()}getUserId(){var e,t;return(e=(t=this.credentials)===null||t===void 0?void 0:t.userId)!==null&&e!==void 0?e:null}getSafeUserId(){var e=this.getUserId();if(!e)throw new Error("Expected logged in user but found none.");return e}getDomain(){var e;return(e=this.credentials)!==null&&e!==void 0&&e.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){var e,t;return(e=(t=this.credentials)===null||t===void 0||(t=t.userId)===null||t===void 0?void 0:t.split(":")[0].substring(1))!==null&&e!==void 0?e:null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return!this.disableVoip&&this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return ou(this,e)}createGroupCall(e,t,n,r,a,o){var c=this;return A(function*(){if(c.getGroupCallForRoom(e))throw new Error("".concat(e," already has an existing group call"));var d=c.getRoom(e);if(!d)throw new Error("Cannot find room ".concat(e));return new tb(c,d,t,n,r,void 0,a||c.isVoipWithNoMediaAllowed,o,c.isVoipWithNoMediaAllowed,c.useLivekitForGroupCalls,c.livekitServiceURL).create()})()}getLivekitServiceURL(){return this.livekitServiceURL}setLivekitServiceURL(e){this.livekitServiceURL=e}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return(e=(t=this.syncApi)===null||t===void 0?void 0:t.getSyncState())!==null&&e!==void 0?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){var e=this.getSyncState();return e?e===ct.Prepared||e===ct.Syncing:!1}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),(e=(t=this.syncApi)===null||t===void 0?void 0:t.retryImmediately())!==null&&e!==void 0?e:!1}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(){var e=this;return A(function*(){var t=e.serverCapabilitiesService.getCachedCapabilities();return t||e.serverCapabilitiesService.fetchCapabilities()})()}getCachedCapabilities(){return this.serverCapabilitiesService.getCachedCapabilities()}fetchCapabilities(){return this.serverCapabilitiesService.fetchCapabilities()}initRustCrypto(){var e=arguments,t=this;return A(function*(){var n,r,a=e.length>0&&e[0]!==void 0?e[0]:{};if(t.cryptoBackend){t.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}var o=t.getUserId();if(o===null)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");var c=t.getDeviceId();if(c===null)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");t.logger.debug("Downloading Rust crypto library");var d=yield QD(()=>import("./index-CQGa4boa.js"),__vite__mapDeps([0,1])),h=yield d.initRustCrypto({logger:t.logger,http:t.http,userId:o,deviceId:c,secretStorage:t.secretStorage,cryptoCallbacks:t.cryptoCallbacks,storePrefix:a.useIndexedDB===!1?null:(n=a.cryptoDatabasePrefix)!==null&&n!==void 0?n:Pp,storeKey:a.storageKey,storePassphrase:a.storagePassword,legacyCryptoStore:t.legacyCryptoStore,legacyPickleKey:(r=t.legacyPickleKey)!==null&&r!==void 0?r:"DEFAULT_KEY",legacyMigrationProgressListener:(v,m)=>{t.emit(ln.LegacyCryptoStoreMigrationProgress,v,m)},enableEncryptedStateEvents:t.enableEncryptedStateEvents});h.setSupportedVerificationMethods(t.verificationMethods),t.cryptoBackend=h,t.on(Hn.Membership,h.onRoomMembership.bind(h)),t.on(ye.Event,v=>{h.onLiveEventFromSync(v)}),t.reEmitter.reEmit(h,[ln.VerificationRequestReceived,ln.UserTrustStatusChanged,ln.KeyBackupStatus,ln.KeyBackupSessionsRemaining,ln.KeyBackupFailed,ln.KeyBackupDecryptionKeyCached,ln.KeysChanged,ln.DevicesUpdated,ln.WillUpdateDevices,ln.DehydratedDeviceCreated,ln.DehydratedDeviceUploaded,ln.RehydrationStarted,ln.RehydrationProgress,ln.RehydrationCompleted,ln.RehydrationError,ln.DehydrationKeyCached,ln.DehydratedDeviceRotationError])})()}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isRoomEncrypted(e){var t=this.getRoom(e);return t?t.hasEncryptionStateEvent():!1}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}makeKeyBackupPath(e,t,n){var r;t!==void 0?r=he("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):e!==void 0?r=he("/room_keys/keys/$roomId",{$roomId:e}):r="/room_keys/keys";var a=n===void 0?void 0:{version:n};return{path:r,queryData:a}}deleteKeysFromBackup(e,t,n){var r=this;return A(function*(){var a=r.makeKeyBackupPath(e,t,n);yield r.http.authedRequest($.Delete,a.path,a.queryData,void 0,{prefix:At.V3})})()}getMediaConfig(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=e?"/media/config":"/config";return this.http.authedRequest($.Get,t,void 0,void 0,{prefix:e?At.V1:$o.V3})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.store.getRooms(),n=new Set(t);for(var r of n){var a=this.findPredecessorRooms(r,!0,e);for(var o of a)n.delete(o)}return Array.from(n)}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){var n=this;return A(function*(){if(!n.clientRunning)return n.logger.warn("Calling `setAccountData` before the client is started: `getAccountData` may return inconsistent results."),yield Mg(5,()=>n.setAccountDataRaw(e,t));var r=n.store.getAccountData(e);if(r&&cl(r.event.content,t))return{};var a=Promise.withResolvers();function o(d){d.getType()===e&&a.resolve()}n.addListener(ye.AccountData,o);try{var c=yield Mg(5,()=>n.setAccountDataRaw(e,t));return yield a.promise,c}finally{n.removeListener(ye.AccountData,o)}})()}setAccountDataRaw(e,t){var n=he("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return this.http.authedRequest($.Put,n,void 0,t)}getAccountData(e){return this.store.getAccountData(e)}getAccountDataFromServer(e){var t=this;return A(function*(){if(t.isInitialSyncComplete()){var n=t.store.getAccountData(e);return n?n.getContent():null}var r=he("/user/$userId/account_data/$type",{$userId:t.credentials.userId,$type:e});try{return yield t.http.authedRequest($.Get,r)}catch(o){var a;if(((a=o.data)===null||a===void 0?void 0:a.errcode)==="M_NOT_FOUND")return null;throw o}})()}deleteAccountData(e){var t=this;return A(function*(){var n=t.canSupport.get(nn.AccountDataDeletion);if(n===tn.Unsupported){yield t.setAccountData(e,{});return}var r=he("/user/$userId/account_data/$type",{$userId:t.getSafeUserId(),$type:e}),a=n===tn.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return yield t.http.authedRequest($.Delete,r,void 0,void 0,a)})()}getIgnoredUsers(){var e=this.getAccountData(G.IgnoredUserList);return e!=null&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e){var t={ignored_users:{}};return e.forEach(n=>{t.ignored_users[n]={}}),this.setAccountData(G.IgnoredUserList,t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}joinRoom(e){var t=arguments,n=this;return A(function*(){var r,a,o=t.length>1&&t[1]!==void 0?t[1]:{},c=n.getRoom(e),d=c?.getMember(n.getSafeUserId()),h=d?.membership,v=h==Ne.Invite&&(r=d==null||(a=d.events.member)===null||a===void 0?void 0:a.getSender())!==null&&r!==void 0?r:null;if(n.logger.debug("joinRoom[".concat(e,"]: preJoinMembership=").concat(h,", inviter=").concat(v,", opts=").concat(JSON.stringify(o))),h==Ne.Join)return c;var m=Promise.resolve();if(o.inviteSignUrl){var y=new URL(o.inviteSignUrl);y.searchParams.set("mxid",n.credentials.userId),m=n.http.requestOtherUrl($.Post,y)}var E={};o.viaServers&&(E.via=E.server_name=o.viaServers.slice(0,3));var T={},S=yield m;S&&(T.third_party_signed=S);var O=he("/join/$roomid",{$roomid:e}),R=yield n.http.authedRequest($.Post,O,E,T),I=R.room_id;if(o.acceptSharedHistory&&v&&n.cryptoBackend){var M=yield n.cryptoBackend.maybeAcceptKeyBundle(I,v);M||n.cryptoBackend.markRoomAsPendingKeyBundle(I,v)}var C=n.getRoom(I);if(C!=null&&C.hasMembershipState(n.credentials.userId,Ne.Join))return C;var k=new La(n,n.clientOpts,n.buildSyncApiOptions());return k.createRoom(I)})()}knockRoom(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=this.getRoom(e);if(n!=null&&n.hasMembershipState(this.credentials.userId,Ne.Knock))return Promise.resolve({room_id:n.roomId});var r=he("/knock/$roomIdOrAlias",{$roomIdOrAlias:e}),a={};if(t.viaServers){var o=Array.isArray(t.viaServers)?t.viaServers.slice(0,3):[t.viaServers];a.server_name=o,a.via=o}var c={};return t.reason&&(c.reason=t.reason),this.http.authedRequest($.Post,r,a,c)}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,Ie.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![Ie.QUEUED,Ie.NOT_SENT,Ie.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===Ie.ENCRYPTING?this.eventsBeingEncrypted.delete(e.getId()):this.scheduler&&e.status===Ie.QUEUED&&this.scheduler.removeEventFromQueue(e);var t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,Ie.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,G.RoomName,{name:t})}setRoomTopic(e,t,n){var r=iw(t,n);return this.sendStateEvent(e,G.RoomTopic,r)}getRoomTags(e){var t=he("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest($.Get,t)}setRoomTag(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},r=he("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest($.Put,r,void 0,n)}deleteRoomTag(e,t){var n=he("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest($.Delete,n)}setRoomAccountData(e,t,n){var r=he("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest($.Put,r,void 0,n)}setPowerLevel(e,t,n){var r=this;return A(function*(){var a,o;if(r.clientRunning&&r.isInitialSyncComplete()){var c;o=(c=r.getRoom(e))===null||c===void 0||(c=c.currentState)===null||c===void 0||(c=c.getStateEvents(G.RoomPowerLevels,""))===null||c===void 0?void 0:c.getContent()}if(!o)try{o=yield r.getStateEvent(e,G.RoomPowerLevels,"")}catch(v){if(v instanceof Ct&&v.errcode==="M_NOT_FOUND")o={};else throw v}o=wu(o),(a=o)!==null&&a!==void 0&&a.users||(o.users={});var d=Array.isArray(t)?t:[t];for(var h of d)n==null?delete o.users[h]:o.users[h]=n;return r.sendStateEvent(e,G.RoomPowerLevels,o,"")})()}unstable_createLiveBeacon(e,t){var n=this;return A(function*(){return n.unstable_setLiveBeacon(e,t)})()}unstable_setLiveBeacon(e,t){var n=this;return A(function*(){return n.sendStateEvent(e,sb.name,t,n.getUserId())})()}sendEvent(e,t,n,r,a){var o,c,d,h;return!(t!=null&&t.startsWith(Zi))&&t!==null?(h=r,d=n,c=t,o=null):(h=a,d=r,c=n,o=t),this.addThreadRelationIfNeeded(d,o,e),this.sendCompleteEvent({roomId:e,threadId:o,eventObject:{type:c,content:d},txnId:h})}addThreadRelationIfNeeded(e,t,n){var r;if(t&&!((r=e["m.relates_to"])!==null&&r!==void 0&&r.rel_type)){var a,o,c=!!((a=e["m.relates_to"])!==null&&a!==void 0&&a["m.in_reply_to"]);e["m.relates_to"]=wt(wt({},e["m.relates_to"]),{},{rel_type:mt.name,event_id:t,is_falling_back:!c});var d=(o=this.getRoom(n))===null||o===void 0?void 0:o.getThread(t);if(d&&!c){var h,v;e["m.relates_to"]["m.in_reply_to"]={event_id:(h=(v=d.lastReply(m=>m.isRelation(mt.name)&&!m.status))===null||v===void 0?void 0:v.getId())!==null&&h!==void 0?h:t}}}}sendCompleteEvent(e){var{roomId:t,threadId:n,eventObject:r,delayOpts:a,queryDict:o,txnId:c}=e;c||(c=this.makeTxnId());var d=new Sn(Object.assign(r,{event_id:"~"+t+":"+c,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:t,origin_server_ts:new Date().getTime()})),h=this.getRoom(t),v=n?h?.getThread(n):void 0;v&&d.setThread(v),a||(this.reEmitter.reEmit(d,[ot.Replaced,ot.VisibilityChange]),h?.reEmitter.reEmit(d,[ot.BeforeRedaction]));var m=d.getAssociatedId();if(m!=null&&m.startsWith("~")){var y=h?.getPendingEvents().find(T=>T.getId()===m);y?.once(ot.LocalEventIdReplaced,()=>{d.updateAssociatedId(y.getId())})}var E=d.getType();return this.logger.debug("sendEvent of type ".concat(E," in ").concat(t," with txnId ").concat(c).concat(a?" (delayed event)":"").concat(o?" query params: "+JSON.stringify(o):"")),d.setTxnId(c),d.setStatus(Ie.SENDING),a?this.encryptAndSendEvent(h,d,a,o):(h?.addPendingEvent(d,c),d.status===Ie.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(h,d,o))}encryptAndSendEvent(e,t,n,r){var a=this;return A(function*(){var o=r;if(n&&Qh(n))return a.sendEventHttpRequest(t,n,o);o||(o=n);try{var c;a.eventsBeingEncrypted.add(t.getId());try{yield a.encryptEventIfNeeded(t,e??void 0)}finally{c=!a.eventsBeingEncrypted.delete(t.getId())}if(c)return{};t.status===Ie.ENCRYPTING&&a.updatePendingEventStatus(e,t,Ie.SENDING);var d=null;return a.scheduler&&(d=a.scheduler.queueEvent(t),d&&a.scheduler.getQueueForEvent(t).length>1&&a.updatePendingEventStatus(e,t,Ie.QUEUED)),d||(d=a.sendEventHttpRequest(t,o),e&&(d=d.then(h=>(e.updatePendingEvent(t,Ie.SENT,h.event_id),h)))),yield d}catch(h){a.logger.error("Error sending event",h);try{t.error=h,a.updatePendingEventStatus(e,t,Ie.NOT_SENT)}catch(v){a.logger.error("Exception in error handler!",v)}throw h instanceof Ct&&(h.event=t),h}})()}encryptEventIfNeeded(e,t){var n=this;return A(function*(){if(t&&(yield n.shouldEncryptEventForRoom(e,t))&&!(!n.cryptoBackend&&n.usingExternalCrypto)){if(!n.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");n.updatePendingEventStatus(t,e,Ie.ENCRYPTING),yield n.cryptoBackend.encryptEvent(e,t)}})()}shouldEncryptEventForRoom(e,t){var n=this;return A(function*(){var r;return e.isEncrypted()||e.getType()===G.Reaction||e.isRedaction()?!1:!!(t.hasEncryptionStateEvent()||(yield(r=n.cryptoBackend)===null||r===void 0?void 0:r.isEncryptionEnabledInRoom(t.roomId)))})()}getEncryptedIfNeededEventType(e,t){var n;return t===G.Reaction?t:(n=this.getRoom(e))!==null&&n!==void 0&&n.hasEncryptionStateEvent()?G.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,n){e?e.updatePendingEvent(t,n):t.setStatus(n)}sendEventHttpRequest(e,t,n){var r=e.getTxnId();r||(r=this.makeTxnId(),e.setTxnId(r));var a={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:r},o;if(e.isState()){var c="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(c="/rooms/$roomId/state/$eventType/$stateKey"),o=he(c,a)}else if(e.isRedaction()&&e.event.redacts){var d="/rooms/$roomId/redact/$redactsEventId/$txnId";o=he(d,wt({$redactsEventId:e.event.redacts},a))}else o=he("/rooms/$roomId/send/$eventType/$txnId",a);var h=t&&Qh(t)?t:void 0,v=h?n:t,m=e.getWireContent();return h?this.http.authedRequest($.Put,o,wt(wt({},DC(h)),v),m):this.http.authedRequest($.Put,o,v,m).then(y=>(this.logger.debug("Event sent to ".concat(e.getRoomId()," with event id ").concat(y.event_id)),y))}redactEvent(e,t,n,r,a){var o,c,d;(o=n)!==null&&o!==void 0&&o.startsWith(Zi)||(a=r,r=n,n=t,t=null);var h=(c=a)===null||c===void 0?void 0:c.reason,v={reason:h};if(((d=a)===null||d===void 0?void 0:d.with_rel_types)!==void 0){if(this.canSupport.get(nn.RelationBasedRedactions)===tn.Unsupported)throw new Error("Server does not support relation based redactions "+"roomId ".concat(e," eventId ").concat(n," txnId: ").concat(r," threadId ").concat(t));var m=this.canSupport.get(nn.RelationBasedRedactions)===tn.Stable?Cg.stable:Cg.unstable;v[m]=a.with_rel_types}return this.sendCompleteEvent({roomId:e,threadId:t,eventObject:{type:G.RoomRedaction,content:v,redacts:n},txnId:r})}sendMessage(e,t,n,r){typeof t!="string"&&t!==null&&(r=n,n=t,t=null);var a=G.RoomMessage,o=n;return this.sendEvent(e,t,a,o,r)}sendTextMessage(e,t,n,r){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Zi))&&t!==null&&(r=n,n=t,t=null);var o=Qk(n);return this.sendMessage(e,t,o,r)}sendNotice(e,t,n,r){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Zi))&&t!==null&&(r=n,n=t,t=null);var o=Zk(n);return this.sendMessage(e,t,o,r)}sendEmoteMessage(e,t,n,r){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Zi))&&t!==null&&(r=n,n=t,t=null);var o=ew(n);return this.sendMessage(e,t,o,r)}sendImageMessage(e,t,n,r){var a,o=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Image";!((a=t)!==null&&a!==void 0&&a.startsWith(Zi))&&t!==null&&(o=r||"Image",r=n,n=t,t=null);var c={msgtype:hr.Image,url:n,info:r,body:o};return this.sendMessage(e,t,c)}sendStickerMessage(e,t,n,r){var a,o=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Sticker";!((a=t)!==null&&a!==void 0&&a.startsWith(Zi))&&t!==null&&(o=r||"Sticker",r=n,n=t,t=null);var c={url:n,info:r,body:o};return this.sendEvent(e,t,G.Sticker,c)}sendHtmlMessage(e,t,n,r){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Zi))&&t!==null&&(r=n,n=t,t=null);var o=Yk(n,r);return this.sendMessage(e,t,o)}sendHtmlNotice(e,t,n,r){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Zi))&&t!==null&&(r=n,n=t,t=null);var o=$k(n,r);return this.sendMessage(e,t,o)}sendHtmlEmote(e,t,n,r){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Zi))&&t!==null&&(r=n,n=t,t=null);var o=Xk(n,r);return this.sendMessage(e,t,o)}_unstable_sendDelayedEvent(e,t,n,r,a,o){var c=this;return A(function*(){if(!(yield c.doesServerSupportUnstableFeature(bn)))throw new hi("Server does not support the delayed events API","sendDelayedEvent");return c.addThreadRelationIfNeeded(a,n,e),c.sendCompleteEvent({roomId:e,threadId:n,eventObject:{type:r,content:a},delayOpts:t,txnId:o})})()}_unstable_sendStickyDelayedEvent(e,t,n,r,a,o,c){var d=this;return A(function*(){if(!(yield d.doesServerSupportUnstableFeature(bn)))throw new hi("Server does not support the delayed events API","getDelayedEvents");if(!(yield d.doesServerSupportUnstableFeature(ry)))throw new Yg("Server does not support the sticky events","sendStickyEvent");return d.addThreadRelationIfNeeded(o,r,e),d.sendCompleteEvent({roomId:e,threadId:r,eventObject:{type:a,content:o},queryDict:{"org.matrix.msc4354.sticky_duration_ms":t},delayOpts:n,txnId:c})})()}_unstable_sendDelayedStateEvent(e,t,n,r){var a=arguments,o=this;return A(function*(){var c=a.length>4&&a[4]!==void 0?a[4]:"",d=a.length>5&&a[5]!==void 0?a[5]:{};if(!(yield o.doesServerSupportUnstableFeature(bn)))throw new hi("Server does not support the delayed events API","sendDelayedStateEvent");var h={$roomId:e,$eventType:n,$stateKey:c},v=he("/rooms/$roomId/state/$eventType",h);return c!==void 0&&(v=he(v+"/$stateKey",h)),o.http.authedRequest($.Put,v,DC(t),r,d)})()}_unstable_sendStickyEvent(e,t,n,r,a,o){var c=this;return A(function*(){if(!(yield c.doesServerSupportUnstableFeature(ry)))throw new Yg("Server does not support the sticky events","sendStickyEvent");return c.addThreadRelationIfNeeded(a,n,e),c.sendCompleteEvent({roomId:e,threadId:n,eventObject:{type:r,content:a},queryDict:{"org.matrix.msc4354.sticky_duration_ms":t},txnId:o})})()}_unstable_getDelayedEvents(e,t,n){var r=this;return A(function*(){if(!(yield r.doesServerSupportUnstableFeature(bn)))throw new hi("Server does not support the delayed events API","getDelayedEvents");var a={from:n,status:e,delay_id:t};return yield r.http.authedRequest($.Get,"/delayed_events",a,void 0,{prefix:"".concat(At.Unstable,"/").concat(bn)})})()}_unstable_updateDelayedEvent(e,t){var n=arguments,r=this;return A(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:{};if(!(yield r.doesServerSupportUnstableFeature(bn)))throw new hi("Server does not support the delayed events API","updateDelayedEvent");return yield r.updateScheduledDelayedEventWithActionInBody(e,t,a)})()}_unstable_cancelScheduledDelayedEvent(e){var t=arguments,n=this;return A(function*(){var r=t.length>1&&t[1]!==void 0?t[1]:{};return yield n.updateScheduledDelayedEvent(e,Ls.Cancel,r)})()}_unstable_restartScheduledDelayedEvent(e){var t=arguments,n=this;return A(function*(){var r=t.length>1&&t[1]!==void 0?t[1]:{};return yield n.updateScheduledDelayedEvent(e,Ls.Restart,r)})()}_unstable_sendScheduledDelayedEvent(e){var t=arguments,n=this;return A(function*(){var r=t.length>1&&t[1]!==void 0?t[1]:{};return yield n.updateScheduledDelayedEvent(e,Ls.Send,r)})()}updateScheduledDelayedEvent(e,t){var n=arguments,r=this;return A(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:{};if(!(yield r.doesServerSupportUnstableFeature(bn)))throw new hi("Server does not support the delayed events API","".concat(t,"ScheduledDelayedEvent"));try{var o=he("/delayed_events/$delayId/$action",{$delayId:e,$action:t});return yield r.http.request($.Post,o,void 0,void 0,wt(wt({},a),{},{prefix:"".concat(At.Unstable,"/").concat(bn)}))}catch(c){if(c instanceof Ct&&c.errcode==="M_UNRECOGNIZED")return yield r.updateScheduledDelayedEventWithActionInBody(e,t,a);throw c}})()}updateScheduledDelayedEventWithActionInBody(e,t){var n=arguments,r=this;return A(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:{},o=he("/delayed_events/$delayId",{$delayId:e}),c={action:t};try{return yield r.http.request($.Post,o,void 0,c,wt(wt({},a),{},{prefix:"".concat(At.Unstable,"/").concat(bn)}))}catch(d){if(d instanceof Ct&&d.errcode==="M_MISSING_TOKEN")return yield r.http.authedRequest($.Post,o,void 0,c,wt(wt({},a),{},{prefix:"".concat(At.Unstable,"/").concat(bn)}));throw d}})()}sendReceipt(e,t,n){var r=arguments,a=this;return A(function*(){var o=r.length>3&&r[3]!==void 0?r[3]:!1;if(a.isGuest())return Promise.resolve({});var c=he("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),d=!o&&a.supportsThreads(),h=d?wt(wt({},n),{},{thread_id:pl(e)}):n,v=a.http.authedRequest($.Post,c,void 0,h||{}),m=a.getRoom(e.getRoomId());return m&&a.credentials.userId&&m.addLocalEchoReceipt(a.credentials.userId,e,t,o),v})()}sendReadReceipt(e){var t=arguments,n=this;return A(function*(){var r=t.length>1&&t[1]!==void 0?t[1]:On.Read,a=t.length>2&&t[2]!==void 0?t[2]:!1;if(e){var o=e.getId(),c=n.getRoom(e.getRoomId());if(c!=null&&c.hasPendingEvent(o))throw new Error("Cannot set read receipt to a pending event (".concat(o,")"));return n.sendReceipt(e,r,{},a)}})()}setRoomReadMarkers(e,t,n,r){var a=this;return A(function*(){var o=a.getRoom(e);if(o!=null&&o.hasPendingEvent(t))throw new Error("Cannot set read marker to a pending event (".concat(t,")"));var c;if(n){if(c=n.getId(),o!=null&&o.hasPendingEvent(c))throw new Error("Cannot set read receipt to a pending event (".concat(c,")"));o?.addLocalEchoReceipt(a.credentials.userId,n,On.Read)}var d;if(r){if(d=r.getId(),o!=null&&o.hasPendingEvent(d))throw new Error("Cannot set read receipt to a pending event (".concat(d,")"));o?.addLocalEchoReceipt(a.credentials.userId,r,On.ReadPrivate)}return yield a.setRoomReadMarkersHttpRequest(e,t,c,d)})()}sendRtcDecline(e,t){return this.sendEvent(e,G.RTCDecline,{"m.relates_to":{event_id:t,rel_type:Et.Reference}})}getUrlPreview(e,t){t=Math.floor(t/6e4)*6e4;var n=new URL(e);n.hash="",e=n.toString();var r=t+"_"+e;if(r in this.urlPreviewCache)return this.urlPreviewCache[r];var a=this.http.authedRequest($.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:$o.V3,priority:"low"});return this.urlPreviewCache[r]=a,a}sendTyping(e,t,n){if(this.isGuest())return Promise.resolve({});var r=he("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),a={typing:t};return t&&(a.timeout=n||2e4),this.http.authedRequest($.Put,r,void 0,a)}getRoomUpgradeHistory(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,r=this.getRoom(e);if(!r)return[];var a=this.findPredecessorRooms(r,t,n),o=this.findSuccessorRooms(r,t,n);return[...a,r,...o]}findPredecessorRooms(e,t,n){for(var r,a=[],o=new Set([e.roomId]),c=(r=e.findPredecessor(n))===null||r===void 0?void 0:r.roomId;c!==null;){var d;if(c){if(o.has(c))break;o.add(c)}var h=this.getRoom(c);if(h===null)break;if(t){var v=h.currentState.getStateEvents(G.RoomTombstone,"");if(!v||v.getContent().replacement_room!==e.roomId)break}a.splice(0,0,h),e=h,c=(d=e.findPredecessor(n))===null||d===void 0?void 0:d.roomId}return a}findSuccessorRooms(e,t,n){for(var r=[],a=e.currentState.getStateEvents(G.RoomTombstone,"");a;){var o=this.getRoom(a.getContent().replacement_room);if(!o||o.roomId===e.roomId)break;if(t){var c,d=(c=o.findPredecessor(n))===null||c===void 0?void 0:c.roomId;if(!d||d!==e.roomId)break}r.push(o);var h=new Set(r.map(v=>v.roomId));if(h.size<r.length)return r.slice(0,r.length-1);e=o,a=e.currentState.getStateEvents(G.RoomTombstone,"")}return r}invite(e,t){var n=arguments,r=this;return A(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:{};if(typeof a!="object"&&(a={reason:a}),a.shareEncryptedHistory){var o;yield(o=r.cryptoBackend)===null||o===void 0?void 0:o.shareRoomHistoryWithUser(e,t)}return yield r.membershipChange(e,t,Ne.Invite,a.reason)})()}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}inviteByThreePid(e,t,n){var r=this;return A(function*(){var a,o=he("/rooms/$roomId/invite",{$roomId:e}),c=r.getIdentityServerUrl(!0);if(!c)return Promise.reject(new Ct({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));var d={id_server:c,medium:t,address:n};if((a=r.identityServer)!==null&&a!==void 0&&a.getAccessToken){var h=yield r.identityServer.getAccessToken();h&&(d.id_access_token=h)}return r.http.authedRequest($.Post,o,void 0,d)})()}leave(e){return this.membershipChange(e,void 0,Ne.Leave)}leaveRoomChain(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,n=this.getRoomUpgradeHistory(e,!0),r=n;if(!t){r=[];for(var a of n)if(r.push(a),a.roomId===e)break}var o={},c=[],d=v=>this.leave(v).then(()=>{delete o[v]}).catch(m=>{o[v]=m});for(var h of r)c.push(d(h.roomId));return Promise.all(c).then(()=>o)}ban(e,t,n){return this.membershipChange(e,t,Ne.Ban,n)}forget(e){var t=arguments,n=this;return A(function*(){var r=t.length>1&&t[1]!==void 0?t[1]:!0,a=he("/rooms/$room_id/forget",{$room_id:e}),o=yield n.http.authedRequest($.Post,a);return r&&(n.store.removeRoom(e),n.emit(ye.DeleteRoom,e)),o})()}unban(e,t){var n=he("/rooms/$roomId/unban",{$roomId:e}),r={user_id:t};return this.http.authedRequest($.Post,n,void 0,r)}kick(e,t,n){var r=he("/rooms/$roomId/kick",{$roomId:e}),a={user_id:t,reason:n};return this.http.authedRequest($.Post,r,void 0,a)}membershipChange(e,t,n,r){var a=he("/rooms/$room_id/$membership",{$room_id:e,$membership:n});return this.http.authedRequest($.Post,a,void 0,{user_id:t,reason:r})}getPushActionsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushActions()||t){var{actions:n,rule:r}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(n,r)}return e.getPushActions()}getPushDetailsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushDetails()||t){var{actions:n,rule:r}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(n,r)}return e.getPushDetails()}setProfileInfo(e,t){var n=he("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest($.Put,n,void 0,t)}setDisplayName(e){var t=this;return A(function*(){var n=yield t.setProfileInfo("displayname",{displayname:e}),r=t.getUser(t.getUserId());return r&&(r.displayName=e,r.emit(ci.DisplayName,r.events.presence,r)),n})()}setAvatarUrl(e){var t=this;return A(function*(){var n=yield t.setProfileInfo("avatar_url",{avatar_url:e}),r=t.getUser(t.getUserId());return r&&(r.avatarUrl=e,r.emit(ci.AvatarUrl,r.events.presence,r)),n})()}mxcUrlToHttp(e,t,n,r,a,o,c){return wf(this.baseUrl,e,t,n,r,a,o,c)}setSyncPresence(e){var t=this;return A(function*(){var n;(n=t.syncApi)===null||n===void 0||n.setPresence(e)})()}setPresence(e){var t=this;return A(function*(){var n=he("/presence/$userId/status",{$userId:t.credentials.userId}),r=["offline","online","unavailable"];if(r.indexOf(e.presence)===-1)throw new Error("Bad presence value: "+e.presence);yield t.http.authedRequest($.Put,n,void 0,e)})()}getPresence(e){var t=he("/presence/$userId/status",{$userId:e});return this.http.authedRequest($.Get,t)}scrollback(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:30,n=0,r=this.ongoingScrollbacks[e.roomId]||{};if(r.promise)return r.promise;if(r.errorTs){var a=Date.now()-r.errorTs;n=Math.max(uL-a,0)}if(e.oldState.paginationToken===null)return Promise.resolve(e);var o=this.store.scrollback(e,t).length;if(o===t)return Promise.resolve(e);t=t-o;var c=new Promise((d,h)=>{Iu(n).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,Be.Backward)).then(v=>{var m,y,E=v.chunk.map(this.getEventMapper());if(v.state){var T=v.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(T)}var[S,O,R]=e.partitionThreadedEvents(E);this.processAggregatedTimelineEvents(e,S),e.addEventsToTimeline(S,!0,!0,e.getLiveTimeline()),this.processThreadEvents(e,O,!0),R.forEach(I=>e.relations.aggregateChildEvent(I)),e.oldState.paginationToken=(m=v.end)!==null&&m!==void 0?m:null,v.chunk.length===0&&(e.oldState.paginationToken=null),this.store.storeEvents(e,E,(y=v.end)!==null&&y!==void 0?y:null,!0),delete this.ongoingScrollbacks[e.roomId],d(e)}).catch(v=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},h(v)})});return r={promise:c},this.ongoingScrollbacks[e.roomId]=r,c}getEventMapper(e){return zN(this,e||{})}getEventContext(e,t){var n=this;return A(function*(){var r,a=he("/rooms/$roomId/context/$eventId",{$roomId:e,$eventId:t}),o={limit:"0"};(r=n.clientOpts)!==null&&r!==void 0&&r.lazyLoadMembers&&(o.filter=JSON.stringify(di.LAZY_LOADING_MESSAGES_FILTER));var c=yield n.http.authedRequest($.Get,a,o);if(c.event){var d,h,v;return{start:c.start,end:c.end,event:c.event,events_after:(d=c.events_after)!==null&&d!==void 0?d:[],events_before:(h=c.events_before)!==null&&h!==void 0?h:[],state:(v=c.state)!==null&&v!==void 0?v:[]}}throw new Error("'event' not in '/context' result - homeserver too old?")})()}getEventTimeline(e,t){var n=this;return A(function*(){var r,a,o;if(!n.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!(e!=null&&e.room))throw new Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&n.supportsThreads()){var c;return(c=yield n.getThreadTimeline(e,t))!==null&&c!==void 0?c:null}var d=yield n.getEventContext(e.room.roomId,t);if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);var h=n.getEventMapper(),v=h(d.event);if(v.isRelation(mt.name))return n.logger.warn("Tried loading a regular timeline at the position of a thread event"),null;var m=[...d.events_after.reverse().map(h),v,...d.events_before.map(h)],y=e.getTimelineForEvent(m[0].getId());if(y)y.getState(me.BACKWARDS).setUnknownStateEvents(d.state.map(h));else{var E;y=e.addTimeline(),y.initialiseState(d.state.map(h)),y.getState(me.FORWARDS).paginationToken=(E=d.end)!==null&&E!==void 0?E:null}var[T,S,O]=e.room.partitionThreadedEvents(m);return e.addEventsToTimeline(T,!0,!1,y,d.start),n.processThreadEvents(e.room,S,!0),n.processAggregatedTimelineEvents(e.room,T),O.forEach(R=>e.relations.aggregateChildEvent(R)),(r=(a=e.getTimelineForEvent(t))!==null&&a!==void 0?a:(o=e.room.findThreadForEvent(v))===null||o===void 0?void 0:o.liveTimeline)!==null&&r!==void 0?r:y})()}getThreadTimeline(e,t){var n=this;return A(function*(){if(!n.supportsThreads())throw new Error("could not get thread timeline: no client support");if(!e.room)throw new Error("could not get thread timeline: not a room timeline");if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var r=yield n.getEventContext(e.room.roomId,t),a=n.getEventMapper(),o=a(r.event);if(e.canContain(o)){var c=n.canSupport.get(nn.RelationsRecursion)!==tn.Unsupported;if(_t.hasServerSideSupport)if(_t.hasServerSideFwdPaginationSupport){var d,h,v;if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var m=e.thread,y=yield n.fetchRelations(e.room.roomId,m.id,null,null,{dir:Be.Backward,from:r.start,recurse:c||void 0}),E=yield n.fetchRelations(e.room.roomId,m.id,null,null,{dir:Be.Forward,from:r.end,recurse:c||void 0}),T=[...E.chunk.reverse().filter(Dp(m.id)).map(a),o,...y.chunk.filter(Dp(m.id)).map(a)];for(var S of T){var O;yield(O=e.thread)===null||O===void 0?void 0:O.processEvent(S)}var R=e.getTimelineForEvent(o.getId());if(R?R.getState(me.BACKWARDS).setUnknownStateEvents(r.state.map(a)):(R=e.addTimeline(),R.initialiseState(r.state.map(a))),e.addEventsToTimeline(T,!0,!1,R,E.next_batch),!y.next_batch){var I=yield n.fetchRoomEvent(e.room.roomId,m.id);e.addEventsToTimeline([a(I)],!0,!1,R,null)}return R.setPaginationToken((d=y.next_batch)!==null&&d!==void 0?d:null,Be.Backward),R.setPaginationToken((h=E.next_batch)!==null&&h!==void 0?h:null,Be.Forward),n.processAggregatedTimelineEvents(e.room,T),(v=e.getTimelineForEvent(t))!==null&&v!==void 0?v:R}else{for(var M,C=e.thread,k=yield n.fetchRelations(e.room.roomId,C.id,mt.name,null,{dir:Be.Backward,from:r.start,recurse:c||void 0}),_=[],P=r.end;P;){var x=yield n.fetchRelations(e.room.roomId,C.id,mt.name,null,{dir:Be.Forward,from:P,recurse:c||void 0});P=x.next_batch,_.push(...x.chunk)}var U=[..._.reverse().map(a),o,...k.chunk.map(a)];for(var j of U){var K;yield(K=e.thread)===null||K===void 0?void 0:K.processEvent(j)}var Z=e.getLiveTimeline();if(Z.getState(me.BACKWARDS).setUnknownStateEvents(r.state.map(a)),e.addEventsToTimeline(U,!0,!1,Z,null),!k.next_batch){var be=yield n.fetchRoomEvent(e.room.roomId,C.id);e.addEventsToTimeline([a(be)],!0,!1,Z,null)}return Z.setPaginationToken((M=k.next_batch)!==null&&M!==void 0?M:null,Be.Backward),Z.setPaginationToken(null,Be.Forward),n.processAggregatedTimelineEvents(e.room,U),Z}}})()}getLatestTimeline(e){var t=this;return A(function*(){if(!t.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw new Error("getLatestTimeline only supports room timelines");var n;if(e.threadListType!==null){var r,a=yield t.createThreadListMessagesRequest(e.room.roomId,null,1,Be.Backward,e.threadListType,e.getFilter());n=(r=a.chunk)===null||r===void 0?void 0:r[0]}else if(e.thread&&_t.hasServerSideSupport){var o,c=t.canSupport.get(nn.RelationsRecursion)!==tn.Unsupported,d=yield t.fetchRelations(e.room.roomId,e.thread.id,mt.name,null,{dir:Be.Backward,limit:1,recurse:c||void 0});n=(o=d.chunk)===null||o===void 0?void 0:o[0]}else{var h,v,m=he("/rooms/$roomId/messages",{$roomId:e.room.roomId}),y={dir:"b"};(h=t.clientOpts)!==null&&h!==void 0&&h.lazyLoadMembers&&(y.filter=JSON.stringify(di.LAZY_LOADING_MESSAGES_FILTER));var E=yield t.http.authedRequest($.Get,m,y);n=(v=E.chunk)===null||v===void 0?void 0:v[0]}if(!n)throw new Error("No message returned when trying to construct getLatestTimeline");return t.getEventTimeline(e,n.event_id)})()}createMessagesRequest(e,t){var n,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,a=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0,c=he("/rooms/$roomId/messages",{$roomId:e}),d={limit:r.toString(),dir:a};t&&(d.from=t);var h=null;if((n=this.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(h=Object.assign({},di.LAZY_LOADING_MESSAGES_FILTER)),o){var v;h=h||{},Object.assign(h,(v=o.getRoomTimelineFilterComponent())===null||v===void 0?void 0:v.toJSON())}return h&&(d.filter=JSON.stringify(h)),this.http.authedRequest($.Get,c,d)}createThreadListMessagesRequest(e,t){var n,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:Be.Backward,o=arguments.length>4&&arguments[4]!==void 0?arguments[4]:Ui.All,c=arguments.length>5?arguments[5]:void 0,d=he("/rooms/$roomId/threads",{$roomId:e}),h={limit:r.toString(),dir:a,include:eI(o)};t&&(h.from=t);var v={};if((n=this.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(v=wt({},di.LAZY_LOADING_MESSAGES_FILTER)),c){var m;v=wt(wt({},v),(m=c.getRoomTimelineFilterComponent())===null||m===void 0?void 0:m.toJSON())}Object.keys(v).length&&(h.filter=JSON.stringify(v));var y={prefix:_t.hasServerSideListSupport===Rn.Stable?At.V1:"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest($.Get,d,h,void 0,y).then(E=>{var T;return wt(wt({},E),{},{chunk:(T=E.chunk)===null||T===void 0?void 0:T.reverse(),start:E.prev_batch,end:E.next_batch})})}paginateEventTimeline(e,t){var n=this,r=e.getTimelineSet()===this.notifTimelineSet,a=this.getRoom(e.getRoomId()),o=e.getTimelineSet().threadListType,c=e.getTimelineSet().thread;t=t||{};var d=t.backwards||!1;if(r&&!d)throw new Error("paginateNotifTimeline can only paginate backwards");var h=d?me.BACKWARDS:me.FORWARDS,v=e.getPaginationToken(h),m=e.paginationRequests[h];if(m)return m;var y,E,T;if(r){var S;y="/notifications",E={limit:((S=t.limit)!==null&&S!==void 0?S:30).toString(),only:"highlight"},v&&v!=="end"&&(E.from=v),T=this.http.authedRequest($.Get,y,E).then((function(){var C=A(function*(k){var _=k.next_token,P=[];k.notifications=k.notifications.filter(ji);for(var x=0;x<k.notifications.length;x++){var U=k.notifications[x],j=n.getEventMapper()(U.event);n.getPushDetailsForEvent(j,!0),j.event.room_id=U.room_id,P[x]=j}var K=e.getTimelineSet();return K.addEventsToTimeline(P,d,!1,e,_),n.processAggregatedTimelineEvents(K.room,P),d&&!k.next_token&&e.setPaginationToken(null,h),!!k.next_token});return function(k){return C.apply(this,arguments)}})()).finally(()=>{e.paginationRequests[h]=null}),e.paginationRequests[h]=T}else if(o!==null){if(!a)throw new Error("Unknown room "+e.getRoomId());if(!_t.hasServerSideFwdPaginationSupport&&h===Be.Forward)throw new Error("Cannot paginate threads forwards without server-side support for MSC 3715");T=this.createThreadListMessagesRequest(e.getRoomId(),v,t.limit,h,o,e.getFilter()).then(C=>{if(C.state){var k=e.getState(h),_=C.state.filter(ji).map(this.getEventMapper());k.setUnknownStateEvents(_)}var P=C.end,x=C.chunk.filter(ji).map(this.getEventMapper()),U=e.getTimelineSet();return U.addEventsToTimeline(x,d,!1,e,P),this.processAggregatedTimelineEvents(a,x),this.processThreadRoots(a,x,d),d&&C.end==C.start&&e.setPaginationToken(null,h),C.end!==C.start}).finally(()=>{e.paginationRequests[h]=null}),e.paginationRequests[h]=T}else if(c){var O,R,I=this.getRoom((O=e.getRoomId())!==null&&O!==void 0?O:void 0);if(!I)throw new Error("Unknown room "+e.getRoomId());var M=this.canSupport.get(nn.RelationsRecursion)!==tn.Unsupported;T=this.fetchRelations((R=e.getRoomId())!==null&&R!==void 0?R:"",c.id,null,null,{dir:h,limit:t.limit,from:v??void 0,recurse:M||void 0}).then((function(){var C=A(function*(k){var _=n.getEventMapper(),P=k.chunk.filter(ji).filter(Dp(c.id)).map(_);for(var x of P.slice().reverse()){yield c?.processEvent(x);var U=x.getSender();(!d||c?.getEventReadUpTo(U)===null)&&I.addLocalEchoReceipt(U,x,On.Read)}var j=k.next_batch,K=e.getTimelineSet();if(K.addEventsToTimeline(P,d,!1,e,j??null),!j&&d){var Z,be,Pe=(Z=c.rootEvent)!==null&&Z!==void 0?Z:_(yield n.fetchRoomEvent((be=e.getRoomId())!==null&&be!==void 0?be:"",c.id));K.addEventsToTimeline([Pe],!0,!1,e,null)}return n.processAggregatedTimelineEvents(K.room,P),d&&!j&&e.setPaginationToken(null,h),!!j});return function(k){return C.apply(this,arguments)}})()).finally(()=>{e.paginationRequests[h]=null}),e.paginationRequests[h]=T}else{if(!a)throw new Error("Unknown room "+e.getRoomId());T=this.createMessagesRequest(e.getRoomId(),v,t.limit,h,e.getFilter()).then(C=>{if(C.state){var k=e.getState(h),_=C.state.filter(ji).map(this.getEventMapper());k.setUnknownStateEvents(_)}var P=C.end,x=C.chunk.filter(ji).map(this.getEventMapper()),U=e.getTimelineSet(),[j,,K]=a.partitionThreadedEvents(x);U.addEventsToTimeline(j,d,!1,e,P),this.processAggregatedTimelineEvents(a,j),this.processThreadRoots(a,j.filter(be=>be.getServerAggregatedRelation(mt.name)),!1),K.forEach(be=>a.relations.aggregateChildEvent(be));var Z=C.end===void 0||C.end===C.start;return d&&Z&&e.setPaginationToken(null,h),!Z}).finally(()=>{e.paginationRequests[h]=null}),e.paginationRequests[h]=T}return T}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20;return(t=this.peekSync)===null||t===void 0||t.stopPeeking(),this.peekSync=new La(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e,n)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){var n=this.sendStateEvent(e,G.RoomGuestAccess,{guest_access:t.allowJoin?Zh.CanJoin:Zh.Forbidden},""),r=Promise.resolve();return t.allowRead&&(r=this.sendStateEvent(e,G.RoomHistoryVisibility,{history_visibility:ab.WorldReadable},"")),Promise.all([r,n]).then()}requestRegisterEmailToken(e,t,n,r){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:r})}requestRegisterMsisdnToken(e,t,n,r,a){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:r,next_link:a})}requestAdd3pidEmailToken(e,t,n,r){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:r})}requestAdd3pidMsisdnToken(e,t,n,r,a){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:r,next_link:a})}requestPasswordEmailToken(e,t,n,r){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:r})}requestPasswordMsisdnToken(e,t,n,r,a){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:r,next_link:a})}requestTokenFromEndpoint(e,t){var n=this;return A(function*(){var r=Object.assign({},t);return n.http.request($.Post,e,void 0,r)})()}getRoomPushRule(e,t){if(this.pushRules){var n;return(n=this.pushRules[e])===null||n===void 0||(n=n.room)===null||n===void 0?void 0:n.find(r=>r.rule_id===t)}else throw new Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,n){var r,a=!1,o=this.getRoomPushRule(e,t);if(o!=null&&o.actions.includes(ja.DontNotify)&&(a=!0),!n)a&&(r=this.deletePushRule(e,un.RoomSpecific,o.rule_id));else if(!o)r=this.addPushRule(e,un.RoomSpecific,t,{actions:[ja.DontNotify]});else if(!a){var c=Promise.withResolvers();this.deletePushRule(e,un.RoomSpecific,o.rule_id).then(()=>{this.addPushRule(e,un.RoomSpecific,t,{actions:[ja.DontNotify]}).then(()=>{c.resolve()}).catch(d=>{c.reject(d)})}).catch(d=>{c.reject(d)}),r=c.promise}if(r)return new Promise((d,h)=>{r.then(()=>{this.getPushRules().then(v=>{this.pushRules=v,d()}).catch(v=>{h(v)})}).catch(v=>{this.getPushRules().then(m=>{this.pushRules=m,h(v)}).catch(m=>{h(v)})})})}searchMessageText(e){var t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){var t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:Mw.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},n={_query:t,results:[],highlights:[]};return this.search({body:t}).then(r=>this.processRoomEventsSearch(n,r))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;var t={body:e._query,next_batch:e.next_batch},n=this.search(t,e.abortSignal).then(r=>this.processRoomEventsSearch(e,r)).finally(()=>{e.pendingRequest=void 0});return e.pendingRequest=n,n}processRoomEventsSearch(e,t){var n,r,a=t.search_categories.room_events;e.count=a.count,e.next_batch=a.next_batch;var o=new Set(a.highlights);e.highlights.forEach(E=>{o.add(E)}),e.highlights=Array.from(o);for(var c=this.getEventMapper(),d=(n=(r=a.results)===null||r===void 0?void 0:r.length)!==null&&n!==void 0?n:0,h=0;h<d;h++){var v=Nf.fromJson(a.results[h],c),m=this.getRoom(v.context.getEvent().getRoomId());if(m)for(var y of v.context.getTimeline())y.setMetadata(m.currentState,!1);e.results.push(v)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;var e=new La(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(()=>{this.logger.debug("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=void 0}),this.syncLeftRoomsPromise}createFilter(e){var t=he("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest($.Post,t,void 0,e).then(n=>{var r=di.fromJson(this.credentials.userId,n.filter_id,e);return this.store.storeFilter(r),r})}getFilter(e,t,n){if(n){var r=this.store.getFilter(e,t);if(r)return Promise.resolve(r)}var a=he("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest($.Get,a).then(o=>{var c=di.fromJson(e,t,o);return this.store.storeFilter(c),c})}getOrCreateFilter(e,t){var n=this;return A(function*(){var r=n.store.getFilterIdByName(e),a;if(r){try{var o=yield n.getFilter(n.credentials.userId,r,!0);if(o){var c=o.getDefinition(),d=t.getDefinition();cl(c,d)&&(a=r)}}catch(v){if(v.errcode!=="M_UNKNOWN"&&v.errcode!=="M_NOT_FOUND")throw v}a||n.store.setFilterIdByName(e,void 0)}if(a)return a;var h=yield n.createFilter(t.getDefinition());return n.store.setFilterIdByName(e,h.filterId),h.filterId})()}getOpenIdToken(){var e=he("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest($.Post,e,void 0,{})}turnServer(){return this.http.authedRequest($.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return this.checkTurnServersIntervalID!==void 0}checkTurnServers(){var e=this;return A(function*(){if(e.supportsVoip()){var t=!1,n=e.turnServersExpiry-Date.now();if(n>PC)e.logger.debug("TURN creds are valid for another "+n+" ms: not fetching new ones."),t=!0;else{e.logger.debug("Fetching new TURN credentials");try{var r=yield e.turnServer();if(r.uris){e.logger.debug("Got TURN URIs: "+r.uris+" refresh in "+r.ttl+" secs");var a={urls:r.uris,username:r.username,credential:r.password};e.turnServers=[a],e.turnServersExpiry=Date.now()+r.ttl*1e3,t=!0,e.emit(ye.TurnServers,e.turnServers)}}catch(o){e.logger.error("Failed to get TURN URIs",o),o.httpStatus===403?(e.logger.info("TURN access unavailable for this account: stopping credentials checks"),e.checkTurnServersIntervalID!==null&&globalThis.clearInterval(e.checkTurnServersIntervalID),e.checkTurnServersIntervalID=void 0,e.emit(ye.TurnServersError,o,!0)):e.emit(ye.TurnServersError,o,!1)}}return t}})()}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){var e=he("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest($.Get,e,void 0,void 0,{prefix:""}).then(t=>t.admin)}whoisSynapseUser(e){var t=he("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest($.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){var t=he("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest($.Post,t,void 0,void 0,{prefix:""})}fetchClientWellKnown(){var e=this;return A(function*(){var t;e.clientWellKnownPromise=De.getRawClientConfig((t=e.getDomain())!==null&&t!==void 0?t:void 0),e.clientWellKnown=yield e.clientWellKnownPromise,e.emit(ye.ClientWellKnown,e.clientWellKnown)})()}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw new Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){var e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(n=>{var[r,a]=n;return e.includes(typeof a)}).reduce((n,r)=>{var[a,o]=r;return n[a]=o,n},{});return this.store.storeClientOptions(t)}_unstable_getSharedRooms(e){var t=this;return A(function*(){var n=yield t.doesServerSupportUnstableFeature(Jw),r=yield t.doesServerSupportUnstableFeature(Yw),a=yield t.doesServerSupportUnstableFeature($w);if(!n&&!r&&!a)throw Error("Server does not support the Mutual Rooms API");var o,c;a?(o="/uk.half-shot.msc2666/user/mutual_rooms",c={user_id:e}):(o=he("/uk.half-shot.msc2666/user/".concat(r?"mutual_rooms":"shared_rooms","/$userId"),{$userId:e}),c={});var d=[],h=null;do{var v={};h!=null&&a&&(v.batch_token=h);var m=yield t.http.authedRequest($.Get,o,wt(wt({},c),v),void 0,{prefix:At.Unstable});d.push(...m.joined),m.next_batch_token!==void 0?h=m.next_batch_token:h=null}while(h!=null);return d})()}_unstable_getRTCTransports(){var e=this;return A(function*(){return(yield e.http.authedRequest($.Get,"/rtc/transports",void 0,void 0,{prefix:"".concat(At.Unstable,"/org.matrix.msc4143")})).rtc_transports})()}getVersions(){var e=this;return A(function*(){if(e.serverVersionsPromise)return e.serverVersionsPromise;e.serverVersionsPromise=e.http.authedRequest($.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(n=>{throw e.serverVersionsPromise=void 0,n});var t=yield e.serverVersionsPromise;return e.canSupport=yield G1(t),e.serverVersionsPromise})()}isVersionSupported(e){var t=this;return A(function*(){var{versions:n}=yield t.getVersions();return n&&n.includes(e)})()}doesServerSupportUnstableFeature(e){var t=this;return A(function*(){var n=yield t.getVersions();if(!n)return!1;var r=n.unstable_features;return r&&!!r[e]})()}doesServerForceEncryptionForPreset(e){var t=this;return A(function*(){var n=yield t.getVersions();if(!n)return!1;var r=n.unstable_features,a=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return r&&!!r["io.element.e2ee_forced.".concat(a)]})()}doesServerSupportThread(){var e=this;return A(function*(){if(yield e.isVersionSupported("v1.4"))return{threads:Rn.Stable,list:Rn.Stable,fwdPagination:Rn.Stable};try{var[t,n,r,a,o,c]=yield Promise.all([e.doesServerSupportUnstableFeature("org.matrix.msc3440"),e.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3856"),e.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3715"),e.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:Ch(n,t),list:Ch(a,r),fwdPagination:Ch(c,o)}}catch{return{threads:Rn.None,list:Rn.None,fwdPagination:Rn.None}}})()}hasLazyLoadMembersEnabled(){var e;return!!((e=this.clientOpts)!==null&&e!==void 0&&e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}relations(e,t,n,r){var a=arguments,o=this;return A(function*(){var c,d,h=a.length>4&&a[4]!==void 0?a[4]:{dir:Be.Backward},v=r?o.getEncryptedIfNeededEventType(e,r):null,[m,y]=yield Promise.all([o.fetchRoomEvent(e,t),o.fetchRelations(e,t,n,v,h)]),E=o.getEventMapper(),T=m?E(m):void 0,S=y.chunk.map(E);if(v===G.RoomMessageEncrypted){var O=T?S.concat(T):S;yield Promise.all(O.map(R=>o.decryptEventIfNeeded(R))),r!==null&&(S=S.filter(R=>R.getType()===r))}return T&&n===Et.Replace&&(S=S.filter(R=>R.getSender()===T.getSender())),{originalEvent:T??null,events:S,nextBatch:(c=y.next_batch)!==null&&c!==void 0?c:null,prevBatch:(d=y.prev_batch)!==null&&d!==void 0?d:null}})()}generateClientSecret(){return Fa(32)}decryptEventIfNeeded(e,t){return e.isState()&&!this.enableEncryptedStateEvents?Promise.resolve():(e.shouldAttemptDecryption()&&this.getCrypto()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve())}termsUrlForService(e,t){switch(e){case jg.IS:return this.http.getUrl("/terms",void 0,Nr.V2,t);case jg.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(){var e,t,n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return n&&((e=this.idBaseUrl)!==null&&e!==void 0&&e.startsWith("http://")||(t=this.idBaseUrl)!==null&&t!==void 0&&t.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=yp(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){var e;return(e=this.http.opts.refreshToken)!==null&&e!==void 0?e:null}setAccessToken(e){this.http.opts.accessToken=e,this.serverVersionsPromise=void 0}isLoggedIn(){return this.http.opts.accessToken!==void 0}makeTxnId(){return"m"+new Date().getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest($.Get,"/register/available",{username:e}).then(t=>t.available).catch(t=>t.errcode==="M_USER_IN_USE"?!1:Promise.reject(t))}register(e,t,n,r,a,o,c){n&&(r.session=n);var d={auth:r,refresh_token:!0};return e!=null&&(d.username=e),t!=null&&(d.password=t),o!=null&&(d.guest_access_token=o),c!=null&&(d.inhibit_login=c),this.registerRequest(d)}registerGuest(){var{body:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.registerRequest(e||{},"guest")}registerRequest(e,t){var n={};return t&&(n.kind=t),this.http.request($.Post,"/register",n,e)}refreshToken(e){var t=n=>this.http.authedRequest($.Post,"/refresh",void 0,{refresh_token:e},{prefix:n,inhibitLogoutEmit:!0});return t(At.V3).catch(n=>{if(n.errcode==="M_UNRECOGNIZED")return t(At.V1);throw n})}loginFlows(){return this.http.request($.Get,"/login")}login(e,t){return this.loginRequest(wt(wt({},t),{},{type:e})).then(n=>(n.access_token&&n.user_id&&(this.http.opts.accessToken=n.access_token,this.credentials={userId:n.user_id}),n))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"sso",n=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,a="/login/"+t+"/redirect";n&&(a+="/"+n);var o={redirectUrl:e,[AC.stable]:r,[AC.unstable]:r};return this.http.getUrl(a,o).href}loginWithToken(e){return this.login("m.login.token",{token:e})}loginRequest(e){var t=this;return A(function*(){return yield t.http.authedRequest($.Post,"/login",void 0,e)})()}logout(){var e=arguments,t=this;return A(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:!1;return n&&(t.stopClient(),t.http.abort()),t.http.authedRequest($.Post,"/logout")})()}deactivateAccount(e,t){var n={};return e&&(n.auth=e),t!==void 0&&(n.erase=t),this.http.authedRequest($.Post,"/account/deactivate",void 0,n)}requestLoginToken(e){var t=this;return A(function*(){var n={auth:e};return t.http.authedRequest($.Post,"/login/get_token",void 0,n,{prefix:At.V1})})()}getFallbackAuthUrl(e,t){var n=he("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(n,{session:t}).href}createRoom(e){var t=this;return A(function*(){var n,r=(e.invite_3pid||[]).filter(c=>!c.id_access_token);if(r.length>0&&(n=t.identityServer)!==null&&n!==void 0&&n.getAccessToken){var a=yield t.identityServer.getAccessToken();if(a)for(var o of r)o.id_access_token=a}return t.http.authedRequest($.Post,"/createRoom",void 0,e)})()}fetchRelations(e,t,n,r){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{dir:Be.Backward},o=a;_t.hasServerSideFwdPaginationSupport===Rn.Experimental&&(o=e_("dir","org.matrix.msc3715.dir",o)),this.canSupport.get(nn.RelationsRecursion)===tn.Unstable&&(o=e_("recurse","org.matrix.msc3981.recurse",o));var c=vg(o),d="/rooms/$roomId/relations/$eventId";n!==null?(d+="/$relationType",r!==null&&(d+="/$eventType")):r!==null&&(this.logger.warn("eventType: ".concat(r,` ignored when fetching
            relations as relationType is null`)),r=null);var h=he(d+"?"+c,{$roomId:e,$eventId:t,$relationType:n,$eventType:r});return this.http.authedRequest($.Get,h,void 0,void 0,{prefix:At.V1})}roomState(e){var t=he("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest($.Get,t)}fetchRoomEvent(e,t){var n=he("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest($.Get,n)}members(e,t,n,r){var a={};t&&(a.membership=t),n&&(a.not_membership=n),r&&(a.at=r);var o=vg(a),c=he("/rooms/$roomId/members?"+o,{$roomId:e});return this.http.authedRequest($.Get,c)}upgradeRoom(e,t,n){var r=he("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest($.Post,r,void 0,{new_version:t,additional_creators:n})}getStateEvent(e,t,n){var r={$roomId:e,$eventType:t,$stateKey:n},a=he("/rooms/$roomId/state/$eventType",r);return n!==void 0&&(a=he(a+"/$stateKey",r)),this.http.authedRequest($.Get,a)}sendStateEvent(e,t,n){var r=arguments,a=this;return A(function*(){var o=r.length>3&&r[3]!==void 0?r[3]:"",c=r.length>4&&r[4]!==void 0?r[4]:{},d=a.getRoom(e),h=new Sn({room_id:e,type:t,state_key:o,content:n});yield a.encryptStateEventIfNeeded(h,d??void 0);var v={$roomId:e,$eventType:h.getWireType(),$stateKey:h.getWireStateKey()},m=he("/rooms/$roomId/state/$eventType",v);return o!==void 0&&(m=he(m+"/$stateKey",v)),a.http.authedRequest($.Put,m,void 0,h.getWireContent(),c)})()}encryptStateEventIfNeeded(e,t){var n=this;return A(function*(){if(n.enableEncryptedStateEvents&&t&&!(!n.cryptoBackend&&n.usingExternalCrypto)){if(!n.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");(yield n.shouldEncryptEventForRoom(e,t))&&(yield n.cryptoBackend.isStateEncryptionEnabledInRoom(t.roomId))&&(["m.room.create","m.room.member","m.room.join_rules","m.room.power_levels","m.room.third_party_invite","m.room.history_visibility","m.room.guest_access","m.room.encryption"].includes(e.getType())||(yield n.cryptoBackend.encryptEvent(e,t)))}})()}roomInitialSync(e,t){var n,r=he("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest($.Get,r,{limit:(n=t?.toString())!==null&&n!==void 0?n:"30"})}setRoomReadMarkersHttpRequest(e,t,n,r){var a=this;return A(function*(){var o=he("/rooms/$roomId/read_markers",{$roomId:e}),c={[On.FullyRead]:t,[On.Read]:n};return((yield a.doesServerSupportUnstableFeature("org.matrix.msc2285.stable"))||(yield a.isVersionSupported("v1.4")))&&(c[On.ReadPrivate]=r),a.http.authedRequest($.Post,o,void 0,c)})()}getJoinedRooms(){var e=he("/joined_rooms",{});return this.http.authedRequest($.Get,e)}getJoinedRoomMembers(e){var t=he("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest($.Get,t)}publicRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{server:t,limit:n,since:r}=e,a=e1(e,cL);if(Object.keys(a).length===0){var o={server:t,limit:n,since:r};return this.http.authedRequest($.Get,"/publicRooms",o)}else{var c={server:t},d=wt({limit:n,since:r},a);return this.http.authedRequest($.Post,"/publicRooms",c,d)}}createAlias(e,t){var n=he("/directory/room/$alias",{$alias:e}),r={room_id:t};return this.http.authedRequest($.Put,n,void 0,r)}deleteAlias(e){var t=he("/directory/room/$alias",{$alias:e});return this.http.authedRequest($.Delete,t)}getLocalAliases(e){var t=he("/rooms/$roomId/aliases",{$roomId:e}),n=At.V3;return this.http.authedRequest($.Get,t,void 0,void 0,{prefix:n})}getRoomIdForAlias(e){var t=he("/directory/room/$alias",{$alias:e});return this.http.authedRequest($.Get,t)}getRoomDirectoryVisibility(e){var t=he("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest($.Get,t)}setRoomDirectoryVisibility(e,t){var n=he("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest($.Put,n,void 0,{visibility:t})}searchUserDirectory(e){var{term:t,limit:n}=e,r={search_term:t};return n!==void 0&&(r.limit=n),this.http.authedRequest($.Post,"/user_directory/search",void 0,r)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){var n=t?he("/profile/$userId/$info",{$userId:e,$info:t}):he("/profile/$userId",{$userId:e});return this.http.authedRequest($.Get,n)}doesServerSupportExtendedProfiles(){var e=this;return A(function*(){return(yield e.isVersionSupported("v1.16"))||(yield e.doesServerSupportUnstableFeature(Xw))||(yield e.doesServerSupportUnstableFeature(Qw))})()}getExtendedProfileRequestPrefix(){var e=this;return A(function*(){return(yield e.isVersionSupported("v1.16"))||(yield e.doesServerSupportUnstableFeature("uk.tcpip.msc4133.stable"))?At.V3:"/_matrix/client/unstable/uk.tcpip.msc4133"})()}getExtendedProfile(e){var t=this;return A(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");return t.http.authedRequest($.Get,he("/profile/$userId",{$userId:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getExtendedProfileProperty(e,t){var n=this;return A(function*(){if(!(yield n.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=yield n.http.authedRequest($.Get,he("/profile/$userId/$key",{$userId:e,$key:t}),void 0,void 0,{prefix:yield n.getExtendedProfileRequestPrefix()});return r[t]})()}setExtendedProfileProperty(e,t){var n=this;return A(function*(){if(!(yield n.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=n.getUserId();yield n.http.authedRequest($.Put,he("/profile/$userId/$key",{$userId:r,$key:e}),void 0,{[e]:t},{prefix:yield n.getExtendedProfileRequestPrefix()})})()}deleteExtendedProfileProperty(e){var t=this;return A(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=t.getUserId();yield t.http.authedRequest($.Delete,he("/profile/$userId/$key",{$userId:n,$key:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}patchExtendedProfile(e){var t=this;return A(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=t.getUserId();return t.http.authedRequest($.Patch,he("/profile/$userId",{$userId:n}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}setExtendedProfile(e){var t=this;return A(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=t.getUserId();yield t.http.authedRequest($.Put,he("/profile/$userId",{$userId:n}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getThreePids(){return this.http.authedRequest($.Get,"/account/3pid")}addThreePidOnly(e){var t=this;return A(function*(){var n="/account/3pid/add";return t.http.authedRequest($.Post,n,void 0,e)})()}bindThreePid(e){var t=this;return A(function*(){var n="/account/3pid/bind";return t.http.authedRequest($.Post,n,void 0,e)})()}unbindThreePid(e,t){var n=this;return A(function*(){var r="/account/3pid/unbind",a={medium:e,address:t,id_server:n.getIdentityServerUrl(!0)};return n.http.authedRequest($.Post,r,void 0,a)})()}deleteThreePid(e,t){var n="/account/3pid/delete";return this.http.authedRequest($.Post,n,void 0,{medium:e,address:t})}setPassword(e,t,n){var r="/account/password",a={auth:e,new_password:t,logout_devices:n};return this.http.authedRequest($.Post,r,void 0,a)}getDevices(){return this.http.authedRequest($.Get,"/devices")}getDevice(e){var t=he("/devices/$device_id",{$device_id:e});return this.http.authedRequest($.Get,t)}setDeviceDetails(e,t){var n=he("/devices/$device_id",{$device_id:e});return this.http.authedRequest($.Put,n,void 0,t)}deleteDevice(e,t){var n=he("/devices/$device_id",{$device_id:e}),r={};return t&&(r.auth=t),this.http.authedRequest($.Delete,n,void 0,r)}deleteMultipleDevices(e,t){var n={devices:e};t&&(n.auth=t);var r="/delete_devices";return this.http.authedRequest($.Post,r,void 0,n)}getPushers(){var e=this;return A(function*(){var t=yield e.http.authedRequest($.Get,"/pushers");return(yield e.doesServerSupportUnstableFeature("org.matrix.msc3881"))||(t.pushers=t.pushers.map(n=>(n.hasOwnProperty(Rg.name)||(n[Rg.name]=!0),n))),t})()}setPusher(e){var t="/pushers/set";return this.http.authedRequest($.Post,t,void 0,e)}removePusher(e,t){var n="/pushers/set",r={pushkey:e,app_id:t,kind:null};return this.http.authedRequest($.Post,n,void 0,r)}setLocalNotificationSettings(e,t){var n="".concat(xk.name,".").concat(e);return this.setAccountData(n,t)}getPushRules(){return this.http.authedRequest($.Get,"/pushrules/").then(e=>(this.setPushRules(e),this.pushRules))}setPushRules(e){this.pushRules=Bi.rewriteDefaultRules(this.logger,e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,n,r){var a=he("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest($.Put,a,void 0,r)}deletePushRule(e,t,n){var r=he("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest($.Delete,r)}setPushRuleEnabled(e,t,n,r){var a=he("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:n});return this.http.authedRequest($.Put,a,void 0,{enabled:r})}setPushRuleActions(e,t,n,r){var a=he("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:n});return this.http.authedRequest($.Put,a,void 0,{actions:r})}search(e,t){var{body:n,next_batch:r}=e,a={};return r&&(a.next_batch=r),this.http.authedRequest($.Post,"/search",a,n,{abortSignal:t})}uploadKeysRequest(e,t){return this.http.authedRequest($.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest($.Post,"/keys/signatures/upload",void 0,e)}downloadKeysForUsers(e){var{token:t}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n={device_keys:{}};return t!==void 0&&(n.token=t),e.forEach(r=>{n.device_keys[r]=[]}),this.http.authedRequest($.Post,"/keys/query",void 0,n)}claimOneTimeKeys(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"signed_curve25519",n=arguments.length>2?arguments[2]:void 0,r={};t===void 0&&(t="signed_curve25519");for(var[a,o]of e){var c=r[a]||{};Gh(r,a,c),Gh(c,o,t)}var d={one_time_keys:r};n&&(d.timeout=n);var h="/keys/claim";return this.http.authedRequest($.Post,h,void 0,d)}getKeyChanges(e,t){var n={from:e,to:t};return this.http.authedRequest($.Get,"/keys/changes",n)}uploadDeviceSigningKeys(e,t){var n=Object.assign({},t);return e&&Object.assign(n,{auth:e}),this.http.authedRequest($.Post,"/keys/device_signing/upload",void 0,n,{prefix:At.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");var t=this.http.getUrl("/account/register",void 0,Nr.V2,this.idBaseUrl);return this.http.requestOtherUrl($.Post,t,e)}requestEmailToken(e,t,n,r,a){var o={client_secret:t,email:e,send_attempt:n?.toString()};return r&&(o.next_link=r),this.http.idServerRequest($.Post,"/validate/email/requestToken",o,Nr.V2,a)}requestMsisdnToken(e,t,n,r,a,o){var c={client_secret:n,country:e,phone_number:t,send_attempt:r?.toString()};return a&&(c.next_link=a),this.http.idServerRequest($.Post,"/validate/msisdn/requestToken",c,Nr.V2,o)}submitMsisdnToken(e,t,n,r){var a={sid:e,client_secret:t,token:n};return this.http.idServerRequest($.Post,"/validate/msisdn/submitToken",a,Nr.V2,r??void 0)}submitMsisdnTokenOtherUrl(e,t,n,r){var a={sid:t,client_secret:n,token:r};return this.http.requestOtherUrl($.Post,e,a)}getIdentityHashDetails(e){return this.http.idServerRequest($.Get,"/hash_details",void 0,Nr.V2,e)}identityHashedLookup(e,t){var n=this;return A(function*(){var r={},a=yield n.getIdentityHashDetails(t);if(!a||!a.lookup_pepper||!a.algorithms)throw new Error("Unsupported identity server: bad response");r.pepper=a.lookup_pepper;var o={};if(a.algorithms.includes("sha256"))r.addresses=yield Promise.all(e.map((function(){var y=A(function*(E){var T=E[0].toLowerCase(),S=E[1].toLowerCase(),O=yield ob("".concat(T," ").concat(S," ").concat(r.pepper)),R=Af(O);return o[R]=E[0],R});return function(E){return y.apply(this,arguments)}})())),r.algorithm="sha256";else if(a.algorithms.includes("none"))r.addresses=e.map(y=>{var E=y[0].toLowerCase(),T=y[1].toLowerCase(),S="".concat(E," ").concat(T);return o[S]=y[0],S}),r.algorithm="none";else throw new Error("Unsupported identity server: unknown hash algorithm");var c=yield n.http.idServerRequest($.Post,"/lookup",r,Nr.V2,t);if(!(c!=null&&c.mappings))return[];var d=[];for(var h of Object.keys(c.mappings)){var v=c.mappings[h],m=o[h];if(!m)throw new Error("Identity server returned more results than expected");d.push({address:m,mxid:v})}return d})()}lookupThreePid(e,t,n){var r=this;return A(function*(){var a=yield r.identityHashedLookup([[t,e]],n),o=a.find(d=>d.address===t);if(!o)return{};var c={address:t,medium:e,mxid:o.mxid};return c})()}bulkLookupThreePids(e,t){var n=this;return A(function*(){var r=yield n.identityHashedLookup(e.map(d=>[d[1],d[0]]),t),a=[],o=function*(h){var v=e.find(m=>m[1]===h.address);if(!v)throw new Error("Identity sever returned unexpected results");a.push([v[0],h.address,h.mxid])};for(var c of r)yield*o(c);return{threepids:a}})()}getIdentityAccount(e){return this.http.idServerRequest($.Get,"/account",void 0,Nr.V2,e)}sendToDevice(e,t,n){var r=he("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:n||this.makeTxnId()}),a={messages:Ps(t)},o=new Map;for(var[c,d]of t)o.set(c,Array.from(d.keys()));return this.logger.debug("PUT ".concat(r),o),this.http.authedRequest($.Put,r,void 0,a)}encryptAndSendToDevice(e,t,n){var r=this;return A(function*(){if(!r.cryptoBackend)throw new Error("Cannot encrypt to device event, your client does not support encryption.");var a=yield r.cryptoBackend.encryptToDeviceMessages(e,t,n);yield r.queueToDevice(a)})()}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest($.Get,"/thirdparty/protocols").then(e=>{if(!e||typeof e!="object")throw new Error("/thirdparty/protocols did not return an object: ".concat(e));return e})}getThirdpartyLocation(e,t){var n=he("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest($.Get,n,t)}getThirdpartyUser(e,t){var n=he("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest($.Get,n,t)}getTerms(e,t){var n=this.termsUrlForService(e,t);return this.http.requestOtherUrl($.Get,n)}agreeToTerms(e,t,n,r){var a=this.termsUrlForService(e,t),o={Authorization:"Bearer "+n};return this.http.requestOtherUrl($.Post,a,{user_accepts:r},{headers:o})}reportEvent(e,t,n,r){var a=he("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest($.Post,a,void 0,{score:n,reason:r})}reportRoom(e,t){var n=he("/rooms/$roomId/report",{$roomId:e});return this.http.authedRequest($.Post,n,void 0,{reason:t})}getRoomHierarchy(e,t,n){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,a=arguments.length>4?arguments[4]:void 0,o=he("/rooms/$roomId/hierarchy",{$roomId:e}),c={suggested_only:String(r),max_depth:n?.toString(),from:a,limit:t?.toString()};return this.http.authedRequest($.Get,o,c,void 0,{prefix:At.V1}).catch(d=>{if(d.errcode==="M_UNRECOGNIZED")return this.http.authedRequest($.Get,o,c,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw d})}unstableCreateFileTree(e){var t=this;return A(function*(){var{room_id:n}=yield t.createRoom({name:e,preset:rb.PrivateChat,power_level_content_override:wt(wt({},WN),{},{users:{[t.getUserId()]:100}}),creation_content:{[zh]:Yo.Space},initial_state:[{type:Eg.name,state_key:_g.name,content:{[Tg.name]:!0}},{type:G.RoomEncryption,state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}]});return new pC(t,n)})()}unstableGetFileTreeSpace(e){var t,n,r=this.getRoom(e);if(r?.getMyMembership()!==Ne.Join)return null;var a=r.currentState.getStateEvents(G.RoomCreate,""),o=r.currentState.getStateEvents(Eg.name,_g.name);if(!a)throw new Error("Expected single room create event");return!(o!=null&&(t=o.getContent())!==null&&t!==void 0&&t[Tg.name])||((n=a.getContent())===null||n===void 0?void 0:n[zh])!==Yo.Space?null:new pC(this,e)}slidingSync(e,t,n){var r={};e.pos&&(r.pos=e.pos,delete e.pos),e.timeout&&(r.timeout=e.timeout,delete e.timeout);var a=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest($.Post,"/sync",r,e,{prefix:"/_matrix/client/unstable/org.matrix.simplified_msc3575",baseUrl:t,localTimeoutMs:a,abortSignal:n})}supportsThreads(){var e;return((e=this.clientOpts)===null||e===void 0?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){return this.canSupport.get(nn.IntentionalMentions)!==tn.Unsupported}getRoomSummary(e,t){var n=this;return A(function*(){var r={prefix:"/_matrix/client/unstable/im.nheko.summary"};try{var a=he("/summary/$roomid",{$roomid:e});return yield n.http.authedRequest($.Get,a,{via:t},void 0,r)}catch(c){if(c instanceof Ct&&c.errcode==="M_UNRECOGNIZED"){var o=he("/rooms/$roomid/summary",{$roomid:e});return yield n.http.authedRequest($.Get,o,{via:t},void 0,r)}else throw c}})()}processThreadEvents(e,t,n){e.processThreadedEvents(t,n)}processThreadRoots(e,t,n){this.supportsThreads()&&e.processThreadRoots(t,n)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){t!=null&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}whoami(){var e=this;return A(function*(){return e.http.authedRequest($.Get,"/account/whoami")})()}timestampToEvent(e,t,n){var r=this;return A(function*(){var a=he("/rooms/$roomId/timestamp_to_event",{$roomId:e}),o={ts:t.toString(),dir:n};try{return yield r.http.authedRequest($.Get,a,o,void 0,{prefix:At.V1})}catch(c){if(c.errcode==="M_UNRECOGNIZED"&&(c.httpStatus===400||c.httpStatus===404||c.httpStatus===405))return yield r.http.authedRequest($.Get,a,o,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw c}})()}getAuthMetadata(){var e=this;return A(function*(){var t;try{var n=yield e.isVersionSupported("v1.15");t=yield e.http.request($.Get,"/auth_metadata",void 0,void 0,{prefix:n?At.V1:At.Unstable+"/org.matrix.msc2965"})}catch(a){if(a instanceof Ct&&a.errcode==="M_UNRECOGNIZED"){var{issuer:r}=yield e.http.request($.Get,"/auth_issuer",void 0,void 0,{prefix:At.Unstable+"/org.matrix.msc2965"});return vb(r)}throw a}return mb(t)})()}}b(Bf,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY");function DC(i){return Object.fromEntries(Object.entries(i).map(e=>{var[t,n]=e;return["".concat(bn,".").concat(t),n]}))}function Zw(i,e){var t,n=i.getUserId(),r=e.getId(),a=i.getRoom(e.getRoomId());if(!(!a||!n||!r)){if(!a.findEventById(r)){D.info("Decrypted event ".concat(e.getId()," is not in room ").concat(a.roomId,": ignoring"));return}var o=!!e.threadRootId&&!e.isThreadRoot,c;if(o){var d=a.getThread(e.threadRootId);c=d?d.hasUserReadEvent(n,r):!0}else c=a.hasUserReadEvent(n,r);if(!c){var h=i.getPushActionsForEvent(e,!0),v=!!(h!=null&&(t=h.tweaks)!==null&&t!==void 0&&t.highlight);if(v){var m=a.getUnreadCountForEventContext(it.Highlight,e)+1;o?a.setThreadUnreadNotificationCount(e.threadRootId,it.Highlight,m):a.setUnreadNotificationCount(it.Highlight,m)}var y=!!(h!=null&&h.notify);if(y){var E=a.getUnreadCountForEventContext(it.Total,e)+1;o?a.setThreadUnreadNotificationCount(e.threadRootId,it.Total,E):a.setUnreadNotificationCount(it.Total,E)}}}}function pl(i){return vu(i)?ku:i.threadRootId}function vu(i){if(!i.threadRootId||i.isThreadRoot)return!0;if(!i.isRelation())return D.warn("Event is not a relation or a thread root, but still has a threadRootId! id=".concat(i.getId())),!0;if(i.isRelation(mt.name))return!1;var e=i.relationEventId===i.threadRootId;return e}function NC(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function xC(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?NC(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):NC(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}var Mn=(function(i){return i.New="Thread.new",i.Update="Thread.update",i.NewReply="Thread.newReply",i.ViewThread="Thread.viewThread",i.Delete="Thread.delete",i})({}),Rn=(function(i){return i[i.None=0]="None",i[i.Experimental=1]="Experimental",i[i.Stable=2]="Stable",i})({});function Ch(i,e){return i?Rn.Stable:e?Rn.Experimental:Rn.None}class _t extends ow{constructor(e,t,n){var r,a;if(super(),r=this,this.id=e,this.rootEvent=t,b(this,"timelineSet",void 0),b(this,"_currentUserParticipated",!1),b(this,"reEmitter",void 0),b(this,"lastEvent",void 0),b(this,"replyCount",0),b(this,"lastPendingEvent",void 0),b(this,"pendingReplyCount",0),b(this,"room",void 0),b(this,"client",void 0),b(this,"pendingEventOrdering",void 0),b(this,"processRootEventPromise",void 0),b(this,"initialEventsFetched",!_t.hasServerSideSupport),b(this,"initalEventFetchProm",void 0),b(this,"replayEvents",[]),b(this,"onTimelineReset",A(function*(){yield r.processRootEventPromise,r.processRootEventPromise=void 0})),b(this,"onBeforeRedaction",(o,c)=>{o!=null&&o.isRelation(mt.name)&&this.room.eventShouldLiveIn(o).threadId===this.id&&o.getId()!==this.id&&!c.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(Mn.Update,this))}),b(this,"onRedaction",(function(){var o=A(function*(c,d,h){if(h===r.id)if(r.replyCount<=0){for(var v of r.timeline)r.clearEventMetadata(v);r.lastEvent=r.rootEvent,r._currentUserParticipated=!1,r.emit(Mn.Delete,r)}else{var m;((m=r.lastEvent)===null||m===void 0?void 0:m.getId())===c.getAssociatedId()&&(yield r.processRootEventPromise,r.processRootEventPromise=void 0),yield r.updateThreadMetadata()}});return function(c,d,h){return o.apply(this,arguments)}})()),b(this,"onTimelineEvent",(o,c,d)=>{if(!d){var h=o.getSender();h&&c&&this.shouldSendLocalEchoReceipt(h,o)&&c.addLocalEchoReceipt(h,o,On.Read),o.getId()!==this.id&&o.isRelation(mt.name)&&this.replyCount++}this.onEcho(o,d??!1)}),b(this,"onLocalEcho",o=>{this.onEcho(o,!1)}),b(this,"onEcho",(function(){var o=A(function*(c,d){c.threadRootId===r.id&&r.lastEvent!==c&&(yield r.updateThreadMetadata(),c.isRelation(mt.name)&&(d||(r.lastEvent=void 0,r.emit(Mn.NewReply,r,c))))});return function(c,d){return o.apply(this,arguments)}})()),this.setMaxListeners(1e3),!(n!=null&&n.room))throw new Error("element-web#22141: A thread requires a room in order to function");this.room=n.room,this.client=n.client,this.pendingEventOrdering=(a=n.pendingEventOrdering)!==null&&a!==void 0?a:ml.Chronological,this.timelineSet=new Ho(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new Cl(this),this.reEmitter.reEmit(this.timelineSet,[ge.Timeline,ge.TimelineReset]),this.room.on(ot.BeforeRedaction,this.onBeforeRedaction),this.room.on(ge.Redaction,this.onRedaction),this.room.on(ge.LocalEchoUpdated,this.onLocalEcho),this.room.on(ge.TimelineReset,this.onTimelineReset),this.timelineSet.on(ge.Timeline,this.onTimelineEvent),this.processReceipts(n.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}fetchRootEvent(){var e=this;return A(function*(){try{var t=yield e.client.fetchRoomEvent(e.roomId,e.id),n=e.client.getEventMapper();e.rootEvent=n(t)}catch(r){D.error("Failed to fetch thread root to construct thread with",r)}yield e.processEvent(e.rootEvent)})()}static setServerSideSupport(e){_t.hasServerSideSupport=e,e!==Rn.Stable&&(Zo.setPreferUnstable(!0),el.setPreferUnstable(!0),mt.setPreferUnstable(!0))}static setServerSideListSupport(e){_t.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){_t.hasServerSideFwdPaginationSupport=e}shouldSendLocalEchoReceipt(e,t){var n,r=(n=this.client.canSupport.get(nn.RelationsRecursion))!==null&&n!==void 0?n:tn.Unsupported;if(r===tn.Unsupported){var a,o=(a=this.getReadReceiptForUserId(e))===null||a===void 0?void 0:a.eventId;if(o){var c=this.findEventById(o);if(c&&c.getTs()>t.getTs())return!1}}return!0}get roomState(){return this.room.getLiveTimeline().getState(me.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState,addToState:!1})}insertEventIntoTimeline(e){var t=e.getId();t&&(this.findEventById(t)||this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState,!1))}addEvents(e,t){e.forEach(n=>this.addEvent(n,t,!1)),this.updateThreadMetadata()}addEvent(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;this.setEventMetadata(e);var r=this.lastReply(),a=!r||e.localTimestamp>=r.localTimestamp;if(!_t.hasServerSideSupport)this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e);else if(e.isRelation(Et.Annotation)||e.isRelation(Et.Replace)){this.addRelatedThreadEvent(e,t);return}else!t&&a?(this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e)):t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e);e.getId()!==this.id&&e.isRelation(mt.name)&&!t&&a&&(this.lastEvent=void 0),n&&(this.emit(Mn.NewReply,this,e),this.updateThreadMetadata())}addRelatedThreadEvent(e,t){if(this.initialEventsFetched){var a,o=(a=this.client.canSupport.get(nn.RelationsRecursion))!==null&&a!==void 0?a:tn.Unsupported;o===tn.Unsupported?this.insertEventIntoTimeline(e):this.addEventToTimeline(e,t)}else{var n;if((n=this.replayEvents)===null||n===void 0||n.push(e),e.isRelation(Et.Annotation)){var r;(r=this.timelineSet.relations)===null||r===void 0||r.aggregateChildEvent(e,this.timelineSet)}}}processEvent(e){var t=this;return A(function*(){e&&(t.setEventMetadata(e),yield t.fetchEditsWhereNeeded(e))})()}processReceipts(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];for(var{eventId:t,receiptType:n,userId:r,receipt:a,synthetic:o}of e)this.addReceiptToStructure(t,n,r,a,o)}getRootEventBundledRelationship(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.rootEvent;return e?.getServerAggregatedRelation(mt.name)}processRootEvent(){var e=this;return A(function*(){var t=e.getRootEventBundledRelationship();if(_t.hasServerSideSupport&&t){e.replyCount=t.count,e._currentUserParticipated=!!t.current_user_participated;var n=e.client.getEventMapper();e.lastEvent=n(xC(xC({},t.latest_event),{},{room_id:e.roomId})),e.updatePendingReplyCount(),yield e.processEvent(e.lastEvent)}})()}updatePendingReplyCount(){var e=this.pendingEventOrdering===ml.Detached?this.room.getPendingEvents():this.events,t=e.filter(n=>{var r;return n.threadRootId===this.id&&n.isRelation(mt.name)&&n.status!==null&&n.getId()!==((r=this.lastEvent)===null||r===void 0?void 0:r.getId())});this.lastPendingEvent=t.length?t[t.length-1]:void 0,this.pendingReplyCount=t.length}resetLiveTimeline(e,t){var n=this;return A(function*(){var r=n.liveTimeline;n.timelineSet.resetLiveTimeline(e??void 0,t??void 0);var a=n.liveTimeline,o,c;if(e){var d=yield n.client.createMessagesRequest(n.roomId,e,1,Be.Forward);o=d.end}if(t){var h=yield n.client.createMessagesRequest(n.roomId,t,1,Be.Backward);c=h.start}t&&r.getPaginationToken(Be.Forward)===t&&r.setPaginationToken(c??null,Be.Forward),e&&a.getPaginationToken(Be.Backward)===e&&a.setPaginationToken(o??null,Be.Backward)})()}updateThreadFromRootEvent(){var e=this;return A(function*(){_t.hasServerSideSupport&&(!e.initialEventsFetched&&!e.lastEvent&&(yield e.processRootEvent()),yield e.fetchRootEvent()),yield e.processRootEvent()})()}updateThreadMetadata(){var e=this;return A(function*(){if(e.updatePendingReplyCount(),e.processRootEventPromise||(e.processRootEventPromise=e.updateThreadFromRootEvent()),yield e.processRootEventPromise,!e.initialEventsFetched)if(e.initalEventFetchProm)yield e.initalEventFetchProm;else try{e.timelineSet.resetLiveTimeline(),e.replyCount===0&&e.rootEvent?(e.timelineSet.addEventsToTimeline([e.rootEvent],!0,!1,e.liveTimeline,null),e.liveTimeline.setPaginationToken(null,Be.Backward)):(e.initalEventFetchProm=e.client.paginateEventTimeline(e.liveTimeline,{backwards:!0}),yield e.initalEventFetchProm),e.initialEventsFetched=!0;for(var t of e.replayEvents)e.addEvent(t,!1);e.replayEvents=null,e.emit(ge.TimelineReset,e.room,e.timelineSet,!0)}catch(n){D.error("Failed to load start of newly created thread: ",n),e.initialEventsFetched=!1}e.emit(Mn.Update,e)})()}fetchEditsWhereNeeded(){var e=arguments,t=this;return A(function*(){var n,r=(n=t.client.canSupport.get(nn.RelationsRecursion))!==null&&n!==void 0?n:tn.Unsupported;if(r===tn.Unsupported){for(var a=e.length,o=new Array(a),c=0;c<a;c++)o[c]=e[c];return Promise.all(o.filter(fL).map((function(){var d=A(function*(h){try{var v=yield t.client.relations(t.roomId,h.getId(),Et.Replace,h.getType(),{limit:1});if(v.events.length){var m=v.events[0];h.makeReplaced(m),t.insertEventIntoTimeline(m)}}catch(y){D.error("Failed to load edits for encrypted thread event",y)}});return function(h){return d.apply(this,arguments)}})()))}})()}setEventMetadata(e){e&&(me.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){if(e){var t;e.setThread(void 0),(t=e.event)===null||t===void 0||(t=t.unsigned)===null||t===void 0||(t=t["m.relations"])===null||t===void 0||delete t[mt.name]}}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(){for(var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:r=>r.isRelation(mt.name),t=this.timeline.length-1;t>=0;t--){var n=this.timeline[t];if(e(n))return n}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return(e=(t=this.lastPendingEvent)!==null&&t!==void 0?t:this.lastEvent)!==null&&e!==void 0?e:this.lastReply()}get timeline(){return this.events}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof Sn}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){var n=e===this.client.getUserId(),r=this.timeline[this.timeline.length-1];if(n&&r){var a=r.getTs()<this.room.getOldestThreadedReceiptTs(),o=r.getId();if(a&&o)return o}var c=super.getEventReadUpTo(e,t);if(r){var d=this.room.getLastUnthreadedReceiptFor(e);if(!d)return c;for(var h=((v=this.timeline)===null||v===void 0?void 0:v.length)-1;h>=0;--h){var v,m,y=this.timeline[h];if(y.getId()===c)return c;if(y.getTs()<d.ts)return(m=y.getId())!==null&&m!==void 0?m:c}}return c}hasUserReadEvent(e,t){if(e===this.client.getUserId()){var n,r,a,o,c,d,h=((n=(r=this.lastReply())===null||r===void 0?void 0:r.getTs())!==null&&n!==void 0?n:0)<this.room.getOldestThreadedReceiptTs(),v=(a=(o=this.room.getLastUnthreadedReceiptFor(e))===null||o===void 0?void 0:o.ts)!==null&&a!==void 0?a:0,m=((c=this===null||this===void 0||(d=this.lastReply())===null||d===void 0?void 0:d.getTs())!==null&&c!==void 0?c:0)<v;if(h||m)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}}b(_t,"hasServerSideSupport",Rn.None);b(_t,"hasServerSideListSupport",Rn.None);b(_t,"hasServerSideFwdPaginationSupport",Rn.None);function fL(i){return i.isEncrypted()&&(i.isRelation(mt.name)||i.isThreadRoot)}var Zo=new Rf("related_by_senders","io.element.relation_senders"),el=new Rf("related_by_rel_types","io.element.relation_types"),mt=new Rf("m.thread","io.element.thread"),Ui=(function(i){return i[i.My=0]="My",i[i.All=1]="All",i})({});function eI(i){return i===Ui.My?"participated":"all"}class LC extends Error{constructor(e,t,n){super(t),this.code=e,b(this,"detailedString",void 0),this.name="DecryptionError",this.detailedString=vL(this,n)}}function vL(i,e){var t=i.name+"[msg: "+i.message;return e&&(t+=", "+Object.keys(e).map(n=>n+": "+e[n]).join(", ")),t+="]",t}var UC=Object.freeze({visible:!0}),pb=36e5,ot=(function(i){return i.Decrypted="Event.decrypted",i.BeforeRedaction="Event.beforeRedaction",i.VisibilityChange="Event.visibilityChange",i.LocalEventIdReplaced="Event.localEventIdReplaced",i.Status="Event.status",i.Replaced="Event.replaced",i.RelationsCreated="Event.relationsCreated",i.SentinelUpdated="Event.sentinelUpdated",i})({});class Sn extends Ot{setMetadata(e,t){var n,r,a=this.isState()&&this.getType()===G.RoomMember&&this.getSender()===this.getStateKey(),o=!1;if(a||!((n=this.sender)!==null&&n!==void 0&&(n=n.events)!==null&&n!==void 0&&n.member)){var c=e.getSentinelMember(this.getSender());c!==this.sender&&(o=!0),this.sender=c}if(a||!((r=this.target)!==null&&r!==void 0&&(r=r.events)!==null&&r!==void 0&&r.member)&&this.getType()===G.RoomMember){var d=e.getSentinelMember(this.getStateKey());d!==this.target&&(o=!0),this.target=d}this.isState()&&t&&(this.forwardLooking=!1),o&&this.emit(ot.SentinelUpdated)}constructor(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.event=t,b(this,"pushDetails",{}),b(this,"_replacingEvent",null),b(this,"_localRedactionEvent",null),b(this,"_isCancelled",!1),b(this,"clearEvent",void 0),b(this,"visibility",UC),b(this,"_hasCachedExtEv",!1),b(this,"_cachedExtEv",void 0),b(this,"_decryptionFailureReason",null),b(this,"senderCurve25519Key",null),b(this,"claimedEd25519Key",null),b(this,"keyForwardedBy",void 0),b(this,"decryptionPromise",null),b(this,"retryDecryption",!1),b(this,"txnId",void 0),b(this,"thread",void 0),b(this,"threadId",void 0),b(this,"localTimestamp",void 0),b(this,"sender",null),b(this,"target",null),b(this,"status",null),b(this,"error",null),b(this,"forwardLooking",!0),b(this,"reEmitter",void 0),b(this,"unstableStickyExpiresAt",void 0),["state_key","type","sender","room_id","membership"].forEach(a=>{typeof t[a]=="string"&&(t[a]=gp(t[a]))}),["membership","avatar_url","displayname"].forEach(a=>{var o;typeof((o=t.content)===null||o===void 0?void 0:o[a])=="string"&&(t.content[a]=gp(t.content[a]))}),["rel_type"].forEach(a=>{var o;typeof((o=t.content)===null||o===void 0||(o=o["m.relates_to"])===null||o===void 0?void 0:o[a])=="string"&&(t.content["m.relates_to"][a]=gp(t.content["m.relates_to"][a]))}),this.txnId=t.txn_id;var n=this.getAge(),r=Date.now();this.localTimestamp=n!==void 0?r-n:(e=this.getTs())!==null&&e!==void 0?e:r,this.reEmitter=new Cl(this),this.unstableStickyInfo&&(this.unstableStickyInfo.duration_ttl_ms?this.unstableStickyExpiresAt=r+this.unstableStickyInfo.duration_ttl_ms:this.unstableStickyExpiresAt=Math.min(r,this.getTs())+this.unstableStickyInfo.duration_ms)}get unstableExtensibleEvent(){if(!this._hasCachedExtEv){var e;this._cachedExtEv=(e=Wn.ExtensibleEvents.parse(this.getEffectiveEvent()))!==null&&e!==void 0?e:void 0}return this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){var e=Object.assign({},this.getContent());if(this.getWireType()===G.RoomMessageEncrypted)for(var[t,n]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||e[t]===void 0&&(e[t]=n);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){var e=this.getRoomId();if(e){var t;return"id=".concat(this.getId()," type=").concat(this.getWireType()," sender=").concat(this.getSender()," room=").concat(e," ts=").concat((t=this.getDate())===null||t===void 0?void 0:t.toISOString())}else{var n=this.getContent()[Of];return"msgid=".concat(n," type=").concat(this.getWireType()," sender=").concat(this.getSender())}}getOriginalContent(){var e;if(this._localRedactionEvent)return{};if(this.clearEvent){var t;return(t=this.clearEvent.content)!==null&&t!==void 0?t:{}}return(e=this.event.content)!==null&&e!==void 0?e:{}}getContent(){if(this._localRedactionEvent)return{};if(this._replacingEvent){var e;return(e=this._replacingEvent.getContent()["m.new_content"])!==null&&e!==void 0?e:{}}else return this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;if(!this.isState()){var t=(e=this.getWireContent())===null||e===void 0?void 0:e["m.relates_to"];if(t?.rel_type===mt.name)return t.event_id;if(this.thread)return this.thread.id;if(this.threadId!==void 0)return this.threadId;var n=this.getUnsigned();if(typeof n[Wh.name]=="string")return n[Wh.name]}}get isThreadRoot(){if(this.isState())return!1;var e=this.getServerAggregatedRelation(mt.name);return!!e||this.threadRootId===this.getId()}get replyEventId(){var e;return(e=this.getWireContent()["m.relates_to"])===null||e===void 0||(e=e["m.in_reply_to"])===null||e===void 0?void 0:e.event_id}get relationEventId(){var e;return(e=this.getWireContent())===null||e===void 0||(e=e["m.relates_to"])===null||e===void 0?void 0:e.event_id}getPrevContent(){return this.getUnsigned().prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.clearEvent?this.clearEvent.state_key:this.event.state_key}getWireStateKey(){return this.event.state_key}isState(){return this.event.state_key!==void 0}getMembershipAtEvent(){var e=this.getUnsigned();return Lk.findIn(e)}makeEncrypted(e,t,n,r){this.clearEvent={type:this.event.type,content:this.event.content,state_key:this.event.state_key},this.event.type=e,this.event.content=t,this.senderCurve25519Key=n,this.claimedEd25519Key=r,this.isState()&&(this.event.state_key="".concat(this.clearEvent.type,":").concat(this.clearEvent.state_key))}isBeingDecrypted(){return this.decryptionPromise!=null}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){return this._decryptionFailureReason!==null}get decryptionFailureReason(){return this._decryptionFailureReason}shouldAttemptDecryption(){return!(this.isRedacted()||this.isBeingDecrypted()||this.clearEvent||!this.isEncrypted())}attemptDecryption(e){var t=arguments,n=this;return A(function*(){var r=t.length>1&&t[1]!==void 0?t[1]:{};if(!n.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");var a=n.clearEvent&&!n.isDecryptionFailure();if(a)throw new Error("Attempt to decrypt event which has already been decrypted");return n.decryptionPromise?(D.log("Event ".concat(n.getId()," already being decrypted; queueing a retry")),n.retryDecryption=!0,n.decryptionPromise):(n.decryptionPromise=n.decryptionLoop(e,r),n.decryptionPromise)})()}getKeyRequestRecipients(e){var t=[{userId:e,deviceId:"*"}];return t}decryptionLoop(e){var t=arguments,n=this;return A(function*(){var r=t.length>1&&t[1]!==void 0?t[1]:{};for(yield Promise.resolve();;){n.retryDecryption=!1;var a=void 0;try{var o=yield e.decryptEvent(n);r.isRetry===!0&&D.info("Decrypted event on retry (".concat(n.getDetails(),")")),n.setClearData(o),n._decryptionFailureReason=null}catch(d){var c=d instanceof LC?d.detailedString:String(d);if(a=d,n.retryDecryption){D.log("Error decrypting event (".concat(n.getDetails(),"), but retrying: ").concat(c));continue}D.warn("Error decrypting event (".concat(n.getDetails(),"): ").concat(c)),n.setClearDataForDecryptionFailure(String(d)),n._decryptionFailureReason=d instanceof LC?d.code:sx.UNKNOWN_ERROR}n.decryptionPromise=null,n.retryDecryption=!1,n.setPushDetails(),r.emit!==!1&&n.emit(ot.Decrypted,n,a);return}})()}setClearData(e){var t,n;this.clearEvent=e.clearEvent,this.senderCurve25519Key=(t=e.senderCurve25519Key)!==null&&t!==void 0?t:null,this.claimedEd25519Key=(n=e.claimedEd25519Key)!==null&&n!==void 0?n:null,this.keyForwardedBy=e.keyForwardedBy,this.invalidateExtensibleEvent()}setClearDataForDecryptionFailure(e){this.clearEvent={type:G.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: ".concat(e," **")}},this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return this.event.type===G.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return[]}isKeySourceUntrusted(){return!1}getKeyForwardingUser(){return this.keyForwardedBy}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){var e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(ot.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,n,r=(t=e?.visible)!==null&&t!==void 0?t:!0,a=(n=e?.reason)!==null&&n!==void 0?n:null,o=!1;(this.visibility.visible!==r||!this.visibility.visible&&this.visibility.reason!==a)&&(o=!0),o&&(r?this.visibility=UC:this.visibility=Object.freeze({visible:!1,reason:a}),this.emit(ot.VisibilityChange,this,r))}messageVisibility(){return this.visibility}makeRedacted(e,t){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit(ot.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(var n in this.event)this.event.hasOwnProperty(n)&&!mL.has(n)&&delete this.event[n];this.isEncrypted()&&(this.clearEvent=void 0);var r=this.getType()in BC?BC[this.getType()]:{},a=this.getContent();for(var o in a)a.hasOwnProperty(o)&&!r[o]&&delete a[o];!this.isThreadRoot&&this.threadRootId&&this.threadRootId!==this.getId()&&(this.moveAllRelatedToMainTimeline(t),e.moveToMainTimeline(t)),this.invalidateExtensibleEvent()}moveAllRelatedToMainTimeline(e){var t=this.thread;if(this.moveToMainTimeline(e),t)for(var n of t.events){var r;((r=n.getRelation())===null||r===void 0?void 0:r.event_id)===this.getId()&&n.moveAllRelatedToMainTimeline(e)}}moveToMainTimeline(e){var t;(t=this.thread)===null||t===void 0||t.timelineSet.removeEvent(this.getId()),this.setThread(void 0);var n=e.getLiveTimeline();n.getTimelineSet().insertEventIntoTimeline(this,n,n.getState(me.FORWARDS),!1)}isRedacted(){return!!this.getUnsigned().redacted_because}isRedaction(){return this.getType()===G.RoomRedaction}asVisibilityChange(){if(!As.matches(this.getType()))return null;var e=this.getRelation();if(!e||e.rel_type!="m.reference")return null;var t=e.event_id;if(!t)return null;var n=this.getWireContent(),r=!!n.visible,a=n.reason;return a&&typeof a!="string"?null:{visible:r,reason:a,eventId:t}}isVisibilityEvent(){return As.matches(this.getType())}getRedactionEvent(){var e,t;if(!this.isRedacted())return null;if((e=this.clearEvent)!==null&&e!==void 0&&e.unsigned){var n,r;return(n=(r=this.clearEvent)===null||r===void 0?void 0:r.unsigned.redacted_because)!==null&&n!==void 0?n:null}else return(t=this.event.unsigned)!==null&&t!==void 0&&t.redacted_because?this.event.unsigned.redacted_because:{}}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){var t,n=this.getUnsigned(),r=this.getId();this.event=e,n.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=n.redacted_because),this.setStatus(null),this.getId()!==r&&this.emit(ot.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-((t=this.getAge())!==null&&t!==void 0?t:0)}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(ot.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(ot.LocalEventIdReplaced,this)}isRelation(e){var t,n=(t=this.getWireContent())===null||t===void 0?void 0:t["m.relates_to"];return this.isState()&&(n!=null&&n.rel_type)&&[Et.Replace,Et.Thread].includes(n.rel_type)?!1:!!(n!=null&&n.rel_type&&n.event_id&&(!e||n.rel_type===e))}getRelation(){var e;return this.isRelation()&&(e=this.getWireContent()["m.relates_to"])!==null&&e!==void 0?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=e??null,this.emit(ot.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return(t=this.getUnsigned()["m.relations"])===null||t===void 0?void 0:t[e]}replacingEventId(){var e=this.getServerAggregatedRelation(Et.Replace);if(e)return e.event_id;if(this._replacingEvent)return this._replacingEvent.getId()}replacingEvent(){return this._replacingEvent}replacingEventDate(){var e=this.getServerAggregatedRelation(Et.Replace);if(e){var t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent){var n;return(n=this._replacingEvent.getDate())!==null&&n!==void 0?n:void 0}}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){var e=this.getRelation();if(this.replyEventId)return this.replyEventId;if(e)return e.event_id;if(this.isRedaction())return this.event.redacts}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){var t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){var e=new Sn(JSON.parse(JSON.stringify(this.event)));for(var[t,n]of Object.entries(this))t!=="event"&&(e[t]=n);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;var t=mg(this.event),n=mg(e.event);return JSON.stringify(t)===JSON.stringify(n)}toJSON(){var e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.isState()||(this.thread&&this.reEmitter.stopReEmitting(this.thread,[Mn.Update]),this.thread=e,this.setThreadId(e?.id),e&&this.reEmitter.reEmit(e,[Mn.Update]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}get unstableStickyInfo(){var e,t;if((e=this.event.msc4354_sticky)!==null&&e!==void 0&&e.duration_ms)return{duration_ms:Math.min(pb,this.event.msc4354_sticky.duration_ms),duration_ttl_ms:(t=this.event.unsigned)===null||t===void 0?void 0:t.msc4354_sticky_duration_ttl_ms}}}var mL=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),BC={[G.RoomMember]:{membership:1},[G.RoomJoinRules]:{join_rule:1},[G.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}},pL=["1","2","3","4","5","6","7","8","9","10","11"];function gL(i){return!pL.includes(i)}var oi=(function(i){return i[i.NotStarted=0]="NotStarted",i[i.InProgress=1]="InProgress",i[i.Finished=2]="Finished",i})(oi||{}),Ke=(function(i){return i.Events="RoomState.events",i.Members="RoomState.members",i.NewMember="RoomState.newMember",i.Update="RoomState.update",i.BeaconLiveness="RoomState.BeaconLiveness",i.Marker="RoomState.Marker",i})({});class mu extends Ot{constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{status:oi.NotStarted};super(),this.roomId=e,this.oobMemberFlags=t,b(this,"reEmitter",new Cl(this)),b(this,"sentinels",{}),b(this,"displayNameToUserIds",new Map),b(this,"userIdsToDisplayNames",{}),b(this,"tokenToInvite",{}),b(this,"joinedMemberCount",null),b(this,"summaryJoinedMemberCount",null),b(this,"invitedMemberCount",null),b(this,"summaryInvitedMemberCount",null),b(this,"modified",-1),b(this,"members",{}),b(this,"events",new Map),b(this,"paginationToken",null),b(this,"beacons",new Map),b(this,"_liveBeaconIds",[]),b(this,"getVersionWarning",!1),this.updateModifiedTime()}getRoomVersion(){var e,t=this.getStateEvents(G.RoomCreate,"");return t?(e=t.getContent().room_version)!==null&&e!==void 0?e:"1":(this.getVersionWarning||(D.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}getJoinedMemberCount(){return this.summaryJoinedMemberCount!==null?this.summaryJoinedMemberCount:(this.joinedMemberCount===null&&(this.joinedMemberCount=this.getMembers().reduce((e,t)=>t.membership===Ne.Join?e+1:e,0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return this.summaryInvitedMemberCount!==null?this.summaryInvitedMemberCount:(this.invitedMemberCount===null&&(this.invitedMemberCount=this.getMembers().reduce((e,t)=>t.membership===Ne.Invite?e+1:e,0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter(t=>!e.includes(t.userId))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;var t=this.sentinels[e];if(t===void 0){t=new ru(this.roomId,e);var n=this.members[e];n!=null&&n.events.member&&t.setMembershipEvent(n.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return t===void 0?[]:null;if(t===void 0)return Array.from(this.events.get(e).values());var n=this.events.get(e).get(t);return n||null}get hasLiveBeacons(){var e;return!!((e=this.liveBeaconIds)!==null&&e!==void 0&&e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){var e=new mu(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=oi.NotStarted,Array.from(this.events.values()).forEach(n=>{e.setStateEvents(Array.from(n.values()))}),this.oobMemberFlags.status=t,this.summaryInvitedMemberCount!==null&&e.setInvitedMemberCount(this.getInvitedMemberCount()),this.summaryJoinedMemberCount!==null&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==oi.Finished&&this.getMembers().forEach(n=>{if(n.isOutOfBand()){var r;(r=e.getMember(n.userId))===null||r===void 0||r.markOutOfBand()}}),e}setUnknownStateEvents(e){var t=e.filter(n=>!this.events.has(n.getType())||!this.events.get(n.getType()).has(n.getStateKey()));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach(n=>{if(!(n.getRoomId()!==this.roomId||!n.isState())){sb.matches(n.getType())&&this.setBeacon(n);var r=this.getStateEventMatching(n);if(this.setStateEvent(n),n.getType()===G.RoomMember){var a;this.updateDisplayNameCache(n.getStateKey(),(a=n.getContent().displayname)!==null&&a!==void 0?a:""),this.updateThirdPartyTokenCache(n)}this.emit(Ke.Events,n,this,r)}}),this.onBeaconLivenessChange(),e.forEach(n=>{if(!(n.getRoomId()!==this.roomId||!n.isState()))if(n.getType()===G.RoomMember){var r=n.getStateKey();(n.getContent().membership===Ne.Leave||n.getContent().membership===Ne.Ban)&&(n.getContent().avatar_url=n.getContent().avatar_url||n.getPrevContent().avatar_url,n.getContent().displayname=n.getContent().displayname||n.getPrevContent().displayname);var a=this.getOrCreateMember(r,n);a.setMembershipEvent(n,this),this.updateMember(a),this.emit(Ke.Members,n,this,a)}else if(n.getType()===G.RoomPowerLevels){if(n.getStateKey()!=="")return;var o=Object.values(this.members),c=this.getStateEvents(G.RoomCreate,""),d=FC(this.getRoomVersion(),c);o.forEach(h=>{var v=h.getLastModifiedTime();if(c){var m=jC(h.userId,n,d);h.setPowerLevel(m,n)}v!==h.getLastModifiedTime()&&this.emit(Ke.Members,n,this,h)}),this.sentinels={}}else Dk.matches(n.getType())&&this.emit(Ke.Marker,n,t)}),this.emit(Ke.Update,this)}processBeaconEvents(e,t){var n=this;return A(function*(){if(!(!e.length||!n.beacons.size)){var r=[...n.beacons.values()].reduce((h,v)=>(h[v.beaconInfoId]=v,h),{}),a=(h,v)=>{if(Vg.matches(v.getType())){var m=r[h];m&&m.addLocations([v])}},o=function*(v){var m,y=(m=v.getRelation())===null||m===void 0?void 0:m.event_id;if(!y||!r[y])return{v:void 0};if(!Vg.matches(v.getType())&&!v.isEncrypted())return{v:void 0};try{yield t.decryptEventIfNeeded(v),a(y,v)}catch{v.isDecryptionFailure()&&v.once(ot.Decrypted,A(function*(){a(y,v)}))}},c;for(var d of e)if(c=yield*o(d),c)return c.v}})()}getOrCreateMember(e,t){var n=this.members[e];return n||(n=new ru(this.roomId,e),this.members[e]=n,this.emit(Ke.NewMember,t,this,n)),n}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){var t=Yh(e);if(this.beacons.has(t)){var n=this.beacons.get(t);if(e.isRedacted()){var r;n.beaconInfoId===((r=e.getRedactionEvent())===null||r===void 0?void 0:r.redacts)&&(n.destroy(),this.beacons.delete(t));return}return n.update(e)}if(!e.isRedacted()){var a=new aw(e);this.reEmitter.reEmit(a,[It.New,It.Update,It.Destroy,It.LivenessChange]),this.emit(It.New,e,a),a.on(It.LivenessChange,this.onBeaconLivenessChange.bind(this)),a.on(It.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(a.identifier,a)}}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter(e=>e.isLive).map(e=>e.identifier),this.emit(Ke.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,n;return(t=(n=this.events.get(e.getType()))===null||n===void 0?void 0:n.get(e.getStateKey()))!==null&&t!==void 0?t:null}updateMember(e){var t=this.getStateEvents(G.RoomCreate,""),n=this.getStateEvents(G.RoomPowerLevels,"");if(n&&t){var r=jC(e.userId,n,FC(this.getRoomVersion(),t));e.setPowerLevel(r,n)}delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===oi.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===oi.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===oi.NotStarted&&(this.oobMemberFlags.status=oi.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===oi.InProgress&&(this.oobMemberFlags.status=oi.NotStarted)}clearOutOfBandMembers(){var e=0;Object.keys(this.members).forEach(t=>{var n=this.members[t];n.isOutOfBand()&&(++e,delete this.members[t])}),D.log("LL: RoomState removed ".concat(e," members...")),this.oobMemberFlags.status=oi.NotStarted}setOutOfBandMembers(e){D.log("LL: RoomState about to set ".concat(e.length," OOB members ...")),this.oobMemberFlags.status===oi.InProgress&&(D.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=oi.Finished,e.forEach(t=>this.setOutOfBandMember(t)),this.emit(Ke.Update,this))}setOutOfBandMember(e){if(e.getType()===G.RoomMember){var t=e.getStateKey(),n=this.getMember(t);if(!(n&&!n.isOutOfBand())){var r=this.getOrCreateMember(t,e);r.setMembershipEvent(e,this),r.markOutOfBand(),this.updateDisplayNameCache(r.userId,r.name),this.setStateEvent(e),this.updateMember(r),this.emit(Ke.Members,e,this,r)}}}setTypingEvent(e){Object.values(this.members).forEach(function(t){t.setTypingEvent(e)})}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return(t=this.displayNameToUserIds.get(Ns(e)))!==null&&t!==void 0?t:[]}maySendRedactionForEvent(e,t){var n=this.getMember(t);if(!n||n.membership===Ne.Leave||e.status||e.isRedacted())return!1;var r=this.maySendEvent(G.RoomRedaction,t);return r?e.getSender()===t?!0:this.hasSufficientPowerLevelFor("redact",n.powerLevel):!1}hasSufficientPowerLevelFor(e,t){var n=this.getStateEvents(G.RoomPowerLevels,""),r={};n&&(r=n.getContent());var a=50;return t_(r[e])&&(a=r[e]),t>=a}maySendMessage(e){return this.maySendEventOfType(G.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return t.isGuest()||!t.credentials.userId?!1:this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,n){var r,a=this.getStateEvents(G.RoomPowerLevels,""),o,c={},d=0,h=0;a&&(o=a.getContent(),c=o.events||{},Number.isSafeInteger(o.state_default)?d=o.state_default:d=50,Number.isSafeInteger(o.events_default)&&(h=o.events_default));var v=n?d:h;Number.isSafeInteger(c[e])&&(v=c[e]);var m=this.getMember(t),y=(r=m?.powerLevel)!==null&&r!==void 0?r:0;return y>=v}mayTriggerNotifOfType(e,t){var n=this.getMember(t);if(!n)return!1;var r=this.getStateEvents(G.RoomPowerLevels,""),a=50;return r&&r.getContent()&&r.getContent().notifications&&t_(r.getContent().notifications[e])&&(a=r.getContent().notifications[e]),n.powerLevel>=a}getJoinRule(){var e,t=this.getStateEvents(G.RoomJoinRules,""),n=(e=t?.getContent())!==null&&e!==void 0?e:{};return n.join_rule||Ow.Invite}getHistoryVisibility(){var e,t=this.getStateEvents(G.RoomHistoryVisibility,""),n=(e=t?.getContent())!==null&&e!==void 0?e:{};return n.history_visibility||ab.Shared}getGuestAccess(){var e,t=this.getStateEvents(G.RoomGuestAccess,""),n=(e=t?.getContent())!==null&&e!==void 0?e:{};return n.guest_access||Zh.Forbidden}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(e){var t=this.getStateEvents(G.RoomPredecessor,"");if(t){var n=t.getContent(),r=n.predecessor_room_id,a=n.last_known_event_id;typeof a!="string"&&(a=void 0);var o=n.via_servers;if(Array.isArray(o)||(o=void 0),typeof r=="string")return{roomId:r,eventId:a,viaServers:o}}}var c=this.getStateEvents(G.RoomCreate,"");if(c){var d=c.getContent().predecessor;if(d){var h=d.room_id;if(typeof h=="string"){var v=d.event_id;return(typeof v!="string"||v==="")&&(v=void 0),{roomId:h,eventId:v}}}}return null}updateThirdPartyTokenCache(e){if(e.getContent().third_party_invite){var t=(e.getContent().third_party_invite.signed||{}).token;if(t){var n=this.getStateEvents(G.RoomThirdPartyInvite,t);n&&(this.tokenToInvite[t]=e)}}}updateDisplayNameCache(e,t){var n=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],n){var r=Ns(n),a=this.displayNameToUserIds.get(r);if(a){var o=a.filter(v=>v!==e);this.displayNameToUserIds.set(r,o)}}this.userIdsToDisplayNames[e]=t;var c=t&&Ns(t);if(c){var d,h=(d=this.displayNameToUserIds.get(c))!==null&&d!==void 0?d:[];h.push(e),this.displayNameToUserIds.set(c,h)}}}function FC(i,e){var t=new Set;if(gL(i)&&e){var n=e.getSender();n&&t.add(n);var r=e.getDirectionalContent().additional_creators;Array.isArray(r)&&r.forEach(a=>t.add(a))}return t}function jC(i,e,t){if(t.has(i))return 1/0;var n=e.getDirectionalContent(),r=n.users||{};return r[i]!==void 0&&Number.isInteger(r[i])?r[i]:n.users_default!==void 0?n.users_default:0}function qC(i){var e=typeof i=="string"&&!!i&&i!=="undefined"&&i!=="null";return e||typeof i=="number"}class gb{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};b(this,"rooms",{}),b(this,"users",{}),b(this,"syncToken",null),b(this,"filters",new Yr(()=>new Map)),b(this,"accountData",new Map),b(this,"localStorage",void 0),b(this,"oobMembers",new Map),b(this,"pendingEvents",{}),b(this,"clientOptions",void 0),b(this,"pendingToDeviceBatches",[]),b(this,"nextToDeviceBatchId",0),b(this,"createUser",void 0),b(this,"onRoomMember",(t,n,r)=>{var a;if(r.membership!==Ne.Invite){var o=this.users[r.userId]||((a=this.createUser)===null||a===void 0?void 0:a.call(this,r.userId));r.name&&(o.setDisplayName(r.name),r.events.member&&o.setRawDisplayName(r.events.member.getDirectionalContent().displayname)),r.events.member&&r.events.member.getContent().avatar_url&&o.setAvatarUrl(r.events.member.getContent().avatar_url),this.users[o.userId]=o}}),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(Ke.Members,this.onRoomMember),e.currentState.getMembers().forEach(t=>{this.onRoomMember(null,e.currentState,t)})}setUserCreator(e){this.createUser=e}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(Ke.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map(function(e){return e.summary})}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,n,r){}storeFilter(e){!(e!=null&&e.userId)||!(e!=null&&e.filterId)||this.filters.getOrCreate(e.userId).set(e.filterId,e)}getFilter(e,t){var n;return((n=this.filters.get(e))===null||n===void 0?void 0:n.get(t))||null}getFilterIdByName(e){if(!this.localStorage)return null;var t="mxjssdk_memory_filter_"+e;try{var n=this.localStorage.getItem(t);if(qC(n))return n}catch{}return null}setFilterIdByName(e,t){if(this.localStorage){var n="mxjssdk_memory_filter_"+e;try{qC(t)?this.localStorage.setItem(n,t):this.localStorage.removeItem(n)}catch{}}}storeAccountDataEvents(e){e.forEach(t=>{var n=!Object.keys(t.getContent()).length;n?this.accountData.delete(t.getType()):this.accountData.set(t.getType(),t)})}getAccountData(e){return this.accountData.get(e)}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new Yr(()=>new Map),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers.get(e)||null)}setOutOfBandMembers(e,t){return this.oobMembers.set(e,t),Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers.delete(e),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}getPendingEvents(e){var t=this;return A(function*(){var n;return(n=t.pendingEvents[e])!==null&&n!==void 0?n:[]})()}setPendingEvents(e,t){var n=this;return A(function*(){n.pendingEvents[e]=t})()}saveToDeviceBatches(e){for(var t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}getOldestToDeviceBatch(){var e=this;return A(function*(){return e.pendingToDeviceBatches.length===0?null:e.pendingToDeviceBatches[0]})()}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter(t=>t.id!==e),Promise.resolve()}destroy(){return A(function*(){})()}}var tI=(i=>(i.ToWidget="toWidget",i.FromWidget="fromWidget",i))(tI||{});function yL(i){if(i==="toWidget")return"fromWidget";if(i==="fromWidget")return"toWidget";throw new Error("Invalid direction")}var Br=(i=>(i.MSC2762="org.matrix.msc2762",i.MSC2762_UPDATE_STATE="org.matrix.msc2762_update_state",i.MSC2871="org.matrix.msc2871",i.MSC2873="org.matrix.msc2873",i.MSC2931="org.matrix.msc2931",i.MSC2974="org.matrix.msc2974",i.MSC2876="org.matrix.msc2876",i.MSC3819="org.matrix.msc3819",i.MSC3846="town.robin.msc3846",i.MSC3869="org.matrix.msc3869",i.MSC3973="org.matrix.msc3973",i.MSC4039="org.matrix.msc4039",i))(Br||{});const bL=["0.0.1","0.0.2","org.matrix.msc2762","org.matrix.msc2762_update_state","org.matrix.msc2871","org.matrix.msc2873","org.matrix.msc2931","org.matrix.msc2974","org.matrix.msc2876","org.matrix.msc3819","town.robin.msc3846","org.matrix.msc3869","org.matrix.msc3973","org.matrix.msc4039"];class SL extends If.EventEmitter{constructor(e,t,n,r){super(),this.sendDirection=e,this.transportWindow=n,this.inboundWindow=r,this.strictOriginCheck=!1,this.targetOrigin="*",this.timeoutSeconds=10,this._ready=!1,this.outboundRequests=new Map,this.stopController=new AbortController,this._widgetId=t}get ready(){return this._ready}get widgetId(){return this._widgetId||null}get nextRequestId(){const e=`widgetapi-${Date.now()}`;let t=0,n=e;for(;this.outboundRequests.has(n);)n=`${e}-${t++}`;return this.outboundRequests.set(n,null),n}sendInternal(e){console.log(`[PostmessageTransport] Sending object to ${this.targetOrigin}: `,e),this.transportWindow.postMessage(e,this.targetOrigin)}reply(e,t){return this.sendInternal({...e,response:t})}send(e,t){return this.sendComplete(e,t).then(n=>n.response)}sendComplete(e,t){if(!this.ready||!this.widgetId)return Promise.reject(new Error("Not ready or unknown widget ID"));const n={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:e,data:t};return e===en.UpdateVisibility&&(n.visible=t.visible),new Promise((r,a)=>{const o=m=>{v(),r(m)},c=m=>{v(),a(m)},d=setTimeout(()=>c(new Error("Request timed out")),(this.timeoutSeconds||1)*1e3),h=()=>c(new Error("Transport stopped"));this.stopController.signal.addEventListener("abort",h);const v=()=>{this.outboundRequests.delete(n.requestId),clearTimeout(d),this.stopController.signal.removeEventListener("abort",h)};this.outboundRequests.set(n.requestId,{request:n,resolve:o,reject:c}),this.sendInternal(n)})}start(){this.inboundWindow.addEventListener("message",e=>{this.handleMessage(e)}),this._ready=!0}stop(){this._ready=!1,this.stopController.abort()}handleMessage(e){if(this.stopController.signal.aborted||!e.data||this.strictOriginCheck&&e.origin!==globalThis.origin)return;const t=e.data;if(!(!t.action||!t.requestId||!t.widgetId))if(t.response){if(t.api!==this.sendDirection)return;this.handleResponse(t)}else{const n=t;if(n.api!==yL(this.sendDirection))return;this.handleRequest(n)}}handleRequest(e){if(this.widgetId){if(this.widgetId!==e.widgetId)return}else this._widgetId=e.widgetId;this.emit("message",new CustomEvent("message",{detail:e}))}handleResponse(e){if(e.widgetId!==this.widgetId)return;const t=this.outboundRequests.get(e.requestId);if(t)if(EL(e.response)){const{message:n,...r}=e.response.error;t.reject(new af(n,r))}else t.resolve(e)}}var en=(i=>(i.SupportedApiVersions="supported_api_versions",i.Capabilities="capabilities",i.NotifyCapabilities="notify_capabilities",i.ThemeChange="theme_change",i.LanguageChange="language_change",i.TakeScreenshot="screenshot",i.UpdateVisibility="visibility",i.OpenIDCredentials="openid_credentials",i.WidgetConfig="widget_config",i.CloseModalWidget="close_modal",i.ButtonClicked="button_clicked",i.SendEvent="send_event",i.SendToDevice="send_to_device",i.UpdateState="update_state",i.UpdateTurnServers="update_turn_servers",i))(en||{}),Tt=(i=>(i.SupportedApiVersions="supported_api_versions",i.ContentLoaded="content_loaded",i.SendSticker="m.sticker",i.UpdateAlwaysOnScreen="set_always_on_screen",i.GetOpenIDCredentials="get_openid",i.CloseModalWidget="close_modal",i.OpenModalWidget="open_modal",i.SetModalButtonEnabled="set_button_enabled",i.SendEvent="send_event",i.SendToDevice="send_to_device",i.WatchTurnServers="watch_turn_servers",i.UnwatchTurnServers="unwatch_turn_servers",i.BeeperReadRoomAccountData="com.beeper.read_room_account_data",i.MSC2876ReadEvents="org.matrix.msc2876.read_events",i.MSC2931Navigate="org.matrix.msc2931.navigate",i.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",i.MSC3869ReadRelations="org.matrix.msc3869.read_relations",i.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",i.MSC4039GetMediaConfigAction="org.matrix.msc4039.get_media_config",i.MSC4039UploadFileAction="org.matrix.msc4039.upload_file",i.MSC4039DownloadFileAction="org.matrix.msc4039.download_file",i.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",i))(Tt||{}),Vo=(i=>(i.Allowed="allowed",i.Blocked="blocked",i.PendingUserConfirmation="request",i))(Vo||{}),nI=(i=>(i.Custom="m.custom",i.JitsiMeet="m.jitsi",i.Stickerpicker="m.stickerpicker",i))(nI||{}),iI=(i=>(i.Close="m.close",i))(iI||{}),rr=(i=>(i.Send="send",i.Receive="receive",i))(rr||{});class Cn{constructor(e,t,n,r,a){this.direction=e,this.eventType=t,this.kind=n,this.keyStr=r,this.raw=a}matchesAsStateEvent(e,t,n){return this.kind!=="state_event"||this.direction!==e||this.eventType!==t?!1:this.keyStr===null||this.keyStr===n}matchesAsToDeviceEvent(e,t){return!(this.kind!=="to_device"||this.direction!==e||this.eventType!==t)}matchesAsRoomEvent(e,t,n=null){if(this.kind!=="event"||this.direction!==e||this.eventType!==t)return!1;if(this.eventType==="m.room.message"){if(this.keyStr===null||this.keyStr===n)return!0}else return!0;return!1}matchesAsRoomAccountData(e,t){return!(this.kind!=="room_account"||this.direction!==e||this.eventType!==t)}static forStateEvent(e,t,n){t=t.replace(/#/g,"\\#"),n=n!=null?`#${n}`:"";const r=`org.matrix.msc2762.${e}.state_event:${t}${n}`;return Cn.findEventCapabilities([r])[0]}static forToDeviceEvent(e,t){const n=`org.matrix.msc3819.${e}.to_device:${t}`;return Cn.findEventCapabilities([n])[0]}static forRoomEvent(e,t){const n=`org.matrix.msc2762.${e}.event:${t}`;return Cn.findEventCapabilities([n])[0]}static forRoomMessageEvent(e,t){t=t??"";const n=`org.matrix.msc2762.${e}.event:m.room.message#${t}`;return Cn.findEventCapabilities([n])[0]}static forRoomAccountData(e,t){const n=`com.beeper.capabilities.${e}.room_account_data:${t}`;return Cn.findEventCapabilities([n])[0]}static findEventCapabilities(e){const t=[];for(const n of e){let r=null,a,o=null;if(n.startsWith("org.matrix.msc2762.send.event:")?(r="send",o="event",a=n.substring(30)):n.startsWith("org.matrix.msc2762.send.state_event:")?(r="send",o="state_event",a=n.substring(36)):n.startsWith("org.matrix.msc3819.send.to_device:")?(r="send",o="to_device",a=n.substring(34)):n.startsWith("org.matrix.msc2762.receive.event:")?(r="receive",o="event",a=n.substring(33)):n.startsWith("org.matrix.msc2762.receive.state_event:")?(r="receive",o="state_event",a=n.substring(39)):n.startsWith("org.matrix.msc3819.receive.to_device:")?(r="receive",o="to_device",a=n.substring(37)):n.startsWith("com.beeper.capabilities.receive.room_account_data:")&&(r="receive",o="room_account",a=n.substring(50)),r===null||o===null||a===void 0)continue;const c=a.startsWith("m.room.message#")||o==="state_event";let d=null;if(a.includes("#")&&c){const h=a.split("#"),v=h.findIndex(m=>!m.endsWith("\\"));a=h.slice(0,v+1).map(m=>m.endsWith("\\")?m.substring(0,m.length-1):m).join("#"),d=h.slice(v+1).join("#")}t.push(new Cn(r,a,o,d,n))}return t}}var ws=(i=>(i.AnyRoom="*",i))(ws||{}),Rh=(i=>(i.Cancel="cancel",i.Restart="restart",i.Send="send",i))(Rh||{});const _f=class _f extends Error{constructor(e,t){super(e),this.data=t}};_f.prototype.name=_f.name;let af=_f;class Fq extends If.EventEmitter{constructor(e=null,t=null){if(super(),this.capabilitiesFinished=!1,this.supportsMSC2974Renegotiate=!1,this.requestedCapabilities=[],this.turnServerWatchers=0,!globalThis.parent)throw new Error("No parent window. This widget doesn't appear to be embedded properly.");this.transport=new SL(tI.FromWidget,e,globalThis.parent,globalThis),this.transport.targetOrigin=t,this.transport.on("message",this.handleMessage.bind(this))}hasCapability(e){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(e):this.requestedCapabilities.includes(e)}requestCapability(e){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw new Error("Capabilities have already been negotiated");this.requestedCapabilities.push(e)}requestCapabilities(e){for(const t of e)this.requestCapability(t)}requestCapabilityForRoomTimeline(e){this.requestCapability(`org.matrix.msc2762.timeline:${e}`)}requestCapabilityToSendState(e,t){this.requestCapability(Cn.forStateEvent(rr.Send,e,t).raw)}requestCapabilityToReceiveState(e,t){this.requestCapability(Cn.forStateEvent(rr.Receive,e,t).raw)}requestCapabilityToSendToDevice(e){this.requestCapability(Cn.forToDeviceEvent(rr.Send,e).raw)}requestCapabilityToReceiveToDevice(e){this.requestCapability(Cn.forToDeviceEvent(rr.Receive,e).raw)}requestCapabilityToSendEvent(e){this.requestCapability(Cn.forRoomEvent(rr.Send,e).raw)}requestCapabilityToReceiveEvent(e){this.requestCapability(Cn.forRoomEvent(rr.Receive,e).raw)}requestCapabilityToSendMessage(e){this.requestCapability(Cn.forRoomMessageEvent(rr.Send,e).raw)}requestCapabilityToReceiveMessage(e){this.requestCapability(Cn.forRoomMessageEvent(rr.Receive,e).raw)}requestCapabilityToReceiveRoomAccountData(e){this.requestCapability(Cn.forRoomAccountData(rr.Receive,e).raw)}requestOpenIDConnectToken(){return new Promise((e,t)=>{this.transport.sendComplete(Tt.GetOpenIDCredentials,{}).then(n=>{const r=n.response;if(r.state===Vo.Allowed)e(r);else if(r.state===Vo.Blocked)t(new Error("User declined to verify their identity"));else if(r.state===Vo.PendingUserConfirmation){const a=o=>{o.preventDefault();const c=o.detail;c.data.original_request_id===n.requestId&&(c.data.state===Vo.Allowed?(e(c.data),this.transport.reply(c,{})):c.data.state===Vo.Blocked?(t(new Error("User declined to verify their identity")),this.transport.reply(c,{})):(t(new Error("Invalid state on reply: "+r.state)),this.transport.reply(c,{error:{message:"Invalid state"}})),this.off(`action:${en.OpenIDCredentials}`,a))};this.on(`action:${en.OpenIDCredentials}`,a)}else t(new Error("Invalid state: "+r.state))}).catch(t)})}updateRequestedCapabilities(){return this.transport.send(Tt.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()}sendContentLoaded(){return this.transport.send(Tt.ContentLoaded,{}).then()}sendSticker(e){return this.transport.send(Tt.SendSticker,e).then()}setAlwaysOnScreen(e){return this.transport.send(Tt.UpdateAlwaysOnScreen,{value:e}).then(t=>t.success)}openModalWidget(e,t,n=[],r={},a=nI.Custom){return this.transport.send(Tt.OpenModalWidget,{type:a,url:e,name:t,buttons:n,data:r}).then()}closeModalWidget(e={}){return this.transport.send(Tt.CloseModalWidget,e).then()}sendRoomEvent(e,t,n,r,a,o){return this.sendEvent(e,void 0,t,n,r,a,o)}sendStateEvent(e,t,n,r,a,o){return this.sendEvent(e,t,n,r,a,o)}sendEvent(e,t,n,r,a,o,c){return this.transport.send(Tt.SendEvent,{type:e,content:n,...t!==void 0&&{state_key:t},...r!==void 0&&{room_id:r},...a!==void 0&&{delay:a},...o!==void 0&&{parent_delay_id:o},...c!==void 0&&{sticky_duration_ms:c}})}cancelScheduledDelayedEvent(e){return this.transport.send(Tt.MSC4157UpdateDelayedEvent,{delay_id:e,action:Rh.Cancel})}restartScheduledDelayedEvent(e){return this.transport.send(Tt.MSC4157UpdateDelayedEvent,{delay_id:e,action:Rh.Restart})}sendScheduledDelayedEvent(e){return this.transport.send(Tt.MSC4157UpdateDelayedEvent,{delay_id:e,action:Rh.Send})}sendToDevice(e,t,n){return this.transport.send(Tt.SendToDevice,{type:e,encrypted:t,messages:n})}readRoomAccountData(e,t){const n={type:e};return t&&(t.includes(ws.AnyRoom)?n.room_ids=ws.AnyRoom:n.room_ids=t),this.transport.send(Tt.BeeperReadRoomAccountData,n).then(r=>r.events)}readRoomEvents(e,t,n,r,a){const o={type:e,msgtype:n};return t!==void 0&&(o.limit=t),r&&(r.includes(ws.AnyRoom)?o.room_ids=ws.AnyRoom:o.room_ids=r),a&&(o.since=a),this.transport.send(Tt.MSC2876ReadEvents,o).then(c=>c.events)}async readEventRelations(e,t,n,r,a,o,c,d){if(!(await this.getClientVersions()).includes(Br.MSC3869))throw new Error("The read_relations action is not supported by the client.");const v={event_id:e,rel_type:n,event_type:r,room_id:t,to:c,from:o,limit:a,direction:d};return this.transport.send(Tt.MSC3869ReadRelations,v)}readStateEvents(e,t,n,r){const a={type:e,state_key:n===void 0?!0:n};return t!==void 0&&(a.limit=t),r&&(r.includes(ws.AnyRoom)?a.room_ids=ws.AnyRoom:a.room_ids=r),this.transport.send(Tt.MSC2876ReadEvents,a).then(o=>o.events)}setModalButtonEnabled(e,t){if(e===iI.Close)throw new Error("The close button cannot be disabled");return this.transport.send(Tt.SetModalButtonEnabled,{button:e,enabled:t}).then()}navigateTo(e){if(!e||!e.startsWith("https://matrix.to/#"))throw new Error("Invalid matrix.to URI");return this.transport.send(Tt.MSC2931Navigate,{uri:e}).then()}async*getTurnServers(){let e;const t=async n=>{n.preventDefault(),e(n.detail.data),this.transport.reply(n.detail,{})};if(this.on(`action:${en.UpdateTurnServers}`,t),this.turnServerWatchers===0)try{await this.transport.send(Tt.WatchTurnServers,{})}catch(n){throw this.off(`action:${en.UpdateTurnServers}`,t),n}this.turnServerWatchers++;try{for(;;)yield await new Promise(n=>e=n)}finally{this.off(`action:${en.UpdateTurnServers}`,t),this.turnServerWatchers--,this.turnServerWatchers===0&&await this.transport.send(Tt.UnwatchTurnServers,{})}}async searchUserDirectory(e,t){if(!(await this.getClientVersions()).includes(Br.MSC3973))throw new Error("The user_directory_search action is not supported by the client.");const r={search_term:e,limit:t};return this.transport.send(Tt.MSC3973UserDirectorySearch,r)}async getMediaConfig(){if(!(await this.getClientVersions()).includes(Br.MSC4039))throw new Error("The get_media_config action is not supported by the client.");const t={};return this.transport.send(Tt.MSC4039GetMediaConfigAction,t)}async uploadFile(e){if(!(await this.getClientVersions()).includes(Br.MSC4039))throw new Error("The upload_file action is not supported by the client.");const n={file:e};return this.transport.send(Tt.MSC4039UploadFileAction,n)}async downloadFile(e){if(!(await this.getClientVersions()).includes(Br.MSC4039))throw new Error("The download_file action is not supported by the client.");const n={content_uri:e};return this.transport.send(Tt.MSC4039DownloadFileAction,n)}start(){this.transport.start(),this.getClientVersions().then(e=>{e.includes(Br.MSC2974)&&(this.supportsMSC2974Renegotiate=!0)})}handleMessage(e){const t=new CustomEvent(`action:${e.detail.action}`,{detail:e.detail,cancelable:!0});if(this.emit(`action:${e.detail.action}`,t),!t.defaultPrevented)switch(e.detail.action){case en.SupportedApiVersions:return this.replyVersions(e.detail);case en.Capabilities:return this.handleCapabilities(e.detail);case en.UpdateVisibility:return this.transport.reply(e.detail,{});case en.NotifyCapabilities:return this.transport.reply(e.detail,{});default:return this.transport.reply(e.detail,{error:{message:"Unknown or unsupported action: "+e.detail.action}})}}replyVersions(e){this.transport.reply(e,{supported_versions:bL})}getClientVersions(){return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(Tt.SupportedApiVersions,{}).then(e=>(this.cachedClientVersions=e.supported_versions,e.supported_versions)).catch(e=>(console.warn("non-fatal error getting supported client versions: ",e),[]))}handleCapabilities(e){return this.capabilitiesFinished?this.transport.reply(e,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then(t=>(t.includes(Br.MSC2871)?this.once(`action:${en.NotifyCapabilities}`,n=>{this.approvedCapabilities=n.detail.data.approved,this.emit("ready")}):this.emit("ready"),this.capabilitiesFinished=!0,this.transport.reply(e,{capabilities:this.requestedCapabilities})))}}var Ko=(i=>(i.Screenshots="m.capability.screenshot",i.StickerSending="m.sticker",i.AlwaysOnScreen="m.always_on_screen",i.RequiresClient="io.element.requires_client",i.MSC2931Navigate="org.matrix.msc2931.navigate",i.MSC3846TurnServers="town.robin.msc3846.turn_servers",i.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",i.MSC4039UploadFile="org.matrix.msc4039.upload_file",i.MSC4039DownloadFile="org.matrix.msc4039.download_file",i.MSC4157SendDelayedEvent="org.matrix.msc4157.send.delayed_event",i.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",i.MSC4407SendStickyEvent="org.matrix.msc4407.send.sticky_event",i.MSC4407ReceiveStickyEvent="org.matrix.msc4407.receive.sticky_event",i))(Ko||{});function EL(i){const e=i.error;return typeof e=="object"&&e!==null&&"message"in e&&typeof e.message=="string"}function VC(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(i,r).enumerable})),t.push.apply(t,n)}return t}function dh(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?VC(Object(t),!0).forEach(function(n){b(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):VC(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}function TL(i){var e,t,n,r=2;for(typeof Symbol<"u"&&(t=Symbol.asyncIterator,n=Symbol.iterator);r--;){if(t&&(e=i[t])!=null)return e.call(i);if(n&&(e=i[n])!=null)return new kh(e.call(i));t="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function kh(i){function e(t){if(Object(t)!==t)return Promise.reject(new TypeError(t+" is not an object."));var n=t.done;return Promise.resolve(t.value).then(function(r){return{value:r,done:n}})}return kh=function(n){this.s=n,this.n=n.next},kh.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var r=this.s.return;return r===void 0?Promise.resolve({value:n,done:!0}):e(r.apply(this.s,arguments))},throw:function(n){var r=this.s.return;return r===void 0?Promise.reject(n):e(r.apply(this.s,arguments))}},new kh(i)}var wh=(function(i){return i.PendingEventsChanged="PendingEvent.pendingEventsChanged",i})({});class rI extends Bf{constructor(e,t,n,r,a){var o,c;super(r),o=this,this.widgetApi=e,this.capabilities=t,this.roomId=n,b(this,"room",void 0),b(this,"widgetApiReady",void 0),b(this,"roomStateSynced",void 0),b(this,"lifecycle",void 0),b(this,"syncState",null),b(this,"pendingSendingEventsTxId",[]),b(this,"eventEmitter",new Ot),b(this,"syncApiResolver",Promise.withResolvers()),b(this,"updateTxId",(function(){var v=A(function*(m){if(m.getSender()===o.getUserId()&&o.pendingSendingEventsTxId.some(S=>m.getType()===S.type)){for(var y,E=(y=o.pendingSendingEventsTxId.find(S=>S.id===m.getId()))===null||y===void 0?void 0:y.txId;!E&&o.pendingSendingEventsTxId.length>0;){var T;yield new Promise(S=>o.eventEmitter.once(wh.PendingEventsChanged,()=>S())),E=(T=o.pendingSendingEventsTxId.find(S=>S.id===m.getId()))===null||T===void 0?void 0:T.txId}E&&(m.setTxnId(E),m.setUnsigned(dh(dh({},m.getUnsigned()),{},{transaction_id:E}))),o.pendingSendingEventsTxId=o.pendingSendingEventsTxId.filter(S=>S.id!==m.getId()),o.pendingSendingEventsTxId.length===0&&o.eventEmitter.emit(wh.PendingEventsChanged)}});return function(m){return v.apply(this,arguments)}})()),b(this,"onEvent",(function(){var v=A(function*(m){if(m.preventDefault(),m.detail.data.room_id===o.roomId){var y=new Sn(m.detail.data);yield o.updateTxId(y),yield o.syncApiResolver.promise,o.syncApi instanceof La?(yield o.supportUpdateState())?yield o.syncApi.injectRoomEvents(o.room,void 0,[],[y]):yield o.syncApi.injectRoomEvents(o.room,[],void 0,[y]):(yield o.supportUpdateState())?yield o.syncApi.injectRoomEvents(o.room,[],[y]):D.error("slididng sync cannot be used in widget mode if the client widget driver does not support the version: 'org.matrix.msc2762_update_state'"),o.emit(ye.Event,y),y.unstableStickyInfo!==void 0&&o.room._unstable_addStickyEvents([y]),o.setSyncState(ct.Syncing),D.info("Received event ".concat(y.getId()," ").concat(y.getType()))}else{var{event_id:E,room_id:T}=m.detail.data;D.info("Received event ".concat(E," for a different room ").concat(T,"; discarding"))}yield o.ack(m)});return function(m){return v.apply(this,arguments)}})()),b(this,"onToDevice",(function(){var v=A(function*(m){m.preventDefault();var y=new Sn({type:m.detail.data.type,sender:m.detail.data.sender,content:m.detail.data.content});m.detail.data.encrypted&&y.makeEncrypted(G.RoomMessageEncrypted,{},"",""),o.emit(ye.ToDeviceEvent,y),o.setSyncState(ct.Syncing),yield o.ack(m)});return function(m){return v.apply(this,arguments)}})()),b(this,"onStateUpdate",(function(){var v=A(function*(m){m.preventDefault(),(yield o.supportUpdateState())||D.warn("received update_state widget action but the widget driver did not claim to support 'org.matrix.msc2762_update_state'"),yield o.syncApiResolver.promise;for(var y of m.detail.data.state)if(y.room_id===o.roomId){var E=new Sn(y);o.syncApi instanceof La?yield o.syncApi.injectRoomEvents(o.room,void 0,[E]):yield o.syncApi.injectRoomEvents(o.room,[E]),D.info("Updated state entry ".concat(E.getType()," ").concat(E.getStateKey()," to ").concat(E.getId()))}else{var{event_id:T,room_id:S}=m.detail.data;D.info("Received state entry ".concat(T," for a different room ").concat(S,"; discarding"))}yield o.ack(m)});return function(m){return v.apply(this,arguments)}})());var d=this.widgetApi.transport.send.bind(this.widgetApi.transport);this.widgetApi.transport.send=(function(){var v=A(function*(m,y){try{return yield d(m,y)}catch(E){KC(E)}});return function(m,y){return v.apply(this,arguments)}})();var h=this.widgetApi.transport.sendComplete.bind(this.widgetApi.transport);this.widgetApi.transport.sendComplete=(function(){var v=A(function*(m,y){try{return yield h(m,y)}catch(E){KC(E)}});return function(m,y){return v.apply(this,arguments)}})(),this.widgetApiReady=new Promise(v=>this.widgetApi.once("ready",v)),this.roomStateSynced=(c=t.receiveState)!==null&&c!==void 0&&c.length?new Promise(v=>this.widgetApi.once("action:".concat(en.UpdateState),v)):Promise.resolve(),this.requestInitialCapabilities(t,n),e.on("action:".concat(en.SendEvent),this.onEvent),e.on("action:".concat(en.SendToDevice),this.onToDevice),e.on("action:".concat(en.UpdateState),this.onStateUpdate),e.start(),a&&e.sendContentLoaded()}requestInitialCapabilities(e,t){var n,r,a,o,c,d,h,v,m,y,E,T;((n=e.sendEvent)!==null&&n!==void 0&&n.length||(r=e.receiveEvent)!==null&&r!==void 0&&r.length||e.sendMessage===!0||Array.isArray(e.sendMessage)&&e.sendMessage.length||e.receiveMessage===!0||Array.isArray(e.receiveMessage)&&e.receiveMessage.length||(a=e.sendState)!==null&&a!==void 0&&a.length||(o=e.receiveState)!==null&&o!==void 0&&o.length)&&this.widgetApi.requestCapabilityForRoomTimeline(t),(c=e.sendEvent)===null||c===void 0||c.forEach(S=>this.widgetApi.requestCapabilityToSendEvent(S)),(d=e.receiveEvent)===null||d===void 0||d.forEach(S=>this.widgetApi.requestCapabilityToReceiveEvent(S)),e.sendMessage===!0?this.widgetApi.requestCapabilityToSendMessage():Array.isArray(e.sendMessage)&&e.sendMessage.forEach(S=>this.widgetApi.requestCapabilityToSendMessage(S)),e.receiveMessage===!0?this.widgetApi.requestCapabilityToReceiveMessage():Array.isArray(e.receiveMessage)&&e.receiveMessage.forEach(S=>this.widgetApi.requestCapabilityToReceiveMessage(S)),(h=e.sendState)===null||h===void 0||h.forEach(S=>{var{eventType:O,stateKey:R}=S;return this.widgetApi.requestCapabilityToSendState(O,R)}),(v=e.receiveState)===null||v===void 0||v.forEach(S=>{var{eventType:O,stateKey:R}=S;return this.widgetApi.requestCapabilityToReceiveState(O,R)}),(m=e.sendToDevice)===null||m===void 0||m.forEach(S=>this.widgetApi.requestCapabilityToSendToDevice(S)),(y=e.receiveToDevice)===null||y===void 0||y.forEach(S=>this.widgetApi.requestCapabilityToReceiveToDevice(S)),e.sendDelayedEvents&&((E=e.sendEvent)!==null&&E!==void 0&&E.length||e.sendMessage===!0||Array.isArray(e.sendMessage)&&e.sendMessage.length||(T=e.sendState)!==null&&T!==void 0&&T.length)&&this.widgetApi.requestCapability(Ko.MSC4157SendDelayedEvent),e.updateDelayedEvents&&this.widgetApi.requestCapability(Ko.MSC4157UpdateDelayedEvent),e.sendSticky&&this.widgetApi.requestCapability(Ko.MSC4407SendStickyEvent),e.receiveSticky&&this.widgetApi.requestCapability(Ko.MSC4407ReceiveStickyEvent),e.turnServers&&this.widgetApi.requestCapability(Ko.MSC3846TurnServers)}supportUpdateState(){var e=this;return A(function*(){return(yield e.widgetApi.getClientVersions()).includes(Br.MSC2762_UPDATE_STATE)})()}startClient(){var e=arguments,t=this;return A(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:{};t.lifecycle=new AbortController;var r=t.getUserId();if(r&&t.store.storeUser(new $r(r)),n.slidingSync?t.syncApi=new Pw(n.slidingSync,t,n,t.buildSyncApiOptions()):t.syncApi=new La(t,n,t.buildSyncApiOptions()),t.syncApiResolver.resolve(),t.room=t.syncApi.createRoom(t.roomId),t.store.storeRoom(t.room),yield t.widgetApiReady,yield t.supportUpdateState())yield t.roomStateSynced;else{var a,o;yield Promise.all((a=(o=t.capabilities.receiveState)===null||o===void 0?void 0:o.map((function(){var c=A(function*(d){var{eventType:h,stateKey:v}=d,m=yield t.widgetApi.readStateEvents(h,void 0,v,[t.roomId]),y=m.map(E=>new Sn(E));t.syncApi instanceof La?yield t.syncApi.injectRoomEvents(t.room,void 0,y):yield t.syncApi.injectRoomEvents(t.room,y),y.forEach(E=>{t.emit(ye.Event,E),D.info("Backfilled event ".concat(E.getId()," ").concat(E.getType()," ").concat(E.getStateKey()))})});return function(d){return c.apply(this,arguments)}})()))!==null&&a!==void 0?a:[])}n.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*n.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.setSyncState(ct.Syncing),D.info("Finished initial sync"),t.matrixRTC.start(),t.capabilities.turnServers&&t.watchTurnServers()})()}stopClient(){this.widgetApi.off("action:".concat(en.SendEvent),this.onEvent),this.widgetApi.off("action:".concat(en.SendToDevice),this.onToDevice),this.widgetApi.off("action:".concat(en.UpdateState),this.onStateUpdate),super.stopClient(),this.lifecycle.abort()}joinRoom(e){var t=this;return A(function*(){if(e===t.roomId)return t.room;throw new Error("Unknown room: ".concat(e))})()}encryptAndSendEvent(e,t,n,r){var a=this;return A(function*(){var o,c=r,d;n&&Qh(n)?d=n:c||(c=n);var h=(o=c)===null||o===void 0?void 0:o["org.matrix.msc4354.sticky_duration_ms"];if(h!==void 0&&typeof h!="number")throw new Error("Sticky duration must be a number when defined");var v=h,m=t.event.redacts?dh(dh({},t.getContent()),{},{redacts:t.event.redacts}):t.getContent();if(d){var y=yield a.widgetApi.sendRoomEvent(t.getType(),m,e.roomId,"delay"in d?d.delay:void 0,"parent_delay_id"in d?d.parent_delay_id:void 0,v).catch(si);return a.validateSendDelayedEventResponse(y)}var E=t.getTxnId();E&&a.pendingSendingEventsTxId.push({type:t.getType(),id:void 0,txId:E});var T;try{T=yield a.widgetApi.sendRoomEvent(t.getType(),m,e.roomId,void 0,void 0,v).catch(si)}catch(S){throw a.updatePendingEventStatus(e,t,Ie.NOT_SENT),S}return e.updatePendingEvent(t,Ie.SENT,T.event_id),a.pendingSendingEventsTxId.forEach(S=>{S.txId===E&&(S.id=T.event_id)}),a.eventEmitter.emit(wh.PendingEventsChanged),{event_id:T.event_id}})()}sendStateEvent(e,t,n){var r=arguments,a=this;return A(function*(){var o=r.length>3&&r[3]!==void 0?r[3]:"",c=yield a.widgetApi.sendStateEvent(t,o,n,e).catch(si);if(c.event_id===void 0)throw new Error("'event_id' absent from response to an event request");return{event_id:c.event_id}})()}_unstable_sendDelayedStateEvent(e,t,n,r){var a=arguments,o=this;return A(function*(){var c=a.length>4&&a[4]!==void 0?a[4]:"";if(!(yield o.doesServerSupportUnstableFeature(bn)))throw new hi("Server does not support the delayed events API","sendDelayedStateEvent");var d=yield o.widgetApi.sendStateEvent(n,c,r,e,"delay"in t?t.delay:void 0,"parent_delay_id"in t?t.parent_delay_id:void 0).catch(si);return o.validateSendDelayedEventResponse(d)})()}validateSendDelayedEventResponse(e){if(e.delay_id===void 0)throw new Error("'delay_id' absent from response to a delayed event request");return{delay_id:e.delay_id}}_unstable_updateDelayedEvent(e,t){var n=this;return A(function*(){if(!(yield n.doesServerSupportUnstableFeature(bn)))throw new hi("Server does not support the delayed events API","updateDelayedEvent");var r;switch(t){case Ls.Cancel:r=n.widgetApi.cancelScheduledDelayedEvent;break;case Ls.Restart:r=n.widgetApi.cancelScheduledDelayedEvent;break;case Ls.Send:r=n.widgetApi.sendScheduledDelayedEvent;break}return yield r.call(n.widgetApi,e).catch(si),{}})()}_unstable_cancelScheduledDelayedEvent(e){var t=this;return A(function*(){if(!(yield t.doesServerSupportUnstableFeature(bn)))throw new hi("Server does not support the delayed events API","cancelScheduledDelayedEvent");return yield t.widgetApi.cancelScheduledDelayedEvent(e).catch(si),{}})()}_unstable_restartScheduledDelayedEvent(e){var t=this;return A(function*(){if(!(yield t.doesServerSupportUnstableFeature(bn)))throw new hi("Server does not support the delayed events API","restartScheduledDelayedEvent");return yield t.widgetApi.restartScheduledDelayedEvent(e).catch(si),{}})()}_unstable_sendScheduledDelayedEvent(e){var t=this;return A(function*(){if(!(yield t.doesServerSupportUnstableFeature(bn)))throw new hi("Server does not support the delayed events API","sendScheduledDelayedEvent");return yield t.widgetApi.sendScheduledDelayedEvent(e).catch(si),{}})()}encryptAndSendToDevice(e,t,n){var r=this;return A(function*(){var a=new Yr(()=>new Map);for(var{userId:o,deviceId:c}of t)a.getOrCreate(o).set(c,n);yield r.widgetApi.sendToDevice(e,!0,Ps(a)).catch(si)})()}sendToDevice(e,t){var n=this;return A(function*(){return yield n.widgetApi.sendToDevice(e,!1,Ps(t)).catch(si),{}})()}getOpenIdToken(){var e=this;return A(function*(){var t=yield e.widgetApi.requestOpenIDConnectToken().catch(si);return{access_token:t.access_token,expires_in:t.expires_in,matrix_server_name:t.matrix_server_name,token_type:t.token_type}})()}queueToDevice(e){var t=this;return A(function*(){var{eventType:n,batch:r}=e,a=new Yr(()=>new Map);for(var{userId:o,deviceId:c,payload:d}of r)a.getOrCreate(o).set(c,d);yield t.widgetApi.sendToDevice(n,!1,Ps(a)).catch(si)})()}sendToDeviceViaWidgetApi(e,t,n){var r=this;return A(function*(){yield r.widgetApi.sendToDevice(e,t,Ps(n)).catch(si)})()}checkTurnServers(){var e=this;return A(function*(){return e.turnServers.length>0})()}getSyncState(){return this.syncState}setSyncState(e){var t=this.syncState;this.syncState=e,this.emit(ye.Sync,e,t)}ack(e){var t=this;return A(function*(){yield t.widgetApi.transport.reply(e.detail,{})})()}watchTurnServers(){var e=this;return A(function*(){var t=e.widgetApi.getTurnServers(),n=()=>{t.return(void 0)};e.lifecycle.signal.addEventListener("abort",n);try{var r=!1,a=!1,o;try{for(var c=TL(t),d;r=!(d=yield c.next()).done;r=!1){var h=d.value;e.turnServers=[{urls:h.uris,username:h.username,credential:h.password}],e.emit(ye.TurnServers,e.turnServers),D.log("Received TURN server: ".concat(h.uris))}}catch(v){a=!0,o=v}finally{try{r&&c.return!=null&&(yield c.return())}finally{if(a)throw o}}}catch(v){D.warn("Error watching TURN servers",v)}finally{e.lifecycle.signal.removeEventListener("abort",n)}})()}}function KC(i){throw i instanceof af&&i.data.matrix_api_error?Ct.fromWidgetApiErrorData(i.data.matrix_api_error):i}function si(i){throw i instanceof Error&&i.message==="Request timed out"?new Gs("widget api timeout"):i}class _L{constructor(){b(this,"unthreadedReadReceipts",new Map),b(this,"threadedReadReceipts",new Yr(()=>new Map))}setUnthreaded(e,t){this.unthreadedReadReceipts.set(e,t)}setThreaded(e,t,n){this.threadedReadReceipts.getOrCreate(e).set(t,n)}allUnthreaded(){return this.unthreadedReadReceipts.entries()}*allThreaded(){for(var e of this.threadedReadReceipts.values())for(var t of e.entries())yield t}consumeEphemeralEvents(e){e?.forEach(t=>{t.type!==G.Receipt||!t.content||Object.keys(t.content).forEach(n=>{Object.entries(t.content[n]).forEach(r=>{var[a,o]=r;if(By(a))for(var c of Object.keys(o)){var d=t.content[n][a][c],h={data:t.content[n][a][c],type:a,eventId:n};d.thread_id?this.setThreaded(d.thread_id,c,h):this.setUnthreaded(c,h)}})})})}buildAccumulatedReceiptEvent(e){var t={type:G.Receipt,room_id:e,content:{}},n=new Yr(()=>new Yr(()=>new Map));for(var[r,a]of this.allUnthreaded())n.getOrCreate(a.eventId).getOrCreate(a.type).set(r,a.data);for(var[o,c]of this.allThreaded())n.getOrCreate(c.eventId).getOrCreate(c.type).set(o,c.data);return t.content=Ps(n),n.size>0?t:null}}var xr=(function(i){return i.Invite="invite",i.Leave="leave",i.Join="join",i.Knock="knock",i})({});function CL(i){return"_localTs"in i&&i._localTs!==void 0}class aI{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.opts=e,b(this,"accountData",{}),b(this,"inviteRooms",{}),b(this,"knockRooms",{}),b(this,"joinRooms",{}),b(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){!e.account_data||!e.account_data.events||e.account_data.events.forEach(t=>{this.accountData[t.type]=t})}accumulateRooms(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(n=>{this.accumulateRoom(n,xr.Invite,e.rooms.invite[n],t)}),e.rooms.join&&Object.keys(e.rooms.join).forEach(n=>{this.accumulateRoom(n,xr.Join,e.rooms.join[n],t)}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(n=>{this.accumulateRoom(n,xr.Leave,e.rooms.leave[n],t)}),e.rooms.knock&&Object.keys(e.rooms.knock).forEach(n=>{this.accumulateRoom(n,xr.Knock,e.rooms.knock[n],t)}))}accumulateRoom(e,t,n){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;switch(t){case xr.Invite:this.knockRooms[e]&&delete this.knockRooms[e],this.accumulateInviteState(e,n);break;case xr.Knock:this.accumulateKnockState(e,n);break;case xr.Join:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,n,r);break;case xr.Leave:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:D.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!(!t.invite_state||!t.invite_state.events)){if(!this.inviteRooms[e]){this.inviteRooms[e]={invite_state:t.invite_state};return}var n=this.inviteRooms[e];t.invite_state.events.forEach(r=>{for(var a=!1,o=0;o<n.invite_state.events.length;o++){var c=n.invite_state.events[o];c.type===r.type&&c.state_key==r.state_key&&(n.invite_state.events[o]=r,a=!0)}a||n.invite_state.events.push(r)})}}accumulateKnockState(e,t){if(!(!t.knock_state||!t.knock_state.events)){if(!this.knockRooms[e]){this.knockRooms[e]={knock_state:t.knock_state};return}var n=this.knockRooms[e];t.knock_state.events.forEach(r=>{for(var a=!1,o=0;o<n.knock_state.events.length;o++){var c=n.knock_state.events[o];c.type===r.type&&c.state_key==r.state_key&&(n.knock_state.events[o]=r,a=!0)}a||n.knock_state.events.push(r)})}}accumulateJoinState(e,t){var n,r,a,o,c,d,h,v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,m=Date.now();this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_receipts:new _L,_stickyEvents:[]});var y=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(P=>{y._accountData[P.type]=P}),t.unread_notifications&&(y._unreadNotifications=t.unread_notifications),y._unreadThreadNotifications=(n=(r=t[au.stable])!==null&&r!==void 0?r:t[au.unstable])!==null&&n!==void 0?n:void 0,t.summary){var E,T,S,O="m.heroes",R="m.invited_member_count",I="m.joined_member_count",M=y._summary,C=t.summary;M[O]=(E=C[O])!==null&&E!==void 0?E:M[O],M[I]=(T=C[I])!==null&&T!==void 0?T:M[I],M[R]=(S=C[R])!==null&&S!==void 0?S:M[R]}if(y._receipts.consumeEphemeralEvents((a=t.ephemeral)===null||a===void 0?void 0:a.events),t.timeline&&t.timeline.limited&&(y._timeline=[]),(o=t.state)===null||o===void 0||(o=o.events)===null||o===void 0||o.forEach(P=>{hh(y._currentState,P)}),(c=t["org.matrix.msc4222.state_after"])===null||c===void 0||(c=c.events)===null||c===void 0||c.forEach(P=>{hh(y._currentState,P)}),(d=t.timeline)===null||d===void 0||(d=d.events)===null||d===void 0||d.forEach((P,x)=>{var U;t["org.matrix.msc4222.state_after"]||hh(y._currentState,P);var j;if(v)j=P;else{var K;j=Object.assign({},P),j.unsigned!==void 0&&(j.unsigned=Object.assign({},j.unsigned));var Z=(K=P.unsigned)===null||K===void 0?void 0:K.age;Z!==void 0&&(j._localTs=Date.now()-Z)}y._timeline.push({event:j,token:x===0&&(U=t.timeline.prev_batch)!==null&&U!==void 0?U:null})}),y._stickyEvents=y._stickyEvents.filter(P=>{var{expiresTs:x}=P;return x>m}),(h=t.msc4354_sticky)!==null&&h!==void 0&&h.events&&(y._stickyEvents=y._stickyEvents.concat(t.msc4354_sticky.events.map(P=>{var x=Math.min(P.msc4354_sticky.duration_ms,pb),U=Math.min(P.origin_server_ts,m);return{event:P,expiresTs:x+U}}))),y._timeline.length>this.opts.maxTimelineEntries){for(var k=y._timeline.length-this.opts.maxTimelineEntries,_=k;_<y._timeline.length;_++)if(y._timeline[_].token){y._timeline=y._timeline.slice(_,y._timeline.length);break}}}getJSON(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={join:{},invite:{},knock:{},leave:{}};Object.keys(this.inviteRooms).forEach(r=>{t.invite[r]=this.inviteRooms[r]}),Object.keys(this.knockRooms).forEach(r=>{t.knock[r]=this.knockRooms[r]}),Object.keys(this.joinRooms).forEach(r=>{var a,o=this.joinRooms[r],c={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},"org.matrix.msc4222.state_after":{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:o._unreadNotifications,unread_thread_notifications:o._unreadThreadNotifications,summary:o._summary,msc4354_sticky:(a=o._stickyEvents)!==null&&a!==void 0&&a.length?{events:o._stickyEvents.map(E=>E.event)}:void 0};Object.keys(o._accountData).forEach(E=>{c.account_data.events.push(o._accountData[E])});var d=o._receipts.buildAccumulatedReceiptEvent(r);d&&c.ephemeral.events.push(d),o._timeline.forEach(E=>{if(!c.timeline.prev_batch){if(!E.token)return;c.timeline.prev_batch=E.token}var T;!e&&CL(E.event)?(T=Object.assign({},E.event),T.unsigned!==void 0&&(T.unsigned=Object.assign({},T.unsigned)),delete T._localTs,T.unsigned=T.unsigned||{},T.unsigned.age=Date.now()-E.event._localTs):T=E.event,c.timeline.events.push(T)});for(var h=Object.create(null),v=c.timeline.events.length-1;v>=0;v--){var m=c.timeline.events[v];if(!(m.state_key===null||m.state_key===void 0)){var y=wu(m);y.unsigned&&(y.unsigned.prev_content&&(y.content=y.unsigned.prev_content),y.unsigned.prev_sender&&(y.sender=y.unsigned.prev_sender)),hh(h,y)}}Object.keys(o._currentState).forEach(E=>{Object.keys(o._currentState[E]).forEach(T=>{var S=o._currentState[E][T];c["org.matrix.msc4222.state_after"].events.push(S),h[E]&&h[E][T]&&(S=h[E][T]),c.state.events.push(S)})}),t.join[r]=c});var n=[];return Object.keys(this.accountData).forEach(r=>{n.push(this.accountData[r])}),{nextBatch:this.nextBatch,roomsData:t,accountData:n}}getNextBatchToken(){return this.nextBatch}}function hh(i,e){e.state_key===null||e.state_key===void 0||!e.type||(i[e.type]||(i[e.type]=Object.create(null)),i[e.type][e.state_key]=e)}var sI=(function(i){return i[i.Blocked=-1]="Blocked",i[i.Unverified=0]="Unverified",i[i.Verified=1]="Verified",i})({});class RL{constructor(e){b(this,"deviceId",void 0),b(this,"userId",void 0),b(this,"algorithms",void 0),b(this,"keys",void 0),b(this,"verified",void 0),b(this,"signatures",void 0),b(this,"displayName",void 0),b(this,"dehydrated",!1),this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||sI.Unverified,this.signatures=e.signatures||new Map,this.displayName=e.displayName,this.dehydrated=!!e.dehydrated}getFingerprint(){return this.keys.get("ed25519:".concat(this.deviceId))}getIdentityKey(){return this.keys.get("curve25519:".concat(this.deviceId))}}var HC=function(){},kL=10;class wL{constructor(e,t){var n,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};this.client=e,this.timelineSet=t,b(this,"windowLimit",void 0),b(this,"start",void 0),b(this,"end",void 0),b(this,"eventCount",0),this.windowLimit=r.windowLimit||1e3,(n=t.room)===null||n===void 0||n.on(ge.Timeline,this.onTimelineEvent.bind(this))}load(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20,n=r=>{if(!r)throw new Error("No timeline given to initFields");var a,o=r.getEvents();if(!e)a=o.length;else if(a=o.findIndex(h=>h.getId()===e),a<0)throw new Error("getEventTimeline result didn't include requested event");var c=Math.min(o.length,a+Math.ceil(t/2)),d=Math.max(0,c-t);this.start=new ay(r,d-r.getBaseIndex()),this.end=new ay(r,c-r.getBaseIndex()),this.eventCount=c-d};return this.timelineSet.getTimelineForEvent(e)?(n(this.timelineSet.getTimelineForEvent(e)),Promise.resolve()):e?this.client.getEventTimeline(this.timelineSet,e).then(n):(n(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(e){if(e==me.BACKWARDS){var t;return(t=this.start)!==null&&t!==void 0?t:null}else if(e==me.FORWARDS){var n;return(n=this.end)!==null&&n!==void 0?n:null}else throw new Error("Invalid direction '"+e+"'")}extend(e,t){var n=this.getTimelineIndex(e);if(!n)return!1;var r=e==me.BACKWARDS?n.retreat(t):n.advance(t);if(r){this.eventCount+=r,HC("TimelineWindow: increased cap by "+r+" (now "+this.eventCount+")");var a=this.eventCount-this.windowLimit;return a>0&&this.unpaginate(a,e!=me.BACKWARDS),!0}return!1}onTimelineEvent(e,t,n,r){r&&this.onEventRemoved()}onEventRemoved(){var e=this.getEvents();e.length>0&&e[e.length-1]===void 0&&this.end&&this.end.index--}canPaginate(e){var t=this.getTimelineIndex(e);if(!t)return!1;if(e==me.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;var n=t.timeline.getNeighbouringTimeline(e),r=t.timeline.getPaginationToken(e);return!!n||!!r}paginate(e,t){var n=arguments,r=this;return A(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:!0,o=n.length>3&&n[3]!==void 0?n[3]:kL,c=r.getTimelineIndex(e);if(!c)return!1;if(c.pendingPaginate)return c.pendingPaginate;if(r.extend(e,t))return!0;if(!a||o===0)return!1;var d=c.timeline.getPaginationToken(e);if(!d)return!1;var h=r.client.paginateEventTimeline(c.timeline,{backwards:e==me.BACKWARDS,limit:t}).finally(function(){c.pendingPaginate=void 0}).then(v=>v?r.paginate(e,t,!0,o-1):r.paginate(e,t,!1,0));return c.pendingPaginate=h,h})()}unpaginate(e,t){var n=t?this.start:this.end;if(!n)throw new Error("Attempting to unpaginate startOfTimeline=".concat(t," but don't have this direction"));if(e>this.eventCount||e<0)throw new Error("Attemting to unpaginate ".concat(e," events, but only have ").concat(this.eventCount," in the timeline"));for(;e>0;){var r=t?n.advance(e):n.retreat(e);if(r<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=r,this.eventCount-=r,HC("TimelineWindow.unpaginate: dropped "+r+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];for(var e=[],t=this.start.timeline;t;){var n,r,a=t.getEvents(),o=0,c=a.length;t===this.start.timeline&&(o=this.start.index+t.getBaseIndex()),t===((n=this.end)===null||n===void 0?void 0:n.timeline)&&(c=this.end.index+t.getBaseIndex());for(var d=o;d<c;d++)e.push(a[d]);if(t===((r=this.end)===null||r===void 0?void 0:r.timeline))break;t=t.getNeighbouringTimeline(me.FORWARDS)}return e}}class ay{constructor(e,t){this.timeline=e,this.index=t,b(this,"pendingPaginate",void 0)}minIndex(){return this.timeline.getBaseIndex()*-1}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;var t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;var n=this.timeline.getNeighbouringTimeline(e<0?me.BACKWARDS:me.FORWARDS);return n?(this.timeline=n,e<0?this.index=this.maxIndex():this.index=this.minIndex(),this.advance(e)):0}retreat(e){return this.advance(e*-1)*-1}}var Ac="m.login.email.identity",GC="m.login.msisdn",sy=(function(i){return i.Password="m.login.password",i.Recaptcha="m.login.recaptcha",i.Terms="m.login.terms",i.Email="m.login.email.identity",i.Msisdn="m.login.msisdn",i.Sso="m.login.sso",i.SsoUnstable="org.matrix.login.sso",i.Dummy="m.login.dummy",i.RegistrationToken="m.login.registration_token",i.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token",i.OAuth="m.oauth",i})({});class oI extends Error{constructor(e,t,n){super(e),this.required_stages=t,this.flows=n,b(this,"name","NoAuthFlowFoundError")}}class IL{constructor(e){var t=this;b(this,"matrixClient",void 0),b(this,"inputs",void 0),b(this,"clientSecret",void 0),b(this,"requestCallback",void 0),b(this,"busyChangedCallback",void 0),b(this,"stateUpdatedCallback",void 0),b(this,"requestEmailTokenCallback",void 0),b(this,"supportedStages",void 0),b(this,"data",void 0),b(this,"emailSid",void 0),b(this,"requestingEmailToken",!1),b(this,"attemptAuthDeferred",null),b(this,"chosenFlow",null),b(this,"currentStage",null),b(this,"emailAttempt",1),b(this,"submitPromise",null),b(this,"requestEmailToken",A(function*(){if(t.requestingEmailToken)D.warn("Could not request email token: Already requesting");else{D.trace("Requesting email token. Attempt: "+t.emailAttempt),t.requestingEmailToken=!0;try{var n=yield t.requestEmailTokenCallback(t.inputs.emailAddress,t.clientSecret,t.emailAttempt++,t.data.session);t.emailSid=n.sid,D.trace("Email token request succeeded")}finally{t.requestingEmailToken=!1}}})),this.matrixClient=e.matrixClient,this.data=e.authData||{flows:[]},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=e.emailSid,e.supportedStages!==void 0&&(this.supportedStages=new Set(e.supportedStages))}attemptAuth(){var e=this;return A(function*(){var t;e.attemptAuthDeferred=Promise.withResolvers();var n=e.attemptAuthDeferred.promise;if((t=e.data)!==null&&t!==void 0&&(t=t.flows)!==null&&t!==void 0&&t.length)e.startNextAuthStage();else{var r;(r=e.busyChangedCallback)===null||r===void 0||r.call(e,!0);var a=e.data.session?{session:e.data.session}:null;e.doRequest(a).finally(()=>{var o;(o=e.busyChangedCallback)===null||o===void 0||o.call(e,!1)})}return n})()}poll(){var e=this;return A(function*(){if(e.data.session&&e.attemptAuthDeferred&&!e.submitPromise){var t={};if(e.currentStage==Ac&&e.emailSid){var n={sid:e.emailSid,client_secret:e.clientSecret},r=e.matrixClient.getIdentityServerUrl();r&&(n.id_server=new URL(r).host),t={type:Ac,threepid_creds:n}}e.submitAuthDict(t,!0)}})()}getSessionId(){var e;return(e=this.data)===null||e===void 0?void 0:e.session}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return(t=this.data)===null||t===void 0||(t=t.params)===null||t===void 0?void 0:t[e]}getChosenFlow(){return this.chosenFlow}submitAuthDict(e){var t=arguments,n=this;return A(function*(){var r,a=t.length>1&&t[1]!==void 0?t[1]:!1;if(!n.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");if(!a){var o;(o=n.busyChangedCallback)===null||o===void 0||o.call(n,!0)}for(;n.submitPromise;)try{yield n.submitPromise}catch{}var c;(r=n.data)!==null&&r!==void 0&&r.session?c=Object.assign({session:n.data.session},e):c=e;try{n.submitPromise=n.doRequest(c,a),yield n.submitPromise}finally{if(n.submitPromise=null,!a){var d;(d=n.busyChangedCallback)===null||d===void 0||d.call(n,!1)}}})()}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}doRequest(e){var t=arguments,n=this;return A(function*(){var r=t.length>1&&t[1]!==void 0?t[1]:!1;try{var a=yield n.requestCallback(e,r);n.attemptAuthDeferred.resolve(a),n.attemptAuthDeferred=null}catch(T){var o,c,d,h,v=T instanceof Ct?T:null,m=(o=v==null||(c=v.data)===null||c===void 0?void 0:c.flows)!==null&&o!==void 0?o:null,y=((d=n.data)===null||d===void 0?void 0:d.flows)||!!m;if(!v||v.httpStatus!==401||!v.data||!y)if(r)D.log("Background poll request failed doing UI auth: ignoring",T);else{var E;(E=n.attemptAuthDeferred)===null||E===void 0||E.reject(T)}v&&!v.data&&(v.data={}),v&&!v.data.flows&&!v.data.completed&&!v.data.session&&(v.data.flows=n.data.flows,v.data.completed=n.data.completed,v.data.session=n.data.session),v&&(n.data=v.data);try{n.startNextAuthStage()}catch(S){n.attemptAuthDeferred.reject(S),n.attemptAuthDeferred=null;return}if(!n.emailSid&&(h=n.chosenFlow)!==null&&h!==void 0&&h.stages.includes(sy.Email))try{yield n.requestEmailToken()}catch(S){n.attemptAuthDeferred.reject(S),n.attemptAuthDeferred=null}}})()}startNextAuthStage(){var e,t,n=this.chooseStage();if(!n)throw new Error("No incomplete flows from the server");if(this.currentStage=n,n===sy.Dummy){this.submitAuthDict({type:"m.login.dummy"});return}if((e=this.data)!==null&&e!==void 0&&e.errcode||(t=this.data)!==null&&t!==void 0&&t.error){var r,a;this.stateUpdatedCallback(n,{errcode:((r=this.data)===null||r===void 0?void 0:r.errcode)||"",error:((a=this.data)===null||a===void 0?void 0:a.error)||""});return}this.stateUpdatedCallback(n,n===Ac?{emailSid:this.emailSid}:{})}chooseStage(){this.chosenFlow===null&&(this.chosenFlow=this.chooseFlow()),D.log("Active flow => %s",JSON.stringify(this.chosenFlow));var e=this.firstUncompletedStage(this.chosenFlow);return D.log("Next stage: %s",e),e}scoreFlow(e){var t=e.stages.length;return this.supportedStages!==void 0&&(t+=e.stages.filter(n=>!this.supportedStages.has(n)).length*10),t}chooseFlow(){var e,t=((e=this.data)===null||e===void 0?void 0:e.flows)||[],n=!!this.inputs.emailAddress||!!this.emailSid,r=!!this.inputs.phoneCountry&&!!this.inputs.phoneNumber;t.sort((v,m)=>this.scoreFlow(v)-this.scoreFlow(m));for(var a of t){var o=!1,c=!1;for(var d of a.stages)d===Ac?o=!0:d==GC&&(c=!0);if(o==n&&c==r)return a}var h=[];throw n&&h.push(Ac),r&&h.push(GC),new oI("No appropriate authentication flow found",h,t)}firstUncompletedStage(e){var t,n=((t=this.data)===null||t===void 0?void 0:t.completed)||[];return e.stages.find(r=>!n.includes(r))}}function lI(i,e){return new Promise((t,n)=>{var r=!0,a=i.open(e);a.onupgradeneeded=()=>{r=!1},a.onblocked=()=>n(a.error),a.onsuccess=()=>{var o=a.result;o.close(),r||i.deleteDatabase(e),t(r)},a.onerror=()=>n(a.error)})}var cI=[i=>{i.createObjectStore("users",{keyPath:["userId"]}),i.createObjectStore("accountData",{keyPath:["type"]}),i.createObjectStore("sync",{keyPath:["clobber"]})},i=>{var e=i.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]});e.createIndex("room","room_id")},i=>{i.createObjectStore("client_options",{keyPath:["clobber"]})},i=>{i.createObjectStore("to_device_queue",{autoIncrement:!0})}],OL=cI.length;function fh(i,e,t){var n=i.openCursor(e);return new Promise((r,a)=>{var o=[];n.onerror=()=>{var c;a(new Error("Query failed: "+((c=n.error)===null||c===void 0?void 0:c.name)))},n.onsuccess=()=>{var c=n.result;if(!c){r(o);return}o.push(t(c)),c.continue()}})}function Es(i){return new Promise((e,t)=>{i.oncomplete=function(n){e(n)},i.onerror=function(){t(i.error)}})}function uI(i){return new Promise((e,t)=>{i.onsuccess=function(n){e(n)},i.onerror=function(){t(i.error)}})}function ML(i){return new Promise((e,t)=>{i.onsuccess=()=>e(i),i.onerror=n=>t(n)})}function Lp(i){return uI(i).then(e=>i.result)}class zC{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),lI(e,t)}constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"default";this.indexedDB=e,b(this,"dbName",void 0),b(this,"syncAccumulator",void 0),b(this,"db",void 0),b(this,"disconnected",!0),b(this,"_isNewlyCreated",!1),b(this,"syncToDatabasePromise",void 0),b(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+t,this.syncAccumulator=new aI}connect(e){var t=this;if(!this.disconnected)return D.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,D.log("LocalIndexedDBStoreBackend.connect: connecting...");var n=this.indexedDB.open(this.dbName,OL);return n.onupgradeneeded=r=>{var a=n.result,o=r.oldVersion;D.log("LocalIndexedDBStoreBackend.connect: upgrading from ".concat(o)),o<1&&(this._isNewlyCreated=!0),cI.forEach((c,d)=>{o<=d&&c(a)})},n.onblocked=()=>{D.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},D.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),uI(n).then(A(function*(){D.log("LocalIndexedDBStoreBackend.connect: connected"),t.db=n.result,t.db.onversionchange=()=>{var r;(r=t.db)===null||r===void 0||r.close(),t.disconnected=!0,t.db=void 0},t.db.onclose=()=>{t.disconnected=!0,t.db=void 0,e?.()},yield t.init()}))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then(e=>{var[t,n]=e;D.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:n.nextBatch,rooms:n.roomsData,account_data:{events:t}},!0)})}getOutOfBandMembers(e){return new Promise((t,n)=>{var r=this.db.transaction(["oob_membership_events"],"readonly"),a=r.objectStore("oob_membership_events"),o=a.index("room"),c=IDBKeyRange.only(e),d=o.openCursor(c),h=[],v=!1;d.onsuccess=()=>{var m=d.result;if(!m)return!h.length&&!v?t(null):t(h);var y=m.value;y.oob_written?v=!0:h.push(y),m.continue()},d.onerror=m=>{n(m)}}).then(t=>(D.log("LL: got ".concat(t?.length," membershipEvents from storage for room ").concat(e," ...")),t))}setOutOfBandMembers(e,t){var n=this;return A(function*(){D.log("LL: backend about to store ".concat(t.length)+" members for ".concat(e));var r=n.db.transaction(["oob_membership_events"],"readwrite"),a=r.objectStore("oob_membership_events");t.forEach(c=>{a.put(c)});var o={room_id:e,oob_written:!0,state_key:0};a.put(o),yield Es(r),D.log("LL: backend done storing for ".concat(e,"!"))})()}clearOutOfBandMembers(e){var t=this;return A(function*(){var n=t.db.transaction(["oob_membership_events"],"readonly"),r=n.objectStore("oob_membership_events"),a=r.index("room"),o=IDBKeyRange.only(e),c=Lp(a.openKeyCursor(o,"next")).then(T=>(T?.primaryKey)[1]),d=Lp(a.openKeyCursor(o,"prev")).then(T=>(T?.primaryKey)[1]),[h,v]=yield Promise.all([c,d]),m=t.db.transaction(["oob_membership_events"],"readwrite"),y=m.objectStore("oob_membership_events"),E=IDBKeyRange.bound([e,h],[e,v]);D.log("LL: Deleting all users + marker in storage for room ".concat(e,", with key range:"),[e,h],[e,v]),yield ML(y.delete(E))})()}clearDatabase(){return new Promise(e=>{var t;D.log("Removing indexeddb instance: ".concat(this.dbName)),(t=this.db)===null||t===void 0||t.close();var n=this.indexedDB.deleteDatabase(this.dbName);n.onblocked=()=>{D.log("can't yet delete indexeddb ".concat(this.dbName," because it is open elsewhere"))},n.onerror=()=>{var r;D.warn("unable to delete js-sdk store indexeddb: ".concat((r=n.error)===null||r===void 0?void 0:r.name)),e()},n.onsuccess=()=>{D.log("Removed indexeddb instance: ".concat(this.dbName)),e()}})}getSavedSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(wu(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then(()=>{this.syncAccumulator.accumulate(e)})}syncToDatabase(e){var t=this;return A(function*(){return t.syncToDatabasePromise?(D.warn("Skipping syncToDatabase() as persist already in flight"),t.pendingUserPresenceData.push(...e),t.syncToDatabasePromise):(e.unshift(...t.pendingUserPresenceData),t.syncToDatabasePromise=t.doSyncToDatabase(e),t.syncToDatabasePromise)})()}doSyncToDatabase(e){var t=this;return A(function*(){try{var n=t.syncAccumulator.getJSON(!0);yield Promise.all([t.persistUserPresenceEvents(e),t.persistAccountData(n.accountData),t.persistSyncData(n.nextBatch,n.roomsData)])}finally{t.syncToDatabasePromise=void 0}})()}persistSyncData(e,t){return D.log("Persisting sync data up to",e),Ao(()=>{var n=this.db.transaction(["sync"],"readwrite"),r=n.objectStore("sync");return r.put({clobber:"-",nextBatch:e,roomsData:t}),Es(n).then(()=>{D.log("Persisted sync data up to",e)})})}persistAccountData(e){return Ao(()=>{var t=this.db.transaction(["accountData"],"readwrite"),n=t.objectStore("accountData");for(var r of e)n.put(r);return Es(t).then()})}persistUserPresenceEvents(e){return Ao(()=>{var t=this.db.transaction(["users"],"readwrite"),n=t.objectStore("users");for(var r of e)n.put({userId:r[0],event:r[1]});return Es(t).then()})}getUserPresenceEvents(){return Ao(()=>{var e=this.db.transaction(["users"],"readonly"),t=e.objectStore("users");return fh(t,void 0,n=>[n.value.userId,n.value.event])})}loadAccountData(){return D.log("LocalIndexedDBStoreBackend: loading account data..."),Ao(()=>{var e=this.db.transaction(["accountData"],"readonly"),t=e.objectStore("accountData");return fh(t,void 0,n=>n.value).then(n=>(D.log("LocalIndexedDBStoreBackend: loaded account data"),n))})}loadSyncData(){return D.log("LocalIndexedDBStoreBackend: loading sync data..."),Ao(()=>{var e=this.db.transaction(["sync"],"readonly"),t=e.objectStore("sync");return fh(t,void 0,n=>n.value).then(n=>(D.log("LocalIndexedDBStoreBackend: loaded sync data"),n.length>1&&D.warn("loadSyncData: More than 1 sync row found."),n.length>0?n[0]:{}))})}getClientOptions(){return Promise.resolve().then(()=>{var e=this.db.transaction(["client_options"],"readonly"),t=e.objectStore("client_options");return fh(t,void 0,n=>{var r;return(r=n.value)===null||r===void 0?void 0:r.options}).then(n=>n[0])})}storeClientOptions(e){var t=this;return A(function*(){var n=t.db.transaction(["client_options"],"readwrite"),r=n.objectStore("client_options");r.put({clobber:"-",options:e}),yield Es(n)})()}saveToDeviceBatches(e){var t=this;return A(function*(){var n=t.db.transaction(["to_device_queue"],"readwrite"),r=n.objectStore("to_device_queue");for(var a of e)r.add(a);yield Es(n)})()}getOldestToDeviceBatch(){var e=this;return A(function*(){var t=e.db.transaction(["to_device_queue"],"readonly"),n=t.objectStore("to_device_queue"),r=yield Lp(n.openCursor());if(!r)return null;var a=r.value;return{id:r.key,txnId:a.txnId,eventType:a.eventType,batch:a.batch}})()}removeToDeviceBatch(e){var t=this;return A(function*(){var n=t.db.transaction(["to_device_queue"],"readwrite"),r=n.objectStore("to_device_queue");r.delete(e),yield Es(n)})()}destroy(){var e=this;return A(function*(){var t;(t=e.db)===null||t===void 0||t.close()})()}}class PL{constructor(e,t){this.workerFactory=e,this.dbName=t,b(this,"worker",void 0),b(this,"nextSeq",0),b(this,"inFlight",{}),b(this,"startPromise",void 0),b(this,"onWorkerMessage",n=>{var r=n.data;if(r.command=="closed"){var a;(a=this.onClose)===null||a===void 0||a.call(this)}else if(r.command=="cmd_success"||r.command=="cmd_fail"){if(r.seq===void 0){D.error("Got reply from worker with no seq");return}var o=this.inFlight[r.seq];if(o===void 0){D.error("Got reply for unknown seq "+r.seq);return}if(delete this.inFlight[r.seq],r.command=="cmd_success")o.resolve(r.result);else{var c=new Error(r.error.message);c.name=r.error.name,o.reject(c)}}else D.warn("Unrecognised message from worker: ",r)})}connect(e){return this.onClose=e,this.ensureStarted().then(()=>this.doCmd("connect"))}clearDatabase(){return this.ensureStarted().then(()=>this.doCmd("clearDatabase"))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}saveToDeviceBatches(e){var t=this;return A(function*(){return t.doCmd("saveToDeviceBatches",[e])})()}getOldestToDeviceBatch(){var e=this;return A(function*(){return e.doCmd("getOldestToDeviceBatch")})()}removeToDeviceBatch(e){var t=this;return A(function*(){return t.doCmd("removeToDeviceBatch",[e])})()}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then(()=>{D.log("IndexedDB worker is ready")})),this.startPromise}doCmd(e,t){return Promise.resolve().then(()=>{var n,r=this.nextSeq++,a=Promise.withResolvers();return this.inFlight[r]=a,(n=this.worker)===null||n===void 0||n.postMessage({command:e,seq:r,args:t}),a.promise})}destroy(){var e=this;return A(function*(){var t;(t=e.worker)===null||t===void 0||t.terminate()})()}}var AL=1e3*60*5;class DL extends gb{static exists(e,t){return zC.exists(e,t)}constructor(e){if(super(e),b(this,"backend",void 0),b(this,"startedUp",!1),b(this,"syncTs",0),b(this,"userModifiedMap",{}),b(this,"emitter",new Ot),b(this,"onClose",()=>{this.emitter.emit("closed")}),b(this,"getSavedSync",this.degradable(()=>this.backend.getSavedSync(),"getSavedSync")),b(this,"isNewlyCreated",this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated")),b(this,"getSavedSyncToken",this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken")),b(this,"deleteAllData",this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{D.log("Deleted indexeddb data.")},t=>{throw D.error("Failed to delete indexeddb data: ".concat(t)),t})),null)),b(this,"reallySave",this.degradable(()=>{this.syncTs=Date.now();var t=[];for(var n of this.getUsers())this.userModifiedMap[n.userId]!==n.getLastModifiedTime()&&n.events.presence&&(t.push([n.userId,n.events.presence.event]),this.userModifiedMap[n.userId]=n.getLastModifiedTime());return this.backend.syncToDatabase(t)},null)),b(this,"setSyncData",this.degradable(t=>this.backend.setSyncData(t),"setSyncData")),b(this,"getOutOfBandMembers",this.degradable(t=>this.backend.getOutOfBandMembers(t),"getOutOfBandMembers")),b(this,"setOutOfBandMembers",this.degradable((t,n)=>(super.setOutOfBandMembers(t,n),this.backend.setOutOfBandMembers(t,n)),"setOutOfBandMembers")),b(this,"clearOutOfBandMembers",this.degradable(t=>(super.clearOutOfBandMembers(t),this.backend.clearOutOfBandMembers(t)),"clearOutOfBandMembers")),b(this,"getClientOptions",this.degradable(()=>this.backend.getClientOptions(),"getClientOptions")),b(this,"storeClientOptions",this.degradable(t=>(super.storeClientOptions(t),this.backend.storeClientOptions(t)),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new PL(e.workerFactory,e.dbName):this.backend=new zC(e.indexedDB,e.dbName)}on(e,t){this.emitter.on(e,t)}startup(){return this.startedUp?(D.log("IndexedDBStore.startup: already started"),Promise.resolve()):(D.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then(()=>(D.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{D.log("IndexedDBStore.startup: processing presence events"),e.forEach(t=>{var[n,r]=t;if(!this.createUser)throw new Error("`IndexedDBStore.startup` must be called after assigning it to the client, not before!");var a=this.createUser(n);r&&a.setPresenceEvent(new Sn(r)),this.userModifiedMap[a.userId]=a.getLastModifiedTime(),this.storeUser(a)}),this.startedUp=!0}))}destroy(){return this.backend.destroy()}wantsSave(){var e=Date.now();return e-this.syncTs>AL}save(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){var n=this,r=t?super[t]:null;return A(function*(){for(var a=arguments.length,o=new Array(a),c=0;c<a;c++)o[c]=arguments[c];try{return yield e.call(n,...o)}catch(d){D.error("IndexedDBStore failure, degrading to MemoryStore",d),n.emitter.emit("degraded",d);try{D.log("IndexedDBStore trying to delete degraded data"),yield n.backend.clearDatabase(),D.log("IndexedDBStore delete after degrading succeeded")}catch(h){D.warn("IndexedDBStore delete after degrading failed",h)}if(r)return r.call(n,...o)}})}getPendingEvents(e){var t=()=>super.getPendingEvents,n=this;return A(function*(){if(!n.localStorage)return t().call(n,e);var r=n.localStorage.getItem(Up(e));if(r)try{return JSON.parse(r)}catch(a){D.error("Could not parse persisted pending events",a)}return[]})()}setPendingEvents(e,t){var n=()=>super.setPendingEvents,r=this;return A(function*(){if(!r.localStorage)return n().call(r,e,t);t.length>0?r.localStorage.setItem(Up(e),JSON.stringify(t)):r.localStorage.removeItem(Up(e))})()}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}}function Up(i){return"mx_pending_events_".concat(i)}var zi="crypto.",WC=zi+"migration",Bp=zi+"account",NL=zi+"cross_signing_keys",Ih=zi+"inboundgroupsessions/",xL=zi+"inboundgroupsessions.withheld/",LL=zi+"rooms/",Fp=zi+"sessionsneedingbackup";function Bo(i){return zi+"sessions/"+i}function jp(i,e){return Ih+i+"/"+e}function UL(i,e){return xL+i+"/"+e}function BL(i){return LL+i}class Ff extends kf{static exists(e){for(var t=e.length,n=0;n<t;n++){var r;if((r=e.key(n))!==null&&r!==void 0&&r.startsWith(zi))return!0}return!1}constructor(e){super(),this.store=e}containsData(){var e=this;return A(function*(){return Ff.exists(e.store)})()}getMigrationState(){var e=this;return A(function*(){var t;return(t=ki(e.store,WC))!==null&&t!==void 0?t:ul.NOT_STARTED})()}setMigrationState(e){var t=this;return A(function*(){Ts(t.store,WC,e)})()}countEndToEndSessions(e,t){for(var n=0,r=0;r<this.store.length;++r){var a=this.store.key(r);if(a!=null&&a.startsWith(Bo(""))){var o=ki(this.store,a);n+=Object.keys(o??{}).length}}t(n)}_getEndToEndSessions(e){var t=ki(this.store,Bo(e)),n={};for(var[r,a]of Object.entries(t||{}))typeof a=="string"?n[r]={session:a}:n[r]=a;return n}getEndToEndSession(e,t,n,r){var a,o=this._getEndToEndSessions(e);r((a=o[t])!==null&&a!==void 0?a:{})}getEndToEndSessions(e,t,n){var r;n((r=this._getEndToEndSessions(e))!==null&&r!==void 0?r:{})}storeEndToEndSession(e,t,n,r){var a=this._getEndToEndSessions(e)||{};a[t]=n,Ts(this.store,Bo(e),a)}getEndToEndSessionsBatch(){var e=this;return A(function*(){for(var t=[],n=0;n<e.store.length;++n){var r;if((r=e.store.key(n))!==null&&r!==void 0&&r.startsWith(Bo(""))){var a=e.store.key(n).split("/")[1];for(var o of Object.values(e._getEndToEndSessions(a)))if(t.push(o),t.length>=dl)return t}}return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return A(function*(){for(var{deviceKey:n,sessionId:r}of e){var a=t._getEndToEndSessions(n)||{};delete a[r],Object.keys(a).length===0?t.store.removeItem(Bo(n)):Ts(t.store,Bo(n),a)}})()}getEndToEndInboundGroupSession(e,t,n,r){r(ki(this.store,jp(e,t)),ki(this.store,UL(e,t)))}storeEndToEndInboundGroupSession(e,t,n,r){Ts(this.store,jp(e,t),n)}countEndToEndInboundGroupSessions(){var e=this;return A(function*(){for(var t=0,n=0;n<e.store.length;++n){var r=e.store.key(n);r!=null&&r.startsWith(Ih)&&(t+=1)}return t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return A(function*(){for(var t=ki(e.store,Fp)||{},n=[],r=0;r<e.store.length;++r){var a=e.store.key(r);if(a!=null&&a.startsWith(Ih)){var o=a.slice(Ih.length);if(n.push({senderKey:o.slice(0,43),sessionId:o.slice(44),sessionData:ki(e.store,a),needsBackup:o in t}),n.length>=dl)return n}}return n.length===0?null:n})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return A(function*(){for(var{senderKey:n,sessionId:r}of e){var a=jp(n,r);t.store.removeItem(a)}})()}getEndToEndRooms(e,t){for(var n={},r=BL(""),a=0;a<this.store.length;++a){var o=this.store.key(a);if(o!=null&&o.startsWith(r)){var c=o.slice(r.length);n[c]=ki(this.store,o)}}t(n)}markSessionsNeedingBackup(e){var t=ki(this.store,Fp)||{};for(var n of e)t[n.senderKey+"/"+n.sessionId]=!0;return Ts(this.store,Fp,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(Bp),Promise.resolve()}getAccount(e,t){var n=ki(this.store,Bp);t(n)}storeAccount(e,t){Ts(this.store,Bp,t)}getCrossSigningKeys(e,t){var n=ki(this.store,NL);t(n)}getSecretStorePrivateKey(e,t,n){var r=ki(this.store,zi+"ssss_cache.".concat(n));t(r)}storeSecretStorePrivateKey(e,t,n){Ts(this.store,zi+"ssss_cache.".concat(t),n)}doTxn(e,t,n){return Promise.resolve(n(null))}}function ki(i,e){try{return JSON.parse(i.getItem(e))}catch(t){D.log("Error: Failed to get key %s: %s",e,t.message),D.log(t.stack)}return null}function Ts(i,e,t){i.setItem(e,JSON.stringify(t))}class FL{constructor(e){this.db=e,b(this,"nextTxnId",0),e.onversionchange=()=>{D.log("versionchange for indexeddb ".concat(this.db.name,": closing")),e.close()}}containsData(){return A(function*(){throw Error("Not implemented for Backend")})()}startup(){var e=this;return A(function*(){return e})()}deleteAllData(){return A(function*(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")})()}getMigrationState(){var e=this;return A(function*(){var t=ul.NOT_STARTED;return yield e.doTxn("readonly",[et.STORE_ACCOUNT],n=>{var r=n.objectStore(et.STORE_ACCOUNT),a=r.get(bg);a.onsuccess=()=>{var o;t=(o=a.result)!==null&&o!==void 0?o:ul.NOT_STARTED}}),t})()}setMigrationState(e){var t=this;return A(function*(){yield t.doTxn("readwrite",[et.STORE_ACCOUNT],n=>{var r=n.objectStore(et.STORE_ACCOUNT);r.put(e,bg)})})()}getAccount(e,t){var n=e.objectStore("account"),r=n.get("-");r.onsuccess=function(){try{t(r.result||null)}catch(a){qn(e,a)}}}storeAccount(e,t){var n=e.objectStore("account");n.put(t,"-")}getCrossSigningKeys(e,t){var n=e.objectStore("account"),r=n.get("crossSigningKeys");r.onsuccess=function(){try{t(r.result||null)}catch(a){qn(e,a)}}}getSecretStorePrivateKey(e,t,n){var r=e.objectStore("account"),a=r.get("ssss_cache:".concat(n));a.onsuccess=function(){try{t(a.result||null)}catch(o){qn(e,o)}}}storeSecretStorePrivateKey(e,t,n){var r=e.objectStore("account");r.put(n,"ssss_cache:".concat(t))}countEndToEndSessions(e,t){var n=e.objectStore("sessions"),r=n.count();r.onsuccess=function(){try{t(r.result)}catch(a){qn(e,a)}}}getEndToEndSessions(e,t,n){var r=t.objectStore("sessions"),a=r.index("deviceKey"),o=a.openCursor(e),c={};o.onsuccess=function(){var d=o.result;if(d)c[d.value.sessionId]={session:d.value.session,lastReceivedMessageTs:d.value.lastReceivedMessageTs},d.continue();else try{n(c)}catch(h){qn(t,h)}}}getEndToEndSession(e,t,n,r){var a=n.objectStore("sessions"),o=a.get([e,t]);o.onsuccess=function(){try{o.result?r({session:o.result.session,lastReceivedMessageTs:o.result.lastReceivedMessageTs}):r(null)}catch(c){qn(n,c)}}}storeEndToEndSession(e,t,n,r){var a=r.objectStore("sessions");a.put({deviceKey:e,sessionId:t,session:n.session,lastReceivedMessageTs:n.lastReceivedMessageTs})}getEndToEndSessionsBatch(){var e=this;return A(function*(){var t=[];return yield e.doTxn("readonly",[et.STORE_SESSIONS],n=>{var r=n.objectStore(et.STORE_SESSIONS),a=r.openCursor();a.onsuccess=function(){try{var o=a.result;o&&(t.push(o.value),t.length<dl&&o.continue())}catch(c){qn(n,c)}}}),t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return A(function*(){yield t.doTxn("readwrite",[et.STORE_SESSIONS],(function(){var n=A(function*(r){try{var a=r.objectStore(et.STORE_SESSIONS),o=function*(){var v=a.delete([c,d]);yield new Promise(m=>{v.onsuccess=m})};for(var{deviceKey:c,sessionId:d}of e)yield*o()}catch(h){qn(r,h)}});return function(r){return n.apply(this,arguments)}})())})()}getEndToEndInboundGroupSession(e,t,n,r){var a=!1,o=!1,c=n.objectStore("inbound_group_sessions"),d=c.get([e,t]);d.onsuccess=function(){try{d.result?a=d.result.session:a=null,o!==!1&&r(a,o)}catch(m){qn(n,m)}};var h=n.objectStore("inbound_group_sessions_withheld"),v=h.get([e,t]);v.onsuccess=function(){try{v.result?o=v.result.session:o=null,a!==!1&&r(a,o)}catch(m){qn(n,m)}}}storeEndToEndInboundGroupSession(e,t,n,r){var a=r.objectStore("inbound_group_sessions");a.put({senderCurve25519Key:e,sessionId:t,session:n})}countEndToEndInboundGroupSessions(){var e=this;return A(function*(){var t=0;return yield e.doTxn("readonly",[et.STORE_INBOUND_GROUP_SESSIONS],n=>{var r=n.objectStore(et.STORE_INBOUND_GROUP_SESSIONS),a=r.count();a.onsuccess=()=>{t=a.result}}),t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return A(function*(){var t=[];return yield e.doTxn("readonly",[et.STORE_INBOUND_GROUP_SESSIONS,et.STORE_BACKUP],n=>{var r=n.objectStore(et.STORE_INBOUND_GROUP_SESSIONS),a=n.objectStore(et.STORE_BACKUP),o=r.openCursor();o.onsuccess=function(){try{var c=o.result;if(c){var d=a.get(c.key);d.onsuccess=()=>{t.push({senderKey:c.value.senderCurve25519Key,sessionId:c.value.sessionId,sessionData:c.value.session,needsBackup:d.result!==void 0}),t.length<dl&&c.continue()}}}catch(h){qn(n,h)}}}),t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return A(function*(){yield t.doTxn("readwrite",[et.STORE_INBOUND_GROUP_SESSIONS],(function(){var n=A(function*(r){try{var a=r.objectStore(et.STORE_INBOUND_GROUP_SESSIONS),o=function*(){var v=a.delete([c,d]);yield new Promise(m=>{v.onsuccess=m})};for(var{senderKey:c,sessionId:d}of e)yield*o()}catch(h){qn(r,h)}});return function(r){return n.apply(this,arguments)}})())})()}getEndToEndDeviceData(e,t){var n=e.objectStore("device_data"),r=n.get("-");r.onsuccess=function(){try{t(r.result||null)}catch(a){qn(e,a)}}}getEndToEndRooms(e,t){var n={},r=e.objectStore("rooms"),a=r.openCursor();a.onsuccess=function(){var o=a.result;if(o)n[o.key]=o.value,o.continue();else try{t(n)}catch(c){qn(e,c)}}}markSessionsNeedingBackup(e,t){var n=this;return A(function*(){t||(t=n.db.transaction("sessions_needing_backup","readwrite"));var r=t.objectStore("sessions_needing_backup");yield Promise.all(e.map(a=>new Promise((o,c)=>{var d=r.put({senderCurve25519Key:a.senderKey,sessionId:a.sessionId});d.onsuccess=o,d.onerror=c})))})()}doTxn(e,t,n){var r=this.db.transaction(t,e),a=VL(r),o=n(r);return a.then(()=>o)}}var dI=[i=>{qL(i)},i=>{i.createObjectStore("account")},i=>{var e=i.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]});e.createIndex("deviceKey","deviceKey")},i=>{i.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},i=>{i.createObjectStore("device_data")},i=>{i.createObjectStore("rooms")},i=>{i.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},i=>{i.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},i=>{var e=i.createObjectStore("session_problems",{keyPath:["deviceKey","time"]});e.createIndex("deviceKey","deviceKey"),i.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},i=>{i.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},i=>{i.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],hI=dI.length;function jL(i,e){D.log("Upgrading IndexedDBCryptoStore from version ".concat(e)+" to ".concat(hI)),dI.forEach((t,n)=>{e<=n&&t(i)})}function qL(i){var e=i.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});e.createIndex("session",["requestBody.room_id","requestBody.session_id"]),e.createIndex("state","state")}function qn(i,e){i._mx_abortexception=e;try{i.abort()}catch{}}function VL(i){return new Promise((e,t)=>{i.oncomplete=()=>{i._mx_abortexception!==void 0&&t(i._mx_abortexception),e(null)},i.onerror=n=>{i._mx_abortexception!==void 0?t(i._mx_abortexception):(D.log("Error performing indexeddb txn",n),t(i.error))},i.onabort=n=>{i._mx_abortexception!==void 0?t(i._mx_abortexception):(D.log("Error performing indexeddb txn",n),t(i.error))}})}class et{static exists(e,t){return lI(e,t)}static existsAndIsNotMigrated(e,t){return new Promise((n,r)=>{var a=!0,o=e.open(t);o.onupgradeneeded=()=>{a=!1},o.onblocked=()=>r(o.error),o.onsuccess=()=>{var c=o.result;if(!a)c.close(),e.deleteDatabase(t),n(!1);else{var d=c.transaction([et.STORE_ACCOUNT],"readonly"),h=d.objectStore(et.STORE_ACCOUNT),v=h.get(bg);v.onsuccess=()=>{var m,y=(m=v.result)!==null&&m!==void 0?m:ul.NOT_STARTED;n(y===ul.NOT_STARTED)},v.onerror=()=>{r(v.error)},c.close()}},o.onerror=()=>r(o.error)})}constructor(e,t){this.indexedDB=e,this.dbName=t,b(this,"backendPromise",void 0),b(this,"backend",void 0)}containsData(){var e=this;return A(function*(){return et.exists(e.indexedDB,e.dbName)})()}startup(){return this.backendPromise?this.backendPromise:(this.backendPromise=new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}D.log("connecting to indexeddb ".concat(this.dbName));var n=this.indexedDB.open(this.dbName,hI);n.onupgradeneeded=r=>{var a=n.result,o=r.oldVersion;jL(a,o)},n.onblocked=()=>{D.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},n.onerror=r=>{D.log("Error connecting to indexeddb",r),t(n.error)},n.onsuccess=()=>{var r=n.result;D.log("connected to indexeddb ".concat(this.dbName)),e(new FL(r))}}).then(e=>e.doTxn("readonly",[et.STORE_INBOUND_GROUP_SESSIONS,et.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(e=>{if(e.name==="VersionError")throw D.warn("Crypto DB is too new for us to use!",e),new cb(lb.TooNew);D.warn("unable to connect to indexeddb ".concat(this.dbName)+": falling back to localStorage store: ".concat(e));try{if(!(globalThis.localStorage instanceof Storage))throw new Error("localStorage is not available");return new Ff(globalThis.localStorage)}catch(t){return D.warn("Unable to open localStorage: falling back to in-memory store: ".concat(t)),new kf}}).then(e=>(this.backend=e,e)),this.backendPromise)}deleteAllData(){return new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}D.log("Removing indexeddb instance: ".concat(this.dbName));var n=this.indexedDB.deleteDatabase(this.dbName);n.onblocked=()=>{D.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},n.onerror=r=>{D.log("Error deleting data from indexeddb",r),t(n.error)},n.onsuccess=()=>{D.log("Removed indexeddb instance: ".concat(this.dbName)),e()}}).catch(e=>{D.warn("unable to delete IndexedDBCryptoStore: ".concat(e))})}getMigrationState(){return this.backend.getMigrationState()}setMigrationState(e){return this.backend.setMigrationState(e)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,n){this.backend.getSecretStorePrivateKey(e,t,n)}storeSecretStorePrivateKey(e,t,n){this.backend.storeSecretStorePrivateKey(e,t,n)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,n,r){this.backend.getEndToEndSession(e,t,n,r)}getEndToEndSessions(e,t,n){this.backend.getEndToEndSessions(e,t,n)}storeEndToEndSession(e,t,n,r){this.backend.storeEndToEndSession(e,t,n,r)}countEndToEndInboundGroupSessions(){return this.backend.countEndToEndInboundGroupSessions()}getEndToEndSessionsBatch(){return this.backend.getEndToEndSessionsBatch()}deleteEndToEndSessionsBatch(e){return this.backend.deleteEndToEndSessionsBatch(e)}getEndToEndInboundGroupSession(e,t,n,r){this.backend.getEndToEndInboundGroupSession(e,t,n,r)}storeEndToEndInboundGroupSession(e,t,n,r){this.backend.storeEndToEndInboundGroupSession(e,t,n,r)}getEndToEndInboundGroupSessionsBatch(){return this.backend.getEndToEndInboundGroupSessionsBatch()}deleteEndToEndInboundGroupSessionsBatch(e){return this.backend.deleteEndToEndInboundGroupSessionsBatch(e)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}doTxn(e,t,n,r){return this.backend.doTxn(e,t,n,r)}}b(et,"STORE_ACCOUNT","account");b(et,"STORE_SESSIONS","sessions");b(et,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions");b(et,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld");b(et,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions");b(et,"STORE_PARKED_SHARED_HISTORY","parked_shared_history");b(et,"STORE_DEVICE_DATA","device_data");b(et,"STORE_ROOMS","rooms");b(et,"STORE_BACKUP","sessions_needing_backup");var KL=(function(i){return i.Email="email",i.Phone="msisdn",i})({}),fI=new Ht("oauth_aware_preferred","org.matrix.msc3824.delegated_oidc_compatibility"),HL=fI,GL=(function(i){return i.Gitlab="gitlab",i.Github="github",i.Apple="apple",i.Google="google",i.Facebook="facebook",i.Twitter="twitter",i})({}),zL=(function(i){return i.LOGIN="login",i.REGISTER="register",i})({}),WL="m.tz",JL="us.cloke.msc4175.tz";class YL{constructor(e){b(this,"relations",void 0),this.relations=e.filter(t=>!!t)}getRelations(){return this.relations.reduce((e,t)=>[...e,...t.getRelations()],[])}on(e,t){this.relations.forEach(n=>n.on(e,t))}off(e,t){this.relations.forEach(n=>n.off(e,t))}}var $L=(function(i){return i.Global="Global",i.SetItemError="setItem",i.GetItemError="getItem",i.RemoveItemError="removeItem",i.ClearError="clear",i.QuotaExceededError="QuotaExceededError",i})({});class XL extends Ot{}var QL=new XL,vI=()=>new kf;function mI(i){vI=i}function pI(i){var e,t,n;return i.store=(e=i.store)!==null&&e!==void 0?e:new gb({localStorage:globalThis.localStorage}),i.scheduler=(t=i.scheduler)!==null&&t!==void 0?t:new hl,i.cryptoStore=(n=i.cryptoStore)!==null&&n!==void 0?n:vI(),i}function ZL(i){return new Bf(pI(i))}function eU(i,e,t,n){var r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;return new rI(i,e,t,pI(n),r)}const tU=Object.freeze(Object.defineProperty({__proto__:null,AuthType:sy,AutoDiscovery:De,AutoDiscoveryAction:ui,AutoDiscoveryError:Mi,Beacon:aw,BeaconEvent:It,CallEvent:qe,CallFeedEvent:tr,Category:xr,ClientEvent:ye,ClientPrefix:At,ClientStoppedError:px,ConditionKind:$t,ConditionOperator:NN,ConnectionError:Gs,ContentHelpers:d1,DELEGATED_OIDC_COMPATIBILITY:HL,DEVICE_CODE_SCOPE:sL,DMMemberCountCondition:xN,DebugLogger:Fy,Device:RL,DeviceVerification:sI,Direction:Be,DuplicateStrategy:zc,EVENT_VISIBILITY_CHANGE_TYPE:As,EventEmitterEvents:Pk,EventStatus:Ie,EventTimeline:me,EventTimelineSet:Ho,EventType:G,FILTER_RELATED_BY_REL_TYPES:el,FILTER_RELATED_BY_SENDERS:Zo,FeatureSupport:Rn,Filter:di,GET_LOGIN_TOKEN_CAPABILITY:hL,GroupCall:tb,GroupCallEvent:yt,GroupCallIntent:ww,GroupCallState:Dt,GroupCallStatsReportEvent:qc,GroupCallType:Df,GuestAccess:Zh,HTTPError:Fs,HistoryVisibility:ab,HttpApiEvent:Og,IdentityPrefix:Nr,IdentityProviderBrand:GL,IndexedDBCryptoStore:et,IndexedDBStore:DL,InteractiveAuth:IL,InvalidCryptoStoreError:cb,InvalidCryptoStoreState:lb,JoinRule:Ow,KNOWN_SAFE_ROOM_VERSION:Sw,KeySignatureUploadError:mx,KnownMembership:Ne,LOCAL_NOTIFICATION_SETTINGS_PREFIX:xk,LocalStorageCryptoStore:Ff,LocalStorageErrors:$L,LocationAssetType:ll,MAIN_ROOM_TIMELINE:ku,MAXIMUM_MATRIX_VERSION:VN,MAX_STICKY_DURATION_MS:pb,MINIMUM_MATRIX_VERSION:qN,MSC3912_RELATION_BASED_REDACTIONS_PROP:Cg,MXID_PATTERN:jy,M_ASSET:Cu,M_BEACON:Vg,M_BEACON_INFO:sb,M_HTML:r1,M_LOCATION:Ru,M_MESSAGE:i1,M_POLL_END:$h,M_POLL_KIND_DISCLOSED:f1,M_POLL_KIND_UNDISCLOSED:v1,M_POLL_RESPONSE:su,M_POLL_START:m1,M_TEXT:Gy,M_TIMESTAMP:Ja,M_TOPIC:zy,MatrixClient:Bf,MatrixError:Ct,MatrixEvent:Sn,MatrixEventEvent:ot,MatrixHttpApi:gw,MatrixSafetyError:vw,MatrixSafetyErrorCode:fw,MatrixScheduler:hl,MediaHandlerEvent:Rs,MediaPrefix:$o,MemoryCryptoStore:kf,MemoryStore:gb,Method:$,MsgType:hr,NoAuthFlowFoundError:oI,NotificationCountType:it,OAUTH_AWARE_PREFERRED_FLOW_FIELD:fI,OAuthGrantType:fu,OidcError:kn,OidcTokenRefresher:lL,PUSHER_DEVICE_ID:VD,PUSHER_ENABLED:Rg,PendingEventOrdering:ml,Poll:lw,PollEvent:Pa,Preset:rb,ProfileKeyMSC4175Timezone:JL,ProfileKeyTimezone:WL,PushRuleActionName:ja,PushRuleKind:un,REFERENCE_RELATION:Jk,ReceiptType:On,RelatedRelations:YL,RelationType:Et,Relations:Hy,RelationsEvent:Sh,RestrictedAllowType:GN,Room:Pf,RoomCreateTypeField:zh,RoomEvent:ge,RoomMember:ru,RoomMemberEvent:Hn,RoomNameType:er,RoomState:mu,RoomStateEvent:Ke,RoomSummary:zk,RoomType:Yo,RoomVersionStability:yw,RoomWidgetClient:rI,RoomWidgetClientEvent:wh,RuleId:cn,SERVICE_TYPES:jg,SSOAction:zL,STABLE_MSC4133_EXTENDED_PROFILES:Qw,SUPPORTED_MATRIX_VERSIONS:lu,SearchOrderBy:Mw,SearchResult:Nf,SecretStorage:dx,ServerCapabilities:bw,SetPresence:Ew,SlidingSyncEvent:qg,StatsReport:Wr,SyncAccumulator:aI,SyncState:ct,THREAD_RELATION_TYPE:mt,Thread:_t,ThreadEvent:Mn,ThreadFilterType:Ui,ThreepidMedium:KL,TimelineIndex:ay,TimelineWindow:wL,ToDeviceMessageId:Of,TokenRefreshError:hw,TokenRefreshLogoutError:Yy,TweakName:nb,TypedEventEmitter:Ot,UNSIGNED_MEMBERSHIP_FIELD:Lk,UNSIGNED_THREAD_ID_FIELD:Wh,UNSTABLE_ELEMENT_FUNCTIONAL_USERS:Nk,UNSTABLE_MSC2666_MUTUAL_ROOMS:Yw,UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS:$w,UNSTABLE_MSC2666_SHARED_ROOMS:Jw,UNSTABLE_MSC2716_MARKER:Dk,UNSTABLE_MSC3088_ENABLED:Tg,UNSTABLE_MSC3088_PURPOSE:Eg,UNSTABLE_MSC3089_BRANCH:jr,UNSTABLE_MSC3089_LEAF:Ak,UNSTABLE_MSC3089_TREE_SUBTYPE:_g,UNSTABLE_MSC3852_LAST_SEEN_UA:dL,UNSTABLE_MSC4133_EXTENDED_PROFILES:Xw,UNSTABLE_MSC4140_DELAYED_EVENTS:bn,UNSTABLE_MSC4354_STICKY_EVENTS:ry,UnsupportedDelayedEventsEndpointError:hi,UnsupportedStickyEventsEndpointError:Yg,UpdateDelayedEventAction:Ls,User:$r,UserEvent:ci,Visibility:HN,anySignal:mw,calculateRetryBackoff:pw,completeAuthorizationCodeGrant:aL,createClient:ZL,createNewMatrixCall:ou,createRoomWidgetClient:eU,decodeBase64:xs,decodeIdToken:Hw,determineFeatureSupport:Ch,discoverAndValidateOIDCIssuerWellKnown:vb,encodeBase64:Wc,encodeUnpaddedBase64:eb,encodeUnpaddedBase64Url:Af,fixNotificationCountOnDecryption:Zw,generateAuthorizationParams:tL,generateAuthorizationUrl:nL,generateOidcAuthorizationUrl:iL,generateScope:Uf,getBeaconInfoIdentifier:Yh,getHttpUriForMxc:wf,inMainTimelineForReceipt:vu,isDmMemberCountCondition:LN,isEventTypeSame:a1,isPollEvent:cw,isSendDelayedEventRequestOpts:Qh,isTimestampInDuration:wg,localStorageErrorsEventsEmitter:QL,parseErrorResponse:$y,registerOidcClient:oL,retryNetworkOperation:Mg,safeGetRetryAfterMs:Jy,setCryptoStoreFactory:mI,threadFilterTypeToFilter:eI,threadIdForReceipt:pl,timeoutSignal:Mf,validateAuthMetadata:Kw,validateAuthMetadataAndKeys:mb,validateBearerTokenResponse:Ww,validateIdToken:Gw,validateStoredUserState:zw},Symbol.toStringTag,{value:"Module"}));if(globalThis.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");globalThis.__js_sdk_entrypoint=!0;var oy;try{oy=globalThis.indexedDB}catch{}oy&&mI(()=>new et(oy,"matrix-js-sdk:crypto"));globalThis.matrixcs=tU;var qp={exports:{}},xe={};var JC;function nU(){if(JC)return xe;JC=1;var i=Symbol.for("react.transitional.element"),e=Symbol.for("react.portal"),t=Symbol.for("react.fragment"),n=Symbol.for("react.strict_mode"),r=Symbol.for("react.profiler"),a=Symbol.for("react.consumer"),o=Symbol.for("react.context"),c=Symbol.for("react.forward_ref"),d=Symbol.for("react.suspense"),h=Symbol.for("react.memo"),v=Symbol.for("react.lazy"),m=Symbol.for("react.activity"),y=Symbol.iterator;function E(F){return F===null||typeof F!="object"?null:(F=y&&F[y]||F["@@iterator"],typeof F=="function"?F:null)}var T={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},S=Object.assign,O={};function R(F,ee,de){this.props=F,this.context=ee,this.refs=O,this.updater=de||T}R.prototype.isReactComponent={},R.prototype.setState=function(F,ee){if(typeof F!="object"&&typeof F!="function"&&F!=null)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,F,ee,"setState")},R.prototype.forceUpdate=function(F){this.updater.enqueueForceUpdate(this,F,"forceUpdate")};function I(){}I.prototype=R.prototype;function M(F,ee,de){this.props=F,this.context=ee,this.refs=O,this.updater=de||T}var C=M.prototype=new I;C.constructor=M,S(C,R.prototype),C.isPureReactComponent=!0;var k=Array.isArray;function _(){}var P={H:null,A:null,T:null,S:null},x=Object.prototype.hasOwnProperty;function U(F,ee,de){var pe=de.ref;return{$$typeof:i,type:F,key:ee,ref:pe!==void 0?pe:null,props:de}}function j(F,ee){return U(F.type,ee,F.props)}function K(F){return typeof F=="object"&&F!==null&&F.$$typeof===i}function Z(F){var ee={"=":"=0",":":"=2"};return"$"+F.replace(/[=:]/g,function(de){return ee[de]})}var be=/\/+/g;function Pe(F,ee){return typeof F=="object"&&F!==null&&F.key!=null?Z(""+F.key):ee.toString(36)}function ce(F){switch(F.status){case"fulfilled":return F.value;case"rejected":throw F.reason;default:switch(typeof F.status=="string"?F.then(_,_):(F.status="pending",F.then(function(ee){F.status==="pending"&&(F.status="fulfilled",F.value=ee)},function(ee){F.status==="pending"&&(F.status="rejected",F.reason=ee)})),F.status){case"fulfilled":return F.value;case"rejected":throw F.reason}}throw F}function V(F,ee,de,pe,Re){var Ae=typeof F;(Ae==="undefined"||Ae==="boolean")&&(F=null);var ke=!1;if(F===null)ke=!0;else switch(Ae){case"bigint":case"string":case"number":ke=!0;break;case"object":switch(F.$$typeof){case i:case e:ke=!0;break;case v:return ke=F._init,V(ke(F._payload),ee,de,pe,Re)}}if(ke)return Re=Re(F),ke=pe===""?"."+Pe(F,0):pe,k(Re)?(de="",ke!=null&&(de=ke.replace(be,"$&/")+"/"),V(Re,ee,de,"",function(Ji){return Ji})):Re!=null&&(K(Re)&&(Re=j(Re,de+(Re.key==null||F&&F.key===Re.key?"":(""+Re.key).replace(be,"$&/")+"/")+ke)),ee.push(Re)),1;ke=0;var lt=pe===""?".":pe+":";if(k(F))for(var He=0;He<F.length;He++)pe=F[He],Ae=lt+Pe(pe,He),ke+=V(pe,ee,de,Ae,Re);else if(He=E(F),typeof He=="function")for(F=He.call(F),He=0;!(pe=F.next()).done;)pe=pe.value,Ae=lt+Pe(pe,He++),ke+=V(pe,ee,de,Ae,Re);else if(Ae==="object"){if(typeof F.then=="function")return V(ce(F),ee,de,pe,Re);throw ee=String(F),Error("Objects are not valid as a React child (found: "+(ee==="[object Object]"?"object with keys {"+Object.keys(F).join(", ")+"}":ee)+"). If you meant to render a collection of children, use an array instead.")}return ke}function Q(F,ee,de){if(F==null)return F;var pe=[],Re=0;return V(F,pe,"","",function(Ae){return ee.call(de,Ae,Re++)}),pe}function le(F){if(F._status===-1){var ee=F._result;ee=ee(),ee.then(function(de){(F._status===0||F._status===-1)&&(F._status=1,F._result=de)},function(de){(F._status===0||F._status===-1)&&(F._status=2,F._result=de)}),F._status===-1&&(F._status=0,F._result=ee)}if(F._status===1)return F._result.default;throw F._result}var ve=typeof reportError=="function"?reportError:function(F){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var ee=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof F=="object"&&F!==null&&typeof F.message=="string"?String(F.message):String(F),error:F});if(!window.dispatchEvent(ee))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",F);return}console.error(F)},Te={map:Q,forEach:function(F,ee,de){Q(F,function(){ee.apply(this,arguments)},de)},count:function(F){var ee=0;return Q(F,function(){ee++}),ee},toArray:function(F){return Q(F,function(ee){return ee})||[]},only:function(F){if(!K(F))throw Error("React.Children.only expected to receive a single React element child.");return F}};return xe.Activity=m,xe.Children=Te,xe.Component=R,xe.Fragment=t,xe.Profiler=r,xe.PureComponent=M,xe.StrictMode=n,xe.Suspense=d,xe.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=P,xe.__COMPILER_RUNTIME={__proto__:null,c:function(F){return P.H.useMemoCache(F)}},xe.cache=function(F){return function(){return F.apply(null,arguments)}},xe.cacheSignal=function(){return null},xe.cloneElement=function(F,ee,de){if(F==null)throw Error("The argument must be a React element, but you passed "+F+".");var pe=S({},F.props),Re=F.key;if(ee!=null)for(Ae in ee.key!==void 0&&(Re=""+ee.key),ee)!x.call(ee,Ae)||Ae==="key"||Ae==="__self"||Ae==="__source"||Ae==="ref"&&ee.ref===void 0||(pe[Ae]=ee[Ae]);var Ae=arguments.length-2;if(Ae===1)pe.children=de;else if(1<Ae){for(var ke=Array(Ae),lt=0;lt<Ae;lt++)ke[lt]=arguments[lt+2];pe.children=ke}return U(F.type,Re,pe)},xe.createContext=function(F){return F={$$typeof:o,_currentValue:F,_currentValue2:F,_threadCount:0,Provider:null,Consumer:null},F.Provider=F,F.Consumer={$$typeof:a,_context:F},F},xe.createElement=function(F,ee,de){var pe,Re={},Ae=null;if(ee!=null)for(pe in ee.key!==void 0&&(Ae=""+ee.key),ee)x.call(ee,pe)&&pe!=="key"&&pe!=="__self"&&pe!=="__source"&&(Re[pe]=ee[pe]);var ke=arguments.length-2;if(ke===1)Re.children=de;else if(1<ke){for(var lt=Array(ke),He=0;He<ke;He++)lt[He]=arguments[He+2];Re.children=lt}if(F&&F.defaultProps)for(pe in ke=F.defaultProps,ke)Re[pe]===void 0&&(Re[pe]=ke[pe]);return U(F,Ae,Re)},xe.createRef=function(){return{current:null}},xe.forwardRef=function(F){return{$$typeof:c,render:F}},xe.isValidElement=K,xe.lazy=function(F){return{$$typeof:v,_payload:{_status:-1,_result:F},_init:le}},xe.memo=function(F,ee){return{$$typeof:h,type:F,compare:ee===void 0?null:ee}},xe.startTransition=function(F){var ee=P.T,de={};P.T=de;try{var pe=F(),Re=P.S;Re!==null&&Re(de,pe),typeof pe=="object"&&pe!==null&&typeof pe.then=="function"&&pe.then(_,ve)}catch(Ae){ve(Ae)}finally{ee!==null&&de.types!==null&&(ee.types=de.types),P.T=ee}},xe.unstable_useCacheRefresh=function(){return P.H.useCacheRefresh()},xe.use=function(F){return P.H.use(F)},xe.useActionState=function(F,ee,de){return P.H.useActionState(F,ee,de)},xe.useCallback=function(F,ee){return P.H.useCallback(F,ee)},xe.useContext=function(F){return P.H.useContext(F)},xe.useDebugValue=function(){},xe.useDeferredValue=function(F,ee){return P.H.useDeferredValue(F,ee)},xe.useEffect=function(F,ee){return P.H.useEffect(F,ee)},xe.useEffectEvent=function(F){return P.H.useEffectEvent(F)},xe.useId=function(){return P.H.useId()},xe.useImperativeHandle=function(F,ee,de){return P.H.useImperativeHandle(F,ee,de)},xe.useInsertionEffect=function(F,ee){return P.H.useInsertionEffect(F,ee)},xe.useLayoutEffect=function(F,ee){return P.H.useLayoutEffect(F,ee)},xe.useMemo=function(F,ee){return P.H.useMemo(F,ee)},xe.useOptimistic=function(F,ee){return P.H.useOptimistic(F,ee)},xe.useReducer=function(F,ee,de){return P.H.useReducer(F,ee,de)},xe.useRef=function(F){return P.H.useRef(F)},xe.useState=function(F){return P.H.useState(F)},xe.useSyncExternalStore=function(F,ee,de){return P.H.useSyncExternalStore(F,ee,de)},xe.useTransition=function(){return P.H.useTransition()},xe.version="19.2.3",xe}var YC;function yb(){return YC||(YC=1,qp.exports=nU()),qp.exports}var _e=yb();const iU=Cf(_e),jq=sD({__proto__:null,default:iU},[_e]);var Vp={exports:{}},Dc={},Kp={exports:{}},Hp={};var $C;function rU(){return $C||($C=1,(function(i){function e(V,Q){var le=V.length;V.push(Q);e:for(;0<le;){var ve=le-1>>>1,Te=V[ve];if(0<r(Te,Q))V[ve]=Q,V[le]=Te,le=ve;else break e}}function t(V){return V.length===0?null:V[0]}function n(V){if(V.length===0)return null;var Q=V[0],le=V.pop();if(le!==Q){V[0]=le;e:for(var ve=0,Te=V.length,F=Te>>>1;ve<F;){var ee=2*(ve+1)-1,de=V[ee],pe=ee+1,Re=V[pe];if(0>r(de,le))pe<Te&&0>r(Re,de)?(V[ve]=Re,V[pe]=le,ve=pe):(V[ve]=de,V[ee]=le,ve=ee);else if(pe<Te&&0>r(Re,le))V[ve]=Re,V[pe]=le,ve=pe;else break e}}return Q}function r(V,Q){var le=V.sortIndex-Q.sortIndex;return le!==0?le:V.id-Q.id}if(i.unstable_now=void 0,typeof performance=="object"&&typeof performance.now=="function"){var a=performance;i.unstable_now=function(){return a.now()}}else{var o=Date,c=o.now();i.unstable_now=function(){return o.now()-c}}var d=[],h=[],v=1,m=null,y=3,E=!1,T=!1,S=!1,O=!1,R=typeof setTimeout=="function"?setTimeout:null,I=typeof clearTimeout=="function"?clearTimeout:null,M=typeof setImmediate<"u"?setImmediate:null;function C(V){for(var Q=t(h);Q!==null;){if(Q.callback===null)n(h);else if(Q.startTime<=V)n(h),Q.sortIndex=Q.expirationTime,e(d,Q);else break;Q=t(h)}}function k(V){if(S=!1,C(V),!T)if(t(d)!==null)T=!0,_||(_=!0,Z());else{var Q=t(h);Q!==null&&ce(k,Q.startTime-V)}}var _=!1,P=-1,x=5,U=-1;function j(){return O?!0:!(i.unstable_now()-U<x)}function K(){if(O=!1,_){var V=i.unstable_now();U=V;var Q=!0;try{e:{T=!1,S&&(S=!1,I(P),P=-1),E=!0;var le=y;try{t:{for(C(V),m=t(d);m!==null&&!(m.expirationTime>V&&j());){var ve=m.callback;if(typeof ve=="function"){m.callback=null,y=m.priorityLevel;var Te=ve(m.expirationTime<=V);if(V=i.unstable_now(),typeof Te=="function"){m.callback=Te,C(V),Q=!0;break t}m===t(d)&&n(d),C(V)}else n(d);m=t(d)}if(m!==null)Q=!0;else{var F=t(h);F!==null&&ce(k,F.startTime-V),Q=!1}}break e}finally{m=null,y=le,E=!1}Q=void 0}}finally{Q?Z():_=!1}}}var Z;if(typeof M=="function")Z=function(){M(K)};else if(typeof MessageChannel<"u"){var be=new MessageChannel,Pe=be.port2;be.port1.onmessage=K,Z=function(){Pe.postMessage(null)}}else Z=function(){R(K,0)};function ce(V,Q){P=R(function(){V(i.unstable_now())},Q)}i.unstable_IdlePriority=5,i.unstable_ImmediatePriority=1,i.unstable_LowPriority=4,i.unstable_NormalPriority=3,i.unstable_Profiling=null,i.unstable_UserBlockingPriority=2,i.unstable_cancelCallback=function(V){V.callback=null},i.unstable_forceFrameRate=function(V){0>V||125<V?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):x=0<V?Math.floor(1e3/V):5},i.unstable_getCurrentPriorityLevel=function(){return y},i.unstable_next=function(V){switch(y){case 1:case 2:case 3:var Q=3;break;default:Q=y}var le=y;y=Q;try{return V()}finally{y=le}},i.unstable_requestPaint=function(){O=!0},i.unstable_runWithPriority=function(V,Q){switch(V){case 1:case 2:case 3:case 4:case 5:break;default:V=3}var le=y;y=V;try{return Q()}finally{y=le}},i.unstable_scheduleCallback=function(V,Q,le){var ve=i.unstable_now();switch(typeof le=="object"&&le!==null?(le=le.delay,le=typeof le=="number"&&0<le?ve+le:ve):le=ve,V){case 1:var Te=-1;break;case 2:Te=250;break;case 5:Te=1073741823;break;case 4:Te=1e4;break;default:Te=5e3}return Te=le+Te,V={id:v++,callback:Q,priorityLevel:V,startTime:le,expirationTime:Te,sortIndex:-1},le>ve?(V.sortIndex=le,e(h,V),t(d)===null&&V===t(h)&&(S?(I(P),P=-1):S=!0,ce(k,le-ve))):(V.sortIndex=Te,e(d,V),T||E||(T=!0,_||(_=!0,Z()))),V},i.unstable_shouldYield=j,i.unstable_wrapCallback=function(V){var Q=y;return function(){var le=y;y=Q;try{return V.apply(this,arguments)}finally{y=le}}}})(Hp)),Hp}var XC;function aU(){return XC||(XC=1,Kp.exports=rU()),Kp.exports}var Gp={exports:{}},_n={};var QC;function sU(){if(QC)return _n;QC=1;var i=yb();function e(d){var h="https://react.dev/errors/"+d;if(1<arguments.length){h+="?args[]="+encodeURIComponent(arguments[1]);for(var v=2;v<arguments.length;v++)h+="&args[]="+encodeURIComponent(arguments[v])}return"Minified React error #"+d+"; visit "+h+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function t(){}var n={d:{f:t,r:function(){throw Error(e(522))},D:t,C:t,L:t,m:t,X:t,S:t,M:t},p:0,findDOMNode:null},r=Symbol.for("react.portal");function a(d,h,v){var m=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:r,key:m==null?null:""+m,children:d,containerInfo:h,implementation:v}}var o=i.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;function c(d,h){if(d==="font")return"";if(typeof h=="string")return h==="use-credentials"?h:""}return _n.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=n,_n.createPortal=function(d,h){var v=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!h||h.nodeType!==1&&h.nodeType!==9&&h.nodeType!==11)throw Error(e(299));return a(d,h,null,v)},_n.flushSync=function(d){var h=o.T,v=n.p;try{if(o.T=null,n.p=2,d)return d()}finally{o.T=h,n.p=v,n.d.f()}},_n.preconnect=function(d,h){typeof d=="string"&&(h?(h=h.crossOrigin,h=typeof h=="string"?h==="use-credentials"?h:"":void 0):h=null,n.d.C(d,h))},_n.prefetchDNS=function(d){typeof d=="string"&&n.d.D(d)},_n.preinit=function(d,h){if(typeof d=="string"&&h&&typeof h.as=="string"){var v=h.as,m=c(v,h.crossOrigin),y=typeof h.integrity=="string"?h.integrity:void 0,E=typeof h.fetchPriority=="string"?h.fetchPriority:void 0;v==="style"?n.d.S(d,typeof h.precedence=="string"?h.precedence:void 0,{crossOrigin:m,integrity:y,fetchPriority:E}):v==="script"&&n.d.X(d,{crossOrigin:m,integrity:y,fetchPriority:E,nonce:typeof h.nonce=="string"?h.nonce:void 0})}},_n.preinitModule=function(d,h){if(typeof d=="string")if(typeof h=="object"&&h!==null){if(h.as==null||h.as==="script"){var v=c(h.as,h.crossOrigin);n.d.M(d,{crossOrigin:v,integrity:typeof h.integrity=="string"?h.integrity:void 0,nonce:typeof h.nonce=="string"?h.nonce:void 0})}}else h==null&&n.d.M(d)},_n.preload=function(d,h){if(typeof d=="string"&&typeof h=="object"&&h!==null&&typeof h.as=="string"){var v=h.as,m=c(v,h.crossOrigin);n.d.L(d,v,{crossOrigin:m,integrity:typeof h.integrity=="string"?h.integrity:void 0,nonce:typeof h.nonce=="string"?h.nonce:void 0,type:typeof h.type=="string"?h.type:void 0,fetchPriority:typeof h.fetchPriority=="string"?h.fetchPriority:void 0,referrerPolicy:typeof h.referrerPolicy=="string"?h.referrerPolicy:void 0,imageSrcSet:typeof h.imageSrcSet=="string"?h.imageSrcSet:void 0,imageSizes:typeof h.imageSizes=="string"?h.imageSizes:void 0,media:typeof h.media=="string"?h.media:void 0})}},_n.preloadModule=function(d,h){if(typeof d=="string")if(h){var v=c(h.as,h.crossOrigin);n.d.m(d,{as:typeof h.as=="string"&&h.as!=="script"?h.as:void 0,crossOrigin:v,integrity:typeof h.integrity=="string"?h.integrity:void 0})}else n.d.m(d)},_n.requestFormReset=function(d){n.d.r(d)},_n.unstable_batchedUpdates=function(d,h){return d(h)},_n.useFormState=function(d,h,v){return o.H.useFormState(d,h,v)},_n.useFormStatus=function(){return o.H.useHostTransitionStatus()},_n.version="19.2.3",_n}var ZC;function oU(){if(ZC)return Gp.exports;ZC=1;function i(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(i)}catch(e){console.error(e)}}return i(),Gp.exports=sU(),Gp.exports}var eR;function lU(){if(eR)return Dc;eR=1;var i=aU(),e=yb(),t=oU();function n(s){var l="https://react.dev/errors/"+s;if(1<arguments.length){l+="?args[]="+encodeURIComponent(arguments[1]);for(var u=2;u<arguments.length;u++)l+="&args[]="+encodeURIComponent(arguments[u])}return"Minified React error #"+s+"; visit "+l+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function r(s){return!(!s||s.nodeType!==1&&s.nodeType!==9&&s.nodeType!==11)}function a(s){var l=s,u=s;if(s.alternate)for(;l.return;)l=l.return;else{s=l;do l=s,(l.flags&4098)!==0&&(u=l.return),s=l.return;while(s)}return l.tag===3?u:null}function o(s){if(s.tag===13){var l=s.memoizedState;if(l===null&&(s=s.alternate,s!==null&&(l=s.memoizedState)),l!==null)return l.dehydrated}return null}function c(s){if(s.tag===31){var l=s.memoizedState;if(l===null&&(s=s.alternate,s!==null&&(l=s.memoizedState)),l!==null)return l.dehydrated}return null}function d(s){if(a(s)!==s)throw Error(n(188))}function h(s){var l=s.alternate;if(!l){if(l=a(s),l===null)throw Error(n(188));return l!==s?null:s}for(var u=s,f=l;;){var p=u.return;if(p===null)break;var g=p.alternate;if(g===null){if(f=p.return,f!==null){u=f;continue}break}if(p.child===g.child){for(g=p.child;g;){if(g===u)return d(p),s;if(g===f)return d(p),l;g=g.sibling}throw Error(n(188))}if(u.return!==f.return)u=p,f=g;else{for(var w=!1,N=p.child;N;){if(N===u){w=!0,u=p,f=g;break}if(N===f){w=!0,f=p,u=g;break}N=N.sibling}if(!w){for(N=g.child;N;){if(N===u){w=!0,u=g,f=p;break}if(N===f){w=!0,f=g,u=p;break}N=N.sibling}if(!w)throw Error(n(189))}}if(u.alternate!==f)throw Error(n(190))}if(u.tag!==3)throw Error(n(188));return u.stateNode.current===u?s:l}function v(s){var l=s.tag;if(l===5||l===26||l===27||l===6)return s;for(s=s.child;s!==null;){if(l=v(s),l!==null)return l;s=s.sibling}return null}var m=Object.assign,y=Symbol.for("react.element"),E=Symbol.for("react.transitional.element"),T=Symbol.for("react.portal"),S=Symbol.for("react.fragment"),O=Symbol.for("react.strict_mode"),R=Symbol.for("react.profiler"),I=Symbol.for("react.consumer"),M=Symbol.for("react.context"),C=Symbol.for("react.forward_ref"),k=Symbol.for("react.suspense"),_=Symbol.for("react.suspense_list"),P=Symbol.for("react.memo"),x=Symbol.for("react.lazy"),U=Symbol.for("react.activity"),j=Symbol.for("react.memo_cache_sentinel"),K=Symbol.iterator;function Z(s){return s===null||typeof s!="object"?null:(s=K&&s[K]||s["@@iterator"],typeof s=="function"?s:null)}var be=Symbol.for("react.client.reference");function Pe(s){if(s==null)return null;if(typeof s=="function")return s.$$typeof===be?null:s.displayName||s.name||null;if(typeof s=="string")return s;switch(s){case S:return"Fragment";case R:return"Profiler";case O:return"StrictMode";case k:return"Suspense";case _:return"SuspenseList";case U:return"Activity"}if(typeof s=="object")switch(s.$$typeof){case T:return"Portal";case M:return s.displayName||"Context";case I:return(s._context.displayName||"Context")+".Consumer";case C:var l=s.render;return s=s.displayName,s||(s=l.displayName||l.name||"",s=s!==""?"ForwardRef("+s+")":"ForwardRef"),s;case P:return l=s.displayName||null,l!==null?l:Pe(s.type)||"Memo";case x:l=s._payload,s=s._init;try{return Pe(s(l))}catch{}}return null}var ce=Array.isArray,V=e.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,Q=t.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,le={pending:!1,data:null,method:null,action:null},ve=[],Te=-1;function F(s){return{current:s}}function ee(s){0>Te||(s.current=ve[Te],ve[Te]=null,Te--)}function de(s,l){Te++,ve[Te]=s.current,s.current=l}var pe=F(null),Re=F(null),Ae=F(null),ke=F(null);function lt(s,l){switch(de(Ae,l),de(Re,s),de(pe,null),l.nodeType){case 9:case 11:s=(s=l.documentElement)&&(s=s.namespaceURI)?gT(s):0;break;default:if(s=l.tagName,l=l.namespaceURI)l=gT(l),s=yT(l,s);else switch(s){case"svg":s=1;break;case"math":s=2;break;default:s=0}}ee(pe),de(pe,s)}function He(){ee(pe),ee(Re),ee(Ae)}function Ji(s){s.memoizedState!==null&&de(ke,s);var l=pe.current,u=yT(l,s.type);l!==u&&(de(Re,s),de(pe,u))}function xu(s){Re.current===s&&(ee(pe),ee(Re)),ke.current===s&&(ee(ke),fc._currentValue=le)}var $f,Wb;function Xa(s){if($f===void 0)try{throw Error()}catch(u){var l=u.stack.trim().match(/\n( *(at )?)/);$f=l&&l[1]||"",Wb=-1<u.stack.indexOf(`
    at`)?" (<anonymous>)":-1<u.stack.indexOf("@")?"@unknown:0:0":""}return`
`+$f+s+Wb}var Xf=!1;function Qf(s,l){if(!s||Xf)return"";Xf=!0;var u=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{var f={DetermineComponentFrameRoot:function(){try{if(l){var re=function(){throw Error()};if(Object.defineProperty(re.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(re,[])}catch(X){var Y=X}Reflect.construct(s,[],re)}else{try{re.call()}catch(X){Y=X}s.call(re.prototype)}}else{try{throw Error()}catch(X){Y=X}(re=s())&&typeof re.catch=="function"&&re.catch(function(){})}}catch(X){if(X&&Y&&typeof X.stack=="string")return[X.stack,Y.stack]}return[null,null]}};f.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var p=Object.getOwnPropertyDescriptor(f.DetermineComponentFrameRoot,"name");p&&p.configurable&&Object.defineProperty(f.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var g=f.DetermineComponentFrameRoot(),w=g[0],N=g[1];if(w&&N){var B=w.split(`
`),W=N.split(`
`);for(p=f=0;f<B.length&&!B[f].includes("DetermineComponentFrameRoot");)f++;for(;p<W.length&&!W[p].includes("DetermineComponentFrameRoot");)p++;if(f===B.length||p===W.length)for(f=B.length-1,p=W.length-1;1<=f&&0<=p&&B[f]!==W[p];)p--;for(;1<=f&&0<=p;f--,p--)if(B[f]!==W[p]){if(f!==1||p!==1)do if(f--,p--,0>p||B[f]!==W[p]){var ne=`
`+B[f].replace(" at new "," at ");return s.displayName&&ne.includes("<anonymous>")&&(ne=ne.replace("<anonymous>",s.displayName)),ne}while(1<=f&&0<=p);break}}}finally{Xf=!1,Error.prepareStackTrace=u}return(u=s?s.displayName||s.name:"")?Xa(u):""}function UM(s,l){switch(s.tag){case 26:case 27:case 5:return Xa(s.type);case 16:return Xa("Lazy");case 13:return s.child!==l&&l!==null?Xa("Suspense Fallback"):Xa("Suspense");case 19:return Xa("SuspenseList");case 0:case 15:return Qf(s.type,!1);case 11:return Qf(s.type.render,!1);case 1:return Qf(s.type,!0);case 31:return Xa("Activity");default:return""}}function Jb(s){try{var l="",u=null;do l+=UM(s,u),u=s,s=s.return;while(s);return l}catch(f){return`
Error generating stack: `+f.message+`
`+f.stack}}var Zf=Object.prototype.hasOwnProperty,ev=i.unstable_scheduleCallback,tv=i.unstable_cancelCallback,BM=i.unstable_shouldYield,FM=i.unstable_requestPaint,Jn=i.unstable_now,jM=i.unstable_getCurrentPriorityLevel,Yb=i.unstable_ImmediatePriority,$b=i.unstable_UserBlockingPriority,Lu=i.unstable_NormalPriority,qM=i.unstable_LowPriority,Xb=i.unstable_IdlePriority,VM=i.log,KM=i.unstable_setDisableYieldValue,Rl=null,Yn=null;function ea(s){if(typeof VM=="function"&&KM(s),Yn&&typeof Yn.setStrictMode=="function")try{Yn.setStrictMode(Rl,s)}catch{}}var $n=Math.clz32?Math.clz32:zM,HM=Math.log,GM=Math.LN2;function zM(s){return s>>>=0,s===0?32:31-(HM(s)/GM|0)|0}var Uu=256,Bu=262144,Fu=4194304;function Qa(s){var l=s&42;if(l!==0)return l;switch(s&-s){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:return 64;case 128:return 128;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:return s&261888;case 262144:case 524288:case 1048576:case 2097152:return s&3932160;case 4194304:case 8388608:case 16777216:case 33554432:return s&62914560;case 67108864:return 67108864;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 0;default:return s}}function ju(s,l,u){var f=s.pendingLanes;if(f===0)return 0;var p=0,g=s.suspendedLanes,w=s.pingedLanes;s=s.warmLanes;var N=f&134217727;return N!==0?(f=N&~g,f!==0?p=Qa(f):(w&=N,w!==0?p=Qa(w):u||(u=N&~s,u!==0&&(p=Qa(u))))):(N=f&~g,N!==0?p=Qa(N):w!==0?p=Qa(w):u||(u=f&~s,u!==0&&(p=Qa(u)))),p===0?0:l!==0&&l!==p&&(l&g)===0&&(g=p&-p,u=l&-l,g>=u||g===32&&(u&4194048)!==0)?l:p}function kl(s,l){return(s.pendingLanes&~(s.suspendedLanes&~s.pingedLanes)&l)===0}function WM(s,l){switch(s){case 1:case 2:case 4:case 8:case 64:return l+250;case 16:case 32:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return l+5e3;case 4194304:case 8388608:case 16777216:case 33554432:return-1;case 67108864:case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function Qb(){var s=Fu;return Fu<<=1,(Fu&62914560)===0&&(Fu=4194304),s}function nv(s){for(var l=[],u=0;31>u;u++)l.push(s);return l}function wl(s,l){s.pendingLanes|=l,l!==268435456&&(s.suspendedLanes=0,s.pingedLanes=0,s.warmLanes=0)}function JM(s,l,u,f,p,g){var w=s.pendingLanes;s.pendingLanes=u,s.suspendedLanes=0,s.pingedLanes=0,s.warmLanes=0,s.expiredLanes&=u,s.entangledLanes&=u,s.errorRecoveryDisabledLanes&=u,s.shellSuspendCounter=0;var N=s.entanglements,B=s.expirationTimes,W=s.hiddenUpdates;for(u=w&~u;0<u;){var ne=31-$n(u),re=1<<ne;N[ne]=0,B[ne]=-1;var Y=W[ne];if(Y!==null)for(W[ne]=null,ne=0;ne<Y.length;ne++){var X=Y[ne];X!==null&&(X.lane&=-536870913)}u&=~re}f!==0&&Zb(s,f,0),g!==0&&p===0&&s.tag!==0&&(s.suspendedLanes|=g&~(w&~l))}function Zb(s,l,u){s.pendingLanes|=l,s.suspendedLanes&=~l;var f=31-$n(l);s.entangledLanes|=l,s.entanglements[f]=s.entanglements[f]|1073741824|u&261930}function eS(s,l){var u=s.entangledLanes|=l;for(s=s.entanglements;u;){var f=31-$n(u),p=1<<f;p&l|s[f]&l&&(s[f]|=l),u&=~p}}function tS(s,l){var u=l&-l;return u=(u&42)!==0?1:iv(u),(u&(s.suspendedLanes|l))!==0?0:u}function iv(s){switch(s){case 2:s=1;break;case 8:s=4;break;case 32:s=16;break;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:s=128;break;case 268435456:s=134217728;break;default:s=0}return s}function rv(s){return s&=-s,2<s?8<s?(s&134217727)!==0?32:268435456:8:2}function nS(){var s=Q.p;return s!==0?s:(s=window.event,s===void 0?32:qT(s.type))}function iS(s,l){var u=Q.p;try{return Q.p=s,l()}finally{Q.p=u}}var ta=Math.random().toString(36).slice(2),fn="__reactFiber$"+ta,Nn="__reactProps$"+ta,Ws="__reactContainer$"+ta,av="__reactEvents$"+ta,YM="__reactListeners$"+ta,$M="__reactHandles$"+ta,rS="__reactResources$"+ta,Il="__reactMarker$"+ta;function sv(s){delete s[fn],delete s[Nn],delete s[av],delete s[YM],delete s[$M]}function Js(s){var l=s[fn];if(l)return l;for(var u=s.parentNode;u;){if(l=u[Ws]||u[fn]){if(u=l.alternate,l.child!==null||u!==null&&u.child!==null)for(s=RT(s);s!==null;){if(u=s[fn])return u;s=RT(s)}return l}s=u,u=s.parentNode}return null}function Ys(s){if(s=s[fn]||s[Ws]){var l=s.tag;if(l===5||l===6||l===13||l===31||l===26||l===27||l===3)return s}return null}function Ol(s){var l=s.tag;if(l===5||l===26||l===27||l===6)return s.stateNode;throw Error(n(33))}function $s(s){var l=s[rS];return l||(l=s[rS]={hoistableStyles:new Map,hoistableScripts:new Map}),l}function sn(s){s[Il]=!0}var aS=new Set,sS={};function Za(s,l){Xs(s,l),Xs(s+"Capture",l)}function Xs(s,l){for(sS[s]=l,s=0;s<l.length;s++)aS.add(l[s])}var XM=RegExp("^[:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD][:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*$"),oS={},lS={};function QM(s){return Zf.call(lS,s)?!0:Zf.call(oS,s)?!1:XM.test(s)?lS[s]=!0:(oS[s]=!0,!1)}function qu(s,l,u){if(QM(l))if(u===null)s.removeAttribute(l);else{switch(typeof u){case"undefined":case"function":case"symbol":s.removeAttribute(l);return;case"boolean":var f=l.toLowerCase().slice(0,5);if(f!=="data-"&&f!=="aria-"){s.removeAttribute(l);return}}s.setAttribute(l,""+u)}}function Vu(s,l,u){if(u===null)s.removeAttribute(l);else{switch(typeof u){case"undefined":case"function":case"symbol":case"boolean":s.removeAttribute(l);return}s.setAttribute(l,""+u)}}function mr(s,l,u,f){if(f===null)s.removeAttribute(u);else{switch(typeof f){case"undefined":case"function":case"symbol":case"boolean":s.removeAttribute(u);return}s.setAttributeNS(l,u,""+f)}}function mi(s){switch(typeof s){case"bigint":case"boolean":case"number":case"string":case"undefined":return s;case"object":return s;default:return""}}function cS(s){var l=s.type;return(s=s.nodeName)&&s.toLowerCase()==="input"&&(l==="checkbox"||l==="radio")}function ZM(s,l,u){var f=Object.getOwnPropertyDescriptor(s.constructor.prototype,l);if(!s.hasOwnProperty(l)&&typeof f<"u"&&typeof f.get=="function"&&typeof f.set=="function"){var p=f.get,g=f.set;return Object.defineProperty(s,l,{configurable:!0,get:function(){return p.call(this)},set:function(w){u=""+w,g.call(this,w)}}),Object.defineProperty(s,l,{enumerable:f.enumerable}),{getValue:function(){return u},setValue:function(w){u=""+w},stopTracking:function(){s._valueTracker=null,delete s[l]}}}}function ov(s){if(!s._valueTracker){var l=cS(s)?"checked":"value";s._valueTracker=ZM(s,l,""+s[l])}}function uS(s){if(!s)return!1;var l=s._valueTracker;if(!l)return!0;var u=l.getValue(),f="";return s&&(f=cS(s)?s.checked?"true":"false":s.value),s=f,s!==u?(l.setValue(s),!0):!1}function Ku(s){if(s=s||(typeof document<"u"?document:void 0),typeof s>"u")return null;try{return s.activeElement||s.body}catch{return s.body}}var eP=/[\n"\\]/g;function pi(s){return s.replace(eP,function(l){return"\\"+l.charCodeAt(0).toString(16)+" "})}function lv(s,l,u,f,p,g,w,N){s.name="",w!=null&&typeof w!="function"&&typeof w!="symbol"&&typeof w!="boolean"?s.type=w:s.removeAttribute("type"),l!=null?w==="number"?(l===0&&s.value===""||s.value!=l)&&(s.value=""+mi(l)):s.value!==""+mi(l)&&(s.value=""+mi(l)):w!=="submit"&&w!=="reset"||s.removeAttribute("value"),l!=null?cv(s,w,mi(l)):u!=null?cv(s,w,mi(u)):f!=null&&s.removeAttribute("value"),p==null&&g!=null&&(s.defaultChecked=!!g),p!=null&&(s.checked=p&&typeof p!="function"&&typeof p!="symbol"),N!=null&&typeof N!="function"&&typeof N!="symbol"&&typeof N!="boolean"?s.name=""+mi(N):s.removeAttribute("name")}function dS(s,l,u,f,p,g,w,N){if(g!=null&&typeof g!="function"&&typeof g!="symbol"&&typeof g!="boolean"&&(s.type=g),l!=null||u!=null){if(!(g!=="submit"&&g!=="reset"||l!=null)){ov(s);return}u=u!=null?""+mi(u):"",l=l!=null?""+mi(l):u,N||l===s.value||(s.value=l),s.defaultValue=l}f=f??p,f=typeof f!="function"&&typeof f!="symbol"&&!!f,s.checked=N?s.checked:!!f,s.defaultChecked=!!f,w!=null&&typeof w!="function"&&typeof w!="symbol"&&typeof w!="boolean"&&(s.name=w),ov(s)}function cv(s,l,u){l==="number"&&Ku(s.ownerDocument)===s||s.defaultValue===""+u||(s.defaultValue=""+u)}function Qs(s,l,u,f){if(s=s.options,l){l={};for(var p=0;p<u.length;p++)l["$"+u[p]]=!0;for(u=0;u<s.length;u++)p=l.hasOwnProperty("$"+s[u].value),s[u].selected!==p&&(s[u].selected=p),p&&f&&(s[u].defaultSelected=!0)}else{for(u=""+mi(u),l=null,p=0;p<s.length;p++){if(s[p].value===u){s[p].selected=!0,f&&(s[p].defaultSelected=!0);return}l!==null||s[p].disabled||(l=s[p])}l!==null&&(l.selected=!0)}}function hS(s,l,u){if(l!=null&&(l=""+mi(l),l!==s.value&&(s.value=l),u==null)){s.defaultValue!==l&&(s.defaultValue=l);return}s.defaultValue=u!=null?""+mi(u):""}function fS(s,l,u,f){if(l==null){if(f!=null){if(u!=null)throw Error(n(92));if(ce(f)){if(1<f.length)throw Error(n(93));f=f[0]}u=f}u==null&&(u=""),l=u}u=mi(l),s.defaultValue=u,f=s.textContent,f===u&&f!==""&&f!==null&&(s.value=f),ov(s)}function Zs(s,l){if(l){var u=s.firstChild;if(u&&u===s.lastChild&&u.nodeType===3){u.nodeValue=l;return}}s.textContent=l}var tP=new Set("animationIterationCount aspectRatio borderImageOutset borderImageSlice borderImageWidth boxFlex boxFlexGroup boxOrdinalGroup columnCount columns flex flexGrow flexPositive flexShrink flexNegative flexOrder gridArea gridRow gridRowEnd gridRowSpan gridRowStart gridColumn gridColumnEnd gridColumnSpan gridColumnStart fontWeight lineClamp lineHeight opacity order orphans scale tabSize widows zIndex zoom fillOpacity floodOpacity stopOpacity strokeDasharray strokeDashoffset strokeMiterlimit strokeOpacity strokeWidth MozAnimationIterationCount MozBoxFlex MozBoxFlexGroup MozLineClamp msAnimationIterationCount msFlex msZoom msFlexGrow msFlexNegative msFlexOrder msFlexPositive msFlexShrink msGridColumn msGridColumnSpan msGridRow msGridRowSpan WebkitAnimationIterationCount WebkitBoxFlex WebKitBoxFlexGroup WebkitBoxOrdinalGroup WebkitColumnCount WebkitColumns WebkitFlex WebkitFlexGrow WebkitFlexPositive WebkitFlexShrink WebkitLineClamp".split(" "));function vS(s,l,u){var f=l.indexOf("--")===0;u==null||typeof u=="boolean"||u===""?f?s.setProperty(l,""):l==="float"?s.cssFloat="":s[l]="":f?s.setProperty(l,u):typeof u!="number"||u===0||tP.has(l)?l==="float"?s.cssFloat=u:s[l]=(""+u).trim():s[l]=u+"px"}function mS(s,l,u){if(l!=null&&typeof l!="object")throw Error(n(62));if(s=s.style,u!=null){for(var f in u)!u.hasOwnProperty(f)||l!=null&&l.hasOwnProperty(f)||(f.indexOf("--")===0?s.setProperty(f,""):f==="float"?s.cssFloat="":s[f]="");for(var p in l)f=l[p],l.hasOwnProperty(p)&&u[p]!==f&&vS(s,p,f)}else for(var g in l)l.hasOwnProperty(g)&&vS(s,g,l[g])}function uv(s){if(s.indexOf("-")===-1)return!1;switch(s){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var nP=new Map([["acceptCharset","accept-charset"],["htmlFor","for"],["httpEquiv","http-equiv"],["crossOrigin","crossorigin"],["accentHeight","accent-height"],["alignmentBaseline","alignment-baseline"],["arabicForm","arabic-form"],["baselineShift","baseline-shift"],["capHeight","cap-height"],["clipPath","clip-path"],["clipRule","clip-rule"],["colorInterpolation","color-interpolation"],["colorInterpolationFilters","color-interpolation-filters"],["colorProfile","color-profile"],["colorRendering","color-rendering"],["dominantBaseline","dominant-baseline"],["enableBackground","enable-background"],["fillOpacity","fill-opacity"],["fillRule","fill-rule"],["floodColor","flood-color"],["floodOpacity","flood-opacity"],["fontFamily","font-family"],["fontSize","font-size"],["fontSizeAdjust","font-size-adjust"],["fontStretch","font-stretch"],["fontStyle","font-style"],["fontVariant","font-variant"],["fontWeight","font-weight"],["glyphName","glyph-name"],["glyphOrientationHorizontal","glyph-orientation-horizontal"],["glyphOrientationVertical","glyph-orientation-vertical"],["horizAdvX","horiz-adv-x"],["horizOriginX","horiz-origin-x"],["imageRendering","image-rendering"],["letterSpacing","letter-spacing"],["lightingColor","lighting-color"],["markerEnd","marker-end"],["markerMid","marker-mid"],["markerStart","marker-start"],["overlinePosition","overline-position"],["overlineThickness","overline-thickness"],["paintOrder","paint-order"],["panose-1","panose-1"],["pointerEvents","pointer-events"],["renderingIntent","rendering-intent"],["shapeRendering","shape-rendering"],["stopColor","stop-color"],["stopOpacity","stop-opacity"],["strikethroughPosition","strikethrough-position"],["strikethroughThickness","strikethrough-thickness"],["strokeDasharray","stroke-dasharray"],["strokeDashoffset","stroke-dashoffset"],["strokeLinecap","stroke-linecap"],["strokeLinejoin","stroke-linejoin"],["strokeMiterlimit","stroke-miterlimit"],["strokeOpacity","stroke-opacity"],["strokeWidth","stroke-width"],["textAnchor","text-anchor"],["textDecoration","text-decoration"],["textRendering","text-rendering"],["transformOrigin","transform-origin"],["underlinePosition","underline-position"],["underlineThickness","underline-thickness"],["unicodeBidi","unicode-bidi"],["unicodeRange","unicode-range"],["unitsPerEm","units-per-em"],["vAlphabetic","v-alphabetic"],["vHanging","v-hanging"],["vIdeographic","v-ideographic"],["vMathematical","v-mathematical"],["vectorEffect","vector-effect"],["vertAdvY","vert-adv-y"],["vertOriginX","vert-origin-x"],["vertOriginY","vert-origin-y"],["wordSpacing","word-spacing"],["writingMode","writing-mode"],["xmlnsXlink","xmlns:xlink"],["xHeight","x-height"]]),iP=/^[\u0000-\u001F ]*j[\r\n\t]*a[\r\n\t]*v[\r\n\t]*a[\r\n\t]*s[\r\n\t]*c[\r\n\t]*r[\r\n\t]*i[\r\n\t]*p[\r\n\t]*t[\r\n\t]*:/i;function Hu(s){return iP.test(""+s)?"javascript:throw new Error('React has blocked a javascript: URL as a security precaution.')":s}function pr(){}var dv=null;function hv(s){return s=s.target||s.srcElement||window,s.correspondingUseElement&&(s=s.correspondingUseElement),s.nodeType===3?s.parentNode:s}var eo=null,to=null;function pS(s){var l=Ys(s);if(l&&(s=l.stateNode)){var u=s[Nn]||null;e:switch(s=l.stateNode,l.type){case"input":if(lv(s,u.value,u.defaultValue,u.defaultValue,u.checked,u.defaultChecked,u.type,u.name),l=u.name,u.type==="radio"&&l!=null){for(u=s;u.parentNode;)u=u.parentNode;for(u=u.querySelectorAll('input[name="'+pi(""+l)+'"][type="radio"]'),l=0;l<u.length;l++){var f=u[l];if(f!==s&&f.form===s.form){var p=f[Nn]||null;if(!p)throw Error(n(90));lv(f,p.value,p.defaultValue,p.defaultValue,p.checked,p.defaultChecked,p.type,p.name)}}for(l=0;l<u.length;l++)f=u[l],f.form===s.form&&uS(f)}break e;case"textarea":hS(s,u.value,u.defaultValue);break e;case"select":l=u.value,l!=null&&Qs(s,!!u.multiple,l,!1)}}}var fv=!1;function gS(s,l,u){if(fv)return s(l,u);fv=!0;try{var f=s(l);return f}finally{if(fv=!1,(eo!==null||to!==null)&&(Pd(),eo&&(l=eo,s=to,to=eo=null,pS(l),s)))for(l=0;l<s.length;l++)pS(s[l])}}function Ml(s,l){var u=s.stateNode;if(u===null)return null;var f=u[Nn]||null;if(f===null)return null;u=f[l];e:switch(l){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(f=!f.disabled)||(s=s.type,f=!(s==="button"||s==="input"||s==="select"||s==="textarea")),s=!f;break e;default:s=!1}if(s)return null;if(u&&typeof u!="function")throw Error(n(231,l,typeof u));return u}var gr=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),vv=!1;if(gr)try{var Pl={};Object.defineProperty(Pl,"passive",{get:function(){vv=!0}}),window.addEventListener("test",Pl,Pl),window.removeEventListener("test",Pl,Pl)}catch{vv=!1}var na=null,mv=null,Gu=null;function yS(){if(Gu)return Gu;var s,l=mv,u=l.length,f,p="value"in na?na.value:na.textContent,g=p.length;for(s=0;s<u&&l[s]===p[s];s++);var w=u-s;for(f=1;f<=w&&l[u-f]===p[g-f];f++);return Gu=p.slice(s,1<f?1-f:void 0)}function zu(s){var l=s.keyCode;return"charCode"in s?(s=s.charCode,s===0&&l===13&&(s=13)):s=l,s===10&&(s=13),32<=s||s===13?s:0}function Wu(){return!0}function bS(){return!1}function xn(s){function l(u,f,p,g,w){this._reactName=u,this._targetInst=p,this.type=f,this.nativeEvent=g,this.target=w,this.currentTarget=null;for(var N in s)s.hasOwnProperty(N)&&(u=s[N],this[N]=u?u(g):g[N]);return this.isDefaultPrevented=(g.defaultPrevented!=null?g.defaultPrevented:g.returnValue===!1)?Wu:bS,this.isPropagationStopped=bS,this}return m(l.prototype,{preventDefault:function(){this.defaultPrevented=!0;var u=this.nativeEvent;u&&(u.preventDefault?u.preventDefault():typeof u.returnValue!="unknown"&&(u.returnValue=!1),this.isDefaultPrevented=Wu)},stopPropagation:function(){var u=this.nativeEvent;u&&(u.stopPropagation?u.stopPropagation():typeof u.cancelBubble!="unknown"&&(u.cancelBubble=!0),this.isPropagationStopped=Wu)},persist:function(){},isPersistent:Wu}),l}var es={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(s){return s.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},Ju=xn(es),Al=m({},es,{view:0,detail:0}),rP=xn(Al),pv,gv,Dl,Yu=m({},Al,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:bv,button:0,buttons:0,relatedTarget:function(s){return s.relatedTarget===void 0?s.fromElement===s.srcElement?s.toElement:s.fromElement:s.relatedTarget},movementX:function(s){return"movementX"in s?s.movementX:(s!==Dl&&(Dl&&s.type==="mousemove"?(pv=s.screenX-Dl.screenX,gv=s.screenY-Dl.screenY):gv=pv=0,Dl=s),pv)},movementY:function(s){return"movementY"in s?s.movementY:gv}}),SS=xn(Yu),aP=m({},Yu,{dataTransfer:0}),sP=xn(aP),oP=m({},Al,{relatedTarget:0}),yv=xn(oP),lP=m({},es,{animationName:0,elapsedTime:0,pseudoElement:0}),cP=xn(lP),uP=m({},es,{clipboardData:function(s){return"clipboardData"in s?s.clipboardData:window.clipboardData}}),dP=xn(uP),hP=m({},es,{data:0}),ES=xn(hP),fP={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},vP={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},mP={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function pP(s){var l=this.nativeEvent;return l.getModifierState?l.getModifierState(s):(s=mP[s])?!!l[s]:!1}function bv(){return pP}var gP=m({},Al,{key:function(s){if(s.key){var l=fP[s.key]||s.key;if(l!=="Unidentified")return l}return s.type==="keypress"?(s=zu(s),s===13?"Enter":String.fromCharCode(s)):s.type==="keydown"||s.type==="keyup"?vP[s.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:bv,charCode:function(s){return s.type==="keypress"?zu(s):0},keyCode:function(s){return s.type==="keydown"||s.type==="keyup"?s.keyCode:0},which:function(s){return s.type==="keypress"?zu(s):s.type==="keydown"||s.type==="keyup"?s.keyCode:0}}),yP=xn(gP),bP=m({},Yu,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),TS=xn(bP),SP=m({},Al,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:bv}),EP=xn(SP),TP=m({},es,{propertyName:0,elapsedTime:0,pseudoElement:0}),_P=xn(TP),CP=m({},Yu,{deltaX:function(s){return"deltaX"in s?s.deltaX:"wheelDeltaX"in s?-s.wheelDeltaX:0},deltaY:function(s){return"deltaY"in s?s.deltaY:"wheelDeltaY"in s?-s.wheelDeltaY:"wheelDelta"in s?-s.wheelDelta:0},deltaZ:0,deltaMode:0}),RP=xn(CP),kP=m({},es,{newState:0,oldState:0}),wP=xn(kP),IP=[9,13,27,32],Sv=gr&&"CompositionEvent"in window,Nl=null;gr&&"documentMode"in document&&(Nl=document.documentMode);var OP=gr&&"TextEvent"in window&&!Nl,_S=gr&&(!Sv||Nl&&8<Nl&&11>=Nl),CS=" ",RS=!1;function kS(s,l){switch(s){case"keyup":return IP.indexOf(l.keyCode)!==-1;case"keydown":return l.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function wS(s){return s=s.detail,typeof s=="object"&&"data"in s?s.data:null}var no=!1;function MP(s,l){switch(s){case"compositionend":return wS(l);case"keypress":return l.which!==32?null:(RS=!0,CS);case"textInput":return s=l.data,s===CS&&RS?null:s;default:return null}}function PP(s,l){if(no)return s==="compositionend"||!Sv&&kS(s,l)?(s=yS(),Gu=mv=na=null,no=!1,s):null;switch(s){case"paste":return null;case"keypress":if(!(l.ctrlKey||l.altKey||l.metaKey)||l.ctrlKey&&l.altKey){if(l.char&&1<l.char.length)return l.char;if(l.which)return String.fromCharCode(l.which)}return null;case"compositionend":return _S&&l.locale!=="ko"?null:l.data;default:return null}}var AP={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function IS(s){var l=s&&s.nodeName&&s.nodeName.toLowerCase();return l==="input"?!!AP[s.type]:l==="textarea"}function OS(s,l,u,f){eo?to?to.push(f):to=[f]:eo=f,l=Bd(l,"onChange"),0<l.length&&(u=new Ju("onChange","change",null,u,f),s.push({event:u,listeners:l}))}var xl=null,Ll=null;function DP(s){dT(s,0)}function $u(s){var l=Ol(s);if(uS(l))return s}function MS(s,l){if(s==="change")return l}var PS=!1;if(gr){var Ev;if(gr){var Tv="oninput"in document;if(!Tv){var AS=document.createElement("div");AS.setAttribute("oninput","return;"),Tv=typeof AS.oninput=="function"}Ev=Tv}else Ev=!1;PS=Ev&&(!document.documentMode||9<document.documentMode)}function DS(){xl&&(xl.detachEvent("onpropertychange",NS),Ll=xl=null)}function NS(s){if(s.propertyName==="value"&&$u(Ll)){var l=[];OS(l,Ll,s,hv(s)),gS(DP,l)}}function NP(s,l,u){s==="focusin"?(DS(),xl=l,Ll=u,xl.attachEvent("onpropertychange",NS)):s==="focusout"&&DS()}function xP(s){if(s==="selectionchange"||s==="keyup"||s==="keydown")return $u(Ll)}function LP(s,l){if(s==="click")return $u(l)}function UP(s,l){if(s==="input"||s==="change")return $u(l)}function BP(s,l){return s===l&&(s!==0||1/s===1/l)||s!==s&&l!==l}var Xn=typeof Object.is=="function"?Object.is:BP;function Ul(s,l){if(Xn(s,l))return!0;if(typeof s!="object"||s===null||typeof l!="object"||l===null)return!1;var u=Object.keys(s),f=Object.keys(l);if(u.length!==f.length)return!1;for(f=0;f<u.length;f++){var p=u[f];if(!Zf.call(l,p)||!Xn(s[p],l[p]))return!1}return!0}function xS(s){for(;s&&s.firstChild;)s=s.firstChild;return s}function LS(s,l){var u=xS(s);s=0;for(var f;u;){if(u.nodeType===3){if(f=s+u.textContent.length,s<=l&&f>=l)return{node:u,offset:l-s};s=f}e:{for(;u;){if(u.nextSibling){u=u.nextSibling;break e}u=u.parentNode}u=void 0}u=xS(u)}}function US(s,l){return s&&l?s===l?!0:s&&s.nodeType===3?!1:l&&l.nodeType===3?US(s,l.parentNode):"contains"in s?s.contains(l):s.compareDocumentPosition?!!(s.compareDocumentPosition(l)&16):!1:!1}function BS(s){s=s!=null&&s.ownerDocument!=null&&s.ownerDocument.defaultView!=null?s.ownerDocument.defaultView:window;for(var l=Ku(s.document);l instanceof s.HTMLIFrameElement;){try{var u=typeof l.contentWindow.location.href=="string"}catch{u=!1}if(u)s=l.contentWindow;else break;l=Ku(s.document)}return l}function _v(s){var l=s&&s.nodeName&&s.nodeName.toLowerCase();return l&&(l==="input"&&(s.type==="text"||s.type==="search"||s.type==="tel"||s.type==="url"||s.type==="password")||l==="textarea"||s.contentEditable==="true")}var FP=gr&&"documentMode"in document&&11>=document.documentMode,io=null,Cv=null,Bl=null,Rv=!1;function FS(s,l,u){var f=u.window===u?u.document:u.nodeType===9?u:u.ownerDocument;Rv||io==null||io!==Ku(f)||(f=io,"selectionStart"in f&&_v(f)?f={start:f.selectionStart,end:f.selectionEnd}:(f=(f.ownerDocument&&f.ownerDocument.defaultView||window).getSelection(),f={anchorNode:f.anchorNode,anchorOffset:f.anchorOffset,focusNode:f.focusNode,focusOffset:f.focusOffset}),Bl&&Ul(Bl,f)||(Bl=f,f=Bd(Cv,"onSelect"),0<f.length&&(l=new Ju("onSelect","select",null,l,u),s.push({event:l,listeners:f}),l.target=io)))}function ts(s,l){var u={};return u[s.toLowerCase()]=l.toLowerCase(),u["Webkit"+s]="webkit"+l,u["Moz"+s]="moz"+l,u}var ro={animationend:ts("Animation","AnimationEnd"),animationiteration:ts("Animation","AnimationIteration"),animationstart:ts("Animation","AnimationStart"),transitionrun:ts("Transition","TransitionRun"),transitionstart:ts("Transition","TransitionStart"),transitioncancel:ts("Transition","TransitionCancel"),transitionend:ts("Transition","TransitionEnd")},kv={},jS={};gr&&(jS=document.createElement("div").style,"AnimationEvent"in window||(delete ro.animationend.animation,delete ro.animationiteration.animation,delete ro.animationstart.animation),"TransitionEvent"in window||delete ro.transitionend.transition);function ns(s){if(kv[s])return kv[s];if(!ro[s])return s;var l=ro[s],u;for(u in l)if(l.hasOwnProperty(u)&&u in jS)return kv[s]=l[u];return s}var qS=ns("animationend"),VS=ns("animationiteration"),KS=ns("animationstart"),jP=ns("transitionrun"),qP=ns("transitionstart"),VP=ns("transitioncancel"),HS=ns("transitionend"),GS=new Map,wv="abort auxClick beforeToggle cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");wv.push("scrollEnd");function Pi(s,l){GS.set(s,l),Za(l,[s])}var Xu=typeof reportError=="function"?reportError:function(s){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var l=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof s=="object"&&s!==null&&typeof s.message=="string"?String(s.message):String(s),error:s});if(!window.dispatchEvent(l))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",s);return}console.error(s)},gi=[],ao=0,Iv=0;function Qu(){for(var s=ao,l=Iv=ao=0;l<s;){var u=gi[l];gi[l++]=null;var f=gi[l];gi[l++]=null;var p=gi[l];gi[l++]=null;var g=gi[l];if(gi[l++]=null,f!==null&&p!==null){var w=f.pending;w===null?p.next=p:(p.next=w.next,w.next=p),f.pending=p}g!==0&&zS(u,p,g)}}function Zu(s,l,u,f){gi[ao++]=s,gi[ao++]=l,gi[ao++]=u,gi[ao++]=f,Iv|=f,s.lanes|=f,s=s.alternate,s!==null&&(s.lanes|=f)}function Ov(s,l,u,f){return Zu(s,l,u,f),ed(s)}function is(s,l){return Zu(s,null,null,l),ed(s)}function zS(s,l,u){s.lanes|=u;var f=s.alternate;f!==null&&(f.lanes|=u);for(var p=!1,g=s.return;g!==null;)g.childLanes|=u,f=g.alternate,f!==null&&(f.childLanes|=u),g.tag===22&&(s=g.stateNode,s===null||s._visibility&1||(p=!0)),s=g,g=g.return;return s.tag===3?(g=s.stateNode,p&&l!==null&&(p=31-$n(u),s=g.hiddenUpdates,f=s[p],f===null?s[p]=[l]:f.push(l),l.lane=u|536870912),g):null}function ed(s){if(50<sc)throw sc=0,Bm=null,Error(n(185));for(var l=s.return;l!==null;)s=l,l=s.return;return s.tag===3?s.stateNode:null}var so={};function KP(s,l,u,f){this.tag=s,this.key=u,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.refCleanup=this.ref=null,this.pendingProps=l,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=f,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Qn(s,l,u,f){return new KP(s,l,u,f)}function Mv(s){return s=s.prototype,!(!s||!s.isReactComponent)}function yr(s,l){var u=s.alternate;return u===null?(u=Qn(s.tag,l,s.key,s.mode),u.elementType=s.elementType,u.type=s.type,u.stateNode=s.stateNode,u.alternate=s,s.alternate=u):(u.pendingProps=l,u.type=s.type,u.flags=0,u.subtreeFlags=0,u.deletions=null),u.flags=s.flags&65011712,u.childLanes=s.childLanes,u.lanes=s.lanes,u.child=s.child,u.memoizedProps=s.memoizedProps,u.memoizedState=s.memoizedState,u.updateQueue=s.updateQueue,l=s.dependencies,u.dependencies=l===null?null:{lanes:l.lanes,firstContext:l.firstContext},u.sibling=s.sibling,u.index=s.index,u.ref=s.ref,u.refCleanup=s.refCleanup,u}function WS(s,l){s.flags&=65011714;var u=s.alternate;return u===null?(s.childLanes=0,s.lanes=l,s.child=null,s.subtreeFlags=0,s.memoizedProps=null,s.memoizedState=null,s.updateQueue=null,s.dependencies=null,s.stateNode=null):(s.childLanes=u.childLanes,s.lanes=u.lanes,s.child=u.child,s.subtreeFlags=0,s.deletions=null,s.memoizedProps=u.memoizedProps,s.memoizedState=u.memoizedState,s.updateQueue=u.updateQueue,s.type=u.type,l=u.dependencies,s.dependencies=l===null?null:{lanes:l.lanes,firstContext:l.firstContext}),s}function td(s,l,u,f,p,g){var w=0;if(f=s,typeof s=="function")Mv(s)&&(w=1);else if(typeof s=="string")w=JA(s,u,pe.current)?26:s==="html"||s==="head"||s==="body"?27:5;else e:switch(s){case U:return s=Qn(31,u,l,p),s.elementType=U,s.lanes=g,s;case S:return rs(u.children,p,g,l);case O:w=8,p|=24;break;case R:return s=Qn(12,u,l,p|2),s.elementType=R,s.lanes=g,s;case k:return s=Qn(13,u,l,p),s.elementType=k,s.lanes=g,s;case _:return s=Qn(19,u,l,p),s.elementType=_,s.lanes=g,s;default:if(typeof s=="object"&&s!==null)switch(s.$$typeof){case M:w=10;break e;case I:w=9;break e;case C:w=11;break e;case P:w=14;break e;case x:w=16,f=null;break e}w=29,u=Error(n(130,s===null?"null":typeof s,"")),f=null}return l=Qn(w,u,l,p),l.elementType=s,l.type=f,l.lanes=g,l}function rs(s,l,u,f){return s=Qn(7,s,f,l),s.lanes=u,s}function Pv(s,l,u){return s=Qn(6,s,null,l),s.lanes=u,s}function JS(s){var l=Qn(18,null,null,0);return l.stateNode=s,l}function Av(s,l,u){return l=Qn(4,s.children!==null?s.children:[],s.key,l),l.lanes=u,l.stateNode={containerInfo:s.containerInfo,pendingChildren:null,implementation:s.implementation},l}var YS=new WeakMap;function yi(s,l){if(typeof s=="object"&&s!==null){var u=YS.get(s);return u!==void 0?u:(l={value:s,source:l,stack:Jb(l)},YS.set(s,l),l)}return{value:s,source:l,stack:Jb(l)}}var oo=[],lo=0,nd=null,Fl=0,bi=[],Si=0,ia=null,Yi=1,$i="";function br(s,l){oo[lo++]=Fl,oo[lo++]=nd,nd=s,Fl=l}function $S(s,l,u){bi[Si++]=Yi,bi[Si++]=$i,bi[Si++]=ia,ia=s;var f=Yi;s=$i;var p=32-$n(f)-1;f&=~(1<<p),u+=1;var g=32-$n(l)+p;if(30<g){var w=p-p%5;g=(f&(1<<w)-1).toString(32),f>>=w,p-=w,Yi=1<<32-$n(l)+p|u<<p|f,$i=g+s}else Yi=1<<g|u<<p|f,$i=s}function Dv(s){s.return!==null&&(br(s,1),$S(s,1,0))}function Nv(s){for(;s===nd;)nd=oo[--lo],oo[lo]=null,Fl=oo[--lo],oo[lo]=null;for(;s===ia;)ia=bi[--Si],bi[Si]=null,$i=bi[--Si],bi[Si]=null,Yi=bi[--Si],bi[Si]=null}function XS(s,l){bi[Si++]=Yi,bi[Si++]=$i,bi[Si++]=ia,Yi=l.id,$i=l.overflow,ia=s}var vn=null,Rt=null,Ze=!1,ra=null,Ei=!1,xv=Error(n(519));function aa(s){var l=Error(n(418,1<arguments.length&&arguments[1]!==void 0&&arguments[1]?"text":"HTML",""));throw jl(yi(l,s)),xv}function QS(s){var l=s.stateNode,u=s.type,f=s.memoizedProps;switch(l[fn]=s,l[Nn]=f,u){case"dialog":ze("cancel",l),ze("close",l);break;case"iframe":case"object":case"embed":ze("load",l);break;case"video":case"audio":for(u=0;u<lc.length;u++)ze(lc[u],l);break;case"source":ze("error",l);break;case"img":case"image":case"link":ze("error",l),ze("load",l);break;case"details":ze("toggle",l);break;case"input":ze("invalid",l),dS(l,f.value,f.defaultValue,f.checked,f.defaultChecked,f.type,f.name,!0);break;case"select":ze("invalid",l);break;case"textarea":ze("invalid",l),fS(l,f.value,f.defaultValue,f.children)}u=f.children,typeof u!="string"&&typeof u!="number"&&typeof u!="bigint"||l.textContent===""+u||f.suppressHydrationWarning===!0||mT(l.textContent,u)?(f.popover!=null&&(ze("beforetoggle",l),ze("toggle",l)),f.onScroll!=null&&ze("scroll",l),f.onScrollEnd!=null&&ze("scrollend",l),f.onClick!=null&&(l.onclick=pr),l=!0):l=!1,l||aa(s,!0)}function ZS(s){for(vn=s.return;vn;)switch(vn.tag){case 5:case 31:case 13:Ei=!1;return;case 27:case 3:Ei=!0;return;default:vn=vn.return}}function co(s){if(s!==vn)return!1;if(!Ze)return ZS(s),Ze=!0,!1;var l=s.tag,u;if((u=l!==3&&l!==27)&&((u=l===5)&&(u=s.type,u=!(u!=="form"&&u!=="button")||Zm(s.type,s.memoizedProps)),u=!u),u&&Rt&&aa(s),ZS(s),l===13){if(s=s.memoizedState,s=s!==null?s.dehydrated:null,!s)throw Error(n(317));Rt=CT(s)}else if(l===31){if(s=s.memoizedState,s=s!==null?s.dehydrated:null,!s)throw Error(n(317));Rt=CT(s)}else l===27?(l=Rt,ba(s.type)?(s=rp,rp=null,Rt=s):Rt=l):Rt=vn?_i(s.stateNode.nextSibling):null;return!0}function as(){Rt=vn=null,Ze=!1}function Lv(){var s=ra;return s!==null&&(Fn===null?Fn=s:Fn.push.apply(Fn,s),ra=null),s}function jl(s){ra===null?ra=[s]:ra.push(s)}var Uv=F(null),ss=null,Sr=null;function sa(s,l,u){de(Uv,l._currentValue),l._currentValue=u}function Er(s){s._currentValue=Uv.current,ee(Uv)}function Bv(s,l,u){for(;s!==null;){var f=s.alternate;if((s.childLanes&l)!==l?(s.childLanes|=l,f!==null&&(f.childLanes|=l)):f!==null&&(f.childLanes&l)!==l&&(f.childLanes|=l),s===u)break;s=s.return}}function Fv(s,l,u,f){var p=s.child;for(p!==null&&(p.return=s);p!==null;){var g=p.dependencies;if(g!==null){var w=p.child;g=g.firstContext;e:for(;g!==null;){var N=g;g=p;for(var B=0;B<l.length;B++)if(N.context===l[B]){g.lanes|=u,N=g.alternate,N!==null&&(N.lanes|=u),Bv(g.return,u,s),f||(w=null);break e}g=N.next}}else if(p.tag===18){if(w=p.return,w===null)throw Error(n(341));w.lanes|=u,g=w.alternate,g!==null&&(g.lanes|=u),Bv(w,u,s),w=null}else w=p.child;if(w!==null)w.return=p;else for(w=p;w!==null;){if(w===s){w=null;break}if(p=w.sibling,p!==null){p.return=w.return,w=p;break}w=w.return}p=w}}function uo(s,l,u,f){s=null;for(var p=l,g=!1;p!==null;){if(!g){if((p.flags&524288)!==0)g=!0;else if((p.flags&262144)!==0)break}if(p.tag===10){var w=p.alternate;if(w===null)throw Error(n(387));if(w=w.memoizedProps,w!==null){var N=p.type;Xn(p.pendingProps.value,w.value)||(s!==null?s.push(N):s=[N])}}else if(p===ke.current){if(w=p.alternate,w===null)throw Error(n(387));w.memoizedState.memoizedState!==p.memoizedState.memoizedState&&(s!==null?s.push(fc):s=[fc])}p=p.return}s!==null&&Fv(l,s,u,f),l.flags|=262144}function id(s){for(s=s.firstContext;s!==null;){if(!Xn(s.context._currentValue,s.memoizedValue))return!0;s=s.next}return!1}function os(s){ss=s,Sr=null,s=s.dependencies,s!==null&&(s.firstContext=null)}function mn(s){return e0(ss,s)}function rd(s,l){return ss===null&&os(s),e0(s,l)}function e0(s,l){var u=l._currentValue;if(l={context:l,memoizedValue:u,next:null},Sr===null){if(s===null)throw Error(n(308));Sr=l,s.dependencies={lanes:0,firstContext:l},s.flags|=524288}else Sr=Sr.next=l;return u}var HP=typeof AbortController<"u"?AbortController:function(){var s=[],l=this.signal={aborted:!1,addEventListener:function(u,f){s.push(f)}};this.abort=function(){l.aborted=!0,s.forEach(function(u){return u()})}},GP=i.unstable_scheduleCallback,zP=i.unstable_NormalPriority,Gt={$$typeof:M,Consumer:null,Provider:null,_currentValue:null,_currentValue2:null,_threadCount:0};function jv(){return{controller:new HP,data:new Map,refCount:0}}function ql(s){s.refCount--,s.refCount===0&&GP(zP,function(){s.controller.abort()})}var Vl=null,qv=0,ho=0,fo=null;function WP(s,l){if(Vl===null){var u=Vl=[];qv=0,ho=Hm(),fo={status:"pending",value:void 0,then:function(f){u.push(f)}}}return qv++,l.then(t0,t0),l}function t0(){if(--qv===0&&Vl!==null){fo!==null&&(fo.status="fulfilled");var s=Vl;Vl=null,ho=0,fo=null;for(var l=0;l<s.length;l++)(0,s[l])()}}function JP(s,l){var u=[],f={status:"pending",value:null,reason:null,then:function(p){u.push(p)}};return s.then(function(){f.status="fulfilled",f.value=l;for(var p=0;p<u.length;p++)(0,u[p])(l)},function(p){for(f.status="rejected",f.reason=p,p=0;p<u.length;p++)(0,u[p])(void 0)}),f}var n0=V.S;V.S=function(s,l){FE=Jn(),typeof l=="object"&&l!==null&&typeof l.then=="function"&&WP(s,l),n0!==null&&n0(s,l)};var ls=F(null);function Vv(){var s=ls.current;return s!==null?s:gt.pooledCache}function ad(s,l){l===null?de(ls,ls.current):de(ls,l.pool)}function i0(){var s=Vv();return s===null?null:{parent:Gt._currentValue,pool:s}}var vo=Error(n(460)),Kv=Error(n(474)),sd=Error(n(542)),od={then:function(){}};function r0(s){return s=s.status,s==="fulfilled"||s==="rejected"}function a0(s,l,u){switch(u=s[u],u===void 0?s.push(l):u!==l&&(l.then(pr,pr),l=u),l.status){case"fulfilled":return l.value;case"rejected":throw s=l.reason,o0(s),s;default:if(typeof l.status=="string")l.then(pr,pr);else{if(s=gt,s!==null&&100<s.shellSuspendCounter)throw Error(n(482));s=l,s.status="pending",s.then(function(f){if(l.status==="pending"){var p=l;p.status="fulfilled",p.value=f}},function(f){if(l.status==="pending"){var p=l;p.status="rejected",p.reason=f}})}switch(l.status){case"fulfilled":return l.value;case"rejected":throw s=l.reason,o0(s),s}throw us=l,vo}}function cs(s){try{var l=s._init;return l(s._payload)}catch(u){throw u!==null&&typeof u=="object"&&typeof u.then=="function"?(us=u,vo):u}}var us=null;function s0(){if(us===null)throw Error(n(459));var s=us;return us=null,s}function o0(s){if(s===vo||s===sd)throw Error(n(483))}var mo=null,Kl=0;function ld(s){var l=Kl;return Kl+=1,mo===null&&(mo=[]),a0(mo,s,l)}function Hl(s,l){l=l.props.ref,s.ref=l!==void 0?l:null}function cd(s,l){throw l.$$typeof===y?Error(n(525)):(s=Object.prototype.toString.call(l),Error(n(31,s==="[object Object]"?"object with keys {"+Object.keys(l).join(", ")+"}":s)))}function l0(s){function l(H,q){if(s){var z=H.deletions;z===null?(H.deletions=[q],H.flags|=16):z.push(q)}}function u(H,q){if(!s)return null;for(;q!==null;)l(H,q),q=q.sibling;return null}function f(H){for(var q=new Map;H!==null;)H.key!==null?q.set(H.key,H):q.set(H.index,H),H=H.sibling;return q}function p(H,q){return H=yr(H,q),H.index=0,H.sibling=null,H}function g(H,q,z){return H.index=z,s?(z=H.alternate,z!==null?(z=z.index,z<q?(H.flags|=67108866,q):z):(H.flags|=67108866,q)):(H.flags|=1048576,q)}function w(H){return s&&H.alternate===null&&(H.flags|=67108866),H}function N(H,q,z,ie){return q===null||q.tag!==6?(q=Pv(z,H.mode,ie),q.return=H,q):(q=p(q,z),q.return=H,q)}function B(H,q,z,ie){var Ce=z.type;return Ce===S?ne(H,q,z.props.children,ie,z.key):q!==null&&(q.elementType===Ce||typeof Ce=="object"&&Ce!==null&&Ce.$$typeof===x&&cs(Ce)===q.type)?(q=p(q,z.props),Hl(q,z),q.return=H,q):(q=td(z.type,z.key,z.props,null,H.mode,ie),Hl(q,z),q.return=H,q)}function W(H,q,z,ie){return q===null||q.tag!==4||q.stateNode.containerInfo!==z.containerInfo||q.stateNode.implementation!==z.implementation?(q=Av(z,H.mode,ie),q.return=H,q):(q=p(q,z.children||[]),q.return=H,q)}function ne(H,q,z,ie,Ce){return q===null||q.tag!==7?(q=rs(z,H.mode,ie,Ce),q.return=H,q):(q=p(q,z),q.return=H,q)}function re(H,q,z){if(typeof q=="string"&&q!==""||typeof q=="number"||typeof q=="bigint")return q=Pv(""+q,H.mode,z),q.return=H,q;if(typeof q=="object"&&q!==null){switch(q.$$typeof){case E:return z=td(q.type,q.key,q.props,null,H.mode,z),Hl(z,q),z.return=H,z;case T:return q=Av(q,H.mode,z),q.return=H,q;case x:return q=cs(q),re(H,q,z)}if(ce(q)||Z(q))return q=rs(q,H.mode,z,null),q.return=H,q;if(typeof q.then=="function")return re(H,ld(q),z);if(q.$$typeof===M)return re(H,rd(H,q),z);cd(H,q)}return null}function Y(H,q,z,ie){var Ce=q!==null?q.key:null;if(typeof z=="string"&&z!==""||typeof z=="number"||typeof z=="bigint")return Ce!==null?null:N(H,q,""+z,ie);if(typeof z=="object"&&z!==null){switch(z.$$typeof){case E:return z.key===Ce?B(H,q,z,ie):null;case T:return z.key===Ce?W(H,q,z,ie):null;case x:return z=cs(z),Y(H,q,z,ie)}if(ce(z)||Z(z))return Ce!==null?null:ne(H,q,z,ie,null);if(typeof z.then=="function")return Y(H,q,ld(z),ie);if(z.$$typeof===M)return Y(H,q,rd(H,z),ie);cd(H,z)}return null}function X(H,q,z,ie,Ce){if(typeof ie=="string"&&ie!==""||typeof ie=="number"||typeof ie=="bigint")return H=H.get(z)||null,N(q,H,""+ie,Ce);if(typeof ie=="object"&&ie!==null){switch(ie.$$typeof){case E:return H=H.get(ie.key===null?z:ie.key)||null,B(q,H,ie,Ce);case T:return H=H.get(ie.key===null?z:ie.key)||null,W(q,H,ie,Ce);case x:return ie=cs(ie),X(H,q,z,ie,Ce)}if(ce(ie)||Z(ie))return H=H.get(z)||null,ne(q,H,ie,Ce,null);if(typeof ie.then=="function")return X(H,q,z,ld(ie),Ce);if(ie.$$typeof===M)return X(H,q,z,rd(q,ie),Ce);cd(q,ie)}return null}function Se(H,q,z,ie){for(var Ce=null,tt=null,Ee=q,Ve=q=0,Xe=null;Ee!==null&&Ve<z.length;Ve++){Ee.index>Ve?(Xe=Ee,Ee=null):Xe=Ee.sibling;var nt=Y(H,Ee,z[Ve],ie);if(nt===null){Ee===null&&(Ee=Xe);break}s&&Ee&&nt.alternate===null&&l(H,Ee),q=g(nt,q,Ve),tt===null?Ce=nt:tt.sibling=nt,tt=nt,Ee=Xe}if(Ve===z.length)return u(H,Ee),Ze&&br(H,Ve),Ce;if(Ee===null){for(;Ve<z.length;Ve++)Ee=re(H,z[Ve],ie),Ee!==null&&(q=g(Ee,q,Ve),tt===null?Ce=Ee:tt.sibling=Ee,tt=Ee);return Ze&&br(H,Ve),Ce}for(Ee=f(Ee);Ve<z.length;Ve++)Xe=X(Ee,H,Ve,z[Ve],ie),Xe!==null&&(s&&Xe.alternate!==null&&Ee.delete(Xe.key===null?Ve:Xe.key),q=g(Xe,q,Ve),tt===null?Ce=Xe:tt.sibling=Xe,tt=Xe);return s&&Ee.forEach(function(Ca){return l(H,Ca)}),Ze&&br(H,Ve),Ce}function we(H,q,z,ie){if(z==null)throw Error(n(151));for(var Ce=null,tt=null,Ee=q,Ve=q=0,Xe=null,nt=z.next();Ee!==null&&!nt.done;Ve++,nt=z.next()){Ee.index>Ve?(Xe=Ee,Ee=null):Xe=Ee.sibling;var Ca=Y(H,Ee,nt.value,ie);if(Ca===null){Ee===null&&(Ee=Xe);break}s&&Ee&&Ca.alternate===null&&l(H,Ee),q=g(Ca,q,Ve),tt===null?Ce=Ca:tt.sibling=Ca,tt=Ca,Ee=Xe}if(nt.done)return u(H,Ee),Ze&&br(H,Ve),Ce;if(Ee===null){for(;!nt.done;Ve++,nt=z.next())nt=re(H,nt.value,ie),nt!==null&&(q=g(nt,q,Ve),tt===null?Ce=nt:tt.sibling=nt,tt=nt);return Ze&&br(H,Ve),Ce}for(Ee=f(Ee);!nt.done;Ve++,nt=z.next())nt=X(Ee,H,Ve,nt.value,ie),nt!==null&&(s&&nt.alternate!==null&&Ee.delete(nt.key===null?Ve:nt.key),q=g(nt,q,Ve),tt===null?Ce=nt:tt.sibling=nt,tt=nt);return s&&Ee.forEach(function(aD){return l(H,aD)}),Ze&&br(H,Ve),Ce}function vt(H,q,z,ie){if(typeof z=="object"&&z!==null&&z.type===S&&z.key===null&&(z=z.props.children),typeof z=="object"&&z!==null){switch(z.$$typeof){case E:e:{for(var Ce=z.key;q!==null;){if(q.key===Ce){if(Ce=z.type,Ce===S){if(q.tag===7){u(H,q.sibling),ie=p(q,z.props.children),ie.return=H,H=ie;break e}}else if(q.elementType===Ce||typeof Ce=="object"&&Ce!==null&&Ce.$$typeof===x&&cs(Ce)===q.type){u(H,q.sibling),ie=p(q,z.props),Hl(ie,z),ie.return=H,H=ie;break e}u(H,q);break}else l(H,q);q=q.sibling}z.type===S?(ie=rs(z.props.children,H.mode,ie,z.key),ie.return=H,H=ie):(ie=td(z.type,z.key,z.props,null,H.mode,ie),Hl(ie,z),ie.return=H,H=ie)}return w(H);case T:e:{for(Ce=z.key;q!==null;){if(q.key===Ce)if(q.tag===4&&q.stateNode.containerInfo===z.containerInfo&&q.stateNode.implementation===z.implementation){u(H,q.sibling),ie=p(q,z.children||[]),ie.return=H,H=ie;break e}else{u(H,q);break}else l(H,q);q=q.sibling}ie=Av(z,H.mode,ie),ie.return=H,H=ie}return w(H);case x:return z=cs(z),vt(H,q,z,ie)}if(ce(z))return Se(H,q,z,ie);if(Z(z)){if(Ce=Z(z),typeof Ce!="function")throw Error(n(150));return z=Ce.call(z),we(H,q,z,ie)}if(typeof z.then=="function")return vt(H,q,ld(z),ie);if(z.$$typeof===M)return vt(H,q,rd(H,z),ie);cd(H,z)}return typeof z=="string"&&z!==""||typeof z=="number"||typeof z=="bigint"?(z=""+z,q!==null&&q.tag===6?(u(H,q.sibling),ie=p(q,z),ie.return=H,H=ie):(u(H,q),ie=Pv(z,H.mode,ie),ie.return=H,H=ie),w(H)):u(H,q)}return function(H,q,z,ie){try{Kl=0;var Ce=vt(H,q,z,ie);return mo=null,Ce}catch(Ee){if(Ee===vo||Ee===sd)throw Ee;var tt=Qn(29,Ee,null,H.mode);return tt.lanes=ie,tt.return=H,tt}}}var ds=l0(!0),c0=l0(!1),oa=!1;function Hv(s){s.updateQueue={baseState:s.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,lanes:0,hiddenCallbacks:null},callbacks:null}}function Gv(s,l){s=s.updateQueue,l.updateQueue===s&&(l.updateQueue={baseState:s.baseState,firstBaseUpdate:s.firstBaseUpdate,lastBaseUpdate:s.lastBaseUpdate,shared:s.shared,callbacks:null})}function la(s){return{lane:s,tag:0,payload:null,callback:null,next:null}}function ca(s,l,u){var f=s.updateQueue;if(f===null)return null;if(f=f.shared,(rt&2)!==0){var p=f.pending;return p===null?l.next=l:(l.next=p.next,p.next=l),f.pending=l,l=ed(s),zS(s,null,u),l}return Zu(s,f,l,u),ed(s)}function Gl(s,l,u){if(l=l.updateQueue,l!==null&&(l=l.shared,(u&4194048)!==0)){var f=l.lanes;f&=s.pendingLanes,u|=f,l.lanes=u,eS(s,u)}}function zv(s,l){var u=s.updateQueue,f=s.alternate;if(f!==null&&(f=f.updateQueue,u===f)){var p=null,g=null;if(u=u.firstBaseUpdate,u!==null){do{var w={lane:u.lane,tag:u.tag,payload:u.payload,callback:null,next:null};g===null?p=g=w:g=g.next=w,u=u.next}while(u!==null);g===null?p=g=l:g=g.next=l}else p=g=l;u={baseState:f.baseState,firstBaseUpdate:p,lastBaseUpdate:g,shared:f.shared,callbacks:f.callbacks},s.updateQueue=u;return}s=u.lastBaseUpdate,s===null?u.firstBaseUpdate=l:s.next=l,u.lastBaseUpdate=l}var Wv=!1;function zl(){if(Wv){var s=fo;if(s!==null)throw s}}function Wl(s,l,u,f){Wv=!1;var p=s.updateQueue;oa=!1;var g=p.firstBaseUpdate,w=p.lastBaseUpdate,N=p.shared.pending;if(N!==null){p.shared.pending=null;var B=N,W=B.next;B.next=null,w===null?g=W:w.next=W,w=B;var ne=s.alternate;ne!==null&&(ne=ne.updateQueue,N=ne.lastBaseUpdate,N!==w&&(N===null?ne.firstBaseUpdate=W:N.next=W,ne.lastBaseUpdate=B))}if(g!==null){var re=p.baseState;w=0,ne=W=B=null,N=g;do{var Y=N.lane&-536870913,X=Y!==N.lane;if(X?($e&Y)===Y:(f&Y)===Y){Y!==0&&Y===ho&&(Wv=!0),ne!==null&&(ne=ne.next={lane:0,tag:N.tag,payload:N.payload,callback:null,next:null});e:{var Se=s,we=N;Y=l;var vt=u;switch(we.tag){case 1:if(Se=we.payload,typeof Se=="function"){re=Se.call(vt,re,Y);break e}re=Se;break e;case 3:Se.flags=Se.flags&-65537|128;case 0:if(Se=we.payload,Y=typeof Se=="function"?Se.call(vt,re,Y):Se,Y==null)break e;re=m({},re,Y);break e;case 2:oa=!0}}Y=N.callback,Y!==null&&(s.flags|=64,X&&(s.flags|=8192),X=p.callbacks,X===null?p.callbacks=[Y]:X.push(Y))}else X={lane:Y,tag:N.tag,payload:N.payload,callback:N.callback,next:null},ne===null?(W=ne=X,B=re):ne=ne.next=X,w|=Y;if(N=N.next,N===null){if(N=p.shared.pending,N===null)break;X=N,N=X.next,X.next=null,p.lastBaseUpdate=X,p.shared.pending=null}}while(!0);ne===null&&(B=re),p.baseState=B,p.firstBaseUpdate=W,p.lastBaseUpdate=ne,g===null&&(p.shared.lanes=0),va|=w,s.lanes=w,s.memoizedState=re}}function u0(s,l){if(typeof s!="function")throw Error(n(191,s));s.call(l)}function d0(s,l){var u=s.callbacks;if(u!==null)for(s.callbacks=null,s=0;s<u.length;s++)u0(u[s],l)}var po=F(null),ud=F(0);function h0(s,l){s=Mr,de(ud,s),de(po,l),Mr=s|l.baseLanes}function Jv(){de(ud,Mr),de(po,po.current)}function Yv(){Mr=ud.current,ee(po),ee(ud)}var Zn=F(null),Ti=null;function ua(s){var l=s.alternate;de(jt,jt.current&1),de(Zn,s),Ti===null&&(l===null||po.current!==null||l.memoizedState!==null)&&(Ti=s)}function $v(s){de(jt,jt.current),de(Zn,s),Ti===null&&(Ti=s)}function f0(s){s.tag===22?(de(jt,jt.current),de(Zn,s),Ti===null&&(Ti=s)):da()}function da(){de(jt,jt.current),de(Zn,Zn.current)}function ei(s){ee(Zn),Ti===s&&(Ti=null),ee(jt)}var jt=F(0);function dd(s){for(var l=s;l!==null;){if(l.tag===13){var u=l.memoizedState;if(u!==null&&(u=u.dehydrated,u===null||np(u)||ip(u)))return l}else if(l.tag===19&&(l.memoizedProps.revealOrder==="forwards"||l.memoizedProps.revealOrder==="backwards"||l.memoizedProps.revealOrder==="unstable_legacy-backwards"||l.memoizedProps.revealOrder==="together")){if((l.flags&128)!==0)return l}else if(l.child!==null){l.child.return=l,l=l.child;continue}if(l===s)break;for(;l.sibling===null;){if(l.return===null||l.return===s)return null;l=l.return}l.sibling.return=l.return,l=l.sibling}return null}var Tr=0,je=null,ht=null,zt=null,hd=!1,go=!1,hs=!1,fd=0,Jl=0,yo=null,YP=0;function Nt(){throw Error(n(321))}function Xv(s,l){if(l===null)return!1;for(var u=0;u<l.length&&u<s.length;u++)if(!Xn(s[u],l[u]))return!1;return!0}function Qv(s,l,u,f,p,g){return Tr=g,je=l,l.memoizedState=null,l.updateQueue=null,l.lanes=0,V.H=s===null||s.memoizedState===null?$0:fm,hs=!1,g=u(f,p),hs=!1,go&&(g=m0(l,u,f,p)),v0(s),g}function v0(s){V.H=Xl;var l=ht!==null&&ht.next!==null;if(Tr=0,zt=ht=je=null,hd=!1,Jl=0,yo=null,l)throw Error(n(300));s===null||Wt||(s=s.dependencies,s!==null&&id(s)&&(Wt=!0))}function m0(s,l,u,f){je=s;var p=0;do{if(go&&(yo=null),Jl=0,go=!1,25<=p)throw Error(n(301));if(p+=1,zt=ht=null,s.updateQueue!=null){var g=s.updateQueue;g.lastEffect=null,g.events=null,g.stores=null,g.memoCache!=null&&(g.memoCache.index=0)}V.H=X0,g=l(u,f)}while(go);return g}function $P(){var s=V.H,l=s.useState()[0];return l=typeof l.then=="function"?Yl(l):l,s=s.useState()[0],(ht!==null?ht.memoizedState:null)!==s&&(je.flags|=1024),l}function Zv(){var s=fd!==0;return fd=0,s}function em(s,l,u){l.updateQueue=s.updateQueue,l.flags&=-2053,s.lanes&=~u}function tm(s){if(hd){for(s=s.memoizedState;s!==null;){var l=s.queue;l!==null&&(l.pending=null),s=s.next}hd=!1}Tr=0,zt=ht=je=null,go=!1,Jl=fd=0,yo=null}function wn(){var s={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return zt===null?je.memoizedState=zt=s:zt=zt.next=s,zt}function qt(){if(ht===null){var s=je.alternate;s=s!==null?s.memoizedState:null}else s=ht.next;var l=zt===null?je.memoizedState:zt.next;if(l!==null)zt=l,ht=s;else{if(s===null)throw je.alternate===null?Error(n(467)):Error(n(310));ht=s,s={memoizedState:ht.memoizedState,baseState:ht.baseState,baseQueue:ht.baseQueue,queue:ht.queue,next:null},zt===null?je.memoizedState=zt=s:zt=zt.next=s}return zt}function vd(){return{lastEffect:null,events:null,stores:null,memoCache:null}}function Yl(s){var l=Jl;return Jl+=1,yo===null&&(yo=[]),s=a0(yo,s,l),l=je,(zt===null?l.memoizedState:zt.next)===null&&(l=l.alternate,V.H=l===null||l.memoizedState===null?$0:fm),s}function md(s){if(s!==null&&typeof s=="object"){if(typeof s.then=="function")return Yl(s);if(s.$$typeof===M)return mn(s)}throw Error(n(438,String(s)))}function nm(s){var l=null,u=je.updateQueue;if(u!==null&&(l=u.memoCache),l==null){var f=je.alternate;f!==null&&(f=f.updateQueue,f!==null&&(f=f.memoCache,f!=null&&(l={data:f.data.map(function(p){return p.slice()}),index:0})))}if(l==null&&(l={data:[],index:0}),u===null&&(u=vd(),je.updateQueue=u),u.memoCache=l,u=l.data[l.index],u===void 0)for(u=l.data[l.index]=Array(s),f=0;f<s;f++)u[f]=j;return l.index++,u}function _r(s,l){return typeof l=="function"?l(s):l}function pd(s){var l=qt();return im(l,ht,s)}function im(s,l,u){var f=s.queue;if(f===null)throw Error(n(311));f.lastRenderedReducer=u;var p=s.baseQueue,g=f.pending;if(g!==null){if(p!==null){var w=p.next;p.next=g.next,g.next=w}l.baseQueue=p=g,f.pending=null}if(g=s.baseState,p===null)s.memoizedState=g;else{l=p.next;var N=w=null,B=null,W=l,ne=!1;do{var re=W.lane&-536870913;if(re!==W.lane?($e&re)===re:(Tr&re)===re){var Y=W.revertLane;if(Y===0)B!==null&&(B=B.next={lane:0,revertLane:0,gesture:null,action:W.action,hasEagerState:W.hasEagerState,eagerState:W.eagerState,next:null}),re===ho&&(ne=!0);else if((Tr&Y)===Y){W=W.next,Y===ho&&(ne=!0);continue}else re={lane:0,revertLane:W.revertLane,gesture:null,action:W.action,hasEagerState:W.hasEagerState,eagerState:W.eagerState,next:null},B===null?(N=B=re,w=g):B=B.next=re,je.lanes|=Y,va|=Y;re=W.action,hs&&u(g,re),g=W.hasEagerState?W.eagerState:u(g,re)}else Y={lane:re,revertLane:W.revertLane,gesture:W.gesture,action:W.action,hasEagerState:W.hasEagerState,eagerState:W.eagerState,next:null},B===null?(N=B=Y,w=g):B=B.next=Y,je.lanes|=re,va|=re;W=W.next}while(W!==null&&W!==l);if(B===null?w=g:B.next=N,!Xn(g,s.memoizedState)&&(Wt=!0,ne&&(u=fo,u!==null)))throw u;s.memoizedState=g,s.baseState=w,s.baseQueue=B,f.lastRenderedState=g}return p===null&&(f.lanes=0),[s.memoizedState,f.dispatch]}function rm(s){var l=qt(),u=l.queue;if(u===null)throw Error(n(311));u.lastRenderedReducer=s;var f=u.dispatch,p=u.pending,g=l.memoizedState;if(p!==null){u.pending=null;var w=p=p.next;do g=s(g,w.action),w=w.next;while(w!==p);Xn(g,l.memoizedState)||(Wt=!0),l.memoizedState=g,l.baseQueue===null&&(l.baseState=g),u.lastRenderedState=g}return[g,f]}function p0(s,l,u){var f=je,p=qt(),g=Ze;if(g){if(u===void 0)throw Error(n(407));u=u()}else u=l();var w=!Xn((ht||p).memoizedState,u);if(w&&(p.memoizedState=u,Wt=!0),p=p.queue,om(b0.bind(null,f,p,s),[s]),p.getSnapshot!==l||w||zt!==null&&zt.memoizedState.tag&1){if(f.flags|=2048,bo(9,{destroy:void 0},y0.bind(null,f,p,u,l),null),gt===null)throw Error(n(349));g||(Tr&127)!==0||g0(f,l,u)}return u}function g0(s,l,u){s.flags|=16384,s={getSnapshot:l,value:u},l=je.updateQueue,l===null?(l=vd(),je.updateQueue=l,l.stores=[s]):(u=l.stores,u===null?l.stores=[s]:u.push(s))}function y0(s,l,u,f){l.value=u,l.getSnapshot=f,S0(l)&&E0(s)}function b0(s,l,u){return u(function(){S0(l)&&E0(s)})}function S0(s){var l=s.getSnapshot;s=s.value;try{var u=l();return!Xn(s,u)}catch{return!0}}function E0(s){var l=is(s,2);l!==null&&jn(l,s,2)}function am(s){var l=wn();if(typeof s=="function"){var u=s;if(s=u(),hs){ea(!0);try{u()}finally{ea(!1)}}}return l.memoizedState=l.baseState=s,l.queue={pending:null,lanes:0,dispatch:null,lastRenderedReducer:_r,lastRenderedState:s},l}function T0(s,l,u,f){return s.baseState=u,im(s,ht,typeof f=="function"?f:_r)}function XP(s,l,u,f,p){if(bd(s))throw Error(n(485));if(s=l.action,s!==null){var g={payload:p,action:s,next:null,isTransition:!0,status:"pending",value:null,reason:null,listeners:[],then:function(w){g.listeners.push(w)}};V.T!==null?u(!0):g.isTransition=!1,f(g),u=l.pending,u===null?(g.next=l.pending=g,_0(l,g)):(g.next=u.next,l.pending=u.next=g)}}function _0(s,l){var u=l.action,f=l.payload,p=s.state;if(l.isTransition){var g=V.T,w={};V.T=w;try{var N=u(p,f),B=V.S;B!==null&&B(w,N),C0(s,l,N)}catch(W){sm(s,l,W)}finally{g!==null&&w.types!==null&&(g.types=w.types),V.T=g}}else try{g=u(p,f),C0(s,l,g)}catch(W){sm(s,l,W)}}function C0(s,l,u){u!==null&&typeof u=="object"&&typeof u.then=="function"?u.then(function(f){R0(s,l,f)},function(f){return sm(s,l,f)}):R0(s,l,u)}function R0(s,l,u){l.status="fulfilled",l.value=u,k0(l),s.state=u,l=s.pending,l!==null&&(u=l.next,u===l?s.pending=null:(u=u.next,l.next=u,_0(s,u)))}function sm(s,l,u){var f=s.pending;if(s.pending=null,f!==null){f=f.next;do l.status="rejected",l.reason=u,k0(l),l=l.next;while(l!==f)}s.action=null}function k0(s){s=s.listeners;for(var l=0;l<s.length;l++)(0,s[l])()}function w0(s,l){return l}function I0(s,l){if(Ze){var u=gt.formState;if(u!==null){e:{var f=je;if(Ze){if(Rt){t:{for(var p=Rt,g=Ei;p.nodeType!==8;){if(!g){p=null;break t}if(p=_i(p.nextSibling),p===null){p=null;break t}}g=p.data,p=g==="F!"||g==="F"?p:null}if(p){Rt=_i(p.nextSibling),f=p.data==="F!";break e}}aa(f)}f=!1}f&&(l=u[0])}}return u=wn(),u.memoizedState=u.baseState=l,f={pending:null,lanes:0,dispatch:null,lastRenderedReducer:w0,lastRenderedState:l},u.queue=f,u=W0.bind(null,je,f),f.dispatch=u,f=am(!1),g=hm.bind(null,je,!1,f.queue),f=wn(),p={state:l,dispatch:null,action:s,pending:null},f.queue=p,u=XP.bind(null,je,p,g,u),p.dispatch=u,f.memoizedState=s,[l,u,!1]}function O0(s){var l=qt();return M0(l,ht,s)}function M0(s,l,u){if(l=im(s,l,w0)[0],s=pd(_r)[0],typeof l=="object"&&l!==null&&typeof l.then=="function")try{var f=Yl(l)}catch(w){throw w===vo?sd:w}else f=l;l=qt();var p=l.queue,g=p.dispatch;return u!==l.memoizedState&&(je.flags|=2048,bo(9,{destroy:void 0},QP.bind(null,p,u),null)),[f,g,s]}function QP(s,l){s.action=l}function P0(s){var l=qt(),u=ht;if(u!==null)return M0(l,u,s);qt(),l=l.memoizedState,u=qt();var f=u.queue.dispatch;return u.memoizedState=s,[l,f,!1]}function bo(s,l,u,f){return s={tag:s,create:u,deps:f,inst:l,next:null},l=je.updateQueue,l===null&&(l=vd(),je.updateQueue=l),u=l.lastEffect,u===null?l.lastEffect=s.next=s:(f=u.next,u.next=s,s.next=f,l.lastEffect=s),s}function A0(){return qt().memoizedState}function gd(s,l,u,f){var p=wn();je.flags|=s,p.memoizedState=bo(1|l,{destroy:void 0},u,f===void 0?null:f)}function yd(s,l,u,f){var p=qt();f=f===void 0?null:f;var g=p.memoizedState.inst;ht!==null&&f!==null&&Xv(f,ht.memoizedState.deps)?p.memoizedState=bo(l,g,u,f):(je.flags|=s,p.memoizedState=bo(1|l,g,u,f))}function D0(s,l){gd(8390656,8,s,l)}function om(s,l){yd(2048,8,s,l)}function ZP(s){je.flags|=4;var l=je.updateQueue;if(l===null)l=vd(),je.updateQueue=l,l.events=[s];else{var u=l.events;u===null?l.events=[s]:u.push(s)}}function N0(s){var l=qt().memoizedState;return ZP({ref:l,nextImpl:s}),function(){if((rt&2)!==0)throw Error(n(440));return l.impl.apply(void 0,arguments)}}function x0(s,l){return yd(4,2,s,l)}function L0(s,l){return yd(4,4,s,l)}function U0(s,l){if(typeof l=="function"){s=s();var u=l(s);return function(){typeof u=="function"?u():l(null)}}if(l!=null)return s=s(),l.current=s,function(){l.current=null}}function B0(s,l,u){u=u!=null?u.concat([s]):null,yd(4,4,U0.bind(null,l,s),u)}function lm(){}function F0(s,l){var u=qt();l=l===void 0?null:l;var f=u.memoizedState;return l!==null&&Xv(l,f[1])?f[0]:(u.memoizedState=[s,l],s)}function j0(s,l){var u=qt();l=l===void 0?null:l;var f=u.memoizedState;if(l!==null&&Xv(l,f[1]))return f[0];if(f=s(),hs){ea(!0);try{s()}finally{ea(!1)}}return u.memoizedState=[f,l],f}function cm(s,l,u){return u===void 0||(Tr&1073741824)!==0&&($e&261930)===0?s.memoizedState=l:(s.memoizedState=u,s=qE(),je.lanes|=s,va|=s,u)}function q0(s,l,u,f){return Xn(u,l)?u:po.current!==null?(s=cm(s,u,f),Xn(s,l)||(Wt=!0),s):(Tr&42)===0||(Tr&1073741824)!==0&&($e&261930)===0?(Wt=!0,s.memoizedState=u):(s=qE(),je.lanes|=s,va|=s,l)}function V0(s,l,u,f,p){var g=Q.p;Q.p=g!==0&&8>g?g:8;var w=V.T,N={};V.T=N,hm(s,!1,l,u);try{var B=p(),W=V.S;if(W!==null&&W(N,B),B!==null&&typeof B=="object"&&typeof B.then=="function"){var ne=JP(B,f);$l(s,l,ne,ii(s))}else $l(s,l,f,ii(s))}catch(re){$l(s,l,{then:function(){},status:"rejected",reason:re},ii())}finally{Q.p=g,w!==null&&N.types!==null&&(w.types=N.types),V.T=w}}function eA(){}function um(s,l,u,f){if(s.tag!==5)throw Error(n(476));var p=K0(s).queue;V0(s,p,l,le,u===null?eA:function(){return H0(s),u(f)})}function K0(s){var l=s.memoizedState;if(l!==null)return l;l={memoizedState:le,baseState:le,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:_r,lastRenderedState:le},next:null};var u={};return l.next={memoizedState:u,baseState:u,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:_r,lastRenderedState:u},next:null},s.memoizedState=l,s=s.alternate,s!==null&&(s.memoizedState=l),l}function H0(s){var l=K0(s);l.next===null&&(l=s.alternate.memoizedState),$l(s,l.next.queue,{},ii())}function dm(){return mn(fc)}function G0(){return qt().memoizedState}function z0(){return qt().memoizedState}function tA(s){for(var l=s.return;l!==null;){switch(l.tag){case 24:case 3:var u=ii();s=la(u);var f=ca(l,s,u);f!==null&&(jn(f,l,u),Gl(f,l,u)),l={cache:jv()},s.payload=l;return}l=l.return}}function nA(s,l,u){var f=ii();u={lane:f,revertLane:0,gesture:null,action:u,hasEagerState:!1,eagerState:null,next:null},bd(s)?J0(l,u):(u=Ov(s,l,u,f),u!==null&&(jn(u,s,f),Y0(u,l,f)))}function W0(s,l,u){var f=ii();$l(s,l,u,f)}function $l(s,l,u,f){var p={lane:f,revertLane:0,gesture:null,action:u,hasEagerState:!1,eagerState:null,next:null};if(bd(s))J0(l,p);else{var g=s.alternate;if(s.lanes===0&&(g===null||g.lanes===0)&&(g=l.lastRenderedReducer,g!==null))try{var w=l.lastRenderedState,N=g(w,u);if(p.hasEagerState=!0,p.eagerState=N,Xn(N,w))return Zu(s,l,p,0),gt===null&&Qu(),!1}catch{}if(u=Ov(s,l,p,f),u!==null)return jn(u,s,f),Y0(u,l,f),!0}return!1}function hm(s,l,u,f){if(f={lane:2,revertLane:Hm(),gesture:null,action:f,hasEagerState:!1,eagerState:null,next:null},bd(s)){if(l)throw Error(n(479))}else l=Ov(s,u,f,2),l!==null&&jn(l,s,2)}function bd(s){var l=s.alternate;return s===je||l!==null&&l===je}function J0(s,l){go=hd=!0;var u=s.pending;u===null?l.next=l:(l.next=u.next,u.next=l),s.pending=l}function Y0(s,l,u){if((u&4194048)!==0){var f=l.lanes;f&=s.pendingLanes,u|=f,l.lanes=u,eS(s,u)}}var Xl={readContext:mn,use:md,useCallback:Nt,useContext:Nt,useEffect:Nt,useImperativeHandle:Nt,useLayoutEffect:Nt,useInsertionEffect:Nt,useMemo:Nt,useReducer:Nt,useRef:Nt,useState:Nt,useDebugValue:Nt,useDeferredValue:Nt,useTransition:Nt,useSyncExternalStore:Nt,useId:Nt,useHostTransitionStatus:Nt,useFormState:Nt,useActionState:Nt,useOptimistic:Nt,useMemoCache:Nt,useCacheRefresh:Nt};Xl.useEffectEvent=Nt;var $0={readContext:mn,use:md,useCallback:function(s,l){return wn().memoizedState=[s,l===void 0?null:l],s},useContext:mn,useEffect:D0,useImperativeHandle:function(s,l,u){u=u!=null?u.concat([s]):null,gd(4194308,4,U0.bind(null,l,s),u)},useLayoutEffect:function(s,l){return gd(4194308,4,s,l)},useInsertionEffect:function(s,l){gd(4,2,s,l)},useMemo:function(s,l){var u=wn();l=l===void 0?null:l;var f=s();if(hs){ea(!0);try{s()}finally{ea(!1)}}return u.memoizedState=[f,l],f},useReducer:function(s,l,u){var f=wn();if(u!==void 0){var p=u(l);if(hs){ea(!0);try{u(l)}finally{ea(!1)}}}else p=l;return f.memoizedState=f.baseState=p,s={pending:null,lanes:0,dispatch:null,lastRenderedReducer:s,lastRenderedState:p},f.queue=s,s=s.dispatch=nA.bind(null,je,s),[f.memoizedState,s]},useRef:function(s){var l=wn();return s={current:s},l.memoizedState=s},useState:function(s){s=am(s);var l=s.queue,u=W0.bind(null,je,l);return l.dispatch=u,[s.memoizedState,u]},useDebugValue:lm,useDeferredValue:function(s,l){var u=wn();return cm(u,s,l)},useTransition:function(){var s=am(!1);return s=V0.bind(null,je,s.queue,!0,!1),wn().memoizedState=s,[!1,s]},useSyncExternalStore:function(s,l,u){var f=je,p=wn();if(Ze){if(u===void 0)throw Error(n(407));u=u()}else{if(u=l(),gt===null)throw Error(n(349));($e&127)!==0||g0(f,l,u)}p.memoizedState=u;var g={value:u,getSnapshot:l};return p.queue=g,D0(b0.bind(null,f,g,s),[s]),f.flags|=2048,bo(9,{destroy:void 0},y0.bind(null,f,g,u,l),null),u},useId:function(){var s=wn(),l=gt.identifierPrefix;if(Ze){var u=$i,f=Yi;u=(f&~(1<<32-$n(f)-1)).toString(32)+u,l="_"+l+"R_"+u,u=fd++,0<u&&(l+="H"+u.toString(32)),l+="_"}else u=YP++,l="_"+l+"r_"+u.toString(32)+"_";return s.memoizedState=l},useHostTransitionStatus:dm,useFormState:I0,useActionState:I0,useOptimistic:function(s){var l=wn();l.memoizedState=l.baseState=s;var u={pending:null,lanes:0,dispatch:null,lastRenderedReducer:null,lastRenderedState:null};return l.queue=u,l=hm.bind(null,je,!0,u),u.dispatch=l,[s,l]},useMemoCache:nm,useCacheRefresh:function(){return wn().memoizedState=tA.bind(null,je)},useEffectEvent:function(s){var l=wn(),u={impl:s};return l.memoizedState=u,function(){if((rt&2)!==0)throw Error(n(440));return u.impl.apply(void 0,arguments)}}},fm={readContext:mn,use:md,useCallback:F0,useContext:mn,useEffect:om,useImperativeHandle:B0,useInsertionEffect:x0,useLayoutEffect:L0,useMemo:j0,useReducer:pd,useRef:A0,useState:function(){return pd(_r)},useDebugValue:lm,useDeferredValue:function(s,l){var u=qt();return q0(u,ht.memoizedState,s,l)},useTransition:function(){var s=pd(_r)[0],l=qt().memoizedState;return[typeof s=="boolean"?s:Yl(s),l]},useSyncExternalStore:p0,useId:G0,useHostTransitionStatus:dm,useFormState:O0,useActionState:O0,useOptimistic:function(s,l){var u=qt();return T0(u,ht,s,l)},useMemoCache:nm,useCacheRefresh:z0};fm.useEffectEvent=N0;var X0={readContext:mn,use:md,useCallback:F0,useContext:mn,useEffect:om,useImperativeHandle:B0,useInsertionEffect:x0,useLayoutEffect:L0,useMemo:j0,useReducer:rm,useRef:A0,useState:function(){return rm(_r)},useDebugValue:lm,useDeferredValue:function(s,l){var u=qt();return ht===null?cm(u,s,l):q0(u,ht.memoizedState,s,l)},useTransition:function(){var s=rm(_r)[0],l=qt().memoizedState;return[typeof s=="boolean"?s:Yl(s),l]},useSyncExternalStore:p0,useId:G0,useHostTransitionStatus:dm,useFormState:P0,useActionState:P0,useOptimistic:function(s,l){var u=qt();return ht!==null?T0(u,ht,s,l):(u.baseState=s,[s,u.queue.dispatch])},useMemoCache:nm,useCacheRefresh:z0};X0.useEffectEvent=N0;function vm(s,l,u,f){l=s.memoizedState,u=u(f,l),u=u==null?l:m({},l,u),s.memoizedState=u,s.lanes===0&&(s.updateQueue.baseState=u)}var mm={enqueueSetState:function(s,l,u){s=s._reactInternals;var f=ii(),p=la(f);p.payload=l,u!=null&&(p.callback=u),l=ca(s,p,f),l!==null&&(jn(l,s,f),Gl(l,s,f))},enqueueReplaceState:function(s,l,u){s=s._reactInternals;var f=ii(),p=la(f);p.tag=1,p.payload=l,u!=null&&(p.callback=u),l=ca(s,p,f),l!==null&&(jn(l,s,f),Gl(l,s,f))},enqueueForceUpdate:function(s,l){s=s._reactInternals;var u=ii(),f=la(u);f.tag=2,l!=null&&(f.callback=l),l=ca(s,f,u),l!==null&&(jn(l,s,u),Gl(l,s,u))}};function Q0(s,l,u,f,p,g,w){return s=s.stateNode,typeof s.shouldComponentUpdate=="function"?s.shouldComponentUpdate(f,g,w):l.prototype&&l.prototype.isPureReactComponent?!Ul(u,f)||!Ul(p,g):!0}function Z0(s,l,u,f){s=l.state,typeof l.componentWillReceiveProps=="function"&&l.componentWillReceiveProps(u,f),typeof l.UNSAFE_componentWillReceiveProps=="function"&&l.UNSAFE_componentWillReceiveProps(u,f),l.state!==s&&mm.enqueueReplaceState(l,l.state,null)}function fs(s,l){var u=l;if("ref"in l){u={};for(var f in l)f!=="ref"&&(u[f]=l[f])}if(s=s.defaultProps){u===l&&(u=m({},u));for(var p in s)u[p]===void 0&&(u[p]=s[p])}return u}function eE(s){Xu(s)}function tE(s){console.error(s)}function nE(s){Xu(s)}function Sd(s,l){try{var u=s.onUncaughtError;u(l.value,{componentStack:l.stack})}catch(f){setTimeout(function(){throw f})}}function iE(s,l,u){try{var f=s.onCaughtError;f(u.value,{componentStack:u.stack,errorBoundary:l.tag===1?l.stateNode:null})}catch(p){setTimeout(function(){throw p})}}function pm(s,l,u){return u=la(u),u.tag=3,u.payload={element:null},u.callback=function(){Sd(s,l)},u}function rE(s){return s=la(s),s.tag=3,s}function aE(s,l,u,f){var p=u.type.getDerivedStateFromError;if(typeof p=="function"){var g=f.value;s.payload=function(){return p(g)},s.callback=function(){iE(l,u,f)}}var w=u.stateNode;w!==null&&typeof w.componentDidCatch=="function"&&(s.callback=function(){iE(l,u,f),typeof p!="function"&&(ma===null?ma=new Set([this]):ma.add(this));var N=f.stack;this.componentDidCatch(f.value,{componentStack:N!==null?N:""})})}function iA(s,l,u,f,p){if(u.flags|=32768,f!==null&&typeof f=="object"&&typeof f.then=="function"){if(l=u.alternate,l!==null&&uo(l,u,p,!0),u=Zn.current,u!==null){switch(u.tag){case 31:case 13:return Ti===null?Ad():u.alternate===null&&xt===0&&(xt=3),u.flags&=-257,u.flags|=65536,u.lanes=p,f===od?u.flags|=16384:(l=u.updateQueue,l===null?u.updateQueue=new Set([f]):l.add(f),qm(s,f,p)),!1;case 22:return u.flags|=65536,f===od?u.flags|=16384:(l=u.updateQueue,l===null?(l={transitions:null,markerInstances:null,retryQueue:new Set([f])},u.updateQueue=l):(u=l.retryQueue,u===null?l.retryQueue=new Set([f]):u.add(f)),qm(s,f,p)),!1}throw Error(n(435,u.tag))}return qm(s,f,p),Ad(),!1}if(Ze)return l=Zn.current,l!==null?((l.flags&65536)===0&&(l.flags|=256),l.flags|=65536,l.lanes=p,f!==xv&&(s=Error(n(422),{cause:f}),jl(yi(s,u)))):(f!==xv&&(l=Error(n(423),{cause:f}),jl(yi(l,u))),s=s.current.alternate,s.flags|=65536,p&=-p,s.lanes|=p,f=yi(f,u),p=pm(s.stateNode,f,p),zv(s,p),xt!==4&&(xt=2)),!1;var g=Error(n(520),{cause:f});if(g=yi(g,u),ac===null?ac=[g]:ac.push(g),xt!==4&&(xt=2),l===null)return!0;f=yi(f,u),u=l;do{switch(u.tag){case 3:return u.flags|=65536,s=p&-p,u.lanes|=s,s=pm(u.stateNode,f,s),zv(u,s),!1;case 1:if(l=u.type,g=u.stateNode,(u.flags&128)===0&&(typeof l.getDerivedStateFromError=="function"||g!==null&&typeof g.componentDidCatch=="function"&&(ma===null||!ma.has(g))))return u.flags|=65536,p&=-p,u.lanes|=p,p=rE(p),aE(p,s,u,f),zv(u,p),!1}u=u.return}while(u!==null);return!1}var gm=Error(n(461)),Wt=!1;function pn(s,l,u,f){l.child=s===null?c0(l,null,u,f):ds(l,s.child,u,f)}function sE(s,l,u,f,p){u=u.render;var g=l.ref;if("ref"in f){var w={};for(var N in f)N!=="ref"&&(w[N]=f[N])}else w=f;return os(l),f=Qv(s,l,u,w,g,p),N=Zv(),s!==null&&!Wt?(em(s,l,p),Cr(s,l,p)):(Ze&&N&&Dv(l),l.flags|=1,pn(s,l,f,p),l.child)}function oE(s,l,u,f,p){if(s===null){var g=u.type;return typeof g=="function"&&!Mv(g)&&g.defaultProps===void 0&&u.compare===null?(l.tag=15,l.type=g,lE(s,l,g,f,p)):(s=td(u.type,null,f,l,l.mode,p),s.ref=l.ref,s.return=l,l.child=s)}if(g=s.child,!Rm(s,p)){var w=g.memoizedProps;if(u=u.compare,u=u!==null?u:Ul,u(w,f)&&s.ref===l.ref)return Cr(s,l,p)}return l.flags|=1,s=yr(g,f),s.ref=l.ref,s.return=l,l.child=s}function lE(s,l,u,f,p){if(s!==null){var g=s.memoizedProps;if(Ul(g,f)&&s.ref===l.ref)if(Wt=!1,l.pendingProps=f=g,Rm(s,p))(s.flags&131072)!==0&&(Wt=!0);else return l.lanes=s.lanes,Cr(s,l,p)}return ym(s,l,u,f,p)}function cE(s,l,u,f){var p=f.children,g=s!==null?s.memoizedState:null;if(s===null&&l.stateNode===null&&(l.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),f.mode==="hidden"){if((l.flags&128)!==0){if(g=g!==null?g.baseLanes|u:u,s!==null){for(f=l.child=s.child,p=0;f!==null;)p=p|f.lanes|f.childLanes,f=f.sibling;f=p&~g}else f=0,l.child=null;return uE(s,l,g,u,f)}if((u&536870912)!==0)l.memoizedState={baseLanes:0,cachePool:null},s!==null&&ad(l,g!==null?g.cachePool:null),g!==null?h0(l,g):Jv(),f0(l);else return f=l.lanes=536870912,uE(s,l,g!==null?g.baseLanes|u:u,u,f)}else g!==null?(ad(l,g.cachePool),h0(l,g),da(),l.memoizedState=null):(s!==null&&ad(l,null),Jv(),da());return pn(s,l,p,u),l.child}function Ql(s,l){return s!==null&&s.tag===22||l.stateNode!==null||(l.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),l.sibling}function uE(s,l,u,f,p){var g=Vv();return g=g===null?null:{parent:Gt._currentValue,pool:g},l.memoizedState={baseLanes:u,cachePool:g},s!==null&&ad(l,null),Jv(),f0(l),s!==null&&uo(s,l,f,!0),l.childLanes=p,null}function Ed(s,l){return l=_d({mode:l.mode,children:l.children},s.mode),l.ref=s.ref,s.child=l,l.return=s,l}function dE(s,l,u){return ds(l,s.child,null,u),s=Ed(l,l.pendingProps),s.flags|=2,ei(l),l.memoizedState=null,s}function rA(s,l,u){var f=l.pendingProps,p=(l.flags&128)!==0;if(l.flags&=-129,s===null){if(Ze){if(f.mode==="hidden")return s=Ed(l,f),l.lanes=536870912,Ql(null,s);if($v(l),(s=Rt)?(s=_T(s,Ei),s=s!==null&&s.data==="&"?s:null,s!==null&&(l.memoizedState={dehydrated:s,treeContext:ia!==null?{id:Yi,overflow:$i}:null,retryLane:536870912,hydrationErrors:null},u=JS(s),u.return=l,l.child=u,vn=l,Rt=null)):s=null,s===null)throw aa(l);return l.lanes=536870912,null}return Ed(l,f)}var g=s.memoizedState;if(g!==null){var w=g.dehydrated;if($v(l),p)if(l.flags&256)l.flags&=-257,l=dE(s,l,u);else if(l.memoizedState!==null)l.child=s.child,l.flags|=128,l=null;else throw Error(n(558));else if(Wt||uo(s,l,u,!1),p=(u&s.childLanes)!==0,Wt||p){if(f=gt,f!==null&&(w=tS(f,u),w!==0&&w!==g.retryLane))throw g.retryLane=w,is(s,w),jn(f,s,w),gm;Ad(),l=dE(s,l,u)}else s=g.treeContext,Rt=_i(w.nextSibling),vn=l,Ze=!0,ra=null,Ei=!1,s!==null&&XS(l,s),l=Ed(l,f),l.flags|=4096;return l}return s=yr(s.child,{mode:f.mode,children:f.children}),s.ref=l.ref,l.child=s,s.return=l,s}function Td(s,l){var u=l.ref;if(u===null)s!==null&&s.ref!==null&&(l.flags|=4194816);else{if(typeof u!="function"&&typeof u!="object")throw Error(n(284));(s===null||s.ref!==u)&&(l.flags|=4194816)}}function ym(s,l,u,f,p){return os(l),u=Qv(s,l,u,f,void 0,p),f=Zv(),s!==null&&!Wt?(em(s,l,p),Cr(s,l,p)):(Ze&&f&&Dv(l),l.flags|=1,pn(s,l,u,p),l.child)}function hE(s,l,u,f,p,g){return os(l),l.updateQueue=null,u=m0(l,f,u,p),v0(s),f=Zv(),s!==null&&!Wt?(em(s,l,g),Cr(s,l,g)):(Ze&&f&&Dv(l),l.flags|=1,pn(s,l,u,g),l.child)}function fE(s,l,u,f,p){if(os(l),l.stateNode===null){var g=so,w=u.contextType;typeof w=="object"&&w!==null&&(g=mn(w)),g=new u(f,g),l.memoizedState=g.state!==null&&g.state!==void 0?g.state:null,g.updater=mm,l.stateNode=g,g._reactInternals=l,g=l.stateNode,g.props=f,g.state=l.memoizedState,g.refs={},Hv(l),w=u.contextType,g.context=typeof w=="object"&&w!==null?mn(w):so,g.state=l.memoizedState,w=u.getDerivedStateFromProps,typeof w=="function"&&(vm(l,u,w,f),g.state=l.memoizedState),typeof u.getDerivedStateFromProps=="function"||typeof g.getSnapshotBeforeUpdate=="function"||typeof g.UNSAFE_componentWillMount!="function"&&typeof g.componentWillMount!="function"||(w=g.state,typeof g.componentWillMount=="function"&&g.componentWillMount(),typeof g.UNSAFE_componentWillMount=="function"&&g.UNSAFE_componentWillMount(),w!==g.state&&mm.enqueueReplaceState(g,g.state,null),Wl(l,f,g,p),zl(),g.state=l.memoizedState),typeof g.componentDidMount=="function"&&(l.flags|=4194308),f=!0}else if(s===null){g=l.stateNode;var N=l.memoizedProps,B=fs(u,N);g.props=B;var W=g.context,ne=u.contextType;w=so,typeof ne=="object"&&ne!==null&&(w=mn(ne));var re=u.getDerivedStateFromProps;ne=typeof re=="function"||typeof g.getSnapshotBeforeUpdate=="function",N=l.pendingProps!==N,ne||typeof g.UNSAFE_componentWillReceiveProps!="function"&&typeof g.componentWillReceiveProps!="function"||(N||W!==w)&&Z0(l,g,f,w),oa=!1;var Y=l.memoizedState;g.state=Y,Wl(l,f,g,p),zl(),W=l.memoizedState,N||Y!==W||oa?(typeof re=="function"&&(vm(l,u,re,f),W=l.memoizedState),(B=oa||Q0(l,u,B,f,Y,W,w))?(ne||typeof g.UNSAFE_componentWillMount!="function"&&typeof g.componentWillMount!="function"||(typeof g.componentWillMount=="function"&&g.componentWillMount(),typeof g.UNSAFE_componentWillMount=="function"&&g.UNSAFE_componentWillMount()),typeof g.componentDidMount=="function"&&(l.flags|=4194308)):(typeof g.componentDidMount=="function"&&(l.flags|=4194308),l.memoizedProps=f,l.memoizedState=W),g.props=f,g.state=W,g.context=w,f=B):(typeof g.componentDidMount=="function"&&(l.flags|=4194308),f=!1)}else{g=l.stateNode,Gv(s,l),w=l.memoizedProps,ne=fs(u,w),g.props=ne,re=l.pendingProps,Y=g.context,W=u.contextType,B=so,typeof W=="object"&&W!==null&&(B=mn(W)),N=u.getDerivedStateFromProps,(W=typeof N=="function"||typeof g.getSnapshotBeforeUpdate=="function")||typeof g.UNSAFE_componentWillReceiveProps!="function"&&typeof g.componentWillReceiveProps!="function"||(w!==re||Y!==B)&&Z0(l,g,f,B),oa=!1,Y=l.memoizedState,g.state=Y,Wl(l,f,g,p),zl();var X=l.memoizedState;w!==re||Y!==X||oa||s!==null&&s.dependencies!==null&&id(s.dependencies)?(typeof N=="function"&&(vm(l,u,N,f),X=l.memoizedState),(ne=oa||Q0(l,u,ne,f,Y,X,B)||s!==null&&s.dependencies!==null&&id(s.dependencies))?(W||typeof g.UNSAFE_componentWillUpdate!="function"&&typeof g.componentWillUpdate!="function"||(typeof g.componentWillUpdate=="function"&&g.componentWillUpdate(f,X,B),typeof g.UNSAFE_componentWillUpdate=="function"&&g.UNSAFE_componentWillUpdate(f,X,B)),typeof g.componentDidUpdate=="function"&&(l.flags|=4),typeof g.getSnapshotBeforeUpdate=="function"&&(l.flags|=1024)):(typeof g.componentDidUpdate!="function"||w===s.memoizedProps&&Y===s.memoizedState||(l.flags|=4),typeof g.getSnapshotBeforeUpdate!="function"||w===s.memoizedProps&&Y===s.memoizedState||(l.flags|=1024),l.memoizedProps=f,l.memoizedState=X),g.props=f,g.state=X,g.context=B,f=ne):(typeof g.componentDidUpdate!="function"||w===s.memoizedProps&&Y===s.memoizedState||(l.flags|=4),typeof g.getSnapshotBeforeUpdate!="function"||w===s.memoizedProps&&Y===s.memoizedState||(l.flags|=1024),f=!1)}return g=f,Td(s,l),f=(l.flags&128)!==0,g||f?(g=l.stateNode,u=f&&typeof u.getDerivedStateFromError!="function"?null:g.render(),l.flags|=1,s!==null&&f?(l.child=ds(l,s.child,null,p),l.child=ds(l,null,u,p)):pn(s,l,u,p),l.memoizedState=g.state,s=l.child):s=Cr(s,l,p),s}function vE(s,l,u,f){return as(),l.flags|=256,pn(s,l,u,f),l.child}var bm={dehydrated:null,treeContext:null,retryLane:0,hydrationErrors:null};function Sm(s){return{baseLanes:s,cachePool:i0()}}function Em(s,l,u){return s=s!==null?s.childLanes&~u:0,l&&(s|=ni),s}function mE(s,l,u){var f=l.pendingProps,p=!1,g=(l.flags&128)!==0,w;if((w=g)||(w=s!==null&&s.memoizedState===null?!1:(jt.current&2)!==0),w&&(p=!0,l.flags&=-129),w=(l.flags&32)!==0,l.flags&=-33,s===null){if(Ze){if(p?ua(l):da(),(s=Rt)?(s=_T(s,Ei),s=s!==null&&s.data!=="&"?s:null,s!==null&&(l.memoizedState={dehydrated:s,treeContext:ia!==null?{id:Yi,overflow:$i}:null,retryLane:536870912,hydrationErrors:null},u=JS(s),u.return=l,l.child=u,vn=l,Rt=null)):s=null,s===null)throw aa(l);return ip(s)?l.lanes=32:l.lanes=536870912,null}var N=f.children;return f=f.fallback,p?(da(),p=l.mode,N=_d({mode:"hidden",children:N},p),f=rs(f,p,u,null),N.return=l,f.return=l,N.sibling=f,l.child=N,f=l.child,f.memoizedState=Sm(u),f.childLanes=Em(s,w,u),l.memoizedState=bm,Ql(null,f)):(ua(l),Tm(l,N))}var B=s.memoizedState;if(B!==null&&(N=B.dehydrated,N!==null)){if(g)l.flags&256?(ua(l),l.flags&=-257,l=_m(s,l,u)):l.memoizedState!==null?(da(),l.child=s.child,l.flags|=128,l=null):(da(),N=f.fallback,p=l.mode,f=_d({mode:"visible",children:f.children},p),N=rs(N,p,u,null),N.flags|=2,f.return=l,N.return=l,f.sibling=N,l.child=f,ds(l,s.child,null,u),f=l.child,f.memoizedState=Sm(u),f.childLanes=Em(s,w,u),l.memoizedState=bm,l=Ql(null,f));else if(ua(l),ip(N)){if(w=N.nextSibling&&N.nextSibling.dataset,w)var W=w.dgst;w=W,f=Error(n(419)),f.stack="",f.digest=w,jl({value:f,source:null,stack:null}),l=_m(s,l,u)}else if(Wt||uo(s,l,u,!1),w=(u&s.childLanes)!==0,Wt||w){if(w=gt,w!==null&&(f=tS(w,u),f!==0&&f!==B.retryLane))throw B.retryLane=f,is(s,f),jn(w,s,f),gm;np(N)||Ad(),l=_m(s,l,u)}else np(N)?(l.flags|=192,l.child=s.child,l=null):(s=B.treeContext,Rt=_i(N.nextSibling),vn=l,Ze=!0,ra=null,Ei=!1,s!==null&&XS(l,s),l=Tm(l,f.children),l.flags|=4096);return l}return p?(da(),N=f.fallback,p=l.mode,B=s.child,W=B.sibling,f=yr(B,{mode:"hidden",children:f.children}),f.subtreeFlags=B.subtreeFlags&65011712,W!==null?N=yr(W,N):(N=rs(N,p,u,null),N.flags|=2),N.return=l,f.return=l,f.sibling=N,l.child=f,Ql(null,f),f=l.child,N=s.child.memoizedState,N===null?N=Sm(u):(p=N.cachePool,p!==null?(B=Gt._currentValue,p=p.parent!==B?{parent:B,pool:B}:p):p=i0(),N={baseLanes:N.baseLanes|u,cachePool:p}),f.memoizedState=N,f.childLanes=Em(s,w,u),l.memoizedState=bm,Ql(s.child,f)):(ua(l),u=s.child,s=u.sibling,u=yr(u,{mode:"visible",children:f.children}),u.return=l,u.sibling=null,s!==null&&(w=l.deletions,w===null?(l.deletions=[s],l.flags|=16):w.push(s)),l.child=u,l.memoizedState=null,u)}function Tm(s,l){return l=_d({mode:"visible",children:l},s.mode),l.return=s,s.child=l}function _d(s,l){return s=Qn(22,s,null,l),s.lanes=0,s}function _m(s,l,u){return ds(l,s.child,null,u),s=Tm(l,l.pendingProps.children),s.flags|=2,l.memoizedState=null,s}function pE(s,l,u){s.lanes|=l;var f=s.alternate;f!==null&&(f.lanes|=l),Bv(s.return,l,u)}function Cm(s,l,u,f,p,g){var w=s.memoizedState;w===null?s.memoizedState={isBackwards:l,rendering:null,renderingStartTime:0,last:f,tail:u,tailMode:p,treeForkCount:g}:(w.isBackwards=l,w.rendering=null,w.renderingStartTime=0,w.last=f,w.tail=u,w.tailMode=p,w.treeForkCount=g)}function gE(s,l,u){var f=l.pendingProps,p=f.revealOrder,g=f.tail;f=f.children;var w=jt.current,N=(w&2)!==0;if(N?(w=w&1|2,l.flags|=128):w&=1,de(jt,w),pn(s,l,f,u),f=Ze?Fl:0,!N&&s!==null&&(s.flags&128)!==0)e:for(s=l.child;s!==null;){if(s.tag===13)s.memoizedState!==null&&pE(s,u,l);else if(s.tag===19)pE(s,u,l);else if(s.child!==null){s.child.return=s,s=s.child;continue}if(s===l)break e;for(;s.sibling===null;){if(s.return===null||s.return===l)break e;s=s.return}s.sibling.return=s.return,s=s.sibling}switch(p){case"forwards":for(u=l.child,p=null;u!==null;)s=u.alternate,s!==null&&dd(s)===null&&(p=u),u=u.sibling;u=p,u===null?(p=l.child,l.child=null):(p=u.sibling,u.sibling=null),Cm(l,!1,p,u,g,f);break;case"backwards":case"unstable_legacy-backwards":for(u=null,p=l.child,l.child=null;p!==null;){if(s=p.alternate,s!==null&&dd(s)===null){l.child=p;break}s=p.sibling,p.sibling=u,u=p,p=s}Cm(l,!0,u,null,g,f);break;case"together":Cm(l,!1,null,null,void 0,f);break;default:l.memoizedState=null}return l.child}function Cr(s,l,u){if(s!==null&&(l.dependencies=s.dependencies),va|=l.lanes,(u&l.childLanes)===0)if(s!==null){if(uo(s,l,u,!1),(u&l.childLanes)===0)return null}else return null;if(s!==null&&l.child!==s.child)throw Error(n(153));if(l.child!==null){for(s=l.child,u=yr(s,s.pendingProps),l.child=u,u.return=l;s.sibling!==null;)s=s.sibling,u=u.sibling=yr(s,s.pendingProps),u.return=l;u.sibling=null}return l.child}function Rm(s,l){return(s.lanes&l)!==0?!0:(s=s.dependencies,!!(s!==null&&id(s)))}function aA(s,l,u){switch(l.tag){case 3:lt(l,l.stateNode.containerInfo),sa(l,Gt,s.memoizedState.cache),as();break;case 27:case 5:Ji(l);break;case 4:lt(l,l.stateNode.containerInfo);break;case 10:sa(l,l.type,l.memoizedProps.value);break;case 31:if(l.memoizedState!==null)return l.flags|=128,$v(l),null;break;case 13:var f=l.memoizedState;if(f!==null)return f.dehydrated!==null?(ua(l),l.flags|=128,null):(u&l.child.childLanes)!==0?mE(s,l,u):(ua(l),s=Cr(s,l,u),s!==null?s.sibling:null);ua(l);break;case 19:var p=(s.flags&128)!==0;if(f=(u&l.childLanes)!==0,f||(uo(s,l,u,!1),f=(u&l.childLanes)!==0),p){if(f)return gE(s,l,u);l.flags|=128}if(p=l.memoizedState,p!==null&&(p.rendering=null,p.tail=null,p.lastEffect=null),de(jt,jt.current),f)break;return null;case 22:return l.lanes=0,cE(s,l,u,l.pendingProps);case 24:sa(l,Gt,s.memoizedState.cache)}return Cr(s,l,u)}function yE(s,l,u){if(s!==null)if(s.memoizedProps!==l.pendingProps)Wt=!0;else{if(!Rm(s,u)&&(l.flags&128)===0)return Wt=!1,aA(s,l,u);Wt=(s.flags&131072)!==0}else Wt=!1,Ze&&(l.flags&1048576)!==0&&$S(l,Fl,l.index);switch(l.lanes=0,l.tag){case 16:e:{var f=l.pendingProps;if(s=cs(l.elementType),l.type=s,typeof s=="function")Mv(s)?(f=fs(s,f),l.tag=1,l=fE(null,l,s,f,u)):(l.tag=0,l=ym(null,l,s,f,u));else{if(s!=null){var p=s.$$typeof;if(p===C){l.tag=11,l=sE(null,l,s,f,u);break e}else if(p===P){l.tag=14,l=oE(null,l,s,f,u);break e}}throw l=Pe(s)||s,Error(n(306,l,""))}}return l;case 0:return ym(s,l,l.type,l.pendingProps,u);case 1:return f=l.type,p=fs(f,l.pendingProps),fE(s,l,f,p,u);case 3:e:{if(lt(l,l.stateNode.containerInfo),s===null)throw Error(n(387));f=l.pendingProps;var g=l.memoizedState;p=g.element,Gv(s,l),Wl(l,f,null,u);var w=l.memoizedState;if(f=w.cache,sa(l,Gt,f),f!==g.cache&&Fv(l,[Gt],u,!0),zl(),f=w.element,g.isDehydrated)if(g={element:f,isDehydrated:!1,cache:w.cache},l.updateQueue.baseState=g,l.memoizedState=g,l.flags&256){l=vE(s,l,f,u);break e}else if(f!==p){p=yi(Error(n(424)),l),jl(p),l=vE(s,l,f,u);break e}else for(s=l.stateNode.containerInfo,s.nodeType===9?s=s.body:s=s.nodeName==="HTML"?s.ownerDocument.body:s,Rt=_i(s.firstChild),vn=l,Ze=!0,ra=null,Ei=!0,u=c0(l,null,f,u),l.child=u;u;)u.flags=u.flags&-3|4096,u=u.sibling;else{if(as(),f===p){l=Cr(s,l,u);break e}pn(s,l,f,u)}l=l.child}return l;case 26:return Td(s,l),s===null?(u=OT(l.type,null,l.pendingProps,null))?l.memoizedState=u:Ze||(u=l.type,s=l.pendingProps,f=Fd(Ae.current).createElement(u),f[fn]=l,f[Nn]=s,gn(f,u,s),sn(f),l.stateNode=f):l.memoizedState=OT(l.type,s.memoizedProps,l.pendingProps,s.memoizedState),null;case 27:return Ji(l),s===null&&Ze&&(f=l.stateNode=kT(l.type,l.pendingProps,Ae.current),vn=l,Ei=!0,p=Rt,ba(l.type)?(rp=p,Rt=_i(f.firstChild)):Rt=p),pn(s,l,l.pendingProps.children,u),Td(s,l),s===null&&(l.flags|=4194304),l.child;case 5:return s===null&&Ze&&((p=f=Rt)&&(f=xA(f,l.type,l.pendingProps,Ei),f!==null?(l.stateNode=f,vn=l,Rt=_i(f.firstChild),Ei=!1,p=!0):p=!1),p||aa(l)),Ji(l),p=l.type,g=l.pendingProps,w=s!==null?s.memoizedProps:null,f=g.children,Zm(p,g)?f=null:w!==null&&Zm(p,w)&&(l.flags|=32),l.memoizedState!==null&&(p=Qv(s,l,$P,null,null,u),fc._currentValue=p),Td(s,l),pn(s,l,f,u),l.child;case 6:return s===null&&Ze&&((s=u=Rt)&&(u=LA(u,l.pendingProps,Ei),u!==null?(l.stateNode=u,vn=l,Rt=null,s=!0):s=!1),s||aa(l)),null;case 13:return mE(s,l,u);case 4:return lt(l,l.stateNode.containerInfo),f=l.pendingProps,s===null?l.child=ds(l,null,f,u):pn(s,l,f,u),l.child;case 11:return sE(s,l,l.type,l.pendingProps,u);case 7:return pn(s,l,l.pendingProps,u),l.child;case 8:return pn(s,l,l.pendingProps.children,u),l.child;case 12:return pn(s,l,l.pendingProps.children,u),l.child;case 10:return f=l.pendingProps,sa(l,l.type,f.value),pn(s,l,f.children,u),l.child;case 9:return p=l.type._context,f=l.pendingProps.children,os(l),p=mn(p),f=f(p),l.flags|=1,pn(s,l,f,u),l.child;case 14:return oE(s,l,l.type,l.pendingProps,u);case 15:return lE(s,l,l.type,l.pendingProps,u);case 19:return gE(s,l,u);case 31:return rA(s,l,u);case 22:return cE(s,l,u,l.pendingProps);case 24:return os(l),f=mn(Gt),s===null?(p=Vv(),p===null&&(p=gt,g=jv(),p.pooledCache=g,g.refCount++,g!==null&&(p.pooledCacheLanes|=u),p=g),l.memoizedState={parent:f,cache:p},Hv(l),sa(l,Gt,p)):((s.lanes&u)!==0&&(Gv(s,l),Wl(l,null,null,u),zl()),p=s.memoizedState,g=l.memoizedState,p.parent!==f?(p={parent:f,cache:f},l.memoizedState=p,l.lanes===0&&(l.memoizedState=l.updateQueue.baseState=p),sa(l,Gt,f)):(f=g.cache,sa(l,Gt,f),f!==p.cache&&Fv(l,[Gt],u,!0))),pn(s,l,l.pendingProps.children,u),l.child;case 29:throw l.pendingProps}throw Error(n(156,l.tag))}function Rr(s){s.flags|=4}function km(s,l,u,f,p){if((l=(s.mode&32)!==0)&&(l=!1),l){if(s.flags|=16777216,(p&335544128)===p)if(s.stateNode.complete)s.flags|=8192;else if(GE())s.flags|=8192;else throw us=od,Kv}else s.flags&=-16777217}function bE(s,l){if(l.type!=="stylesheet"||(l.state.loading&4)!==0)s.flags&=-16777217;else if(s.flags|=16777216,!NT(l))if(GE())s.flags|=8192;else throw us=od,Kv}function Cd(s,l){l!==null&&(s.flags|=4),s.flags&16384&&(l=s.tag!==22?Qb():536870912,s.lanes|=l,_o|=l)}function Zl(s,l){if(!Ze)switch(s.tailMode){case"hidden":l=s.tail;for(var u=null;l!==null;)l.alternate!==null&&(u=l),l=l.sibling;u===null?s.tail=null:u.sibling=null;break;case"collapsed":u=s.tail;for(var f=null;u!==null;)u.alternate!==null&&(f=u),u=u.sibling;f===null?l||s.tail===null?s.tail=null:s.tail.sibling=null:f.sibling=null}}function kt(s){var l=s.alternate!==null&&s.alternate.child===s.child,u=0,f=0;if(l)for(var p=s.child;p!==null;)u|=p.lanes|p.childLanes,f|=p.subtreeFlags&65011712,f|=p.flags&65011712,p.return=s,p=p.sibling;else for(p=s.child;p!==null;)u|=p.lanes|p.childLanes,f|=p.subtreeFlags,f|=p.flags,p.return=s,p=p.sibling;return s.subtreeFlags|=f,s.childLanes=u,l}function sA(s,l,u){var f=l.pendingProps;switch(Nv(l),l.tag){case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return kt(l),null;case 1:return kt(l),null;case 3:return u=l.stateNode,f=null,s!==null&&(f=s.memoizedState.cache),l.memoizedState.cache!==f&&(l.flags|=2048),Er(Gt),He(),u.pendingContext&&(u.context=u.pendingContext,u.pendingContext=null),(s===null||s.child===null)&&(co(l)?Rr(l):s===null||s.memoizedState.isDehydrated&&(l.flags&256)===0||(l.flags|=1024,Lv())),kt(l),null;case 26:var p=l.type,g=l.memoizedState;return s===null?(Rr(l),g!==null?(kt(l),bE(l,g)):(kt(l),km(l,p,null,f,u))):g?g!==s.memoizedState?(Rr(l),kt(l),bE(l,g)):(kt(l),l.flags&=-16777217):(s=s.memoizedProps,s!==f&&Rr(l),kt(l),km(l,p,s,f,u)),null;case 27:if(xu(l),u=Ae.current,p=l.type,s!==null&&l.stateNode!=null)s.memoizedProps!==f&&Rr(l);else{if(!f){if(l.stateNode===null)throw Error(n(166));return kt(l),null}s=pe.current,co(l)?QS(l):(s=kT(p,f,u),l.stateNode=s,Rr(l))}return kt(l),null;case 5:if(xu(l),p=l.type,s!==null&&l.stateNode!=null)s.memoizedProps!==f&&Rr(l);else{if(!f){if(l.stateNode===null)throw Error(n(166));return kt(l),null}if(g=pe.current,co(l))QS(l);else{var w=Fd(Ae.current);switch(g){case 1:g=w.createElementNS("http://www.w3.org/2000/svg",p);break;case 2:g=w.createElementNS("http://www.w3.org/1998/Math/MathML",p);break;default:switch(p){case"svg":g=w.createElementNS("http://www.w3.org/2000/svg",p);break;case"math":g=w.createElementNS("http://www.w3.org/1998/Math/MathML",p);break;case"script":g=w.createElement("div"),g.innerHTML="<script><\/script>",g=g.removeChild(g.firstChild);break;case"select":g=typeof f.is=="string"?w.createElement("select",{is:f.is}):w.createElement("select"),f.multiple?g.multiple=!0:f.size&&(g.size=f.size);break;default:g=typeof f.is=="string"?w.createElement(p,{is:f.is}):w.createElement(p)}}g[fn]=l,g[Nn]=f;e:for(w=l.child;w!==null;){if(w.tag===5||w.tag===6)g.appendChild(w.stateNode);else if(w.tag!==4&&w.tag!==27&&w.child!==null){w.child.return=w,w=w.child;continue}if(w===l)break e;for(;w.sibling===null;){if(w.return===null||w.return===l)break e;w=w.return}w.sibling.return=w.return,w=w.sibling}l.stateNode=g;e:switch(gn(g,p,f),p){case"button":case"input":case"select":case"textarea":f=!!f.autoFocus;break e;case"img":f=!0;break e;default:f=!1}f&&Rr(l)}}return kt(l),km(l,l.type,s===null?null:s.memoizedProps,l.pendingProps,u),null;case 6:if(s&&l.stateNode!=null)s.memoizedProps!==f&&Rr(l);else{if(typeof f!="string"&&l.stateNode===null)throw Error(n(166));if(s=Ae.current,co(l)){if(s=l.stateNode,u=l.memoizedProps,f=null,p=vn,p!==null)switch(p.tag){case 27:case 5:f=p.memoizedProps}s[fn]=l,s=!!(s.nodeValue===u||f!==null&&f.suppressHydrationWarning===!0||mT(s.nodeValue,u)),s||aa(l,!0)}else s=Fd(s).createTextNode(f),s[fn]=l,l.stateNode=s}return kt(l),null;case 31:if(u=l.memoizedState,s===null||s.memoizedState!==null){if(f=co(l),u!==null){if(s===null){if(!f)throw Error(n(318));if(s=l.memoizedState,s=s!==null?s.dehydrated:null,!s)throw Error(n(557));s[fn]=l}else as(),(l.flags&128)===0&&(l.memoizedState=null),l.flags|=4;kt(l),s=!1}else u=Lv(),s!==null&&s.memoizedState!==null&&(s.memoizedState.hydrationErrors=u),s=!0;if(!s)return l.flags&256?(ei(l),l):(ei(l),null);if((l.flags&128)!==0)throw Error(n(558))}return kt(l),null;case 13:if(f=l.memoizedState,s===null||s.memoizedState!==null&&s.memoizedState.dehydrated!==null){if(p=co(l),f!==null&&f.dehydrated!==null){if(s===null){if(!p)throw Error(n(318));if(p=l.memoizedState,p=p!==null?p.dehydrated:null,!p)throw Error(n(317));p[fn]=l}else as(),(l.flags&128)===0&&(l.memoizedState=null),l.flags|=4;kt(l),p=!1}else p=Lv(),s!==null&&s.memoizedState!==null&&(s.memoizedState.hydrationErrors=p),p=!0;if(!p)return l.flags&256?(ei(l),l):(ei(l),null)}return ei(l),(l.flags&128)!==0?(l.lanes=u,l):(u=f!==null,s=s!==null&&s.memoizedState!==null,u&&(f=l.child,p=null,f.alternate!==null&&f.alternate.memoizedState!==null&&f.alternate.memoizedState.cachePool!==null&&(p=f.alternate.memoizedState.cachePool.pool),g=null,f.memoizedState!==null&&f.memoizedState.cachePool!==null&&(g=f.memoizedState.cachePool.pool),g!==p&&(f.flags|=2048)),u!==s&&u&&(l.child.flags|=8192),Cd(l,l.updateQueue),kt(l),null);case 4:return He(),s===null&&Jm(l.stateNode.containerInfo),kt(l),null;case 10:return Er(l.type),kt(l),null;case 19:if(ee(jt),f=l.memoizedState,f===null)return kt(l),null;if(p=(l.flags&128)!==0,g=f.rendering,g===null)if(p)Zl(f,!1);else{if(xt!==0||s!==null&&(s.flags&128)!==0)for(s=l.child;s!==null;){if(g=dd(s),g!==null){for(l.flags|=128,Zl(f,!1),s=g.updateQueue,l.updateQueue=s,Cd(l,s),l.subtreeFlags=0,s=u,u=l.child;u!==null;)WS(u,s),u=u.sibling;return de(jt,jt.current&1|2),Ze&&br(l,f.treeForkCount),l.child}s=s.sibling}f.tail!==null&&Jn()>Od&&(l.flags|=128,p=!0,Zl(f,!1),l.lanes=4194304)}else{if(!p)if(s=dd(g),s!==null){if(l.flags|=128,p=!0,s=s.updateQueue,l.updateQueue=s,Cd(l,s),Zl(f,!0),f.tail===null&&f.tailMode==="hidden"&&!g.alternate&&!Ze)return kt(l),null}else 2*Jn()-f.renderingStartTime>Od&&u!==536870912&&(l.flags|=128,p=!0,Zl(f,!1),l.lanes=4194304);f.isBackwards?(g.sibling=l.child,l.child=g):(s=f.last,s!==null?s.sibling=g:l.child=g,f.last=g)}return f.tail!==null?(s=f.tail,f.rendering=s,f.tail=s.sibling,f.renderingStartTime=Jn(),s.sibling=null,u=jt.current,de(jt,p?u&1|2:u&1),Ze&&br(l,f.treeForkCount),s):(kt(l),null);case 22:case 23:return ei(l),Yv(),f=l.memoizedState!==null,s!==null?s.memoizedState!==null!==f&&(l.flags|=8192):f&&(l.flags|=8192),f?(u&536870912)!==0&&(l.flags&128)===0&&(kt(l),l.subtreeFlags&6&&(l.flags|=8192)):kt(l),u=l.updateQueue,u!==null&&Cd(l,u.retryQueue),u=null,s!==null&&s.memoizedState!==null&&s.memoizedState.cachePool!==null&&(u=s.memoizedState.cachePool.pool),f=null,l.memoizedState!==null&&l.memoizedState.cachePool!==null&&(f=l.memoizedState.cachePool.pool),f!==u&&(l.flags|=2048),s!==null&&ee(ls),null;case 24:return u=null,s!==null&&(u=s.memoizedState.cache),l.memoizedState.cache!==u&&(l.flags|=2048),Er(Gt),kt(l),null;case 25:return null;case 30:return null}throw Error(n(156,l.tag))}function oA(s,l){switch(Nv(l),l.tag){case 1:return s=l.flags,s&65536?(l.flags=s&-65537|128,l):null;case 3:return Er(Gt),He(),s=l.flags,(s&65536)!==0&&(s&128)===0?(l.flags=s&-65537|128,l):null;case 26:case 27:case 5:return xu(l),null;case 31:if(l.memoizedState!==null){if(ei(l),l.alternate===null)throw Error(n(340));as()}return s=l.flags,s&65536?(l.flags=s&-65537|128,l):null;case 13:if(ei(l),s=l.memoizedState,s!==null&&s.dehydrated!==null){if(l.alternate===null)throw Error(n(340));as()}return s=l.flags,s&65536?(l.flags=s&-65537|128,l):null;case 19:return ee(jt),null;case 4:return He(),null;case 10:return Er(l.type),null;case 22:case 23:return ei(l),Yv(),s!==null&&ee(ls),s=l.flags,s&65536?(l.flags=s&-65537|128,l):null;case 24:return Er(Gt),null;case 25:return null;default:return null}}function SE(s,l){switch(Nv(l),l.tag){case 3:Er(Gt),He();break;case 26:case 27:case 5:xu(l);break;case 4:He();break;case 31:l.memoizedState!==null&&ei(l);break;case 13:ei(l);break;case 19:ee(jt);break;case 10:Er(l.type);break;case 22:case 23:ei(l),Yv(),s!==null&&ee(ls);break;case 24:Er(Gt)}}function ec(s,l){try{var u=l.updateQueue,f=u!==null?u.lastEffect:null;if(f!==null){var p=f.next;u=p;do{if((u.tag&s)===s){f=void 0;var g=u.create,w=u.inst;f=g(),w.destroy=f}u=u.next}while(u!==p)}}catch(N){dt(l,l.return,N)}}function ha(s,l,u){try{var f=l.updateQueue,p=f!==null?f.lastEffect:null;if(p!==null){var g=p.next;f=g;do{if((f.tag&s)===s){var w=f.inst,N=w.destroy;if(N!==void 0){w.destroy=void 0,p=l;var B=u,W=N;try{W()}catch(ne){dt(p,B,ne)}}}f=f.next}while(f!==g)}}catch(ne){dt(l,l.return,ne)}}function EE(s){var l=s.updateQueue;if(l!==null){var u=s.stateNode;try{d0(l,u)}catch(f){dt(s,s.return,f)}}}function TE(s,l,u){u.props=fs(s.type,s.memoizedProps),u.state=s.memoizedState;try{u.componentWillUnmount()}catch(f){dt(s,l,f)}}function tc(s,l){try{var u=s.ref;if(u!==null){switch(s.tag){case 26:case 27:case 5:var f=s.stateNode;break;case 30:f=s.stateNode;break;default:f=s.stateNode}typeof u=="function"?s.refCleanup=u(f):u.current=f}}catch(p){dt(s,l,p)}}function Xi(s,l){var u=s.ref,f=s.refCleanup;if(u!==null)if(typeof f=="function")try{f()}catch(p){dt(s,l,p)}finally{s.refCleanup=null,s=s.alternate,s!=null&&(s.refCleanup=null)}else if(typeof u=="function")try{u(null)}catch(p){dt(s,l,p)}else u.current=null}function _E(s){var l=s.type,u=s.memoizedProps,f=s.stateNode;try{e:switch(l){case"button":case"input":case"select":case"textarea":u.autoFocus&&f.focus();break e;case"img":u.src?f.src=u.src:u.srcSet&&(f.srcset=u.srcSet)}}catch(p){dt(s,s.return,p)}}function wm(s,l,u){try{var f=s.stateNode;OA(f,s.type,u,l),f[Nn]=l}catch(p){dt(s,s.return,p)}}function CE(s){return s.tag===5||s.tag===3||s.tag===26||s.tag===27&&ba(s.type)||s.tag===4}function Im(s){e:for(;;){for(;s.sibling===null;){if(s.return===null||CE(s.return))return null;s=s.return}for(s.sibling.return=s.return,s=s.sibling;s.tag!==5&&s.tag!==6&&s.tag!==18;){if(s.tag===27&&ba(s.type)||s.flags&2||s.child===null||s.tag===4)continue e;s.child.return=s,s=s.child}if(!(s.flags&2))return s.stateNode}}function Om(s,l,u){var f=s.tag;if(f===5||f===6)s=s.stateNode,l?(u.nodeType===9?u.body:u.nodeName==="HTML"?u.ownerDocument.body:u).insertBefore(s,l):(l=u.nodeType===9?u.body:u.nodeName==="HTML"?u.ownerDocument.body:u,l.appendChild(s),u=u._reactRootContainer,u!=null||l.onclick!==null||(l.onclick=pr));else if(f!==4&&(f===27&&ba(s.type)&&(u=s.stateNode,l=null),s=s.child,s!==null))for(Om(s,l,u),s=s.sibling;s!==null;)Om(s,l,u),s=s.sibling}function Rd(s,l,u){var f=s.tag;if(f===5||f===6)s=s.stateNode,l?u.insertBefore(s,l):u.appendChild(s);else if(f!==4&&(f===27&&ba(s.type)&&(u=s.stateNode),s=s.child,s!==null))for(Rd(s,l,u),s=s.sibling;s!==null;)Rd(s,l,u),s=s.sibling}function RE(s){var l=s.stateNode,u=s.memoizedProps;try{for(var f=s.type,p=l.attributes;p.length;)l.removeAttributeNode(p[0]);gn(l,f,u),l[fn]=s,l[Nn]=u}catch(g){dt(s,s.return,g)}}var kr=!1,Jt=!1,Mm=!1,kE=typeof WeakSet=="function"?WeakSet:Set,on=null;function lA(s,l){if(s=s.containerInfo,Xm=zd,s=BS(s),_v(s)){if("selectionStart"in s)var u={start:s.selectionStart,end:s.selectionEnd};else e:{u=(u=s.ownerDocument)&&u.defaultView||window;var f=u.getSelection&&u.getSelection();if(f&&f.rangeCount!==0){u=f.anchorNode;var p=f.anchorOffset,g=f.focusNode;f=f.focusOffset;try{u.nodeType,g.nodeType}catch{u=null;break e}var w=0,N=-1,B=-1,W=0,ne=0,re=s,Y=null;t:for(;;){for(var X;re!==u||p!==0&&re.nodeType!==3||(N=w+p),re!==g||f!==0&&re.nodeType!==3||(B=w+f),re.nodeType===3&&(w+=re.nodeValue.length),(X=re.firstChild)!==null;)Y=re,re=X;for(;;){if(re===s)break t;if(Y===u&&++W===p&&(N=w),Y===g&&++ne===f&&(B=w),(X=re.nextSibling)!==null)break;re=Y,Y=re.parentNode}re=X}u=N===-1||B===-1?null:{start:N,end:B}}else u=null}u=u||{start:0,end:0}}else u=null;for(Qm={focusedElem:s,selectionRange:u},zd=!1,on=l;on!==null;)if(l=on,s=l.child,(l.subtreeFlags&1028)!==0&&s!==null)s.return=l,on=s;else for(;on!==null;){switch(l=on,g=l.alternate,s=l.flags,l.tag){case 0:if((s&4)!==0&&(s=l.updateQueue,s=s!==null?s.events:null,s!==null))for(u=0;u<s.length;u++)p=s[u],p.ref.impl=p.nextImpl;break;case 11:case 15:break;case 1:if((s&1024)!==0&&g!==null){s=void 0,u=l,p=g.memoizedProps,g=g.memoizedState,f=u.stateNode;try{var Se=fs(u.type,p);s=f.getSnapshotBeforeUpdate(Se,g),f.__reactInternalSnapshotBeforeUpdate=s}catch(we){dt(u,u.return,we)}}break;case 3:if((s&1024)!==0){if(s=l.stateNode.containerInfo,u=s.nodeType,u===9)tp(s);else if(u===1)switch(s.nodeName){case"HEAD":case"HTML":case"BODY":tp(s);break;default:s.textContent=""}}break;case 5:case 26:case 27:case 6:case 4:case 17:break;default:if((s&1024)!==0)throw Error(n(163))}if(s=l.sibling,s!==null){s.return=l.return,on=s;break}on=l.return}}function wE(s,l,u){var f=u.flags;switch(u.tag){case 0:case 11:case 15:Ir(s,u),f&4&&ec(5,u);break;case 1:if(Ir(s,u),f&4)if(s=u.stateNode,l===null)try{s.componentDidMount()}catch(w){dt(u,u.return,w)}else{var p=fs(u.type,l.memoizedProps);l=l.memoizedState;try{s.componentDidUpdate(p,l,s.__reactInternalSnapshotBeforeUpdate)}catch(w){dt(u,u.return,w)}}f&64&&EE(u),f&512&&tc(u,u.return);break;case 3:if(Ir(s,u),f&64&&(s=u.updateQueue,s!==null)){if(l=null,u.child!==null)switch(u.child.tag){case 27:case 5:l=u.child.stateNode;break;case 1:l=u.child.stateNode}try{d0(s,l)}catch(w){dt(u,u.return,w)}}break;case 27:l===null&&f&4&&RE(u);case 26:case 5:Ir(s,u),l===null&&f&4&&_E(u),f&512&&tc(u,u.return);break;case 12:Ir(s,u);break;case 31:Ir(s,u),f&4&&ME(s,u);break;case 13:Ir(s,u),f&4&&PE(s,u),f&64&&(s=u.memoizedState,s!==null&&(s=s.dehydrated,s!==null&&(u=gA.bind(null,u),UA(s,u))));break;case 22:if(f=u.memoizedState!==null||kr,!f){l=l!==null&&l.memoizedState!==null||Jt,p=kr;var g=Jt;kr=f,(Jt=l)&&!g?Or(s,u,(u.subtreeFlags&8772)!==0):Ir(s,u),kr=p,Jt=g}break;case 30:break;default:Ir(s,u)}}function IE(s){var l=s.alternate;l!==null&&(s.alternate=null,IE(l)),s.child=null,s.deletions=null,s.sibling=null,s.tag===5&&(l=s.stateNode,l!==null&&sv(l)),s.stateNode=null,s.return=null,s.dependencies=null,s.memoizedProps=null,s.memoizedState=null,s.pendingProps=null,s.stateNode=null,s.updateQueue=null}var Mt=null,Ln=!1;function wr(s,l,u){for(u=u.child;u!==null;)OE(s,l,u),u=u.sibling}function OE(s,l,u){if(Yn&&typeof Yn.onCommitFiberUnmount=="function")try{Yn.onCommitFiberUnmount(Rl,u)}catch{}switch(u.tag){case 26:Jt||Xi(u,l),wr(s,l,u),u.memoizedState?u.memoizedState.count--:u.stateNode&&(u=u.stateNode,u.parentNode.removeChild(u));break;case 27:Jt||Xi(u,l);var f=Mt,p=Ln;ba(u.type)&&(Mt=u.stateNode,Ln=!1),wr(s,l,u),uc(u.stateNode),Mt=f,Ln=p;break;case 5:Jt||Xi(u,l);case 6:if(f=Mt,p=Ln,Mt=null,wr(s,l,u),Mt=f,Ln=p,Mt!==null)if(Ln)try{(Mt.nodeType===9?Mt.body:Mt.nodeName==="HTML"?Mt.ownerDocument.body:Mt).removeChild(u.stateNode)}catch(g){dt(u,l,g)}else try{Mt.removeChild(u.stateNode)}catch(g){dt(u,l,g)}break;case 18:Mt!==null&&(Ln?(s=Mt,ET(s.nodeType===9?s.body:s.nodeName==="HTML"?s.ownerDocument.body:s,u.stateNode),Po(s)):ET(Mt,u.stateNode));break;case 4:f=Mt,p=Ln,Mt=u.stateNode.containerInfo,Ln=!0,wr(s,l,u),Mt=f,Ln=p;break;case 0:case 11:case 14:case 15:ha(2,u,l),Jt||ha(4,u,l),wr(s,l,u);break;case 1:Jt||(Xi(u,l),f=u.stateNode,typeof f.componentWillUnmount=="function"&&TE(u,l,f)),wr(s,l,u);break;case 21:wr(s,l,u);break;case 22:Jt=(f=Jt)||u.memoizedState!==null,wr(s,l,u),Jt=f;break;default:wr(s,l,u)}}function ME(s,l){if(l.memoizedState===null&&(s=l.alternate,s!==null&&(s=s.memoizedState,s!==null))){s=s.dehydrated;try{Po(s)}catch(u){dt(l,l.return,u)}}}function PE(s,l){if(l.memoizedState===null&&(s=l.alternate,s!==null&&(s=s.memoizedState,s!==null&&(s=s.dehydrated,s!==null))))try{Po(s)}catch(u){dt(l,l.return,u)}}function cA(s){switch(s.tag){case 31:case 13:case 19:var l=s.stateNode;return l===null&&(l=s.stateNode=new kE),l;case 22:return s=s.stateNode,l=s._retryCache,l===null&&(l=s._retryCache=new kE),l;default:throw Error(n(435,s.tag))}}function kd(s,l){var u=cA(s);l.forEach(function(f){if(!u.has(f)){u.add(f);var p=yA.bind(null,s,f);f.then(p,p)}})}function Un(s,l){var u=l.deletions;if(u!==null)for(var f=0;f<u.length;f++){var p=u[f],g=s,w=l,N=w;e:for(;N!==null;){switch(N.tag){case 27:if(ba(N.type)){Mt=N.stateNode,Ln=!1;break e}break;case 5:Mt=N.stateNode,Ln=!1;break e;case 3:case 4:Mt=N.stateNode.containerInfo,Ln=!0;break e}N=N.return}if(Mt===null)throw Error(n(160));OE(g,w,p),Mt=null,Ln=!1,g=p.alternate,g!==null&&(g.return=null),p.return=null}if(l.subtreeFlags&13886)for(l=l.child;l!==null;)AE(l,s),l=l.sibling}var Ai=null;function AE(s,l){var u=s.alternate,f=s.flags;switch(s.tag){case 0:case 11:case 14:case 15:Un(l,s),Bn(s),f&4&&(ha(3,s,s.return),ec(3,s),ha(5,s,s.return));break;case 1:Un(l,s),Bn(s),f&512&&(Jt||u===null||Xi(u,u.return)),f&64&&kr&&(s=s.updateQueue,s!==null&&(f=s.callbacks,f!==null&&(u=s.shared.hiddenCallbacks,s.shared.hiddenCallbacks=u===null?f:u.concat(f))));break;case 26:var p=Ai;if(Un(l,s),Bn(s),f&512&&(Jt||u===null||Xi(u,u.return)),f&4){var g=u!==null?u.memoizedState:null;if(f=s.memoizedState,u===null)if(f===null)if(s.stateNode===null){e:{f=s.type,u=s.memoizedProps,p=p.ownerDocument||p;t:switch(f){case"title":g=p.getElementsByTagName("title")[0],(!g||g[Il]||g[fn]||g.namespaceURI==="http://www.w3.org/2000/svg"||g.hasAttribute("itemprop"))&&(g=p.createElement(f),p.head.insertBefore(g,p.querySelector("head > title"))),gn(g,f,u),g[fn]=s,sn(g),f=g;break e;case"link":var w=AT("link","href",p).get(f+(u.href||""));if(w){for(var N=0;N<w.length;N++)if(g=w[N],g.getAttribute("href")===(u.href==null||u.href===""?null:u.href)&&g.getAttribute("rel")===(u.rel==null?null:u.rel)&&g.getAttribute("title")===(u.title==null?null:u.title)&&g.getAttribute("crossorigin")===(u.crossOrigin==null?null:u.crossOrigin)){w.splice(N,1);break t}}g=p.createElement(f),gn(g,f,u),p.head.appendChild(g);break;case"meta":if(w=AT("meta","content",p).get(f+(u.content||""))){for(N=0;N<w.length;N++)if(g=w[N],g.getAttribute("content")===(u.content==null?null:""+u.content)&&g.getAttribute("name")===(u.name==null?null:u.name)&&g.getAttribute("property")===(u.property==null?null:u.property)&&g.getAttribute("http-equiv")===(u.httpEquiv==null?null:u.httpEquiv)&&g.getAttribute("charset")===(u.charSet==null?null:u.charSet)){w.splice(N,1);break t}}g=p.createElement(f),gn(g,f,u),p.head.appendChild(g);break;default:throw Error(n(468,f))}g[fn]=s,sn(g),f=g}s.stateNode=f}else DT(p,s.type,s.stateNode);else s.stateNode=PT(p,f,s.memoizedProps);else g!==f?(g===null?u.stateNode!==null&&(u=u.stateNode,u.parentNode.removeChild(u)):g.count--,f===null?DT(p,s.type,s.stateNode):PT(p,f,s.memoizedProps)):f===null&&s.stateNode!==null&&wm(s,s.memoizedProps,u.memoizedProps)}break;case 27:Un(l,s),Bn(s),f&512&&(Jt||u===null||Xi(u,u.return)),u!==null&&f&4&&wm(s,s.memoizedProps,u.memoizedProps);break;case 5:if(Un(l,s),Bn(s),f&512&&(Jt||u===null||Xi(u,u.return)),s.flags&32){p=s.stateNode;try{Zs(p,"")}catch(Se){dt(s,s.return,Se)}}f&4&&s.stateNode!=null&&(p=s.memoizedProps,wm(s,p,u!==null?u.memoizedProps:p)),f&1024&&(Mm=!0);break;case 6:if(Un(l,s),Bn(s),f&4){if(s.stateNode===null)throw Error(n(162));f=s.memoizedProps,u=s.stateNode;try{u.nodeValue=f}catch(Se){dt(s,s.return,Se)}}break;case 3:if(Vd=null,p=Ai,Ai=jd(l.containerInfo),Un(l,s),Ai=p,Bn(s),f&4&&u!==null&&u.memoizedState.isDehydrated)try{Po(l.containerInfo)}catch(Se){dt(s,s.return,Se)}Mm&&(Mm=!1,DE(s));break;case 4:f=Ai,Ai=jd(s.stateNode.containerInfo),Un(l,s),Bn(s),Ai=f;break;case 12:Un(l,s),Bn(s);break;case 31:Un(l,s),Bn(s),f&4&&(f=s.updateQueue,f!==null&&(s.updateQueue=null,kd(s,f)));break;case 13:Un(l,s),Bn(s),s.child.flags&8192&&s.memoizedState!==null!=(u!==null&&u.memoizedState!==null)&&(Id=Jn()),f&4&&(f=s.updateQueue,f!==null&&(s.updateQueue=null,kd(s,f)));break;case 22:p=s.memoizedState!==null;var B=u!==null&&u.memoizedState!==null,W=kr,ne=Jt;if(kr=W||p,Jt=ne||B,Un(l,s),Jt=ne,kr=W,Bn(s),f&8192)e:for(l=s.stateNode,l._visibility=p?l._visibility&-2:l._visibility|1,p&&(u===null||B||kr||Jt||vs(s)),u=null,l=s;;){if(l.tag===5||l.tag===26){if(u===null){B=u=l;try{if(g=B.stateNode,p)w=g.style,typeof w.setProperty=="function"?w.setProperty("display","none","important"):w.display="none";else{N=B.stateNode;var re=B.memoizedProps.style,Y=re!=null&&re.hasOwnProperty("display")?re.display:null;N.style.display=Y==null||typeof Y=="boolean"?"":(""+Y).trim()}}catch(Se){dt(B,B.return,Se)}}}else if(l.tag===6){if(u===null){B=l;try{B.stateNode.nodeValue=p?"":B.memoizedProps}catch(Se){dt(B,B.return,Se)}}}else if(l.tag===18){if(u===null){B=l;try{var X=B.stateNode;p?TT(X,!0):TT(B.stateNode,!1)}catch(Se){dt(B,B.return,Se)}}}else if((l.tag!==22&&l.tag!==23||l.memoizedState===null||l===s)&&l.child!==null){l.child.return=l,l=l.child;continue}if(l===s)break e;for(;l.sibling===null;){if(l.return===null||l.return===s)break e;u===l&&(u=null),l=l.return}u===l&&(u=null),l.sibling.return=l.return,l=l.sibling}f&4&&(f=s.updateQueue,f!==null&&(u=f.retryQueue,u!==null&&(f.retryQueue=null,kd(s,u))));break;case 19:Un(l,s),Bn(s),f&4&&(f=s.updateQueue,f!==null&&(s.updateQueue=null,kd(s,f)));break;case 30:break;case 21:break;default:Un(l,s),Bn(s)}}function Bn(s){var l=s.flags;if(l&2){try{for(var u,f=s.return;f!==null;){if(CE(f)){u=f;break}f=f.return}if(u==null)throw Error(n(160));switch(u.tag){case 27:var p=u.stateNode,g=Im(s);Rd(s,g,p);break;case 5:var w=u.stateNode;u.flags&32&&(Zs(w,""),u.flags&=-33);var N=Im(s);Rd(s,N,w);break;case 3:case 4:var B=u.stateNode.containerInfo,W=Im(s);Om(s,W,B);break;default:throw Error(n(161))}}catch(ne){dt(s,s.return,ne)}s.flags&=-3}l&4096&&(s.flags&=-4097)}function DE(s){if(s.subtreeFlags&1024)for(s=s.child;s!==null;){var l=s;DE(l),l.tag===5&&l.flags&1024&&l.stateNode.reset(),s=s.sibling}}function Ir(s,l){if(l.subtreeFlags&8772)for(l=l.child;l!==null;)wE(s,l.alternate,l),l=l.sibling}function vs(s){for(s=s.child;s!==null;){var l=s;switch(l.tag){case 0:case 11:case 14:case 15:ha(4,l,l.return),vs(l);break;case 1:Xi(l,l.return);var u=l.stateNode;typeof u.componentWillUnmount=="function"&&TE(l,l.return,u),vs(l);break;case 27:uc(l.stateNode);case 26:case 5:Xi(l,l.return),vs(l);break;case 22:l.memoizedState===null&&vs(l);break;case 30:vs(l);break;default:vs(l)}s=s.sibling}}function Or(s,l,u){for(u=u&&(l.subtreeFlags&8772)!==0,l=l.child;l!==null;){var f=l.alternate,p=s,g=l,w=g.flags;switch(g.tag){case 0:case 11:case 15:Or(p,g,u),ec(4,g);break;case 1:if(Or(p,g,u),f=g,p=f.stateNode,typeof p.componentDidMount=="function")try{p.componentDidMount()}catch(W){dt(f,f.return,W)}if(f=g,p=f.updateQueue,p!==null){var N=f.stateNode;try{var B=p.shared.hiddenCallbacks;if(B!==null)for(p.shared.hiddenCallbacks=null,p=0;p<B.length;p++)u0(B[p],N)}catch(W){dt(f,f.return,W)}}u&&w&64&&EE(g),tc(g,g.return);break;case 27:RE(g);case 26:case 5:Or(p,g,u),u&&f===null&&w&4&&_E(g),tc(g,g.return);break;case 12:Or(p,g,u);break;case 31:Or(p,g,u),u&&w&4&&ME(p,g);break;case 13:Or(p,g,u),u&&w&4&&PE(p,g);break;case 22:g.memoizedState===null&&Or(p,g,u),tc(g,g.return);break;case 30:break;default:Or(p,g,u)}l=l.sibling}}function Pm(s,l){var u=null;s!==null&&s.memoizedState!==null&&s.memoizedState.cachePool!==null&&(u=s.memoizedState.cachePool.pool),s=null,l.memoizedState!==null&&l.memoizedState.cachePool!==null&&(s=l.memoizedState.cachePool.pool),s!==u&&(s!=null&&s.refCount++,u!=null&&ql(u))}function Am(s,l){s=null,l.alternate!==null&&(s=l.alternate.memoizedState.cache),l=l.memoizedState.cache,l!==s&&(l.refCount++,s!=null&&ql(s))}function Di(s,l,u,f){if(l.subtreeFlags&10256)for(l=l.child;l!==null;)NE(s,l,u,f),l=l.sibling}function NE(s,l,u,f){var p=l.flags;switch(l.tag){case 0:case 11:case 15:Di(s,l,u,f),p&2048&&ec(9,l);break;case 1:Di(s,l,u,f);break;case 3:Di(s,l,u,f),p&2048&&(s=null,l.alternate!==null&&(s=l.alternate.memoizedState.cache),l=l.memoizedState.cache,l!==s&&(l.refCount++,s!=null&&ql(s)));break;case 12:if(p&2048){Di(s,l,u,f),s=l.stateNode;try{var g=l.memoizedProps,w=g.id,N=g.onPostCommit;typeof N=="function"&&N(w,l.alternate===null?"mount":"update",s.passiveEffectDuration,-0)}catch(B){dt(l,l.return,B)}}else Di(s,l,u,f);break;case 31:Di(s,l,u,f);break;case 13:Di(s,l,u,f);break;case 23:break;case 22:g=l.stateNode,w=l.alternate,l.memoizedState!==null?g._visibility&2?Di(s,l,u,f):nc(s,l):g._visibility&2?Di(s,l,u,f):(g._visibility|=2,So(s,l,u,f,(l.subtreeFlags&10256)!==0||!1)),p&2048&&Pm(w,l);break;case 24:Di(s,l,u,f),p&2048&&Am(l.alternate,l);break;default:Di(s,l,u,f)}}function So(s,l,u,f,p){for(p=p&&((l.subtreeFlags&10256)!==0||!1),l=l.child;l!==null;){var g=s,w=l,N=u,B=f,W=w.flags;switch(w.tag){case 0:case 11:case 15:So(g,w,N,B,p),ec(8,w);break;case 23:break;case 22:var ne=w.stateNode;w.memoizedState!==null?ne._visibility&2?So(g,w,N,B,p):nc(g,w):(ne._visibility|=2,So(g,w,N,B,p)),p&&W&2048&&Pm(w.alternate,w);break;case 24:So(g,w,N,B,p),p&&W&2048&&Am(w.alternate,w);break;default:So(g,w,N,B,p)}l=l.sibling}}function nc(s,l){if(l.subtreeFlags&10256)for(l=l.child;l!==null;){var u=s,f=l,p=f.flags;switch(f.tag){case 22:nc(u,f),p&2048&&Pm(f.alternate,f);break;case 24:nc(u,f),p&2048&&Am(f.alternate,f);break;default:nc(u,f)}l=l.sibling}}var ic=8192;function Eo(s,l,u){if(s.subtreeFlags&ic)for(s=s.child;s!==null;)xE(s,l,u),s=s.sibling}function xE(s,l,u){switch(s.tag){case 26:Eo(s,l,u),s.flags&ic&&s.memoizedState!==null&&YA(u,Ai,s.memoizedState,s.memoizedProps);break;case 5:Eo(s,l,u);break;case 3:case 4:var f=Ai;Ai=jd(s.stateNode.containerInfo),Eo(s,l,u),Ai=f;break;case 22:s.memoizedState===null&&(f=s.alternate,f!==null&&f.memoizedState!==null?(f=ic,ic=16777216,Eo(s,l,u),ic=f):Eo(s,l,u));break;default:Eo(s,l,u)}}function LE(s){var l=s.alternate;if(l!==null&&(s=l.child,s!==null)){l.child=null;do l=s.sibling,s.sibling=null,s=l;while(s!==null)}}function rc(s){var l=s.deletions;if((s.flags&16)!==0){if(l!==null)for(var u=0;u<l.length;u++){var f=l[u];on=f,BE(f,s)}LE(s)}if(s.subtreeFlags&10256)for(s=s.child;s!==null;)UE(s),s=s.sibling}function UE(s){switch(s.tag){case 0:case 11:case 15:rc(s),s.flags&2048&&ha(9,s,s.return);break;case 3:rc(s);break;case 12:rc(s);break;case 22:var l=s.stateNode;s.memoizedState!==null&&l._visibility&2&&(s.return===null||s.return.tag!==13)?(l._visibility&=-3,wd(s)):rc(s);break;default:rc(s)}}function wd(s){var l=s.deletions;if((s.flags&16)!==0){if(l!==null)for(var u=0;u<l.length;u++){var f=l[u];on=f,BE(f,s)}LE(s)}for(s=s.child;s!==null;){switch(l=s,l.tag){case 0:case 11:case 15:ha(8,l,l.return),wd(l);break;case 22:u=l.stateNode,u._visibility&2&&(u._visibility&=-3,wd(l));break;default:wd(l)}s=s.sibling}}function BE(s,l){for(;on!==null;){var u=on;switch(u.tag){case 0:case 11:case 15:ha(8,u,l);break;case 23:case 22:if(u.memoizedState!==null&&u.memoizedState.cachePool!==null){var f=u.memoizedState.cachePool.pool;f!=null&&f.refCount++}break;case 24:ql(u.memoizedState.cache)}if(f=u.child,f!==null)f.return=u,on=f;else e:for(u=s;on!==null;){f=on;var p=f.sibling,g=f.return;if(IE(f),f===u){on=null;break e}if(p!==null){p.return=g,on=p;break e}on=g}}}var uA={getCacheForType:function(s){var l=mn(Gt),u=l.data.get(s);return u===void 0&&(u=s(),l.data.set(s,u)),u},cacheSignal:function(){return mn(Gt).controller.signal}},dA=typeof WeakMap=="function"?WeakMap:Map,rt=0,gt=null,Ge=null,$e=0,ut=0,ti=null,fa=!1,To=!1,Dm=!1,Mr=0,xt=0,va=0,ms=0,Nm=0,ni=0,_o=0,ac=null,Fn=null,xm=!1,Id=0,FE=0,Od=1/0,Md=null,ma=null,Qt=0,pa=null,Co=null,Pr=0,Lm=0,Um=null,jE=null,sc=0,Bm=null;function ii(){return(rt&2)!==0&&$e!==0?$e&-$e:V.T!==null?Hm():nS()}function qE(){if(ni===0)if(($e&536870912)===0||Ze){var s=Bu;Bu<<=1,(Bu&3932160)===0&&(Bu=262144),ni=s}else ni=536870912;return s=Zn.current,s!==null&&(s.flags|=32),ni}function jn(s,l,u){(s===gt&&(ut===2||ut===9)||s.cancelPendingCommit!==null)&&(Ro(s,0),ga(s,$e,ni,!1)),wl(s,u),((rt&2)===0||s!==gt)&&(s===gt&&((rt&2)===0&&(ms|=u),xt===4&&ga(s,$e,ni,!1)),Qi(s))}function VE(s,l,u){if((rt&6)!==0)throw Error(n(327));var f=!u&&(l&127)===0&&(l&s.expiredLanes)===0||kl(s,l),p=f?vA(s,l):jm(s,l,!0),g=f;do{if(p===0){To&&!f&&ga(s,l,0,!1);break}else{if(u=s.current.alternate,g&&!hA(u)){p=jm(s,l,!1),g=!1;continue}if(p===2){if(g=l,s.errorRecoveryDisabledLanes&g)var w=0;else w=s.pendingLanes&-536870913,w=w!==0?w:w&536870912?536870912:0;if(w!==0){l=w;e:{var N=s;p=ac;var B=N.current.memoizedState.isDehydrated;if(B&&(Ro(N,w).flags|=256),w=jm(N,w,!1),w!==2){if(Dm&&!B){N.errorRecoveryDisabledLanes|=g,ms|=g,p=4;break e}g=Fn,Fn=p,g!==null&&(Fn===null?Fn=g:Fn.push.apply(Fn,g))}p=w}if(g=!1,p!==2)continue}}if(p===1){Ro(s,0),ga(s,l,0,!0);break}e:{switch(f=s,g=p,g){case 0:case 1:throw Error(n(345));case 4:if((l&4194048)!==l)break;case 6:ga(f,l,ni,!fa);break e;case 2:Fn=null;break;case 3:case 5:break;default:throw Error(n(329))}if((l&62914560)===l&&(p=Id+300-Jn(),10<p)){if(ga(f,l,ni,!fa),ju(f,0,!0)!==0)break e;Pr=l,f.timeoutHandle=bT(KE.bind(null,f,u,Fn,Md,xm,l,ni,ms,_o,fa,g,"Throttled",-0,0),p);break e}KE(f,u,Fn,Md,xm,l,ni,ms,_o,fa,g,null,-0,0)}}break}while(!0);Qi(s)}function KE(s,l,u,f,p,g,w,N,B,W,ne,re,Y,X){if(s.timeoutHandle=-1,re=l.subtreeFlags,re&8192||(re&16785408)===16785408){re={stylesheets:null,count:0,imgCount:0,imgBytes:0,suspenseyImages:[],waitingForImages:!0,waitingForViewTransition:!1,unsuspend:pr},xE(l,g,re);var Se=(g&62914560)===g?Id-Jn():(g&4194048)===g?FE-Jn():0;if(Se=$A(re,Se),Se!==null){Pr=g,s.cancelPendingCommit=Se(XE.bind(null,s,l,g,u,f,p,w,N,B,ne,re,null,Y,X)),ga(s,g,w,!W);return}}XE(s,l,g,u,f,p,w,N,B)}function hA(s){for(var l=s;;){var u=l.tag;if((u===0||u===11||u===15)&&l.flags&16384&&(u=l.updateQueue,u!==null&&(u=u.stores,u!==null)))for(var f=0;f<u.length;f++){var p=u[f],g=p.getSnapshot;p=p.value;try{if(!Xn(g(),p))return!1}catch{return!1}}if(u=l.child,l.subtreeFlags&16384&&u!==null)u.return=l,l=u;else{if(l===s)break;for(;l.sibling===null;){if(l.return===null||l.return===s)return!0;l=l.return}l.sibling.return=l.return,l=l.sibling}}return!0}function ga(s,l,u,f){l&=~Nm,l&=~ms,s.suspendedLanes|=l,s.pingedLanes&=~l,f&&(s.warmLanes|=l),f=s.expirationTimes;for(var p=l;0<p;){var g=31-$n(p),w=1<<g;f[g]=-1,p&=~w}u!==0&&Zb(s,u,l)}function Pd(){return(rt&6)===0?(oc(0),!1):!0}function Fm(){if(Ge!==null){if(ut===0)var s=Ge.return;else s=Ge,Sr=ss=null,tm(s),mo=null,Kl=0,s=Ge;for(;s!==null;)SE(s.alternate,s),s=s.return;Ge=null}}function Ro(s,l){var u=s.timeoutHandle;u!==-1&&(s.timeoutHandle=-1,AA(u)),u=s.cancelPendingCommit,u!==null&&(s.cancelPendingCommit=null,u()),Pr=0,Fm(),gt=s,Ge=u=yr(s.current,null),$e=l,ut=0,ti=null,fa=!1,To=kl(s,l),Dm=!1,_o=ni=Nm=ms=va=xt=0,Fn=ac=null,xm=!1,(l&8)!==0&&(l|=l&32);var f=s.entangledLanes;if(f!==0)for(s=s.entanglements,f&=l;0<f;){var p=31-$n(f),g=1<<p;l|=s[p],f&=~g}return Mr=l,Qu(),u}function HE(s,l){je=null,V.H=Xl,l===vo||l===sd?(l=s0(),ut=3):l===Kv?(l=s0(),ut=4):ut=l===gm?8:l!==null&&typeof l=="object"&&typeof l.then=="function"?6:1,ti=l,Ge===null&&(xt=1,Sd(s,yi(l,s.current)))}function GE(){var s=Zn.current;return s===null?!0:($e&4194048)===$e?Ti===null:($e&62914560)===$e||($e&536870912)!==0?s===Ti:!1}function zE(){var s=V.H;return V.H=Xl,s===null?Xl:s}function WE(){var s=V.A;return V.A=uA,s}function Ad(){xt=4,fa||($e&4194048)!==$e&&Zn.current!==null||(To=!0),(va&134217727)===0&&(ms&134217727)===0||gt===null||ga(gt,$e,ni,!1)}function jm(s,l,u){var f=rt;rt|=2;var p=zE(),g=WE();(gt!==s||$e!==l)&&(Md=null,Ro(s,l)),l=!1;var w=xt;e:do try{if(ut!==0&&Ge!==null){var N=Ge,B=ti;switch(ut){case 8:Fm(),w=6;break e;case 3:case 2:case 9:case 6:Zn.current===null&&(l=!0);var W=ut;if(ut=0,ti=null,ko(s,N,B,W),u&&To){w=0;break e}break;default:W=ut,ut=0,ti=null,ko(s,N,B,W)}}fA(),w=xt;break}catch(ne){HE(s,ne)}while(!0);return l&&s.shellSuspendCounter++,Sr=ss=null,rt=f,V.H=p,V.A=g,Ge===null&&(gt=null,$e=0,Qu()),w}function fA(){for(;Ge!==null;)JE(Ge)}function vA(s,l){var u=rt;rt|=2;var f=zE(),p=WE();gt!==s||$e!==l?(Md=null,Od=Jn()+500,Ro(s,l)):To=kl(s,l);e:do try{if(ut!==0&&Ge!==null){l=Ge;var g=ti;t:switch(ut){case 1:ut=0,ti=null,ko(s,l,g,1);break;case 2:case 9:if(r0(g)){ut=0,ti=null,YE(l);break}l=function(){ut!==2&&ut!==9||gt!==s||(ut=7),Qi(s)},g.then(l,l);break e;case 3:ut=7;break e;case 4:ut=5;break e;case 7:r0(g)?(ut=0,ti=null,YE(l)):(ut=0,ti=null,ko(s,l,g,7));break;case 5:var w=null;switch(Ge.tag){case 26:w=Ge.memoizedState;case 5:case 27:var N=Ge;if(w?NT(w):N.stateNode.complete){ut=0,ti=null;var B=N.sibling;if(B!==null)Ge=B;else{var W=N.return;W!==null?(Ge=W,Dd(W)):Ge=null}break t}}ut=0,ti=null,ko(s,l,g,5);break;case 6:ut=0,ti=null,ko(s,l,g,6);break;case 8:Fm(),xt=6;break e;default:throw Error(n(462))}}mA();break}catch(ne){HE(s,ne)}while(!0);return Sr=ss=null,V.H=f,V.A=p,rt=u,Ge!==null?0:(gt=null,$e=0,Qu(),xt)}function mA(){for(;Ge!==null&&!BM();)JE(Ge)}function JE(s){var l=yE(s.alternate,s,Mr);s.memoizedProps=s.pendingProps,l===null?Dd(s):Ge=l}function YE(s){var l=s,u=l.alternate;switch(l.tag){case 15:case 0:l=hE(u,l,l.pendingProps,l.type,void 0,$e);break;case 11:l=hE(u,l,l.pendingProps,l.type.render,l.ref,$e);break;case 5:tm(l);default:SE(u,l),l=Ge=WS(l,Mr),l=yE(u,l,Mr)}s.memoizedProps=s.pendingProps,l===null?Dd(s):Ge=l}function ko(s,l,u,f){Sr=ss=null,tm(l),mo=null,Kl=0;var p=l.return;try{if(iA(s,p,l,u,$e)){xt=1,Sd(s,yi(u,s.current)),Ge=null;return}}catch(g){if(p!==null)throw Ge=p,g;xt=1,Sd(s,yi(u,s.current)),Ge=null;return}l.flags&32768?(Ze||f===1?s=!0:To||($e&536870912)!==0?s=!1:(fa=s=!0,(f===2||f===9||f===3||f===6)&&(f=Zn.current,f!==null&&f.tag===13&&(f.flags|=16384))),$E(l,s)):Dd(l)}function Dd(s){var l=s;do{if((l.flags&32768)!==0){$E(l,fa);return}s=l.return;var u=sA(l.alternate,l,Mr);if(u!==null){Ge=u;return}if(l=l.sibling,l!==null){Ge=l;return}Ge=l=s}while(l!==null);xt===0&&(xt=5)}function $E(s,l){do{var u=oA(s.alternate,s);if(u!==null){u.flags&=32767,Ge=u;return}if(u=s.return,u!==null&&(u.flags|=32768,u.subtreeFlags=0,u.deletions=null),!l&&(s=s.sibling,s!==null)){Ge=s;return}Ge=s=u}while(s!==null);xt=6,Ge=null}function XE(s,l,u,f,p,g,w,N,B){s.cancelPendingCommit=null;do Nd();while(Qt!==0);if((rt&6)!==0)throw Error(n(327));if(l!==null){if(l===s.current)throw Error(n(177));if(g=l.lanes|l.childLanes,g|=Iv,JM(s,u,g,w,N,B),s===gt&&(Ge=gt=null,$e=0),Co=l,pa=s,Pr=u,Lm=g,Um=p,jE=f,(l.subtreeFlags&10256)!==0||(l.flags&10256)!==0?(s.callbackNode=null,s.callbackPriority=0,bA(Lu,function(){return nT(),null})):(s.callbackNode=null,s.callbackPriority=0),f=(l.flags&13878)!==0,(l.subtreeFlags&13878)!==0||f){f=V.T,V.T=null,p=Q.p,Q.p=2,w=rt,rt|=4;try{lA(s,l,u)}finally{rt=w,Q.p=p,V.T=f}}Qt=1,QE(),ZE(),eT()}}function QE(){if(Qt===1){Qt=0;var s=pa,l=Co,u=(l.flags&13878)!==0;if((l.subtreeFlags&13878)!==0||u){u=V.T,V.T=null;var f=Q.p;Q.p=2;var p=rt;rt|=4;try{AE(l,s);var g=Qm,w=BS(s.containerInfo),N=g.focusedElem,B=g.selectionRange;if(w!==N&&N&&N.ownerDocument&&US(N.ownerDocument.documentElement,N)){if(B!==null&&_v(N)){var W=B.start,ne=B.end;if(ne===void 0&&(ne=W),"selectionStart"in N)N.selectionStart=W,N.selectionEnd=Math.min(ne,N.value.length);else{var re=N.ownerDocument||document,Y=re&&re.defaultView||window;if(Y.getSelection){var X=Y.getSelection(),Se=N.textContent.length,we=Math.min(B.start,Se),vt=B.end===void 0?we:Math.min(B.end,Se);!X.extend&&we>vt&&(w=vt,vt=we,we=w);var H=LS(N,we),q=LS(N,vt);if(H&&q&&(X.rangeCount!==1||X.anchorNode!==H.node||X.anchorOffset!==H.offset||X.focusNode!==q.node||X.focusOffset!==q.offset)){var z=re.createRange();z.setStart(H.node,H.offset),X.removeAllRanges(),we>vt?(X.addRange(z),X.extend(q.node,q.offset)):(z.setEnd(q.node,q.offset),X.addRange(z))}}}}for(re=[],X=N;X=X.parentNode;)X.nodeType===1&&re.push({element:X,left:X.scrollLeft,top:X.scrollTop});for(typeof N.focus=="function"&&N.focus(),N=0;N<re.length;N++){var ie=re[N];ie.element.scrollLeft=ie.left,ie.element.scrollTop=ie.top}}zd=!!Xm,Qm=Xm=null}finally{rt=p,Q.p=f,V.T=u}}s.current=l,Qt=2}}function ZE(){if(Qt===2){Qt=0;var s=pa,l=Co,u=(l.flags&8772)!==0;if((l.subtreeFlags&8772)!==0||u){u=V.T,V.T=null;var f=Q.p;Q.p=2;var p=rt;rt|=4;try{wE(s,l.alternate,l)}finally{rt=p,Q.p=f,V.T=u}}Qt=3}}function eT(){if(Qt===4||Qt===3){Qt=0,FM();var s=pa,l=Co,u=Pr,f=jE;(l.subtreeFlags&10256)!==0||(l.flags&10256)!==0?Qt=5:(Qt=0,Co=pa=null,tT(s,s.pendingLanes));var p=s.pendingLanes;if(p===0&&(ma=null),rv(u),l=l.stateNode,Yn&&typeof Yn.onCommitFiberRoot=="function")try{Yn.onCommitFiberRoot(Rl,l,void 0,(l.current.flags&128)===128)}catch{}if(f!==null){l=V.T,p=Q.p,Q.p=2,V.T=null;try{for(var g=s.onRecoverableError,w=0;w<f.length;w++){var N=f[w];g(N.value,{componentStack:N.stack})}}finally{V.T=l,Q.p=p}}(Pr&3)!==0&&Nd(),Qi(s),p=s.pendingLanes,(u&261930)!==0&&(p&42)!==0?s===Bm?sc++:(sc=0,Bm=s):sc=0,oc(0)}}function tT(s,l){(s.pooledCacheLanes&=l)===0&&(l=s.pooledCache,l!=null&&(s.pooledCache=null,ql(l)))}function Nd(){return QE(),ZE(),eT(),nT()}function nT(){if(Qt!==5)return!1;var s=pa,l=Lm;Lm=0;var u=rv(Pr),f=V.T,p=Q.p;try{Q.p=32>u?32:u,V.T=null,u=Um,Um=null;var g=pa,w=Pr;if(Qt=0,Co=pa=null,Pr=0,(rt&6)!==0)throw Error(n(331));var N=rt;if(rt|=4,UE(g.current),NE(g,g.current,w,u),rt=N,oc(0,!1),Yn&&typeof Yn.onPostCommitFiberRoot=="function")try{Yn.onPostCommitFiberRoot(Rl,g)}catch{}return!0}finally{Q.p=p,V.T=f,tT(s,l)}}function iT(s,l,u){l=yi(u,l),l=pm(s.stateNode,l,2),s=ca(s,l,2),s!==null&&(wl(s,2),Qi(s))}function dt(s,l,u){if(s.tag===3)iT(s,s,u);else for(;l!==null;){if(l.tag===3){iT(l,s,u);break}else if(l.tag===1){var f=l.stateNode;if(typeof l.type.getDerivedStateFromError=="function"||typeof f.componentDidCatch=="function"&&(ma===null||!ma.has(f))){s=yi(u,s),u=rE(2),f=ca(l,u,2),f!==null&&(aE(u,f,l,s),wl(f,2),Qi(f));break}}l=l.return}}function qm(s,l,u){var f=s.pingCache;if(f===null){f=s.pingCache=new dA;var p=new Set;f.set(l,p)}else p=f.get(l),p===void 0&&(p=new Set,f.set(l,p));p.has(u)||(Dm=!0,p.add(u),s=pA.bind(null,s,l,u),l.then(s,s))}function pA(s,l,u){var f=s.pingCache;f!==null&&f.delete(l),s.pingedLanes|=s.suspendedLanes&u,s.warmLanes&=~u,gt===s&&($e&u)===u&&(xt===4||xt===3&&($e&62914560)===$e&&300>Jn()-Id?(rt&2)===0&&Ro(s,0):Nm|=u,_o===$e&&(_o=0)),Qi(s)}function rT(s,l){l===0&&(l=Qb()),s=is(s,l),s!==null&&(wl(s,l),Qi(s))}function gA(s){var l=s.memoizedState,u=0;l!==null&&(u=l.retryLane),rT(s,u)}function yA(s,l){var u=0;switch(s.tag){case 31:case 13:var f=s.stateNode,p=s.memoizedState;p!==null&&(u=p.retryLane);break;case 19:f=s.stateNode;break;case 22:f=s.stateNode._retryCache;break;default:throw Error(n(314))}f!==null&&f.delete(l),rT(s,u)}function bA(s,l){return ev(s,l)}var xd=null,wo=null,Vm=!1,Ld=!1,Km=!1,ya=0;function Qi(s){s!==wo&&s.next===null&&(wo===null?xd=wo=s:wo=wo.next=s),Ld=!0,Vm||(Vm=!0,EA())}function oc(s,l){if(!Km&&Ld){Km=!0;do for(var u=!1,f=xd;f!==null;){if(s!==0){var p=f.pendingLanes;if(p===0)var g=0;else{var w=f.suspendedLanes,N=f.pingedLanes;g=(1<<31-$n(42|s)+1)-1,g&=p&~(w&~N),g=g&201326741?g&201326741|1:g?g|2:0}g!==0&&(u=!0,lT(f,g))}else g=$e,g=ju(f,f===gt?g:0,f.cancelPendingCommit!==null||f.timeoutHandle!==-1),(g&3)===0||kl(f,g)||(u=!0,lT(f,g));f=f.next}while(u);Km=!1}}function SA(){aT()}function aT(){Ld=Vm=!1;var s=0;ya!==0&&PA()&&(s=ya);for(var l=Jn(),u=null,f=xd;f!==null;){var p=f.next,g=sT(f,l);g===0?(f.next=null,u===null?xd=p:u.next=p,p===null&&(wo=u)):(u=f,(s!==0||(g&3)!==0)&&(Ld=!0)),f=p}Qt!==0&&Qt!==5||oc(s),ya!==0&&(ya=0)}function sT(s,l){for(var u=s.suspendedLanes,f=s.pingedLanes,p=s.expirationTimes,g=s.pendingLanes&-62914561;0<g;){var w=31-$n(g),N=1<<w,B=p[w];B===-1?((N&u)===0||(N&f)!==0)&&(p[w]=WM(N,l)):B<=l&&(s.expiredLanes|=N),g&=~N}if(l=gt,u=$e,u=ju(s,s===l?u:0,s.cancelPendingCommit!==null||s.timeoutHandle!==-1),f=s.callbackNode,u===0||s===l&&(ut===2||ut===9)||s.cancelPendingCommit!==null)return f!==null&&f!==null&&tv(f),s.callbackNode=null,s.callbackPriority=0;if((u&3)===0||kl(s,u)){if(l=u&-u,l===s.callbackPriority)return l;switch(f!==null&&tv(f),rv(u)){case 2:case 8:u=$b;break;case 32:u=Lu;break;case 268435456:u=Xb;break;default:u=Lu}return f=oT.bind(null,s),u=ev(u,f),s.callbackPriority=l,s.callbackNode=u,l}return f!==null&&f!==null&&tv(f),s.callbackPriority=2,s.callbackNode=null,2}function oT(s,l){if(Qt!==0&&Qt!==5)return s.callbackNode=null,s.callbackPriority=0,null;var u=s.callbackNode;if(Nd()&&s.callbackNode!==u)return null;var f=$e;return f=ju(s,s===gt?f:0,s.cancelPendingCommit!==null||s.timeoutHandle!==-1),f===0?null:(VE(s,f,l),sT(s,Jn()),s.callbackNode!=null&&s.callbackNode===u?oT.bind(null,s):null)}function lT(s,l){if(Nd())return null;VE(s,l,!0)}function EA(){DA(function(){(rt&6)!==0?ev(Yb,SA):aT()})}function Hm(){if(ya===0){var s=ho;s===0&&(s=Uu,Uu<<=1,(Uu&261888)===0&&(Uu=256)),ya=s}return ya}function cT(s){return s==null||typeof s=="symbol"||typeof s=="boolean"?null:typeof s=="function"?s:Hu(""+s)}function uT(s,l){var u=l.ownerDocument.createElement("input");return u.name=l.name,u.value=l.value,s.id&&u.setAttribute("form",s.id),l.parentNode.insertBefore(u,l),s=new FormData(s),u.parentNode.removeChild(u),s}function TA(s,l,u,f,p){if(l==="submit"&&u&&u.stateNode===p){var g=cT((p[Nn]||null).action),w=f.submitter;w&&(l=(l=w[Nn]||null)?cT(l.formAction):w.getAttribute("formAction"),l!==null&&(g=l,w=null));var N=new Ju("action","action",null,f,p);s.push({event:N,listeners:[{instance:null,listener:function(){if(f.defaultPrevented){if(ya!==0){var B=w?uT(p,w):new FormData(p);um(u,{pending:!0,data:B,method:p.method,action:g},null,B)}}else typeof g=="function"&&(N.preventDefault(),B=w?uT(p,w):new FormData(p),um(u,{pending:!0,data:B,method:p.method,action:g},g,B))},currentTarget:p}]})}}for(var Gm=0;Gm<wv.length;Gm++){var zm=wv[Gm],_A=zm.toLowerCase(),CA=zm[0].toUpperCase()+zm.slice(1);Pi(_A,"on"+CA)}Pi(qS,"onAnimationEnd"),Pi(VS,"onAnimationIteration"),Pi(KS,"onAnimationStart"),Pi("dblclick","onDoubleClick"),Pi("focusin","onFocus"),Pi("focusout","onBlur"),Pi(jP,"onTransitionRun"),Pi(qP,"onTransitionStart"),Pi(VP,"onTransitionCancel"),Pi(HS,"onTransitionEnd"),Xs("onMouseEnter",["mouseout","mouseover"]),Xs("onMouseLeave",["mouseout","mouseover"]),Xs("onPointerEnter",["pointerout","pointerover"]),Xs("onPointerLeave",["pointerout","pointerover"]),Za("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),Za("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),Za("onBeforeInput",["compositionend","keypress","textInput","paste"]),Za("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),Za("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),Za("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var lc="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),RA=new Set("beforetoggle cancel close invalid load scroll scrollend toggle".split(" ").concat(lc));function dT(s,l){l=(l&4)!==0;for(var u=0;u<s.length;u++){var f=s[u],p=f.event;f=f.listeners;e:{var g=void 0;if(l)for(var w=f.length-1;0<=w;w--){var N=f[w],B=N.instance,W=N.currentTarget;if(N=N.listener,B!==g&&p.isPropagationStopped())break e;g=N,p.currentTarget=W;try{g(p)}catch(ne){Xu(ne)}p.currentTarget=null,g=B}else for(w=0;w<f.length;w++){if(N=f[w],B=N.instance,W=N.currentTarget,N=N.listener,B!==g&&p.isPropagationStopped())break e;g=N,p.currentTarget=W;try{g(p)}catch(ne){Xu(ne)}p.currentTarget=null,g=B}}}}function ze(s,l){var u=l[av];u===void 0&&(u=l[av]=new Set);var f=s+"__bubble";u.has(f)||(hT(l,s,2,!1),u.add(f))}function Wm(s,l,u){var f=0;l&&(f|=4),hT(u,s,f,l)}var Ud="_reactListening"+Math.random().toString(36).slice(2);function Jm(s){if(!s[Ud]){s[Ud]=!0,aS.forEach(function(u){u!=="selectionchange"&&(RA.has(u)||Wm(u,!1,s),Wm(u,!0,s))});var l=s.nodeType===9?s:s.ownerDocument;l===null||l[Ud]||(l[Ud]=!0,Wm("selectionchange",!1,l))}}function hT(s,l,u,f){switch(qT(l)){case 2:var p=ZA;break;case 8:p=eD;break;default:p=cp}u=p.bind(null,l,u,s),p=void 0,!vv||l!=="touchstart"&&l!=="touchmove"&&l!=="wheel"||(p=!0),f?p!==void 0?s.addEventListener(l,u,{capture:!0,passive:p}):s.addEventListener(l,u,!0):p!==void 0?s.addEventListener(l,u,{passive:p}):s.addEventListener(l,u,!1)}function Ym(s,l,u,f,p){var g=f;if((l&1)===0&&(l&2)===0&&f!==null)e:for(;;){if(f===null)return;var w=f.tag;if(w===3||w===4){var N=f.stateNode.containerInfo;if(N===p)break;if(w===4)for(w=f.return;w!==null;){var B=w.tag;if((B===3||B===4)&&w.stateNode.containerInfo===p)return;w=w.return}for(;N!==null;){if(w=Js(N),w===null)return;if(B=w.tag,B===5||B===6||B===26||B===27){f=g=w;continue e}N=N.parentNode}}f=f.return}gS(function(){var W=g,ne=hv(u),re=[];e:{var Y=GS.get(s);if(Y!==void 0){var X=Ju,Se=s;switch(s){case"keypress":if(zu(u)===0)break e;case"keydown":case"keyup":X=yP;break;case"focusin":Se="focus",X=yv;break;case"focusout":Se="blur",X=yv;break;case"beforeblur":case"afterblur":X=yv;break;case"click":if(u.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":X=SS;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":X=sP;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":X=EP;break;case qS:case VS:case KS:X=cP;break;case HS:X=_P;break;case"scroll":case"scrollend":X=rP;break;case"wheel":X=RP;break;case"copy":case"cut":case"paste":X=dP;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":X=TS;break;case"toggle":case"beforetoggle":X=wP}var we=(l&4)!==0,vt=!we&&(s==="scroll"||s==="scrollend"),H=we?Y!==null?Y+"Capture":null:Y;we=[];for(var q=W,z;q!==null;){var ie=q;if(z=ie.stateNode,ie=ie.tag,ie!==5&&ie!==26&&ie!==27||z===null||H===null||(ie=Ml(q,H),ie!=null&&we.push(cc(q,ie,z))),vt)break;q=q.return}0<we.length&&(Y=new X(Y,Se,null,u,ne),re.push({event:Y,listeners:we}))}}if((l&7)===0){e:{if(Y=s==="mouseover"||s==="pointerover",X=s==="mouseout"||s==="pointerout",Y&&u!==dv&&(Se=u.relatedTarget||u.fromElement)&&(Js(Se)||Se[Ws]))break e;if((X||Y)&&(Y=ne.window===ne?ne:(Y=ne.ownerDocument)?Y.defaultView||Y.parentWindow:window,X?(Se=u.relatedTarget||u.toElement,X=W,Se=Se?Js(Se):null,Se!==null&&(vt=a(Se),we=Se.tag,Se!==vt||we!==5&&we!==27&&we!==6)&&(Se=null)):(X=null,Se=W),X!==Se)){if(we=SS,ie="onMouseLeave",H="onMouseEnter",q="mouse",(s==="pointerout"||s==="pointerover")&&(we=TS,ie="onPointerLeave",H="onPointerEnter",q="pointer"),vt=X==null?Y:Ol(X),z=Se==null?Y:Ol(Se),Y=new we(ie,q+"leave",X,u,ne),Y.target=vt,Y.relatedTarget=z,ie=null,Js(ne)===W&&(we=new we(H,q+"enter",Se,u,ne),we.target=z,we.relatedTarget=vt,ie=we),vt=ie,X&&Se)t:{for(we=kA,H=X,q=Se,z=0,ie=H;ie;ie=we(ie))z++;ie=0;for(var Ce=q;Ce;Ce=we(Ce))ie++;for(;0<z-ie;)H=we(H),z--;for(;0<ie-z;)q=we(q),ie--;for(;z--;){if(H===q||q!==null&&H===q.alternate){we=H;break t}H=we(H),q=we(q)}we=null}else we=null;X!==null&&fT(re,Y,X,we,!1),Se!==null&&vt!==null&&fT(re,vt,Se,we,!0)}}e:{if(Y=W?Ol(W):window,X=Y.nodeName&&Y.nodeName.toLowerCase(),X==="select"||X==="input"&&Y.type==="file")var tt=MS;else if(IS(Y))if(PS)tt=UP;else{tt=xP;var Ee=NP}else X=Y.nodeName,!X||X.toLowerCase()!=="input"||Y.type!=="checkbox"&&Y.type!=="radio"?W&&uv(W.elementType)&&(tt=MS):tt=LP;if(tt&&(tt=tt(s,W))){OS(re,tt,u,ne);break e}Ee&&Ee(s,Y,W),s==="focusout"&&W&&Y.type==="number"&&W.memoizedProps.value!=null&&cv(Y,"number",Y.value)}switch(Ee=W?Ol(W):window,s){case"focusin":(IS(Ee)||Ee.contentEditable==="true")&&(io=Ee,Cv=W,Bl=null);break;case"focusout":Bl=Cv=io=null;break;case"mousedown":Rv=!0;break;case"contextmenu":case"mouseup":case"dragend":Rv=!1,FS(re,u,ne);break;case"selectionchange":if(FP)break;case"keydown":case"keyup":FS(re,u,ne)}var Ve;if(Sv)e:{switch(s){case"compositionstart":var Xe="onCompositionStart";break e;case"compositionend":Xe="onCompositionEnd";break e;case"compositionupdate":Xe="onCompositionUpdate";break e}Xe=void 0}else no?kS(s,u)&&(Xe="onCompositionEnd"):s==="keydown"&&u.keyCode===229&&(Xe="onCompositionStart");Xe&&(_S&&u.locale!=="ko"&&(no||Xe!=="onCompositionStart"?Xe==="onCompositionEnd"&&no&&(Ve=yS()):(na=ne,mv="value"in na?na.value:na.textContent,no=!0)),Ee=Bd(W,Xe),0<Ee.length&&(Xe=new ES(Xe,s,null,u,ne),re.push({event:Xe,listeners:Ee}),Ve?Xe.data=Ve:(Ve=wS(u),Ve!==null&&(Xe.data=Ve)))),(Ve=OP?MP(s,u):PP(s,u))&&(Xe=Bd(W,"onBeforeInput"),0<Xe.length&&(Ee=new ES("onBeforeInput","beforeinput",null,u,ne),re.push({event:Ee,listeners:Xe}),Ee.data=Ve)),TA(re,s,W,u,ne)}dT(re,l)})}function cc(s,l,u){return{instance:s,listener:l,currentTarget:u}}function Bd(s,l){for(var u=l+"Capture",f=[];s!==null;){var p=s,g=p.stateNode;if(p=p.tag,p!==5&&p!==26&&p!==27||g===null||(p=Ml(s,u),p!=null&&f.unshift(cc(s,p,g)),p=Ml(s,l),p!=null&&f.push(cc(s,p,g))),s.tag===3)return f;s=s.return}return[]}function kA(s){if(s===null)return null;do s=s.return;while(s&&s.tag!==5&&s.tag!==27);return s||null}function fT(s,l,u,f,p){for(var g=l._reactName,w=[];u!==null&&u!==f;){var N=u,B=N.alternate,W=N.stateNode;if(N=N.tag,B!==null&&B===f)break;N!==5&&N!==26&&N!==27||W===null||(B=W,p?(W=Ml(u,g),W!=null&&w.unshift(cc(u,W,B))):p||(W=Ml(u,g),W!=null&&w.push(cc(u,W,B)))),u=u.return}w.length!==0&&s.push({event:l,listeners:w})}var wA=/\r\n?/g,IA=/\u0000|\uFFFD/g;function vT(s){return(typeof s=="string"?s:""+s).replace(wA,`
`).replace(IA,"")}function mT(s,l){return l=vT(l),vT(s)===l}function ft(s,l,u,f,p,g){switch(u){case"children":typeof f=="string"?l==="body"||l==="textarea"&&f===""||Zs(s,f):(typeof f=="number"||typeof f=="bigint")&&l!=="body"&&Zs(s,""+f);break;case"className":Vu(s,"class",f);break;case"tabIndex":Vu(s,"tabindex",f);break;case"dir":case"role":case"viewBox":case"width":case"height":Vu(s,u,f);break;case"style":mS(s,f,g);break;case"data":if(l!=="object"){Vu(s,"data",f);break}case"src":case"href":if(f===""&&(l!=="a"||u!=="href")){s.removeAttribute(u);break}if(f==null||typeof f=="function"||typeof f=="symbol"||typeof f=="boolean"){s.removeAttribute(u);break}f=Hu(""+f),s.setAttribute(u,f);break;case"action":case"formAction":if(typeof f=="function"){s.setAttribute(u,"javascript:throw new Error('A React form was unexpectedly submitted. If you called form.submit() manually, consider using form.requestSubmit() instead. If you\\'re trying to use event.stopPropagation() in a submit event handler, consider also calling event.preventDefault().')");break}else typeof g=="function"&&(u==="formAction"?(l!=="input"&&ft(s,l,"name",p.name,p,null),ft(s,l,"formEncType",p.formEncType,p,null),ft(s,l,"formMethod",p.formMethod,p,null),ft(s,l,"formTarget",p.formTarget,p,null)):(ft(s,l,"encType",p.encType,p,null),ft(s,l,"method",p.method,p,null),ft(s,l,"target",p.target,p,null)));if(f==null||typeof f=="symbol"||typeof f=="boolean"){s.removeAttribute(u);break}f=Hu(""+f),s.setAttribute(u,f);break;case"onClick":f!=null&&(s.onclick=pr);break;case"onScroll":f!=null&&ze("scroll",s);break;case"onScrollEnd":f!=null&&ze("scrollend",s);break;case"dangerouslySetInnerHTML":if(f!=null){if(typeof f!="object"||!("__html"in f))throw Error(n(61));if(u=f.__html,u!=null){if(p.children!=null)throw Error(n(60));s.innerHTML=u}}break;case"multiple":s.multiple=f&&typeof f!="function"&&typeof f!="symbol";break;case"muted":s.muted=f&&typeof f!="function"&&typeof f!="symbol";break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"defaultValue":case"defaultChecked":case"innerHTML":case"ref":break;case"autoFocus":break;case"xlinkHref":if(f==null||typeof f=="function"||typeof f=="boolean"||typeof f=="symbol"){s.removeAttribute("xlink:href");break}u=Hu(""+f),s.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",u);break;case"contentEditable":case"spellCheck":case"draggable":case"value":case"autoReverse":case"externalResourcesRequired":case"focusable":case"preserveAlpha":f!=null&&typeof f!="function"&&typeof f!="symbol"?s.setAttribute(u,""+f):s.removeAttribute(u);break;case"inert":case"allowFullScreen":case"async":case"autoPlay":case"controls":case"default":case"defer":case"disabled":case"disablePictureInPicture":case"disableRemotePlayback":case"formNoValidate":case"hidden":case"loop":case"noModule":case"noValidate":case"open":case"playsInline":case"readOnly":case"required":case"reversed":case"scoped":case"seamless":case"itemScope":f&&typeof f!="function"&&typeof f!="symbol"?s.setAttribute(u,""):s.removeAttribute(u);break;case"capture":case"download":f===!0?s.setAttribute(u,""):f!==!1&&f!=null&&typeof f!="function"&&typeof f!="symbol"?s.setAttribute(u,f):s.removeAttribute(u);break;case"cols":case"rows":case"size":case"span":f!=null&&typeof f!="function"&&typeof f!="symbol"&&!isNaN(f)&&1<=f?s.setAttribute(u,f):s.removeAttribute(u);break;case"rowSpan":case"start":f==null||typeof f=="function"||typeof f=="symbol"||isNaN(f)?s.removeAttribute(u):s.setAttribute(u,f);break;case"popover":ze("beforetoggle",s),ze("toggle",s),qu(s,"popover",f);break;case"xlinkActuate":mr(s,"http://www.w3.org/1999/xlink","xlink:actuate",f);break;case"xlinkArcrole":mr(s,"http://www.w3.org/1999/xlink","xlink:arcrole",f);break;case"xlinkRole":mr(s,"http://www.w3.org/1999/xlink","xlink:role",f);break;case"xlinkShow":mr(s,"http://www.w3.org/1999/xlink","xlink:show",f);break;case"xlinkTitle":mr(s,"http://www.w3.org/1999/xlink","xlink:title",f);break;case"xlinkType":mr(s,"http://www.w3.org/1999/xlink","xlink:type",f);break;case"xmlBase":mr(s,"http://www.w3.org/XML/1998/namespace","xml:base",f);break;case"xmlLang":mr(s,"http://www.w3.org/XML/1998/namespace","xml:lang",f);break;case"xmlSpace":mr(s,"http://www.w3.org/XML/1998/namespace","xml:space",f);break;case"is":qu(s,"is",f);break;case"innerText":case"textContent":break;default:(!(2<u.length)||u[0]!=="o"&&u[0]!=="O"||u[1]!=="n"&&u[1]!=="N")&&(u=nP.get(u)||u,qu(s,u,f))}}function $m(s,l,u,f,p,g){switch(u){case"style":mS(s,f,g);break;case"dangerouslySetInnerHTML":if(f!=null){if(typeof f!="object"||!("__html"in f))throw Error(n(61));if(u=f.__html,u!=null){if(p.children!=null)throw Error(n(60));s.innerHTML=u}}break;case"children":typeof f=="string"?Zs(s,f):(typeof f=="number"||typeof f=="bigint")&&Zs(s,""+f);break;case"onScroll":f!=null&&ze("scroll",s);break;case"onScrollEnd":f!=null&&ze("scrollend",s);break;case"onClick":f!=null&&(s.onclick=pr);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"innerHTML":case"ref":break;case"innerText":case"textContent":break;default:if(!sS.hasOwnProperty(u))e:{if(u[0]==="o"&&u[1]==="n"&&(p=u.endsWith("Capture"),l=u.slice(2,p?u.length-7:void 0),g=s[Nn]||null,g=g!=null?g[u]:null,typeof g=="function"&&s.removeEventListener(l,g,p),typeof f=="function")){typeof g!="function"&&g!==null&&(u in s?s[u]=null:s.hasAttribute(u)&&s.removeAttribute(u)),s.addEventListener(l,f,p);break e}u in s?s[u]=f:f===!0?s.setAttribute(u,""):qu(s,u,f)}}}function gn(s,l,u){switch(l){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"img":ze("error",s),ze("load",s);var f=!1,p=!1,g;for(g in u)if(u.hasOwnProperty(g)){var w=u[g];if(w!=null)switch(g){case"src":f=!0;break;case"srcSet":p=!0;break;case"children":case"dangerouslySetInnerHTML":throw Error(n(137,l));default:ft(s,l,g,w,u,null)}}p&&ft(s,l,"srcSet",u.srcSet,u,null),f&&ft(s,l,"src",u.src,u,null);return;case"input":ze("invalid",s);var N=g=w=p=null,B=null,W=null;for(f in u)if(u.hasOwnProperty(f)){var ne=u[f];if(ne!=null)switch(f){case"name":p=ne;break;case"type":w=ne;break;case"checked":B=ne;break;case"defaultChecked":W=ne;break;case"value":g=ne;break;case"defaultValue":N=ne;break;case"children":case"dangerouslySetInnerHTML":if(ne!=null)throw Error(n(137,l));break;default:ft(s,l,f,ne,u,null)}}dS(s,g,N,B,W,w,p,!1);return;case"select":ze("invalid",s),f=w=g=null;for(p in u)if(u.hasOwnProperty(p)&&(N=u[p],N!=null))switch(p){case"value":g=N;break;case"defaultValue":w=N;break;case"multiple":f=N;default:ft(s,l,p,N,u,null)}l=g,u=w,s.multiple=!!f,l!=null?Qs(s,!!f,l,!1):u!=null&&Qs(s,!!f,u,!0);return;case"textarea":ze("invalid",s),g=p=f=null;for(w in u)if(u.hasOwnProperty(w)&&(N=u[w],N!=null))switch(w){case"value":f=N;break;case"defaultValue":p=N;break;case"children":g=N;break;case"dangerouslySetInnerHTML":if(N!=null)throw Error(n(91));break;default:ft(s,l,w,N,u,null)}fS(s,f,p,g);return;case"option":for(B in u)u.hasOwnProperty(B)&&(f=u[B],f!=null)&&(B==="selected"?s.selected=f&&typeof f!="function"&&typeof f!="symbol":ft(s,l,B,f,u,null));return;case"dialog":ze("beforetoggle",s),ze("toggle",s),ze("cancel",s),ze("close",s);break;case"iframe":case"object":ze("load",s);break;case"video":case"audio":for(f=0;f<lc.length;f++)ze(lc[f],s);break;case"image":ze("error",s),ze("load",s);break;case"details":ze("toggle",s);break;case"embed":case"source":case"link":ze("error",s),ze("load",s);case"area":case"base":case"br":case"col":case"hr":case"keygen":case"meta":case"param":case"track":case"wbr":case"menuitem":for(W in u)if(u.hasOwnProperty(W)&&(f=u[W],f!=null))switch(W){case"children":case"dangerouslySetInnerHTML":throw Error(n(137,l));default:ft(s,l,W,f,u,null)}return;default:if(uv(l)){for(ne in u)u.hasOwnProperty(ne)&&(f=u[ne],f!==void 0&&$m(s,l,ne,f,u,void 0));return}}for(N in u)u.hasOwnProperty(N)&&(f=u[N],f!=null&&ft(s,l,N,f,u,null))}function OA(s,l,u,f){switch(l){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"input":var p=null,g=null,w=null,N=null,B=null,W=null,ne=null;for(X in u){var re=u[X];if(u.hasOwnProperty(X)&&re!=null)switch(X){case"checked":break;case"value":break;case"defaultValue":B=re;default:f.hasOwnProperty(X)||ft(s,l,X,null,f,re)}}for(var Y in f){var X=f[Y];if(re=u[Y],f.hasOwnProperty(Y)&&(X!=null||re!=null))switch(Y){case"type":g=X;break;case"name":p=X;break;case"checked":W=X;break;case"defaultChecked":ne=X;break;case"value":w=X;break;case"defaultValue":N=X;break;case"children":case"dangerouslySetInnerHTML":if(X!=null)throw Error(n(137,l));break;default:X!==re&&ft(s,l,Y,X,f,re)}}lv(s,w,N,B,W,ne,g,p);return;case"select":X=w=N=Y=null;for(g in u)if(B=u[g],u.hasOwnProperty(g)&&B!=null)switch(g){case"value":break;case"multiple":X=B;default:f.hasOwnProperty(g)||ft(s,l,g,null,f,B)}for(p in f)if(g=f[p],B=u[p],f.hasOwnProperty(p)&&(g!=null||B!=null))switch(p){case"value":Y=g;break;case"defaultValue":N=g;break;case"multiple":w=g;default:g!==B&&ft(s,l,p,g,f,B)}l=N,u=w,f=X,Y!=null?Qs(s,!!u,Y,!1):!!f!=!!u&&(l!=null?Qs(s,!!u,l,!0):Qs(s,!!u,u?[]:"",!1));return;case"textarea":X=Y=null;for(N in u)if(p=u[N],u.hasOwnProperty(N)&&p!=null&&!f.hasOwnProperty(N))switch(N){case"value":break;case"children":break;default:ft(s,l,N,null,f,p)}for(w in f)if(p=f[w],g=u[w],f.hasOwnProperty(w)&&(p!=null||g!=null))switch(w){case"value":Y=p;break;case"defaultValue":X=p;break;case"children":break;case"dangerouslySetInnerHTML":if(p!=null)throw Error(n(91));break;default:p!==g&&ft(s,l,w,p,f,g)}hS(s,Y,X);return;case"option":for(var Se in u)Y=u[Se],u.hasOwnProperty(Se)&&Y!=null&&!f.hasOwnProperty(Se)&&(Se==="selected"?s.selected=!1:ft(s,l,Se,null,f,Y));for(B in f)Y=f[B],X=u[B],f.hasOwnProperty(B)&&Y!==X&&(Y!=null||X!=null)&&(B==="selected"?s.selected=Y&&typeof Y!="function"&&typeof Y!="symbol":ft(s,l,B,Y,f,X));return;case"img":case"link":case"area":case"base":case"br":case"col":case"embed":case"hr":case"keygen":case"meta":case"param":case"source":case"track":case"wbr":case"menuitem":for(var we in u)Y=u[we],u.hasOwnProperty(we)&&Y!=null&&!f.hasOwnProperty(we)&&ft(s,l,we,null,f,Y);for(W in f)if(Y=f[W],X=u[W],f.hasOwnProperty(W)&&Y!==X&&(Y!=null||X!=null))switch(W){case"children":case"dangerouslySetInnerHTML":if(Y!=null)throw Error(n(137,l));break;default:ft(s,l,W,Y,f,X)}return;default:if(uv(l)){for(var vt in u)Y=u[vt],u.hasOwnProperty(vt)&&Y!==void 0&&!f.hasOwnProperty(vt)&&$m(s,l,vt,void 0,f,Y);for(ne in f)Y=f[ne],X=u[ne],!f.hasOwnProperty(ne)||Y===X||Y===void 0&&X===void 0||$m(s,l,ne,Y,f,X);return}}for(var H in u)Y=u[H],u.hasOwnProperty(H)&&Y!=null&&!f.hasOwnProperty(H)&&ft(s,l,H,null,f,Y);for(re in f)Y=f[re],X=u[re],!f.hasOwnProperty(re)||Y===X||Y==null&&X==null||ft(s,l,re,Y,f,X)}function pT(s){switch(s){case"css":case"script":case"font":case"img":case"image":case"input":case"link":return!0;default:return!1}}function MA(){if(typeof performance.getEntriesByType=="function"){for(var s=0,l=0,u=performance.getEntriesByType("resource"),f=0;f<u.length;f++){var p=u[f],g=p.transferSize,w=p.initiatorType,N=p.duration;if(g&&N&&pT(w)){for(w=0,N=p.responseEnd,f+=1;f<u.length;f++){var B=u[f],W=B.startTime;if(W>N)break;var ne=B.transferSize,re=B.initiatorType;ne&&pT(re)&&(B=B.responseEnd,w+=ne*(B<N?1:(N-W)/(B-W)))}if(--f,l+=8*(g+w)/(p.duration/1e3),s++,10<s)break}}if(0<s)return l/s/1e6}return navigator.connection&&(s=navigator.connection.downlink,typeof s=="number")?s:5}var Xm=null,Qm=null;function Fd(s){return s.nodeType===9?s:s.ownerDocument}function gT(s){switch(s){case"http://www.w3.org/2000/svg":return 1;case"http://www.w3.org/1998/Math/MathML":return 2;default:return 0}}function yT(s,l){if(s===0)switch(l){case"svg":return 1;case"math":return 2;default:return 0}return s===1&&l==="foreignObject"?0:s}function Zm(s,l){return s==="textarea"||s==="noscript"||typeof l.children=="string"||typeof l.children=="number"||typeof l.children=="bigint"||typeof l.dangerouslySetInnerHTML=="object"&&l.dangerouslySetInnerHTML!==null&&l.dangerouslySetInnerHTML.__html!=null}var ep=null;function PA(){var s=window.event;return s&&s.type==="popstate"?s===ep?!1:(ep=s,!0):(ep=null,!1)}var bT=typeof setTimeout=="function"?setTimeout:void 0,AA=typeof clearTimeout=="function"?clearTimeout:void 0,ST=typeof Promise=="function"?Promise:void 0,DA=typeof queueMicrotask=="function"?queueMicrotask:typeof ST<"u"?function(s){return ST.resolve(null).then(s).catch(NA)}:bT;function NA(s){setTimeout(function(){throw s})}function ba(s){return s==="head"}function ET(s,l){var u=l,f=0;do{var p=u.nextSibling;if(s.removeChild(u),p&&p.nodeType===8)if(u=p.data,u==="/$"||u==="/&"){if(f===0){s.removeChild(p),Po(l);return}f--}else if(u==="$"||u==="$?"||u==="$~"||u==="$!"||u==="&")f++;else if(u==="html")uc(s.ownerDocument.documentElement);else if(u==="head"){u=s.ownerDocument.head,uc(u);for(var g=u.firstChild;g;){var w=g.nextSibling,N=g.nodeName;g[Il]||N==="SCRIPT"||N==="STYLE"||N==="LINK"&&g.rel.toLowerCase()==="stylesheet"||u.removeChild(g),g=w}}else u==="body"&&uc(s.ownerDocument.body);u=p}while(u);Po(l)}function TT(s,l){var u=s;s=0;do{var f=u.nextSibling;if(u.nodeType===1?l?(u._stashedDisplay=u.style.display,u.style.display="none"):(u.style.display=u._stashedDisplay||"",u.getAttribute("style")===""&&u.removeAttribute("style")):u.nodeType===3&&(l?(u._stashedText=u.nodeValue,u.nodeValue=""):u.nodeValue=u._stashedText||""),f&&f.nodeType===8)if(u=f.data,u==="/$"){if(s===0)break;s--}else u!=="$"&&u!=="$?"&&u!=="$~"&&u!=="$!"||s++;u=f}while(u)}function tp(s){var l=s.firstChild;for(l&&l.nodeType===10&&(l=l.nextSibling);l;){var u=l;switch(l=l.nextSibling,u.nodeName){case"HTML":case"HEAD":case"BODY":tp(u),sv(u);continue;case"SCRIPT":case"STYLE":continue;case"LINK":if(u.rel.toLowerCase()==="stylesheet")continue}s.removeChild(u)}}function xA(s,l,u,f){for(;s.nodeType===1;){var p=u;if(s.nodeName.toLowerCase()!==l.toLowerCase()){if(!f&&(s.nodeName!=="INPUT"||s.type!=="hidden"))break}else if(f){if(!s[Il])switch(l){case"meta":if(!s.hasAttribute("itemprop"))break;return s;case"link":if(g=s.getAttribute("rel"),g==="stylesheet"&&s.hasAttribute("data-precedence"))break;if(g!==p.rel||s.getAttribute("href")!==(p.href==null||p.href===""?null:p.href)||s.getAttribute("crossorigin")!==(p.crossOrigin==null?null:p.crossOrigin)||s.getAttribute("title")!==(p.title==null?null:p.title))break;return s;case"style":if(s.hasAttribute("data-precedence"))break;return s;case"script":if(g=s.getAttribute("src"),(g!==(p.src==null?null:p.src)||s.getAttribute("type")!==(p.type==null?null:p.type)||s.getAttribute("crossorigin")!==(p.crossOrigin==null?null:p.crossOrigin))&&g&&s.hasAttribute("async")&&!s.hasAttribute("itemprop"))break;return s;default:return s}}else if(l==="input"&&s.type==="hidden"){var g=p.name==null?null:""+p.name;if(p.type==="hidden"&&s.getAttribute("name")===g)return s}else return s;if(s=_i(s.nextSibling),s===null)break}return null}function LA(s,l,u){if(l==="")return null;for(;s.nodeType!==3;)if((s.nodeType!==1||s.nodeName!=="INPUT"||s.type!=="hidden")&&!u||(s=_i(s.nextSibling),s===null))return null;return s}function _T(s,l){for(;s.nodeType!==8;)if((s.nodeType!==1||s.nodeName!=="INPUT"||s.type!=="hidden")&&!l||(s=_i(s.nextSibling),s===null))return null;return s}function np(s){return s.data==="$?"||s.data==="$~"}function ip(s){return s.data==="$!"||s.data==="$?"&&s.ownerDocument.readyState!=="loading"}function UA(s,l){var u=s.ownerDocument;if(s.data==="$~")s._reactRetry=l;else if(s.data!=="$?"||u.readyState!=="loading")l();else{var f=function(){l(),u.removeEventListener("DOMContentLoaded",f)};u.addEventListener("DOMContentLoaded",f),s._reactRetry=f}}function _i(s){for(;s!=null;s=s.nextSibling){var l=s.nodeType;if(l===1||l===3)break;if(l===8){if(l=s.data,l==="$"||l==="$!"||l==="$?"||l==="$~"||l==="&"||l==="F!"||l==="F")break;if(l==="/$"||l==="/&")return null}}return s}var rp=null;function CT(s){s=s.nextSibling;for(var l=0;s;){if(s.nodeType===8){var u=s.data;if(u==="/$"||u==="/&"){if(l===0)return _i(s.nextSibling);l--}else u!=="$"&&u!=="$!"&&u!=="$?"&&u!=="$~"&&u!=="&"||l++}s=s.nextSibling}return null}function RT(s){s=s.previousSibling;for(var l=0;s;){if(s.nodeType===8){var u=s.data;if(u==="$"||u==="$!"||u==="$?"||u==="$~"||u==="&"){if(l===0)return s;l--}else u!=="/$"&&u!=="/&"||l++}s=s.previousSibling}return null}function kT(s,l,u){switch(l=Fd(u),s){case"html":if(s=l.documentElement,!s)throw Error(n(452));return s;case"head":if(s=l.head,!s)throw Error(n(453));return s;case"body":if(s=l.body,!s)throw Error(n(454));return s;default:throw Error(n(451))}}function uc(s){for(var l=s.attributes;l.length;)s.removeAttributeNode(l[0]);sv(s)}var Ci=new Map,wT=new Set;function jd(s){return typeof s.getRootNode=="function"?s.getRootNode():s.nodeType===9?s:s.ownerDocument}var Ar=Q.d;Q.d={f:BA,r:FA,D:jA,C:qA,L:VA,m:KA,X:GA,S:HA,M:zA};function BA(){var s=Ar.f(),l=Pd();return s||l}function FA(s){var l=Ys(s);l!==null&&l.tag===5&&l.type==="form"?H0(l):Ar.r(s)}var Io=typeof document>"u"?null:document;function IT(s,l,u){var f=Io;if(f&&typeof l=="string"&&l){var p=pi(l);p='link[rel="'+s+'"][href="'+p+'"]',typeof u=="string"&&(p+='[crossorigin="'+u+'"]'),wT.has(p)||(wT.add(p),s={rel:s,crossOrigin:u,href:l},f.querySelector(p)===null&&(l=f.createElement("link"),gn(l,"link",s),sn(l),f.head.appendChild(l)))}}function jA(s){Ar.D(s),IT("dns-prefetch",s,null)}function qA(s,l){Ar.C(s,l),IT("preconnect",s,l)}function VA(s,l,u){Ar.L(s,l,u);var f=Io;if(f&&s&&l){var p='link[rel="preload"][as="'+pi(l)+'"]';l==="image"&&u&&u.imageSrcSet?(p+='[imagesrcset="'+pi(u.imageSrcSet)+'"]',typeof u.imageSizes=="string"&&(p+='[imagesizes="'+pi(u.imageSizes)+'"]')):p+='[href="'+pi(s)+'"]';var g=p;switch(l){case"style":g=Oo(s);break;case"script":g=Mo(s)}Ci.has(g)||(s=m({rel:"preload",href:l==="image"&&u&&u.imageSrcSet?void 0:s,as:l},u),Ci.set(g,s),f.querySelector(p)!==null||l==="style"&&f.querySelector(dc(g))||l==="script"&&f.querySelector(hc(g))||(l=f.createElement("link"),gn(l,"link",s),sn(l),f.head.appendChild(l)))}}function KA(s,l){Ar.m(s,l);var u=Io;if(u&&s){var f=l&&typeof l.as=="string"?l.as:"script",p='link[rel="modulepreload"][as="'+pi(f)+'"][href="'+pi(s)+'"]',g=p;switch(f){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":g=Mo(s)}if(!Ci.has(g)&&(s=m({rel:"modulepreload",href:s},l),Ci.set(g,s),u.querySelector(p)===null)){switch(f){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":if(u.querySelector(hc(g)))return}f=u.createElement("link"),gn(f,"link",s),sn(f),u.head.appendChild(f)}}}function HA(s,l,u){Ar.S(s,l,u);var f=Io;if(f&&s){var p=$s(f).hoistableStyles,g=Oo(s);l=l||"default";var w=p.get(g);if(!w){var N={loading:0,preload:null};if(w=f.querySelector(dc(g)))N.loading=5;else{s=m({rel:"stylesheet",href:s,"data-precedence":l},u),(u=Ci.get(g))&&ap(s,u);var B=w=f.createElement("link");sn(B),gn(B,"link",s),B._p=new Promise(function(W,ne){B.onload=W,B.onerror=ne}),B.addEventListener("load",function(){N.loading|=1}),B.addEventListener("error",function(){N.loading|=2}),N.loading|=4,qd(w,l,f)}w={type:"stylesheet",instance:w,count:1,state:N},p.set(g,w)}}}function GA(s,l){Ar.X(s,l);var u=Io;if(u&&s){var f=$s(u).hoistableScripts,p=Mo(s),g=f.get(p);g||(g=u.querySelector(hc(p)),g||(s=m({src:s,async:!0},l),(l=Ci.get(p))&&sp(s,l),g=u.createElement("script"),sn(g),gn(g,"link",s),u.head.appendChild(g)),g={type:"script",instance:g,count:1,state:null},f.set(p,g))}}function zA(s,l){Ar.M(s,l);var u=Io;if(u&&s){var f=$s(u).hoistableScripts,p=Mo(s),g=f.get(p);g||(g=u.querySelector(hc(p)),g||(s=m({src:s,async:!0,type:"module"},l),(l=Ci.get(p))&&sp(s,l),g=u.createElement("script"),sn(g),gn(g,"link",s),u.head.appendChild(g)),g={type:"script",instance:g,count:1,state:null},f.set(p,g))}}function OT(s,l,u,f){var p=(p=Ae.current)?jd(p):null;if(!p)throw Error(n(446));switch(s){case"meta":case"title":return null;case"style":return typeof u.precedence=="string"&&typeof u.href=="string"?(l=Oo(u.href),u=$s(p).hoistableStyles,f=u.get(l),f||(f={type:"style",instance:null,count:0,state:null},u.set(l,f)),f):{type:"void",instance:null,count:0,state:null};case"link":if(u.rel==="stylesheet"&&typeof u.href=="string"&&typeof u.precedence=="string"){s=Oo(u.href);var g=$s(p).hoistableStyles,w=g.get(s);if(w||(p=p.ownerDocument||p,w={type:"stylesheet",instance:null,count:0,state:{loading:0,preload:null}},g.set(s,w),(g=p.querySelector(dc(s)))&&!g._p&&(w.instance=g,w.state.loading=5),Ci.has(s)||(u={rel:"preload",as:"style",href:u.href,crossOrigin:u.crossOrigin,integrity:u.integrity,media:u.media,hrefLang:u.hrefLang,referrerPolicy:u.referrerPolicy},Ci.set(s,u),g||WA(p,s,u,w.state))),l&&f===null)throw Error(n(528,""));return w}if(l&&f!==null)throw Error(n(529,""));return null;case"script":return l=u.async,u=u.src,typeof u=="string"&&l&&typeof l!="function"&&typeof l!="symbol"?(l=Mo(u),u=$s(p).hoistableScripts,f=u.get(l),f||(f={type:"script",instance:null,count:0,state:null},u.set(l,f)),f):{type:"void",instance:null,count:0,state:null};default:throw Error(n(444,s))}}function Oo(s){return'href="'+pi(s)+'"'}function dc(s){return'link[rel="stylesheet"]['+s+"]"}function MT(s){return m({},s,{"data-precedence":s.precedence,precedence:null})}function WA(s,l,u,f){s.querySelector('link[rel="preload"][as="style"]['+l+"]")?f.loading=1:(l=s.createElement("link"),f.preload=l,l.addEventListener("load",function(){return f.loading|=1}),l.addEventListener("error",function(){return f.loading|=2}),gn(l,"link",u),sn(l),s.head.appendChild(l))}function Mo(s){return'[src="'+pi(s)+'"]'}function hc(s){return"script[async]"+s}function PT(s,l,u){if(l.count++,l.instance===null)switch(l.type){case"style":var f=s.querySelector('style[data-href~="'+pi(u.href)+'"]');if(f)return l.instance=f,sn(f),f;var p=m({},u,{"data-href":u.href,"data-precedence":u.precedence,href:null,precedence:null});return f=(s.ownerDocument||s).createElement("style"),sn(f),gn(f,"style",p),qd(f,u.precedence,s),l.instance=f;case"stylesheet":p=Oo(u.href);var g=s.querySelector(dc(p));if(g)return l.state.loading|=4,l.instance=g,sn(g),g;f=MT(u),(p=Ci.get(p))&&ap(f,p),g=(s.ownerDocument||s).createElement("link"),sn(g);var w=g;return w._p=new Promise(function(N,B){w.onload=N,w.onerror=B}),gn(g,"link",f),l.state.loading|=4,qd(g,u.precedence,s),l.instance=g;case"script":return g=Mo(u.src),(p=s.querySelector(hc(g)))?(l.instance=p,sn(p),p):(f=u,(p=Ci.get(g))&&(f=m({},u),sp(f,p)),s=s.ownerDocument||s,p=s.createElement("script"),sn(p),gn(p,"link",f),s.head.appendChild(p),l.instance=p);case"void":return null;default:throw Error(n(443,l.type))}else l.type==="stylesheet"&&(l.state.loading&4)===0&&(f=l.instance,l.state.loading|=4,qd(f,u.precedence,s));return l.instance}function qd(s,l,u){for(var f=u.querySelectorAll('link[rel="stylesheet"][data-precedence],style[data-precedence]'),p=f.length?f[f.length-1]:null,g=p,w=0;w<f.length;w++){var N=f[w];if(N.dataset.precedence===l)g=N;else if(g!==p)break}g?g.parentNode.insertBefore(s,g.nextSibling):(l=u.nodeType===9?u.head:u,l.insertBefore(s,l.firstChild))}function ap(s,l){s.crossOrigin==null&&(s.crossOrigin=l.crossOrigin),s.referrerPolicy==null&&(s.referrerPolicy=l.referrerPolicy),s.title==null&&(s.title=l.title)}function sp(s,l){s.crossOrigin==null&&(s.crossOrigin=l.crossOrigin),s.referrerPolicy==null&&(s.referrerPolicy=l.referrerPolicy),s.integrity==null&&(s.integrity=l.integrity)}var Vd=null;function AT(s,l,u){if(Vd===null){var f=new Map,p=Vd=new Map;p.set(u,f)}else p=Vd,f=p.get(u),f||(f=new Map,p.set(u,f));if(f.has(s))return f;for(f.set(s,null),u=u.getElementsByTagName(s),p=0;p<u.length;p++){var g=u[p];if(!(g[Il]||g[fn]||s==="link"&&g.getAttribute("rel")==="stylesheet")&&g.namespaceURI!=="http://www.w3.org/2000/svg"){var w=g.getAttribute(l)||"";w=s+w;var N=f.get(w);N?N.push(g):f.set(w,[g])}}return f}function DT(s,l,u){s=s.ownerDocument||s,s.head.insertBefore(u,l==="title"?s.querySelector("head > title"):null)}function JA(s,l,u){if(u===1||l.itemProp!=null)return!1;switch(s){case"meta":case"title":return!0;case"style":if(typeof l.precedence!="string"||typeof l.href!="string"||l.href==="")break;return!0;case"link":if(typeof l.rel!="string"||typeof l.href!="string"||l.href===""||l.onLoad||l.onError)break;return l.rel==="stylesheet"?(s=l.disabled,typeof l.precedence=="string"&&s==null):!0;case"script":if(l.async&&typeof l.async!="function"&&typeof l.async!="symbol"&&!l.onLoad&&!l.onError&&l.src&&typeof l.src=="string")return!0}return!1}function NT(s){return!(s.type==="stylesheet"&&(s.state.loading&3)===0)}function YA(s,l,u,f){if(u.type==="stylesheet"&&(typeof f.media!="string"||matchMedia(f.media).matches!==!1)&&(u.state.loading&4)===0){if(u.instance===null){var p=Oo(f.href),g=l.querySelector(dc(p));if(g){l=g._p,l!==null&&typeof l=="object"&&typeof l.then=="function"&&(s.count++,s=Kd.bind(s),l.then(s,s)),u.state.loading|=4,u.instance=g,sn(g);return}g=l.ownerDocument||l,f=MT(f),(p=Ci.get(p))&&ap(f,p),g=g.createElement("link"),sn(g);var w=g;w._p=new Promise(function(N,B){w.onload=N,w.onerror=B}),gn(g,"link",f),u.instance=g}s.stylesheets===null&&(s.stylesheets=new Map),s.stylesheets.set(u,l),(l=u.state.preload)&&(u.state.loading&3)===0&&(s.count++,u=Kd.bind(s),l.addEventListener("load",u),l.addEventListener("error",u))}}var op=0;function $A(s,l){return s.stylesheets&&s.count===0&&Gd(s,s.stylesheets),0<s.count||0<s.imgCount?function(u){var f=setTimeout(function(){if(s.stylesheets&&Gd(s,s.stylesheets),s.unsuspend){var g=s.unsuspend;s.unsuspend=null,g()}},6e4+l);0<s.imgBytes&&op===0&&(op=62500*MA());var p=setTimeout(function(){if(s.waitingForImages=!1,s.count===0&&(s.stylesheets&&Gd(s,s.stylesheets),s.unsuspend)){var g=s.unsuspend;s.unsuspend=null,g()}},(s.imgBytes>op?50:800)+l);return s.unsuspend=u,function(){s.unsuspend=null,clearTimeout(f),clearTimeout(p)}}:null}function Kd(){if(this.count--,this.count===0&&(this.imgCount===0||!this.waitingForImages)){if(this.stylesheets)Gd(this,this.stylesheets);else if(this.unsuspend){var s=this.unsuspend;this.unsuspend=null,s()}}}var Hd=null;function Gd(s,l){s.stylesheets=null,s.unsuspend!==null&&(s.count++,Hd=new Map,l.forEach(XA,s),Hd=null,Kd.call(s))}function XA(s,l){if(!(l.state.loading&4)){var u=Hd.get(s);if(u)var f=u.get(null);else{u=new Map,Hd.set(s,u);for(var p=s.querySelectorAll("link[data-precedence],style[data-precedence]"),g=0;g<p.length;g++){var w=p[g];(w.nodeName==="LINK"||w.getAttribute("media")!=="not all")&&(u.set(w.dataset.precedence,w),f=w)}f&&u.set(null,f)}p=l.instance,w=p.getAttribute("data-precedence"),g=u.get(w)||f,g===f&&u.set(null,p),u.set(w,p),this.count++,f=Kd.bind(this),p.addEventListener("load",f),p.addEventListener("error",f),g?g.parentNode.insertBefore(p,g.nextSibling):(s=s.nodeType===9?s.head:s,s.insertBefore(p,s.firstChild)),l.state.loading|=4}}var fc={$$typeof:M,Provider:null,Consumer:null,_currentValue:le,_currentValue2:le,_threadCount:0};function QA(s,l,u,f,p,g,w,N,B){this.tag=1,this.containerInfo=s,this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.next=this.pendingContext=this.context=this.cancelPendingCommit=null,this.callbackPriority=0,this.expirationTimes=nv(-1),this.entangledLanes=this.shellSuspendCounter=this.errorRecoveryDisabledLanes=this.expiredLanes=this.warmLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=nv(0),this.hiddenUpdates=nv(null),this.identifierPrefix=f,this.onUncaughtError=p,this.onCaughtError=g,this.onRecoverableError=w,this.pooledCache=null,this.pooledCacheLanes=0,this.formState=B,this.incompleteTransitions=new Map}function xT(s,l,u,f,p,g,w,N,B,W,ne,re){return s=new QA(s,l,u,w,B,W,ne,re,N),l=1,g===!0&&(l|=24),g=Qn(3,null,null,l),s.current=g,g.stateNode=s,l=jv(),l.refCount++,s.pooledCache=l,l.refCount++,g.memoizedState={element:f,isDehydrated:u,cache:l},Hv(g),s}function LT(s){return s?(s=so,s):so}function UT(s,l,u,f,p,g){p=LT(p),f.context===null?f.context=p:f.pendingContext=p,f=la(l),f.payload={element:u},g=g===void 0?null:g,g!==null&&(f.callback=g),u=ca(s,f,l),u!==null&&(jn(u,s,l),Gl(u,s,l))}function BT(s,l){if(s=s.memoizedState,s!==null&&s.dehydrated!==null){var u=s.retryLane;s.retryLane=u!==0&&u<l?u:l}}function lp(s,l){BT(s,l),(s=s.alternate)&&BT(s,l)}function FT(s){if(s.tag===13||s.tag===31){var l=is(s,67108864);l!==null&&jn(l,s,67108864),lp(s,67108864)}}function jT(s){if(s.tag===13||s.tag===31){var l=ii();l=iv(l);var u=is(s,l);u!==null&&jn(u,s,l),lp(s,l)}}var zd=!0;function ZA(s,l,u,f){var p=V.T;V.T=null;var g=Q.p;try{Q.p=2,cp(s,l,u,f)}finally{Q.p=g,V.T=p}}function eD(s,l,u,f){var p=V.T;V.T=null;var g=Q.p;try{Q.p=8,cp(s,l,u,f)}finally{Q.p=g,V.T=p}}function cp(s,l,u,f){if(zd){var p=up(f);if(p===null)Ym(s,l,f,Wd,u),VT(s,f);else if(nD(p,s,l,u,f))f.stopPropagation();else if(VT(s,f),l&4&&-1<tD.indexOf(s)){for(;p!==null;){var g=Ys(p);if(g!==null)switch(g.tag){case 3:if(g=g.stateNode,g.current.memoizedState.isDehydrated){var w=Qa(g.pendingLanes);if(w!==0){var N=g;for(N.pendingLanes|=2,N.entangledLanes|=2;w;){var B=1<<31-$n(w);N.entanglements[1]|=B,w&=~B}Qi(g),(rt&6)===0&&(Od=Jn()+500,oc(0))}}break;case 31:case 13:N=is(g,2),N!==null&&jn(N,g,2),Pd(),lp(g,2)}if(g=up(f),g===null&&Ym(s,l,f,Wd,u),g===p)break;p=g}p!==null&&f.stopPropagation()}else Ym(s,l,f,null,u)}}function up(s){return s=hv(s),dp(s)}var Wd=null;function dp(s){if(Wd=null,s=Js(s),s!==null){var l=a(s);if(l===null)s=null;else{var u=l.tag;if(u===13){if(s=o(l),s!==null)return s;s=null}else if(u===31){if(s=c(l),s!==null)return s;s=null}else if(u===3){if(l.stateNode.current.memoizedState.isDehydrated)return l.tag===3?l.stateNode.containerInfo:null;s=null}else l!==s&&(s=null)}}return Wd=s,null}function qT(s){switch(s){case"beforetoggle":case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"toggle":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 2;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 8;case"message":switch(jM()){case Yb:return 2;case $b:return 8;case Lu:case qM:return 32;case Xb:return 268435456;default:return 32}default:return 32}}var hp=!1,Sa=null,Ea=null,Ta=null,vc=new Map,mc=new Map,_a=[],tD="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset".split(" ");function VT(s,l){switch(s){case"focusin":case"focusout":Sa=null;break;case"dragenter":case"dragleave":Ea=null;break;case"mouseover":case"mouseout":Ta=null;break;case"pointerover":case"pointerout":vc.delete(l.pointerId);break;case"gotpointercapture":case"lostpointercapture":mc.delete(l.pointerId)}}function pc(s,l,u,f,p,g){return s===null||s.nativeEvent!==g?(s={blockedOn:l,domEventName:u,eventSystemFlags:f,nativeEvent:g,targetContainers:[p]},l!==null&&(l=Ys(l),l!==null&&FT(l)),s):(s.eventSystemFlags|=f,l=s.targetContainers,p!==null&&l.indexOf(p)===-1&&l.push(p),s)}function nD(s,l,u,f,p){switch(l){case"focusin":return Sa=pc(Sa,s,l,u,f,p),!0;case"dragenter":return Ea=pc(Ea,s,l,u,f,p),!0;case"mouseover":return Ta=pc(Ta,s,l,u,f,p),!0;case"pointerover":var g=p.pointerId;return vc.set(g,pc(vc.get(g)||null,s,l,u,f,p)),!0;case"gotpointercapture":return g=p.pointerId,mc.set(g,pc(mc.get(g)||null,s,l,u,f,p)),!0}return!1}function KT(s){var l=Js(s.target);if(l!==null){var u=a(l);if(u!==null){if(l=u.tag,l===13){if(l=o(u),l!==null){s.blockedOn=l,iS(s.priority,function(){jT(u)});return}}else if(l===31){if(l=c(u),l!==null){s.blockedOn=l,iS(s.priority,function(){jT(u)});return}}else if(l===3&&u.stateNode.current.memoizedState.isDehydrated){s.blockedOn=u.tag===3?u.stateNode.containerInfo:null;return}}}s.blockedOn=null}function Jd(s){if(s.blockedOn!==null)return!1;for(var l=s.targetContainers;0<l.length;){var u=up(s.nativeEvent);if(u===null){u=s.nativeEvent;var f=new u.constructor(u.type,u);dv=f,u.target.dispatchEvent(f),dv=null}else return l=Ys(u),l!==null&&FT(l),s.blockedOn=u,!1;l.shift()}return!0}function HT(s,l,u){Jd(s)&&u.delete(l)}function iD(){hp=!1,Sa!==null&&Jd(Sa)&&(Sa=null),Ea!==null&&Jd(Ea)&&(Ea=null),Ta!==null&&Jd(Ta)&&(Ta=null),vc.forEach(HT),mc.forEach(HT)}function Yd(s,l){s.blockedOn===l&&(s.blockedOn=null,hp||(hp=!0,i.unstable_scheduleCallback(i.unstable_NormalPriority,iD)))}var $d=null;function GT(s){$d!==s&&($d=s,i.unstable_scheduleCallback(i.unstable_NormalPriority,function(){$d===s&&($d=null);for(var l=0;l<s.length;l+=3){var u=s[l],f=s[l+1],p=s[l+2];if(typeof f!="function"){if(dp(f||u)===null)continue;break}var g=Ys(u);g!==null&&(s.splice(l,3),l-=3,um(g,{pending:!0,data:p,method:u.method,action:f},f,p))}}))}function Po(s){function l(B){return Yd(B,s)}Sa!==null&&Yd(Sa,s),Ea!==null&&Yd(Ea,s),Ta!==null&&Yd(Ta,s),vc.forEach(l),mc.forEach(l);for(var u=0;u<_a.length;u++){var f=_a[u];f.blockedOn===s&&(f.blockedOn=null)}for(;0<_a.length&&(u=_a[0],u.blockedOn===null);)KT(u),u.blockedOn===null&&_a.shift();if(u=(s.ownerDocument||s).$$reactFormReplay,u!=null)for(f=0;f<u.length;f+=3){var p=u[f],g=u[f+1],w=p[Nn]||null;if(typeof g=="function")w||GT(u);else if(w){var N=null;if(g&&g.hasAttribute("formAction")){if(p=g,w=g[Nn]||null)N=w.formAction;else if(dp(p)!==null)continue}else N=w.action;typeof N=="function"?u[f+1]=N:(u.splice(f,3),f-=3),GT(u)}}}function zT(){function s(g){g.canIntercept&&g.info==="react-transition"&&g.intercept({handler:function(){return new Promise(function(w){return p=w})},focusReset:"manual",scroll:"manual"})}function l(){p!==null&&(p(),p=null),f||setTimeout(u,20)}function u(){if(!f&&!navigation.transition){var g=navigation.currentEntry;g&&g.url!=null&&navigation.navigate(g.url,{state:g.getState(),info:"react-transition",history:"replace"})}}if(typeof navigation=="object"){var f=!1,p=null;return navigation.addEventListener("navigate",s),navigation.addEventListener("navigatesuccess",l),navigation.addEventListener("navigateerror",l),setTimeout(u,100),function(){f=!0,navigation.removeEventListener("navigate",s),navigation.removeEventListener("navigatesuccess",l),navigation.removeEventListener("navigateerror",l),p!==null&&(p(),p=null)}}}function fp(s){this._internalRoot=s}Xd.prototype.render=fp.prototype.render=function(s){var l=this._internalRoot;if(l===null)throw Error(n(409));var u=l.current,f=ii();UT(u,f,s,l,null,null)},Xd.prototype.unmount=fp.prototype.unmount=function(){var s=this._internalRoot;if(s!==null){this._internalRoot=null;var l=s.containerInfo;UT(s.current,2,null,s,null,null),Pd(),l[Ws]=null}};function Xd(s){this._internalRoot=s}Xd.prototype.unstable_scheduleHydration=function(s){if(s){var l=nS();s={blockedOn:null,target:s,priority:l};for(var u=0;u<_a.length&&l!==0&&l<_a[u].priority;u++);_a.splice(u,0,s),u===0&&KT(s)}};var WT=e.version;if(WT!=="19.2.3")throw Error(n(527,WT,"19.2.3"));Q.findDOMNode=function(s){var l=s._reactInternals;if(l===void 0)throw typeof s.render=="function"?Error(n(188)):(s=Object.keys(s).join(","),Error(n(268,s)));return s=h(l),s=s!==null?v(s):null,s=s===null?null:s.stateNode,s};var rD={bundleType:0,version:"19.2.3",rendererPackageName:"react-dom",currentDispatcherRef:V,reconcilerVersion:"19.2.3"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var Qd=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!Qd.isDisabled&&Qd.supportsFiber)try{Rl=Qd.inject(rD),Yn=Qd}catch{}}return Dc.createRoot=function(s,l){if(!r(s))throw Error(n(299));var u=!1,f="",p=eE,g=tE,w=nE;return l!=null&&(l.unstable_strictMode===!0&&(u=!0),l.identifierPrefix!==void 0&&(f=l.identifierPrefix),l.onUncaughtError!==void 0&&(p=l.onUncaughtError),l.onCaughtError!==void 0&&(g=l.onCaughtError),l.onRecoverableError!==void 0&&(w=l.onRecoverableError)),l=xT(s,1,!1,null,null,u,f,null,p,g,w,zT),s[Ws]=l.current,Jm(s),new fp(l)},Dc.hydrateRoot=function(s,l,u){if(!r(s))throw Error(n(299));var f=!1,p="",g=eE,w=tE,N=nE,B=null;return u!=null&&(u.unstable_strictMode===!0&&(f=!0),u.identifierPrefix!==void 0&&(p=u.identifierPrefix),u.onUncaughtError!==void 0&&(g=u.onUncaughtError),u.onCaughtError!==void 0&&(w=u.onCaughtError),u.onRecoverableError!==void 0&&(N=u.onRecoverableError),u.formState!==void 0&&(B=u.formState)),l=xT(s,1,!0,l,u??null,f,p,B,g,w,N,zT),l.context=LT(null),u=l.current,f=ii(),f=iv(f),p=la(f),p.callback=null,ca(u,p,f),u=f,l.current.lanes=u,wl(l,u),Qi(l),s[Ws]=l.current,Jm(s),new Xd(l)},Dc.version="19.2.3",Dc}var tR;function cU(){if(tR)return Vp.exports;tR=1;function i(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(i)}catch(e){console.error(e)}}return i(),Vp.exports=lU(),Vp.exports}var qq=cU(),nR={};function uU(i,e){return e.forEach(function(t){t&&typeof t!="string"&&!Array.isArray(t)&&Object.keys(t).forEach(function(n){if(n!=="default"&&!(n in i)){var r=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(i,n,r.get?r:{enumerable:!0,get:function(){return t[n]}})}})}),Object.freeze(i)}var dU=Object.defineProperty,hU=(i,e,t)=>e in i?dU(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,iR=(i,e,t)=>hU(i,typeof e!="symbol"?e+"":e,t);class An{constructor(){iR(this,"_locking"),iR(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let e;const t=new Promise(r=>e=()=>{this._locks-=1,r()}),n=this._locking.then(()=>e);return this._locking=this._locking.then(()=>t),n}}function Bt(i,e){if(!i)throw new Error(e)}const fU=34028234663852886e22,vU=-34028234663852886e22,mU=4294967295,pU=2147483647,gU=-2147483648;function Oh(i){if(typeof i!="number")throw new Error("invalid int 32: "+typeof i);if(!Number.isInteger(i)||i>pU||i<gU)throw new Error("invalid int 32: "+i)}function ly(i){if(typeof i!="number")throw new Error("invalid uint 32: "+typeof i);if(!Number.isInteger(i)||i>mU||i<0)throw new Error("invalid uint 32: "+i)}function gI(i){if(typeof i!="number")throw new Error("invalid float 32: "+typeof i);if(Number.isFinite(i)&&(i>fU||i<vU))throw new Error("invalid float 32: "+i)}const yI=Symbol("@bufbuild/protobuf/enum-type");function yU(i){const e=i[yI];return Bt(e,"missing enum type on enum object"),e}function bI(i,e,t,n){i[yI]=SI(e,t.map(r=>({no:r.no,name:r.name,localName:i[r.no]})))}function SI(i,e,t){const n=Object.create(null),r=Object.create(null),a=[];for(const o of e){const c=EI(o);a.push(c),n[o.name]=c,r[o.no]=c}return{typeName:i,values:a,findName(o){return n[o]},findNumber(o){return r[o]}}}function bU(i,e,t){const n={};for(const r of e){const a=EI(r);n[a.localName]=a.no,n[a.no]=a.localName}return bI(n,i,e),n}function EI(i){return"localName"in i?i:Object.assign(Object.assign({},i),{localName:i.name})}class bb{equals(e){return this.getType().runtime.util.equals(this.getType(),this,e)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(e,t){const n=this.getType(),r=n.runtime.bin,a=r.makeReadOptions(t);return r.readMessage(this,a.readerFactory(e),e.byteLength,a),this}fromJson(e,t){const n=this.getType(),r=n.runtime.json,a=r.makeReadOptions(t);return r.readMessage(n,e,a,this),this}fromJsonString(e,t){let n;try{n=JSON.parse(e)}catch(r){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(r instanceof Error?r.message:String(r)))}return this.fromJson(n,t)}toBinary(e){const t=this.getType(),n=t.runtime.bin,r=n.makeWriteOptions(e),a=r.writerFactory();return n.writeMessage(this,a,r),a.finish()}toJson(e){const t=this.getType(),n=t.runtime.json,r=n.makeWriteOptions(e);return n.writeMessage(this,r)}toJsonString(e){var t;const n=this.toJson(e);return JSON.stringify(n,null,(t=e?.prettySpaces)!==null&&t!==void 0?t:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function SU(i,e,t,n){var r;const a=(r=n?.localName)!==null&&r!==void 0?r:e.substring(e.lastIndexOf(".")+1),o={[a]:function(c){i.util.initFields(this),i.util.initPartial(c,this)}}[a];return Object.setPrototypeOf(o.prototype,new bb),Object.assign(o,{runtime:i,typeName:e,fields:i.util.newFieldList(t),fromBinary(c,d){return new o().fromBinary(c,d)},fromJson(c,d){return new o().fromJson(c,d)},fromJsonString(c,d){return new o().fromJsonString(c,d)},equals(c,d){return i.util.equals(o,c,d)}}),o}function EU(){let i=0,e=0;for(let n=0;n<28;n+=7){let r=this.buf[this.pos++];if(i|=(r&127)<<n,(r&128)==0)return this.assertBounds(),[i,e]}let t=this.buf[this.pos++];if(i|=(t&15)<<28,e=(t&112)>>4,(t&128)==0)return this.assertBounds(),[i,e];for(let n=3;n<=31;n+=7){let r=this.buf[this.pos++];if(e|=(r&127)<<n,(r&128)==0)return this.assertBounds(),[i,e]}throw new Error("invalid varint")}function zp(i,e,t){for(let a=0;a<28;a=a+7){const o=i>>>a,c=!(!(o>>>7)&&e==0),d=(c?o|128:o)&255;if(t.push(d),!c)return}const n=i>>>28&15|(e&7)<<4,r=e>>3!=0;if(t.push((r?n|128:n)&255),!!r){for(let a=3;a<31;a=a+7){const o=e>>>a,c=!!(o>>>7),d=(c?o|128:o)&255;if(t.push(d),!c)return}t.push(e>>>31&1)}}const Mh=4294967296;function rR(i){const e=i[0]==="-";e&&(i=i.slice(1));const t=1e6;let n=0,r=0;function a(o,c){const d=Number(i.slice(o,c));r*=t,n=n*t+d,n>=Mh&&(r=r+(n/Mh|0),n=n%Mh)}return a(-24,-18),a(-18,-12),a(-12,-6),a(-6),e?_I(n,r):Sb(n,r)}function TU(i,e){let t=Sb(i,e);const n=t.hi&2147483648;n&&(t=_I(t.lo,t.hi));const r=TI(t.lo,t.hi);return n?"-"+r:r}function TI(i,e){if({lo:i,hi:e}=_U(i,e),e<=2097151)return String(Mh*e+i);const t=i&16777215,n=(i>>>24|e<<8)&16777215,r=e>>16&65535;let a=t+n*6777216+r*6710656,o=n+r*8147497,c=r*2;const d=1e7;return a>=d&&(o+=Math.floor(a/d),a%=d),o>=d&&(c+=Math.floor(o/d),o%=d),c.toString()+aR(o)+aR(a)}function _U(i,e){return{lo:i>>>0,hi:e>>>0}}function Sb(i,e){return{lo:i|0,hi:e|0}}function _I(i,e){return e=~e,i?i=~i+1:e+=1,Sb(i,e)}const aR=i=>{const e=String(i);return"0000000".slice(e.length)+e};function sR(i,e){if(i>=0){for(;i>127;)e.push(i&127|128),i=i>>>7;e.push(i)}else{for(let t=0;t<9;t++)e.push(i&127|128),i=i>>7;e.push(1)}}function CU(){let i=this.buf[this.pos++],e=i&127;if((i&128)==0)return this.assertBounds(),e;if(i=this.buf[this.pos++],e|=(i&127)<<7,(i&128)==0)return this.assertBounds(),e;if(i=this.buf[this.pos++],e|=(i&127)<<14,(i&128)==0)return this.assertBounds(),e;if(i=this.buf[this.pos++],e|=(i&127)<<21,(i&128)==0)return this.assertBounds(),e;i=this.buf[this.pos++],e|=(i&15)<<28;for(let t=5;(i&128)!==0&&t<10;t++)i=this.buf[this.pos++];if((i&128)!=0)throw new Error("invalid varint");return this.assertBounds(),e>>>0}function RU(){const i=new DataView(new ArrayBuffer(8));if(typeof BigInt=="function"&&typeof i.getBigInt64=="function"&&typeof i.getBigUint64=="function"&&typeof i.setBigInt64=="function"&&typeof i.setBigUint64=="function"&&(typeof process!="object"||typeof nR!="object"||nR.BUF_BIGINT_DISABLE!=="1")){const r=BigInt("-9223372036854775808"),a=BigInt("9223372036854775807"),o=BigInt("0"),c=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(d){const h=typeof d=="bigint"?d:BigInt(d);if(h>a||h<r)throw new Error("int64 invalid: ".concat(d));return h},uParse(d){const h=typeof d=="bigint"?d:BigInt(d);if(h>c||h<o)throw new Error("uint64 invalid: ".concat(d));return h},enc(d){return i.setBigInt64(0,this.parse(d),!0),{lo:i.getInt32(0,!0),hi:i.getInt32(4,!0)}},uEnc(d){return i.setBigInt64(0,this.uParse(d),!0),{lo:i.getInt32(0,!0),hi:i.getInt32(4,!0)}},dec(d,h){return i.setInt32(0,d,!0),i.setInt32(4,h,!0),i.getBigInt64(0,!0)},uDec(d,h){return i.setInt32(0,d,!0),i.setInt32(4,h,!0),i.getBigUint64(0,!0)}}}const t=r=>Bt(/^-?[0-9]+$/.test(r),"int64 invalid: ".concat(r)),n=r=>Bt(/^[0-9]+$/.test(r),"uint64 invalid: ".concat(r));return{zero:"0",supported:!1,parse(r){return typeof r!="string"&&(r=r.toString()),t(r),r},uParse(r){return typeof r!="string"&&(r=r.toString()),n(r),r},enc(r){return typeof r!="string"&&(r=r.toString()),t(r),rR(r)},uEnc(r){return typeof r!="string"&&(r=r.toString()),n(r),rR(r)},dec(r,a){return TU(r,a)},uDec(r,a){return TI(r,a)}}}const Pt=RU();var oe;(function(i){i[i.DOUBLE=1]="DOUBLE",i[i.FLOAT=2]="FLOAT",i[i.INT64=3]="INT64",i[i.UINT64=4]="UINT64",i[i.INT32=5]="INT32",i[i.FIXED64=6]="FIXED64",i[i.FIXED32=7]="FIXED32",i[i.BOOL=8]="BOOL",i[i.STRING=9]="STRING",i[i.BYTES=12]="BYTES",i[i.UINT32=13]="UINT32",i[i.SFIXED32=15]="SFIXED32",i[i.SFIXED64=16]="SFIXED64",i[i.SINT32=17]="SINT32",i[i.SINT64=18]="SINT64"})(oe||(oe={}));var za;(function(i){i[i.BIGINT=0]="BIGINT",i[i.STRING=1]="STRING"})(za||(za={}));function wa(i,e,t){if(e===t)return!0;if(i==oe.BYTES){if(!(e instanceof Uint8Array)||!(t instanceof Uint8Array)||e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}switch(i){case oe.UINT64:case oe.FIXED64:case oe.INT64:case oe.SFIXED64:case oe.SINT64:return e==t}return!1}function gl(i,e){switch(i){case oe.BOOL:return!1;case oe.UINT64:case oe.FIXED64:case oe.INT64:case oe.SFIXED64:case oe.SINT64:return e==0?Pt.zero:"0";case oe.DOUBLE:case oe.FLOAT:return 0;case oe.BYTES:return new Uint8Array(0);case oe.STRING:return"";default:return 0}}function CI(i,e){switch(i){case oe.BOOL:return e===!1;case oe.STRING:return e==="";case oe.BYTES:return e instanceof Uint8Array&&!e.byteLength;default:return e==0}}var Vt;(function(i){i[i.Varint=0]="Varint",i[i.Bit64=1]="Bit64",i[i.LengthDelimited=2]="LengthDelimited",i[i.StartGroup=3]="StartGroup",i[i.EndGroup=4]="EndGroup",i[i.Bit32=5]="Bit32"})(Vt||(Vt={}));class kU{constructor(e){this.stack=[],this.textEncoder=e??new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let r=0;r<this.chunks.length;r++)e+=this.chunks[r].length;let t=new Uint8Array(e),n=0;for(let r=0;r<this.chunks.length;r++)t.set(this.chunks[r],n),n+=this.chunks[r].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(ly(e);e>127;)this.buf.push(e&127|128),e=e>>>7;return this.buf.push(e),this}int32(e){return Oh(e),sR(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){gI(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){ly(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){Oh(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return Oh(e),e=(e<<1^e>>31)>>>0,sR(e,this.buf),this}sfixed64(e){let t=new Uint8Array(8),n=new DataView(t.buffer),r=Pt.enc(e);return n.setInt32(0,r.lo,!0),n.setInt32(4,r.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),n=new DataView(t.buffer),r=Pt.uEnc(e);return n.setInt32(0,r.lo,!0),n.setInt32(4,r.hi,!0),this.raw(t)}int64(e){let t=Pt.enc(e);return zp(t.lo,t.hi,this.buf),this}sint64(e){let t=Pt.enc(e),n=t.hi>>31,r=t.lo<<1^n,a=(t.hi<<1|t.lo>>>31)^n;return zp(r,a,this.buf),this}uint64(e){let t=Pt.uEnc(e);return zp(t.lo,t.hi,this.buf),this}}class wU{constructor(e,t){this.varint64=EU,this.uint32=CU,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=t??new TextDecoder}tag(){let e=this.uint32(),t=e>>>3,n=e&7;if(t<=0||n<0||n>5)throw new Error("illegal tag: field no "+t+" wire type "+n);return[t,n]}skip(e,t){let n=this.pos;switch(e){case Vt.Varint:for(;this.buf[this.pos++]&128;);break;case Vt.Bit64:this.pos+=4;case Vt.Bit32:this.pos+=4;break;case Vt.LengthDelimited:let r=this.uint32();this.pos+=r;break;case Vt.StartGroup:for(;;){const[a,o]=this.tag();if(o===Vt.EndGroup){if(t!==void 0&&a!==t)throw new Error("invalid end group tag");break}this.skip(o,a)}break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(n,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)}int64(){return Pt.dec(...this.varint64())}uint64(){return Pt.uDec(...this.varint64())}sint64(){let[e,t]=this.varint64(),n=-(e&1);return e=(e>>>1|(t&1)<<31)^n,t=t>>>1^n,Pt.dec(e,t)}bool(){let[e,t]=this.varint64();return e!==0||t!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return Pt.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return Pt.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}function IU(i,e,t,n){let r;return{typeName:e,extendee:t,get field(){if(!r){const a=typeof n=="function"?n():n;a.name=e.split(".").pop(),a.jsonName="[".concat(e,"]"),r=i.util.newFieldList([a]).list()[0]}return r},runtime:i}}function RI(i){const e=i.field.localName,t=Object.create(null);return t[e]=OU(i),[t,()=>t[e]]}function OU(i){const e=i.field;if(e.repeated)return[];if(e.default!==void 0)return e.default;switch(e.kind){case"enum":return e.T.values[0].no;case"scalar":return gl(e.T,e.L);case"message":const t=e.T,n=new t;return t.fieldWrapper?t.fieldWrapper.unwrapField(n):n;case"map":throw"map fields are not allowed to be extensions"}}function MU(i,e){if(!e.repeated&&(e.kind=="enum"||e.kind=="scalar")){for(let t=i.length-1;t>=0;--t)if(i[t].no==e.no)return[i[t]];return[]}return i.filter(t=>t.no===e.no)}let Vr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),jf=[];for(let i=0;i<Vr.length;i++)jf[Vr[i].charCodeAt(0)]=i;jf[45]=Vr.indexOf("+");jf[95]=Vr.indexOf("/");const kI={dec(i){let e=i.length*3/4;i[i.length-2]=="="?e-=2:i[i.length-1]=="="&&(e-=1);let t=new Uint8Array(e),n=0,r=0,a,o=0;for(let c=0;c<i.length;c++){if(a=jf[i.charCodeAt(c)],a===void 0)switch(i[c]){case"=":r=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(r){case 0:o=a,r=1;break;case 1:t[n++]=o<<2|(a&48)>>4,o=a,r=2;break;case 2:t[n++]=(o&15)<<4|(a&60)>>2,o=a,r=3;break;case 3:t[n++]=(o&3)<<6|a,r=0;break}}if(r==1)throw Error("invalid base64 string.");return t.subarray(0,n)},enc(i){let e="",t=0,n,r=0;for(let a=0;a<i.length;a++)switch(n=i[a],t){case 0:e+=Vr[n>>2],r=(n&3)<<4,t=1;break;case 1:e+=Vr[r|n>>4],r=(n&15)<<2,t=2;break;case 2:e+=Vr[r|n>>6],e+=Vr[n&63],t=0;break}return t&&(e+=Vr[r],e+="=",t==1&&(e+="=")),e}};function PU(i,e,t){II(e,i);const n=e.runtime.bin.makeReadOptions(t),r=MU(i.getType().runtime.bin.listUnknownFields(i),e.field),[a,o]=RI(e);for(const c of r)e.runtime.bin.readField(a,n.readerFactory(c.data),e.field,c.wireType,n);return o()}function AU(i,e,t,n){II(e,i);const r=e.runtime.bin.makeReadOptions(n),a=e.runtime.bin.makeWriteOptions(n);if(wI(i,e)){const h=i.getType().runtime.bin.listUnknownFields(i).filter(v=>v.no!=e.field.no);i.getType().runtime.bin.discardUnknownFields(i);for(const v of h)i.getType().runtime.bin.onUnknownField(i,v.no,v.wireType,v.data)}const o=a.writerFactory();let c=e.field;!c.opt&&!c.repeated&&(c.kind=="enum"||c.kind=="scalar")&&(c=Object.assign(Object.assign({},e.field),{opt:!0})),e.runtime.bin.writeField(c,t,o,a);const d=r.readerFactory(o.finish());for(;d.pos<d.len;){const[h,v]=d.tag(),m=d.skip(v,h);i.getType().runtime.bin.onUnknownField(i,h,v,m)}}function wI(i,e){const t=i.getType();return e.extendee.typeName===t.typeName&&!!t.runtime.bin.listUnknownFields(i).find(n=>n.no==e.field.no)}function II(i,e){Bt(i.extendee.typeName==e.getType().typeName,"extension ".concat(i.typeName," can only be applied to message ").concat(i.extendee.typeName))}function OI(i,e){const t=i.localName;if(i.repeated)return e[t].length>0;if(i.oneof)return e[i.oneof.localName].case===t;switch(i.kind){case"enum":case"scalar":return i.opt||i.req?e[t]!==void 0:i.kind=="enum"?e[t]!==i.T.values[0].no:!CI(i.T,e[t]);case"message":return e[t]!==void 0;case"map":return Object.keys(e[t]).length>0}}function oR(i,e){const t=i.localName,n=!i.opt&&!i.req;if(i.repeated)e[t]=[];else if(i.oneof)e[i.oneof.localName]={case:void 0};else switch(i.kind){case"map":e[t]={};break;case"enum":e[t]=n?i.T.values[0].no:void 0;break;case"scalar":e[t]=n?gl(i.T,i.L):void 0;break;case"message":e[t]=void 0;break}}function Kr(i,e){if(i===null||typeof i!="object"||!Object.getOwnPropertyNames(bb.prototype).every(n=>n in i&&typeof i[n]=="function"))return!1;const t=i.getType();return t===null||typeof t!="function"||!("typeName"in t)||typeof t.typeName!="string"?!1:e===void 0?!0:t.typeName==e.typeName}function MI(i,e){return Kr(e)||!i.fieldWrapper?e:i.fieldWrapper.wrapField(e)}oe.DOUBLE,oe.FLOAT,oe.INT64,oe.UINT64,oe.INT32,oe.UINT32,oe.BOOL,oe.STRING,oe.BYTES;const lR={ignoreUnknownFields:!1},cR={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function DU(i){return i?Object.assign(Object.assign({},lR),i):lR}function NU(i){return i?Object.assign(Object.assign({},cR),i):cR}const sf=Symbol(),Ph=Symbol();function xU(){return{makeReadOptions:DU,makeWriteOptions:NU,readMessage(i,e,t,n){if(e==null||Array.isArray(e)||typeof e!="object")throw new Error("cannot decode message ".concat(i.typeName," from JSON: ").concat(lr(e)));n=n??new i;const r=new Map,a=t.typeRegistry;for(const[o,c]of Object.entries(e)){const d=i.fields.findJsonName(o);if(d){if(d.oneof){if(c===null&&d.kind=="scalar")continue;const h=r.get(d.oneof);if(h!==void 0)throw new Error("cannot decode message ".concat(i.typeName,' from JSON: multiple keys for oneof "').concat(d.oneof.name,'" present: "').concat(h,'", "').concat(o,'"'));r.set(d.oneof,o)}uR(n,c,d,t,i)}else{let h=!1;if(a?.findExtension&&o.startsWith("[")&&o.endsWith("]")){const v=a.findExtension(o.substring(1,o.length-1));if(v&&v.extendee.typeName==i.typeName){h=!0;const[m,y]=RI(v);uR(m,c,v.field,t,v),AU(n,v,y(),t)}}if(!h&&!t.ignoreUnknownFields)throw new Error("cannot decode message ".concat(i.typeName,' from JSON: key "').concat(o,'" is unknown'))}}return n},writeMessage(i,e){const t=i.getType(),n={};let r;try{for(r of t.fields.byNumber()){if(!OI(r,i)){if(r.req)throw"required field not set";if(!e.emitDefaultValues||!UU(r))continue}const o=r.oneof?i[r.oneof.localName].value:i[r.localName],c=dR(r,o,e);c!==void 0&&(n[e.useProtoFieldName?r.name:r.jsonName]=c)}const a=e.typeRegistry;if(a?.findExtensionFor)for(const o of t.runtime.bin.listUnknownFields(i)){const c=a.findExtensionFor(t.typeName,o.no);if(c&&wI(i,c)){const d=PU(i,c,e),h=dR(c.field,d,e);h!==void 0&&(n[c.field.jsonName]=h)}}}catch(a){const o=r?"cannot encode field ".concat(t.typeName,".").concat(r.name," to JSON"):"cannot encode message ".concat(t.typeName," to JSON"),c=a instanceof Error?a.message:String(a);throw new Error(o+(c.length>0?": ".concat(c):""))}return n},readScalar(i,e,t){return Qc(i,e,t??za.BIGINT,!0)},writeScalar(i,e,t){if(e!==void 0&&(t||CI(i,e)))return Ah(i,e)},debug:lr}}function lr(i){if(i===null)return"null";switch(typeof i){case"object":return Array.isArray(i)?"array":"object";case"string":return i.length>100?"string":'"'.concat(i.split('"').join('\\"'),'"');default:return String(i)}}function uR(i,e,t,n,r){let a=t.localName;if(t.repeated){if(Bt(t.kind!="map"),e===null)return;if(!Array.isArray(e))throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(lr(e)));const o=i[a];for(const c of e){if(c===null)throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(lr(c)));switch(t.kind){case"message":o.push(t.T.fromJson(c,n));break;case"enum":const d=Wp(t.T,c,n.ignoreUnknownFields,!0);d!==Ph&&o.push(d);break;case"scalar":try{o.push(Qc(t.T,c,t.L,!0))}catch(h){let v="cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(lr(c));throw h instanceof Error&&h.message.length>0&&(v+=": ".concat(h.message)),new Error(v)}break}}}else if(t.kind=="map"){if(e===null)return;if(typeof e!="object"||Array.isArray(e))throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(lr(e)));const o=i[a];for(const[c,d]of Object.entries(e)){if(d===null)throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: map value null"));let h;try{h=LU(t.K,c)}catch(v){let m="cannot decode map key for field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(lr(e));throw v instanceof Error&&v.message.length>0&&(m+=": ".concat(v.message)),new Error(m)}switch(t.V.kind){case"message":o[h]=t.V.T.fromJson(d,n);break;case"enum":const v=Wp(t.V.T,d,n.ignoreUnknownFields,!0);v!==Ph&&(o[h]=v);break;case"scalar":try{o[h]=Qc(t.V.T,d,za.BIGINT,!0)}catch(m){let y="cannot decode map value for field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(lr(e));throw m instanceof Error&&m.message.length>0&&(y+=": ".concat(m.message)),new Error(y)}break}}}else switch(t.oneof&&(i=i[t.oneof.localName]={case:a},a="value"),t.kind){case"message":const o=t.T;if(e===null&&o.typeName!="google.protobuf.Value")return;let c=i[a];Kr(c)?c.fromJson(e,n):(i[a]=c=o.fromJson(e,n),o.fieldWrapper&&!t.oneof&&(i[a]=o.fieldWrapper.unwrapField(c)));break;case"enum":const d=Wp(t.T,e,n.ignoreUnknownFields,!1);switch(d){case sf:oR(t,i);break;case Ph:break;default:i[a]=d;break}break;case"scalar":try{const h=Qc(t.T,e,t.L,!1);h===sf?oR(t,i):i[a]=h}catch(h){let v="cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(lr(e));throw h instanceof Error&&h.message.length>0&&(v+=": ".concat(h.message)),new Error(v)}break}}function LU(i,e){if(i===oe.BOOL)switch(e){case"true":e=!0;break;case"false":e=!1;break}return Qc(i,e,za.BIGINT,!0).toString()}function Qc(i,e,t,n){if(e===null)return n?gl(i,t):sf;switch(i){case oe.DOUBLE:case oe.FLOAT:if(e==="NaN")return Number.NaN;if(e==="Infinity")return Number.POSITIVE_INFINITY;if(e==="-Infinity")return Number.NEGATIVE_INFINITY;if(e===""||typeof e=="string"&&e.trim().length!==e.length||typeof e!="string"&&typeof e!="number")break;const r=Number(e);if(Number.isNaN(r)||!Number.isFinite(r))break;return i==oe.FLOAT&&gI(r),r;case oe.INT32:case oe.FIXED32:case oe.SFIXED32:case oe.SINT32:case oe.UINT32:let a;if(typeof e=="number"?a=e:typeof e=="string"&&e.length>0&&e.trim().length===e.length&&(a=Number(e)),a===void 0)break;return i==oe.UINT32||i==oe.FIXED32?ly(a):Oh(a),a;case oe.INT64:case oe.SFIXED64:case oe.SINT64:if(typeof e!="number"&&typeof e!="string")break;const o=Pt.parse(e);return t?o.toString():o;case oe.FIXED64:case oe.UINT64:if(typeof e!="number"&&typeof e!="string")break;const c=Pt.uParse(e);return t?c.toString():c;case oe.BOOL:if(typeof e!="boolean")break;return e;case oe.STRING:if(typeof e!="string")break;try{encodeURIComponent(e)}catch{throw new Error("invalid UTF8")}return e;case oe.BYTES:if(e==="")return new Uint8Array(0);if(typeof e!="string")break;return kI.dec(e)}throw new Error}function Wp(i,e,t,n){if(e===null)return i.typeName=="google.protobuf.NullValue"?0:n?i.values[0].no:sf;switch(typeof e){case"number":if(Number.isInteger(e))return e;break;case"string":const r=i.findName(e);if(r!==void 0)return r.no;if(t)return Ph;break}throw new Error("cannot decode enum ".concat(i.typeName," from JSON: ").concat(lr(e)))}function UU(i){return i.repeated||i.kind=="map"?!0:!(i.oneof||i.kind=="message"||i.opt||i.req)}function dR(i,e,t){if(i.kind=="map"){Bt(typeof e=="object"&&e!=null);const n={},r=Object.entries(e);switch(i.V.kind){case"scalar":for(const[o,c]of r)n[o.toString()]=Ah(i.V.T,c);break;case"message":for(const[o,c]of r)n[o.toString()]=c.toJson(t);break;case"enum":const a=i.V.T;for(const[o,c]of r)n[o.toString()]=Jp(a,c,t.enumAsInteger);break}return t.emitDefaultValues||r.length>0?n:void 0}if(i.repeated){Bt(Array.isArray(e));const n=[];switch(i.kind){case"scalar":for(let r=0;r<e.length;r++)n.push(Ah(i.T,e[r]));break;case"enum":for(let r=0;r<e.length;r++)n.push(Jp(i.T,e[r],t.enumAsInteger));break;case"message":for(let r=0;r<e.length;r++)n.push(e[r].toJson(t));break}return t.emitDefaultValues||n.length>0?n:void 0}switch(i.kind){case"scalar":return Ah(i.T,e);case"enum":return Jp(i.T,e,t.enumAsInteger);case"message":return MI(i.T,e).toJson(t)}}function Jp(i,e,t){var n;if(Bt(typeof e=="number"),i.typeName=="google.protobuf.NullValue")return null;if(t)return e;const r=i.findNumber(e);return(n=r?.name)!==null&&n!==void 0?n:e}function Ah(i,e){switch(i){case oe.INT32:case oe.SFIXED32:case oe.SINT32:case oe.FIXED32:case oe.UINT32:return Bt(typeof e=="number"),e;case oe.FLOAT:case oe.DOUBLE:return Bt(typeof e=="number"),Number.isNaN(e)?"NaN":e===Number.POSITIVE_INFINITY?"Infinity":e===Number.NEGATIVE_INFINITY?"-Infinity":e;case oe.STRING:return Bt(typeof e=="string"),e;case oe.BOOL:return Bt(typeof e=="boolean"),e;case oe.UINT64:case oe.FIXED64:case oe.INT64:case oe.SFIXED64:case oe.SINT64:return Bt(typeof e=="bigint"||typeof e=="string"||typeof e=="number"),e.toString();case oe.BYTES:return Bt(e instanceof Uint8Array),kI.enc(e)}}const Fo=Symbol("@bufbuild/protobuf/unknown-fields"),hR={readUnknownFields:!0,readerFactory:i=>new wU(i)},fR={writeUnknownFields:!0,writerFactory:()=>new kU};function BU(i){return i?Object.assign(Object.assign({},hR),i):hR}function FU(i){return i?Object.assign(Object.assign({},fR),i):fR}function jU(){return{makeReadOptions:BU,makeWriteOptions:FU,listUnknownFields(i){var e;return(e=i[Fo])!==null&&e!==void 0?e:[]},discardUnknownFields(i){delete i[Fo]},writeUnknownFields(i,e){const n=i[Fo];if(n)for(const r of n)e.tag(r.no,r.wireType).raw(r.data)},onUnknownField(i,e,t,n){const r=i;Array.isArray(r[Fo])||(r[Fo]=[]),r[Fo].push({no:e,wireType:t,data:n})},readMessage(i,e,t,n,r){const a=i.getType(),o=r?e.len:e.pos+t;let c,d;for(;e.pos<o&&([c,d]=e.tag(),!(r===!0&&d==Vt.EndGroup));){const h=a.fields.find(c);if(!h){const v=e.skip(d,c);n.readUnknownFields&&this.onUnknownField(i,c,d,v);continue}vR(i,e,h,d,n)}if(r&&(d!=Vt.EndGroup||c!==t))throw new Error("invalid end group tag")},readField:vR,writeMessage(i,e,t){const n=i.getType();for(const r of n.fields.byNumber()){if(!OI(r,i)){if(r.req)throw new Error("cannot encode field ".concat(n.typeName,".").concat(r.name," to binary: required field not set"));continue}const a=r.oneof?i[r.oneof.localName].value:i[r.localName];mR(r,a,e,t)}return t.writeUnknownFields&&this.writeUnknownFields(i,e),e},writeField(i,e,t,n){e!==void 0&&mR(i,e,t,n)}}}function vR(i,e,t,n,r){let{repeated:a,localName:o}=t;switch(t.oneof&&(i=i[t.oneof.localName],i.case!=o&&delete i.value,i.case=o,o="value"),t.kind){case"scalar":case"enum":const c=t.kind=="enum"?oe.INT32:t.T;let d=of;if(t.kind=="scalar"&&t.L>0&&(d=VU),a){let y=i[o];if(n==Vt.LengthDelimited&&c!=oe.STRING&&c!=oe.BYTES){let T=e.uint32()+e.pos;for(;e.pos<T;)y.push(d(e,c))}else y.push(d(e,c))}else i[o]=d(e,c);break;case"message":const h=t.T;a?i[o].push(Dh(e,new h,r,t)):Kr(i[o])?Dh(e,i[o],r,t):(i[o]=Dh(e,new h,r,t),h.fieldWrapper&&!t.oneof&&!t.repeated&&(i[o]=h.fieldWrapper.unwrapField(i[o])));break;case"map":let[v,m]=qU(t,e,r);i[o][v]=m;break}}function Dh(i,e,t,n){const r=e.getType().runtime.bin,a=n?.delimited;return r.readMessage(e,i,a?n.no:i.uint32(),t,a),e}function qU(i,e,t){const n=e.uint32(),r=e.pos+n;let a,o;for(;e.pos<r;){const[c]=e.tag();switch(c){case 1:a=of(e,i.K);break;case 2:switch(i.V.kind){case"scalar":o=of(e,i.V.T);break;case"enum":o=e.int32();break;case"message":o=Dh(e,new i.V.T,t,void 0);break}break}}if(a===void 0&&(a=gl(i.K,za.BIGINT)),typeof a!="string"&&typeof a!="number"&&(a=a.toString()),o===void 0)switch(i.V.kind){case"scalar":o=gl(i.V.T,za.BIGINT);break;case"enum":o=i.V.T.values[0].no;break;case"message":o=new i.V.T;break}return[a,o]}function VU(i,e){const t=of(i,e);return typeof t=="bigint"?t.toString():t}function of(i,e){switch(e){case oe.STRING:return i.string();case oe.BOOL:return i.bool();case oe.DOUBLE:return i.double();case oe.FLOAT:return i.float();case oe.INT32:return i.int32();case oe.INT64:return i.int64();case oe.UINT64:return i.uint64();case oe.FIXED64:return i.fixed64();case oe.BYTES:return i.bytes();case oe.FIXED32:return i.fixed32();case oe.SFIXED32:return i.sfixed32();case oe.SFIXED64:return i.sfixed64();case oe.SINT64:return i.sint64();case oe.UINT32:return i.uint32();case oe.SINT32:return i.sint32()}}function mR(i,e,t,n){Bt(e!==void 0);const r=i.repeated;switch(i.kind){case"scalar":case"enum":let a=i.kind=="enum"?oe.INT32:i.T;if(r)if(Bt(Array.isArray(e)),i.packed)HU(t,a,i.no,e);else for(const o of e)Zc(t,a,i.no,o);else Zc(t,a,i.no,e);break;case"message":if(r){Bt(Array.isArray(e));for(const o of e)pR(t,n,i,o)}else pR(t,n,i,e);break;case"map":Bt(typeof e=="object"&&e!=null);for(const[o,c]of Object.entries(e))KU(t,n,i,o,c);break}}function KU(i,e,t,n,r){i.tag(t.no,Vt.LengthDelimited),i.fork();let a=n;switch(t.K){case oe.INT32:case oe.FIXED32:case oe.UINT32:case oe.SFIXED32:case oe.SINT32:a=Number.parseInt(n);break;case oe.BOOL:Bt(n=="true"||n=="false"),a=n=="true";break}switch(Zc(i,t.K,1,a),t.V.kind){case"scalar":Zc(i,t.V.T,2,r);break;case"enum":Zc(i,oe.INT32,2,r);break;case"message":Bt(r!==void 0),i.tag(2,Vt.LengthDelimited).bytes(r.toBinary(e));break}i.join()}function pR(i,e,t,n){const r=MI(t.T,n);t.delimited?i.tag(t.no,Vt.StartGroup).raw(r.toBinary(e)).tag(t.no,Vt.EndGroup):i.tag(t.no,Vt.LengthDelimited).bytes(r.toBinary(e))}function Zc(i,e,t,n){Bt(n!==void 0);let[r,a]=PI(e);i.tag(t,r)[a](n)}function HU(i,e,t,n){if(!n.length)return;i.tag(t,Vt.LengthDelimited).fork();let[,r]=PI(e);for(let a=0;a<n.length;a++)i[r](n[a]);i.join()}function PI(i){let e=Vt.Varint;switch(i){case oe.BYTES:case oe.STRING:e=Vt.LengthDelimited;break;case oe.DOUBLE:case oe.FIXED64:case oe.SFIXED64:e=Vt.Bit64;break;case oe.FIXED32:case oe.SFIXED32:case oe.FLOAT:e=Vt.Bit32;break}const t=oe[i].toLowerCase();return[e,t]}function GU(){return{setEnumType:bI,initPartial(i,e){if(i===void 0)return;const t=e.getType();for(const n of t.fields.byMember()){const r=n.localName,a=e,o=i;if(o[r]!=null)switch(n.kind){case"oneof":const c=o[r].case;if(c===void 0)continue;const d=n.findField(c);let h=o[r].value;d&&d.kind=="message"&&!Kr(h,d.T)?h=new d.T(h):d&&d.kind==="scalar"&&d.T===oe.BYTES&&(h=Nc(h)),a[r]={case:c,value:h};break;case"scalar":case"enum":let v=o[r];n.T===oe.BYTES&&(v=n.repeated?v.map(Nc):Nc(v)),a[r]=v;break;case"map":switch(n.V.kind){case"scalar":case"enum":if(n.V.T===oe.BYTES)for(const[E,T]of Object.entries(o[r]))a[r][E]=Nc(T);else Object.assign(a[r],o[r]);break;case"message":const y=n.V.T;for(const E of Object.keys(o[r])){let T=o[r][E];y.fieldWrapper||(T=new y(T)),a[r][E]=T}break}break;case"message":const m=n.T;if(n.repeated)a[r]=o[r].map(y=>Kr(y,m)?y:new m(y));else{const y=o[r];m.fieldWrapper?m.typeName==="google.protobuf.BytesValue"?a[r]=Nc(y):a[r]=y:a[r]=Kr(y,m)?y:new m(y)}break}}},equals(i,e,t){return e===t?!0:!e||!t?!1:i.fields.byMember().every(n=>{const r=e[n.localName],a=t[n.localName];if(n.repeated){if(r.length!==a.length)return!1;switch(n.kind){case"message":return r.every((o,c)=>n.T.equals(o,a[c]));case"scalar":return r.every((o,c)=>wa(n.T,o,a[c]));case"enum":return r.every((o,c)=>wa(oe.INT32,o,a[c]))}throw new Error("repeated cannot contain ".concat(n.kind))}switch(n.kind){case"message":let o=r,c=a;return n.T.fieldWrapper&&(o!==void 0&&!Kr(o)&&(o=n.T.fieldWrapper.wrapField(o)),c!==void 0&&!Kr(c)&&(c=n.T.fieldWrapper.wrapField(c))),n.T.equals(o,c);case"enum":return wa(oe.INT32,r,a);case"scalar":return wa(n.T,r,a);case"oneof":if(r.case!==a.case)return!1;const d=n.findField(r.case);if(d===void 0)return!0;switch(d.kind){case"message":return d.T.equals(r.value,a.value);case"enum":return wa(oe.INT32,r.value,a.value);case"scalar":return wa(d.T,r.value,a.value)}throw new Error("oneof cannot contain ".concat(d.kind));case"map":const h=Object.keys(r).concat(Object.keys(a));switch(n.V.kind){case"message":const v=n.V.T;return h.every(y=>v.equals(r[y],a[y]));case"enum":return h.every(y=>wa(oe.INT32,r[y],a[y]));case"scalar":const m=n.V.T;return h.every(y=>wa(m,r[y],a[y]))}break}})},clone(i){const e=i.getType(),t=new e,n=t;for(const r of e.fields.byMember()){const a=i[r.localName];let o;if(r.repeated)o=a.map(vh);else if(r.kind=="map"){o=n[r.localName];for(const[c,d]of Object.entries(a))o[c]=vh(d)}else r.kind=="oneof"?o=r.findField(a.case)?{case:a.case,value:vh(a.value)}:{case:void 0}:o=vh(a);n[r.localName]=o}for(const r of e.runtime.bin.listUnknownFields(i))e.runtime.bin.onUnknownField(n,r.no,r.wireType,r.data);return t}}}function vh(i){if(i===void 0)return i;if(Kr(i))return i.clone();if(i instanceof Uint8Array){const e=new Uint8Array(i.byteLength);return e.set(i),e}return i}function Nc(i){return i instanceof Uint8Array?i:new Uint8Array(i)}function zU(i,e,t){return{syntax:i,json:xU(),bin:jU(),util:Object.assign(Object.assign({},GU()),{newFieldList:e,initFields:t}),makeMessageType(n,r,a){return SU(this,n,r,a)},makeEnum:bU,makeEnumType:SI,getEnumType:yU,makeExtension(n,r,a){return IU(this,n,r,a)}}}class WU{constructor(e,t){this._fields=e,this._normalizer=t}findJsonName(e){if(!this.jsonNames){const t={};for(const n of this.list())t[n.jsonName]=t[n.name]=n;this.jsonNames=t}return this.jsonNames[e]}find(e){if(!this.numbers){const t={};for(const n of this.list())t[n.no]=n;this.numbers=t}return this.numbers[e]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort((e,t)=>e.no-t.no)),this.numbersAsc}byMember(){if(!this.members){this.members=[];const e=this.members;let t;for(const n of this.list())n.oneof?n.oneof!==t&&(t=n.oneof,e.push(t)):e.push(n)}return this.members}}function AI(i,e){const t=DI(i);return e?t:ZU(QU(t))}function JU(i){return AI(i,!1)}const YU=DI;function DI(i){let e=!1;const t=[];for(let n=0;n<i.length;n++){let r=i.charAt(n);switch(r){case"_":e=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":t.push(r),e=!1;break;default:e&&(e=!1,r=r.toUpperCase()),t.push(r);break}}return t.join("")}const $U=new Set(["constructor","toString","toJSON","valueOf"]),XU=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),NI=i=>"".concat(i,"$"),QU=i=>XU.has(i)?NI(i):i,ZU=i=>$U.has(i)?NI(i):i;class eB{constructor(e){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=e,this.localName=JU(e)}addField(e){Bt(e.oneof===this,"field ".concat(e.name," not one of ").concat(this.name)),this.fields.push(e)}findField(e){if(!this._lookup){this._lookup=Object.create(null);for(let t=0;t<this.fields.length;t++)this._lookup[this.fields[t].localName]=this.fields[t]}return this._lookup[e]}}function tB(i,e){var t,n,r,a,o,c;const d=[];let h;for(const v of typeof i=="function"?i():i){const m=v;if(m.localName=AI(v.name,v.oneof!==void 0),m.jsonName=(t=v.jsonName)!==null&&t!==void 0?t:YU(v.name),m.repeated=(n=v.repeated)!==null&&n!==void 0?n:!1,v.kind=="scalar"&&(m.L=(r=v.L)!==null&&r!==void 0?r:za.BIGINT),m.delimited=(a=v.delimited)!==null&&a!==void 0?a:!1,m.req=(o=v.req)!==null&&o!==void 0?o:!1,m.opt=(c=v.opt)!==null&&c!==void 0?c:!1,v.packed===void 0&&(m.packed=v.kind=="enum"||v.kind=="scalar"&&v.T!=oe.BYTES&&v.T!=oe.STRING),v.oneof!==void 0){const y=typeof v.oneof=="string"?v.oneof:v.oneof.name;(!h||h.name!=y)&&(h=new eB(y)),m.oneof=h,h.addField(m)}d.push(m)}return d}const J=zU("proto3",i=>new WU(i,e=>tB(e)),i=>{for(const e of i.getType().fields.byMember()){if(e.opt)continue;const t=e.localName,n=i;if(e.repeated){n[t]=[];continue}switch(e.kind){case"oneof":n[t]={case:void 0};break;case"enum":n[t]=0;break;case"map":n[t]={};break;case"scalar":n[t]=gl(e.T,e.L);break}}});class Kn extends bb{constructor(e){super(),this.seconds=Pt.zero,this.nanos=0,J.util.initPartial(e,this)}fromJson(e,t){if(typeof e!="string")throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(J.json.debug(e)));const n=e.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!n)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const r=Date.parse(n[1]+"-"+n[2]+"-"+n[3]+"T"+n[4]+":"+n[5]+":"+n[6]+(n[8]?n[8]:"Z"));if(Number.isNaN(r))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(r<Date.parse("0001-01-01T00:00:00Z")||r>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=Pt.parse(r/1e3),this.nanos=0,n[7]&&(this.nanos=parseInt("1"+n[7]+"0".repeat(9-n[7].length))-1e9),this}toJson(e){const t=Number(this.seconds)*1e3;if(t<Date.parse("0001-01-01T00:00:00Z")||t>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let n="Z";if(this.nanos>0){const r=(this.nanos+1e9).toString().substring(1);r.substring(3)==="000000"?n="."+r.substring(0,3)+"Z":r.substring(6)==="000"?n="."+r.substring(0,6)+"Z":n="."+r+"Z"}return new Date(t).toISOString().replace(".000Z",n)}toDate(){return new Date(Number(this.seconds)*1e3+Math.ceil(this.nanos/1e6))}static now(){return Kn.fromDate(new Date)}static fromDate(e){const t=e.getTime();return new Kn({seconds:Pt.parse(Math.floor(t/1e3)),nanos:t%1e3*1e6})}static fromBinary(e,t){return new Kn().fromBinary(e,t)}static fromJson(e,t){return new Kn().fromJson(e,t)}static fromJsonString(e,t){return new Kn().fromJsonString(e,t)}static equals(e,t){return J.util.equals(Kn,e,t)}}Kn.runtime=J;Kn.typeName="google.protobuf.Timestamp";Kn.fields=J.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);const nB=J.makeMessageType("livekit.MetricsBatch",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Kn},{no:3,name:"str_data",kind:"scalar",T:9,repeated:!0},{no:4,name:"time_series",kind:"message",T:iB,repeated:!0},{no:5,name:"events",kind:"message",T:aB,repeated:!0}]),iB=J.makeMessageType("livekit.TimeSeriesMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:rB,repeated:!0},{no:5,name:"rid",kind:"scalar",T:13}]),rB=J.makeMessageType("livekit.MetricSample",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Kn},{no:3,name:"value",kind:"scalar",T:2}]),aB=J.makeMessageType("livekit.EventMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:!0},{no:6,name:"normalized_start_timestamp",kind:"message",T:Kn},{no:7,name:"normalized_end_timestamp",kind:"message",T:Kn,opt:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}]),xI=J.makeEnum("livekit.BackupCodecPolicy",[{no:0,name:"PREFER_REGRESSION"},{no:1,name:"SIMULCAST"},{no:2,name:"REGRESSION"}]),qi=J.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),Xt=J.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),Eb=J.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]),Kc=J.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]),pu=J.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]),Hi=J.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"},{no:13,name:"SIP_TRUNK_FAILURE"},{no:14,name:"CONNECTION_TIMEOUT"},{no:15,name:"MEDIA_FAILURE"}]),Is=J.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]),sB=J.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]),dn=J.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"},{no:6,name:"TF_PRECONNECT_BUFFER"}]),qf=J.makeMessageType("livekit.Room",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:15,name:"creation_time_ms",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:lf,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:JI}]),lf=J.makeMessageType("livekit.Codec",()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]),oB=J.makeMessageType("livekit.ParticipantPermission",()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:J.getEnumType(Xt),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}]),js=J.makeMessageType("livekit.ParticipantInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:J.getEnumType(tl)},{no:4,name:"tracks",kind:"message",T:zo,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:17,name:"joined_at_ms",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:oB},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:J.getEnumType(gu)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:J.getEnumType(Hi)},{no:18,name:"kind_details",kind:"enum",T:J.getEnumType(lB),repeated:!0}]),tl=J.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]),gu=J.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"},{no:7,name:"CONNECTOR"}]),lB=J.makeEnum("livekit.ParticipantInfo.KindDetail",[{no:0,name:"CLOUD_AGENT"},{no:1,name:"FORWARDED"}]),rn=J.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]),cB=J.makeMessageType("livekit.SimulcastCodecInfo",()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:Va,repeated:!0},{no:5,name:"video_layer_mode",kind:"enum",T:J.getEnumType(LI)},{no:6,name:"sdp_cid",kind:"scalar",T:9}]),zo=J.makeMessageType("livekit.TrackInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:J.getEnumType(qi)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:J.getEnumType(Xt)},{no:10,name:"layers",kind:"message",T:Va,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:cB,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:J.getEnumType(rn)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:JI},{no:19,name:"audio_features",kind:"enum",T:J.getEnumType(dn),repeated:!0},{no:20,name:"backup_codec_policy",kind:"enum",T:J.getEnumType(xI)}]),Va=J.makeMessageType("livekit.VideoLayer",()=>[{no:1,name:"quality",kind:"enum",T:J.getEnumType(Eb)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13},{no:6,name:"spatial_layer",kind:"scalar",T:5},{no:7,name:"rid",kind:"scalar",T:9}]),LI=J.makeEnum("livekit.VideoLayer.Mode",[{no:0,name:"MODE_UNUSED"},{no:1,name:"ONE_SPATIAL_LAYER_PER_STREAM"},{no:2,name:"MULTIPLE_SPATIAL_LAYERS_PER_STREAM"},{no:3,name:"ONE_SPATIAL_LAYER_PER_STREAM_INCOMPLETE_RTCP_SR"}]),Pn=J.makeMessageType("livekit.DataPacket",()=>[{no:1,name:"kind",kind:"enum",T:J.getEnumType(Je)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:2,name:"user",kind:"message",T:Tb,oneof:"value"},{no:3,name:"speaker",kind:"message",T:uB,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:jI,oneof:"value"},{no:7,name:"transcription",kind:"message",T:dB,oneof:"value"},{no:8,name:"metrics",kind:"message",T:nB,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:cf,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:_b,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:Cb,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:Rb,oneof:"value"},{no:13,name:"stream_header",kind:"message",T:uf,oneof:"value"},{no:14,name:"stream_chunk",kind:"message",T:df,oneof:"value"},{no:15,name:"stream_trailer",kind:"message",T:hf,oneof:"value"},{no:18,name:"encrypted_packet",kind:"message",T:UI,oneof:"value"},{no:16,name:"sequence",kind:"scalar",T:13},{no:17,name:"participant_sid",kind:"scalar",T:9}]),Je=J.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]),UI=J.makeMessageType("livekit.EncryptedPacket",()=>[{no:1,name:"encryption_type",kind:"enum",T:J.getEnumType(rn)},{no:2,name:"iv",kind:"scalar",T:12},{no:3,name:"key_index",kind:"scalar",T:13},{no:4,name:"encrypted_value",kind:"scalar",T:12}]),BI=J.makeMessageType("livekit.EncryptedPacketPayload",()=>[{no:1,name:"user",kind:"message",T:Tb,oneof:"value"},{no:3,name:"chat_message",kind:"message",T:cf,oneof:"value"},{no:4,name:"rpc_request",kind:"message",T:_b,oneof:"value"},{no:5,name:"rpc_ack",kind:"message",T:Cb,oneof:"value"},{no:6,name:"rpc_response",kind:"message",T:Rb,oneof:"value"},{no:7,name:"stream_header",kind:"message",T:uf,oneof:"value"},{no:8,name:"stream_chunk",kind:"message",T:df,oneof:"value"},{no:9,name:"stream_trailer",kind:"message",T:hf,oneof:"value"}]),uB=J.makeMessageType("livekit.ActiveSpeakerUpdate",()=>[{no:1,name:"speakers",kind:"message",T:FI,repeated:!0}]),FI=J.makeMessageType("livekit.SpeakerInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]),Tb=J.makeMessageType("livekit.UserPacket",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0},{no:8,name:"id",kind:"scalar",T:9,opt:!0},{no:9,name:"start_time",kind:"scalar",T:4,opt:!0},{no:10,name:"end_time",kind:"scalar",T:4,opt:!0},{no:11,name:"nonce",kind:"scalar",T:12}]),jI=J.makeMessageType("livekit.SipDTMF",()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}]),dB=J.makeMessageType("livekit.Transcription",()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:hB,repeated:!0}]),hB=J.makeMessageType("livekit.TranscriptionSegment",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}]),cf=J.makeMessageType("livekit.ChatMessage",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:!0},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}]),_b=J.makeMessageType("livekit.RpcRequest",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}]),Cb=J.makeMessageType("livekit.RpcAck",()=>[{no:1,name:"request_id",kind:"scalar",T:9}]),Rb=J.makeMessageType("livekit.RpcResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:qI,oneof:"value"}]),qI=J.makeMessageType("livekit.RpcError",()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}]),VI=J.makeMessageType("livekit.ParticipantTracks",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}]),KI=J.makeMessageType("livekit.ServerInfo",()=>[{no:1,name:"edition",kind:"enum",T:J.getEnumType(HI)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}]),HI=J.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]),GI=J.makeMessageType("livekit.ClientInfo",()=>[{no:1,name:"sdk",kind:"enum",T:J.getEnumType(zI)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}]),zI=J.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"},{no:13,name:"UNREAL"},{no:14,name:"ESP32"}]),WI=J.makeMessageType("livekit.ClientConfiguration",()=>[{no:1,name:"video",kind:"message",T:gR},{no:2,name:"screen",kind:"message",T:gR},{no:3,name:"resume_connection",kind:"enum",T:J.getEnumType(pu)},{no:4,name:"disabled_codecs",kind:"message",T:fB},{no:5,name:"force_relay",kind:"enum",T:J.getEnumType(pu)}]),gR=J.makeMessageType("livekit.VideoConfiguration",()=>[{no:1,name:"hardware_encoder",kind:"enum",T:J.getEnumType(pu)}]),fB=J.makeMessageType("livekit.DisabledCodecs",()=>[{no:1,name:"codecs",kind:"message",T:lf,repeated:!0},{no:2,name:"publish",kind:"message",T:lf,repeated:!0}]),JI=J.makeMessageType("livekit.TimedVersion",()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]),cy=J.makeEnum("livekit.DataStream.OperationType",[{no:0,name:"CREATE"},{no:1,name:"UPDATE"},{no:2,name:"DELETE"},{no:3,name:"REACTION"}]),YI=J.makeMessageType("livekit.DataStream.TextHeader",()=>[{no:1,name:"operation_type",kind:"enum",T:J.getEnumType(cy)},{no:2,name:"version",kind:"scalar",T:5},{no:3,name:"reply_to_stream_id",kind:"scalar",T:9},{no:4,name:"attached_stream_ids",kind:"scalar",T:9,repeated:!0},{no:5,name:"generated",kind:"scalar",T:8}],{localName:"DataStream_TextHeader"}),$I=J.makeMessageType("livekit.DataStream.ByteHeader",()=>[{no:1,name:"name",kind:"scalar",T:9}],{localName:"DataStream_ByteHeader"}),uf=J.makeMessageType("livekit.DataStream.Header",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"mime_type",kind:"scalar",T:9},{no:5,name:"total_length",kind:"scalar",T:4,opt:!0},{no:7,name:"encryption_type",kind:"enum",T:J.getEnumType(rn)},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:9,name:"text_header",kind:"message",T:YI,oneof:"content_header"},{no:10,name:"byte_header",kind:"message",T:$I,oneof:"content_header"}],{localName:"DataStream_Header"}),df=J.makeMessageType("livekit.DataStream.Chunk",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"chunk_index",kind:"scalar",T:4},{no:3,name:"content",kind:"scalar",T:12},{no:4,name:"version",kind:"scalar",T:5},{no:5,name:"iv",kind:"scalar",T:12,opt:!0}],{localName:"DataStream_Chunk"}),hf=J.makeMessageType("livekit.DataStream.Trailer",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"reason",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}],{localName:"DataStream_Trailer"}),vB=J.makeMessageType("livekit.SubscribedAudioCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"enabled",kind:"scalar",T:8}]),Vi=J.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]),uy=J.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),mB=J.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]),pB=J.makeMessageType("livekit.SignalRequest",()=>[{no:1,name:"offer",kind:"message",T:Wa,oneof:"message"},{no:2,name:"answer",kind:"message",T:Wa,oneof:"message"},{no:3,name:"trickle",kind:"message",T:Vf,oneof:"message"},{no:4,name:"add_track",kind:"message",T:yu,oneof:"message"},{no:5,name:"mute",kind:"message",T:Kf,oneof:"message"},{no:6,name:"subscription",kind:"message",T:Hf,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:XI,oneof:"message"},{no:8,name:"leave",kind:"message",T:Gf,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:ZI,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:nO,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:Mb,oneof:"message"},{no:13,name:"simulate",kind:"message",T:ar,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:Ib,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:aO,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:wb,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:QI,oneof:"message"}]),yR=J.makeMessageType("livekit.SignalResponse",()=>[{no:1,name:"join",kind:"message",T:gB,oneof:"message"},{no:2,name:"answer",kind:"message",T:Wa,oneof:"message"},{no:3,name:"offer",kind:"message",T:Wa,oneof:"message"},{no:4,name:"trickle",kind:"message",T:Vf,oneof:"message"},{no:5,name:"update",kind:"message",T:SB,oneof:"message"},{no:6,name:"track_published",kind:"message",T:kb,oneof:"message"},{no:8,name:"leave",kind:"message",T:Gf,oneof:"message"},{no:9,name:"mute",kind:"message",T:Kf,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:EB,oneof:"message"},{no:11,name:"room_update",kind:"message",T:TB,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:CB,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:kB,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:IB,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:MB,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:bB,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:yB,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:AB,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:xB,oneof:"message"},{no:22,name:"request_response",kind:"message",T:LB,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:UB,oneof:"message"},{no:24,name:"room_moved",kind:"message",T:PB,oneof:"message"},{no:25,name:"media_sections_requirement",kind:"message",T:qB,oneof:"message"},{no:26,name:"subscribed_audio_codec_update",kind:"message",T:OB,oneof:"message"}]),dy=J.makeMessageType("livekit.SimulcastCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:Va,repeated:!0},{no:5,name:"video_layer_mode",kind:"enum",T:J.getEnumType(LI)}]),yu=J.makeMessageType("livekit.AddTrackRequest",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:J.getEnumType(qi)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:J.getEnumType(Xt)},{no:9,name:"layers",kind:"message",T:Va,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:dy,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:J.getEnumType(rn)},{no:15,name:"stream",kind:"scalar",T:9},{no:16,name:"backup_codec_policy",kind:"enum",T:J.getEnumType(xI)},{no:17,name:"audio_features",kind:"enum",T:J.getEnumType(dn),repeated:!0}]),Vf=J.makeMessageType("livekit.TrickleRequest",()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:J.getEnumType(Vi)},{no:3,name:"final",kind:"scalar",T:8}]),Kf=J.makeMessageType("livekit.MuteTrackRequest",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]),gB=J.makeMessageType("livekit.JoinResponse",()=>[{no:1,name:"room",kind:"message",T:qf},{no:2,name:"participant",kind:"message",T:js},{no:3,name:"other_participants",kind:"message",T:js,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:eO,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:WI},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:KI},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:lf,repeated:!0},{no:15,name:"fast_publish",kind:"scalar",T:8}]),yB=J.makeMessageType("livekit.ReconnectResponse",()=>[{no:1,name:"ice_servers",kind:"message",T:eO,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:WI},{no:3,name:"server_info",kind:"message",T:KI},{no:4,name:"last_message_seq",kind:"scalar",T:13}]),kb=J.makeMessageType("livekit.TrackPublishedResponse",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:zo}]),bB=J.makeMessageType("livekit.TrackUnpublishedResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),Wa=J.makeMessageType("livekit.SessionDescription",()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9},{no:3,name:"id",kind:"scalar",T:13},{no:4,name:"mid_to_track_id",kind:"map",K:9,V:{kind:"scalar",T:9}}]),SB=J.makeMessageType("livekit.ParticipantUpdate",()=>[{no:1,name:"participants",kind:"message",T:js,repeated:!0}]),Hf=J.makeMessageType("livekit.UpdateSubscription",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:VI,repeated:!0}]),XI=J.makeMessageType("livekit.UpdateTrackSettings",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:J.getEnumType(Eb)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]),wb=J.makeMessageType("livekit.UpdateLocalAudioTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:J.getEnumType(dn),repeated:!0}]),QI=J.makeMessageType("livekit.UpdateLocalVideoTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}]),Gf=J.makeMessageType("livekit.LeaveRequest",()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:J.getEnumType(Hi)},{no:3,name:"action",kind:"enum",T:J.getEnumType(nl)},{no:4,name:"regions",kind:"message",T:DB}]),nl=J.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]),ZI=J.makeMessageType("livekit.UpdateVideoLayers",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:Va,repeated:!0}]),Ib=J.makeMessageType("livekit.UpdateParticipantMetadata",()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}]),eO=J.makeMessageType("livekit.ICEServer",()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]),EB=J.makeMessageType("livekit.SpeakersChanged",()=>[{no:1,name:"speakers",kind:"message",T:FI,repeated:!0}]),TB=J.makeMessageType("livekit.RoomUpdate",()=>[{no:1,name:"room",kind:"message",T:qf}]),_B=J.makeMessageType("livekit.ConnectionQualityInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:J.getEnumType(Kc)},{no:3,name:"score",kind:"scalar",T:2}]),CB=J.makeMessageType("livekit.ConnectionQualityUpdate",()=>[{no:1,name:"updates",kind:"message",T:_B,repeated:!0}]),RB=J.makeMessageType("livekit.StreamStateInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:J.getEnumType(uy)}]),kB=J.makeMessageType("livekit.StreamStateUpdate",()=>[{no:1,name:"stream_states",kind:"message",T:RB,repeated:!0}]),Ob=J.makeMessageType("livekit.SubscribedQuality",()=>[{no:1,name:"quality",kind:"enum",T:J.getEnumType(Eb)},{no:2,name:"enabled",kind:"scalar",T:8}]),wB=J.makeMessageType("livekit.SubscribedCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:Ob,repeated:!0}]),IB=J.makeMessageType("livekit.SubscribedQualityUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:Ob,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:wB,repeated:!0}]),OB=J.makeMessageType("livekit.SubscribedAudioCodecUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_audio_codecs",kind:"message",T:vB,repeated:!0}]),tO=J.makeMessageType("livekit.TrackPermission",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}]),nO=J.makeMessageType("livekit.SubscriptionPermission",()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:tO,repeated:!0}]),MB=J.makeMessageType("livekit.SubscriptionPermissionUpdate",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]),PB=J.makeMessageType("livekit.RoomMovedResponse",()=>[{no:1,name:"room",kind:"message",T:qf},{no:2,name:"token",kind:"scalar",T:9},{no:3,name:"participant",kind:"message",T:js},{no:4,name:"other_participants",kind:"message",T:js,repeated:!0}]),Mb=J.makeMessageType("livekit.SyncState",()=>[{no:1,name:"answer",kind:"message",T:Wa},{no:2,name:"subscription",kind:"message",T:Hf},{no:3,name:"publish_tracks",kind:"message",T:kb,repeated:!0},{no:4,name:"data_channels",kind:"message",T:rO,repeated:!0},{no:5,name:"offer",kind:"message",T:Wa},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:!0},{no:7,name:"datachannel_receive_states",kind:"message",T:iO,repeated:!0}]),iO=J.makeMessageType("livekit.DataChannelReceiveState",()=>[{no:1,name:"publisher_sid",kind:"scalar",T:9},{no:2,name:"last_seq",kind:"scalar",T:13}]),rO=J.makeMessageType("livekit.DataChannelInfo",()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:J.getEnumType(Vi)}]),ar=J.makeMessageType("livekit.SimulateScenario",()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:J.getEnumType(mB),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}]),aO=J.makeMessageType("livekit.Ping",()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]),AB=J.makeMessageType("livekit.Pong",()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]),DB=J.makeMessageType("livekit.RegionSettings",()=>[{no:1,name:"regions",kind:"message",T:NB,repeated:!0}]),NB=J.makeMessageType("livekit.RegionInfo",()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]),xB=J.makeMessageType("livekit.SubscriptionResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:J.getEnumType(sB)}]),LB=J.makeMessageType("livekit.RequestResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:J.getEnumType(Pb)},{no:3,name:"message",kind:"scalar",T:9},{no:4,name:"trickle",kind:"message",T:Vf,oneof:"request"},{no:5,name:"add_track",kind:"message",T:yu,oneof:"request"},{no:6,name:"mute",kind:"message",T:Kf,oneof:"request"},{no:7,name:"update_metadata",kind:"message",T:Ib,oneof:"request"},{no:8,name:"update_audio_track",kind:"message",T:wb,oneof:"request"},{no:9,name:"update_video_track",kind:"message",T:QI,oneof:"request"}]),Pb=J.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"},{no:4,name:"QUEUED"},{no:5,name:"UNSUPPORTED_TYPE"},{no:6,name:"UNCLASSIFIED_ERROR"}]),UB=J.makeMessageType("livekit.TrackSubscribed",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),sO=J.makeMessageType("livekit.ConnectionSettings",()=>[{no:1,name:"auto_subscribe",kind:"scalar",T:8},{no:2,name:"adaptive_stream",kind:"scalar",T:8},{no:3,name:"subscriber_allow_pause",kind:"scalar",T:8,opt:!0},{no:4,name:"disable_ice_lite",kind:"scalar",T:8}]),BB=J.makeMessageType("livekit.JoinRequest",()=>[{no:1,name:"client_info",kind:"message",T:GI},{no:2,name:"connection_settings",kind:"message",T:sO},{no:3,name:"metadata",kind:"scalar",T:9},{no:4,name:"participant_attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:5,name:"add_track_requests",kind:"message",T:yu,repeated:!0},{no:6,name:"publisher_offer",kind:"message",T:Wa},{no:7,name:"reconnect",kind:"scalar",T:8},{no:8,name:"reconnect_reason",kind:"enum",T:J.getEnumType(Is)},{no:9,name:"participant_sid",kind:"scalar",T:9},{no:10,name:"sync_state",kind:"message",T:Mb}]),FB=J.makeMessageType("livekit.WrappedJoinRequest",()=>[{no:1,name:"compression",kind:"enum",T:J.getEnumType(jB)},{no:2,name:"join_request",kind:"scalar",T:12}]),jB=J.makeEnum("livekit.WrappedJoinRequest.Compression",[{no:0,name:"NONE"},{no:1,name:"GZIP"}]),qB=J.makeMessageType("livekit.MediaSectionsRequirement",()=>[{no:1,name:"num_audios",kind:"scalar",T:13},{no:2,name:"num_videos",kind:"scalar",T:13}]);function VB(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var Nh={exports:{}},KB=Nh.exports,bR;function HB(){return bR||(bR=1,(function(i){(function(e,t){i.exports?i.exports=t():e.log=t()})(KB,function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],a={},o=null;function c(S,O){var R=S[O];if(typeof R.bind=="function")return R.bind(S);try{return Function.prototype.bind.call(R,S)}catch{return function(){return Function.prototype.apply.apply(R,[S,arguments])}}}function d(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function h(S){return S==="debug"&&(S="log"),typeof console===t?!1:S==="trace"&&n?d:console[S]!==void 0?c(console,S):console.log!==void 0?c(console,"log"):e}function v(){for(var S=this.getLevel(),O=0;O<r.length;O++){var R=r[O];this[R]=O<S?e:this.methodFactory(R,S,this.name)}if(this.log=this.debug,typeof console===t&&S<this.levels.SILENT)return"No console available for logging"}function m(S){return function(){typeof console!==t&&(v.call(this),this[S].apply(this,arguments))}}function y(S,O,R){return h(S)||m.apply(this,arguments)}function E(S,O){var R=this,I,M,C,k="loglevel";typeof S=="string"?k+=":"+S:typeof S=="symbol"&&(k=void 0);function _(K){var Z=(r[K]||"silent").toUpperCase();if(!(typeof window===t||!k)){try{window.localStorage[k]=Z;return}catch{}try{window.document.cookie=encodeURIComponent(k)+"="+Z+";"}catch{}}}function P(){var K;if(!(typeof window===t||!k)){try{K=window.localStorage[k]}catch{}if(typeof K===t)try{var Z=window.document.cookie,be=encodeURIComponent(k),Pe=Z.indexOf(be+"=");Pe!==-1&&(K=/^([^;]+)/.exec(Z.slice(Pe+be.length+1))[1])}catch{}return R.levels[K]===void 0&&(K=void 0),K}}function x(){if(!(typeof window===t||!k)){try{window.localStorage.removeItem(k)}catch{}try{window.document.cookie=encodeURIComponent(k)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function U(K){var Z=K;if(typeof Z=="string"&&R.levels[Z.toUpperCase()]!==void 0&&(Z=R.levels[Z.toUpperCase()]),typeof Z=="number"&&Z>=0&&Z<=R.levels.SILENT)return Z;throw new TypeError("log.setLevel() called with invalid level: "+K)}R.name=S,R.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},R.methodFactory=O||y,R.getLevel=function(){return C??M??I},R.setLevel=function(K,Z){return C=U(K),Z!==!1&&_(C),v.call(R)},R.setDefaultLevel=function(K){M=U(K),P()||R.setLevel(K,!1)},R.resetLevel=function(){C=null,x(),v.call(R)},R.enableAll=function(K){R.setLevel(R.levels.TRACE,K)},R.disableAll=function(K){R.setLevel(R.levels.SILENT,K)},R.rebuild=function(){if(o!==R&&(I=U(o.getLevel())),v.call(R),o===R)for(var K in a)a[K].rebuild()},I=U(o?o.getLevel():"WARN");var j=P();j!=null&&(C=U(j)),v.call(R)}o=new E,o.getLogger=function(O){if(typeof O!="symbol"&&typeof O!="string"||O==="")throw new TypeError("You must supply a name when creating a logger.");var R=a[O];return R||(R=a[O]=new E(O,o.methodFactory)),R};var T=typeof window!==t?window.log:void 0;return o.noConflict=function(){return typeof window!==t&&window.log===o&&(window.log=T),o},o.getLoggers=function(){return a},o.default=o,o})})(Nh)),Nh.exports}var Pu=HB(),bu;(function(i){i[i.trace=0]="trace",i[i.debug=1]="debug",i[i.info=2]="info",i[i.warn=3]="warn",i[i.error=4]="error",i[i.silent=5]="silent"})(bu||(bu={}));var Wi;(function(i){i.Default="livekit",i.Room="livekit-room",i.TokenSource="livekit-token-source",i.Participant="livekit-participant",i.Track="livekit-track",i.Publication="livekit-track-publication",i.Engine="livekit-engine",i.Signal="livekit-signal",i.PCManager="livekit-pc-manager",i.PCTransport="livekit-pc-transport",i.E2EE="lk-e2ee"})(Wi||(Wi={}));let Fe=Pu.getLogger("livekit");const oO=Object.values(Wi).map(i=>Pu.getLogger(i));Fe.setDefaultLevel(bu.info);function Xr(i){const e=Pu.getLogger(i);return e.setDefaultLevel(Fe.getLevel()),e}function Vq(i,e){if(e)Pu.getLogger(e).setLevel(i);else for(const t of oO)t.setLevel(i)}function Kq(i,e){oO.forEach(n=>{const r=n.methodFactory;n.methodFactory=(a,o,c)=>{const d=r(a,o,c),h=bu[a],v=h>=o&&h<bu.silent;return(m,y)=>{y?d(m,y):d(m),v&&i(h,m,y)}},n.setLevel(n.getLevel())})}const GB=Pu.getLogger("lk-e2ee"),xc=7e3,zB=[0,300,4*300,9*300,16*300,xc,xc,xc,xc,xc];class WB{constructor(e){this._retryDelays=e!==void 0?[...e]:zB}nextRetryDelayInMs(e){if(e.retryCount>=this._retryDelays.length)return null;const t=this._retryDelays[e.retryCount];return e.retryCount<=1?t:t+Math.random()*1e3}}function JB(i,e){var t={};for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&e.indexOf(n)<0&&(t[n]=i[n]);if(i!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,n=Object.getOwnPropertySymbols(i);r<n.length;r++)e.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(i,n[r])&&(t[n[r]]=i[n[r]]);return t}function L(i,e,t,n){function r(a){return a instanceof t?a:new t(function(o){o(a)})}return new(t||(t=Promise))(function(a,o){function c(v){try{h(n.next(v))}catch(m){o(m)}}function d(v){try{h(n.throw(v))}catch(m){o(m)}}function h(v){v.done?a(v.value):r(v.value).then(c,d)}h((n=n.apply(i,e||[])).next())})}function SR(i){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&i[e],n=0;if(t)return t.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&n>=i.length&&(i=void 0),{value:i&&i[n++],done:!i}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Hr(i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=i[Symbol.asyncIterator],t;return e?e.call(i):(i=typeof SR=="function"?SR(i):i[Symbol.iterator](),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(a){t[a]=i[a]&&function(o){return new Promise(function(c,d){o=i[a](o),r(c,d,o.done,o.value)})}}function r(a,o,c,d){Promise.resolve(d).then(function(h){a({value:h,done:c})},o)}}var mh={exports:{}},ER;function YB(){if(ER)return mh.exports;ER=1;var i=typeof Reflect=="object"?Reflect:null,e=i&&typeof i.apply=="function"?i.apply:function(k,_,P){return Function.prototype.apply.call(k,_,P)},t;i&&typeof i.ownKeys=="function"?t=i.ownKeys:Object.getOwnPropertySymbols?t=function(k){return Object.getOwnPropertyNames(k).concat(Object.getOwnPropertySymbols(k))}:t=function(k){return Object.getOwnPropertyNames(k)};function n(C){console&&console.warn&&console.warn(C)}var r=Number.isNaN||function(k){return k!==k};function a(){a.init.call(this)}mh.exports=a,mh.exports.once=R,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var o=10;function c(C){if(typeof C!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof C)}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(C){if(typeof C!="number"||C<0||r(C))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+C+".");o=C}}),a.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(k){if(typeof k!="number"||k<0||r(k))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+k+".");return this._maxListeners=k,this};function d(C){return C._maxListeners===void 0?a.defaultMaxListeners:C._maxListeners}a.prototype.getMaxListeners=function(){return d(this)},a.prototype.emit=function(k){for(var _=[],P=1;P<arguments.length;P++)_.push(arguments[P]);var x=k==="error",U=this._events;if(U!==void 0)x=x&&U.error===void 0;else if(!x)return!1;if(x){var j;if(_.length>0&&(j=_[0]),j instanceof Error)throw j;var K=new Error("Unhandled error."+(j?" ("+j.message+")":""));throw K.context=j,K}var Z=U[k];if(Z===void 0)return!1;if(typeof Z=="function")e(Z,this,_);else for(var be=Z.length,Pe=T(Z,be),P=0;P<be;++P)e(Pe[P],this,_);return!0};function h(C,k,_,P){var x,U,j;if(c(_),U=C._events,U===void 0?(U=C._events=Object.create(null),C._eventsCount=0):(U.newListener!==void 0&&(C.emit("newListener",k,_.listener?_.listener:_),U=C._events),j=U[k]),j===void 0)j=U[k]=_,++C._eventsCount;else if(typeof j=="function"?j=U[k]=P?[_,j]:[j,_]:P?j.unshift(_):j.push(_),x=d(C),x>0&&j.length>x&&!j.warned){j.warned=!0;var K=new Error("Possible EventEmitter memory leak detected. "+j.length+" "+String(k)+" listeners added. Use emitter.setMaxListeners() to increase limit");K.name="MaxListenersExceededWarning",K.emitter=C,K.type=k,K.count=j.length,n(K)}return C}a.prototype.addListener=function(k,_){return h(this,k,_,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(k,_){return h(this,k,_,!0)};function v(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function m(C,k,_){var P={fired:!1,wrapFn:void 0,target:C,type:k,listener:_},x=v.bind(P);return x.listener=_,P.wrapFn=x,x}a.prototype.once=function(k,_){return c(_),this.on(k,m(this,k,_)),this},a.prototype.prependOnceListener=function(k,_){return c(_),this.prependListener(k,m(this,k,_)),this},a.prototype.removeListener=function(k,_){var P,x,U,j,K;if(c(_),x=this._events,x===void 0)return this;if(P=x[k],P===void 0)return this;if(P===_||P.listener===_)--this._eventsCount===0?this._events=Object.create(null):(delete x[k],x.removeListener&&this.emit("removeListener",k,P.listener||_));else if(typeof P!="function"){for(U=-1,j=P.length-1;j>=0;j--)if(P[j]===_||P[j].listener===_){K=P[j].listener,U=j;break}if(U<0)return this;U===0?P.shift():S(P,U),P.length===1&&(x[k]=P[0]),x.removeListener!==void 0&&this.emit("removeListener",k,K||_)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(k){var _,P,x;if(P=this._events,P===void 0)return this;if(P.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):P[k]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete P[k]),this;if(arguments.length===0){var U=Object.keys(P),j;for(x=0;x<U.length;++x)j=U[x],j!=="removeListener"&&this.removeAllListeners(j);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(_=P[k],typeof _=="function")this.removeListener(k,_);else if(_!==void 0)for(x=_.length-1;x>=0;x--)this.removeListener(k,_[x]);return this};function y(C,k,_){var P=C._events;if(P===void 0)return[];var x=P[k];return x===void 0?[]:typeof x=="function"?_?[x.listener||x]:[x]:_?O(x):T(x,x.length)}a.prototype.listeners=function(k){return y(this,k,!0)},a.prototype.rawListeners=function(k){return y(this,k,!1)},a.listenerCount=function(C,k){return typeof C.listenerCount=="function"?C.listenerCount(k):E.call(C,k)},a.prototype.listenerCount=E;function E(C){var k=this._events;if(k!==void 0){var _=k[C];if(typeof _=="function")return 1;if(_!==void 0)return _.length}return 0}a.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function T(C,k){for(var _=new Array(k),P=0;P<k;++P)_[P]=C[P];return _}function S(C,k){for(;k+1<C.length;k++)C[k]=C[k+1];C.pop()}function O(C){for(var k=new Array(C.length),_=0;_<k.length;++_)k[_]=C[_].listener||C[_];return k}function R(C,k){return new Promise(function(_,P){function x(j){C.removeListener(k,U),P(j)}function U(){typeof C.removeListener=="function"&&C.removeListener("error",x),_([].slice.call(arguments))}M(C,k,U,{once:!0}),k!=="error"&&I(C,x,{once:!0})})}function I(C,k,_){typeof C.on=="function"&&M(C,"error",k,_)}function M(C,k,_,P){if(typeof C.on=="function")P.once?C.once(k,_):C.on(k,_);else if(typeof C.addEventListener=="function")C.addEventListener(k,function x(U){P.once&&C.removeEventListener(k,x),_(U)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof C)}return mh.exports}var vr=YB();let lO=!0,cO=!0;function Hc(i,e,t){const n=i.match(e);return n&&n.length>=t&&parseFloat(n[t],10)}function zs(i,e,t){if(!i.RTCPeerConnection)return;const n=i.RTCPeerConnection.prototype,r=n.addEventListener;n.addEventListener=function(o,c){if(o!==e)return r.apply(this,arguments);const d=h=>{const v=t(h);v&&(c.handleEvent?c.handleEvent(v):c(v))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(c,d),r.apply(this,[o,d])};const a=n.removeEventListener;n.removeEventListener=function(o,c){if(o!==e||!this._eventMap||!this._eventMap[e])return a.apply(this,arguments);if(!this._eventMap[e].has(c))return a.apply(this,arguments);const d=this._eventMap[e].get(c);return this._eventMap[e].delete(c),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,a.apply(this,[o,d])},Object.defineProperty(n,"on"+e,{get(){return this["_on"+e]},set(o){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),o&&this.addEventListener(e,this["_on"+e]=o)},enumerable:!0,configurable:!0})}function $B(i){return typeof i!="boolean"?new Error("Argument type: "+typeof i+". Please use a boolean."):(lO=i,i?"adapter.js logging disabled":"adapter.js logging enabled")}function XB(i){return typeof i!="boolean"?new Error("Argument type: "+typeof i+". Please use a boolean."):(cO=!i,"adapter.js deprecation warnings "+(i?"disabled":"enabled"))}function uO(){if(typeof window=="object"){if(lO)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function Ab(i,e){cO&&console.warn(i+" is deprecated, please use "+e+" instead.")}function QB(i){const e={browser:null,version:null};if(typeof i>"u"||!i.navigator||!i.navigator.userAgent)return e.browser="Not a browser.",e;const{navigator:t}=i;if(t.userAgentData&&t.userAgentData.brands){const n=t.userAgentData.brands.find(r=>r.brand==="Chromium");if(n)return{browser:"chrome",version:parseInt(n.version,10)}}if(t.mozGetUserMedia)e.browser="firefox",e.version=parseInt(Hc(t.userAgent,/Firefox\/(\d+)\./,1));else if(t.webkitGetUserMedia||i.isSecureContext===!1&&i.webkitRTCPeerConnection)e.browser="chrome",e.version=parseInt(Hc(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2));else if(i.RTCPeerConnection&&t.userAgent.match(/AppleWebKit\/(\d+)\./))e.browser="safari",e.version=parseInt(Hc(t.userAgent,/AppleWebKit\/(\d+)\./,1)),e.supportsUnifiedPlan=i.RTCRtpTransceiver&&"currentDirection"in i.RTCRtpTransceiver.prototype,e._safariVersion=Hc(t.userAgent,/Version\/(\d+(\.?\d+))/,1);else return e.browser="Not a supported browser.",e;return e}function TR(i){return Object.prototype.toString.call(i)==="[object Object]"}function dO(i){return TR(i)?Object.keys(i).reduce(function(e,t){const n=TR(i[t]),r=n?dO(i[t]):i[t],a=n&&!Object.keys(r).length;return r===void 0||a?e:Object.assign(e,{[t]:r})},{}):i}function hy(i,e,t){!e||t.has(e.id)||(t.set(e.id,e),Object.keys(e).forEach(n=>{n.endsWith("Id")?hy(i,i.get(e[n]),t):n.endsWith("Ids")&&e[n].forEach(r=>{hy(i,i.get(r),t)})}))}function _R(i,e,t){const n=t?"outbound-rtp":"inbound-rtp",r=new Map;if(e===null)return r;const a=[];return i.forEach(o=>{o.type==="track"&&o.trackIdentifier===e.id&&a.push(o)}),a.forEach(o=>{i.forEach(c=>{c.type===n&&c.trackId===o.id&&hy(i,c,r)})}),r}const CR=uO;function hO(i,e){const t=i&&i.navigator;if(!t.mediaDevices)return;const n=function(c){if(typeof c!="object"||c.mandatory||c.optional)return c;const d={};return Object.keys(c).forEach(h=>{if(h==="require"||h==="advanced"||h==="mediaSource")return;const v=typeof c[h]=="object"?c[h]:{ideal:c[h]};v.exact!==void 0&&typeof v.exact=="number"&&(v.min=v.max=v.exact);const m=function(y,E){return y?y+E.charAt(0).toUpperCase()+E.slice(1):E==="deviceId"?"sourceId":E};if(v.ideal!==void 0){d.optional=d.optional||[];let y={};typeof v.ideal=="number"?(y[m("min",h)]=v.ideal,d.optional.push(y),y={},y[m("max",h)]=v.ideal,d.optional.push(y)):(y[m("",h)]=v.ideal,d.optional.push(y))}v.exact!==void 0&&typeof v.exact!="number"?(d.mandatory=d.mandatory||{},d.mandatory[m("",h)]=v.exact):["min","max"].forEach(y=>{v[y]!==void 0&&(d.mandatory=d.mandatory||{},d.mandatory[m(y,h)]=v[y])})}),c.advanced&&(d.optional=(d.optional||[]).concat(c.advanced)),d},r=function(c,d){if(e.version>=61)return d(c);if(c=JSON.parse(JSON.stringify(c)),c&&typeof c.audio=="object"){const h=function(v,m,y){m in v&&!(y in v)&&(v[y]=v[m],delete v[m])};c=JSON.parse(JSON.stringify(c)),h(c.audio,"autoGainControl","googAutoGainControl"),h(c.audio,"noiseSuppression","googNoiseSuppression"),c.audio=n(c.audio)}if(c&&typeof c.video=="object"){let h=c.video.facingMode;h=h&&(typeof h=="object"?h:{ideal:h});const v=e.version<66;if(h&&(h.exact==="user"||h.exact==="environment"||h.ideal==="user"||h.ideal==="environment")&&!(t.mediaDevices.getSupportedConstraints&&t.mediaDevices.getSupportedConstraints().facingMode&&!v)){delete c.video.facingMode;let m;if(h.exact==="environment"||h.ideal==="environment"?m=["back","rear"]:(h.exact==="user"||h.ideal==="user")&&(m=["front"]),m)return t.mediaDevices.enumerateDevices().then(y=>{y=y.filter(T=>T.kind==="videoinput");let E=y.find(T=>m.some(S=>T.label.toLowerCase().includes(S)));return!E&&y.length&&m.includes("back")&&(E=y[y.length-1]),E&&(c.video.deviceId=h.exact?{exact:E.deviceId}:{ideal:E.deviceId}),c.video=n(c.video),CR("chrome: "+JSON.stringify(c)),d(c)})}c.video=n(c.video)}return CR("chrome: "+JSON.stringify(c)),d(c)},a=function(c){return e.version>=64?c:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[c.name]||c.name,message:c.message,constraint:c.constraint||c.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},o=function(c,d,h){r(c,v=>{t.webkitGetUserMedia(v,d,m=>{h&&h(a(m))})})};if(t.getUserMedia=o.bind(t),t.mediaDevices.getUserMedia){const c=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(d){return r(d,h=>c(h).then(v=>{if(h.audio&&!v.getAudioTracks().length||h.video&&!v.getVideoTracks().length)throw v.getTracks().forEach(m=>{m.stop()}),new DOMException("","NotFoundError");return v},v=>Promise.reject(a(v))))}}}function fO(i){i.MediaStream=i.MediaStream||i.webkitMediaStream}function vO(i){if(typeof i=="object"&&i.RTCPeerConnection&&!("ontrack"in i.RTCPeerConnection.prototype)){Object.defineProperty(i.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});const e=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=n=>{n.stream.addEventListener("addtrack",r=>{let a;i.RTCPeerConnection.prototype.getReceivers?a=this.getReceivers().find(c=>c.track&&c.track.id===r.track.id):a={track:r.track};const o=new Event("track");o.track=r.track,o.receiver=a,o.transceiver={receiver:a},o.streams=[n.stream],this.dispatchEvent(o)}),n.stream.getTracks().forEach(r=>{let a;i.RTCPeerConnection.prototype.getReceivers?a=this.getReceivers().find(c=>c.track&&c.track.id===r.id):a={track:r};const o=new Event("track");o.track=r,o.receiver=a,o.transceiver={receiver:a},o.streams=[n.stream],this.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else zs(i,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function mO(i){if(typeof i=="object"&&i.RTCPeerConnection&&!("getSenders"in i.RTCPeerConnection.prototype)&&"createDTMFSender"in i.RTCPeerConnection.prototype){const e=function(r,a){return{track:a,get dtmf(){return this._dtmf===void 0&&(a.kind==="audio"?this._dtmf=r.createDTMFSender(a):this._dtmf=null),this._dtmf},_pc:r}};if(!i.RTCPeerConnection.prototype.getSenders){i.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=i.RTCPeerConnection.prototype.addTrack;i.RTCPeerConnection.prototype.addTrack=function(c,d){let h=r.apply(this,arguments);return h||(h=e(this,c),this._senders.push(h)),h};const a=i.RTCPeerConnection.prototype.removeTrack;i.RTCPeerConnection.prototype.removeTrack=function(c){a.apply(this,arguments);const d=this._senders.indexOf(c);d!==-1&&this._senders.splice(d,1)}}const t=i.RTCPeerConnection.prototype.addStream;i.RTCPeerConnection.prototype.addStream=function(a){this._senders=this._senders||[],t.apply(this,[a]),a.getTracks().forEach(o=>{this._senders.push(e(this,o))})};const n=i.RTCPeerConnection.prototype.removeStream;i.RTCPeerConnection.prototype.removeStream=function(a){this._senders=this._senders||[],n.apply(this,[a]),a.getTracks().forEach(o=>{const c=this._senders.find(d=>d.track===o);c&&this._senders.splice(this._senders.indexOf(c),1)})}}else if(typeof i=="object"&&i.RTCPeerConnection&&"getSenders"in i.RTCPeerConnection.prototype&&"createDTMFSender"in i.RTCPeerConnection.prototype&&i.RTCRtpSender&&!("dtmf"in i.RTCRtpSender.prototype)){const e=i.RTCPeerConnection.prototype.getSenders;i.RTCPeerConnection.prototype.getSenders=function(){const n=e.apply(this,[]);return n.forEach(r=>r._pc=this),n},Object.defineProperty(i.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function pO(i){if(!(typeof i=="object"&&i.RTCPeerConnection&&i.RTCRtpSender&&i.RTCRtpReceiver))return;if(!("getStats"in i.RTCRtpSender.prototype)){const t=i.RTCPeerConnection.prototype.getSenders;t&&(i.RTCPeerConnection.prototype.getSenders=function(){const a=t.apply(this,[]);return a.forEach(o=>o._pc=this),a});const n=i.RTCPeerConnection.prototype.addTrack;n&&(i.RTCPeerConnection.prototype.addTrack=function(){const a=n.apply(this,arguments);return a._pc=this,a}),i.RTCRtpSender.prototype.getStats=function(){const a=this;return this._pc.getStats().then(o=>_R(o,a.track,!0))}}if(!("getStats"in i.RTCRtpReceiver.prototype)){const t=i.RTCPeerConnection.prototype.getReceivers;t&&(i.RTCPeerConnection.prototype.getReceivers=function(){const r=t.apply(this,[]);return r.forEach(a=>a._pc=this),r}),zs(i,"track",n=>(n.receiver._pc=n.srcElement,n)),i.RTCRtpReceiver.prototype.getStats=function(){const r=this;return this._pc.getStats().then(a=>_R(a,r.track,!1))}}if(!("getStats"in i.RTCRtpSender.prototype&&"getStats"in i.RTCRtpReceiver.prototype))return;const e=i.RTCPeerConnection.prototype.getStats;i.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof i.MediaStreamTrack){const n=arguments[0];let r,a,o;return this.getSenders().forEach(c=>{c.track===n&&(r?o=!0:r=c)}),this.getReceivers().forEach(c=>(c.track===n&&(a?o=!0:a=c),c.track===n)),o||r&&a?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():a?a.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function gO(i){i.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(o=>this._shimmedLocalStreams[o][0])};const e=i.RTCPeerConnection.prototype.addTrack;i.RTCPeerConnection.prototype.addTrack=function(o,c){if(!c)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const d=e.apply(this,arguments);return this._shimmedLocalStreams[c.id]?this._shimmedLocalStreams[c.id].indexOf(d)===-1&&this._shimmedLocalStreams[c.id].push(d):this._shimmedLocalStreams[c.id]=[c,d],d};const t=i.RTCPeerConnection.prototype.addStream;i.RTCPeerConnection.prototype.addStream=function(o){this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(h=>{if(this.getSenders().find(m=>m.track===h))throw new DOMException("Track already exists.","InvalidAccessError")});const c=this.getSenders();t.apply(this,arguments);const d=this.getSenders().filter(h=>c.indexOf(h)===-1);this._shimmedLocalStreams[o.id]=[o].concat(d)};const n=i.RTCPeerConnection.prototype.removeStream;i.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],n.apply(this,arguments)};const r=i.RTCPeerConnection.prototype.removeTrack;i.RTCPeerConnection.prototype.removeTrack=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(c=>{const d=this._shimmedLocalStreams[c].indexOf(o);d!==-1&&this._shimmedLocalStreams[c].splice(d,1),this._shimmedLocalStreams[c].length===1&&delete this._shimmedLocalStreams[c]}),r.apply(this,arguments)}}function yO(i,e){if(!i.RTCPeerConnection)return;if(i.RTCPeerConnection.prototype.addTrack&&e.version>=65)return gO(i);const t=i.RTCPeerConnection.prototype.getLocalStreams;i.RTCPeerConnection.prototype.getLocalStreams=function(){const v=t.apply(this);return this._reverseStreams=this._reverseStreams||{},v.map(m=>this._reverseStreams[m.id])};const n=i.RTCPeerConnection.prototype.addStream;i.RTCPeerConnection.prototype.addStream=function(v){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},v.getTracks().forEach(m=>{if(this.getSenders().find(E=>E.track===m))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[v.id]){const m=new i.MediaStream(v.getTracks());this._streams[v.id]=m,this._reverseStreams[m.id]=v,v=m}n.apply(this,[v])};const r=i.RTCPeerConnection.prototype.removeStream;i.RTCPeerConnection.prototype.removeStream=function(v){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[v.id]||v]),delete this._reverseStreams[this._streams[v.id]?this._streams[v.id].id:v.id],delete this._streams[v.id]},i.RTCPeerConnection.prototype.addTrack=function(v,m){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const y=[].slice.call(arguments,1);if(y.length!==1||!y[0].getTracks().find(S=>S===v))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(S=>S.track===v))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const T=this._streams[m.id];if(T)T.addTrack(v),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const S=new i.MediaStream([v]);this._streams[m.id]=S,this._reverseStreams[S.id]=m,this.addStream(S)}return this.getSenders().find(S=>S.track===v)};function a(h,v){let m=v.sdp;return Object.keys(h._reverseStreams||[]).forEach(y=>{const E=h._reverseStreams[y],T=h._streams[E.id];m=m.replace(new RegExp(T.id,"g"),E.id)}),new RTCSessionDescription({type:v.type,sdp:m})}function o(h,v){let m=v.sdp;return Object.keys(h._reverseStreams||[]).forEach(y=>{const E=h._reverseStreams[y],T=h._streams[E.id];m=m.replace(new RegExp(E.id,"g"),T.id)}),new RTCSessionDescription({type:v.type,sdp:m})}["createOffer","createAnswer"].forEach(function(h){const v=i.RTCPeerConnection.prototype[h],m={[h](){const y=arguments;return arguments.length&&typeof arguments[0]=="function"?v.apply(this,[T=>{const S=a(this,T);y[0].apply(null,[S])},T=>{y[1]&&y[1].apply(null,T)},arguments[2]]):v.apply(this,arguments).then(T=>a(this,T))}};i.RTCPeerConnection.prototype[h]=m[h]});const c=i.RTCPeerConnection.prototype.setLocalDescription;i.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?c.apply(this,arguments):(arguments[0]=o(this,arguments[0]),c.apply(this,arguments))};const d=Object.getOwnPropertyDescriptor(i.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(i.RTCPeerConnection.prototype,"localDescription",{get(){const h=d.get.apply(this);return h.type===""?h:a(this,h)}}),i.RTCPeerConnection.prototype.removeTrack=function(v){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!v._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(v._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let y;Object.keys(this._streams).forEach(E=>{this._streams[E].getTracks().find(S=>v.track===S)&&(y=this._streams[E])}),y&&(y.getTracks().length===1?this.removeStream(this._reverseStreams[y.id]):y.removeTrack(v.track),this.dispatchEvent(new Event("negotiationneeded")))}}function fy(i,e){!i.RTCPeerConnection&&i.webkitRTCPeerConnection&&(i.RTCPeerConnection=i.webkitRTCPeerConnection),i.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const n=i.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new(t==="addIceCandidate"?i.RTCIceCandidate:i.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};i.RTCPeerConnection.prototype[t]=r[t]})}function bO(i,e){zs(i,"negotiationneeded",t=>{const n=t.target;if(!((e.version<72||n.getConfiguration&&n.getConfiguration().sdpSemantics==="plan-b")&&n.signalingState!=="stable"))return t})}var RR=Object.freeze({__proto__:null,fixNegotiationNeeded:bO,shimAddTrackRemoveTrack:yO,shimAddTrackRemoveTrackWithNative:gO,shimGetSendersWithDtmf:mO,shimGetUserMedia:hO,shimMediaStream:fO,shimOnTrack:vO,shimPeerConnection:fy,shimSenderReceiverGetStats:pO});function SO(i,e){const t=i&&i.navigator,n=i&&i.MediaStreamTrack;if(t.getUserMedia=function(r,a,o){Ab("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),t.mediaDevices.getUserMedia(r).then(a,o)},!(e.version>55&&"autoGainControl"in t.mediaDevices.getSupportedConstraints())){const r=function(o,c,d){c in o&&!(d in o)&&(o[d]=o[c],delete o[c])},a=t.mediaDevices.getUserMedia.bind(t.mediaDevices);if(t.mediaDevices.getUserMedia=function(o){return typeof o=="object"&&typeof o.audio=="object"&&(o=JSON.parse(JSON.stringify(o)),r(o.audio,"autoGainControl","mozAutoGainControl"),r(o.audio,"noiseSuppression","mozNoiseSuppression")),a(o)},n&&n.prototype.getSettings){const o=n.prototype.getSettings;n.prototype.getSettings=function(){const c=o.apply(this,arguments);return r(c,"mozAutoGainControl","autoGainControl"),r(c,"mozNoiseSuppression","noiseSuppression"),c}}if(n&&n.prototype.applyConstraints){const o=n.prototype.applyConstraints;n.prototype.applyConstraints=function(c){return this.kind==="audio"&&typeof c=="object"&&(c=JSON.parse(JSON.stringify(c)),r(c,"autoGainControl","mozAutoGainControl"),r(c,"noiseSuppression","mozNoiseSuppression")),o.apply(this,[c])}}}}function ZB(i,e){i.navigator.mediaDevices&&"getDisplayMedia"in i.navigator.mediaDevices||i.navigator.mediaDevices&&(i.navigator.mediaDevices.getDisplayMedia=function(n){if(!(n&&n.video)){const r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,Promise.reject(r)}return n.video===!0?n.video={mediaSource:e}:n.video.mediaSource=e,i.navigator.mediaDevices.getUserMedia(n)})}function EO(i){typeof i=="object"&&i.RTCTrackEvent&&"receiver"in i.RTCTrackEvent.prototype&&!("transceiver"in i.RTCTrackEvent.prototype)&&Object.defineProperty(i.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function vy(i,e){if(typeof i!="object"||!(i.RTCPeerConnection||i.mozRTCPeerConnection))return;!i.RTCPeerConnection&&i.mozRTCPeerConnection&&(i.RTCPeerConnection=i.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){const a=i.RTCPeerConnection.prototype[r],o={[r](){return arguments[0]=new(r==="addIceCandidate"?i.RTCIceCandidate:i.RTCSessionDescription)(arguments[0]),a.apply(this,arguments)}};i.RTCPeerConnection.prototype[r]=o[r]});const t={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=i.RTCPeerConnection.prototype.getStats;i.RTCPeerConnection.prototype.getStats=function(){const[a,o,c]=arguments;return n.apply(this,[a||null]).then(d=>{if(e.version<53&&!o)try{d.forEach(h=>{h.type=t[h.type]||h.type})}catch(h){if(h.name!=="TypeError")throw h;d.forEach((v,m)=>{d.set(m,Object.assign({},v,{type:t[v.type]||v.type}))})}return d}).then(o,c)}}function TO(i){if(!(typeof i=="object"&&i.RTCPeerConnection&&i.RTCRtpSender)||i.RTCRtpSender&&"getStats"in i.RTCRtpSender.prototype)return;const e=i.RTCPeerConnection.prototype.getSenders;e&&(i.RTCPeerConnection.prototype.getSenders=function(){const r=e.apply(this,[]);return r.forEach(a=>a._pc=this),r});const t=i.RTCPeerConnection.prototype.addTrack;t&&(i.RTCPeerConnection.prototype.addTrack=function(){const r=t.apply(this,arguments);return r._pc=this,r}),i.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function _O(i){if(!(typeof i=="object"&&i.RTCPeerConnection&&i.RTCRtpSender)||i.RTCRtpSender&&"getStats"in i.RTCRtpReceiver.prototype)return;const e=i.RTCPeerConnection.prototype.getReceivers;e&&(i.RTCPeerConnection.prototype.getReceivers=function(){const n=e.apply(this,[]);return n.forEach(r=>r._pc=this),n}),zs(i,"track",t=>(t.receiver._pc=t.srcElement,t)),i.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function CO(i){!i.RTCPeerConnection||"removeStream"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.removeStream=function(t){Ab("removeStream","removeTrack"),this.getSenders().forEach(n=>{n.track&&t.getTracks().includes(n.track)&&this.removeTrack(n)})})}function RO(i){i.DataChannel&&!i.RTCDataChannel&&(i.RTCDataChannel=i.DataChannel)}function kO(i){if(!(typeof i=="object"&&i.RTCPeerConnection))return;const e=i.RTCPeerConnection.prototype.addTransceiver;e&&(i.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let n=arguments[1]&&arguments[1].sendEncodings;n===void 0&&(n=[]),n=[...n];const r=n.length>0;r&&n.forEach(o=>{if("rid"in o&&!/^[a-z0-9]{0,16}$/i.test(o.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in o&&!(parseFloat(o.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in o&&!(parseFloat(o.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const a=e.apply(this,arguments);if(r){const{sender:o}=a,c=o.getParameters();(!("encodings"in c)||c.encodings.length===1&&Object.keys(c.encodings[0]).length===0)&&(c.encodings=n,o.sendEncodings=n,this.setParametersPromises.push(o.setParameters(c).then(()=>{delete o.sendEncodings}).catch(()=>{delete o.sendEncodings})))}return a})}function wO(i){if(!(typeof i=="object"&&i.RTCRtpSender))return;const e=i.RTCRtpSender.prototype.getParameters;e&&(i.RTCRtpSender.prototype.getParameters=function(){const n=e.apply(this,arguments);return"encodings"in n||(n.encodings=[].concat(this.sendEncodings||[{}])),n})}function IO(i){if(!(typeof i=="object"&&i.RTCPeerConnection))return;const e=i.RTCPeerConnection.prototype.createOffer;i.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function OO(i){if(!(typeof i=="object"&&i.RTCPeerConnection))return;const e=i.RTCPeerConnection.prototype.createAnswer;i.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var kR=Object.freeze({__proto__:null,shimAddTransceiver:kO,shimCreateAnswer:OO,shimCreateOffer:IO,shimGetDisplayMedia:ZB,shimGetParameters:wO,shimGetUserMedia:SO,shimOnTrack:EO,shimPeerConnection:vy,shimRTCDataChannel:RO,shimReceiverGetStats:_O,shimRemoveStream:CO,shimSenderGetStats:TO});function MO(i){if(!(typeof i!="object"||!i.RTCPeerConnection)){if("getLocalStreams"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in i.RTCPeerConnection.prototype)){const e=i.RTCPeerConnection.prototype.addTrack;i.RTCPeerConnection.prototype.addStream=function(n){this._localStreams||(this._localStreams=[]),this._localStreams.includes(n)||this._localStreams.push(n),n.getAudioTracks().forEach(r=>e.call(this,r,n)),n.getVideoTracks().forEach(r=>e.call(this,r,n))},i.RTCPeerConnection.prototype.addTrack=function(n){for(var r=arguments.length,a=new Array(r>1?r-1:0),o=1;o<r;o++)a[o-1]=arguments[o];return a&&a.forEach(c=>{this._localStreams?this._localStreams.includes(c)||this._localStreams.push(c):this._localStreams=[c]}),e.apply(this,arguments)}}"removeStream"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const n=this._localStreams.indexOf(t);if(n===-1)return;this._localStreams.splice(n,1);const r=t.getTracks();this.getSenders().forEach(a=>{r.includes(a.track)&&this.removeTrack(a)})})}}function PO(i){if(!(typeof i!="object"||!i.RTCPeerConnection)&&("getRemoteStreams"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in i.RTCPeerConnection.prototype))){Object.defineProperty(i.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=n=>{n.streams.forEach(r=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(r))return;this._remoteStreams.push(r);const a=new Event("addstream");a.stream=r,this.dispatchEvent(a)})})}});const e=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(){const n=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(a=>{if(n._remoteStreams||(n._remoteStreams=[]),n._remoteStreams.indexOf(a)>=0)return;n._remoteStreams.push(a);const o=new Event("addstream");o.stream=a,n.dispatchEvent(o)})}),e.apply(n,arguments)}}}function AO(i){if(typeof i!="object"||!i.RTCPeerConnection)return;const e=i.RTCPeerConnection.prototype,t=e.createOffer,n=e.createAnswer,r=e.setLocalDescription,a=e.setRemoteDescription,o=e.addIceCandidate;e.createOffer=function(h,v){const m=arguments.length>=2?arguments[2]:arguments[0],y=t.apply(this,[m]);return v?(y.then(h,v),Promise.resolve()):y},e.createAnswer=function(h,v){const m=arguments.length>=2?arguments[2]:arguments[0],y=n.apply(this,[m]);return v?(y.then(h,v),Promise.resolve()):y};let c=function(d,h,v){const m=r.apply(this,[d]);return v?(m.then(h,v),Promise.resolve()):m};e.setLocalDescription=c,c=function(d,h,v){const m=a.apply(this,[d]);return v?(m.then(h,v),Promise.resolve()):m},e.setRemoteDescription=c,c=function(d,h,v){const m=o.apply(this,[d]);return v?(m.then(h,v),Promise.resolve()):m},e.addIceCandidate=c}function DO(i){const e=i&&i.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const t=e.mediaDevices,n=t.getUserMedia.bind(t);e.mediaDevices.getUserMedia=r=>n(NO(r))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(n,r,a){e.mediaDevices.getUserMedia(n).then(r,a)}).bind(e))}function NO(i){return i&&i.video!==void 0?Object.assign({},i,{video:dO(i.video)}):i}function xO(i){if(!i.RTCPeerConnection)return;const e=i.RTCPeerConnection;i.RTCPeerConnection=function(n,r){if(n&&n.iceServers){const a=[];for(let o=0;o<n.iceServers.length;o++){let c=n.iceServers[o];c.urls===void 0&&c.url?(Ab("RTCIceServer.url","RTCIceServer.urls"),c=JSON.parse(JSON.stringify(c)),c.urls=c.url,delete c.url,a.push(c)):a.push(n.iceServers[o])}n.iceServers=a}return new e(n,r)},i.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(i.RTCPeerConnection,"generateCertificate",{get(){return e.generateCertificate}})}function LO(i){typeof i=="object"&&i.RTCTrackEvent&&"receiver"in i.RTCTrackEvent.prototype&&!("transceiver"in i.RTCTrackEvent.prototype)&&Object.defineProperty(i.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function UO(i){const e=i.RTCPeerConnection.prototype.createOffer;i.RTCPeerConnection.prototype.createOffer=function(n){if(n){typeof n.offerToReceiveAudio<"u"&&(n.offerToReceiveAudio=!!n.offerToReceiveAudio);const r=this.getTransceivers().find(o=>o.receiver.track.kind==="audio");n.offerToReceiveAudio===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):n.offerToReceiveAudio===!0&&!r&&this.addTransceiver("audio",{direction:"recvonly"}),typeof n.offerToReceiveVideo<"u"&&(n.offerToReceiveVideo=!!n.offerToReceiveVideo);const a=this.getTransceivers().find(o=>o.receiver.track.kind==="video");n.offerToReceiveVideo===!1&&a?a.direction==="sendrecv"?a.setDirection?a.setDirection("sendonly"):a.direction="sendonly":a.direction==="recvonly"&&(a.setDirection?a.setDirection("inactive"):a.direction="inactive"):n.offerToReceiveVideo===!0&&!a&&this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function BO(i){typeof i!="object"||i.AudioContext||(i.AudioContext=i.webkitAudioContext)}var wR=Object.freeze({__proto__:null,shimAudioContext:BO,shimCallbacksAPI:AO,shimConstraints:NO,shimCreateOfferLegacy:UO,shimGetUserMedia:DO,shimLocalStreamsAPI:MO,shimRTCIceServerUrls:xO,shimRemoteStreamsAPI:PO,shimTrackEventTransceiver:LO}),Yp={exports:{}},IR;function eF(){return IR||(IR=1,(function(i){const e={};e.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},e.localCName=e.generateIdentifier(),e.splitLines=function(t){return t.trim().split(`
`).map(n=>n.trim())},e.splitSections=function(t){return t.split(`
m=`).map((r,a)=>(a>0?"m="+r:r).trim()+`\r
`)},e.getDescription=function(t){const n=e.splitSections(t);return n&&n[0]},e.getMediaSections=function(t){const n=e.splitSections(t);return n.shift(),n},e.matchPrefix=function(t,n){return e.splitLines(t).filter(r=>r.indexOf(n)===0)},e.parseCandidate=function(t){let n;t.indexOf("a=candidate:")===0?n=t.substring(12).split(" "):n=t.substring(10).split(" ");const r={foundation:n[0],component:{1:"rtp",2:"rtcp"}[n[1]]||n[1],protocol:n[2].toLowerCase(),priority:parseInt(n[3],10),ip:n[4],address:n[4],port:parseInt(n[5],10),type:n[7]};for(let a=8;a<n.length;a+=2)switch(n[a]){case"raddr":r.relatedAddress=n[a+1];break;case"rport":r.relatedPort=parseInt(n[a+1],10);break;case"tcptype":r.tcpType=n[a+1];break;case"ufrag":r.ufrag=n[a+1],r.usernameFragment=n[a+1];break;default:r[n[a]]===void 0&&(r[n[a]]=n[a+1]);break}return r},e.writeCandidate=function(t){const n=[];n.push(t.foundation);const r=t.component;r==="rtp"?n.push(1):r==="rtcp"?n.push(2):n.push(r),n.push(t.protocol.toUpperCase()),n.push(t.priority),n.push(t.address||t.ip),n.push(t.port);const a=t.type;return n.push("typ"),n.push(a),a!=="host"&&t.relatedAddress&&t.relatedPort&&(n.push("raddr"),n.push(t.relatedAddress),n.push("rport"),n.push(t.relatedPort)),t.tcpType&&t.protocol.toLowerCase()==="tcp"&&(n.push("tcptype"),n.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(n.push("ufrag"),n.push(t.usernameFragment||t.ufrag)),"candidate:"+n.join(" ")},e.parseIceOptions=function(t){return t.substring(14).split(" ")},e.parseRtpMap=function(t){let n=t.substring(9).split(" ");const r={payloadType:parseInt(n.shift(),10)};return n=n[0].split("/"),r.name=n[0],r.clockRate=parseInt(n[1],10),r.channels=n.length===3?parseInt(n[2],10):1,r.numChannels=r.channels,r},e.writeRtpMap=function(t){let n=t.payloadType;t.preferredPayloadType!==void 0&&(n=t.preferredPayloadType);const r=t.channels||t.numChannels||1;return"a=rtpmap:"+n+" "+t.name+"/"+t.clockRate+(r!==1?"/"+r:"")+`\r
`},e.parseExtmap=function(t){const n=t.substring(9).split(" ");return{id:parseInt(n[0],10),direction:n[0].indexOf("/")>0?n[0].split("/")[1]:"sendrecv",uri:n[1],attributes:n.slice(2).join(" ")}},e.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&t.direction!=="sendrecv"?"/"+t.direction:"")+" "+t.uri+(t.attributes?" "+t.attributes:"")+`\r
`},e.parseFmtp=function(t){const n={};let r;const a=t.substring(t.indexOf(" ")+1).split(";");for(let o=0;o<a.length;o++)r=a[o].trim().split("="),n[r[0].trim()]=r[1];return n},e.writeFmtp=function(t){let n="",r=t.payloadType;if(t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){const a=[];Object.keys(t.parameters).forEach(o=>{t.parameters[o]!==void 0?a.push(o+"="+t.parameters[o]):a.push(o)}),n+="a=fmtp:"+r+" "+a.join(";")+`\r
`}return n},e.parseRtcpFb=function(t){const n=t.substring(t.indexOf(" ")+1).split(" ");return{type:n.shift(),parameter:n.join(" ")}},e.writeRtcpFb=function(t){let n="",r=t.payloadType;return t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach(a=>{n+="a=rtcp-fb:"+r+" "+a.type+(a.parameter&&a.parameter.length?" "+a.parameter:"")+`\r
`}),n},e.parseSsrcMedia=function(t){const n=t.indexOf(" "),r={ssrc:parseInt(t.substring(7,n),10)},a=t.indexOf(":",n);return a>-1?(r.attribute=t.substring(n+1,a),r.value=t.substring(a+1)):r.attribute=t.substring(n+1),r},e.parseSsrcGroup=function(t){const n=t.substring(13).split(" ");return{semantics:n.shift(),ssrcs:n.map(r=>parseInt(r,10))}},e.getMid=function(t){const n=e.matchPrefix(t,"a=mid:")[0];if(n)return n.substring(6)},e.parseFingerprint=function(t){const n=t.substring(14).split(" ");return{algorithm:n[0].toLowerCase(),value:n[1].toUpperCase()}},e.getDtlsParameters=function(t,n){return{role:"auto",fingerprints:e.matchPrefix(t+n,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(t,n){let r="a=setup:"+n+`\r
`;return t.fingerprints.forEach(a=>{r+="a=fingerprint:"+a.algorithm+" "+a.value+`\r
`}),r},e.parseCryptoLine=function(t){const n=t.substring(9).split(" ");return{tag:parseInt(n[0],10),cryptoSuite:n[1],keyParams:n[2],sessionParams:n.slice(3)}},e.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+(typeof t.keyParams=="object"?e.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(t){if(t.indexOf("inline:")!==0)return null;const n=t.substring(7).split("|");return{keyMethod:"inline",keySalt:n[0],lifeTime:n[1],mkiValue:n[2]?n[2].split(":")[0]:void 0,mkiLength:n[2]?n[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")},e.getCryptoParameters=function(t,n){return e.matchPrefix(t+n,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(t,n){const r=e.matchPrefix(t+n,"a=ice-ufrag:")[0],a=e.matchPrefix(t+n,"a=ice-pwd:")[0];return r&&a?{usernameFragment:r.substring(12),password:a.substring(10)}:null},e.writeIceParameters=function(t){let n="a=ice-ufrag:"+t.usernameFragment+`\r
a=ice-pwd:`+t.password+`\r
`;return t.iceLite&&(n+=`a=ice-lite\r
`),n},e.parseRtpParameters=function(t){const n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},a=e.splitLines(t)[0].split(" ");n.profile=a[2];for(let c=3;c<a.length;c++){const d=a[c],h=e.matchPrefix(t,"a=rtpmap:"+d+" ")[0];if(h){const v=e.parseRtpMap(h),m=e.matchPrefix(t,"a=fmtp:"+d+" ");switch(v.parameters=m.length?e.parseFmtp(m[0]):{},v.rtcpFeedback=e.matchPrefix(t,"a=rtcp-fb:"+d+" ").map(e.parseRtcpFb),n.codecs.push(v),v.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(v.name.toUpperCase());break}}}e.matchPrefix(t,"a=extmap:").forEach(c=>{n.headerExtensions.push(e.parseExtmap(c))});const o=e.matchPrefix(t,"a=rtcp-fb:* ").map(e.parseRtcpFb);return n.codecs.forEach(c=>{o.forEach(d=>{c.rtcpFeedback.find(v=>v.type===d.type&&v.parameter===d.parameter)||c.rtcpFeedback.push(d)})}),n},e.writeRtpDescription=function(t,n){let r="";r+="m="+t+" ",r+=n.codecs.length>0?"9":"0",r+=" "+(n.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=n.codecs.map(o=>o.preferredPayloadType!==void 0?o.preferredPayloadType:o.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,n.codecs.forEach(o=>{r+=e.writeRtpMap(o),r+=e.writeFmtp(o),r+=e.writeRtcpFb(o)});let a=0;return n.codecs.forEach(o=>{o.maxptime>a&&(a=o.maxptime)}),a>0&&(r+="a=maxptime:"+a+`\r
`),n.headerExtensions&&n.headerExtensions.forEach(o=>{r+=e.writeExtmap(o)}),r},e.parseRtpEncodingParameters=function(t){const n=[],r=e.parseRtpParameters(t),a=r.fecMechanisms.indexOf("RED")!==-1,o=r.fecMechanisms.indexOf("ULPFEC")!==-1,c=e.matchPrefix(t,"a=ssrc:").map(y=>e.parseSsrcMedia(y)).filter(y=>y.attribute==="cname"),d=c.length>0&&c[0].ssrc;let h;const v=e.matchPrefix(t,"a=ssrc-group:FID").map(y=>y.substring(17).split(" ").map(T=>parseInt(T,10)));v.length>0&&v[0].length>1&&v[0][0]===d&&(h=v[0][1]),r.codecs.forEach(y=>{if(y.name.toUpperCase()==="RTX"&&y.parameters.apt){let E={ssrc:d,codecPayloadType:parseInt(y.parameters.apt,10)};d&&h&&(E.rtx={ssrc:h}),n.push(E),a&&(E=JSON.parse(JSON.stringify(E)),E.fec={ssrc:d,mechanism:o?"red+ulpfec":"red"},n.push(E))}}),n.length===0&&d&&n.push({ssrc:d});let m=e.matchPrefix(t,"b=");return m.length&&(m[0].indexOf("b=TIAS:")===0?m=parseInt(m[0].substring(7),10):m[0].indexOf("b=AS:")===0?m=parseInt(m[0].substring(5),10)*1e3*.95-2e3*8:m=void 0,n.forEach(y=>{y.maxBitrate=m})),n},e.parseRtcpParameters=function(t){const n={},r=e.matchPrefix(t,"a=ssrc:").map(c=>e.parseSsrcMedia(c)).filter(c=>c.attribute==="cname")[0];r&&(n.cname=r.value,n.ssrc=r.ssrc);const a=e.matchPrefix(t,"a=rtcp-rsize");n.reducedSize=a.length>0,n.compound=a.length===0;const o=e.matchPrefix(t,"a=rtcp-mux");return n.mux=o.length>0,n},e.writeRtcpParameters=function(t){let n="";return t.reducedSize&&(n+=`a=rtcp-rsize\r
`),t.mux&&(n+=`a=rtcp-mux\r
`),t.ssrc!==void 0&&t.cname&&(n+="a=ssrc:"+t.ssrc+" cname:"+t.cname+`\r
`),n},e.parseMsid=function(t){let n;const r=e.matchPrefix(t,"a=msid:");if(r.length===1)return n=r[0].substring(7).split(" "),{stream:n[0],track:n[1]};const a=e.matchPrefix(t,"a=ssrc:").map(o=>e.parseSsrcMedia(o)).filter(o=>o.attribute==="msid");if(a.length>0)return n=a[0].value.split(" "),{stream:n[0],track:n[1]}},e.parseSctpDescription=function(t){const n=e.parseMLine(t),r=e.matchPrefix(t,"a=max-message-size:");let a;r.length>0&&(a=parseInt(r[0].substring(19),10)),isNaN(a)&&(a=65536);const o=e.matchPrefix(t,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:n.fmt,maxMessageSize:a};const c=e.matchPrefix(t,"a=sctpmap:");if(c.length>0){const d=c[0].substring(10).split(" ");return{port:parseInt(d[0],10),protocol:d[1],maxMessageSize:a}}},e.writeSctpDescription=function(t,n){let r=[];return t.protocol!=="DTLS/SCTP"?r=["m="+t.kind+" 9 "+t.protocol+" "+n.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+n.port+`\r
`]:r=["m="+t.kind+" 9 "+t.protocol+" "+n.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+n.port+" "+n.protocol+` 65535\r
`],n.maxMessageSize!==void 0&&r.push("a=max-message-size:"+n.maxMessageSize+`\r
`),r.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(t,n,r){let a;const o=n!==void 0?n:2;return t?a=t:a=e.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+a+" "+o+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(t,n){const r=e.splitLines(t);for(let a=0;a<r.length;a++)switch(r[a]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[a].substring(2)}return n?e.getDirection(n):"sendrecv"},e.getKind=function(t){return e.splitLines(t)[0].split(" ")[0].substring(2)},e.isRejected=function(t){return t.split(" ",2)[1]==="0"},e.parseMLine=function(t){const r=e.splitLines(t)[0].substring(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},e.parseOLine=function(t){const r=e.matchPrefix(t,"o=")[0].substring(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},e.isValidSDP=function(t){if(typeof t!="string"||t.length===0)return!1;const n=e.splitLines(t);for(let r=0;r<n.length;r++)if(n[r].length<2||n[r].charAt(1)!=="=")return!1;return!0},i.exports=e})(Yp)),Yp.exports}var FO=eF(),il=VB(FO),tF=uU({__proto__:null,default:il},[FO]);function xh(i){if(!i.RTCIceCandidate||i.RTCIceCandidate&&"foundation"in i.RTCIceCandidate.prototype)return;const e=i.RTCIceCandidate;i.RTCIceCandidate=function(n){if(typeof n=="object"&&n.candidate&&n.candidate.indexOf("a=")===0&&(n=JSON.parse(JSON.stringify(n)),n.candidate=n.candidate.substring(2)),n.candidate&&n.candidate.length){const r=new e(n),a=il.parseCandidate(n.candidate);for(const o in a)o in r||Object.defineProperty(r,o,{value:a[o]});return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new e(n)},i.RTCIceCandidate.prototype=e.prototype,zs(i,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new i.RTCIceCandidate(t.candidate),writable:"false"}),t))}function my(i){!i.RTCIceCandidate||i.RTCIceCandidate&&"relayProtocol"in i.RTCIceCandidate.prototype||zs(i,"icecandidate",e=>{if(e.candidate){const t=il.parseCandidate(e.candidate.candidate);t.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e})}function Lh(i,e){if(!i.RTCPeerConnection)return;"sctp"in i.RTCPeerConnection.prototype||Object.defineProperty(i.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const t=function(c){if(!c||!c.sdp)return!1;const d=il.splitSections(c.sdp);return d.shift(),d.some(h=>{const v=il.parseMLine(h);return v&&v.kind==="application"&&v.protocol.indexOf("SCTP")!==-1})},n=function(c){const d=c.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(d===null||d.length<2)return-1;const h=parseInt(d[1],10);return h!==h?-1:h},r=function(c){let d=65536;return e.browser==="firefox"&&(e.version<57?c===-1?d=16384:d=2147483637:e.version<60?d=e.version===57?65535:65536:d=2147483637),d},a=function(c,d){let h=65536;e.browser==="firefox"&&e.version===57&&(h=65535);const v=il.matchPrefix(c.sdp,"a=max-message-size:");return v.length>0?h=parseInt(v[0].substring(19),10):e.browser==="firefox"&&d!==-1&&(h=2147483637),h},o=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:d}=this.getConfiguration();d==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(t(arguments[0])){const d=n(arguments[0]),h=r(d),v=a(arguments[0],d);let m;h===0&&v===0?m=Number.POSITIVE_INFINITY:h===0||v===0?m=Math.max(h,v):m=Math.min(h,v);const y={};Object.defineProperty(y,"maxMessageSize",{get(){return m}}),this._sctp=y}return o.apply(this,arguments)}}function Uh(i){if(!(i.RTCPeerConnection&&"createDataChannel"in i.RTCPeerConnection.prototype))return;function e(n,r){const a=n.send;n.send=function(){const c=arguments[0],d=c.length||c.size||c.byteLength;if(n.readyState==="open"&&r.sctp&&d>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return a.apply(n,arguments)}}const t=i.RTCPeerConnection.prototype.createDataChannel;i.RTCPeerConnection.prototype.createDataChannel=function(){const r=t.apply(this,arguments);return e(r,this),r},zs(i,"datachannel",n=>(e(n.channel,n.target),n))}function py(i){if(!i.RTCPeerConnection||"connectionState"in i.RTCPeerConnection.prototype)return;const e=i.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(t=>{const n=e[t];e[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{const a=r.target;if(a._lastConnectionState!==a.connectionState){a._lastConnectionState=a.connectionState;const o=new Event("connectionstatechange",r);a.dispatchEvent(o)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}})}function gy(i,e){if(!i.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e._safariVersion>=13.1)return;const t=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&r.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const a=r.sdp.split(`
`).filter(o=>o.trim()!=="a=extmap-allow-mixed").join(`
`);i.RTCSessionDescription&&r instanceof i.RTCSessionDescription?arguments[0]=new i.RTCSessionDescription({type:r.type,sdp:a}):r.sdp=a}return t.apply(this,arguments)}}function Bh(i,e){if(!(i.RTCPeerConnection&&i.RTCPeerConnection.prototype))return;const t=i.RTCPeerConnection.prototype.addIceCandidate;!t||t.length===0||(i.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function Fh(i,e){if(!(i.RTCPeerConnection&&i.RTCPeerConnection.prototype))return;const t=i.RTCPeerConnection.prototype.setLocalDescription;!t||t.length===0||(i.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if(typeof r!="object"||r.type&&r.sdp)return t.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer";break}return r.sdp||r.type!=="offer"&&r.type!=="answer"?t.apply(this,[r]):(r.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(o=>t.apply(this,[o]))})}var nF=Object.freeze({__proto__:null,removeExtmapAllowMixed:gy,shimAddIceCandidateNullOrEmpty:Bh,shimConnectionState:py,shimMaxMessageSize:Lh,shimParameterlessSetLocalDescription:Fh,shimRTCIceCandidate:xh,shimRTCIceCandidateRelayProtocol:my,shimSendThrowTypeError:Uh});function iF(){let{window:i}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const t=uO,n=QB(i),r={browserDetails:n,commonShim:nF,extractVersion:Hc,disableLog:$B,disableWarnings:XB,sdp:tF};switch(n.browser){case"chrome":if(!RR||!fy||!e.shimChrome)return t("Chrome shim is not included in this adapter release."),r;if(n.version===null)return t("Chrome shim can not determine version, not shimming."),r;t("adapter.js shimming chrome."),r.browserShim=RR,Bh(i,n),Fh(i),hO(i,n),fO(i),fy(i,n),vO(i),yO(i,n),mO(i),pO(i),bO(i,n),xh(i),my(i),py(i),Lh(i,n),Uh(i),gy(i,n);break;case"firefox":if(!kR||!vy||!e.shimFirefox)return t("Firefox shim is not included in this adapter release."),r;t("adapter.js shimming firefox."),r.browserShim=kR,Bh(i,n),Fh(i),SO(i,n),vy(i,n),EO(i),CO(i),TO(i),_O(i),RO(i),kO(i),wO(i),IO(i),OO(i),xh(i),py(i),Lh(i,n),Uh(i);break;case"safari":if(!wR||!e.shimSafari)return t("Safari shim is not included in this adapter release."),r;t("adapter.js shimming safari."),r.browserShim=wR,Bh(i,n),Fh(i),xO(i),UO(i),AO(i),MO(i),PO(i),LO(i),DO(i),BO(i),xh(i),my(i),Lh(i,n),Uh(i),gy(i,n);break;default:t("Unsupported browser!");break}return r}iF({window:typeof window>"u"?void 0:window});const rF=10,Lc="lk_e2ee",aF="LKFrameEncryptionKey",sF={sharedKey:!1,ratchetSalt:aF,ratchetWindowSize:8,failureTolerance:rF,keyringSize:16};var Ka;(function(i){i.SetKey="setKey",i.RatchetRequest="ratchetRequest",i.KeyRatcheted="keyRatcheted"})(Ka||(Ka={}));var OR;(function(i){i.KeyRatcheted="keyRatcheted"})(OR||(OR={}));var Ba;(function(i){i.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",i.EncryptionError="encryptionError"})(Ba||(Ba={}));var MR;(function(i){i.Error="cryptorError"})(MR||(MR={}));function oF(){return lF()||yy()}function yy(){return typeof window.RTCRtpScriptTransform<"u"}function lF(){return typeof window.RTCRtpSender<"u"&&typeof window.RTCRtpSender.prototype.createEncodedStreams<"u"}function cF(i){return L(this,void 0,void 0,function*(){let e=new TextEncoder;return yield crypto.subtle.importKey("raw",e.encode(i),{name:"PBKDF2"},!1,["deriveBits","deriveKey"])})}function uF(i){return L(this,void 0,void 0,function*(){return yield crypto.subtle.importKey("raw",i,"HKDF",!1,["deriveBits","deriveKey"])})}function dF(i){var e,t,n,r,a;if(((e=i.value)===null||e===void 0?void 0:e.case)!=="sipDtmf"&&((t=i.value)===null||t===void 0?void 0:t.case)!=="metrics"&&((n=i.value)===null||n===void 0?void 0:n.case)!=="speaker"&&((r=i.value)===null||r===void 0?void 0:r.case)!=="transcription"&&((a=i.value)===null||a===void 0?void 0:a.case)!=="encryptedPacket")return new BI({value:i.value})}class hF extends vr.EventEmitter{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.onKeyRatcheted=(t,n,r)=>{Fe.debug("key ratcheted event received",{ratchetResult:t,participantId:n,keyIndex:r})},this.keyInfoMap=new Map,this.options=Object.assign(Object.assign({},sF),e),this.on(Ka.KeyRatcheted,this.onKeyRatcheted)}onSetEncryptionKey(e,t,n){const r={key:e,participantIdentity:t,keyIndex:n};if(!this.options.sharedKey&&!t)throw new Error("participant identity needs to be passed for encryption key if sharedKey option is false");this.keyInfoMap.set("".concat(t??"shared","-").concat(n??0),r),this.emit(Ka.SetKey,r)}getKeys(){return Array.from(this.keyInfoMap.values())}getOptions(){return this.options}ratchetKey(e,t){this.emit(Ka.RatchetRequest,e,t)}}class Hq extends hF{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=Object.assign(Object.assign({},e),{sharedKey:!0,ratchetWindowSize:0,failureTolerance:-1});super(t)}setKey(e){return L(this,void 0,void 0,function*(){const t=typeof e=="string"?yield cF(e):yield uF(e);this.onSetEncryptionKey(t)})}}class Qr extends Error{constructor(e,t){super(t||"an error has occured"),this.name="LiveKitError",this.code=e}}var Le;(function(i){i[i.NotAllowed=0]="NotAllowed",i[i.ServerUnreachable=1]="ServerUnreachable",i[i.InternalError=2]="InternalError",i[i.Cancelled=3]="Cancelled",i[i.LeaveRequest=4]="LeaveRequest",i[i.Timeout=5]="Timeout"})(Le||(Le={}));class Qe extends Qr{constructor(e,t,n,r){super(1,e),this.name="ConnectionError",this.status=n,this.reason=t,this.context=r,this.reasonName=Le[t]}}class Db extends Qr{constructor(e){super(21,e??"device is unsupported"),this.name="DeviceUnsupportedError"}}class Gr extends Qr{constructor(e){super(20,e??"track is invalid"),this.name="TrackInvalidError"}}class fF extends Qr{constructor(e){super(10,e??"unsupported server"),this.name="UnsupportedServer"}}class Zt extends Qr{constructor(e){super(12,e??"unexpected connection state"),this.name="UnexpectedConnectionState"}}class by extends Qr{constructor(e){super(13,e??"unable to negotiate"),this.name="NegotiationError"}}class PR extends Qr{constructor(e,t){super(15,e),this.name="PublishTrackError",this.status=t}}class AR extends Qr{constructor(e,t){super(15,e),this.reason=t,this.reasonName=typeof t=="string"?t:Pb[t]}}var In;(function(i){i[i.AlreadyOpened=0]="AlreadyOpened",i[i.AbnormalEnd=1]="AbnormalEnd",i[i.DecodeFailed=2]="DecodeFailed",i[i.LengthExceeded=3]="LengthExceeded",i[i.Incomplete=4]="Incomplete",i[i.HandlerAlreadyRegistered=7]="HandlerAlreadyRegistered",i[i.EncryptionTypeMismatch=8]="EncryptionTypeMismatch"})(In||(In={}));class Ii extends Qr{constructor(e,t){super(16,e),this.name="DataStreamError",this.reason=t,this.reasonName=In[t]}}var Su;(function(i){i.PermissionDenied="PermissionDenied",i.NotFound="NotFound",i.DeviceInUse="DeviceInUse",i.Other="Other"})(Su||(Su={}));(function(i){function e(t){if(t&&"name"in t)return t.name==="NotFoundError"||t.name==="DevicesNotFoundError"?i.NotFound:t.name==="NotAllowedError"||t.name==="PermissionDeniedError"?i.PermissionDenied:t.name==="NotReadableError"||t.name==="TrackStartError"?i.DeviceInUse:i.Other}i.getFailure=e})(Su||(Su={}));var DR;(function(i){i[i.InvalidKey=0]="InvalidKey",i[i.MissingKey=1]="MissingKey",i[i.InternalError=2]="InternalError"})(DR||(DR={}));var te;(function(i){i.Connected="connected",i.Reconnecting="reconnecting",i.SignalReconnecting="signalReconnecting",i.Reconnected="reconnected",i.Disconnected="disconnected",i.ConnectionStateChanged="connectionStateChanged",i.Moved="moved",i.MediaDevicesChanged="mediaDevicesChanged",i.ParticipantConnected="participantConnected",i.ParticipantDisconnected="participantDisconnected",i.TrackPublished="trackPublished",i.TrackSubscribed="trackSubscribed",i.TrackSubscriptionFailed="trackSubscriptionFailed",i.TrackUnpublished="trackUnpublished",i.TrackUnsubscribed="trackUnsubscribed",i.TrackMuted="trackMuted",i.TrackUnmuted="trackUnmuted",i.LocalTrackPublished="localTrackPublished",i.LocalTrackUnpublished="localTrackUnpublished",i.LocalAudioSilenceDetected="localAudioSilenceDetected",i.ActiveSpeakersChanged="activeSpeakersChanged",i.ParticipantMetadataChanged="participantMetadataChanged",i.ParticipantNameChanged="participantNameChanged",i.ParticipantAttributesChanged="participantAttributesChanged",i.ParticipantActive="participantActive",i.RoomMetadataChanged="roomMetadataChanged",i.DataReceived="dataReceived",i.SipDTMFReceived="sipDTMFReceived",i.TranscriptionReceived="transcriptionReceived",i.ConnectionQualityChanged="connectionQualityChanged",i.TrackStreamStateChanged="trackStreamStateChanged",i.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",i.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",i.AudioPlaybackStatusChanged="audioPlaybackChanged",i.VideoPlaybackStatusChanged="videoPlaybackChanged",i.MediaDevicesError="mediaDevicesError",i.ParticipantPermissionsChanged="participantPermissionsChanged",i.SignalConnected="signalConnected",i.RecordingStatusChanged="recordingStatusChanged",i.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",i.EncryptionError="encryptionError",i.DCBufferStatusChanged="dcBufferStatusChanged",i.ActiveDeviceChanged="activeDeviceChanged",i.ChatMessage="chatMessage",i.LocalTrackSubscribed="localTrackSubscribed",i.MetricsReceived="metricsReceived"})(te||(te={}));var ae;(function(i){i.TrackPublished="trackPublished",i.TrackSubscribed="trackSubscribed",i.TrackSubscriptionFailed="trackSubscriptionFailed",i.TrackUnpublished="trackUnpublished",i.TrackUnsubscribed="trackUnsubscribed",i.TrackMuted="trackMuted",i.TrackUnmuted="trackUnmuted",i.LocalTrackPublished="localTrackPublished",i.LocalTrackUnpublished="localTrackUnpublished",i.LocalTrackCpuConstrained="localTrackCpuConstrained",i.LocalSenderCreated="localSenderCreated",i.ParticipantMetadataChanged="participantMetadataChanged",i.ParticipantNameChanged="participantNameChanged",i.DataReceived="dataReceived",i.SipDTMFReceived="sipDTMFReceived",i.TranscriptionReceived="transcriptionReceived",i.IsSpeakingChanged="isSpeakingChanged",i.ConnectionQualityChanged="connectionQualityChanged",i.TrackStreamStateChanged="trackStreamStateChanged",i.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",i.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",i.TrackCpuConstrained="trackCpuConstrained",i.MediaDevicesError="mediaDevicesError",i.AudioStreamAcquired="audioStreamAcquired",i.ParticipantPermissionsChanged="participantPermissionsChanged",i.PCTrackAdded="pcTrackAdded",i.AttributesChanged="attributesChanged",i.LocalTrackSubscribed="localTrackSubscribed",i.ChatMessage="chatMessage",i.Active="active"})(ae||(ae={}));var fe;(function(i){i.TransportsCreated="transportsCreated",i.Connected="connected",i.Disconnected="disconnected",i.Resuming="resuming",i.Resumed="resumed",i.Restarting="restarting",i.Restarted="restarted",i.SignalResumed="signalResumed",i.SignalRestarted="signalRestarted",i.Closing="closing",i.MediaTrackAdded="mediaTrackAdded",i.ActiveSpeakersUpdate="activeSpeakersUpdate",i.DataPacketReceived="dataPacketReceived",i.RTPVideoMapUpdate="rtpVideoMapUpdate",i.DCBufferStatusChanged="dcBufferStatusChanged",i.ParticipantUpdate="participantUpdate",i.RoomUpdate="roomUpdate",i.SpeakersChanged="speakersChanged",i.StreamStateChanged="streamStateChanged",i.ConnectionQualityUpdate="connectionQualityUpdate",i.SubscriptionError="subscriptionError",i.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",i.RemoteMute="remoteMute",i.SubscribedQualityUpdate="subscribedQualityUpdate",i.LocalTrackUnpublished="localTrackUnpublished",i.LocalTrackSubscribed="localTrackSubscribed",i.Offline="offline",i.SignalRequestResponse="signalRequestResponse",i.SignalConnected="signalConnected",i.RoomMoved="roomMoved"})(fe||(fe={}));var ue;(function(i){i.Message="message",i.Muted="muted",i.Unmuted="unmuted",i.Restarted="restarted",i.Ended="ended",i.Subscribed="subscribed",i.Unsubscribed="unsubscribed",i.CpuConstrained="cpuConstrained",i.UpdateSettings="updateSettings",i.UpdateSubscription="updateSubscription",i.AudioPlaybackStarted="audioPlaybackStarted",i.AudioPlaybackFailed="audioPlaybackFailed",i.AudioSilenceDetected="audioSilenceDetected",i.VisibilityChanged="visibilityChanged",i.VideoDimensionsChanged="videoDimensionsChanged",i.VideoPlaybackStarted="videoPlaybackStarted",i.VideoPlaybackFailed="videoPlaybackFailed",i.ElementAttached="elementAttached",i.ElementDetached="elementDetached",i.UpstreamPaused="upstreamPaused",i.UpstreamResumed="upstreamResumed",i.SubscriptionPermissionChanged="subscriptionPermissionChanged",i.SubscriptionStatusChanged="subscriptionStatusChanged",i.SubscriptionFailed="subscriptionFailed",i.TrackProcessorUpdate="trackProcessorUpdate",i.AudioTrackFeatureUpdate="audioTrackFeatureUpdate",i.TranscriptionReceived="transcriptionReceived",i.TimeSyncUpdate="timeSyncUpdate",i.PreConnectBufferFlushed="preConnectBufferFlushed"})(ue||(ue={}));function vF(i){return typeof i>"u"?i:typeof structuredClone=="function"?typeof i=="object"&&i!==null?structuredClone(Object.assign({},i)):structuredClone(i):JSON.parse(JSON.stringify(i))}const mF=/version\/(\d+(\.?_?\d+)+)/i;let $p;function zn(i){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(typeof navigator>"u")return;const t=navigator.userAgent.toLowerCase();if($p===void 0||e){const n=pF.find(r=>{let{test:a}=r;return a.test(t)});$p=n?.describe(t)}return $p}const pF=[{test:/firefox|iceweasel|fxios/i,describe(i){return{name:"Firefox",version:jh(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,i),os:i.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:Xp(i)}}},{test:/chrom|crios|crmo/i,describe(i){return{name:"Chrome",version:jh(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,i),os:i.toLowerCase().includes("crios")?"iOS":void 0,osVersion:Xp(i)}}},{test:/safari|applewebkit/i,describe(i){return{name:"Safari",version:jh(mF,i),os:i.includes("mobile/")?"iOS":"macOS",osVersion:Xp(i)}}}];function jh(i,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const n=e.match(i);return n&&n.length>=t&&n[t]||""}function Xp(i){return i.includes("mac os")?jh(/\(.+?(\d+_\d+(:?_\d+)?)/,i,1).replace(/_/g,"."):void 0}var gF="2.16.0";const yF=gF,bF=16;class En{}En.setTimeout=function(){return setTimeout(...arguments)};En.setInterval=function(){return setInterval(...arguments)};En.clearTimeout=function(){return clearTimeout(...arguments)};En.clearInterval=function(){return clearInterval(...arguments)};const SF=5e3,Uc=[];var fi;(function(i){i[i.LOW=0]="LOW",i[i.MEDIUM=1]="MEDIUM",i[i.HIGH=2]="HIGH"})(fi||(fi={}));class se extends vr.EventEmitter{get streamState(){return this._streamState}setStreamState(e){this._streamState=e}constructor(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};var r;super(),this.attachedElements=[],this.isMuted=!1,this._streamState=se.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=Fe,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),document.visibilityState==="hidden"?this.backgroundTimeout=setTimeout(()=>this.handleAppVisibilityChanged(),SF):this.handleAppVisibilityChanged()},this.log=Xr((r=n.loggerName)!==null&&r!==void 0?r:Wi.Track),this.loggerContextCb=n.loggerContextCb,this.setMaxListeners(100),this.kind=t,this._mediaStreamTrack=e,this._mediaStreamID=e.id,this.source=se.Source.Unknown}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),We(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(e){let t="audio";this.kind===se.Kind.Video&&(t="video"),this.attachedElements.length===0&&this.kind===se.Kind.Video&&this.addAppVisibilityListener(),e||(t==="audio"&&(Uc.forEach(a=>{a.parentElement===null&&!e&&(e=a)}),e&&Uc.splice(Uc.indexOf(e),1)),e||(e=document.createElement(t))),this.attachedElements.includes(e)||this.attachedElements.push(e),Wo(this.mediaStreamTrack,e);const n=e.srcObject.getTracks(),r=n.some(a=>a.kind==="audio");return e.play().then(()=>{this.emit(r?ue.AudioPlaybackStarted:ue.VideoPlaybackStarted)}).catch(a=>{a.name==="NotAllowedError"?this.emit(r?ue.AudioPlaybackFailed:ue.VideoPlaybackFailed,a):a.name==="AbortError"?Fe.debug("".concat(r?"audio":"video"," playback aborted, likely due to new play request")):Fe.warn("could not playback ".concat(r?"audio":"video"),a),r&&e&&n.some(o=>o.kind==="video")&&a.name==="NotAllowedError"&&(e.muted=!0,e.play().catch(()=>{}))}),this.emit(ue.ElementAttached,e),e}detach(e){try{if(e){rl(this.mediaStreamTrack,e);const n=this.attachedElements.indexOf(e);return n>=0&&(this.attachedElements.splice(n,1),this.recycleElement(e),this.emit(ue.ElementDetached,e)),e}const t=[];return this.attachedElements.forEach(n=>{rl(this.mediaStreamTrack,n),t.push(n),this.recycleElement(n),this.emit(ue.ElementDetached,n)}),this.attachedElements=[],t}finally{this.attachedElements.length===0&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval),this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions(e){e.loggerName&&(this.log=Xr(e.loggerName)),e.loggerContextCb&&(this.loggerContextCb=e.loggerContextCb)}recycleElement(e){if(e instanceof HTMLAudioElement){let t=!0;e.pause(),Uc.forEach(n=>{n.parentElement||(t=!1)}),t&&Uc.push(e)}}handleAppVisibilityChanged(){return L(this,void 0,void 0,function*(){this.isInBackground=document.visibilityState==="hidden",!this.isInBackground&&this.kind===se.Kind.Video&&setTimeout(()=>this.attachedElements.forEach(e=>e.play().catch(()=>{})),0)})}addAppVisibilityListener(){Gn()?(this.isInBackground=document.visibilityState==="hidden",document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){Gn()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function Wo(i,e){let t;e.srcObject instanceof MediaStream?t=e.srcObject:t=new MediaStream;let n;i.kind==="audio"?n=t.getAudioTracks():n=t.getVideoTracks(),n.includes(i)||(n.forEach(r=>{t.removeTrack(r)}),t.addTrack(i)),(!Vs()||!(e instanceof HTMLVideoElement))&&(e.autoplay=!0),e.muted=t.getAudioTracks().length===0,e instanceof HTMLVideoElement&&(e.playsInline=!0),e.srcObject!==t&&(e.srcObject=t,(Vs()||qs())&&e instanceof HTMLVideoElement&&setTimeout(()=>{e.srcObject=t,e.play().catch(()=>{})},0))}function rl(i,e){if(e.srcObject instanceof MediaStream){const t=e.srcObject;t.removeTrack(i),t.getTracks().length>0?e.srcObject=t:e.srcObject=null}}(function(i){let e;(function(h){h.Audio="audio",h.Video="video",h.Unknown="unknown"})(e=i.Kind||(i.Kind={}));let t;(function(h){h.Camera="camera",h.Microphone="microphone",h.ScreenShare="screen_share",h.ScreenShareAudio="screen_share_audio",h.Unknown="unknown"})(t=i.Source||(i.Source={}));let n;(function(h){h.Active="active",h.Paused="paused",h.Unknown="unknown"})(n=i.StreamState||(i.StreamState={}));function r(h){switch(h){case e.Audio:return qi.AUDIO;case e.Video:return qi.VIDEO;default:return qi.DATA}}i.kindToProto=r;function a(h){switch(h){case qi.AUDIO:return e.Audio;case qi.VIDEO:return e.Video;default:return e.Unknown}}i.kindFromProto=a;function o(h){switch(h){case t.Camera:return Xt.CAMERA;case t.Microphone:return Xt.MICROPHONE;case t.ScreenShare:return Xt.SCREEN_SHARE;case t.ScreenShareAudio:return Xt.SCREEN_SHARE_AUDIO;default:return Xt.UNKNOWN}}i.sourceToProto=o;function c(h){switch(h){case Xt.CAMERA:return t.Camera;case Xt.MICROPHONE:return t.Microphone;case Xt.SCREEN_SHARE:return t.ScreenShare;case Xt.SCREEN_SHARE_AUDIO:return t.ScreenShareAudio;default:return t.Unknown}}i.sourceFromProto=c;function d(h){switch(h){case uy.ACTIVE:return n.Active;case uy.PAUSED:return n.Paused;default:return n.Unknown}}i.streamStateFromProto=d})(se||(se={}));class pt{constructor(e,t,n,r,a){if(typeof e=="object")this.width=e.width,this.height=e.height,this.aspectRatio=e.aspectRatio,this.encoding={maxBitrate:e.maxBitrate,maxFramerate:e.maxFramerate,priority:e.priority};else if(t!==void 0&&n!==void 0)this.width=e,this.height=t,this.aspectRatio=e/t,this.encoding={maxBitrate:n,maxFramerate:r,priority:a};else throw new TypeError("Unsupported options: provide at least width, height and maxBitrate")}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}const EF=["vp8","h264"],TF=["vp8","h264","vp9","av1","h265"];function _F(i){return!!EF.find(e=>e===i)}const CF=_F;var NR;(function(i){i[i.PREFER_REGRESSION=0]="PREFER_REGRESSION",i[i.SIMULCAST=1]="SIMULCAST",i[i.REGRESSION=2]="REGRESSION"})(NR||(NR={}));var Sy;(function(i){i.telephone={maxBitrate:12e3},i.speech={maxBitrate:24e3},i.music={maxBitrate:48e3},i.musicStereo={maxBitrate:64e3},i.musicHighQuality={maxBitrate:96e3},i.musicHighQualityStereo={maxBitrate:128e3}})(Sy||(Sy={}));const Eu={h90:new pt(160,90,9e4,20),h180:new pt(320,180,16e4,20),h216:new pt(384,216,18e4,20),h360:new pt(640,360,45e4,20),h540:new pt(960,540,8e5,25),h720:new pt(1280,720,17e5,30),h1080:new pt(1920,1080,3e6,30),h1440:new pt(2560,1440,5e6,30),h2160:new pt(3840,2160,8e6,30)},Ey={h120:new pt(160,120,7e4,20),h180:new pt(240,180,125e3,20),h240:new pt(320,240,14e4,20),h360:new pt(480,360,33e4,20),h480:new pt(640,480,5e5,20),h540:new pt(720,540,6e5,25),h720:new pt(960,720,13e5,30),h1080:new pt(1440,1080,23e5,30),h1440:new pt(1920,1440,38e5,30)},Nb={h360fps3:new pt(640,360,2e5,3,"medium"),h360fps15:new pt(640,360,4e5,15,"medium"),h720fps5:new pt(1280,720,8e5,5,"medium"),h720fps15:new pt(1280,720,15e5,15,"medium"),h720fps30:new pt(1280,720,2e6,30,"medium"),h1080fps15:new pt(1920,1080,25e5,15,"medium"),h1080fps30:new pt(1920,1080,5e6,30,"medium"),original:new pt(0,0,7e6,30,"medium")},RF="|",xR="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function kF(i){const e=i.split(RF);return e.length>1?[e[0],i.substr(e[0].length+1)]:[i,""]}function Tn(i){return L(this,void 0,void 0,function*(){return new Promise(e=>En.setTimeout(e,i))})}function Ty(){return"addTransceiver"in RTCPeerConnection.prototype}function _y(){return"addTrack"in RTCPeerConnection.prototype}function wF(){if(!("getCapabilities"in RTCRtpSender)||Vs()||qs())return!1;const i=RTCRtpSender.getCapabilities("video");let e=!1;if(i){for(const t of i.codecs)if(t.mimeType.toLowerCase()==="video/av1"){e=!0;break}}return e}function IF(){if(!("getCapabilities"in RTCRtpSender)||qs())return!1;if(Vs()){const t=zn();if(t?.version&&dr(t.version,"16")<0||t?.os==="iOS"&&t?.osVersion&&dr(t.osVersion,"16")<0)return!1}const i=RTCRtpSender.getCapabilities("video");let e=!1;if(i){for(const t of i.codecs)if(t.mimeType.toLowerCase()==="video/vp9"){e=!0;break}}return e}function Ki(i){return i==="av1"||i==="vp9"}function Cy(i){return!document||Tu()?!1:(i||(i=document.createElement("audio")),"setSinkId"in i)}function OF(){return typeof RTCPeerConnection>"u"?!1:Ty()||_y()}function qs(){var i;return((i=zn())===null||i===void 0?void 0:i.name)==="Firefox"}function LR(){const i=zn();return!!i&&i.name==="Chrome"&&i.os!=="iOS"}function Vs(){var i;return((i=zn())===null||i===void 0?void 0:i.name)==="Safari"}function Tu(){const i=zn();return i?.name==="Safari"||i?.os==="iOS"}function MF(){const i=zn();return i?.name==="Safari"&&i.version.startsWith("17.")||i?.os==="iOS"&&!!i?.osVersion&&dr(i.osVersion,"17")>=0}function PF(i){return i||(i=zn()),i?.name==="Safari"&&dr(i.version,"18.3")>0||i?.os==="iOS"&&!!i?.osVersion&&dr(i.osVersion,"18.3")>0}function jO(){var i,e;return Gn()?(e=(i=navigator.userAgentData)===null||i===void 0?void 0:i.mobile)!==null&&e!==void 0?e:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent):!1}function AF(){const i=zn(),e="17.2";if(i)return i.name!=="Safari"&&i.os!=="iOS"||i.os==="iOS"&&i.osVersion&&dr(i.osVersion,e)>=0?!0:i.name==="Safari"&&dr(i.version,e)>=0}function Gn(){return typeof document<"u"}function ur(){return navigator.product=="ReactNative"}function ff(i){return i.hostname.endsWith(".livekit.cloud")||i.hostname.endsWith(".livekit.run")}function Qp(i){return ff(i)?i.hostname.split(".")[0]:null}function qO(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function VO(){if(!ur())return;let i=qO();if(i)return i.platform}function UR(){if(Gn())return window.devicePixelRatio;if(ur()){let i=qO();if(i)return i.devicePixelRatio}return 1}function dr(i,e){const t=i.split("."),n=e.split("."),r=Math.min(t.length,n.length);for(let a=0;a<r;++a){const o=parseInt(t[a],10),c=parseInt(n[a],10);if(o>c)return 1;if(o<c)return-1;if(a===r-1&&o===c)return 0}return i===""&&e!==""?-1:e===""?1:t.length==n.length?0:t.length<n.length?-1:1}function DF(i){for(const e of i)e.target.handleResize(e)}function NF(i){for(const e of i)e.target.handleVisibilityChanged(e)}let Zp=null;const BR=()=>(Zp||(Zp=new ResizeObserver(DF)),Zp);let eg=null;const FR=()=>(eg||(eg=new IntersectionObserver(NF,{root:null,rootMargin:"0px"})),eg);function xF(){var i;const e=new GI({sdk:zI.JS,protocol:bF,version:yF});return ur()&&(e.os=(i=VO())!==null&&i!==void 0?i:""),e}function jR(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;const r=document.createElement("canvas");r.width=i,r.height=e;const a=r.getContext("2d");a?.fillRect(0,0,r.width,r.height),n&&a&&(a.beginPath(),a.arc(i/2,e/2,50,0,Math.PI*2,!0),a.closePath(),a.fillStyle="grey",a.fill());const o=r.captureStream(),[c]=o.getTracks();if(!c)throw Error("Could not get empty media stream video track");return c.enabled=t,c}let Bc;function tg(){if(!Bc){const i=new AudioContext,e=i.createOscillator(),t=i.createGain();t.gain.setValueAtTime(0,0);const n=i.createMediaStreamDestination();if(e.connect(t),t.connect(n),e.start(),[Bc]=n.stream.getAudioTracks(),!Bc)throw Error("Could not get empty media stream audio track");Bc.enabled=!1}return Bc.clone()}class Oi{get isResolved(){return this._isResolved}constructor(e,t){this._isResolved=!1,this.onFinally=t,this.promise=new Promise((n,r)=>L(this,void 0,void 0,function*(){this.resolve=n,this.reject=r,e&&(yield e(n,r))})).finally(()=>{var n;this._isResolved=!0,(n=this.onFinally)===null||n===void 0||n.call(this)})}}function LF(i){return TF.includes(i)}function Ha(i){if(typeof i=="string"||typeof i=="number")return i;if(Array.isArray(i))return i[0];if(i.exact!==void 0)return Array.isArray(i.exact)?i.exact[0]:i.exact;if(i.ideal!==void 0)return Array.isArray(i.ideal)?i.ideal[0]:i.ideal;throw Error("could not unwrap constraint")}function UF(i){return i.startsWith("http")?i.replace(/^(http)/,"ws"):i}function _u(i){return i.startsWith("ws")?i.replace(/^(ws)/,"http"):i}function BF(i,e){return i.segments.map(t=>{let{id:n,text:r,language:a,startTime:o,endTime:c,final:d}=t;var h;const v=(h=e.get(n))!==null&&h!==void 0?h:Date.now(),m=Date.now();return d?e.delete(n):e.set(n,v),{id:n,text:r,startTime:Number.parseInt(o.toString()),endTime:Number.parseInt(c.toString()),final:d,language:a,firstReceivedTime:v,lastReceivedTime:m}})}function FF(i){const{id:e,timestamp:t,message:n,editTimestamp:r}=i;return{id:e,timestamp:Number.parseInt(t.toString()),editTimestamp:r?Number.parseInt(r.toString()):void 0,message:n}}function qR(i){switch(i.reason){case Le.LeaveRequest:return i.context;case Le.Cancelled:return Hi.CLIENT_INITIATED;case Le.NotAllowed:return Hi.USER_REJECTED;case Le.ServerUnreachable:return Hi.JOIN_FAILURE;default:return Hi.UNKNOWN_REASON}}function qh(i){return i!==void 0?Number(i):void 0}function Os(i){return i!==void 0?BigInt(i):void 0}function Us(i){return!!i&&!(i instanceof MediaStreamTrack)&&i.isLocal}function cr(i){return!!i&&i.kind==se.Kind.Audio}function Ya(i){return!!i&&i.kind==se.Kind.Video}function Ia(i){return Us(i)&&Ya(i)}function Lr(i){return Us(i)&&cr(i)}function Ry(i){return!!i&&!i.isLocal}function jF(i){return!!i&&!i.isLocal}function ng(i){return Ry(i)&&Ya(i)}function qF(i){return i.isLocal}function VF(i,e){const t=[];let n=new TextEncoder().encode(i);for(;n.length>e;){let r=e;for(;r>0;){const a=n[r];if(a!==void 0&&(a&192)!==128)break;r--}t.push(n.slice(0,r)),n=n.slice(r)}return n.length>0&&t.push(n),t}function KF(i){var e;const t=i.get("Cache-Control");if(t){const n=(e=t.match(/(?:^|[,\s])max-age=(\d+)/))===null||e===void 0?void 0:e[1];if(n)return parseInt(n,10)}}function KO(i,e,t){var n,r,a,o;const{optionsWithoutProcessor:c,audioProcessor:d,videoProcessor:h}=zO(i??{}),v=e?.processor,m=t?.processor,y=c??{};return y.audio===!0&&(y.audio={}),y.video===!0&&(y.video={}),y.audio&&(ky(y.audio,e),(n=(a=y.audio).deviceId)!==null&&n!==void 0||(a.deviceId={ideal:"default"}),(d||v)&&(y.audio.processor=d??v)),y.video&&(ky(y.video,t),(r=(o=y.video).deviceId)!==null&&r!==void 0||(o.deviceId={ideal:"default"}),(h||m)&&(y.video.processor=h??m)),y}function ky(i,e){return Object.keys(e).forEach(t=>{i[t]===void 0&&(i[t]=e[t])}),i}function xb(i){var e,t,n,r;const a={};if(i.video)if(typeof i.video=="object"){const o={},c=o,d=i.video;Object.keys(d).forEach(h=>{h==="resolution"?ky(c,d.resolution):c[h]=d[h]}),a.video=o,(e=(n=a.video).deviceId)!==null&&e!==void 0||(n.deviceId={ideal:"default"})}else a.video=i.video?{deviceId:{ideal:"default"}}:!1;else a.video=!1;return i.audio?typeof i.audio=="object"?(a.audio=i.audio,(t=(r=a.audio).deviceId)!==null&&t!==void 0||(r.deviceId={ideal:"default"})):a.audio={deviceId:{ideal:"default"}}:a.audio=!1,a}function HO(i){return L(this,arguments,void 0,function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:200;return(function*(){const n=GO();if(n){const r=n.createAnalyser();r.fftSize=2048;const a=r.frequencyBinCount,o=new Uint8Array(a);n.createMediaStreamSource(new MediaStream([e.mediaStreamTrack])).connect(r),yield Tn(t),r.getByteTimeDomainData(o);const d=o.some(h=>h!==128&&h!==0);return n.close(),!d}return!1})()})}function GO(){var i;const e=typeof window<"u"&&(window.AudioContext||window.webkitAudioContext);if(e){const t=new e({latencyHint:"interactive"});if(t.state==="suspended"&&typeof window<"u"&&(!((i=window.document)===null||i===void 0)&&i.body)){const n=()=>L(this,void 0,void 0,function*(){var r;try{t.state==="suspended"&&(yield t.resume())}catch(a){console.warn("Error trying to auto-resume audio context",a)}finally{(r=window.document.body)===null||r===void 0||r.removeEventListener("click",n)}});t.addEventListener("statechange",()=>{var r;t.state==="closed"&&((r=window.document.body)===null||r===void 0||r.removeEventListener("click",n))}),window.document.body.addEventListener("click",n)}return t}}function HF(i){return i==="audioinput"?se.Source.Microphone:i==="videoinput"?se.Source.Camera:se.Source.Unknown}function wy(i){return i===se.Source.Microphone?"audioinput":i===se.Source.Camera?"videoinput":void 0}function GF(i){var e,t;let n=(e=i.video)!==null&&e!==void 0?e:!0;return i.resolution&&i.resolution.width>0&&i.resolution.height>0&&(n=typeof n=="boolean"?{}:n,Vs()?n=Object.assign(Object.assign({},n),{width:{max:i.resolution.width},height:{max:i.resolution.height},frameRate:i.resolution.frameRate}):n=Object.assign(Object.assign({},n),{width:{ideal:i.resolution.width},height:{ideal:i.resolution.height},frameRate:i.resolution.frameRate})),{audio:(t=i.audio)!==null&&t!==void 0?t:!1,video:n,controller:i.controller,selfBrowserSurface:i.selfBrowserSurface,surfaceSwitching:i.surfaceSwitching,systemAudio:i.systemAudio,preferCurrentTab:i.preferCurrentTab}}function eu(i){return i.split("/")[1].toLowerCase()}function zF(i){const e=[];return i.forEach(t=>{t.track!==void 0&&e.push(new kb({cid:t.track.mediaStreamID,track:t.trackInfo}))}),e}function We(i){return"mediaStreamTrack"in i?{trackID:i.sid,source:i.source,muted:i.isMuted,enabled:i.mediaStreamTrack.enabled,kind:i.kind,streamID:i.mediaStreamID,streamTrackID:i.mediaStreamTrack.id}:{trackID:i.trackSid,enabled:i.isEnabled,muted:i.isMuted,trackInfo:Object.assign({mimeType:i.mimeType,name:i.trackName,encrypted:i.isEncrypted,kind:i.kind,source:i.source},i.track?We(i.track):{})}}function WF(){return typeof RTCRtpReceiver<"u"&&"getSynchronizationSources"in RTCRtpReceiver}function JF(i,e){var t;i===void 0&&(i={}),e===void 0&&(e={});const n=[...Object.keys(e),...Object.keys(i)],r={};for(const a of n)i[a]!==e[a]&&(r[a]=(t=e[a])!==null&&t!==void 0?t:"");return r}function zO(i){const e=Object.assign({},i);let t,n;return typeof e.audio=="object"&&e.audio.processor&&(t=e.audio.processor,e.audio=Object.assign(Object.assign({},e.audio),{processor:void 0})),typeof e.video=="object"&&e.video.processor&&(n=e.video.processor,e.video=Object.assign(Object.assign({},e.video),{processor:void 0})),{audioProcessor:t,videoProcessor:n,optionsWithoutProcessor:vF(e)}}function YF(i){switch(i){case Xt.CAMERA:return se.Source.Camera;case Xt.MICROPHONE:return se.Source.Microphone;case Xt.SCREEN_SHARE:return se.Source.ScreenShare;case Xt.SCREEN_SHARE_AUDIO:return se.Source.ScreenShareAudio;default:return se.Source.Unknown}}function VR(i,e){return i.width*i.height<e.width*e.height}function $F(i,e){var t;return(t=i.layers)===null||t===void 0?void 0:t.find(n=>n.quality===e)}class XF extends vr.EventEmitter{constructor(e,t){super(),this.decryptDataRequests=new Map,this.encryptDataRequests=new Map,this.onWorkerMessage=n=>{var r,a;const{kind:o,data:c}=n.data;switch(o){case"error":if(Fe.error(c.error.message),c.uuid){const v=this.decryptDataRequests.get(c.uuid);if(v?.reject){v.reject(c.error);break}const m=this.encryptDataRequests.get(c.uuid);if(m?.reject){m.reject(c.error);break}}this.emit(Ba.EncryptionError,c.error,c.participantIdentity);break;case"initAck":c.enabled&&this.keyProvider.getKeys().forEach(v=>{this.postKey(v)});break;case"enable":if(c.enabled&&this.keyProvider.getKeys().forEach(v=>{this.postKey(v)}),this.encryptionEnabled!==c.enabled&&c.participantIdentity===((r=this.room)===null||r===void 0?void 0:r.localParticipant.identity))this.emit(Ba.ParticipantEncryptionStatusChanged,c.enabled,this.room.localParticipant),this.encryptionEnabled=c.enabled;else if(c.participantIdentity){const v=(a=this.room)===null||a===void 0?void 0:a.getParticipantByIdentity(c.participantIdentity);if(!v)throw TypeError("couldn't set encryption status, participant not found".concat(c.participantIdentity));this.emit(Ba.ParticipantEncryptionStatusChanged,c.enabled,v)}break;case"ratchetKey":this.keyProvider.emit(Ka.KeyRatcheted,c.ratchetResult,c.participantIdentity,c.keyIndex);break;case"decryptDataResponse":const d=this.decryptDataRequests.get(c.uuid);d?.resolve&&d.resolve(c);break;case"encryptDataResponse":const h=this.encryptDataRequests.get(c.uuid);h?.resolve&&h.resolve(c);break}},this.onWorkerError=n=>{Fe.error("e2ee worker encountered an error:",{error:n.error}),this.emit(Ba.EncryptionError,n.error,void 0)},this.keyProvider=e.keyProvider,this.worker=e.worker,this.encryptionEnabled=!1,this.dataChannelEncryptionEnabled=t}get isEnabled(){return this.encryptionEnabled}get isDataChannelEncryptionEnabled(){return this.isEnabled&&this.dataChannelEncryptionEnabled}setup(e){if(!oF())throw new Db("tried to setup end-to-end encryption on an unsupported browser");if(Fe.info("setting up e2ee"),e!==this.room){this.room=e,this.setupEventListeners(e,this.keyProvider);const t={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:GB.getLevel()}};this.worker&&(Fe.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(t))}}setParticipantCryptorEnabled(e,t){Fe.debug("set e2ee to ".concat(e," for participant ").concat(t)),this.postEnable(e,t)}setSifTrailer(e){!e||e.length===0?Fe.warn("ignoring server sent trailer as it's empty"):this.postSifTrailer(e)}setupEngine(e){e.on(fe.RTPVideoMapUpdate,t=>{this.postRTPMap(t)})}setupEventListeners(e,t){e.on(te.TrackPublished,(n,r)=>this.setParticipantCryptorEnabled(n.trackInfo.encryption!==rn.NONE,r.identity)),e.on(te.ConnectionStateChanged,n=>{n===at.Connected&&e.remoteParticipants.forEach(r=>{r.trackPublications.forEach(a=>{this.setParticipantCryptorEnabled(a.trackInfo.encryption!==rn.NONE,r.identity)})})}).on(te.TrackUnsubscribed,(n,r,a)=>{var o;const c={kind:"removeTransform",data:{participantIdentity:a.identity,trackId:n.mediaStreamID}};(o=this.worker)===null||o===void 0||o.postMessage(c)}).on(te.TrackSubscribed,(n,r,a)=>{this.setupE2EEReceiver(n,a.identity,r.trackInfo)}).on(te.SignalConnected,()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");t.getKeys().forEach(n=>{this.postKey(n)}),this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)}),e.localParticipant.on(ae.LocalSenderCreated,(n,r)=>L(this,void 0,void 0,function*(){this.setupE2EESender(r,n)})),e.localParticipant.on(ae.LocalTrackPublished,n=>{if(!Ya(n.track)||!Tu())return;const r={kind:"updateCodec",data:{trackId:n.track.mediaStreamID,codec:eu(n.trackInfo.codecs[0].mimeType),participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(r)}),t.on(Ka.SetKey,n=>this.postKey(n)).on(Ka.RatchetRequest,(n,r)=>this.postRatchetRequest(n,r))}encryptData(e){return L(this,void 0,void 0,function*(){if(!this.worker)throw Error("could not encrypt data, worker is missing");const t=crypto.randomUUID(),n={kind:"encryptDataRequest",data:{uuid:t,payload:e,participantIdentity:this.room.localParticipant.identity}},r=new Oi;return r.onFinally=()=>{this.encryptDataRequests.delete(t)},this.encryptDataRequests.set(t,r),this.worker.postMessage(n),r.promise})}handleEncryptedData(e,t,n,r){if(!this.worker)throw Error("could not handle encrypted data, worker is missing");const a=crypto.randomUUID(),o={kind:"decryptDataRequest",data:{uuid:a,payload:e,iv:t,participantIdentity:n,keyIndex:r}},c=new Oi;return c.onFinally=()=>{this.decryptDataRequests.delete(a)},this.decryptDataRequests.set(a,c),this.worker.postMessage(o),c.promise}postRatchetRequest(e,t){if(!this.worker)throw Error("could not ratchet key, worker is missing");const n={kind:"ratchetRequest",data:{participantIdentity:e,keyIndex:t}};this.worker.postMessage(n)}postKey(e){let{key:t,participantIdentity:n,keyIndex:r}=e;var a;if(!this.worker)throw Error("could not set key, worker is missing");const o={kind:"setKey",data:{participantIdentity:n,isPublisher:n===((a=this.room)===null||a===void 0?void 0:a.localParticipant.identity),key:t,keyIndex:r}};this.worker.postMessage(o)}postEnable(e,t){if(this.worker){const n={kind:"enable",data:{enabled:e,participantIdentity:t}};this.worker.postMessage(n)}else throw new ReferenceError("failed to enable e2ee, worker is not ready")}postRTPMap(e){var t;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(!((t=this.room)===null||t===void 0)&&t.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const n={kind:"setRTPMap",data:{map:e,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(n)}postSifTrailer(e){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const t={kind:"setSifTrailer",data:{trailer:e}};this.worker.postMessage(t)}setupE2EEReceiver(e,t,n){if(e.receiver){if(!n?.mimeType||n.mimeType==="")throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver(e.receiver,e.mediaStreamID,t,e.kind==="video"?eu(n.mimeType):void 0)}}setupE2EESender(e,t){if(!Us(e)||!t){t||Fe.warn("early return because sender is not ready");return}this.handleSender(t,e.mediaStreamID,void 0)}handleReceiver(e,t,n,r){return L(this,void 0,void 0,function*(){if(this.worker){if(yy()&&!LR()){const a={kind:"decode",participantIdentity:n,trackId:t,codec:r};e.transform=new RTCRtpScriptTransform(this.worker,a)}else{if(Lc in e&&r){const d={kind:"updateCodec",data:{trackId:t,codec:r,participantIdentity:n}};this.worker.postMessage(d);return}let a=e.writableStream,o=e.readableStream;if(!a||!o){const d=e.createEncodedStreams();e.writableStream=d.writable,a=d.writable,e.readableStream=d.readable,o=d.readable}const c={kind:"decode",data:{readableStream:o,writableStream:a,trackId:t,codec:r,participantIdentity:n,isReuse:Lc in e}};this.worker.postMessage(c,[o,a])}e[Lc]=!0}})}handleSender(e,t,n){var r;if(!(Lc in e||!this.worker)){if(!(!((r=this.room)===null||r===void 0)&&r.localParticipant.identity)||this.room.localParticipant.identity==="")throw TypeError("local identity needs to be known in order to set up encrypted sender");if(yy()&&!LR()){Fe.info("initialize script transform");const a={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:t,codec:n};e.transform=new RTCRtpScriptTransform(this.worker,a)}else{Fe.info("initialize encoded streams");const a=e.createEncodedStreams(),o={kind:"encode",data:{readableStream:a.readable,writableStream:a.writable,codec:n,trackId:t,participantIdentity:this.room.localParticipant.identity,isReuse:!1}};this.worker.postMessage(o,[a.readable,a.writable])}e[Lc]=!0}}}const QF=500,ZF=15e3;class al{constructor(){this.failedConnectionAttempts=new Map,this.backOffPromises=new Map}static getInstance(){return this._instance||(this._instance=new al),this._instance}addFailedConnectionAttempt(e){var t;const n=new URL(e),r=Qp(n);if(!r)return;let a=(t=this.failedConnectionAttempts.get(r))!==null&&t!==void 0?t:0;this.failedConnectionAttempts.set(r,a+1),this.backOffPromises.set(r,Tn(Math.min(QF*Math.pow(2,a),ZF)))}getBackOffPromise(e){const t=new URL(e),n=t&&Qp(t);return n&&this.backOffPromises.get(n)||Promise.resolve()}resetFailedConnectionAttempts(e){const t=new URL(e),n=t&&Qp(t);n&&(this.failedConnectionAttempts.set(n,0),this.backOffPromises.set(n,Promise.resolve()))}resetAll(){this.backOffPromises.clear(),this.failedConnectionAttempts.clear()}}al._instance=null;const ig="default";class hn{constructor(){this._previousDevices=[]}static getInstance(){return this.instance===void 0&&(this.instance=new hn),this.instance}get previousDevices(){return this._previousDevices}getDevices(e){return L(this,arguments,void 0,function(t){var n=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var a;if(((a=hn.userMediaPromiseMap)===null||a===void 0?void 0:a.size)>0){Fe.debug("awaiting getUserMedia promise");try{t?yield hn.userMediaPromiseMap.get(t):yield Promise.all(hn.userMediaPromiseMap.values())}catch{Fe.warn("error waiting for media permissons")}}let o=yield navigator.mediaDevices.enumerateDevices();if(r&&!(Vs()&&n.hasDeviceInUse(t))&&(o.filter(d=>d.kind===t).length===0||o.some(d=>{const h=d.label==="",v=t?d.kind===t:!0;return h&&v}))){const d={video:t!=="audioinput"&&t!=="audiooutput",audio:t!=="videoinput"&&{deviceId:{ideal:"default"}}},h=yield navigator.mediaDevices.getUserMedia(d);o=yield navigator.mediaDevices.enumerateDevices(),h.getTracks().forEach(v=>{v.stop()})}return n._previousDevices=o,t&&(o=o.filter(c=>c.kind===t)),o})()})}normalizeDeviceId(e,t,n){return L(this,void 0,void 0,function*(){if(t!==ig)return t;const r=yield this.getDevices(e),a=r.find(c=>c.deviceId===ig);if(!a){Fe.warn("could not reliably determine default device");return}const o=r.find(c=>c.deviceId!==ig&&c.groupId===(n??a.groupId));if(!o){Fe.warn("could not reliably determine default device");return}return o?.deviceId})}hasDeviceInUse(e){return e?hn.userMediaPromiseMap.has(e):hn.userMediaPromiseMap.size>0}}hn.mediaDeviceKinds=["audioinput","audiooutput","videoinput"];hn.userMediaPromiseMap=new Map;var tu;(function(i){i[i.WAITING=0]="WAITING",i[i.RUNNING=1]="RUNNING",i[i.COMPLETED=2]="COMPLETED"})(tu||(tu={}));class e3{constructor(){this.pendingTasks=new Map,this.taskMutex=new An,this.nextTaskIndex=0}run(e){return L(this,void 0,void 0,function*(){const t={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:tu.WAITING};this.pendingTasks.set(t.id,t);const n=yield this.taskMutex.lock();try{return t.executedAt=Date.now(),t.status=tu.RUNNING,yield e()}finally{t.status=tu.COMPLETED,this.pendingTasks.delete(t.id),n()}})}flush(){return L(this,void 0,void 0,function*(){return this.run(()=>L(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}class t3{get readyState(){return this.ws.readyState}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var n,r;if(!((n=t.signal)===null||n===void 0)&&n.aborted)throw new DOMException("This operation was aborted","AbortError");this.url=e;const a=new WebSocket(e,(r=t.protocols)!==null&&r!==void 0?r:[]);a.binaryType="arraybuffer",this.ws=a;const o=function(){let{closeCode:c,reason:d}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return a.close(c,d)};this.opened=new Promise((c,d)=>{a.onopen=()=>{c({readable:new ReadableStream({start(h){a.onmessage=v=>{let{data:m}=v;return h.enqueue(m)},a.onerror=v=>h.error(v)},cancel:o}),writable:new WritableStream({write(h){a.send(h)},abort(){a.close()},close:o}),protocol:a.protocol,extensions:a.extensions}),a.removeEventListener("error",d)},a.addEventListener("error",d)}),this.closed=new Promise((c,d)=>{const h=()=>L(this,void 0,void 0,function*(){const v=new Promise(y=>{a.readyState!==WebSocket.CLOSED&&a.addEventListener("close",E=>{y(E)},{once:!0})}),m=yield Promise.race([Tn(250),v]);m?c(m):d(new Error("Encountered unspecified websocket error without a timely close event"))});a.onclose=v=>{let{code:m,reason:y}=v;c({closeCode:m,reason:y}),a.removeEventListener("error",h)},a.addEventListener("error",h)}),t.signal&&(t.signal.onabort=()=>a.close()),this.close=o}}function n3(i,e){const t=new URL(UF(i));return e.forEach((n,r)=>{t.searchParams.set(r,n)}),WO(t,"rtc")}function i3(i){const e=new URL(_u(i));return WO(e,"validate")}function r3(i){return i.endsWith("/")?i:"".concat(i,"/")}function WO(i,e){return i.pathname="".concat(r3(i.pathname)).concat(e),i.toString()}function KR(i){if(typeof i=="string")return yR.fromJson(JSON.parse(i),{ignoreUnknownFields:!0});if(i instanceof ArrayBuffer)return yR.fromBinary(new Uint8Array(i));throw new Error("could not decode websocket message: ".concat(typeof i))}function a3(i){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"Unknown reason";if(!(i instanceof AbortSignal))return e;const t=i.reason;switch(typeof t){case"string":return t;case"object":return t instanceof Error?t.message:e;default:return"toString"in t?t.toString():e}}const s3=["syncState","trickle","offer","answer","simulate","leave"];function o3(i){const e=s3.indexOf(i.case)>=0;return Fe.trace("request allowed to bypass queue:",{canPass:e,req:i}),e}var St;(function(i){i[i.CONNECTING=0]="CONNECTING",i[i.CONNECTED=1]="CONNECTED",i[i.RECONNECTING=2]="RECONNECTING",i[i.DISCONNECTING=3]="DISCONNECTING",i[i.DISCONNECTED=4]="DISCONNECTED"})(St||(St={}));const l3=250;class Lb{get currentState(){return this.state}get isDisconnected(){return this.state===St.DISCONNECTING||this.state===St.DISCONNECTED}get isEstablishingConnection(){return this.state===St.CONNECTING||this.state===St.RECONNECTING}getNextRequestId(){return this._requestId+=1,this._requestId}constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var n;this.rtt=0,this.state=St.DISCONNECTED,this.log=Fe,this._requestId=0,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0,this.onMediaSectionsRequirement=void 0},this.log=Xr((n=t.loggerName)!==null&&n!==void 0?n:Wi.Signal),this.loggerContextCb=t.loggerContextCb,this.useJSON=e,this.requestQueue=new e3,this.queuedRequests=[],this.closingLock=new An,this.connectionLock=new An,this.state=St.DISCONNECTED}get logContext(){var e,t;return(t=(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this))!==null&&t!==void 0?t:{}}join(e,t,n,r){return L(this,void 0,void 0,function*(){return this.state=St.CONNECTING,this.options=n,yield this.connect(e,t,n,r)})}reconnect(e,t,n,r){return L(this,void 0,void 0,function*(){if(!this.options){this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext);return}return this.state=St.RECONNECTING,this.clearPingInterval(),yield this.connect(e,t,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:n,reconnectReason:r}))})}connect(e,t,n,r){return L(this,void 0,void 0,function*(){const a=yield this.connectionLock.lock();this.connectOptions=n;const o=xF(),c=n.singlePeerConnection?u3(t,o,n):c3(t,o,n),d=n3(e,c),h=i3(d);return new Promise((v,m)=>L(this,void 0,void 0,function*(){var y,E;try{let T=!1;const S=C=>L(this,void 0,void 0,function*(){if(T)return;T=!0;const k=C instanceof Event?C.currentTarget:C,_=a3(k,"Abort handler called");this.streamWriter&&!this.isDisconnected?this.sendLeave().then(()=>this.close(_)).catch(P=>{this.log.error(P),this.close()}):this.close(),O(),m(k instanceof AbortSignal?k.reason:k)});r?.addEventListener("abort",S);const O=()=>{clearTimeout(R),r?.removeEventListener("abort",S)},R=setTimeout(()=>{S(new Qe("room connection has timed out (signal)",Le.ServerUnreachable))},n.websocketTimeout),I=(C,k)=>{this.handleSignalConnected(C,R,k)},M=new URL(d);M.searchParams.has("access_token")&&M.searchParams.set("access_token","<redacted>"),this.log.debug("connecting to ".concat(M),Object.assign({reconnect:n.reconnect,reconnectReason:n.reconnectReason},this.logContext)),this.ws&&(yield this.close(!1)),this.ws=new t3(d);try{this.ws.closed.then(j=>{var K;this.isEstablishingConnection&&m(new Qe("Websocket got closed during a (re)connection attempt: ".concat(j.reason),Le.InternalError)),j.closeCode!==1e3&&(this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:j.reason,code:j.closeCode,wasClean:j.closeCode===1e3,state:this.state})),this.state===St.CONNECTED&&this.handleOnClose((K=j.reason)!==null&&K!==void 0?K:"Unexpected WS error"))}).catch(j=>{this.isEstablishingConnection&&m(new Qe("Websocket error during a (re)connection attempt: ".concat(j),Le.InternalError))});const C=yield this.ws.opened.catch(j=>L(this,void 0,void 0,function*(){if(this.state!==St.CONNECTED){this.state=St.DISCONNECTED,clearTimeout(R);const K=yield this.handleConnectionError(j,h);m(K);return}this.handleWSError(j),m(j)}));if(clearTimeout(R),!C)return;const k=C.readable.getReader();this.streamWriter=C.writable.getWriter();const _=yield k.read();if(k.releaseLock(),!_.value)throw new Qe("no message received as first message",Le.InternalError);const P=KR(_.value),x=this.validateFirstMessage(P,(y=n.reconnect)!==null&&y!==void 0?y:!1);if(!x.isValid){m(x.error);return}((E=P.message)===null||E===void 0?void 0:E.case)==="join"&&(this.pingTimeoutDuration=P.message.value.pingTimeout,this.pingIntervalDuration=P.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration})));const U=x.shouldProcessFirstMessage?P:void 0;I(C,U),v(x.response)}catch(C){m(C)}finally{O()}}finally{a()}}))})}startReadingLoop(e,t){return L(this,void 0,void 0,function*(){for(t&&this.handleSignalResponse(t);;){this.signalLatency&&(yield Tn(this.signalLatency));const{done:n,value:r}=yield e.read();if(n)break;const a=KR(r);this.handleSignalResponse(a)}})}close(){return L(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"Close method called on signal client";return(function*(){if([St.DISCONNECTING||St.DISCONNECTED].includes(e.state)){e.log.debug("ignoring signal close as it's already in disconnecting state");return}const r=yield e.closingLock.lock();try{if(e.clearPingInterval(),t&&(e.state=St.DISCONNECTING),e.ws){e.ws.close({closeCode:1e3,reason:n});const a=e.ws.closed;e.ws=void 0,e.streamWriter=void 0,yield Promise.race([a,Tn(l3)])}}catch(a){e.log.debug("websocket error while closing",Object.assign(Object.assign({},e.logContext),{error:a}))}finally{t&&(e.state=St.DISCONNECTED),r()}})()})}sendOffer(e,t){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:e.sdp})),this.sendRequest({case:"offer",value:Jo(e,t)})}sendAnswer(e,t){return this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:e.sdp})),this.sendRequest({case:"answer",value:Jo(e,t)})}sendIceCandidate(e,t){return this.log.debug("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:e})),this.sendRequest({case:"trickle",value:new Vf({candidateInit:JSON.stringify(e),target:t})})}sendMuteTrack(e,t){return this.sendRequest({case:"mute",value:new Kf({sid:e,muted:t})})}sendAddTrack(e){return this.sendRequest({case:"addTrack",value:e})}sendUpdateLocalMetadata(e,t){return L(this,arguments,void 0,function(n,r){var a=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return(function*(){const c=a.getNextRequestId();return yield a.sendRequest({case:"updateMetadata",value:new Ib({requestId:c,metadata:n,name:r,attributes:o})}),c})()})}sendUpdateTrackSettings(e){this.sendRequest({case:"trackSetting",value:e})}sendUpdateSubscription(e){return this.sendRequest({case:"subscription",value:e})}sendSyncState(e){return this.sendRequest({case:"syncState",value:e})}sendUpdateVideoLayers(e,t){return this.sendRequest({case:"updateLayers",value:new ZI({trackSid:e,layers:t})})}sendUpdateSubscriptionPermissions(e,t){return this.sendRequest({case:"subscriptionPermission",value:new nO({allParticipants:e,trackPermissions:t})})}sendSimulateScenario(e){return this.sendRequest({case:"simulate",value:e})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:Pt.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new aO({timestamp:Pt.parse(Date.now()),rtt:Pt.parse(this.rtt)})})])}sendUpdateLocalAudioTrack(e,t){return this.sendRequest({case:"updateAudioTrack",value:new wb({trackSid:e,features:t})})}sendLeave(){return this.sendRequest({case:"leave",value:new Gf({reason:Hi.CLIENT_INITIATED,action:nl.DISCONNECT})})}sendRequest(e){return L(this,arguments,void 0,function(t){var n=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return(function*(){if(!r&&!o3(t)&&n.state===St.RECONNECTING){n.queuedRequests.push(()=>L(n,void 0,void 0,function*(){yield this.sendRequest(t,!0)}));return}if(r||(yield n.requestQueue.flush()),n.signalLatency&&(yield Tn(n.signalLatency)),n.isDisconnected){n.log.debug("skipping signal request (type: ".concat(t.case,") - SignalClient disconnected"));return}if(!n.streamWriter){n.log.error("cannot send signal request before connected, type: ".concat(t?.case),n.logContext);return}const o=new pB({message:t});try{n.useJSON?yield n.streamWriter.write(o.toJsonString()):yield n.streamWriter.write(o.toBinary())}catch(c){n.log.error("error sending signal message",Object.assign(Object.assign({},n.logContext),{error:c}))}})()})}handleSignalResponse(e){var t,n;const r=e.message;if(r==null){this.log.debug("received unsupported message",this.logContext);return}let a=!1;if(r.case==="answer"){const o=HR(r.value);this.onAnswer&&this.onAnswer(o,r.value.id,r.value.midToTrackId)}else if(r.case==="offer"){const o=HR(r.value);this.onOffer&&this.onOffer(o,r.value.id,r.value.midToTrackId)}else if(r.case==="trickle"){const o=JSON.parse(r.value.candidateInit);this.onTrickle&&this.onTrickle(o,r.value.target)}else r.case==="update"?this.onParticipantUpdate&&this.onParticipantUpdate((t=r.value.participants)!==null&&t!==void 0?t:[]):r.case==="trackPublished"?this.onLocalTrackPublished&&this.onLocalTrackPublished(r.value):r.case==="speakersChanged"?this.onSpeakersChanged&&this.onSpeakersChanged((n=r.value.speakers)!==null&&n!==void 0?n:[]):r.case==="leave"?this.onLeave&&this.onLeave(r.value):r.case==="mute"?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(r.value.sid,r.value.muted):r.case==="roomUpdate"?this.onRoomUpdate&&r.value.room&&this.onRoomUpdate(r.value.room):r.case==="connectionQuality"?this.onConnectionQuality&&this.onConnectionQuality(r.value):r.case==="streamStateUpdate"?this.onStreamStateUpdate&&this.onStreamStateUpdate(r.value):r.case==="subscribedQualityUpdate"?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(r.value):r.case==="subscriptionPermissionUpdate"?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(r.value):r.case==="refreshToken"?this.onTokenRefresh&&this.onTokenRefresh(r.value):r.case==="trackUnpublished"?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(r.value):r.case==="subscriptionResponse"?this.onSubscriptionError&&this.onSubscriptionError(r.value):r.case==="pong"||(r.case==="pongResp"?(this.rtt=Date.now()-Number.parseInt(r.value.lastPingTimestamp.toString()),this.resetPingTimeout(),a=!0):r.case==="requestResponse"?this.onRequestResponse&&this.onRequestResponse(r.value):r.case==="trackSubscribed"?this.onLocalTrackSubscribed&&this.onLocalTrackSubscribed(r.value.trackSid):r.case==="roomMoved"?(this.onTokenRefresh&&this.onTokenRefresh(r.value.token),this.onRoomMoved&&this.onRoomMoved(r.value)):r.case==="mediaSectionsRequirement"?this.onMediaSectionsRequirement&&this.onMediaSectionsRequirement(r.value):this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:r.case})));a||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){const e=this.queuedRequests.shift();e&&this.requestQueue.run(e)}}handleOnClose(e){return L(this,void 0,void 0,function*(){if(this.state===St.DISCONNECTED)return;const t=this.onClose;yield this.close(void 0,e),this.log.debug("websocket connection closed: ".concat(e),Object.assign(Object.assign({},this.logContext),{reason:e})),t&&t(e)})}handleWSError(e){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:e}))}resetPingTimeout(){if(this.clearPingTimeout(),!this.pingTimeoutDuration){this.log.warn("ping timeout duration not set",this.logContext);return}this.pingTimeout=En.setTimeout(()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-this.pingTimeoutDuration*1e3).toUTCString()),this.logContext),this.handleOnClose("ping timeout")},this.pingTimeoutDuration*1e3)}clearPingTimeout(){this.pingTimeout&&En.clearTimeout(this.pingTimeout)}startPingInterval(){if(this.clearPingInterval(),this.resetPingTimeout(),!this.pingIntervalDuration){this.log.warn("ping interval duration not set",this.logContext);return}this.log.debug("start ping interval",this.logContext),this.pingInterval=En.setInterval(()=>{this.sendPing()},this.pingIntervalDuration*1e3)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext),this.clearPingTimeout(),this.pingInterval&&En.clearInterval(this.pingInterval)}handleSignalConnected(e,t,n){this.state=St.CONNECTED,clearTimeout(t),this.startPingInterval(),this.startReadingLoop(e.readable.getReader(),n)}validateFirstMessage(e,t){var n,r,a,o,c;return((n=e.message)===null||n===void 0?void 0:n.case)==="join"?{isValid:!0,response:e.message.value}:this.state===St.RECONNECTING&&((r=e.message)===null||r===void 0?void 0:r.case)!=="leave"?((a=e.message)===null||a===void 0?void 0:a.case)==="reconnect"?{isValid:!0,response:e.message.value}:(this.log.debug("declaring signal reconnected without reconnect response received",this.logContext),{isValid:!0,response:void 0,shouldProcessFirstMessage:!0}):this.isEstablishingConnection&&((o=e.message)===null||o===void 0?void 0:o.case)==="leave"?{isValid:!1,error:new Qe("Received leave request while trying to (re)connect",Le.LeaveRequest,void 0,e.message.value.reason)}:t?{isValid:!1,error:new Qe("Unexpected first message",Le.InternalError)}:{isValid:!1,error:new Qe("did not receive join response, got ".concat((c=e.message)===null||c===void 0?void 0:c.case," instead"),Le.InternalError)}}handleConnectionError(e,t){return L(this,void 0,void 0,function*(){try{const n=yield fetch(t);if(n.status.toFixed(0).startsWith("4")){const r=yield n.text();return new Qe(r,Le.NotAllowed,n.status)}else return e instanceof Qe?e:new Qe("Encountered unknown websocket error during connection: ".concat(e),Le.InternalError,n.status)}catch(n){return n instanceof Qe?n:new Qe(n instanceof Error?n.message:"server was not reachable",Le.ServerUnreachable)}})}}function HR(i){const e={type:"offer",sdp:i.sdp};switch(i.type){case"answer":case"offer":case"pranswer":case"rollback":e.type=i.type;break}return e}function Jo(i,e){return new Wa({sdp:i.sdp,type:i.type,id:e})}function c3(i,e,t){var n;const r=new URLSearchParams;return r.set("access_token",i),t.reconnect&&(r.set("reconnect","1"),t.sid&&r.set("sid",t.sid)),r.set("auto_subscribe",t.autoSubscribe?"1":"0"),r.set("sdk",ur()?"reactnative":"js"),r.set("version",e.version),r.set("protocol",e.protocol.toString()),e.deviceModel&&r.set("device_model",e.deviceModel),e.os&&r.set("os",e.os),e.osVersion&&r.set("os_version",e.osVersion),e.browser&&r.set("browser",e.browser),e.browserVersion&&r.set("browser_version",e.browserVersion),t.adaptiveStream&&r.set("adaptive_stream","1"),t.reconnectReason&&r.set("reconnect_reason",t.reconnectReason.toString()),!((n=navigator.connection)===null||n===void 0)&&n.type&&r.set("network",navigator.connection.type),r}function u3(i,e,t){const n=new URLSearchParams;n.set("access_token",i);const r=new BB({clientInfo:e,connectionSettings:new sO({autoSubscribe:!!t.autoSubscribe,adaptiveStream:!!t.adaptiveStream}),reconnect:!!t.reconnect,participantSid:t.sid?t.sid:void 0});t.reconnectReason&&(r.reconnectReason=t.reconnectReason);const a=new FB({joinRequest:r.toBinary()});return n.set("join_request",btoa(new TextDecoder("utf-8").decode(a.toBinary()))),n}class GR{constructor(){this.buffer=[],this._totalSize=0}push(e){this.buffer.push(e),this._totalSize+=e.data.byteLength}pop(){const e=this.buffer.shift();return e&&(this._totalSize-=e.data.byteLength),e}getAll(){return this.buffer.slice()}popToSequence(e){for(;this.buffer.length>0&&this.buffer[0].sequence<=e;)this.pop()}alignBufferedAmount(e){for(;this.buffer.length>0;){const t=this.buffer[0];if(this._totalSize-t.data.byteLength<=e)break;this.pop()}}get length(){return this.buffer.length}}class d3{constructor(e){this._map=new Map,this._lastCleanup=0,this.ttl=e}set(e,t){const n=Date.now();n-this._lastCleanup>this.ttl/2&&this.cleanup();const r=n+this.ttl;return this._map.set(e,{value:t,expiresAt:r}),this}get(e){const t=this._map.get(e);if(t){if(t.expiresAt<Date.now()){this._map.delete(e);return}return t.value}}has(e){const t=this._map.get(e);return t?t.expiresAt<Date.now()?(this._map.delete(e),!1):!0:!1}delete(e){return this._map.delete(e)}clear(){this._map.clear()}cleanup(){const e=Date.now();for(const[t,n]of this._map.entries())n.expiresAt<e&&this._map.delete(t);this._lastCleanup=e}get size(){return this.cleanup(),this._map.size}forEach(e){this.cleanup();for(const[t,n]of this._map.entries())n.expiresAt>=Date.now()&&e(n.value,t,this.asValueMap())}map(e){this.cleanup();const t=[],n=this.asValueMap();for(const[r,a]of n.entries())t.push(e(a,r,n));return t}asValueMap(){const e=new Map;for(const[t,n]of this._map.entries())n.expiresAt>=Date.now()&&e.set(t,n.value);return e}}var Li={},rg={},ag={exports:{}},zR;function Ub(){if(zR)return ag.exports;zR=1;var i=ag.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return e.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return e.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=e.raddr!=null?" raddr %s rport %d":"%v%v",t+=e.tcptype!=null?" tcptype %s":"%v",e.generation!=null&&(t+=" generation %d"),t+=e["network-id"]!=null?" network-id %d":"%v",t+=e["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return e.attribute!=null&&(t+=" %s",e.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return e.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(e.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=e.id!=null?"id=%s %s":"%v%s",t+=e.mediaClockValue!=null?"=%s":"",t+=e.rateNumerator!=null?" rate=%s":"",t+=e.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(i).forEach(function(e){var t=i[e];t.forEach(function(n){n.reg||(n.reg=/(.*)/),n.format||(n.format="%s")})}),ag.exports}var WR;function h3(){return WR||(WR=1,(function(i){var e=function(c){return String(Number(c))===c?Number(c):c},t=function(c,d,h,v){if(v&&!h)d[v]=e(c[1]);else for(var m=0;m<h.length;m+=1)c[m+1]!=null&&(d[h[m]]=e(c[m+1]))},n=function(c,d,h){var v=c.name&&c.names;c.push&&!d[c.push]?d[c.push]=[]:v&&!d[c.name]&&(d[c.name]={});var m=c.push?{}:v?d[c.name]:d;t(h.match(c.reg),m,c.names,c.name),c.push&&d[c.push].push(m)},r=Ub(),a=RegExp.prototype.test.bind(/^([a-z])=(.*)/);i.parse=function(c){var d={},h=[],v=d;return c.split(/(\r\n|\r|\n)/).filter(a).forEach(function(m){var y=m[0],E=m.slice(2);y==="m"&&(h.push({rtp:[],fmtp:[]}),v=h[h.length-1]);for(var T=0;T<(r[y]||[]).length;T+=1){var S=r[y][T];if(S.reg.test(E))return n(S,v,E)}}),d.media=h,d};var o=function(c,d){var h=d.split(/=(.+)/,2);return h.length===2?c[h[0]]=e(h[1]):h.length===1&&d.length>1&&(c[h[0]]=void 0),c};i.parseParams=function(c){return c.split(/;\s?/).reduce(o,{})},i.parseFmtpConfig=i.parseParams,i.parsePayloads=function(c){return c.toString().split(" ").map(Number)},i.parseRemoteCandidates=function(c){for(var d=[],h=c.split(" ").map(e),v=0;v<h.length;v+=3)d.push({component:h[v],ip:h[v+1],port:h[v+2]});return d},i.parseImageAttributes=function(c){return c.split(" ").map(function(d){return d.substring(1,d.length-1).split(",").reduce(o,{})})},i.parseSimulcastStreamList=function(c){return c.split(";").map(function(d){return d.split(",").map(function(h){var v,m=!1;return h[0]!=="~"?v=e(h):(v=e(h.substring(1,h.length)),m=!0),{scid:v,paused:m}})})}})(rg)),rg}var sg,JR;function f3(){if(JR)return sg;JR=1;var i=Ub(),e=/%[sdv%]/g,t=function(o){var c=1,d=arguments,h=d.length;return o.replace(e,function(v){if(c>=h)return v;var m=d[c];switch(c+=1,v){case"%%":return"%";case"%s":return String(m);case"%d":return Number(m);case"%v":return""}})},n=function(o,c,d){var h=c.format instanceof Function?c.format(c.push?d:d[c.name]):c.format,v=[o+"="+h];if(c.names)for(var m=0;m<c.names.length;m+=1){var y=c.names[m];c.name?v.push(d[c.name][y]):v.push(d[c.names[m]])}else v.push(d[c.name]);return t.apply(null,v)},r=["v","o","s","i","u","e","p","c","b","t","r","z","a"],a=["i","c","b","a"];return sg=function(o,c){c=c||{},o.version==null&&(o.version=0),o.name==null&&(o.name=" "),o.media.forEach(function(m){m.payloads==null&&(m.payloads="")});var d=c.outerOrder||r,h=c.innerOrder||a,v=[];return d.forEach(function(m){i[m].forEach(function(y){y.name in o&&o[y.name]!=null?v.push(n(m,y,o)):y.push in o&&o[y.push]!=null&&o[y.push].forEach(function(E){v.push(n(m,y,E))})})}),o.media.forEach(function(m){v.push(n("m",i.m[0],m)),h.forEach(function(y){i[y].forEach(function(E){E.name in m&&m[E.name]!=null?v.push(n(y,E,m)):E.push in m&&m[E.push]!=null&&m[E.push].forEach(function(T){v.push(n(y,E,T))})})})}),v.join(`\r
`)+`\r
`},sg}var YR;function v3(){if(YR)return Li;YR=1;var i=h3(),e=f3(),t=Ub();return Li.grammar=t,Li.write=e,Li.parse=i.parse,Li.parseParams=i.parseParams,Li.parseFmtpConfig=i.parseFmtpConfig,Li.parsePayloads=i.parsePayloads,Li.parseRemoteCandidates=i.parseRemoteCandidates,Li.parseImageAttributes=i.parseImageAttributes,Li.parseSimulcastStreamList=i.parseSimulcastStreamList,Li}var Ma=v3();function Bb(i,e,t){var n,r,a;e===void 0&&(e=50),t===void 0&&(t={});var o=(n=t.isImmediate)!=null&&n,c=(r=t.callback)!=null&&r,d=t.maxWait,h=Date.now(),v=[];function m(){if(d!==void 0){var E=Date.now()-h;if(E+e>=d)return d-E}return e}var y=function(){var E=[].slice.call(arguments),T=this;return new Promise(function(S,O){var R=o&&a===void 0;if(a!==void 0&&clearTimeout(a),a=setTimeout(function(){if(a=void 0,h=Date.now(),!o){var M=i.apply(T,E);c&&c(M),v.forEach(function(C){return(0,C.resolve)(M)}),v=[]}},m()),R){var I=i.apply(T,E);return c&&c(I),S(I)}v.push({resolve:S,reject:O})})};return y.cancel=function(E){a!==void 0&&clearTimeout(a),v.forEach(function(T){return(0,T.reject)(E)}),v=[]},y}const m3=.7,p3=20,sl={NegotiationStarted:"negotiationStarted",NegotiationComplete:"negotiationComplete",RTPVideoPayloadTypes:"rtpVideoPayloadTypes"};class $R extends vr.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var n;super(),this.log=Fe,this.ddExtID=0,this.latestOfferId=0,this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=Bb(r=>L(this,void 0,void 0,function*(){this.emit(sl.NegotiationStarted);try{yield this.createAndSendOffer()}catch(a){if(r)r(a);else throw a}}),p3),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.log=Xr((n=t.loggerName)!==null&&n!==void 0?n:Wi.PCTransport),this.loggerOptions=t,this.config=e,this._pc=this.createPC(),this.offerLock=new An}createPC(){const e=new RTCPeerConnection(this.config);return e.onicecandidate=t=>{var n;t.candidate&&((n=this.onIceCandidate)===null||n===void 0||n.call(this,t.candidate))},e.onicecandidateerror=t=>{var n;(n=this.onIceCandidateError)===null||n===void 0||n.call(this,t)},e.oniceconnectionstatechange=()=>{var t;(t=this.onIceConnectionStateChange)===null||t===void 0||t.call(this,e.iceConnectionState)},e.onsignalingstatechange=()=>{var t;(t=this.onSignalingStatechange)===null||t===void 0||t.call(this,e.signalingState)},e.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,e.connectionState)},e.ondatachannel=t=>{var n;(n=this.onDataChannel)===null||n===void 0||n.call(this,t)},e.ontrack=t=>{var n;(n=this.onTrack)===null||n===void 0||n.call(this,t)},e}get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions).loggerContextCb)===null||t===void 0?void 0:t.call(e))}get isICEConnected(){return this._pc!==null&&(this.pc.iceConnectionState==="connected"||this.pc.iceConnectionState==="completed")}addIceCandidate(e){return L(this,void 0,void 0,function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate(e);this.pendingCandidates.push(e)})}setRemoteDescription(e,t){return L(this,void 0,void 0,function*(){var n;if(e.type==="answer"&&this.latestOfferId>0&&t>0&&t!==this.latestOfferId)return this.log.warn("ignoring answer for old offer",Object.assign(Object.assign({},this.logContext),{offerId:t,latestOfferId:this.latestOfferId})),!1;let r;if(e.type==="offer"){let{stereoMids:a,nackMids:o}=g3(e);this.remoteStereoMids=a,this.remoteNackMids=o}else if(e.type==="answer"){const a=Ma.parse((n=e.sdp)!==null&&n!==void 0?n:"");a.media.forEach(o=>{const c=Fb(o.mid);o.type==="audio"&&this.trackBitrates.some(d=>{if(!d.transceiver||c!=d.transceiver.mid)return!1;let h=0;if(o.rtp.some(m=>m.codec.toUpperCase()===d.codec.toUpperCase()?(h=m.payload,!0):!1),h===0)return!0;let v=!1;for(const m of o.fmtp)if(m.payload===h){m.config=m.config.split(";").filter(y=>!y.includes("maxaveragebitrate")).join(";"),d.maxbr>0&&(m.config+=";maxaveragebitrate=".concat(d.maxbr*1e3)),v=!0;break}return v||d.maxbr>0&&o.fmtp.push({payload:h,config:"maxaveragebitrate=".concat(d.maxbr*1e3)}),!0})}),r=Ma.write(a)}return yield this.setMungedSDP(e,r,!0),this.pendingCandidates.forEach(a=>{this.pc.addIceCandidate(a)}),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate?(this.renegotiate=!1,yield this.createAndSendOffer()):e.type==="answer"&&(this.emit(sl.NegotiationComplete),e.sdp&&Ma.parse(e.sdp).media.forEach(o=>{o.type==="video"&&this.emit(sl.RTPVideoPayloadTypes,o.rtp)})),!0})}createAndSendOffer(e){return L(this,void 0,void 0,function*(){var t;const n=yield this.offerLock.lock();try{if(this.onOffer===void 0)return;if(e?.iceRestart&&(this.log.debug("restarting ICE",this.logContext),this.restartingIce=!0),this._pc&&this._pc.signalingState==="have-local-offer"){const c=this._pc.remoteDescription;if(e?.iceRestart&&c)yield this._pc.setRemoteDescription(c);else{this.renegotiate=!0;return}}else if(!this._pc||this._pc.signalingState==="closed"){this.log.warn("could not createOffer with closed peer connection",this.logContext);return}this.log.debug("starting to negotiate",this.logContext);const r=this.latestOfferId+1;this.latestOfferId=r;const a=yield this.pc.createOffer(e);this.log.debug("original offer",Object.assign({sdp:a.sdp},this.logContext));const o=Ma.parse((t=a.sdp)!==null&&t!==void 0?t:"");if(o.media.forEach(c=>{QR(c),c.type==="audio"?XR(c,["all"],[]):c.type==="video"&&this.trackBitrates.some(d=>{if(!c.msid||!d.cid||!c.msid.includes(d.cid))return!1;let h=0;if(c.rtp.some(m=>m.codec.toUpperCase()===d.codec.toUpperCase()?(h=m.payload,!0):!1),h===0||(Ki(d.codec)&&!Vs()&&this.ensureVideoDDExtensionForSVC(c,o),!Ki(d.codec)))return!0;const v=Math.round(d.maxbr*m3);for(const m of c.fmtp)if(m.payload===h){m.config.includes("x-google-start-bitrate")||(m.config+=";x-google-start-bitrate=".concat(v));break}return!0})}),this.latestOfferId>r){this.log.warn("latestOfferId mismatch",Object.assign(Object.assign({},this.logContext),{latestOfferId:this.latestOfferId,offerId:r}));return}yield this.setMungedSDP(a,Ma.write(o)),this.onOffer(a,this.latestOfferId)}finally{n()}})}createAndSetAnswer(){return L(this,void 0,void 0,function*(){var e;const t=yield this.pc.createAnswer(),n=Ma.parse((e=t.sdp)!==null&&e!==void 0?e:"");return n.media.forEach(r=>{QR(r),r.type==="audio"&&XR(r,this.remoteStereoMids,this.remoteNackMids)}),yield this.setMungedSDP(t,Ma.write(n)),t})}createDataChannel(e,t){return this.pc.createDataChannel(e,t)}addTransceiver(e,t){return this.pc.addTransceiver(e,t)}addTransceiverOfKind(e,t){return this.pc.addTransceiver(e,t)}addTrack(e){if(!this._pc)throw new Zt("PC closed, cannot add track");return this._pc.addTrack(e)}setTrackCodecBitrate(e){this.trackBitrates.push(e)}setConfiguration(e){var t;if(!this._pc)throw new Zt("PC closed, cannot configure");return(t=this._pc)===null||t===void 0?void 0:t.setConfiguration(e)}canRemoveTrack(){var e;return!!(!((e=this._pc)===null||e===void 0)&&e.removeTrack)}removeTrack(e){var t;return(t=this._pc)===null||t===void 0?void 0:t.removeTrack(e)}getConnectionState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.connectionState)!==null&&t!==void 0?t:"closed"}getICEConnectionState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.iceConnectionState)!==null&&t!==void 0?t:"closed"}getSignallingState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.signalingState)!==null&&t!==void 0?t:"closed"}getTransceivers(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.getTransceivers())!==null&&t!==void 0?t:[]}getSenders(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.getSenders())!==null&&t!==void 0?t:[]}getLocalDescription(){var e;return(e=this._pc)===null||e===void 0?void 0:e.localDescription}getRemoteDescription(){var e;return(e=this.pc)===null||e===void 0?void 0:e.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return L(this,void 0,void 0,function*(){var e;if(!this._pc)return;let t="";const n=new Map,r=new Map;if((yield this._pc.getStats()).forEach(c=>{switch(c.type){case"transport":t=c.selectedCandidatePairId;break;case"candidate-pair":t===""&&c.selected&&(t=c.id),n.set(c.id,c);break;case"remote-candidate":r.set(c.id,"".concat(c.address,":").concat(c.port));break}}),t==="")return;const o=(e=n.get(t))===null||e===void 0?void 0:e.remoteCandidateId;if(o!==void 0)return r.get(o)})}setMungedSDP(e,t,n){return L(this,void 0,void 0,function*(){if(t){const r=e.sdp;e.sdp=t;try{this.log.debug("setting munged ".concat(n?"remote":"local"," description"),this.logContext),n?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e);return}catch(a){this.log.warn("not able to set ".concat(e.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:a,sdp:t})),e.sdp=r}}try{n?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e)}catch(r){let a="unknown error";r instanceof Error?a=r.message:typeof r=="string"&&(a=r);const o={error:a,sdp:e.sdp};throw!n&&this.pc.remoteDescription&&(o.remoteSdp=this.pc.remoteDescription),this.log.error("unable to set ".concat(e.type),Object.assign(Object.assign({},this.logContext),{fields:o})),new by(a)}})}ensureVideoDDExtensionForSVC(e,t){var n,r;if(!((n=e.ext)===null||n===void 0?void 0:n.some(o=>o.uri===xR))){if(this.ddExtID===0){let o=0;t.media.forEach(c=>{var d;c.type==="video"&&((d=c.ext)===null||d===void 0||d.forEach(h=>{h.value>o&&(o=h.value)}))}),this.ddExtID=o+1}(r=e.ext)===null||r===void 0||r.push({value:this.ddExtID,uri:xR})}}}function XR(i,e,t){const n=Fb(i.mid);let r=0;i.rtp.some(a=>a.codec==="opus"?(r=a.payload,!0):!1),r>0&&(i.rtcpFb||(i.rtcpFb=[]),t.includes(n)&&!i.rtcpFb.some(a=>a.payload===r&&a.type==="nack")&&i.rtcpFb.push({payload:r,type:"nack"}),(e.includes(n)||e.length===1&&e[0]==="all")&&i.fmtp.some(a=>a.payload===r?(a.config.includes("stereo=1")||(a.config+=";stereo=1"),!0):!1))}function g3(i){var e;const t=[],n=[],r=Ma.parse((e=i.sdp)!==null&&e!==void 0?e:"");let a=0;return r.media.forEach(o=>{var c;const d=Fb(o.mid);o.type==="audio"&&(o.rtp.some(h=>h.codec==="opus"?(a=h.payload,!0):!1),!((c=o.rtcpFb)===null||c===void 0)&&c.some(h=>h.payload===a&&h.type==="nack")&&n.push(d),o.fmtp.some(h=>h.payload===a?(h.config.includes("sprop-stereo=1")&&t.push(d),!0):!1))}),{stereoMids:t,nackMids:n}}function QR(i){if(i.connection){const e=i.connection.ip.indexOf(":")>=0;(i.connection.version===4&&e||i.connection.version===6&&!e)&&(i.connection.ip="0.0.0.0",i.connection.version=4)}}function Fb(i){return typeof i=="number"?i.toFixed(0):i}const Iy="vp8",y3={audioPreset:Sy.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:Nb.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:Iy,backupCodec:!0,preConnectBuffer:!1},JO={deviceId:{ideal:"default"},autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,voiceIsolation:!0},YO={deviceId:{ideal:"default"},resolution:Eu.h720.resolution},b3={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new WB,disconnectOnPageLeave:!0,webAudioMix:!1,singlePeerConnection:!1},jb={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var Ut;(function(i){i[i.NEW=0]="NEW",i[i.CONNECTING=1]="CONNECTING",i[i.CONNECTED=2]="CONNECTED",i[i.FAILED=3]="FAILED",i[i.CLOSING=4]="CLOSING",i[i.CLOSED=5]="CLOSED"})(Ut||(Ut={}));class S3{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor(e,t,n){var r;this.peerConnectionTimeout=jb.peerConnectionTimeout,this.log=Fe,this.updateState=()=>{var a,o;const c=this.state,d=this.requiredTransports.map(h=>h.getConnectionState());d.every(h=>h==="connected")?this.state=Ut.CONNECTED:d.some(h=>h==="failed")?this.state=Ut.FAILED:d.some(h=>h==="connecting")?this.state=Ut.CONNECTING:d.every(h=>h==="closed")?this.state=Ut.CLOSED:d.some(h=>h==="closed")?this.state=Ut.CLOSING:d.every(h=>h==="new")&&(this.state=Ut.NEW),c!==this.state&&(this.log.debug("pc state change: from ".concat(Ut[c]," to ").concat(Ut[this.state]),this.logContext),(a=this.onStateChange)===null||a===void 0||a.call(this,this.state,this.publisher.getConnectionState(),(o=this.subscriber)===null||o===void 0?void 0:o.getConnectionState()))},this.log=Xr((r=n.loggerName)!==null&&r!==void 0?r:Wi.PCManager),this.loggerOptions=n,this.isPublisherConnectionRequired=t!=="subscriber-primary",this.isSubscriberConnectionRequired=t==="subscriber-primary",this.publisher=new $R(e,n),t!=="publisher-only"&&(this.subscriber=new $R(e,n),this.subscriber.onConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.subscriber.onIceCandidate=a=>{var o;(o=this.onIceCandidate)===null||o===void 0||o.call(this,a,Vi.SUBSCRIBER)},this.subscriber.onDataChannel=a=>{var o;(o=this.onDataChannel)===null||o===void 0||o.call(this,a)},this.subscriber.onTrack=a=>{var o;(o=this.onTrack)===null||o===void 0||o.call(this,a)}),this.publisher.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=a=>{var o;(o=this.onIceCandidate)===null||o===void 0||o.call(this,a,Vi.PUBLISHER)},this.publisher.onTrack=a=>{var o;(o=this.onTrack)===null||o===void 0||o.call(this,a)},this.publisher.onOffer=(a,o)=>{var c;(c=this.onPublisherOffer)===null||c===void 0||c.call(this,a,o)},this.state=Ut.NEW,this.connectionLock=new An,this.remoteOfferLock=new An}get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions).loggerContextCb)===null||t===void 0?void 0:t.call(e))}requirePublisher(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isPublisherConnectionRequired=e,this.updateState()}createAndSendPublisherOffer(e){return this.publisher.createAndSendOffer(e)}setPublisherAnswer(e,t){return this.publisher.setRemoteDescription(e,t)}removeTrack(e){return this.publisher.removeTrack(e)}close(){return L(this,void 0,void 0,function*(){var e;if(this.publisher&&this.publisher.getSignallingState()!=="closed"){const t=this.publisher;for(const n of t.getSenders())try{t.canRemoveTrack()&&t.removeTrack(n)}catch(r){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:r}))}}yield Promise.all([this.publisher.close(),(e=this.subscriber)===null||e===void 0?void 0:e.close()]),this.updateState()})}triggerIceRestart(){return L(this,void 0,void 0,function*(){this.subscriber&&(this.subscriber.restartingIce=!0),this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))})}addIceCandidate(e,t){return L(this,void 0,void 0,function*(){var n;t===Vi.PUBLISHER?yield this.publisher.addIceCandidate(e):yield(n=this.subscriber)===null||n===void 0?void 0:n.addIceCandidate(e)})}createSubscriberAnswerFromOffer(e,t){return L(this,void 0,void 0,function*(){var n,r,a;this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,signalingState:(n=this.subscriber)===null||n===void 0?void 0:n.getSignallingState().toString()}));const o=yield this.remoteOfferLock.lock();try{return(yield(r=this.subscriber)===null||r===void 0?void 0:r.setRemoteDescription(e,t))?yield(a=this.subscriber)===null||a===void 0?void 0:a.createAndSetAnswer():void 0}finally{o()}})}updateConfiguration(e,t){var n;this.publisher.setConfiguration(e),(n=this.subscriber)===null||n===void 0||n.setConfiguration(e),t&&this.triggerIceRestart()}ensurePCTransportConnection(e,t){return L(this,void 0,void 0,function*(){var n;const r=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&this.publisher.getConnectionState()!=="connected"&&this.publisher.getConnectionState()!=="connecting"&&(this.log.debug("negotiation required, start negotiating",this.logContext),this.publisher.negotiate()),yield Promise.all((n=this.requiredTransports)===null||n===void 0?void 0:n.map(a=>this.ensureTransportConnected(a,e,t)))}finally{r()}})}negotiate(e){return L(this,void 0,void 0,function*(){return new Promise((t,n)=>L(this,void 0,void 0,function*(){const r=setTimeout(()=>{n("negotiation timed out")},this.peerConnectionTimeout),a=()=>{clearTimeout(r),n("negotiation aborted")};e.signal.addEventListener("abort",a),this.publisher.once(sl.NegotiationStarted,()=>{e.signal.aborted||this.publisher.once(sl.NegotiationComplete,()=>{clearTimeout(r),t()})}),yield this.publisher.negotiate(o=>{clearTimeout(r),n(o)})}))})}addPublisherTransceiver(e,t){return this.publisher.addTransceiver(e,t)}addPublisherTransceiverOfKind(e,t){return this.publisher.addTransceiverOfKind(e,t)}getMidForReceiver(e){const n=(this.subscriber?this.subscriber.getTransceivers():this.publisher.getTransceivers()).find(r=>r.receiver===e);return n?.mid}addPublisherTrack(e){return this.publisher.addTrack(e)}createPublisherDataChannel(e,t){return this.publisher.createDataChannel(e,t)}getConnectedAddress(e){return e===Vi.PUBLISHER?this.publisher.getConnectedAddress():e===Vi.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const e=[];return this.isPublisherConnectionRequired&&e.push(this.publisher),this.isSubscriberConnectionRequired&&this.subscriber&&e.push(this.subscriber),e}ensureTransportConnected(e,t){return L(this,arguments,void 0,function(n,r){var a=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.peerConnectionTimeout;return(function*(){if(n.getConnectionState()!=="connected")return new Promise((d,h)=>L(a,void 0,void 0,function*(){const v=()=>{this.log.warn("abort transport connection",this.logContext),En.clearTimeout(m),h(new Qe("room connection has been cancelled",Le.Cancelled))};r?.signal.aborted&&v(),r?.signal.addEventListener("abort",v);const m=En.setTimeout(()=>{r?.signal.removeEventListener("abort",v),h(new Qe("could not establish pc connection",Le.InternalError))},o);for(;this.state!==Ut.CONNECTED;)if(yield Tn(50),r?.signal.aborted){h(new Qe("room connection has been cancelled",Le.Cancelled));return}En.clearTimeout(m),r?.signal.removeEventListener("abort",v),d()}))})()})}}const $O=5e3,E3=3e4;class st{static fetchRegionSettings(e,t,n){return L(this,void 0,void 0,function*(){const r=yield st.fetchLock.lock();try{const a=yield fetch("".concat(T3(e),"/regions"),{headers:{authorization:"Bearer ".concat(t)},signal:n});if(a.ok){const o=KF(a.headers),c=o?o*1e3:$O;return{regionSettings:yield a.json(),updatedAtInMs:Date.now(),maxAgeInMs:c}}else throw new Qe("Could not fetch region settings: ".concat(a.statusText),a.status===401?Le.NotAllowed:Le.InternalError,a.status)}catch(a){throw a instanceof Qe?a:n?.aborted?new Qe("Region fetching was aborted",Le.Cancelled):new Qe("Could not fetch region settings, ".concat(a instanceof Error?"".concat(a.name,": ").concat(a.message):a),Le.ServerUnreachable,500)}finally{r()}})}static scheduleRefetch(e,t,n){return L(this,void 0,void 0,function*(){const r=st.settingsTimeouts.get(e.hostname);clearTimeout(r),st.settingsTimeouts.set(e.hostname,setTimeout(()=>L(this,void 0,void 0,function*(){try{const a=yield st.fetchRegionSettings(e,t);st.updateCachedRegionSettings(e,t,a)}catch(a){if(a instanceof Qe&&a.reason===Le.NotAllowed){Fe.debug("token is not valid, cancelling auto region refresh");return}Fe.debug("auto refetching of region settings failed",{error:a}),st.scheduleRefetch(e,t,n)}}),n))})}static updateCachedRegionSettings(e,t,n){st.cache.set(e.hostname,n),st.scheduleRefetch(e,t,n.maxAgeInMs)}static stopRefetch(e){const t=st.settingsTimeouts.get(e);t&&(clearTimeout(t),st.settingsTimeouts.delete(e))}static scheduleCleanup(e){let t=st.connectionTrackers.get(e);t&&(t.cleanupTimeout&&clearTimeout(t.cleanupTimeout),t.cleanupTimeout=setTimeout(()=>{const n=st.connectionTrackers.get(e);n&&n.connectionCount===0&&(Fe.debug("stopping region refetch after disconnect delay",{hostname:e}),st.stopRefetch(e)),n&&(n.cleanupTimeout=void 0)},E3))}static cancelCleanup(e){const t=st.connectionTrackers.get(e);t?.cleanupTimeout&&(clearTimeout(t.cleanupTimeout),t.cleanupTimeout=void 0)}notifyConnected(){const e=this.serverUrl.hostname;let t=st.connectionTrackers.get(e);t||(t={connectionCount:0},st.connectionTrackers.set(e,t)),t.connectionCount++,st.cancelCleanup(e)}notifyDisconnected(){const e=this.serverUrl.hostname,t=st.connectionTrackers.get(e);t&&(t.connectionCount=Math.max(0,t.connectionCount-1),t.connectionCount===0&&st.scheduleCleanup(e))}constructor(e,t){this.attemptedRegions=[],this.serverUrl=new URL(e),this.token=t}updateToken(e){this.token=e}isCloud(){return ff(this.serverUrl)}getServerUrl(){return this.serverUrl}fetchRegionSettings(e){return L(this,void 0,void 0,function*(){return st.fetchRegionSettings(this.serverUrl,this.token,e)})}getNextBestRegionUrl(e){return L(this,void 0,void 0,function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");let t=st.cache.get(this.serverUrl.hostname);(!t||Date.now()-t.updatedAtInMs>t.maxAgeInMs)&&(t=yield this.fetchRegionSettings(e),st.updateCachedRegionSettings(this.serverUrl,this.token,t));const n=t.regionSettings.regions.filter(r=>!this.attemptedRegions.find(a=>a.url===r.url));if(n.length>0){const r=n[0];return this.attemptedRegions.push(r),Fe.debug("next region: ".concat(r.region)),r.url}else return null})}resetAttempts(){this.attemptedRegions=[]}setServerReportedRegions(e){st.updateCachedRegionSettings(this.serverUrl,this.token,e)}}st.cache=new Map;st.settingsTimeouts=new Map;st.connectionTrackers=new Map;st.fetchLock=new An;function T3(i){return"".concat(i.protocol.replace("ws","http"),"//").concat(i.host,"/settings")}class Ft extends Error{constructor(e,t,n){super(t),this.code=e,this.message=ZR(t,Ft.MAX_MESSAGE_BYTES),this.data=n?ZR(n,Ft.MAX_DATA_BYTES):void 0}static fromProto(e){return new Ft(e.code,e.message,e.data)}toProto(){return new qI({code:this.code,message:this.message,data:this.data})}static builtIn(e,t){return new Ft(Ft.ErrorCode[e],Ft.ErrorMessage[e],t)}}Ft.MAX_MESSAGE_BYTES=256;Ft.MAX_DATA_BYTES=15360;Ft.ErrorCode={APPLICATION_ERROR:1500,CONNECTION_TIMEOUT:1501,RESPONSE_TIMEOUT:1502,RECIPIENT_DISCONNECTED:1503,RESPONSE_PAYLOAD_TOO_LARGE:1504,SEND_FAILED:1505,UNSUPPORTED_METHOD:1400,RECIPIENT_NOT_FOUND:1401,REQUEST_PAYLOAD_TOO_LARGE:1402,UNSUPPORTED_SERVER:1403,UNSUPPORTED_VERSION:1404};Ft.ErrorMessage={APPLICATION_ERROR:"Application error in method handler",CONNECTION_TIMEOUT:"Connection timeout",RESPONSE_TIMEOUT:"Response timeout",RECIPIENT_DISCONNECTED:"Recipient disconnected",RESPONSE_PAYLOAD_TOO_LARGE:"Response payload too large",SEND_FAILED:"Failed to send",UNSUPPORTED_METHOD:"Method not supported at destination",RECIPIENT_NOT_FOUND:"Recipient not found",REQUEST_PAYLOAD_TOO_LARGE:"Request payload too large",UNSUPPORTED_SERVER:"RPC not supported by server",UNSUPPORTED_VERSION:"Unsupported RPC version"};const XO=15360;function qb(i){return new TextEncoder().encode(i).length}function ZR(i,e){if(qb(i)<=e)return i;let t=0,n=i.length;const r=new TextEncoder;for(;t<n;){const a=Math.floor((t+n+1)/2);r.encode(i.slice(0,a)).length<=e?t=a:n=a-1}return i.slice(0,t)}const Vb=2e3;function zf(i,e){if(!e)return 0;let t,n;return"bytesReceived"in i?(t=i.bytesReceived,n=e.bytesReceived):"bytesSent"in i&&(t=i.bytesSent,n=e.bytesSent),t===void 0||n===void 0||i.timestamp===void 0||e.timestamp===void 0?0:(t-n)*8*1e3/(i.timestamp-e.timestamp)}const Kb=typeof MediaRecorder<"u";class _3{constructor(){throw new Error("MediaRecorder is not available in this environment")}}const C3=Kb?MediaRecorder:_3;class R3 extends C3{constructor(e,t){if(!Kb)throw new Error("MediaRecorder is not available in this environment");super(new MediaStream([e.mediaStreamTrack]),t);let n,r;const a=()=>r===void 0,o=()=>{this.removeEventListener("dataavailable",n),this.removeEventListener("stop",o),this.removeEventListener("error",c),r?.close(),r=void 0},c=d=>{r?.error(d),this.removeEventListener("dataavailable",n),this.removeEventListener("stop",o),this.removeEventListener("error",c),r=void 0};this.byteStream=new ReadableStream({start:d=>{r=d,n=h=>L(this,void 0,void 0,function*(){let v;if(h.data.arrayBuffer){const m=yield h.data.arrayBuffer();v=new Uint8Array(m)}else if(h.data.byteArray)v=h.data.byteArray;else throw new Error("no data available!");a()||d.enqueue(v)}),this.addEventListener("dataavailable",n)},cancel:()=>{o()}}),this.addEventListener("stop",o),this.addEventListener("error",c)}}function k3(){return Kb}const w3=1e3,I3=1e4;class QO extends se{get sender(){return this._sender}set sender(e){this._sender=e}get constraints(){return this._constraints}get hasPreConnectBuffer(){return!!this.localTrackRecorder}constructor(e,t,n){let r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,a=arguments.length>4?arguments[4]:void 0;super(e,t,a),this.manuallyStopped=!1,this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch(()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)),this.debouncedTrackMuteHandler=Bb(()=>L(this,void 0,void 0,function*(){yield this.pauseUpstream()}),5e3),this.handleTrackUnmuteEvent=()=>L(this,void 0,void 0,function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()}),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(ue.Ended,this)},this.reacquireTrack=!1,this.providedByUser=r,this.muteLock=new An,this.pauseUpstreamLock=new An,this.trackChangeLock=new An,this.trackChangeLock.lock().then(o=>L(this,void 0,void 0,function*(){try{yield this.setMediaStreamTrack(e,!0)}finally{o()}})),this._constraints=e.getConstraints(),n&&(this._constraints=n)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==se.Kind.Video)return;const{width:e,height:t}=this._mediaStreamTrack.getSettings();if(e&&t)return{width:e,height:t}}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var e,t;return(t=(e=this.processor)===null||e===void 0?void 0:e.processedTrack)!==null&&t!==void 0?t:this._mediaStreamTrack}get isLocal(){return!0}getSourceTrackSettings(){return this._mediaStreamTrack.getSettings()}setMediaStreamTrack(e,t){return L(this,void 0,void 0,function*(){var n;if(e===this._mediaStreamTrack&&!t)return;this._mediaStreamTrack&&(this.attachedElements.forEach(a=>{rl(this._mediaStreamTrack,a)}),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)),this.mediaStream=new MediaStream([e]),e&&(e.addEventListener("ended",this.handleEnded),e.addEventListener("mute",this.handleTrackMuteEvent),e.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=e.getConstraints());let r;if(this.processor&&e){if(this.log.debug("restarting processor",this.logContext),this.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");this.processorElement&&(Wo(e,this.processorElement),this.processorElement.muted=!0),yield this.processor.restart({track:e,kind:this.kind,element:this.processorElement}),r=this.processor.processedTrack}this.sender&&((n=this.sender.transport)===null||n===void 0?void 0:n.state)!=="closed"&&(yield this.sender.replaceTrack(r??e)),!this.providedByUser&&this._mediaStreamTrack!==e&&this._mediaStreamTrack.stop(),this._mediaStreamTrack=e,e&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach(a=>{Wo(r??e,a)}))})}waitForDimensions(){return L(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:w3;return(function*(){var n;if(e.kind===se.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");((n=zn())===null||n===void 0?void 0:n.os)==="iOS"&&(yield Tn(10));const r=Date.now();for(;Date.now()-r<t;){const a=e.dimensions;if(a)return a;yield Tn(50)}throw new Gr("unable to get track dimensions after timeout")})()})}setDeviceId(e){return L(this,void 0,void 0,function*(){return this._constraints.deviceId===e&&this._mediaStreamTrack.getSettings().deviceId===Ha(e)||(this._constraints.deviceId=e,this.isMuted)?!0:(yield this.restartTrack(),Ha(e)===this._mediaStreamTrack.getSettings().deviceId)})}getDeviceId(){return L(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){if(e.source===se.Source.ScreenShare)return;const{deviceId:n,groupId:r}=e._mediaStreamTrack.getSettings(),a=e.kind===se.Kind.Audio?"audioinput":"videoinput";return t?hn.getInstance().normalizeDeviceId(a,n,r):n})()})}mute(){return L(this,void 0,void 0,function*(){return this.setTrackMuted(!0),this})}unmute(){return L(this,void 0,void 0,function*(){return this.setTrackMuted(!1),this})}replaceTrack(e,t){return L(this,void 0,void 0,function*(){const n=yield this.trackChangeLock.lock();try{if(!this.sender)throw new Gr("unable to replace an unpublished track");let r,a;return typeof t=="boolean"?r=t:t!==void 0&&(r=t.userProvidedTrack,a=t.stopProcessor),this.providedByUser=r??!0,this.log.debug("replace MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(e),a&&this.processor&&(yield this.internalStopProcessor()),this}finally{n()}})}restart(e){return L(this,void 0,void 0,function*(){this.manuallyStopped=!1;const t=yield this.trackChangeLock.lock();try{e||(e=this._constraints);const{deviceId:n,facingMode:r}=e,a=JB(e,["deviceId","facingMode"]);this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:e}));const o={audio:!1,video:!1};this.kind===se.Kind.Video?o.video=n||r?{deviceId:n,facingMode:r}:!0:o.audio=n?Object.assign({deviceId:n},a):!0,this.attachedElements.forEach(h=>{rl(this.mediaStreamTrack,h)}),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();const d=(yield navigator.mediaDevices.getUserMedia(o)).getTracks()[0];return this.kind===se.Kind.Video&&(yield d.applyConstraints(a)),d.addEventListener("ended",this.handleEnded),this.log.debug("re-acquired MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(d),this._constraints=e,this.emit(ue.Restarted,this),this.manuallyStopped&&(this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext),this.stop()),this}finally{t()}})}setTrackMuted(e){this.log.debug("setting ".concat(this.kind," track ").concat(e?"muted":"unmuted"),this.logContext),!(this.isMuted===e&&this._mediaStreamTrack.enabled!==e)&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?ue.Muted:ue.Unmuted,this))}get needsReAcquisition(){return this._mediaStreamTrack.readyState!=="live"||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return L(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),jO()&&(this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext),!this.isInBackground&&this.needsReAcquisition&&!this.isUserProvided&&!this.isMuted&&(this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext),yield this.restart(),this.reacquireTrack=!1))})}stop(){var e;this.manuallyStopped=!0,super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),(e=this.processor)===null||e===void 0||e.destroy(),this.processor=void 0}pauseUpstream(){return L(this,void 0,void 0,function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!0)return;if(!this.sender){this.log.warn("unable to pause upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!0,this.emit(ue.UpstreamPaused,this);const n=zn();if(n?.name==="Safari"&&dr(n.version,"12.0")<0)throw new Db("pauseUpstream is not supported on Safari < 12.");((e=this.sender.transport)===null||e===void 0?void 0:e.state)!=="closed"&&(yield this.sender.replaceTrack(null))}finally{t()}})}resumeUpstream(){return L(this,void 0,void 0,function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!1)return;if(!this.sender){this.log.warn("unable to resume upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!1,this.emit(ue.UpstreamResumed,this),((e=this.sender.transport)===null||e===void 0?void 0:e.state)!=="closed"&&(yield this.sender.replaceTrack(this.mediaStreamTrack))}finally{t()}})}getRTCStatsReport(){return L(this,void 0,void 0,function*(){var e;return!((e=this.sender)===null||e===void 0)&&e.getStats?yield this.sender.getStats():void 0})}setProcessor(e){return L(this,arguments,void 0,function(t){var n=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var a;const o=yield n.trackChangeLock.lock();try{n.log.debug("setting up processor",n.logContext);const c=document.createElement(n.kind),d={kind:n.kind,track:n._mediaStreamTrack,element:c,audioContext:n.audioContext};if(yield t.init(d),n.log.debug("processor initialized",n.logContext),n.processor&&(yield n.internalStopProcessor()),n.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");if(Wo(n._mediaStreamTrack,c),c.muted=!0,c.play().catch(h=>{h instanceof DOMException&&h.name==="AbortError"?(n.log.warn("failed to play processor element, retrying",Object.assign(Object.assign({},n.logContext),{error:h})),setTimeout(()=>{c.play().catch(v=>{n.log.error("failed to play processor element",Object.assign(Object.assign({},n.logContext),{err:v}))})},100)):n.log.error("failed to play processor element",Object.assign(Object.assign({},n.logContext),{error:h}))}),n.processor=t,n.processorElement=c,n.processor.processedTrack){for(const h of n.attachedElements)h!==n.processorElement&&r&&(rl(n._mediaStreamTrack,h),Wo(n.processor.processedTrack,h));yield(a=n.sender)===null||a===void 0?void 0:a.replaceTrack(n.processor.processedTrack)}n.emit(ue.TrackProcessorUpdate,n.processor)}finally{o()}})()})}getProcessor(){return this.processor}stopProcessor(){return L(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){const n=yield e.trackChangeLock.lock();try{yield e.internalStopProcessor(t)}finally{n()}})()})}internalStopProcessor(){return L(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){var n,r;e.processor&&(e.log.debug("stopping processor",e.logContext),(n=e.processor.processedTrack)===null||n===void 0||n.stop(),yield e.processor.destroy(),e.processor=void 0,t||((r=e.processorElement)===null||r===void 0||r.remove(),e.processorElement=void 0),yield e._mediaStreamTrack.applyConstraints(e._constraints),yield e.setMediaStreamTrack(e._mediaStreamTrack,!0),e.emit(ue.TrackProcessorUpdate))})()})}startPreConnectBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;if(!k3()){this.log.warn("MediaRecorder is not available, cannot start preconnect buffer",this.logContext);return}if(this.localTrackRecorder){this.log.warn("preconnect buffer already started");return}else{let t="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(t)||(t="video/mp4"),this.localTrackRecorder=new R3(this,{mimeType:t})}this.localTrackRecorder.start(e),this.autoStopPreConnectBuffer=setTimeout(()=>{this.log.warn("preconnect buffer timed out, stopping recording automatically",this.logContext),this.stopPreConnectBuffer()},I3)}stopPreConnectBuffer(){clearTimeout(this.autoStopPreConnectBuffer),this.localTrackRecorder&&(this.localTrackRecorder.stop(),this.localTrackRecorder=void 0)}getPreConnectBuffer(){var e;return(e=this.localTrackRecorder)===null||e===void 0?void 0:e.byteStream}getPreConnectBufferMimeType(){var e;return(e=this.localTrackRecorder)===null||e===void 0?void 0:e.mimeType}}class vf extends QO{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}constructor(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0;super(e,se.Kind.Audio,t,n,a),this.stopOnMute=!1,this.isKrispNoiseFilterEnabled=!1,this.monitorSender=()=>L(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let o;try{o=yield this.getSenderStats()}catch(c){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:c}));return}o&&this.prevStats&&(this._currentBitrate=zf(o,this.prevStats)),this.prevStats=o}),this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=!0,this.log.debug("Krisp noise filter enabled",this.logContext),this.emit(ue.AudioTrackFeatureUpdate,this,dn.TF_ENHANCED_NOISE_CANCELLATION,!0)},this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=!1,this.log.debug("Krisp noise filter disabled",this.logContext),this.emit(ue.AudioTrackFeatureUpdate,this,dn.TF_ENHANCED_NOISE_CANCELLATION,!1)},this.audioContext=r,this.checkForSilence()}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return L(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===se.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(this.log.debug("stopping mic track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return L(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{if(!this.isMuted)return this.log.debug("Track already unmuted",this.logContext),this;const n=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==Ha(this._constraints.deviceId);return this.source===se.Source.Microphone&&(this.stopOnMute||this._mediaStreamTrack.readyState==="ended"||n)&&!this.isUserProvided&&(this.log.debug("reacquiring mic track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this}finally{t()}})}restartTrack(e){return L(this,void 0,void 0,function*(){let t;if(e){const n=xb({audio:e});typeof n.audio!="boolean"&&(t=n.audio)}yield this.restart(t)})}restart(e){const t=Object.create(null,{restart:{get:()=>super.restart}});return L(this,void 0,void 0,function*(){const n=yield t.restart.call(this,e);return this.checkForSilence(),n})}startMonitor(){Gn()&&(this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},Vb)))}setProcessor(e){return L(this,void 0,void 0,function*(){var t;const n=yield this.trackChangeLock.lock();try{if(!ur()&&!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");this.processor&&(yield this.internalStopProcessor());const r={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat(e.name),this.logContext),yield e.init(r),this.processor=e,this.processor.processedTrack&&(yield(t=this.sender)===null||t===void 0?void 0:t.replaceTrack(this.processor.processedTrack),this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable),this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)),this.emit(ue.TrackProcessorUpdate,this.processor)}finally{n()}})}setAudioContext(e){this.audioContext=e}getSenderStats(){return L(this,void 0,void 0,function*(){var e;if(!(!((e=this.sender)===null||e===void 0)&&e.getStats))return;const t=yield this.sender.getStats();let n;return t.forEach(r=>{r.type==="outbound-rtp"&&(n={type:"audio",streamId:r.id,packetsSent:r.packetsSent,packetsLost:r.packetsLost,bytesSent:r.bytesSent,timestamp:r.timestamp,roundTripTime:r.roundTripTime,jitter:r.jitter})}),n})}checkForSilence(){return L(this,void 0,void 0,function*(){const e=yield HO(this);return e&&(this.isMuted||this.log.debug("silence detected on local audio track",this.logContext),this.emit(ue.AudioSilenceDetected)),e})}}function O3(i,e,t){switch(i.kind){case"audio":return new vf(i,e,!1,void 0,t);case"video":return new mf(i,e,!1,t);default:throw new Gr("unsupported track type: ".concat(i.kind))}}const M3=Object.values(Eu),P3=Object.values(Ey),A3=Object.values(Nb),D3=[Eu.h180,Eu.h360],N3=[Ey.h180,Ey.h360],x3=i=>[{scaleResolutionDownBy:2,fps:i.encoding.maxFramerate}].map(t=>{var n,r;return new pt(Math.floor(i.width/t.scaleResolutionDownBy),Math.floor(i.height/t.scaleResolutionDownBy),Math.max(15e4,Math.floor(i.encoding.maxBitrate/(Math.pow(t.scaleResolutionDownBy,2)*(((n=i.encoding.maxFramerate)!==null&&n!==void 0?n:30)/((r=t.fps)!==null&&r!==void 0?r:30))))),t.fps,i.encoding.priority)}),Oy=["q","h","f"];function My(i,e,t,n){var r,a;let o=n?.videoEncoding;i&&(o=n?.screenShareEncoding);const c=n?.simulcast,d=n?.scalabilityMode,h=n?.videoCodec;if(!o&&!c&&!d||!e||!t)return[{}];o||(o=U3(i,e,t,h),Fe.debug("using video encoding",o));const v=o.maxFramerate,m=new pt(e,t,o.maxBitrate,o.maxFramerate,o.priority);if(d&&Ki(h)){const T=new ZO(d),S=[];if(T.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(d));const O=zn();if(Tu()||ur()||O?.name==="Chrome"&&dr(O?.version,"113")<0){const R=T.suffix=="h"?2:3,I=PF(O);for(let M=0;M<T.spatial;M+=1)S.push({rid:Oy[2-M],maxBitrate:o.maxBitrate/Math.pow(R,M),maxFramerate:m.encoding.maxFramerate,scaleResolutionDownBy:I?Math.pow(2,M):void 0});S[0].scalabilityMode=d}else S.push({maxBitrate:o.maxBitrate,maxFramerate:m.encoding.maxFramerate,scalabilityMode:d});return m.encoding.priority&&(S[0].priority=m.encoding.priority,S[0].networkPriority=m.encoding.priority),Fe.debug("using svc encoding",{encodings:S}),S}if(!c)return[o];let y=[];i?y=(r=tk(n?.screenShareSimulcastLayers))!==null&&r!==void 0?r:ek(i,m):y=(a=tk(n?.videoSimulcastLayers))!==null&&a!==void 0?a:ek(i,m);let E;if(y.length>0){const T=y[0];y.length>1&&([,E]=y);const S=Math.max(e,t);if(S>=960&&E)return og(e,t,[T,E,m],v);if(S>=480)return og(e,t,[T,m],v)}return og(e,t,[m])}function L3(i,e,t){var n,r,a,o;if(!t.backupCodec||t.backupCodec===!0||t.backupCodec.codec===t.videoCodec)return;e!==t.backupCodec.codec&&Fe.warn("requested a different codec than specified as backup",{serverRequested:e,backup:t.backupCodec.codec}),t.videoCodec=e,t.videoEncoding=t.backupCodec.encoding;const c=i.mediaStreamTrack.getSettings(),d=(n=c.width)!==null&&n!==void 0?n:(r=i.dimensions)===null||r===void 0?void 0:r.width,h=(a=c.height)!==null&&a!==void 0?a:(o=i.dimensions)===null||o===void 0?void 0:o.height;return i.source===se.Source.ScreenShare&&t.simulcast&&(t.simulcast=!1),My(i.source===se.Source.ScreenShare,d,h,t)}function U3(i,e,t,n){const r=B3(i,e,t);let{encoding:a}=r[0];const o=Math.max(e,t);for(let c=0;c<r.length;c+=1){const d=r[c];if(a=d.encoding,d.width>=o)break}if(n)switch(n){case"av1":case"h265":a=Object.assign({},a),a.maxBitrate=a.maxBitrate*.7;break;case"vp9":a=Object.assign({},a),a.maxBitrate=a.maxBitrate*.85;break}return a}function B3(i,e,t){if(i)return A3;const n=e>t?e/t:t/e;return Math.abs(n-16/9)<Math.abs(n-4/3)?M3:P3}function ek(i,e){if(i)return x3(e);const{width:t,height:n}=e,r=t>n?t/n:n/t;return Math.abs(r-16/9)<Math.abs(r-4/3)?D3:N3}function og(i,e,t,n){const r=[];if(t.forEach((a,o)=>{if(o>=Oy.length)return;const c=Math.min(i,e),h={rid:Oy[o],scaleResolutionDownBy:Math.max(1,c/Math.min(a.width,a.height)),maxBitrate:a.encoding.maxBitrate},v=n&&a.encoding.maxFramerate?Math.min(n,a.encoding.maxFramerate):a.encoding.maxFramerate;v&&(h.maxFramerate=v);const m=qs()||o===0;a.encoding.priority&&m&&(h.priority=a.encoding.priority,h.networkPriority=a.encoding.priority),r.push(h)}),ur()&&VO()==="ios"){let a;r.forEach(c=>{a?c.maxFramerate&&c.maxFramerate>a&&(a=c.maxFramerate):a=c.maxFramerate});let o=!0;r.forEach(c=>{var d;c.maxFramerate!=a&&(o&&(o=!1,Fe.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),Fe.info('Setting framerate of encoding "'.concat((d=c.rid)!==null&&d!==void 0?d:"",'" to ').concat(a)),c.maxFramerate=a)})}return r}function tk(i){if(i)return i.sort((e,t)=>{const{encoding:n}=e,{encoding:r}=t;return n.maxBitrate>r.maxBitrate?1:n.maxBitrate<r.maxBitrate?-1:n.maxBitrate===r.maxBitrate&&n.maxFramerate&&r.maxFramerate?n.maxFramerate>r.maxFramerate?1:-1:0})}class ZO{constructor(e){const t=e.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!t)throw new Error("invalid scalability mode");if(this.spatial=parseInt(t[1]),this.temporal=parseInt(t[2]),t.length>3)switch(t[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=t[3]}}toString(){var e;return"L".concat(this.spatial,"T").concat(this.temporal).concat((e=this.suffix)!==null&&e!==void 0?e:"")}}function F3(i){return i.source===se.Source.ScreenShare||i.constraints.height&&Ha(i.constraints.height)>=1080?"maintain-resolution":"balanced"}const j3=5e3;class mf extends QO{get sender(){return this._sender}set sender(e){this._sender=e,this.degradationPreference&&this.setDegradationPreference(this.degradationPreference)}constructor(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r=arguments.length>3?arguments[3]:void 0;super(e,se.Kind.Video,t,n,r),this.simulcastCodecs=new Map,this.degradationPreference="balanced",this.isCpuConstrained=!1,this.optimizeForPerformance=!1,this.monitorSender=()=>L(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let a;try{a=yield this.getSenderStats()}catch(d){this.log.error("could not get video sender stats",Object.assign(Object.assign({},this.logContext),{error:d}));return}const o=new Map(a.map(d=>[d.rid,d])),c=a.some(d=>d.qualityLimitationReason==="cpu");if(c!==this.isCpuConstrained&&(this.isCpuConstrained=c,this.isCpuConstrained&&this.emit(ue.CpuConstrained)),this.prevStats){let d=0;o.forEach((h,v)=>{var m;const y=(m=this.prevStats)===null||m===void 0?void 0:m.get(v);d+=zf(h,y)}),this._currentBitrate=d}this.prevStats=o}),this.senderLock=new An}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor(e){var t;if(this.signalClient=e,!Gn())return;const n=(t=this.sender)===null||t===void 0?void 0:t.getParameters();n&&(this.encodings=n.encodings),!this.monitorInterval&&(this.monitorInterval=setInterval(()=>{this.monitorSender()},Vb))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach(e=>{e.mediaStreamTrack.stop()}),super.stop()}pauseUpstream(){const e=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return L(this,void 0,void 0,function*(){var t,n,r,a,o;yield e.pauseUpstream.call(this);try{for(var c=!0,d=Hr(this.simulcastCodecs.values()),h;h=yield d.next(),t=h.done,!t;c=!0)a=h.value,c=!1,yield(o=a.sender)===null||o===void 0?void 0:o.replaceTrack(null)}catch(v){n={error:v}}finally{try{!c&&!t&&(r=d.return)&&(yield r.call(d))}finally{if(n)throw n.error}}})}resumeUpstream(){const e=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return L(this,void 0,void 0,function*(){var t,n,r,a,o;yield e.resumeUpstream.call(this);try{for(var c=!0,d=Hr(this.simulcastCodecs.values()),h;h=yield d.next(),t=h.done,!t;c=!0){a=h.value,c=!1;const v=a;yield(o=v.sender)===null||o===void 0?void 0:o.replaceTrack(v.mediaStreamTrack)}}catch(v){n={error:v}}finally{try{!c&&!t&&(r=d.return)&&(yield r.call(d))}finally{if(n)throw n.error}}})}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return L(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===se.Source.Camera&&!this.isUserProvided&&(this.log.debug("stopping camera track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return L(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.source===se.Source.Camera&&!this.isUserProvided&&(this.log.debug("reacquiring camera track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this):(this.log.debug("Track already unmuted",this.logContext),this)}finally{t()}})}setTrackMuted(e){super.setTrackMuted(e);for(const t of this.simulcastCodecs.values())t.mediaStreamTrack.enabled=!e}getSenderStats(){return L(this,void 0,void 0,function*(){var e;if(!(!((e=this.sender)===null||e===void 0)&&e.getStats))return[];const t=[],n=yield this.sender.getStats();return n.forEach(r=>{var a;if(r.type==="outbound-rtp"){const o={type:"video",streamId:r.id,frameHeight:r.frameHeight,frameWidth:r.frameWidth,framesPerSecond:r.framesPerSecond,framesSent:r.framesSent,firCount:r.firCount,pliCount:r.pliCount,nackCount:r.nackCount,packetsSent:r.packetsSent,bytesSent:r.bytesSent,qualityLimitationReason:r.qualityLimitationReason,qualityLimitationDurations:r.qualityLimitationDurations,qualityLimitationResolutionChanges:r.qualityLimitationResolutionChanges,rid:(a=r.rid)!==null&&a!==void 0?a:r.id,retransmittedPacketsSent:r.retransmittedPacketsSent,targetBitrate:r.targetBitrate,timestamp:r.timestamp},c=n.get(r.remoteId);c&&(o.jitter=c.jitter,o.packetsLost=c.packetsLost,o.roundTripTime=c.roundTripTime),t.push(o)}}),t.sort((r,a)=>{var o,c;return((o=a.frameWidth)!==null&&o!==void 0?o:0)-((c=r.frameWidth)!==null&&c!==void 0?c:0)}),t})}setPublishingQuality(e){const t=[];for(let n=fi.LOW;n<=fi.HIGH;n+=1)t.push(new Ob({quality:n,enabled:n<=e}));this.log.debug("setting publishing quality. max quality ".concat(e),this.logContext),this.setPublishingLayers(Ki(this.codec),t)}restartTrack(e){return L(this,void 0,void 0,function*(){var t,n,r,a,o;let c;if(e){const m=xb({video:e});typeof m.video!="boolean"&&(c=m.video)}yield this.restart(c),this.isCpuConstrained=!1;try{for(var d=!0,h=Hr(this.simulcastCodecs.values()),v;v=yield h.next(),t=v.done,!t;d=!0){a=v.value,d=!1;const m=a;m.sender&&((o=m.sender.transport)===null||o===void 0?void 0:o.state)!=="closed"&&(m.mediaStreamTrack=this.mediaStreamTrack.clone(),yield m.sender.replaceTrack(m.mediaStreamTrack))}}catch(m){n={error:m}}finally{try{!d&&!t&&(r=h.return)&&(yield r.call(h))}finally{if(n)throw n.error}}})}setProcessor(e){const t=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return L(this,arguments,void 0,function(n){var r=this;let a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var o,c,d,h,v,m;if(yield t.setProcessor.call(r,n,a),!((v=r.processor)===null||v===void 0)&&v.processedTrack)try{for(var y=!0,E=Hr(r.simulcastCodecs.values()),T;T=yield E.next(),o=T.done,!o;y=!0)h=T.value,y=!1,yield(m=h.sender)===null||m===void 0?void 0:m.replaceTrack(r.processor.processedTrack)}catch(S){c={error:S}}finally{try{!y&&!o&&(d=E.return)&&(yield d.call(E))}finally{if(c)throw c.error}}})()})}setDegradationPreference(e){return L(this,void 0,void 0,function*(){if(this.degradationPreference=e,this.sender)try{this.log.debug("setting degradationPreference to ".concat(e),this.logContext);const t=this.sender.getParameters();t.degradationPreference=e,this.sender.setParameters(t)}catch(t){this.log.warn("failed to set degradationPreference",Object.assign({error:t},this.logContext))}})}addSimulcastTrack(e,t){if(this.simulcastCodecs.has(e)){this.log.error("".concat(e," already added, skipping adding simulcast codec"),this.logContext);return}const n={codec:e,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:t};return this.simulcastCodecs.set(e,n),n}setSimulcastTrackSender(e,t){const n=this.simulcastCodecs.get(e);n&&(n.sender=t,setTimeout(()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)},j3))}setPublishingCodecs(e){return L(this,void 0,void 0,function*(){var t,n,r,a,o,c,d;if(this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:e,currentCodec:this.codec})),!this.codec&&e.length>0)return yield this.setPublishingLayers(Ki(e[0].codec),e[0].qualities),[];this.subscribedCodecs=e;const h=[];try{for(t=!0,n=Hr(e);r=yield n.next(),a=r.done,!a;t=!0){d=r.value,t=!1;const v=d;if(!this.codec||this.codec===v.codec)yield this.setPublishingLayers(Ki(v.codec),v.qualities);else{const m=this.simulcastCodecs.get(v.codec);if(this.log.debug("try setPublishingCodec for ".concat(v.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:m})),!m||!m.sender){for(const y of v.qualities)if(y.enabled){h.push(v.codec);break}}else m.encodings&&(this.log.debug("try setPublishingLayersForSender ".concat(v.codec),this.logContext),yield nk(m.sender,m.encodings,v.qualities,this.senderLock,Ki(v.codec),this.log,this.logContext))}}}catch(v){o={error:v}}finally{try{!t&&!a&&(c=n.return)&&(yield c.call(n))}finally{if(o)throw o.error}}return h})}setPublishingLayers(e,t){return L(this,void 0,void 0,function*(){if(this.optimizeForPerformance){this.log.info("skipping setPublishingLayers due to optimized publishing performance",Object.assign(Object.assign({},this.logContext),{qualities:t}));return}this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:t})),!(!this.sender||!this.encodings)&&(yield nk(this.sender,this.encodings,t,this.senderLock,e,this.log,this.logContext))})}prioritizePerformance(){return L(this,void 0,void 0,function*(){if(!this.sender)throw new Error("sender not found");const e=yield this.senderLock.lock();try{this.optimizeForPerformance=!0;const t=this.sender.getParameters();t.encodings=t.encodings.map((n,r)=>{var a;return Object.assign(Object.assign({},n),{active:r===0,scaleResolutionDownBy:Math.max(1,Math.ceil(((a=this.mediaStreamTrack.getSettings().height)!==null&&a!==void 0?a:360)/360)),scalabilityMode:r===0&&Ki(this.codec)?"L1T3":void 0,maxFramerate:r===0?15:0,maxBitrate:r===0?n.maxBitrate:0})}),this.log.debug("setting performance optimised encodings",Object.assign(Object.assign({},this.logContext),{encodings:t.encodings})),this.encodings=t.encodings,yield this.sender.setParameters(t)}catch(t){this.log.error("failed to set performance optimised encodings",Object.assign(Object.assign({},this.logContext),{error:t})),this.optimizeForPerformance=!1}finally{e()}})}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return L(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),jO()&&this.isInBackground&&this.source===se.Source.Camera&&(this._mediaStreamTrack.enabled=!1)})}}function nk(i,e,t,n,r,a,o){return L(this,void 0,void 0,function*(){const c=yield n.lock();a.debug("setPublishingLayersForSender",Object.assign(Object.assign({},o),{sender:i,qualities:t,senderEncodings:e}));try{const d=i.getParameters(),{encodings:h}=d;if(!h)return;if(h.length!==e.length){a.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},o),{encodings:h,senderEncodings:e}));return}let v=!1;!1&&h[0].scalabilityMode||(r&&t.some(E=>E.enabled)&&t.forEach(E=>E.enabled=!0),h.forEach((y,E)=>{var T;let S=(T=y.rid)!==null&&T!==void 0?T:"";S===""&&(S="q");const O=eM(S),R=t.find(I=>I.quality===O);R&&y.active!==R.enabled&&(v=!0,y.active=R.enabled,a.debug("setting layer ".concat(R.quality," to ").concat(y.active?"enabled":"disabled"),o),qs()&&(R.enabled?(y.scaleResolutionDownBy=e[E].scaleResolutionDownBy,y.maxBitrate=e[E].maxBitrate,y.maxFrameRate=e[E].maxFrameRate):(y.scaleResolutionDownBy=4,y.maxBitrate=10,y.maxFrameRate=2)))})),v&&(d.encodings=h,a.debug("setting encodings",Object.assign(Object.assign({},o),{encodings:d.encodings})),yield i.setParameters(d))}finally{c()}})}function eM(i){switch(i){case"f":return fi.HIGH;case"h":return fi.MEDIUM;case"q":return fi.LOW;default:return fi.HIGH}}function ik(i,e,t,n){if(!t)return[new Va({quality:fi.HIGH,width:i,height:e,bitrate:0,ssrc:0})];if(n){const r=t[0].scalabilityMode,a=new ZO(r),o=[],c=a.suffix=="h"?1.5:2,d=a.suffix=="h"?2:3;for(let h=0;h<a.spatial;h+=1)o.push(new Va({quality:Math.min(fi.HIGH,a.spatial-1)-h,width:Math.ceil(i/Math.pow(c,h)),height:Math.ceil(e/Math.pow(c,h)),bitrate:t[0].maxBitrate?Math.ceil(t[0].maxBitrate/Math.pow(d,h)):0,ssrc:0}));return o}return t.map(r=>{var a,o,c;const d=(a=r.scaleResolutionDownBy)!==null&&a!==void 0?a:1;let h=eM((o=r.rid)!==null&&o!==void 0?o:"");return new Va({quality:h,width:Math.ceil(i/d),height:Math.ceil(e/d),bitrate:(c=r.maxBitrate)!==null&&c!==void 0?c:0,ssrc:0})})}const rk="_lossy",ak="_reliable",q3=2*1e3,lg="leave-reconnect",V3=3e4;var wi;(function(i){i[i.New=0]="New",i[i.Connected=1]="Connected",i[i.Disconnected=2]="Disconnected",i[i.Reconnecting=3]="Reconnecting",i[i.Closed=4]="Closed"})(wi||(wi={}));class K3 extends vr.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor(e){var t;super(),this.options=e,this.rtcConfig={},this.peerConnectionTimeout=jb.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.latestRemoteOfferId=0,this.subscriberPrimary=!1,this.pcState=wi.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.log=Fe,this.reliableDataSequence=1,this.reliableMessageBuffer=new GR,this.reliableReceivedState=new d3(V3),this.midToTrackId={},this.isWaitingForNetworkReconnect=!1,this.handleDataChannel=n=>L(this,[n],void 0,function(r){var a=this;let{channel:o}=r;return(function*(){if(o){if(o.label===ak)a.reliableDCSub=o;else if(o.label===rk)a.lossyDCSub=o;else return;a.log.debug("on data channel ".concat(o.id,", ").concat(o.label),a.logContext),o.onmessage=a.handleDataMessage}})()}),this.handleDataMessage=n=>L(this,void 0,void 0,function*(){var r,a,o,c,d;const h=yield this.dataProcessLock.lock();try{let v;if(n.data instanceof ArrayBuffer)v=n.data;else if(n.data instanceof Blob)v=yield n.data.arrayBuffer();else{this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:n.data}));return}const m=Pn.fromBinary(new Uint8Array(v));if(m.sequence>0&&m.participantSid!==""){const y=this.reliableReceivedState.get(m.participantSid);if(y&&m.sequence<=y)return;this.reliableReceivedState.set(m.participantSid,m.sequence)}if(((r=m.value)===null||r===void 0?void 0:r.case)==="speaker")this.emit(fe.ActiveSpeakersUpdate,m.value.value.speakers);else if(((a=m.value)===null||a===void 0?void 0:a.case)==="encryptedPacket"){if(!this.e2eeManager){this.log.error("Received encrypted packet but E2EE not set up",this.logContext);return}const y=yield(o=this.e2eeManager)===null||o===void 0?void 0:o.handleEncryptedData(m.value.value.encryptedValue,m.value.value.iv,m.participantIdentity,m.value.value.keyIndex),E=BI.fromBinary(y.payload),T=new Pn({value:E.value,participantIdentity:m.participantIdentity,participantSid:m.participantSid});((c=T.value)===null||c===void 0?void 0:c.case)==="user"&&sk(T,T.value.value),this.emit(fe.DataPacketReceived,T,m.value.value.encryptionType)}else((d=m.value)===null||d===void 0?void 0:d.case)==="user"&&sk(m,m.value.value),this.emit(fe.DataPacketReceived,m,rn.NONE)}finally{h()}}),this.handleDataError=n=>{const a=n.currentTarget.maxRetransmits===0?"lossy":"reliable";if(n instanceof ErrorEvent&&n.error){const{error:o}=n.error;this.log.error("DataChannel error on ".concat(a,": ").concat(n.message),Object.assign(Object.assign({},this.logContext),{error:o}))}else this.log.error("Unknown DataChannel error on ".concat(a),Object.assign(Object.assign({},this.logContext),{event:n}))},this.handleBufferedAmountLow=n=>{const a=n.currentTarget.maxRetransmits===0?Je.LOSSY:Je.RELIABLE;this.updateAndEmitDCBufferStatus(a)},this.handleDisconnect=(n,r)=>{if(this._isClosed)return;this.log.warn("".concat(n," disconnected"),this.logContext),this.reconnectAttempts===0&&(this.reconnectStart=Date.now());const a=d=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(d,"ms. giving up"),this.logContext),this.emit(fe.Disconnected),this.close()},o=Date.now()-this.reconnectStart;let c=this.getNextRetryDelay({elapsedMs:o,retryCount:this.reconnectAttempts});if(c===null){a(o);return}n===lg&&(c=0),this.log.debug("reconnecting in ".concat(c,"ms"),this.logContext),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=En.setTimeout(()=>this.attemptReconnect(r).finally(()=>this.reconnectTimeout=void 0),c)},this.waitForRestarted=()=>new Promise((n,r)=>{this.pcState===wi.Connected&&n();const a=()=>{this.off(fe.Disconnected,o),n()},o=()=>{this.off(fe.Restarted,a),r()};this.once(fe.Restarted,a),this.once(fe.Disconnected,o)}),this.updateAndEmitDCBufferStatus=n=>{if(n===Je.RELIABLE){const a=this.dataChannelForKind(n);a&&this.reliableMessageBuffer.alignBufferedAmount(a.bufferedAmount)}const r=this.isBufferStatusLow(n);typeof r<"u"&&r!==this.dcBufferStatus.get(n)&&(this.dcBufferStatus.set(n,r),this.emit(fe.DCBufferStatusChanged,r,n))},this.isBufferStatusLow=n=>{const r=this.dataChannelForKind(n);if(r)return r.bufferedAmount<=r.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>L(this,void 0,void 0,function*(){!this.url||!(yield fetch(_u(this.url),{method:"HEAD"}).then(r=>r.ok).catch(()=>!1))||(this.log.info("detected network reconnected"),(this.client.currentState===St.RECONNECTING||this.isWaitingForNetworkReconnect&&this.client.currentState===St.CONNECTED)&&(this.clearReconnectTimeout(),this.attemptReconnect(Is.RR_SIGNAL_DISCONNECTED),this.isWaitingForNetworkReconnect=!1))}),this.handleBrowserOffline=()=>L(this,void 0,void 0,function*(){if(this.url)try{yield Promise.race([fetch(_u(this.url),{method:"HEAD"}),Tn(4e3).then(()=>Promise.reject())])}catch{window.navigator.onLine===!1&&(this.log.info("detected network interruption"),this.isWaitingForNetworkReconnect=!0)}}),this.log=Xr((t=e.loggerName)!==null&&t!==void 0?t:Wi.Engine),this.loggerOptions={loggerName:e.loggerName,loggerContextCb:()=>this.logContext},this.client=new Lb(void 0,this.loggerOptions),this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.closingLock=new An,this.dataProcessLock=new An,this.dcBufferStatus=new Map([[Je.LOSSY,!0],[Je.RELIABLE,!0]]),this.client.onParticipantUpdate=n=>this.emit(fe.ParticipantUpdate,n),this.client.onConnectionQuality=n=>this.emit(fe.ConnectionQualityUpdate,n),this.client.onRoomUpdate=n=>this.emit(fe.RoomUpdate,n),this.client.onSubscriptionError=n=>this.emit(fe.SubscriptionError,n),this.client.onSubscriptionPermissionUpdate=n=>this.emit(fe.SubscriptionPermissionUpdate,n),this.client.onSpeakersChanged=n=>this.emit(fe.SpeakersChanged,n),this.client.onStreamStateUpdate=n=>this.emit(fe.StreamStateChanged,n),this.client.onRequestResponse=n=>this.emit(fe.SignalRequestResponse,n)}get logContext(){var e,t,n,r,a,o;return{room:(t=(e=this.latestJoinResponse)===null||e===void 0?void 0:e.room)===null||t===void 0?void 0:t.name,roomID:(r=(n=this.latestJoinResponse)===null||n===void 0?void 0:n.room)===null||r===void 0?void 0:r.sid,participant:(o=(a=this.latestJoinResponse)===null||a===void 0?void 0:a.participant)===null||o===void 0?void 0:o.identity,pID:this.participantSid}}join(e,t,n,r){return L(this,void 0,void 0,function*(){this.url=e,this.token=t,this.signalOpts=n,this.maxJoinAttempts=n.maxRetries;try{this.joinAttempts+=1,this.setupSignalClientCallbacks();const a=yield this.client.join(e,t,n,r);return this._isClosed=!1,this.latestJoinResponse=a,this.subscriberPrimary=a.subscriberPrimary,this.pcManager||(yield this.configure(a)),(!this.subscriberPrimary||a.fastPublish)&&this.negotiate().catch(o=>{Fe.error(o,this.logContext)}),this.registerOnLineListener(),this.clientConfiguration=a.clientConfiguration,this.emit(fe.SignalConnected,a),a}catch(a){if(a instanceof Qe&&a.reason===Le.ServerUnreachable&&(this.log.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts),this.logContext),this.joinAttempts<this.maxJoinAttempts))return this.join(e,t,n,r);throw a}})}close(){return L(this,void 0,void 0,function*(){const e=yield this.closingLock.lock();if(this.isClosed){e();return}try{this._isClosed=!0,this.joinAttempts=0,this.emit(fe.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{e()}})}cleanupPeerConnections(){return L(this,void 0,void 0,function*(){var e;yield(e=this.pcManager)===null||e===void 0?void 0:e.close(),this.pcManager=void 0;const t=n=>{n&&(n.close(),n.onbufferedamountlow=null,n.onclose=null,n.onclosing=null,n.onerror=null,n.onmessage=null,n.onopen=null)};t(this.lossyDC),t(this.lossyDCSub),t(this.reliableDC),t(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0,this.reliableMessageBuffer=new GR,this.reliableDataSequence=1,this.reliableReceivedState.clear()})}cleanupClient(){return L(this,void 0,void 0,function*(){yield this.client.close(),this.client.resetCallbacks()})}addTrack(e){if(this.pendingTrackResolvers[e.cid])throw new Gr("a track with the same ID has already been published");return new Promise((t,n)=>{const r=setTimeout(()=>{delete this.pendingTrackResolvers[e.cid],n(new Qe("publication of local track timed out, no response from server",Le.Timeout))},1e4);this.pendingTrackResolvers[e.cid]={resolve:a=>{clearTimeout(r),t(a)},reject:()=>{clearTimeout(r),n(new Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack(e)})}removeTrack(e){if(e.track&&this.pendingTrackResolvers[e.track.id]){const{reject:t}=this.pendingTrackResolvers[e.track.id];t&&t(),delete this.pendingTrackResolvers[e.track.id]}try{return this.pcManager.removeTrack(e),!0}catch(t){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:t}))}return!1}updateMuteStatus(e,t){this.client.sendMuteTrack(e,t)}get dataSubscriberReadyState(){var e;return(e=this.reliableDCSub)===null||e===void 0?void 0:e.readyState}getConnectedServerAddress(){return L(this,void 0,void 0,function*(){var e;return(e=this.pcManager)===null||e===void 0?void 0:e.getConnectedAddress()})}setRegionUrlProvider(e){this.regionUrlProvider=e}configure(e){return L(this,void 0,void 0,function*(){var t,n;if(this.pcManager&&this.pcManager.currentState!==Ut.NEW)return;this.participantSid=(t=e.participant)===null||t===void 0?void 0:t.sid;const r=this.makeRTCConfiguration(e);this.pcManager=new S3(r,this.options.singlePeerConnection?"publisher-only":e.subscriberPrimary?"subscriber-primary":"publisher-primary",this.loggerOptions),this.emit(fe.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(a,o)=>{this.client.sendIceCandidate(a,o)},this.pcManager.onPublisherOffer=(a,o)=>{this.client.sendOffer(a,o)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(a,o,c)=>L(this,void 0,void 0,function*(){if(this.log.debug("primary PC state changed ".concat(a),this.logContext),["closed","disconnected","failed"].includes(o)&&(this.publisherConnectionPromise=void 0),a===Ut.CONNECTED){const v=this.pcState===wi.New;this.pcState=wi.Connected,v&&this.emit(fe.Connected,e)}else a===Ut.FAILED&&(this.pcState===wi.Connected||this.pcState===wi.Reconnecting)&&(this.pcState=wi.Disconnected,this.handleDisconnect("peerconnection failed",c==="failed"?Is.RR_SUBSCRIBER_FAILED:Is.RR_PUBLISHER_FAILED));const d=this.client.isDisconnected||this.client.currentState===St.RECONNECTING,h=[Ut.FAILED,Ut.CLOSING,Ut.CLOSED].includes(a);d&&h&&!this._isClosed&&this.emit(fe.Offline)}),this.pcManager.onTrack=a=>{a.streams.length!==0&&this.emit(fe.MediaTrackAdded,a.track,a.streams[0],a.receiver)},H3((n=e.serverInfo)===null||n===void 0?void 0:n.protocol)||this.createDataChannels()})}setupSignalClientCallbacks(){this.client.onAnswer=(e,t,n)=>L(this,void 0,void 0,function*(){this.pcManager&&(this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,midToTrackId:n})),this.midToTrackId=n,yield this.pcManager.setPublisherAnswer(e,t))}),this.client.onTrickle=(e,t)=>{this.pcManager&&(this.log.debug("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:e,target:t})),this.pcManager.addIceCandidate(e,t))},this.client.onOffer=(e,t,n)=>L(this,void 0,void 0,function*(){if(this.latestRemoteOfferId=t,!this.pcManager)return;this.midToTrackId=n;const r=yield this.pcManager.createSubscriberAnswerFromOffer(e,t);r&&this.client.sendAnswer(r,t)}),this.client.onLocalTrackPublished=e=>{var t;if(this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:e.cid,track:(t=e.track)===null||t===void 0?void 0:t.sid})),!this.pendingTrackResolvers[e.cid]){this.log.error("missing track resolver for ".concat(e.cid),Object.assign(Object.assign({},this.logContext),{cid:e.cid}));return}const{resolve:n}=this.pendingTrackResolvers[e.cid];delete this.pendingTrackResolvers[e.cid],n(e.track)},this.client.onLocalTrackUnpublished=e=>{this.emit(fe.LocalTrackUnpublished,e)},this.client.onLocalTrackSubscribed=e=>{this.emit(fe.LocalTrackSubscribed,e)},this.client.onTokenRefresh=e=>{var t;this.token=e,(t=this.regionUrlProvider)===null||t===void 0||t.updateToken(e)},this.client.onRemoteMuteChanged=(e,t)=>{this.emit(fe.RemoteMute,e,t)},this.client.onSubscribedQualityUpdate=e=>{this.emit(fe.SubscribedQualityUpdate,e)},this.client.onRoomMoved=e=>{var t;this.participantSid=(t=e.participant)===null||t===void 0?void 0:t.sid,this.latestJoinResponse&&(this.latestJoinResponse.room=e.room),this.emit(fe.RoomMoved,e)},this.client.onMediaSectionsRequirement=e=>{var t,n;const r={direction:"recvonly"};for(let a=0;a<e.numAudios;a++)(t=this.pcManager)===null||t===void 0||t.addPublisherTransceiverOfKind("audio",r);for(let a=0;a<e.numVideos;a++)(n=this.pcManager)===null||n===void 0||n.addPublisherTransceiverOfKind("video",r);this.negotiate()},this.client.onClose=()=>{this.handleDisconnect("signal",Is.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=e=>{switch(this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:e?.reason})),e.regions&&this.regionUrlProvider&&(this.log.debug("updating regions",this.logContext),this.regionUrlProvider.setServerReportedRegions({updatedAtInMs:Date.now(),maxAgeInMs:$O,regionSettings:e.regions})),e.action){case nl.DISCONNECT:this.emit(fe.Disconnected,e?.reason),this.close();break;case nl.RECONNECT:this.fullReconnectOnNext=!0,this.handleDisconnect(lg);break;case nl.RESUME:this.handleDisconnect(lg)}}}makeRTCConfiguration(e){var t;const n=Object.assign({},this.rtcConfig);if(!((t=this.signalOpts)===null||t===void 0)&&t.e2eeEnabled&&(this.log.debug("E2EE - setting up transports with insertable streams",this.logContext),n.encodedInsertableStreams=!0),e.iceServers&&!n.iceServers){const r=[];e.iceServers.forEach(a=>{const o={urls:a.urls};a.username&&(o.username=a.username),a.credential&&(o.credential=a.credential),r.push(o)}),n.iceServers=r}return e.clientConfiguration&&e.clientConfiguration.forceRelay===pu.ENABLED&&(n.iceTransportPolicy="relay"),n.sdpSemantics="unified-plan",n.continualGatheringPolicy="gather_continually",n}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(rk,{ordered:!1,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(ak,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow)}createSender(e,t,n){return L(this,void 0,void 0,function*(){if(Ty())return yield this.createTransceiverRTCRtpSender(e,t,n);if(_y())return this.log.warn("using add-track fallback",this.logContext),yield this.createRTCRtpSender(e.mediaStreamTrack);throw new Zt("Required webRTC APIs not supported on this device")})}createSimulcastSender(e,t,n,r){return L(this,void 0,void 0,function*(){if(Ty())return this.createSimulcastTransceiverSender(e,t,n,r);if(_y())return this.log.debug("using add-track fallback",this.logContext),this.createRTCRtpSender(e.mediaStreamTrack);throw new Zt("Cannot stream on this device")})}createTransceiverRTCRtpSender(e,t,n){return L(this,void 0,void 0,function*(){if(!this.pcManager)throw new Zt("publisher is closed");const r=[];e.mediaStream&&r.push(e.mediaStream),Ya(e)&&(e.codec=t.videoCodec);const a={direction:"sendonly",streams:r};return n&&(a.sendEncodings=n),(yield this.pcManager.addPublisherTransceiver(e.mediaStreamTrack,a)).sender})}createSimulcastTransceiverSender(e,t,n,r){return L(this,void 0,void 0,function*(){if(!this.pcManager)throw new Zt("publisher is closed");const a={direction:"sendonly"};r&&(a.sendEncodings=r);const o=yield this.pcManager.addPublisherTransceiver(t.mediaStreamTrack,a);if(n.videoCodec)return e.setSimulcastTrackSender(n.videoCodec,o.sender),o.sender})}createRTCRtpSender(e){return L(this,void 0,void 0,function*(){if(!this.pcManager)throw new Zt("publisher is closed");return this.pcManager.addPublisherTrack(e)})}attemptReconnect(e){return L(this,void 0,void 0,function*(){var t,n,r;if(!this._isClosed){if(this.attemptingReconnect){Fe.warn("already attempting reconnect, returning early",this.logContext);return}(((t=this.clientConfiguration)===null||t===void 0?void 0:t.resumeConnection)===pu.DISABLED||((r=(n=this.pcManager)===null||n===void 0?void 0:n.currentState)!==null&&r!==void 0?r:Ut.NEW)===Ut.NEW)&&(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection(e),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(a){this.reconnectAttempts+=1;let o=!0;a instanceof Zt?(this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:a})),o=!1):a instanceof jo||(this.fullReconnectOnNext=!0),o?this.handleDisconnect("reconnect",Is.RR_UNKNOWN):(this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext),this.emit(fe.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}})}getNextRetryDelay(e){try{return this.reconnectPolicy.nextRetryDelayInMs(e)}catch(t){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:t}))}return null}restartConnection(e){return L(this,void 0,void 0,function*(){var t,n,r;try{if(!this.url||!this.token)throw new Zt("could not reconnect, url or token not saved");this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext),this.emit(fe.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();let a;try{if(!this.signalOpts)throw this.log.warn("attempted connection restart, without signal options present",this.logContext),new jo;a=yield this.join(e??this.url,this.token,this.signalOpts)}catch(o){throw o instanceof Qe&&o.reason===Le.NotAllowed?new Zt("could not reconnect, token might be expired"):new jo}if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(this.client.setReconnected(),this.emit(fe.SignalRestarted,a),yield this.waitForPCReconnected(),this.client.currentState!==St.CONNECTED)throw new jo("Signal connection got severed during reconnect");(t=this.regionUrlProvider)===null||t===void 0||t.resetAttempts(),this.emit(fe.Restarted)}catch(a){const o=yield(n=this.regionUrlProvider)===null||n===void 0?void 0:n.getNextBestRegionUrl();if(o){yield this.restartConnection(o);return}else throw(r=this.regionUrlProvider)===null||r===void 0||r.resetAttempts(),a}})}resumeConnection(e){return L(this,void 0,void 0,function*(){var t;if(!this.url||!this.token)throw new Zt("could not reconnect, url or token not saved");if(!this.pcManager)throw new Zt("publisher and subscriber connections unset");this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext),this.emit(fe.Resuming);let n;try{this.setupSignalClientCallbacks(),n=yield this.client.reconnect(this.url,this.token,this.participantSid,e)}catch(r){let a="";throw r instanceof Error&&(a=r.message,this.log.error(r.message,Object.assign(Object.assign({},this.logContext),{error:r}))),r instanceof Qe&&r.reason===Le.NotAllowed?new Zt("could not reconnect, token might be expired"):r instanceof Qe&&r.reason===Le.LeaveRequest?r:new jo(a)}if(this.emit(fe.SignalResumed),n){const r=this.makeRTCConfiguration(n);this.pcManager.updateConfiguration(r),this.latestJoinResponse&&(this.latestJoinResponse.serverInfo=n.serverInfo)}else this.log.warn("Did not receive reconnect response",this.logContext);if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.currentState!==St.CONNECTED)throw new jo("Signal connection got severed during reconnect");this.client.setReconnected(),((t=this.reliableDC)===null||t===void 0?void 0:t.readyState)==="open"&&this.reliableDC.id===null&&this.createDataChannels(),n?.lastMessageSeq&&this.resendReliableMessagesForResume(n.lastMessageSeq),this.emit(fe.Resumed)})}waitForPCInitialConnection(e,t){return L(this,void 0,void 0,function*(){if(!this.pcManager)throw new Zt("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(t,e)})}waitForPCReconnected(){return L(this,void 0,void 0,function*(){this.pcState=wi.Reconnecting,this.log.debug("waiting for peer connection to reconnect",this.logContext);try{if(yield Tn(q3),!this.pcManager)throw new Zt("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=wi.Connected}catch(e){throw this.pcState=wi.Disconnected,new Qe("could not establish PC connection, ".concat(e.message),Le.InternalError)}})}publishRpcResponse(e,t,n,r){return L(this,void 0,void 0,function*(){const a=new Pn({destinationIdentities:[e],kind:Je.RELIABLE,value:{case:"rpcResponse",value:new Rb({requestId:t,value:r?{case:"error",value:r.toProto()}:{case:"payload",value:n??""}})}});yield this.sendDataPacket(a,Je.RELIABLE)})}publishRpcAck(e,t){return L(this,void 0,void 0,function*(){const n=new Pn({destinationIdentities:[e],kind:Je.RELIABLE,value:{case:"rpcAck",value:new Cb({requestId:t})}});yield this.sendDataPacket(n,Je.RELIABLE)})}sendDataPacket(e,t){return L(this,void 0,void 0,function*(){if(yield this.ensurePublisherConnected(t),this.e2eeManager&&this.e2eeManager.isDataChannelEncryptionEnabled){const a=dF(e);if(a){const o=yield this.e2eeManager.encryptData(a.toBinary());e.value={case:"encryptedPacket",value:new UI({encryptedValue:o.payload,iv:o.iv,keyIndex:o.keyIndex})}}}t===Je.RELIABLE&&(e.sequence=this.reliableDataSequence,this.reliableDataSequence+=1);const n=e.toBinary();yield this.waitForBufferStatusLow(t);const r=this.dataChannelForKind(t);if(r){if(t===Je.RELIABLE&&this.reliableMessageBuffer.push({data:n,sequence:e.sequence}),this.attemptingReconnect)return;r.send(n)}this.updateAndEmitDCBufferStatus(t)})}resendReliableMessagesForResume(e){return L(this,void 0,void 0,function*(){yield this.ensurePublisherConnected(Je.RELIABLE);const t=this.dataChannelForKind(Je.RELIABLE);t&&(this.reliableMessageBuffer.popToSequence(e),this.reliableMessageBuffer.getAll().forEach(n=>{t.send(n.data)})),this.updateAndEmitDCBufferStatus(Je.RELIABLE)})}waitForBufferStatusLow(e){return new Promise((t,n)=>L(this,void 0,void 0,function*(){if(this.isBufferStatusLow(e))t();else{const r=()=>n("Engine closed");for(this.once(fe.Closing,r);!this.dcBufferStatus.get(e);)yield Tn(10);this.off(fe.Closing,r),t()}}))}ensureDataTransportConnected(e){return L(this,arguments,void 0,function(t){var n=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.subscriberPrimary;return(function*(){var a;if(!n.pcManager)throw new Zt("PC manager is closed");const o=r?n.pcManager.subscriber:n.pcManager.publisher,c=r?"Subscriber":"Publisher";if(!o)throw new Qe("".concat(c," connection not set"),Le.InternalError);let d=!1;!r&&!n.dataChannelForKind(t,r)&&(n.createDataChannels(),d=!0),!d&&!r&&!n.pcManager.publisher.isICEConnected&&n.pcManager.publisher.getICEConnectionState()!=="checking"&&(d=!0),d&&n.negotiate().catch(m=>{Fe.error(m,n.logContext)});const h=n.dataChannelForKind(t,r);if(h?.readyState==="open")return;const v=new Date().getTime()+n.peerConnectionTimeout;for(;new Date().getTime()<v;){if(o.isICEConnected&&((a=n.dataChannelForKind(t,r))===null||a===void 0?void 0:a.readyState)==="open")return;yield Tn(50)}throw new Qe("could not establish ".concat(c," connection, state: ").concat(o.getICEConnectionState()),Le.InternalError)})()})}ensurePublisherConnected(e){return L(this,void 0,void 0,function*(){this.publisherConnectionPromise||(this.publisherConnectionPromise=this.ensureDataTransportConnected(e,!1)),yield this.publisherConnectionPromise})}verifyTransport(){return!(!this.pcManager||this.pcManager.currentState!==Ut.CONNECTED||!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED)}negotiate(){return L(this,void 0,void 0,function*(){return new Promise((e,t)=>L(this,void 0,void 0,function*(){if(!this.pcManager){t(new by("PC manager is closed"));return}this.pcManager.requirePublisher(),this.pcManager.publisher.getTransceivers().length==0&&!this.lossyDC&&!this.reliableDC&&this.createDataChannels();const n=new AbortController,r=()=>{n.abort(),this.log.debug("engine disconnected while negotiation was ongoing",this.logContext),e()};this.isClosed&&t("cannot negotiate on closed engine"),this.on(fe.Closing,r),this.pcManager.publisher.once(sl.RTPVideoPayloadTypes,a=>{const o=new Map;a.forEach(c=>{const d=c.codec.toLowerCase();LF(d)&&o.set(c.payload,d)}),this.emit(fe.RTPVideoMapUpdate,o)});try{yield this.pcManager.negotiate(n),e()}catch(a){a instanceof by&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",Is.RR_UNKNOWN),t(a)}finally{this.off(fe.Closing,r)}}))})}dataChannelForKind(e,t){if(t){if(e===Je.LOSSY)return this.lossyDCSub;if(e===Je.RELIABLE)return this.reliableDCSub}else{if(e===Je.LOSSY)return this.lossyDC;if(e===Je.RELIABLE)return this.reliableDC}}sendSyncState(e,t){var n,r,a,o;if(!this.pcManager){this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);return}const c=this.pcManager.publisher.getLocalDescription(),d=this.pcManager.publisher.getRemoteDescription(),h=(n=this.pcManager.subscriber)===null||n===void 0?void 0:n.getRemoteDescription(),v=(r=this.pcManager.subscriber)===null||r===void 0?void 0:r.getLocalDescription(),m=(o=(a=this.signalOpts)===null||a===void 0?void 0:a.autoSubscribe)!==null&&o!==void 0?o:!0,y=new Array,E=new Array;e.forEach(T=>{T.isDesired!==m&&y.push(T.trackSid),T.isEnabled||E.push(T.trackSid)}),this.client.sendSyncState(new Mb({answer:this.options.singlePeerConnection?d?Jo({sdp:d.sdp,type:d.type}):void 0:v?Jo({sdp:v.sdp,type:v.type}):void 0,offer:this.options.singlePeerConnection?c?Jo({sdp:c.sdp,type:c.type}):void 0:h?Jo({sdp:h.sdp,type:h.type}):void 0,subscription:new Hf({trackSids:y,subscribe:!m,participantTracks:[]}),publishTracks:zF(t),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:E,datachannelReceiveStates:this.reliableReceivedState.map((T,S)=>new iO({publisherSid:S,lastSeq:T}))}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){const e=[],t=(n,r)=>{n?.id!==void 0&&n.id!==null&&e.push(new rO({label:n.label,id:n.id,target:r}))};return t(this.dataChannelForKind(Je.LOSSY),Vi.PUBLISHER),t(this.dataChannelForKind(Je.RELIABLE),Vi.PUBLISHER),t(this.dataChannelForKind(Je.LOSSY,!0),Vi.SUBSCRIBER),t(this.dataChannelForKind(Je.RELIABLE,!0),Vi.SUBSCRIBER),e}clearReconnectTimeout(){this.reconnectTimeout&&En.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){Gn()&&(window.addEventListener("online",this.handleBrowserOnLine),window.addEventListener("offline",this.handleBrowserOffline))}deregisterOnLineListener(){Gn()&&(window.removeEventListener("online",this.handleBrowserOnLine),window.removeEventListener("offline",this.handleBrowserOffline))}getTrackIdForReceiver(e){var t;const n=(t=this.pcManager)===null||t===void 0?void 0:t.getMidForReceiver(e);if(n){const r=Object.entries(this.midToTrackId).find(a=>{let[o]=a;return o===n});if(r)return r[1]}}}class jo extends Error{}function H3(i){return i!==void 0&&i>13}function sk(i,e){const t=i.participantIdentity?i.participantIdentity:e.participantIdentity;i.participantIdentity=t,e.participantIdentity=t;const n=i.destinationIdentities.length!==0?i.destinationIdentities:e.destinationIdentities;i.destinationIdentities=n,e.destinationIdentities=n}class tM{get info(){return this._info}validateBytesReceived(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(!(typeof this.totalByteSize!="number"||this.totalByteSize===0)){if(e&&this.bytesReceived<this.totalByteSize)throw new Ii("Not enough chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, only received ").concat(this.bytesReceived," bytes"),In.Incomplete);if(this.bytesReceived>this.totalByteSize)throw new Ii("Extra chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, received ").concat(this.bytesReceived," bytes"),In.LengthExceeded)}}constructor(e,t,n,r){this.reader=t,this.totalByteSize=n,this._info=e,this.bytesReceived=0,this.outOfBandFailureRejectingFuture=r}}class G3 extends tM{handleChunkReceived(e){var t;this.bytesReceived+=e.content.byteLength,this.validateBytesReceived();const n=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(t=this.onProgress)===null||t===void 0||t.call(this,n)}[Symbol.asyncIterator](){const e=this.reader.getReader();let t=new Oi,n=null,r=null;if(this.signal){const o=this.signal;r=()=>{var c;(c=t.reject)===null||c===void 0||c.call(t,o.reason)},o.addEventListener("abort",r),n=o}const a=()=>{e.releaseLock(),n&&r&&n.removeEventListener("abort",r),this.signal=void 0};return{next:()=>L(this,void 0,void 0,function*(){var o,c;try{const{done:d,value:h}=yield Promise.race([e.read(),t.promise,(c=(o=this.outOfBandFailureRejectingFuture)===null||o===void 0?void 0:o.promise)!==null&&c!==void 0?c:new Promise(()=>{})]);return d?(this.validateBytesReceived(!0),{done:!0,value:void 0}):(this.handleChunkReceived(h),{done:!1,value:h.content})}catch(d){throw a(),d}}),return(){return L(this,void 0,void 0,function*(){return a(),{done:!0,value:void 0}})}}}withAbortSignal(e){return this.signal=e,this}readAll(){return L(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return(function*(){var n,r,a,o;let c=new Set;const d=t.signal?e.withAbortSignal(t.signal):e;try{for(var h=!0,v=Hr(d),m;m=yield v.next(),n=m.done,!n;h=!0){o=m.value,h=!1;const y=o;c.add(y)}}catch(y){r={error:y}}finally{try{!h&&!n&&(a=v.return)&&(yield a.call(v))}finally{if(r)throw r.error}}return Array.from(c)})()})}}class z3 extends tM{constructor(e,t,n,r){super(e,t,n,r),this.receivedChunks=new Map}handleChunkReceived(e){var t;const n=qh(e.chunkIndex),r=this.receivedChunks.get(n);if(r&&r.version>e.version)return;this.receivedChunks.set(n,e),this.bytesReceived+=e.content.byteLength,this.validateBytesReceived();const a=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(t=this.onProgress)===null||t===void 0||t.call(this,a)}[Symbol.asyncIterator](){const e=this.reader.getReader(),t=new TextDecoder("utf-8",{fatal:!0});let n=new Oi,r=null,a=null;if(this.signal){const c=this.signal;a=()=>{var d;(d=n.reject)===null||d===void 0||d.call(n,c.reason)},c.addEventListener("abort",a),r=c}const o=()=>{e.releaseLock(),r&&a&&r.removeEventListener("abort",a),this.signal=void 0};return{next:()=>L(this,void 0,void 0,function*(){var c,d;try{const{done:h,value:v}=yield Promise.race([e.read(),n.promise,(d=(c=this.outOfBandFailureRejectingFuture)===null||c===void 0?void 0:c.promise)!==null&&d!==void 0?d:new Promise(()=>{})]);if(h)return this.validateBytesReceived(!0),{done:!0,value:void 0};{this.handleChunkReceived(v);let m;try{m=t.decode(v.content)}catch(y){throw new Ii("Cannot decode datastream chunk ".concat(v.chunkIndex," as text: ").concat(y),In.DecodeFailed)}return{done:!1,value:m}}}catch(h){throw o(),h}}),return(){return L(this,void 0,void 0,function*(){return o(),{done:!0,value:void 0}})}}}withAbortSignal(e){return this.signal=e,this}readAll(){return L(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return(function*(){var n,r,a,o;let c="";const d=t.signal?e.withAbortSignal(t.signal):e;try{for(var h=!0,v=Hr(d),m;m=yield v.next(),n=m.done,!n;h=!0)o=m.value,h=!1,c+=o}catch(y){r={error:y}}finally{try{!h&&!n&&(a=v.return)&&(yield a.call(v))}finally{if(r)throw r.error}}return c})()})}}class W3{constructor(){this.log=Fe,this.byteStreamControllers=new Map,this.textStreamControllers=new Map,this.byteStreamHandlers=new Map,this.textStreamHandlers=new Map}registerTextStreamHandler(e,t){if(this.textStreamHandlers.has(e))throw new Ii('A text stream handler for topic "'.concat(e,'" has already been set.'),In.HandlerAlreadyRegistered);this.textStreamHandlers.set(e,t)}unregisterTextStreamHandler(e){this.textStreamHandlers.delete(e)}registerByteStreamHandler(e,t){if(this.byteStreamHandlers.has(e))throw new Ii('A byte stream handler for topic "'.concat(e,'" has already been set.'),In.HandlerAlreadyRegistered);this.byteStreamHandlers.set(e,t)}unregisterByteStreamHandler(e){this.byteStreamHandlers.delete(e)}clearControllers(){this.byteStreamControllers.clear(),this.textStreamControllers.clear()}validateParticipantHasNoActiveDataStreams(e){var t,n,r,a;const o=Array.from(this.textStreamControllers.entries()).filter(d=>d[1].sendingParticipantIdentity===e),c=Array.from(this.byteStreamControllers.entries()).filter(d=>d[1].sendingParticipantIdentity===e);if(o.length>0||c.length>0){const d=new Ii("Participant ".concat(e," unexpectedly disconnected in the middle of sending data"),In.AbnormalEnd);for(const[h,v]of c)(n=(t=v.outOfBandFailureRejectingFuture).reject)===null||n===void 0||n.call(t,d),this.byteStreamControllers.delete(h);for(const[h,v]of o)(a=(r=v.outOfBandFailureRejectingFuture).reject)===null||a===void 0||a.call(r,d),this.textStreamControllers.delete(h)}}handleDataStreamPacket(e,t){return L(this,void 0,void 0,function*(){switch(e.value.case){case"streamHeader":return this.handleStreamHeader(e.value.value,e.participantIdentity,t);case"streamChunk":return this.handleStreamChunk(e.value.value,t);case"streamTrailer":return this.handleStreamTrailer(e.value.value,t);default:throw new Error('DataPacket of value "'.concat(e.value.case,'" is not data stream related!'))}})}handleStreamHeader(e,t,n){return L(this,void 0,void 0,function*(){var r;if(e.contentHeader.case==="byteHeader"){const a=this.byteStreamHandlers.get(e.topic);if(!a){this.log.debug("ignoring incoming byte stream due to no handler for topic",e.topic);return}let o;const c=new Oi;c.promise.catch(v=>{this.log.error(v)});const d={id:e.streamId,name:(r=e.contentHeader.value.name)!==null&&r!==void 0?r:"unknown",mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:qh(e.timestamp),attributes:e.attributes,encryptionType:n},h=new ReadableStream({start:v=>{if(o=v,this.textStreamControllers.has(e.streamId))throw new Ii("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),In.AlreadyOpened);this.byteStreamControllers.set(e.streamId,{info:d,controller:o,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:c})}});a(new G3(d,h,qh(e.totalLength),c),{identity:t})}else if(e.contentHeader.case==="textHeader"){const a=this.textStreamHandlers.get(e.topic);if(!a){this.log.debug("ignoring incoming text stream due to no handler for topic",e.topic);return}let o;const c=new Oi;c.promise.catch(v=>{this.log.error(v)});const d={id:e.streamId,mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:Number(e.timestamp),attributes:e.attributes,encryptionType:n},h=new ReadableStream({start:v=>{if(o=v,this.textStreamControllers.has(e.streamId))throw new Ii("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),In.AlreadyOpened);this.textStreamControllers.set(e.streamId,{info:d,controller:o,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:c})}});a(new z3(d,h,qh(e.totalLength),c),{identity:t})}})}handleStreamChunk(e,t){const n=this.byteStreamControllers.get(e.streamId);n&&(n.info.encryptionType!==t?(n.controller.error(new Ii("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(n.info.encryptionType),In.EncryptionTypeMismatch)),this.byteStreamControllers.delete(e.streamId)):e.content.length>0&&n.controller.enqueue(e));const r=this.textStreamControllers.get(e.streamId);r&&(r.info.encryptionType!==t?(r.controller.error(new Ii("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(r.info.encryptionType),In.EncryptionTypeMismatch)),this.textStreamControllers.delete(e.streamId)):e.content.length>0&&r.controller.enqueue(e))}handleStreamTrailer(e,t){const n=this.textStreamControllers.get(e.streamId);n&&(n.info.encryptionType!==t?n.controller.error(new Ii("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(n.info.encryptionType),In.EncryptionTypeMismatch)):(n.info.attributes=Object.assign(Object.assign({},n.info.attributes),e.attributes),n.controller.close(),this.textStreamControllers.delete(e.streamId)));const r=this.byteStreamControllers.get(e.streamId);r&&(r.info.encryptionType!==t?r.controller.error(new Ii("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(r.info.encryptionType),In.EncryptionTypeMismatch)):(r.info.attributes=Object.assign(Object.assign({},r.info.attributes),e.attributes),r.controller.close()),this.byteStreamControllers.delete(e.streamId))}}class nM{constructor(e,t,n){this.writableStream=e,this.defaultWriter=e.getWriter(),this.onClose=n,this.info=t}write(e){return this.defaultWriter.write(e)}close(){return L(this,void 0,void 0,function*(){var e;yield this.defaultWriter.close(),this.defaultWriter.releaseLock(),(e=this.onClose)===null||e===void 0||e.call(this)})}}class J3 extends nM{}class Y3 extends nM{}const ok=15e3;class $3{constructor(e,t){this.engine=e,this.log=t}setupEngine(e){this.engine=e}sendText(e,t){return L(this,void 0,void 0,function*(){var n;const r=crypto.randomUUID(),o=new TextEncoder().encode(e).byteLength,c=(n=t?.attachments)===null||n===void 0?void 0:n.map(()=>crypto.randomUUID()),d=new Array(c?c.length+1:1).fill(0),h=(m,y)=>{var E;d[y]=m;const T=d.reduce((S,O)=>S+O,0);(E=t?.onProgress)===null||E===void 0||E.call(t,T)},v=yield this.streamText({streamId:r,totalSize:o,destinationIdentities:t?.destinationIdentities,topic:t?.topic,attachedStreamIds:c,attributes:t?.attributes});return yield v.write(e),h(1,0),yield v.close(),t?.attachments&&c&&(yield Promise.all(t.attachments.map((m,y)=>L(this,void 0,void 0,function*(){return this._sendFile(c[y],m,{topic:t.topic,mimeType:m.type,onProgress:E=>{h(E,y+1)}})})))),v.info})}streamText(e){return L(this,void 0,void 0,function*(){var t,n,r;const a=(t=e?.streamId)!==null&&t!==void 0?t:crypto.randomUUID(),o={id:a,mimeType:"text/plain",timestamp:Date.now(),topic:(n=e?.topic)!==null&&n!==void 0?n:"",size:e?.totalSize,attributes:e?.attributes,encryptionType:!((r=this.engine.e2eeManager)===null||r===void 0)&&r.isDataChannelEncryptionEnabled?rn.GCM:rn.NONE},c=new uf({streamId:a,mimeType:o.mimeType,topic:o.topic,timestamp:Os(o.timestamp),totalLength:Os(e?.totalSize),attributes:o.attributes,contentHeader:{case:"textHeader",value:new YI({version:e?.version,attachedStreamIds:e?.attachedStreamIds,replyToStreamId:e?.replyToStreamId,operationType:e?.type==="update"?cy.UPDATE:cy.CREATE})}}),d=e?.destinationIdentities,h=new Pn({destinationIdentities:d,value:{case:"streamHeader",value:c}});yield this.engine.sendDataPacket(h,Je.RELIABLE);let v=0;const m=this.engine,y=new WritableStream({write(S){return L(this,void 0,void 0,function*(){for(const O of VF(S,ok)){const R=new df({content:O,streamId:a,chunkIndex:Os(v)}),I=new Pn({destinationIdentities:d,value:{case:"streamChunk",value:R}});yield m.sendDataPacket(I,Je.RELIABLE),v+=1}})},close(){return L(this,void 0,void 0,function*(){const S=new hf({streamId:a}),O=new Pn({destinationIdentities:d,value:{case:"streamTrailer",value:S}});yield m.sendDataPacket(O,Je.RELIABLE)})},abort(S){console.log("Sink error:",S)}});let E=()=>L(this,void 0,void 0,function*(){yield T.close()});m.once(fe.Closing,E);const T=new J3(y,o,()=>this.engine.off(fe.Closing,E));return T})}sendFile(e,t){return L(this,void 0,void 0,function*(){const n=crypto.randomUUID();return yield this._sendFile(n,e,t),{id:n}})}_sendFile(e,t,n){return L(this,void 0,void 0,function*(){var r;const a=yield this.streamBytes({streamId:e,totalSize:t.size,name:t.name,mimeType:(r=n?.mimeType)!==null&&r!==void 0?r:t.type,topic:n?.topic,destinationIdentities:n?.destinationIdentities}),o=t.stream().getReader();for(;;){const{done:c,value:d}=yield o.read();if(c)break;yield a.write(d)}return yield a.close(),a.info})}streamBytes(e){return L(this,void 0,void 0,function*(){var t,n,r,a,o,c;const d=(t=e?.streamId)!==null&&t!==void 0?t:crypto.randomUUID(),h=e?.destinationIdentities,v={id:d,mimeType:(n=e?.mimeType)!==null&&n!==void 0?n:"application/octet-stream",topic:(r=e?.topic)!==null&&r!==void 0?r:"",timestamp:Date.now(),attributes:e?.attributes,size:e?.totalSize,name:(a=e?.name)!==null&&a!==void 0?a:"unknown",encryptionType:!((o=this.engine.e2eeManager)===null||o===void 0)&&o.isDataChannelEncryptionEnabled?rn.GCM:rn.NONE},m=new uf({totalLength:Os((c=v.size)!==null&&c!==void 0?c:0),mimeType:v.mimeType,streamId:d,topic:v.topic,timestamp:Os(Date.now()),attributes:v.attributes,contentHeader:{case:"byteHeader",value:new $I({name:v.name})}}),y=new Pn({destinationIdentities:h,value:{case:"streamHeader",value:m}});yield this.engine.sendDataPacket(y,Je.RELIABLE);let E=0;const T=new An,S=this.engine,O=this.log,R=new WritableStream({write(M){return L(this,void 0,void 0,function*(){const C=yield T.lock();let k=0;try{for(;k<M.byteLength;){const _=M.slice(k,k+ok),P=new Pn({destinationIdentities:h,value:{case:"streamChunk",value:new df({content:_,streamId:d,chunkIndex:Os(E)})}});yield S.sendDataPacket(P,Je.RELIABLE),E+=1,k+=_.byteLength}}finally{C()}})},close(){return L(this,void 0,void 0,function*(){const M=new hf({streamId:d}),C=new Pn({destinationIdentities:h,value:{case:"streamTrailer",value:M}});yield S.sendDataPacket(C,Je.RELIABLE)})},abort(M){O.error("Sink error:",M)}});return new Y3(R,v)})}}class iM extends se{constructor(e,t,n,r,a){super(e,n,a),this.sid=t,this.receiver=r}get isLocal(){return!1}setMuted(e){this.isMuted!==e&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?ue.Muted:ue.Unmuted,this))}setMediaStream(e){this.mediaStream=e;const t=n=>{n.track===this._mediaStreamTrack&&(e.removeEventListener("removetrack",t),this.receiver&&"playoutDelayHint"in this.receiver&&(this.receiver.playoutDelayHint=void 0),this.receiver=void 0,this._currentBitrate=0,this.emit(ue.Ended,this))};e.addEventListener("removetrack",t)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){return L(this,void 0,void 0,function*(){var e;return!((e=this.receiver)===null||e===void 0)&&e.getStats?yield this.receiver.getStats():void 0})}setPlayoutDelay(e){this.receiver?"playoutDelayHint"in this.receiver?this.receiver.playoutDelayHint=e:this.log.warn("Playout delay not supported in this browser"):this.log.warn("Cannot set playout delay, track already ended")}getPlayoutDelay(){if(this.receiver){if("playoutDelayHint"in this.receiver)return this.receiver.playoutDelayHint;this.log.warn("Playout delay not supported in this browser")}else this.log.warn("Cannot get playout delay, track already ended");return 0}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval(()=>this.monitorReceiver(),Vb)),WF()&&this.registerTimeSyncUpdate()}registerTimeSyncUpdate(){const e=()=>{var t;this.timeSyncHandle=requestAnimationFrame(()=>e());const n=(t=this.receiver)===null||t===void 0?void 0:t.getSynchronizationSources()[0];if(n){const{timestamp:r,rtpTimestamp:a}=n;a&&this.rtpTimestamp!==a&&(this.emit(ue.TimeSyncUpdate,{timestamp:r,rtpTimestamp:a}),this.rtpTimestamp=a)}};e()}}class rM extends iM{constructor(e,t,n,r,a,o){super(e,t,se.Kind.Audio,n,o),this.monitorReceiver=()=>L(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const c=yield this.getReceiverStats();c&&this.prevStats&&this.receiver&&(this._currentBitrate=zf(c,this.prevStats)),this.prevStats=c}),this.audioContext=r,this.webAudioPluginNodes=[],a&&(this.sinkId=a.deviceId)}setVolume(e){var t;for(const n of this.attachedElements)this.audioContext?(t=this.gainNode)===null||t===void 0||t.gain.setTargetAtTime(e,0,.1):n.volume=e;ur()&&this._mediaStreamTrack._setVolume(e),this.elementVolume=e}getVolume(){if(this.elementVolume)return this.elementVolume;if(ur())return 1;let e=0;return this.attachedElements.forEach(t=>{t.volume>e&&(e=t.volume)}),e}setSinkId(e){return L(this,void 0,void 0,function*(){this.sinkId=e,yield Promise.all(this.attachedElements.map(t=>{if(Cy(t))return t.setSinkId(e)}))})}attach(e){const t=this.attachedElements.length===0;return e?super.attach(e):e=super.attach(),this.sinkId&&Cy(e)&&e.setSinkId(this.sinkId).catch(n=>{this.log.error("Failed to set sink id on remote audio track",n,this.logContext)}),this.audioContext&&t&&(this.log.debug("using audio context mapping",this.logContext),this.connectWebAudio(this.audioContext,e),e.volume=0,e.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),e}detach(e){let t;return e?(t=super.detach(e),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(t=super.detach(),this.disconnectWebAudio()),t}setAudioContext(e){this.audioContext=e,e&&this.attachedElements.length>0?this.connectWebAudio(e,this.attachedElements[0]):e||this.disconnectWebAudio()}setWebAudioPlugins(e){this.webAudioPluginNodes=e,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio(e,t){this.disconnectWebAudio(),this.sourceNode=e.createMediaStreamSource(t.srcObject);let n=this.sourceNode;this.webAudioPluginNodes.forEach(r=>{n.connect(r),n=r}),this.gainNode=e.createGain(),n.connect(this.gainNode),this.gainNode.connect(e.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),e.state!=="running"&&e.resume().then(()=>{e.state!=="running"&&this.emit(ue.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))}).catch(r=>{this.emit(ue.AudioPlaybackFailed,r)})}disconnectWebAudio(){var e,t;(e=this.gainNode)===null||e===void 0||e.disconnect(),(t=this.sourceNode)===null||t===void 0||t.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return L(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t;return e.forEach(n=>{n.type==="inbound-rtp"&&(t={type:"audio",streamId:n.id,timestamp:n.timestamp,jitter:n.jitter,bytesReceived:n.bytesReceived,concealedSamples:n.concealedSamples,concealmentEvents:n.concealmentEvents,silentConcealedSamples:n.silentConcealedSamples,silentConcealmentEvents:n.silentConcealmentEvents,totalAudioEnergy:n.totalAudioEnergy,totalSamplesDuration:n.totalSamplesDuration})}),t})}}const cg=100;class X3 extends iM{constructor(e,t,n,r,a){super(e,t,se.Kind.Video,n,a),this.elementInfos=[],this.monitorReceiver=()=>L(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const o=yield this.getReceiverStats();o&&this.prevStats&&this.receiver&&(this._currentBitrate=zf(o,this.prevStats)),this.prevStats=o}),this.debouncedHandleResize=Bb(()=>{this.updateDimensions()},cg),this.adaptiveStreamSettings=r}get isAdaptiveStream(){return this.adaptiveStreamSettings!==void 0}setStreamState(e){super.setStreamState(e),this.log.debug("setStreamState",e),this.isAdaptiveStream&&e===se.StreamState.Active&&this.updateVisibility()}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(e){super.setMuted(e),this.attachedElements.forEach(t=>{e?rl(this._mediaStreamTrack,t):Wo(this._mediaStreamTrack,t)})}attach(e){if(e?super.attach(e):e=super.attach(),this.adaptiveStreamSettings&&this.elementInfos.find(t=>t.element===e)===void 0){const t=new Q3(e);this.observeElementInfo(t)}return e}observeElementInfo(e){this.adaptiveStreamSettings&&this.elementInfos.find(t=>t===e)===void 0?(e.handleResize=()=>{this.debouncedHandleResize()},e.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push(e),e.observe(),this.debouncedHandleResize(),this.updateVisibility()):this.log.warn("visibility resize observer not triggered",this.logContext)}stopObservingElementInfo(e){if(!this.isAdaptiveStream){this.log.warn("stopObservingElementInfo ignored",this.logContext);return}const t=this.elementInfos.filter(n=>n===e);for(const n of t)n.stopObserving();this.elementInfos=this.elementInfos.filter(n=>n!==e),this.updateVisibility(),this.debouncedHandleResize()}detach(e){let t=[];if(e)return this.stopObservingElement(e),super.detach(e);t=super.detach();for(const n of t)this.stopObservingElement(n);return t}getDecoderImplementation(){var e;return(e=this.prevStats)===null||e===void 0?void 0:e.decoderImplementation}getReceiverStats(){return L(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t,n="",r=new Map;return e.forEach(a=>{a.type==="inbound-rtp"?(n=a.codecId,t={type:"video",streamId:a.id,framesDecoded:a.framesDecoded,framesDropped:a.framesDropped,framesReceived:a.framesReceived,packetsReceived:a.packetsReceived,packetsLost:a.packetsLost,frameWidth:a.frameWidth,frameHeight:a.frameHeight,pliCount:a.pliCount,firCount:a.firCount,nackCount:a.nackCount,jitter:a.jitter,timestamp:a.timestamp,bytesReceived:a.bytesReceived,decoderImplementation:a.decoderImplementation}):a.type==="codec"&&r.set(a.id,a)}),t&&n!==""&&r.get(n)&&(t.mimeType=r.get(n).mimeType),t})}stopObservingElement(e){const t=this.elementInfos.filter(n=>n.element===e);for(const n of t)this.stopObservingElementInfo(n)}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return L(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()})}updateVisibility(e){var t,n;const r=this.elementInfos.reduce((d,h)=>Math.max(d,h.visibilityChangedAt||0),0),a=!((n=(t=this.adaptiveStreamSettings)===null||t===void 0?void 0:t.pauseVideoInBackground)!==null&&n!==void 0)||n?this.isInBackground:!1,o=this.elementInfos.some(d=>d.pictureInPicture),c=this.elementInfos.some(d=>d.visible)&&!a||o;if(!(this.lastVisible===c&&!e)){if(!c&&Date.now()-r<cg){En.setTimeout(()=>{this.updateVisibility()},cg);return}this.lastVisible=c,this.emit(ue.VisibilityChanged,c,this)}}updateDimensions(){var e,t;let n=0,r=0;const a=this.getPixelDensity();for(const o of this.elementInfos){const c=o.width()*a,d=o.height()*a;c+d>n+r&&(n=c,r=d)}((e=this.lastDimensions)===null||e===void 0?void 0:e.width)===n&&((t=this.lastDimensions)===null||t===void 0?void 0:t.height)===r||(this.lastDimensions={width:n,height:r},this.emit(ue.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var e;const t=(e=this.adaptiveStreamSettings)===null||e===void 0?void 0:e.pixelDensity;return t==="screen"?UR():t||(UR()>2?2:1)}}class Q3{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(e,t){this.onVisibilityChanged=n=>{var r;const{target:a,isIntersecting:o}=n;a===this.element&&(this.isIntersecting=o,this.isPiP=Fc(this.element),this.visibilityChangedAt=Date.now(),(r=this.handleVisibilityChanged)===null||r===void 0||r.call(this))},this.onEnterPiP=()=>{var n,r,a;(r=(n=window.documentPictureInPicture)===null||n===void 0?void 0:n.window)===null||r===void 0||r.addEventListener("pagehide",this.onLeavePiP),this.isPiP=Fc(this.element),(a=this.handleVisibilityChanged)===null||a===void 0||a.call(this)},this.onLeavePiP=()=>{var n;this.isPiP=Fc(this.element),(n=this.handleVisibilityChanged)===null||n===void 0||n.call(this)},this.element=e,this.isIntersecting=t??Py(e),this.isPiP=Gn()&&Fc(e),this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){var e,t,n;this.isIntersecting=Py(this.element),this.isPiP=Fc(this.element),this.element.handleResize=()=>{var r;(r=this.handleResize)===null||r===void 0||r.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,FR().observe(this.element),BR().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP),(e=window.documentPictureInPicture)===null||e===void 0||e.addEventListener("enter",this.onEnterPiP),(n=(t=window.documentPictureInPicture)===null||t===void 0?void 0:t.window)===null||n===void 0||n.addEventListener("pagehide",this.onLeavePiP)}stopObserving(){var e,t,n,r,a;(e=FR())===null||e===void 0||e.unobserve(this.element),(t=BR())===null||t===void 0||t.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP),(n=window.documentPictureInPicture)===null||n===void 0||n.removeEventListener("enter",this.onEnterPiP),(a=(r=window.documentPictureInPicture)===null||r===void 0?void 0:r.window)===null||a===void 0||a.removeEventListener("pagehide",this.onLeavePiP)}}function Fc(i){var e,t;return document.pictureInPictureElement===i?!0:!((e=window.documentPictureInPicture)===null||e===void 0)&&e.window?Py(i,(t=window.documentPictureInPicture)===null||t===void 0?void 0:t.window):!1}function Py(i,e){const t=e||window;let n=i.offsetTop,r=i.offsetLeft;const a=i.offsetWidth,o=i.offsetHeight,{hidden:c}=i,{display:d}=getComputedStyle(i);for(;i.offsetParent;)i=i.offsetParent,n+=i.offsetTop,r+=i.offsetLeft;return n<t.pageYOffset+t.innerHeight&&r<t.pageXOffset+t.innerWidth&&n+o>t.pageYOffset&&r+a>t.pageXOffset&&!c&&d!=="none"}class Fr extends vr.EventEmitter{constructor(e,t,n,r){var a;super(),this.metadataMuted=!1,this.encryption=rn.NONE,this.log=Fe,this.handleMuted=()=>{this.emit(ue.Muted)},this.handleUnmuted=()=>{this.emit(ue.Unmuted)},this.log=Xr((a=r?.loggerName)!==null&&a!==void 0?a:Wi.Publication),this.loggerContextCb=this.loggerContextCb,this.setMaxListeners(100),this.kind=e,this.trackSid=t,this.trackName=n,this.source=se.Source.Unknown}setTrack(e){this.track&&(this.track.off(ue.Muted,this.handleMuted),this.track.off(ue.Unmuted,this.handleUnmuted)),this.track=e,e&&(e.on(ue.Muted,this.handleMuted),e.on(ue.Unmuted,this.handleUnmuted))}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),We(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return this.track!==void 0}get isEncrypted(){return this.encryption!==rn.NONE}get audioTrack(){if(cr(this.track))return this.track}get videoTrack(){if(Ya(this.track))return this.track}updateInfo(e){this.trackSid=e.sid,this.trackName=e.name,this.source=se.sourceFromProto(e.source),this.mimeType=e.mimeType,this.kind===se.Kind.Video&&e.width>0&&(this.dimensions={width:e.width,height:e.height},this.simulcasted=e.simulcast),this.encryption=e.encryption,this.trackInfo=e,this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:e}))}}(function(i){(function(e){e.Desired="desired",e.Subscribed="subscribed",e.Unsubscribed="unsubscribed"})(i.SubscriptionStatus||(i.SubscriptionStatus={})),(function(e){e.Allowed="allowed",e.NotAllowed="not_allowed"})(i.PermissionStatus||(i.PermissionStatus={}))})(Fr||(Fr={}));class Ay extends Fr{get isUpstreamPaused(){var e;return(e=this.track)===null||e===void 0?void 0:e.isUpstreamPaused}constructor(e,t,n,r){super(e,t.sid,t.name,r),this.track=void 0,this.handleTrackEnded=()=>{this.emit(ue.Ended)},this.handleCpuConstrained=()=>{this.track&&Ya(this.track)&&this.emit(ue.CpuConstrained,this.track)},this.updateInfo(t),this.setTrack(n)}setTrack(e){this.track&&(this.track.off(ue.Ended,this.handleTrackEnded),this.track.off(ue.CpuConstrained,this.handleCpuConstrained)),super.setTrack(e),e&&(e.on(ue.Ended,this.handleTrackEnded),e.on(ue.CpuConstrained,this.handleCpuConstrained))}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}get isLocal(){return!0}mute(){return L(this,void 0,void 0,function*(){var e;return(e=this.track)===null||e===void 0?void 0:e.mute()})}unmute(){return L(this,void 0,void 0,function*(){var e;return(e=this.track)===null||e===void 0?void 0:e.unmute()})}pauseUpstream(){return L(this,void 0,void 0,function*(){var e;yield(e=this.track)===null||e===void 0?void 0:e.pauseUpstream()})}resumeUpstream(){return L(this,void 0,void 0,function*(){var e;yield(e=this.track)===null||e===void 0?void 0:e.resumeUpstream()})}getTrackFeatures(){var e;if(cr(this.track)){const t=this.track.getSourceTrackSettings(),n=new Set;return t.autoGainControl&&n.add(dn.TF_AUTO_GAIN_CONTROL),t.echoCancellation&&n.add(dn.TF_ECHO_CANCELLATION),t.noiseSuppression&&n.add(dn.TF_NOISE_SUPPRESSION),t.channelCount&&t.channelCount>1&&n.add(dn.TF_STEREO),!((e=this.options)===null||e===void 0)&&e.dtx||n.add(dn.TF_NO_DTX),this.track.enhancedNoiseCancellation&&n.add(dn.TF_ENHANCED_NOISE_CANCELLATION),Array.from(n.values())}else return[]}}function Wf(i,e){return L(this,void 0,void 0,function*(){i??(i={});let t=!1;const{audioProcessor:n,videoProcessor:r,optionsWithoutProcessor:a}=zO(i);let o=a.audio,c=a.video;if(n&&typeof a.audio=="object"&&(a.audio.processor=n),r&&typeof a.video=="object"&&(a.video.processor=r),i.audio&&typeof a.audio=="object"&&typeof a.audio.deviceId=="string"){const m=a.audio.deviceId;a.audio.deviceId={exact:m},t=!0,o=Object.assign(Object.assign({},a.audio),{deviceId:{ideal:m}})}if(a.video&&typeof a.video=="object"&&typeof a.video.deviceId=="string"){const m=a.video.deviceId;a.video.deviceId={exact:m},t=!0,c=Object.assign(Object.assign({},a.video),{deviceId:{ideal:m}})}a.audio===!0?a.audio={deviceId:"default"}:typeof a.audio=="object"&&a.audio!==null&&(a.audio=Object.assign(Object.assign({},a.audio),{deviceId:a.audio.deviceId||"default"})),a.video===!0?a.video={deviceId:"default"}:typeof a.video=="object"&&!a.video.deviceId&&(a.video.deviceId="default");const d=KO(a,JO,YO),h=xb(d),v=navigator.mediaDevices.getUserMedia(h);a.audio&&(hn.userMediaPromiseMap.set("audioinput",v),v.catch(()=>hn.userMediaPromiseMap.delete("audioinput"))),a.video&&(hn.userMediaPromiseMap.set("videoinput",v),v.catch(()=>hn.userMediaPromiseMap.delete("videoinput")));try{const m=yield v;return yield Promise.all(m.getTracks().map(y=>L(this,void 0,void 0,function*(){const E=y.kind==="audio";let T=E?d.audio:d.video;(typeof T=="boolean"||!T)&&(T={});let S;const O=E?h.audio:h.video;typeof O!="boolean"&&(S=O);const R=y.getSettings().deviceId;S?.deviceId&&Ha(S.deviceId)!==R?S.deviceId=R:S||(S={deviceId:R});const I=O3(y,S,e);return I.kind===se.Kind.Video?I.source=se.Source.Camera:I.kind===se.Kind.Audio&&(I.source=se.Source.Microphone),I.mediaStream=m,cr(I)&&n?yield I.setProcessor(n):Ya(I)&&r&&(yield I.setProcessor(r)),I})))}catch(m){if(!t)throw m;return Wf(Object.assign(Object.assign({},i),{audio:o,video:c}),e)}})}function Z3(i){return L(this,void 0,void 0,function*(){return(yield Wf({audio:!1,video:!0}))[0]})}function ej(i){return L(this,void 0,void 0,function*(){return(yield Wf({audio:!0,video:!1}))[0]})}var xa;(function(i){i.Excellent="excellent",i.Good="good",i.Poor="poor",i.Lost="lost",i.Unknown="unknown"})(xa||(xa={}));function tj(i){switch(i){case Kc.EXCELLENT:return xa.Excellent;case Kc.GOOD:return xa.Good;case Kc.POOR:return xa.Poor;case Kc.LOST:return xa.Lost;default:return xa.Unknown}}class aM extends vr.EventEmitter{get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions)===null||e===void 0?void 0:e.loggerContextCb)===null||t===void 0?void 0:t.call(e))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every(e=>e.isEncrypted)}get isAgent(){var e;return((e=this.permissions)===null||e===void 0?void 0:e.agent)||this.kind===gu.AGENT}get isActive(){var e;return((e=this.participantInfo)===null||e===void 0?void 0:e.state)===tl.ACTIVE}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor(e,t,n,r,a,o){let c=arguments.length>6&&arguments[6]!==void 0?arguments[6]:gu.STANDARD;var d;super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=xa.Unknown,this.log=Fe,this.log=Xr((d=o?.loggerName)!==null&&d!==void 0?d:Wi.Participant),this.loggerOptions=o,this.setMaxListeners(100),this.sid=e,this.identity=t,this.name=n,this.metadata=r,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this._kind=c,this._attributes=a??{}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication(e){for(const[,t]of this.trackPublications)if(t.source===e)return t}getTrackPublicationByName(e){for(const[,t]of this.trackPublications)if(t.trackName===e)return t}waitUntilActive(){return this.isActive?Promise.resolve():this.activeFuture?this.activeFuture.promise:(this.activeFuture=new Oi,this.once(ae.Active,()=>{var e,t;(t=(e=this.activeFuture)===null||e===void 0?void 0:e.resolve)===null||t===void 0||t.call(e),this.activeFuture=void 0}),this.activeFuture.promise)}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var e;const t=this.getTrackPublication(se.Source.Camera);return!(!((e=t?.isMuted)!==null&&e!==void 0)||e)}get isMicrophoneEnabled(){var e;const t=this.getTrackPublication(se.Source.Microphone);return!(!((e=t?.isMuted)!==null&&e!==void 0)||e)}get isScreenShareEnabled(){return!!this.getTrackPublication(se.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(Number.parseInt(this.participantInfo.joinedAt.toString())*1e3):new Date}updateInfo(e){var t;return this.participantInfo&&this.participantInfo.sid===e.sid&&this.participantInfo.version>e.version?!1:(this.identity=e.identity,this.sid=e.sid,this._setName(e.name),this._setMetadata(e.metadata),this._setAttributes(e.attributes),e.state===tl.ACTIVE&&((t=this.participantInfo)===null||t===void 0?void 0:t.state)!==tl.ACTIVE&&this.emit(ae.Active),e.permission&&this.setPermissions(e.permission),this.participantInfo=e,!0)}_setMetadata(e){const t=this.metadata!==e,n=this.metadata;this.metadata=e,t&&this.emit(ae.ParticipantMetadataChanged,n)}_setName(e){const t=this.name!==e;this.name=e,t&&this.emit(ae.ParticipantNameChanged,e)}_setAttributes(e){const t=JF(this.attributes,e);this._attributes=e,Object.keys(t).length>0&&this.emit(ae.AttributesChanged,t)}setPermissions(e){var t,n,r,a,o,c;const d=this.permissions,h=e.canPublish!==((t=this.permissions)===null||t===void 0?void 0:t.canPublish)||e.canSubscribe!==((n=this.permissions)===null||n===void 0?void 0:n.canSubscribe)||e.canPublishData!==((r=this.permissions)===null||r===void 0?void 0:r.canPublishData)||e.hidden!==((a=this.permissions)===null||a===void 0?void 0:a.hidden)||e.recorder!==((o=this.permissions)===null||o===void 0?void 0:o.recorder)||e.canPublishSources.length!==this.permissions.canPublishSources.length||e.canPublishSources.some((v,m)=>{var y;return v!==((y=this.permissions)===null||y===void 0?void 0:y.canPublishSources[m])})||e.canSubscribeMetrics!==((c=this.permissions)===null||c===void 0?void 0:c.canSubscribeMetrics);return this.permissions=e,h&&this.emit(ae.ParticipantPermissionsChanged,d),h}setIsSpeaking(e){e!==this.isSpeaking&&(this.isSpeaking=e,e&&(this.lastSpokeAt=new Date),this.emit(ae.IsSpeakingChanged,e))}setConnectionQuality(e){const t=this._connectionQuality;this._connectionQuality=tj(e),t!==this._connectionQuality&&this.emit(ae.ConnectionQualityChanged,this._connectionQuality)}setDisconnected(){var e,t;this.activeFuture&&((t=(e=this.activeFuture).reject)===null||t===void 0||t.call(e,new Error("Participant disconnected")),this.activeFuture=void 0)}setAudioContext(e){this.audioContext=e,this.audioTrackPublications.forEach(t=>cr(t.track)&&t.track.setAudioContext(e))}addTrackPublication(e){e.on(ue.Muted,()=>{this.emit(ae.TrackMuted,e)}),e.on(ue.Unmuted,()=>{this.emit(ae.TrackUnmuted,e)});const t=e;switch(t.track&&(t.track.sid=e.trackSid),this.trackPublications.set(e.trackSid,e),e.kind){case se.Kind.Audio:this.audioTrackPublications.set(e.trackSid,e);break;case se.Kind.Video:this.videoTrackPublications.set(e.trackSid,e);break}}}function nj(i){var e,t,n;if(!i.participantSid&&!i.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new tO({participantIdentity:(e=i.participantIdentity)!==null&&e!==void 0?e:"",participantSid:(t=i.participantSid)!==null&&t!==void 0?t:"",allTracks:(n=i.allowAll)!==null&&n!==void 0?n:!1,trackSids:i.allowedTrackSids||[]})}class ij extends aM{constructor(e,t,n,r,a,o){super(e,t,void 0,void 0,void 0,{loggerName:r.loggerName,loggerContextCb:()=>this.engine.logContext}),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=rn.NONE,this.enabledPublishVideoCodecs=[],this.pendingAcks=new Map,this.pendingResponses=new Map,this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new Oi)},this.handleReconnected=()=>{var c,d;(d=(c=this.reconnectFuture)===null||c===void 0?void 0:c.resolve)===null||d===void 0||d.call(c),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleClosing=()=>{var c,d,h,v,m,y;this.reconnectFuture&&(this.reconnectFuture.promise.catch(E=>this.log.warn(E.message,this.logContext)),(d=(c=this.reconnectFuture)===null||c===void 0?void 0:c.reject)===null||d===void 0||d.call(c,new Error("Got disconnected during reconnection attempt")),this.reconnectFuture=void 0),this.signalConnectedFuture&&((v=(h=this.signalConnectedFuture).reject)===null||v===void 0||v.call(h,new Error("Got disconnected without signal connected")),this.signalConnectedFuture=void 0),(y=(m=this.activeAgentFuture)===null||m===void 0?void 0:m.reject)===null||y===void 0||y.call(m,new Error("Got disconnected without active agent present")),this.activeAgentFuture=void 0,this.firstActiveAgent=void 0},this.handleSignalConnected=c=>{var d,h;c.participant&&this.updateInfo(c.participant),this.signalConnectedFuture||(this.signalConnectedFuture=new Oi),(h=(d=this.signalConnectedFuture).resolve)===null||h===void 0||h.call(d)},this.handleSignalRequestResponse=c=>{const{requestId:d,reason:h,message:v}=c,m=this.pendingSignalRequests.get(d);m&&(h!==Pb.OK&&m.reject(new AR(v,h)),this.pendingSignalRequests.delete(d))},this.handleDataPacket=c=>{switch(c.value.case){case"rpcResponse":let d=c.value.value,h=null,v=null;d.value.case==="payload"?h=d.value.value:d.value.case==="error"&&(v=Ft.fromProto(d.value.value)),this.handleIncomingRpcResponse(d.requestId,h,v);break;case"rpcAck":let m=c.value.value;this.handleIncomingRpcAck(m.requestId);break}},this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions})),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map(c=>nj(c)))},this.onTrackUnmuted=c=>{this.onTrackMuted(c,c.isUpstreamPaused)},this.onTrackMuted=(c,d)=>{if(d===void 0&&(d=!0),!c.sid){this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),We(c)));return}this.engine.updateMuteStatus(c.sid,d)},this.onTrackUpstreamPaused=c=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),We(c))),this.onTrackMuted(c,!0)},this.onTrackUpstreamResumed=c=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),We(c))),this.onTrackMuted(c,c.isMuted)},this.onTrackFeatureUpdate=c=>{const d=this.audioTrackPublications.get(c.sid);if(!d){this.log.warn("Could not update local audio track settings, missing publication for track ".concat(c.sid),this.logContext);return}this.engine.client.sendUpdateLocalAudioTrack(d.trackSid,d.getTrackFeatures())},this.onTrackCpuConstrained=(c,d)=>{this.log.debug("track cpu constrained",Object.assign(Object.assign({},this.logContext),We(d))),this.emit(ae.LocalTrackCpuConstrained,c,d)},this.handleSubscribedQualityUpdate=c=>L(this,void 0,void 0,function*(){var d,h,v,m,y;if(!(!((y=this.roomOptions)===null||y===void 0)&&y.dynacast))return;const E=this.videoTrackPublications.get(c.trackSid);if(!E){this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:c.trackSid}));return}if(!E.videoTrack)return;const T=yield E.videoTrack.setPublishingCodecs(c.subscribedCodecs);try{for(var S=!0,O=Hr(T),R;R=yield O.next(),d=R.done,!d;S=!0){m=R.value,S=!1;const I=m;CF(I)&&(this.log.debug("publish ".concat(I," for ").concat(E.videoTrack.sid),Object.assign(Object.assign({},this.logContext),We(E))),yield this.publishAdditionalCodecForTrack(E.videoTrack,I,E.options))}}catch(I){h={error:I}}finally{try{!S&&!d&&(v=O.return)&&(yield v.call(O))}finally{if(h)throw h.error}}}),this.handleLocalTrackUnpublished=c=>{const d=this.trackPublications.get(c.trackSid);if(!d){this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:c.trackSid}));return}this.unpublishTrack(d.track)},this.handleTrackEnded=c=>L(this,void 0,void 0,function*(){if(c.source===se.Source.ScreenShare||c.source===se.Source.ScreenShareAudio)this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),We(c))),this.unpublishTrack(c);else if(c.isUserProvided)yield c.mute();else if(Lr(c)||Ia(c))try{if(Gn())try{const d=yield navigator?.permissions.query({name:c.source===se.Source.Camera?"camera":"microphone"});if(d&&d.state==="denied")throw this.log.warn("user has revoked access to ".concat(c.source),Object.assign(Object.assign({},this.logContext),We(c))),d.onchange=()=>{d.state!=="denied"&&(c.isMuted||c.restartTrack(),d.onchange=null)},new Error("GetUserMedia Permission denied")}catch{}c.isMuted||(this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),We(c))),Lr(c)?yield c.restartTrack({deviceId:"default"}):yield c.restartTrack())}catch{this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),We(c))),yield c.mute()}}),this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this.engine=n,this.roomOptions=r,this.setupEngine(n),this.activeDeviceMap=new Map([["audioinput","default"],["videoinput","default"],["audiooutput","default"]]),this.pendingSignalRequests=new Map,this.rpcHandlers=a,this.roomOutgoingDataStreamManager=o}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==rn.NONE}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setupEngine(e){var t;this.engine=e,this.engine.on(fe.RemoteMute,(n,r)=>{const a=this.trackPublications.get(n);!a||!a.track||(r?a.mute():a.unmute())}),!((t=this.signalConnectedFuture)===null||t===void 0)&&t.isResolved&&(this.signalConnectedFuture=void 0),this.engine.on(fe.Connected,this.handleReconnected).on(fe.SignalConnected,this.handleSignalConnected).on(fe.SignalRestarted,this.handleReconnected).on(fe.SignalResumed,this.handleReconnected).on(fe.Restarting,this.handleReconnecting).on(fe.Resuming,this.handleReconnecting).on(fe.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(fe.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(fe.Closing,this.handleClosing).on(fe.SignalRequestResponse,this.handleSignalRequestResponse).on(fe.DataPacketReceived,this.handleDataPacket)}setMetadata(e){return L(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({metadata:e})})}setName(e){return L(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({name:e})})}setAttributes(e){return L(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({attributes:e})})}requestMetadataUpdate(e){return L(this,arguments,void 0,function(t){var n=this;let{metadata:r,name:a,attributes:o}=t;return(function*(){return new Promise((c,d)=>L(n,void 0,void 0,function*(){var h,v;try{let m=!1;const y=yield this.engine.client.sendUpdateLocalMetadata((h=r??this.metadata)!==null&&h!==void 0?h:"",(v=a??this.name)!==null&&v!==void 0?v:"",o),E=performance.now();for(this.pendingSignalRequests.set(y,{resolve:c,reject:T=>{d(T),m=!0},values:{name:a,metadata:r,attributes:o}});performance.now()-E<5e3&&!m;){if((!a||this.name===a)&&(!r||this.metadata===r)&&(!o||Object.entries(o).every(T=>{let[S,O]=T;return this.attributes[S]===O||O===""&&!this.attributes[S]}))){this.pendingSignalRequests.delete(y),c();return}yield Tn(50)}d(new AR("Request to update local metadata timed out","TimeoutError"))}catch(m){m instanceof Error&&d(m)}}))})()})}setCameraEnabled(e,t,n){return this.setTrackEnabled(se.Source.Camera,e,t,n)}setMicrophoneEnabled(e,t,n){return this.setTrackEnabled(se.Source.Microphone,e,t,n)}setScreenShareEnabled(e,t,n){return this.setTrackEnabled(se.Source.ScreenShare,e,t,n)}setE2EEEnabled(e){return L(this,void 0,void 0,function*(){this.encryptionType=e?rn.GCM:rn.NONE,yield this.republishAllTracks(void 0,!1)})}setTrackEnabled(e,t,n,r){return L(this,void 0,void 0,function*(){var a,o;this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:e,enabled:t})),this.republishPromise&&(yield this.republishPromise);let c=this.getTrackPublication(e);if(t)if(c)yield c.unmute();else{let d;if(this.pendingPublishing.has(e)){const h=yield this.waitForPendingPublicationOfSource(e);return h||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e})),yield h?.unmute(),h}this.pendingPublishing.add(e);try{switch(e){case se.Source.Camera:d=yield this.createTracks({video:(a=n)!==null&&a!==void 0?a:!0});break;case se.Source.Microphone:d=yield this.createTracks({audio:(o=n)!==null&&o!==void 0?o:!0});break;case se.Source.ScreenShare:d=yield this.createScreenTracks(Object.assign({},n));break;default:throw new Gr(e)}}catch(h){throw d?.forEach(v=>{v.stop()}),h instanceof Error&&this.emit(ae.MediaDevicesError,h,wy(e)),this.pendingPublishing.delete(e),h}for(const h of d){const v=Object.assign(Object.assign({},this.roomOptions.publishDefaults),n);e===se.Source.Microphone&&cr(h)&&v.preConnectBuffer&&(this.log.info("starting preconnect buffer for microphone",Object.assign({},this.logContext)),h.startPreConnectBuffer())}try{const h=[];for(const m of d)this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),We(m))),h.push(this.publishTrack(m,r));[c]=yield Promise.all(h)}catch(h){throw d?.forEach(v=>{v.stop()}),h}finally{this.pendingPublishing.delete(e)}}else if(!c?.track&&this.pendingPublishing.has(e)&&(c=yield this.waitForPendingPublicationOfSource(e),c||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e}))),c&&c.track)if(e===se.Source.ScreenShare){c=yield this.unpublishTrack(c.track);const d=this.getTrackPublication(se.Source.ScreenShareAudio);d&&d.track&&this.unpublishTrack(d.track)}else yield c.mute();return c})}enableCameraAndMicrophone(){return L(this,void 0,void 0,function*(){if(!(this.pendingPublishing.has(se.Source.Camera)||this.pendingPublishing.has(se.Source.Microphone))){this.pendingPublishing.add(se.Source.Camera),this.pendingPublishing.add(se.Source.Microphone);try{const e=yield this.createTracks({audio:!0,video:!0});yield Promise.all(e.map(t=>this.publishTrack(t)))}finally{this.pendingPublishing.delete(se.Source.Camera),this.pendingPublishing.delete(se.Source.Microphone)}}})}createTracks(e){return L(this,void 0,void 0,function*(){var t,n;e??(e={});const r=KO(e,(t=this.roomOptions)===null||t===void 0?void 0:t.audioCaptureDefaults,(n=this.roomOptions)===null||n===void 0?void 0:n.videoCaptureDefaults);try{return(yield Wf(r,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext})).map(c=>(cr(c)&&(this.microphoneError=void 0,c.setAudioContext(this.audioContext),c.source=se.Source.Microphone,this.emit(ae.AudioStreamAcquired)),Ya(c)&&(this.cameraError=void 0,c.source=se.Source.Camera),c))}catch(a){throw a instanceof Error&&(e.audio&&(this.microphoneError=a),e.video&&(this.cameraError=a)),a}})}createScreenTracks(e){return L(this,void 0,void 0,function*(){if(e===void 0&&(e={}),navigator.mediaDevices.getDisplayMedia===void 0)throw new Db("getDisplayMedia not supported");e.resolution===void 0&&!MF()&&(e.resolution=Nb.h1080fps30.resolution);const t=GF(e),n=yield navigator.mediaDevices.getDisplayMedia(t),r=n.getVideoTracks();if(r.length===0)throw new Gr("no video track found");const a=new mf(r[0],void 0,!1,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});a.source=se.Source.ScreenShare,e.contentHint&&(a.mediaStreamTrack.contentHint=e.contentHint);const o=[a];if(n.getAudioTracks().length>0){this.emit(ae.AudioStreamAcquired);const c=new vf(n.getAudioTracks()[0],void 0,!1,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});c.source=se.Source.ScreenShareAudio,o.push(c)}return o})}publishTrack(e,t){return L(this,void 0,void 0,function*(){return this.publishOrRepublishTrack(e,t)})}publishOrRepublishTrack(e,t){return L(this,arguments,void 0,function(n,r){var a=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return(function*(){var c,d,h,v;Lr(n)&&n.setAudioContext(a.audioContext),yield(c=a.reconnectFuture)===null||c===void 0?void 0:c.promise,a.republishPromise&&!o&&(yield a.republishPromise),Us(n)&&a.pendingPublishPromises.has(n)&&(yield a.pendingPublishPromises.get(n));let m;if(n instanceof MediaStreamTrack)m=n.getConstraints();else{m=n.constraints;let R;switch(n.source){case se.Source.Microphone:R="audioinput";break;case se.Source.Camera:R="videoinput"}R&&a.activeDeviceMap.has(R)&&(m=Object.assign(Object.assign({},m),{deviceId:a.activeDeviceMap.get(R)}))}if(n instanceof MediaStreamTrack)switch(n.kind){case"audio":n=new vf(n,m,!0,a.audioContext,{loggerName:a.roomOptions.loggerName,loggerContextCb:()=>a.logContext});break;case"video":n=new mf(n,m,!0,{loggerName:a.roomOptions.loggerName,loggerContextCb:()=>a.logContext});break;default:throw new Gr("unsupported MediaStreamTrack kind ".concat(n.kind))}else n.updateLoggerOptions({loggerName:a.roomOptions.loggerName,loggerContextCb:()=>a.logContext});let y;if(a.trackPublications.forEach(R=>{R.track&&R.track===n&&(y=R)}),y)return a.log.warn("track has already been published, skipping",Object.assign(Object.assign({},a.logContext),We(y))),y;const E=Object.assign(Object.assign({},a.roomOptions.publishDefaults),r),T="channelCount"in n.mediaStreamTrack.getSettings()&&n.mediaStreamTrack.getSettings().channelCount===2||n.mediaStreamTrack.getConstraints().channelCount===2,S=(d=E.forceStereo)!==null&&d!==void 0?d:T;S&&(E.dtx===void 0&&a.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},a.logContext),We(n))),E.red===void 0&&a.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),(h=E.dtx)!==null&&h!==void 0||(E.dtx=!1),(v=E.red)!==null&&v!==void 0||(E.red=!1)),!AF()&&a.roomOptions.e2ee&&(a.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},a.logContext)),E.simulcast=!1),E.source&&(n.source=E.source);const O=new Promise((R,I)=>L(a,void 0,void 0,function*(){try{if(this.engine.client.currentState!==St.CONNECTED){this.log.debug("deferring track publication until signal is connected",Object.assign(Object.assign({},this.logContext),{track:We(n)}));let M=!1;const C=setTimeout(()=>{M=!0,n.stop(),I(new PR("publishing rejected as engine not connected within timeout",408))},15e3);if(yield this.waitUntilEngineConnected(),clearTimeout(C),M)return;const k=yield this.publish(n,E,S);R(k)}else try{const M=yield this.publish(n,E,S);R(M)}catch(M){I(M)}}catch(M){I(M)}}));a.pendingPublishPromises.set(n,O);try{return yield O}catch(R){throw R}finally{a.pendingPublishPromises.delete(n)}})()})}waitUntilEngineConnected(){return this.signalConnectedFuture||(this.signalConnectedFuture=new Oi),this.signalConnectedFuture.promise}hasPermissionsToPublish(e){if(!this.permissions)return this.log.warn("no permissions present for publishing track",Object.assign(Object.assign({},this.logContext),We(e))),!1;const{canPublish:t,canPublishSources:n}=this.permissions;return t&&(n.length===0||n.map(r=>YF(r)).includes(e.source))?!0:(this.log.warn("insufficient permissions to publish",Object.assign(Object.assign({},this.logContext),We(e))),!1)}publish(e,t,n){return L(this,void 0,void 0,function*(){var r,a,o,c,d,h,v,m,y,E;if(!this.hasPermissionsToPublish(e))throw new PR("failed to publish track, insufficient permissions",403);Array.from(this.trackPublications.values()).find(U=>Us(e)&&U.source===e.source)&&e.source!==se.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat(e.source),Object.assign(Object.assign({},this.logContext),We(e))),t.stopMicTrackOnMute&&cr(e)&&(e.stopOnMute=!0),e.source===se.Source.ScreenShare&&qs()&&(t.simulcast=!1),t.videoCodec==="av1"&&!wF()&&(t.videoCodec=void 0),t.videoCodec==="vp9"&&!IF()&&(t.videoCodec=void 0),t.videoCodec===void 0&&(t.videoCodec=Iy),this.enabledPublishVideoCodecs.length>0&&(this.enabledPublishVideoCodecs.some(U=>t.videoCodec===eu(U.mime))||(t.videoCodec=eu(this.enabledPublishVideoCodecs[0].mime)));const S=t.videoCodec;e.on(ue.Muted,this.onTrackMuted),e.on(ue.Unmuted,this.onTrackUnmuted),e.on(ue.Ended,this.handleTrackEnded),e.on(ue.UpstreamPaused,this.onTrackUpstreamPaused),e.on(ue.UpstreamResumed,this.onTrackUpstreamResumed),e.on(ue.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);const O=[],R=!(!((r=t.dtx)!==null&&r!==void 0)||r),I=e.getSourceTrackSettings();I.autoGainControl&&O.push(dn.TF_AUTO_GAIN_CONTROL),I.echoCancellation&&O.push(dn.TF_ECHO_CANCELLATION),I.noiseSuppression&&O.push(dn.TF_NOISE_SUPPRESSION),I.channelCount&&I.channelCount>1&&O.push(dn.TF_STEREO),R&&O.push(dn.TF_NO_DTX),Lr(e)&&e.hasPreConnectBuffer&&O.push(dn.TF_PRECONNECT_BUFFER);const M=new yu({cid:e.mediaStreamTrack.id,name:t.name,type:se.kindToProto(e.kind),muted:e.isMuted,source:se.sourceToProto(e.source),disableDtx:R,encryption:this.encryptionType,stereo:n,disableRed:this.isE2EEEnabled||!(!((a=t.red)!==null&&a!==void 0)||a),stream:t?.stream,backupCodecPolicy:t?.backupCodecPolicy,audioFeatures:O});let C;if(e.kind===se.Kind.Video){let U={width:0,height:0};try{U=yield e.waitForDimensions()}catch{const K=(c=(o=this.roomOptions.videoCaptureDefaults)===null||o===void 0?void 0:o.resolution)!==null&&c!==void 0?c:Eu.h720.resolution;U={width:K.width,height:K.height},this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),We(e)),{dims:U}))}M.width=U.width,M.height=U.height,Ia(e)&&(Ki(S)&&(e.source===se.Source.ScreenShare&&(t.scalabilityMode="L1T3","contentHint"in e.mediaStreamTrack&&(e.mediaStreamTrack.contentHint="motion",this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),We(e))))),t.scalabilityMode=(d=t.scalabilityMode)!==null&&d!==void 0?d:"L3T3_KEY"),M.simulcastCodecs=[new dy({codec:S,cid:e.mediaStreamTrack.id})],t.backupCodec===!0&&(t.backupCodec={codec:Iy}),t.backupCodec&&S!==t.backupCodec.codec&&M.encryption===rn.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),M.simulcastCodecs.push(new dy({codec:t.backupCodec.codec,cid:""})))),C=My(e.source===se.Source.ScreenShare,M.width,M.height,t),M.layers=ik(M.width,M.height,C,Ki(t.videoCodec))}else e.kind===se.Kind.Audio&&(C=[{maxBitrate:(h=t.audioPreset)===null||h===void 0?void 0:h.maxBitrate,priority:(m=(v=t.audioPreset)===null||v===void 0?void 0:v.priority)!==null&&m!==void 0?m:"high",networkPriority:(E=(y=t.audioPreset)===null||y===void 0?void 0:y.priority)!==null&&E!==void 0?E:"high"}]);if(!this.engine||this.engine.isClosed)throw new Zt("cannot publish track when not connected");const k=()=>L(this,void 0,void 0,function*(){var U,j,K;if(!this.engine.pcManager)throw new Zt("pcManager is not ready");if(e.sender=yield this.engine.createSender(e,t,C),this.emit(ae.LocalSenderCreated,e.sender,e),Ia(e)&&((U=t.degradationPreference)!==null&&U!==void 0||(t.degradationPreference=F3(e)),e.setDegradationPreference(t.degradationPreference)),C)if(qs()&&e.kind===se.Kind.Audio){let Z;for(const be of this.engine.pcManager.publisher.getTransceivers())if(be.sender===e.sender){Z=be;break}Z&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:Z,codec:"opus",maxbr:!((j=C[0])===null||j===void 0)&&j.maxBitrate?C[0].maxBitrate/1e3:0})}else e.codec&&Ki(e.codec)&&(!((K=C[0])===null||K===void 0)&&K.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:M.cid,codec:e.codec,maxbr:C[0].maxBitrate/1e3});yield this.engine.negotiate()});let _;const P=new Promise((U,j)=>L(this,void 0,void 0,function*(){var K;try{_=yield this.engine.addTrack(M),U(_)}catch(Z){e.sender&&(!((K=this.engine.pcManager)===null||K===void 0)&&K.publisher)&&(this.engine.pcManager.publisher.removeTrack(e.sender),yield this.engine.negotiate().catch(be=>{this.log.error("failed to negotiate after removing track due to failed add track request",Object.assign(Object.assign(Object.assign({},this.logContext),We(e)),{error:be}))})),j(Z)}}));if(this.enabledPublishVideoCodecs.length>0)_=(yield Promise.all([P,k()]))[0];else{_=yield P;let U;if(_.codecs.forEach(j=>{U===void 0&&(U=j.mimeType)}),U&&e.kind===se.Kind.Video){const j=eu(U);j!==S&&(this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),We(e)),{codec:j})),t.videoCodec=j,C=My(e.source===se.Source.ScreenShare,M.width,M.height,t))}yield k()}const x=new Ay(e.kind,_,e,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});if(x.on(ue.CpuConstrained,U=>this.onTrackCpuConstrained(U,x)),x.options=t,e.sid=_.sid,this.log.debug("publishing ".concat(e.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:C,trackInfo:_})),Ia(e)?e.startMonitor(this.engine.client):Lr(e)&&e.startMonitor(),this.addTrackPublication(x),this.emit(ae.LocalTrackPublished,x),Lr(e)&&_.audioFeatures.includes(dn.TF_PRECONNECT_BUFFER)){const U=e.getPreConnectBuffer(),j=e.getPreConnectBufferMimeType();this.on(ae.LocalTrackSubscribed,K=>{if(K.trackSid===_.sid){if(!e.hasPreConnectBuffer){this.log.warn("subscribe event came to late, buffer already closed",this.logContext);return}this.log.debug("finished recording preconnect buffer",Object.assign(Object.assign({},this.logContext),We(e))),e.stopPreConnectBuffer()}}),U&&new Promise((Z,be)=>L(this,void 0,void 0,function*(){var Pe,ce,V,Q,le,ve;try{this.log.debug("waiting for agent",Object.assign(Object.assign({},this.logContext),We(e)));const de=setTimeout(()=>{be(new Error("agent not active within 10 seconds"))},1e4),pe=yield this.waitUntilActiveAgentPresent();clearTimeout(de),this.log.debug("sending preconnect buffer",Object.assign(Object.assign({},this.logContext),We(e)));const Re=yield this.streamBytes({name:"preconnect-buffer",mimeType:j,topic:"lk.agent.pre-connect-audio-buffer",destinationIdentities:[pe.identity],attributes:{trackId:x.trackSid,sampleRate:String((le=I.sampleRate)!==null&&le!==void 0?le:"48000"),channels:String((ve=I.channelCount)!==null&&ve!==void 0?ve:"1")}});try{for(var Te=!0,F=Hr(U),ee;ee=yield F.next(),Pe=ee.done,!Pe;Te=!0){Q=ee.value,Te=!1;const Ae=Q;yield Re.write(Ae)}}catch(Ae){ce={error:Ae}}finally{try{!Te&&!Pe&&(V=F.return)&&(yield V.call(F))}finally{if(ce)throw ce.error}}yield Re.close(),Z()}catch(de){be(de)}})).then(()=>{this.log.debug("preconnect buffer sent successfully",Object.assign(Object.assign({},this.logContext),We(e)))}).catch(Z=>{this.log.error("error sending preconnect buffer",Object.assign(Object.assign(Object.assign({},this.logContext),We(e)),{error:Z}))})}return x})}get isLocal(){return!0}publishAdditionalCodecForTrack(e,t,n){return L(this,void 0,void 0,function*(){var r;if(this.encryptionType!==rn.NONE)return;let a;if(this.trackPublications.forEach(E=>{E.track&&E.track===e&&(a=E)}),!a)throw new Gr("track is not published");if(!Ia(e))throw new Gr("track is not a video track");const o=Object.assign(Object.assign({},(r=this.roomOptions)===null||r===void 0?void 0:r.publishDefaults),n),c=L3(e,t,o);if(!c){this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),We(e)));return}const d=e.addSimulcastTrack(t,c);if(!d)return;const h=new yu({cid:d.mediaStreamTrack.id,type:se.kindToProto(e.kind),muted:e.isMuted,source:se.sourceToProto(e.source),sid:e.sid,simulcastCodecs:[{codec:o.videoCodec,cid:d.mediaStreamTrack.id}]});if(h.layers=ik(h.width,h.height,c),!this.engine||this.engine.isClosed)throw new Zt("cannot publish track when not connected");const v=()=>L(this,void 0,void 0,function*(){yield this.engine.createSimulcastSender(e,d,o,c),yield this.engine.negotiate()}),y=(yield Promise.all([this.engine.addTrack(h),v()]))[0];this.log.debug("published ".concat(t," for track ").concat(e.sid),Object.assign(Object.assign({},this.logContext),{encodings:c,trackInfo:y}))})}unpublishTrack(e,t){return L(this,void 0,void 0,function*(){var n,r;if(Us(e)){const h=this.pendingPublishPromises.get(e);h&&(this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),We(e))),yield h)}const a=this.getPublicationForTrack(e),o=a?We(a):void 0;if(this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),o)),!a||!a.track){this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),o));return}e=a.track,e.off(ue.Muted,this.onTrackMuted),e.off(ue.Unmuted,this.onTrackUnmuted),e.off(ue.Ended,this.handleTrackEnded),e.off(ue.UpstreamPaused,this.onTrackUpstreamPaused),e.off(ue.UpstreamResumed,this.onTrackUpstreamResumed),e.off(ue.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate),t===void 0&&(t=(r=(n=this.roomOptions)===null||n===void 0?void 0:n.stopLocalTrackOnUnpublish)!==null&&r!==void 0?r:!0),t?e.stop():e.stopMonitor();let c=!1;const d=e.sender;if(e.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<Ut.FAILED&&d)try{for(const h of this.engine.pcManager.publisher.getTransceivers())h.sender===d&&(h.direction="inactive",c=!0);if(this.engine.removeTrack(d)&&(c=!0),Ia(e)){for(const[,h]of e.simulcastCodecs)h.sender&&(this.engine.removeTrack(h.sender)&&(c=!0),h.sender=void 0);e.simulcastCodecs.clear()}}catch(h){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),o),{error:h}))}switch(this.trackPublications.delete(a.trackSid),a.kind){case se.Kind.Audio:this.audioTrackPublications.delete(a.trackSid);break;case se.Kind.Video:this.videoTrackPublications.delete(a.trackSid);break}return this.emit(ae.LocalTrackUnpublished,a),a.setTrack(void 0),c&&(yield this.engine.negotiate()),a})}unpublishTracks(e){return L(this,void 0,void 0,function*(){return(yield Promise.all(e.map(n=>this.unpublishTrack(n)))).filter(n=>!!n)})}republishAllTracks(e){return L(this,arguments,void 0,function(t){var n=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){n.republishPromise&&(yield n.republishPromise),n.republishPromise=new Promise((a,o)=>L(n,void 0,void 0,function*(){try{const c=[];this.trackPublications.forEach(d=>{d.track&&(t&&(d.options=Object.assign(Object.assign({},d.options),t)),c.push(d))}),yield Promise.all(c.map(d=>L(this,void 0,void 0,function*(){const h=d.track;yield this.unpublishTrack(h,!1),r&&!h.isMuted&&h.source!==se.Source.ScreenShare&&h.source!==se.Source.ScreenShareAudio&&(Lr(h)||Ia(h))&&!h.isUserProvided&&(this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:d.trackSid})),yield h.restartTrack()),yield this.publishOrRepublishTrack(h,d.options,!0)}))),a()}catch(c){o(c)}finally{this.republishPromise=void 0}})),yield n.republishPromise})()})}publishData(e){return L(this,arguments,void 0,function(t){var n=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return(function*(){const a=r.reliable?Je.RELIABLE:Je.LOSSY,o=r.destinationIdentities,c=r.topic;let d=new Tb({participantIdentity:n.identity,payload:t,destinationIdentities:o,topic:c});const h=new Pn({kind:a,value:{case:"user",value:d}});yield n.engine.sendDataPacket(h,a)})()})}publishDtmf(e,t){return L(this,void 0,void 0,function*(){const n=new Pn({kind:Je.RELIABLE,value:{case:"sipDtmf",value:new jI({code:e,digit:t})}});yield this.engine.sendDataPacket(n,Je.RELIABLE)})}sendChatMessage(e,t){return L(this,void 0,void 0,function*(){const n={id:crypto.randomUUID(),message:e,timestamp:Date.now(),attachedFiles:t?.attachments},r=new Pn({value:{case:"chatMessage",value:new cf(Object.assign(Object.assign({},n),{timestamp:Pt.parse(n.timestamp)}))}});return yield this.engine.sendDataPacket(r,Je.RELIABLE),this.emit(ae.ChatMessage,n),n})}editChatMessage(e,t){return L(this,void 0,void 0,function*(){const n=Object.assign(Object.assign({},t),{message:e,editTimestamp:Date.now()}),r=new Pn({value:{case:"chatMessage",value:new cf(Object.assign(Object.assign({},n),{timestamp:Pt.parse(n.timestamp),editTimestamp:Pt.parse(n.editTimestamp)}))}});return yield this.engine.sendDataPacket(r,Je.RELIABLE),this.emit(ae.ChatMessage,n),n})}sendText(e,t){return L(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendText(e,t)})}streamText(e){return L(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamText(e)})}sendFile(e,t){return L(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendFile(e,t)})}streamBytes(e){return L(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamBytes(e)})}performRpc(e){return L(this,arguments,void 0,function(t){var n=this;let{destinationIdentity:r,method:a,payload:o,responseTimeout:c=15e3}=t;return(function*(){return new Promise((v,m)=>L(n,void 0,void 0,function*(){var y,E,T,S;if(qb(o)>XO){m(Ft.builtIn("REQUEST_PAYLOAD_TOO_LARGE"));return}if(!((E=(y=this.engine.latestJoinResponse)===null||y===void 0?void 0:y.serverInfo)===null||E===void 0)&&E.version&&dr((S=(T=this.engine.latestJoinResponse)===null||T===void 0?void 0:T.serverInfo)===null||S===void 0?void 0:S.version,"1.8.0")<0){m(Ft.builtIn("UNSUPPORTED_SERVER"));return}const O=Math.max(c,8e3),R=crypto.randomUUID();yield this.publishRpcRequest(r,R,a,o,O);const I=setTimeout(()=>{this.pendingAcks.delete(R),m(Ft.builtIn("CONNECTION_TIMEOUT")),this.pendingResponses.delete(R),clearTimeout(M)},7e3);this.pendingAcks.set(R,{resolve:()=>{clearTimeout(I)},participantIdentity:r});const M=setTimeout(()=>{this.pendingResponses.delete(R),m(Ft.builtIn("RESPONSE_TIMEOUT"))},c);this.pendingResponses.set(R,{resolve:(C,k)=>{clearTimeout(M),this.pendingAcks.has(R)&&(console.warn("RPC response received before ack",R),this.pendingAcks.delete(R),clearTimeout(I)),k?m(k):v(C??"")},participantIdentity:r})}))})()})}registerRpcMethod(e,t){this.rpcHandlers.has(e)&&this.log.warn("you're overriding the RPC handler for method ".concat(e,", in the future this will throw an error")),this.rpcHandlers.set(e,t)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setTrackSubscriptionPermissions(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];this.participantTrackPermissions=t,this.allParticipantsAllowedToSubscribe=e,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}handleIncomingRpcAck(e){const t=this.pendingAcks.get(e);t?(t.resolve(),this.pendingAcks.delete(e)):console.error("Ack received for unexpected RPC request",e)}handleIncomingRpcResponse(e,t,n){const r=this.pendingResponses.get(e);r?(r.resolve(t,n),this.pendingResponses.delete(e)):console.error("Response received for unexpected RPC request",e)}publishRpcRequest(e,t,n,r,a){return L(this,void 0,void 0,function*(){const o=new Pn({destinationIdentities:[e],kind:Je.RELIABLE,value:{case:"rpcRequest",value:new _b({id:t,method:n,payload:r,responseTimeoutMs:a,version:1})}});yield this.engine.sendDataPacket(o,Je.RELIABLE)})}handleParticipantDisconnected(e){for(const[t,{participantIdentity:n}]of this.pendingAcks)n===e&&this.pendingAcks.delete(t);for(const[t,{participantIdentity:n,resolve:r}]of this.pendingResponses)n===e&&(r(null,Ft.builtIn("RECIPIENT_DISCONNECTED")),this.pendingResponses.delete(t))}setEnabledPublishCodecs(e){this.enabledPublishVideoCodecs=e.filter(t=>t.mime.split("/")[0].toLowerCase()==="video")}updateInfo(e){return super.updateInfo(e)?(e.tracks.forEach(t=>{var n,r;const a=this.trackPublications.get(t.sid);if(a){const o=a.isMuted||((r=(n=a.track)===null||n===void 0?void 0:n.isUpstreamPaused)!==null&&r!==void 0?r:!1);o!==t.muted&&(this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),We(a)),{mutedOnServer:o})),this.engine.client.sendMuteTrack(t.sid,o))}}),!0):!1}setActiveAgent(e){var t,n,r,a;this.firstActiveAgent=e,e&&!this.firstActiveAgent&&(this.firstActiveAgent=e),e?(n=(t=this.activeAgentFuture)===null||t===void 0?void 0:t.resolve)===null||n===void 0||n.call(t,e):(a=(r=this.activeAgentFuture)===null||r===void 0?void 0:r.reject)===null||a===void 0||a.call(r,new Error("Agent disconnected")),this.activeAgentFuture=void 0}waitUntilActiveAgentPresent(){return this.firstActiveAgent?Promise.resolve(this.firstActiveAgent):(this.activeAgentFuture||(this.activeAgentFuture=new Oi),this.activeAgentFuture.promise)}getPublicationForTrack(e){let t;return this.trackPublications.forEach(n=>{const r=n.track;r&&(e instanceof MediaStreamTrack?(Lr(r)||Ia(r))&&r.mediaStreamTrack===e&&(t=n):e===r&&(t=n))}),t}waitForPendingPublicationOfSource(e){return L(this,void 0,void 0,function*(){const n=Date.now();for(;Date.now()<n+1e4;){const r=Array.from(this.pendingPublishPromises.entries()).find(a=>{let[o]=a;return o.source===e});if(r)return r[1];yield Tn(20)}})}}class pf extends Fr{constructor(e,t,n,r){super(e,t.sid,t.name,r),this.track=void 0,this.allowed=!0,this.requestedDisabled=void 0,this.visible=!0,this.handleEnded=a=>{this.setTrack(void 0),this.emit(ue.Ended,a)},this.handleVisibilityChange=a=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(a),this.logContext),this.visible=a,this.emitTrackUpdate()},this.handleVideoDimensionsChange=a=>{this.log.debug("adaptivestream video dimensions ".concat(a.width,"x").concat(a.height),this.logContext),this.videoDimensionsAdaptiveStream=a,this.emitTrackUpdate()},this.subscribed=n,this.updateInfo(t)}setSubscribed(e){const t=this.subscriptionStatus,n=this.permissionStatus;this.subscribed=e,e&&(this.allowed=!0);const r=new Hf({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new VI({participantSid:"",trackSids:[this.trackSid]})]});this.emit(ue.UpdateSubscription,r),this.emitSubscriptionUpdateIfChanged(t),this.emitPermissionUpdateIfChanged(n)}get subscriptionStatus(){return this.subscribed===!1?Fr.SubscriptionStatus.Unsubscribed:super.isSubscribed?Fr.SubscriptionStatus.Subscribed:Fr.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?Fr.PermissionStatus.Allowed:Fr.PermissionStatus.NotAllowed}get isSubscribed(){return this.subscribed===!1?!1:super.isSubscribed}get isDesired(){return this.subscribed!==!1}get isEnabled(){return this.requestedDisabled!==void 0?!this.requestedDisabled:this.isAdaptiveStream?this.visible:!0}get isLocal(){return!1}setEnabled(e){!this.isManualOperationAllowed()||this.requestedDisabled===!e||(this.requestedDisabled=!e,this.emitTrackUpdate())}setVideoQuality(e){!this.isManualOperationAllowed()||this.requestedMaxQuality===e||(this.requestedMaxQuality=e,this.requestedVideoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions(e){var t,n;this.isManualOperationAllowed()&&(((t=this.requestedVideoDimensions)===null||t===void 0?void 0:t.width)===e.width&&((n=this.requestedVideoDimensions)===null||n===void 0?void 0:n.height)===e.height||(ng(this.track)&&(this.requestedVideoDimensions=e),this.requestedMaxQuality=void 0,this.emitTrackUpdate()))}setVideoFPS(e){this.isManualOperationAllowed()&&ng(this.track)&&this.fps!==e&&(this.fps=e,this.emitTrackUpdate())}get videoQuality(){var e;return(e=this.requestedMaxQuality)!==null&&e!==void 0?e:fi.HIGH}setTrack(e){const t=this.subscriptionStatus,n=this.permissionStatus,r=this.track;r!==e&&(r&&(r.off(ue.VideoDimensionsChanged,this.handleVideoDimensionsChange),r.off(ue.VisibilityChanged,this.handleVisibilityChange),r.off(ue.Ended,this.handleEnded),r.detach(),r.stopMonitor(),this.emit(ue.Unsubscribed,r)),super.setTrack(e),e&&(e.sid=this.trackSid,e.on(ue.VideoDimensionsChanged,this.handleVideoDimensionsChange),e.on(ue.VisibilityChanged,this.handleVisibilityChange),e.on(ue.Ended,this.handleEnded),this.emit(ue.Subscribed,e)),this.emitPermissionUpdateIfChanged(n),this.emitSubscriptionUpdateIfChanged(t))}setAllowed(e){const t=this.subscriptionStatus,n=this.permissionStatus;this.allowed=e,this.emitPermissionUpdateIfChanged(n),this.emitSubscriptionUpdateIfChanged(t)}setSubscriptionError(e){this.emit(ue.SubscriptionFailed,e)}updateInfo(e){super.updateInfo(e);const t=this.metadataMuted;this.metadataMuted=e.muted,this.track?this.track.setMuted(e.muted):t!==e.muted&&this.emit(e.muted?ue.Muted:ue.Unmuted)}emitSubscriptionUpdateIfChanged(e){const t=this.subscriptionStatus;e!==t&&this.emit(ue.SubscriptionStatusChanged,t,e)}emitPermissionUpdateIfChanged(e){this.permissionStatus!==e&&this.emit(ue.SubscriptionPermissionChanged,this.permissionStatus,e)}isManualOperationAllowed(){return this.isDesired?!0:(this.log.warn("cannot update track settings when not subscribed",this.logContext),!1)}get isAdaptiveStream(){return ng(this.track)&&this.track.isAdaptiveStream}emitTrackUpdate(){const e=new XI({trackSids:[this.trackSid],disabled:!this.isEnabled,fps:this.fps});if(this.kind===se.Kind.Video){let t=this.requestedVideoDimensions;if(this.videoDimensionsAdaptiveStream!==void 0)if(t)VR(this.videoDimensionsAdaptiveStream,t)&&(this.log.debug("using adaptive stream dimensions instead of requested",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),t=this.videoDimensionsAdaptiveStream);else if(this.requestedMaxQuality!==void 0&&this.trackInfo){const n=$F(this.trackInfo,this.requestedMaxQuality);n&&VR(this.videoDimensionsAdaptiveStream,n)&&(this.log.debug("using adaptive stream dimensions instead of max quality layer",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),t=this.videoDimensionsAdaptiveStream)}else this.log.debug("using adaptive stream dimensions",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),t=this.videoDimensionsAdaptiveStream;t?(e.width=Math.ceil(t.width),e.height=Math.ceil(t.height)):this.requestedMaxQuality!==void 0?(this.log.debug("using requested max quality",Object.assign(Object.assign({},this.logContext),{quality:this.requestedMaxQuality})),e.quality=this.requestedMaxQuality):(this.log.debug("using default quality",Object.assign(Object.assign({},this.logContext),{quality:fi.HIGH})),e.quality=fi.HIGH)}this.emit(ue.UpdateSettings,e)}}class gf extends aM{static fromParticipantInfo(e,t,n){return new gf(e,t.sid,t.identity,t.name,t.metadata,t.attributes,n,t.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor(e,t,n,r,a,o,c){let d=arguments.length>7&&arguments[7]!==void 0?arguments[7]:gu.STANDARD;super(t,n||"",r,a,o,c,d),this.signalClient=e,this.trackPublications=new Map,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.volumeMap=new Map}addTrackPublication(e){super.addTrackPublication(e),e.on(ue.UpdateSettings,t=>{this.log.debug("send update settings",Object.assign(Object.assign(Object.assign({},this.logContext),We(e)),{settings:t})),this.signalClient.sendUpdateTrackSettings(t)}),e.on(ue.UpdateSubscription,t=>{t.participantTracks.forEach(n=>{n.participantSid=this.sid}),this.signalClient.sendUpdateSubscription(t)}),e.on(ue.SubscriptionPermissionChanged,t=>{this.emit(ae.TrackSubscriptionPermissionChanged,e,t)}),e.on(ue.SubscriptionStatusChanged,t=>{this.emit(ae.TrackSubscriptionStatusChanged,e,t)}),e.on(ue.Subscribed,t=>{this.emit(ae.TrackSubscribed,t,e)}),e.on(ue.Unsubscribed,t=>{this.emit(ae.TrackUnsubscribed,t,e)}),e.on(ue.SubscriptionFailed,t=>{this.emit(ae.TrackSubscriptionFailed,e.trackSid,t)})}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setVolume(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:se.Source.Microphone;this.volumeMap.set(t,e);const n=this.getTrackPublication(t);n&&n.track&&n.track.setVolume(e)}getVolume(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:se.Source.Microphone;const t=this.getTrackPublication(e);return t&&t.track?t.track.getVolume():this.volumeMap.get(e)}addSubscribedMediaTrack(e,t,n,r,a,o){let c=this.getTrackPublicationBySid(t);if(c||t.startsWith("TR")||this.trackPublications.forEach(v=>{!c&&e.kind===v.kind.toString()&&(c=v)}),!c){if(o===0){this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:t})),this.emit(ae.TrackSubscriptionFailed,t);return}o===void 0&&(o=20),setTimeout(()=>{this.addSubscribedMediaTrack(e,t,n,r,a,o-1)},150);return}if(e.readyState==="ended"){this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),We(c))),this.emit(ae.TrackSubscriptionFailed,t);return}const d=e.kind==="video";let h;return d?h=new X3(e,t,r,a):h=new rM(e,t,r,this.audioContext,this.audioOutput),h.source=c.source,h.isMuted=c.isMuted,h.setMediaStream(n),h.start(),c.setTrack(h),this.volumeMap.has(c.source)&&Ry(h)&&cr(h)&&h.setVolume(this.volumeMap.get(c.source)),c}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid(e){return this.trackPublications.get(e)}updateInfo(e){if(!super.updateInfo(e))return!1;const t=new Map,n=new Map;return e.tracks.forEach(r=>{var a,o;let c=this.getTrackPublicationBySid(r.sid);if(c)c.updateInfo(r);else{const d=se.kindFromProto(r.type);if(!d)return;c=new pf(d,r,(a=this.signalClient.connectOptions)===null||a===void 0?void 0:a.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:(o=this.loggerOptions)===null||o===void 0?void 0:o.loggerName}),c.updateInfo(r),n.set(r.sid,c);const h=Array.from(this.trackPublications.values()).find(v=>v.source===c?.source);h&&c.source!==se.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(c.source),Object.assign(Object.assign({},this.logContext),{oldTrack:We(h),newTrack:We(c)})),this.addTrackPublication(c)}t.set(r.sid,c)}),this.trackPublications.forEach(r=>{t.has(r.trackSid)||(this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),We(r))),this.unpublishTrack(r.trackSid,!0))}),n.forEach(r=>{this.emit(ae.TrackPublished,r)}),!0}unpublishTrack(e,t){const n=this.trackPublications.get(e);if(!n)return;const{track:r}=n;switch(r&&(r.stop(),n.setTrack(void 0)),this.trackPublications.delete(e),n.kind){case se.Kind.Audio:this.audioTrackPublications.delete(e);break;case se.Kind.Video:this.videoTrackPublications.delete(e);break}t&&this.emit(ae.TrackUnpublished,n)}setAudioOutput(e){return L(this,void 0,void 0,function*(){this.audioOutput=e;const t=[];this.audioTrackPublications.forEach(n=>{var r;cr(n.track)&&Ry(n.track)&&t.push(n.track.setSinkId((r=e.deviceId)!==null&&r!==void 0?r:"default"))}),yield Promise.all(t)})}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:e,args:n})),super.emit(e,...n)}}var at;(function(i){i.Disconnected="disconnected",i.Connecting="connecting",i.Connected="connected",i.Reconnecting="reconnecting",i.SignalReconnecting="signalReconnecting"})(at||(at={}));const rj=4*1e3;class yl extends vr.EventEmitter{get hasE2EESetup(){return this.e2eeManager!==void 0}constructor(e){var t,n,r,a;if(super(),t=this,this.state=at.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.log=Fe,this.bufferedEvents=[],this.isResuming=!1,this.rpcHandlers=new Map,this.connect=(o,c,d)=>L(this,void 0,void 0,function*(){var h;if(!OF())throw ur()?Error("WebRTC isn't detected, have you called registerGlobals?"):Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.");const v=yield this.disconnectLock.lock();if(this.state===at.Connected)return this.log.info("already connected to room ".concat(this.name),this.logContext),v(),Promise.resolve();if(this.connectFuture)return v(),this.connectFuture.promise;this.setAndEmitConnectionState(at.Connecting),((h=this.regionUrlProvider)===null||h===void 0?void 0:h.getServerUrl().toString())!==o&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),ff(new URL(o))&&(this.regionUrlProvider===void 0?this.regionUrlProvider=new st(o,c):this.regionUrlProvider.updateToken(c),this.regionUrlProvider.fetchRegionSettings().then(E=>{var T;(T=this.regionUrlProvider)===null||T===void 0||T.setServerReportedRegions(E)}).catch(E=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:E}))}));const m=(E,T,S)=>L(this,void 0,void 0,function*(){var O,R;this.abortController&&this.abortController.abort();const I=new AbortController;this.abortController=I,v?.();try{if(yield al.getInstance().getBackOffPromise(o),I.signal.aborted)throw new Qe("Connection attempt aborted",Le.Cancelled);yield this.attemptConnection(S??o,c,d,I),this.abortController=void 0,E()}catch(M){if(this.regionUrlProvider&&M instanceof Qe&&M.reason!==Le.Cancelled&&M.reason!==Le.NotAllowed){let C=null;try{this.log.debug("Fetching next region"),C=yield this.regionUrlProvider.getNextBestRegionUrl((O=this.abortController)===null||O===void 0?void 0:O.signal)}catch(k){if(k instanceof Qe&&(k.status===401||k.reason===Le.Cancelled)){this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),T(k);return}}[Le.InternalError,Le.ServerUnreachable,Le.Timeout].includes(M.reason)&&(this.log.debug("Adding failed connection attempt to back off"),al.getInstance().addFailedConnectionAttempt(o)),C&&!(!((R=this.abortController)===null||R===void 0)&&R.signal.aborted)?(this.log.info("Initial connection failed with ConnectionError: ".concat(M.message,". Retrying with another region: ").concat(C),this.logContext),this.recreateEngine(),yield m(E,T,C)):(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,qR(M)),T(M))}else{let C=Hi.UNKNOWN_REASON;M instanceof Qe&&(C=qR(M)),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,C),T(M)}}}),y=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new Oi((E,T)=>{m(E,T,y)},()=>{this.clearConnectionFutures()}),this.connectFuture.promise}),this.connectSignal=(o,c,d,h,v,m)=>L(this,void 0,void 0,function*(){var y,E,T;const S=yield d.join(o,c,{autoSubscribe:h.autoSubscribe,adaptiveStream:typeof v.adaptiveStream=="object"?!0:v.adaptiveStream,maxRetries:h.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:h.websocketTimeout,singlePeerConnection:v.singlePeerConnection},m.signal);let O=S.serverInfo;if(O||(O={version:S.serverVersion,region:S.serverRegion}),this.serverInfo=O,this.log.debug("connected to Livekit Server ".concat(Object.entries(O).map(R=>{let[I,M]=R;return"".concat(I,": ").concat(M)}).join(", ")),{room:(y=S.room)===null||y===void 0?void 0:y.name,roomSid:(E=S.room)===null||E===void 0?void 0:E.sid,identity:(T=S.participant)===null||T===void 0?void 0:T.identity}),!O.version)throw new fF("unknown server version");return O.version==="0.15.1"&&this.options.dynacast&&(this.log.debug("disabling dynacast due to server version",this.logContext),v.dynacast=!1),S}),this.applyJoinResponse=o=>{const c=o.participant;if(this.localParticipant.sid=c.sid,this.localParticipant.identity=c.identity,this.localParticipant.setEnabledPublishCodecs(o.enabledPublishCodecs),this.e2eeManager)try{this.e2eeManager.setSifTrailer(o.sifTrailer)}catch(d){this.log.error(d instanceof Error?d.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:d}))}this.handleParticipantUpdates([c,...o.otherParticipants]),o.room&&this.handleRoomUpdate(o.room)},this.attemptConnection=(o,c,d,h)=>L(this,void 0,void 0,function*(){var v,m;this.state===at.Reconnecting||this.isResuming||!((v=this.engine)===null||v===void 0)&&v.pendingReconnect?(this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext),this.recreateEngine()):this.maybeCreateEngine(),!((m=this.regionUrlProvider)===null||m===void 0)&&m.isCloud()&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},jb),d),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const y=yield this.connectSignal(o,c,this.engine,this.connOptions,this.options,h);this.applyJoinResponse(y),this.setupLocalParticipantEvents(),this.emit(te.SignalConnected)}catch(y){yield this.engine.close(),this.recreateEngine();const E=new Qe("could not establish signal connection",h.signal.aborted?Le.Cancelled:Le.ServerUnreachable);throw y instanceof Error&&(E.message="".concat(E.message,": ").concat(y.message)),y instanceof Qe&&(E.reason=y.reason,E.status=y.status),this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:y})),E}if(h.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),new Qe("Connection attempt aborted",Le.Cancelled);try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,h)}catch(y){throw yield this.engine.close(),this.recreateEngine(),y}Gn()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),Gn()&&document.addEventListener("freeze",this.onPageLeave),this.setAndEmitConnectionState(at.Connected),this.emit(te.Connected),al.getInstance().resetFailedConnectionAttempts(o),this.registerConnectionReconcile(),this.regionUrlProvider&&this.regionUrlProvider.notifyConnected()}),this.disconnect=function(){for(var o=arguments.length,c=new Array(o),d=0;d<o;d++)c[d]=arguments[d];return L(t,[...c],void 0,function(){var h=this;let v=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){var m,y,E;const T=yield h.disconnectLock.lock();try{if(h.state===at.Disconnected){h.log.debug("already disconnected",h.logContext);return}if(h.log.info("disconnect from room",Object.assign({},h.logContext)),h.state===at.Connecting||h.state===at.Reconnecting||h.isResuming){const S="Abort connection attempt due to user initiated disconnect";h.log.warn(S,h.logContext),(m=h.abortController)===null||m===void 0||m.abort(S),(E=(y=h.connectFuture)===null||y===void 0?void 0:y.reject)===null||E===void 0||E.call(y,new Qe("Client initiated disconnect",Le.Cancelled)),h.connectFuture=void 0}h.engine&&(h.engine.client.isDisconnected||(yield h.engine.client.sendLeave()),yield h.engine.close()),h.handleDisconnect(v,Hi.CLIENT_INITIATED),h.engine=void 0}finally{T()}})()})},this.onPageLeave=()=>L(this,void 0,void 0,function*(){this.log.info("Page leave detected, disconnecting",this.logContext),yield this.disconnect()}),this.startAudio=()=>L(this,void 0,void 0,function*(){const o=[],c=zn();if(c&&c.os==="iOS"){const d="livekit-dummy-audio-el";let h=document.getElementById(d);if(!h){h=document.createElement("audio"),h.id=d,h.autoplay=!0,h.hidden=!0;const v=tg();v.enabled=!0;const m=new MediaStream([v]);h.srcObject=m,document.addEventListener("visibilitychange",()=>{h&&(h.srcObject=document.hidden?null:m,document.hidden||(this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext),this.startAudio()))}),document.body.append(h),this.once(te.Disconnected,()=>{h?.remove(),h=null})}o.push(h)}this.remoteParticipants.forEach(d=>{d.audioTrackPublications.forEach(h=>{h.track&&h.track.attachedElements.forEach(v=>{o.push(v)})})});try{yield Promise.all([this.acquireAudioContext(),...o.map(d=>(d.muted=!1,d.play()))]),this.handleAudioPlaybackStarted()}catch(d){throw this.handleAudioPlaybackFailed(d),d}}),this.startVideo=()=>L(this,void 0,void 0,function*(){const o=[];for(const c of this.remoteParticipants.values())c.videoTrackPublications.forEach(d=>{var h;(h=d.track)===null||h===void 0||h.attachedElements.forEach(v=>{o.includes(v)||o.push(v)})});yield Promise.all(o.map(c=>c.play())).then(()=>{this.handleVideoPlaybackStarted()}).catch(c=>{c.name==="NotAllowedError"?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)})}),this.handleRestarting=()=>{this.clearConnectionReconcile(),this.isResuming=!1;for(const o of this.remoteParticipants.values())this.handleParticipantDisconnected(o.identity,o);this.setAndEmitConnectionState(at.Reconnecting)&&this.emit(te.Reconnecting)},this.handleSignalRestarted=o=>L(this,void 0,void 0,function*(){this.log.debug("signal reconnected to server, region ".concat(o.serverRegion),Object.assign(Object.assign({},this.logContext),{region:o.serverRegion})),this.bufferedEvents=[],this.applyJoinResponse(o);try{yield this.localParticipant.republishAllTracks(void 0,!0)}catch(c){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:c}))}try{yield this.engine.waitForRestarted(),this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:o.serverRegion}))}catch{return}this.setAndEmitConnectionState(at.Connected),this.emit(te.Reconnected),this.registerConnectionReconcile(),this.emitBufferedEvents()}),this.handleParticipantUpdates=o=>{o.forEach(c=>{var d;if(c.identity===this.localParticipant.identity){this.localParticipant.updateInfo(c);return}c.identity===""&&(c.identity=(d=this.sidToIdentity.get(c.sid))!==null&&d!==void 0?d:"");let h=this.remoteParticipants.get(c.identity);c.state===tl.DISCONNECTED?this.handleParticipantDisconnected(c.identity,h):h=this.getOrCreateParticipant(c.identity,c)})},this.handleActiveSpeakersUpdate=o=>{const c=[],d={};o.forEach(h=>{if(d[h.sid]=!0,h.sid===this.localParticipant.sid)this.localParticipant.audioLevel=h.level,this.localParticipant.setIsSpeaking(!0),c.push(this.localParticipant);else{const v=this.getRemoteParticipantBySid(h.sid);v&&(v.audioLevel=h.level,v.setIsSpeaking(!0),c.push(v))}}),d[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.remoteParticipants.forEach(h=>{d[h.sid]||(h.audioLevel=0,h.setIsSpeaking(!1))}),this.activeSpeakers=c,this.emitWhenConnected(te.ActiveSpeakersChanged,c)},this.handleSpeakersChanged=o=>{const c=new Map;this.activeSpeakers.forEach(h=>{const v=this.remoteParticipants.get(h.identity);v&&v.sid!==h.sid||c.set(h.sid,h)}),o.forEach(h=>{let v=this.getRemoteParticipantBySid(h.sid);h.sid===this.localParticipant.sid&&(v=this.localParticipant),v&&(v.audioLevel=h.level,v.setIsSpeaking(h.active),h.active?c.set(h.sid,v):c.delete(h.sid))});const d=Array.from(c.values());d.sort((h,v)=>v.audioLevel-h.audioLevel),this.activeSpeakers=d,this.emitWhenConnected(te.ActiveSpeakersChanged,d)},this.handleStreamStateUpdate=o=>{o.streamStates.forEach(c=>{const d=this.getRemoteParticipantBySid(c.participantSid);if(!d)return;const h=d.getTrackPublicationBySid(c.trackSid);if(!h||!h.track)return;const v=se.streamStateFromProto(c.state);h.track.setStreamState(v),v!==h.track.streamState&&(d.emit(ae.TrackStreamStateChanged,h,h.track.streamState),this.emitWhenConnected(te.TrackStreamStateChanged,h,h.track.streamState,d))})},this.handleSubscriptionPermissionUpdate=o=>{const c=this.getRemoteParticipantBySid(o.participantSid);if(!c)return;const d=c.getTrackPublicationBySid(o.trackSid);d&&d.setAllowed(o.allowed)},this.handleSubscriptionError=o=>{const c=Array.from(this.remoteParticipants.values()).find(h=>h.trackPublications.has(o.trackSid));if(!c)return;const d=c.getTrackPublicationBySid(o.trackSid);d&&d.setSubscriptionError(o.err)},this.handleDataPacket=(o,c)=>{const d=this.remoteParticipants.get(o.participantIdentity);if(o.value.case==="user")this.handleUserPacket(d,o.value.value,o.kind,c);else if(o.value.case==="transcription")this.handleTranscription(d,o.value.value);else if(o.value.case==="sipDtmf")this.handleSipDtmf(d,o.value.value);else if(o.value.case==="chatMessage")this.handleChatMessage(d,o.value.value);else if(o.value.case==="metrics")this.handleMetrics(o.value.value,d);else if(o.value.case==="streamHeader"||o.value.case==="streamChunk"||o.value.case==="streamTrailer")this.handleDataStream(o,c);else if(o.value.case==="rpcRequest"){const h=o.value.value;this.handleIncomingRpcRequest(o.participantIdentity,h.id,h.method,h.payload,h.responseTimeoutMs,h.version)}},this.handleUserPacket=(o,c,d,h)=>{this.emit(te.DataReceived,c.payload,o,d,c.topic,h),o?.emit(ae.DataReceived,c.payload,d,h)},this.handleSipDtmf=(o,c)=>{this.emit(te.SipDTMFReceived,c,o),o?.emit(ae.SipDTMFReceived,c)},this.handleTranscription=(o,c)=>{const d=c.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(c.transcribedParticipantIdentity),h=d?.trackPublications.get(c.trackId),v=BF(c,this.transcriptionReceivedTimes);h?.emit(ue.TranscriptionReceived,v),d?.emit(ae.TranscriptionReceived,v,h),this.emit(te.TranscriptionReceived,v,d,h)},this.handleChatMessage=(o,c)=>{const d=FF(c);this.emit(te.ChatMessage,d,o)},this.handleMetrics=(o,c)=>{this.emit(te.MetricsReceived,o,c)},this.handleDataStream=(o,c)=>{this.incomingDataStreamManager.handleDataStreamPacket(o,c)},this.bufferedSegments=new Map,this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(te.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=o=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:o})),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(te.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(te.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(te.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>L(this,void 0,void 0,function*(){var o;((o=zn())===null||o===void 0?void 0:o.os)!=="iOS"&&(yield this.selectDefaultDevices()),this.emit(te.MediaDevicesChanged)}),this.handleRoomUpdate=o=>{const c=this.roomInfo;this.roomInfo=o,c&&c.metadata!==o.metadata&&this.emitWhenConnected(te.RoomMetadataChanged,o.metadata),c?.activeRecording!==o.activeRecording&&this.emitWhenConnected(te.RecordingStatusChanged,o.activeRecording)},this.handleConnectionQualityUpdate=o=>{o.updates.forEach(c=>{if(c.participantSid===this.localParticipant.sid){this.localParticipant.setConnectionQuality(c.quality);return}const d=this.getRemoteParticipantBySid(c.participantSid);d&&d.setConnectionQuality(c.quality)})},this.onLocalParticipantMetadataChanged=o=>{this.emit(te.ParticipantMetadataChanged,o,this.localParticipant)},this.onLocalParticipantNameChanged=o=>{this.emit(te.ParticipantNameChanged,o,this.localParticipant)},this.onLocalAttributesChanged=o=>{this.emit(te.ParticipantAttributesChanged,o,this.localParticipant)},this.onLocalTrackMuted=o=>{this.emit(te.TrackMuted,o,this.localParticipant)},this.onLocalTrackUnmuted=o=>{this.emit(te.TrackUnmuted,o,this.localParticipant)},this.onTrackProcessorUpdate=o=>{var c;(c=o?.onPublish)===null||c===void 0||c.call(o,this)},this.onLocalTrackPublished=o=>L(this,void 0,void 0,function*(){var c,d,h,v,m,y;(c=o.track)===null||c===void 0||c.on(ue.TrackProcessorUpdate,this.onTrackProcessorUpdate),(d=o.track)===null||d===void 0||d.on(ue.Restarted,this.onLocalTrackRestarted),(m=(v=(h=o.track)===null||h===void 0?void 0:h.getProcessor())===null||v===void 0?void 0:v.onPublish)===null||m===void 0||m.call(v,this),this.emit(te.LocalTrackPublished,o,this.localParticipant),Lr(o.track)&&(yield o.track.checkForSilence())&&this.emit(te.LocalAudioSilenceDetected,o);const E=yield(y=o.track)===null||y===void 0?void 0:y.getDeviceId(!1),T=wy(o.source);T&&E&&E!==this.localParticipant.activeDeviceMap.get(T)&&(this.localParticipant.activeDeviceMap.set(T,E),this.emit(te.ActiveDeviceChanged,T,E))}),this.onLocalTrackUnpublished=o=>{var c,d;(c=o.track)===null||c===void 0||c.off(ue.TrackProcessorUpdate,this.onTrackProcessorUpdate),(d=o.track)===null||d===void 0||d.off(ue.Restarted,this.onLocalTrackRestarted),this.emit(te.LocalTrackUnpublished,o,this.localParticipant)},this.onLocalTrackRestarted=o=>L(this,void 0,void 0,function*(){const c=yield o.getDeviceId(!1),d=wy(o.source);d&&c&&c!==this.localParticipant.activeDeviceMap.get(d)&&(this.log.debug("local track restarted, setting ".concat(d," ").concat(c," active"),this.logContext),this.localParticipant.activeDeviceMap.set(d,c),this.emit(te.ActiveDeviceChanged,d,c))}),this.onLocalConnectionQualityChanged=o=>{this.emit(te.ConnectionQualityChanged,o,this.localParticipant)},this.onMediaDevicesError=(o,c)=>{this.emit(te.MediaDevicesError,o,c)},this.onLocalParticipantPermissionsChanged=o=>{this.emit(te.ParticipantPermissionsChanged,o,this.localParticipant)},this.onLocalChatMessageSent=o=>{this.emit(te.ChatMessage,o,this.localParticipant)},this.setMaxListeners(100),this.remoteParticipants=new Map,this.sidToIdentity=new Map,this.options=Object.assign(Object.assign({},b3),e),this.log=Xr((n=this.options.loggerName)!==null&&n!==void 0?n:Wi.Room),this.transcriptionReceivedTimes=new Map,this.options.audioCaptureDefaults=Object.assign(Object.assign({},JO),e?.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},YO),e?.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},y3),e?.publishDefaults),this.maybeCreateEngine(),this.incomingDataStreamManager=new W3,this.outgoingDataStreamManager=new $3(this.engine,this.log),this.disconnectLock=new An,this.localParticipant=new ij("","",this.engine,this.options,this.rpcHandlers,this.outgoingDataStreamManager),(this.options.e2ee||this.options.encryption)&&this.setupE2EE(),this.engine.e2eeManager=this.e2eeManager,this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",Ha(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",Ha(this.options.audioCaptureDefaults.deviceId)),!((r=this.options.audioOutput)===null||r===void 0)&&r.deviceId&&this.switchActiveDevice("audiooutput",Ha(this.options.audioOutput.deviceId)).catch(o=>this.log.warn("Could not set audio output: ".concat(o.message),this.logContext)),Gn()){const o=new AbortController;(a=navigator.mediaDevices)===null||a===void 0||a.addEventListener("devicechange",this.handleDeviceChange,{signal:o.signal}),yl.cleanupRegistry&&yl.cleanupRegistry.register(this,()=>{o.abort()})}}registerTextStreamHandler(e,t){return this.incomingDataStreamManager.registerTextStreamHandler(e,t)}unregisterTextStreamHandler(e){return this.incomingDataStreamManager.unregisterTextStreamHandler(e)}registerByteStreamHandler(e,t){return this.incomingDataStreamManager.registerByteStreamHandler(e,t)}unregisterByteStreamHandler(e){return this.incomingDataStreamManager.unregisterByteStreamHandler(e)}registerRpcMethod(e,t){if(this.rpcHandlers.has(e))throw Error("RPC handler already registered for method ".concat(e,", unregisterRpcMethod before trying to register again"));this.rpcHandlers.set(e,t)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setE2EEEnabled(e){return L(this,void 0,void 0,function*(){if(this.e2eeManager)yield Promise.all([this.localParticipant.setE2EEEnabled(e)]),this.localParticipant.identity!==""&&this.e2eeManager.setParticipantCryptorEnabled(e,this.localParticipant.identity);else throw Error("e2ee not configured, please set e2ee settings within the room options")})}setupE2EE(){var e;const t=!!this.options.encryption,n=this.options.encryption||this.options.e2ee;n&&("e2eeManager"in n?(this.e2eeManager=n.e2eeManager,this.e2eeManager.isDataChannelEncryptionEnabled=t):this.e2eeManager=new XF(n,t),this.e2eeManager.on(Ba.ParticipantEncryptionStatusChanged,(r,a)=>{qF(a)&&(this.isE2EEEnabled=r),this.emit(te.ParticipantEncryptionStatusChanged,r,a)}),this.e2eeManager.on(Ba.EncryptionError,(r,a)=>{const o=a?this.getParticipantByIdentity(a):void 0;this.emit(te.EncryptionError,r,o)}),(e=this.e2eeManager)===null||e===void 0||e.setup(this))}get logContext(){var e;return{room:this.name,roomID:(e=this.roomInfo)===null||e===void 0?void 0:e.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.activeRecording)!==null&&t!==void 0?t:!1}getSid(){return L(this,void 0,void 0,function*(){return this.state===at.Disconnected?"":this.roomInfo&&this.roomInfo.sid!==""?this.roomInfo.sid:new Promise((e,t)=>{const n=r=>{r.sid!==""&&(this.engine.off(fe.RoomUpdate,n),e(r.sid))};this.engine.on(fe.RoomUpdate,n),this.once(te.Disconnected,()=>{this.engine.off(fe.RoomUpdate,n),t("Room disconnected before room server id was available")})})})}get name(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.name)!==null&&t!==void 0?t:""}get metadata(){var e;return(e=this.roomInfo)===null||e===void 0?void 0:e.metadata}get numParticipants(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.numParticipants)!==null&&t!==void 0?t:0}get numPublishers(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.numPublishers)!==null&&t!==void 0?t:0}maybeCreateEngine(){this.engine&&!this.engine.isClosed||(this.engine=new K3(this.options),this.engine.e2eeManager=this.e2eeManager,this.engine.on(fe.ParticipantUpdate,this.handleParticipantUpdates).on(fe.RoomUpdate,this.handleRoomUpdate).on(fe.SpeakersChanged,this.handleSpeakersChanged).on(fe.StreamStateChanged,this.handleStreamStateUpdate).on(fe.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(fe.SubscriptionError,this.handleSubscriptionError).on(fe.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(fe.MediaTrackAdded,(e,t,n)=>{this.onTrackAdded(e,t,n)}).on(fe.Disconnected,e=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,e)}).on(fe.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(fe.DataPacketReceived,this.handleDataPacket).on(fe.Resuming,()=>{this.clearConnectionReconcile(),this.isResuming=!0,this.log.info("Resuming signal connection",this.logContext),this.setAndEmitConnectionState(at.SignalReconnecting)&&this.emit(te.SignalReconnecting)}).on(fe.Resumed,()=>{this.registerConnectionReconcile(),this.isResuming=!1,this.log.info("Resumed signal connection",this.logContext),this.updateSubscriptions(),this.emitBufferedEvents(),this.setAndEmitConnectionState(at.Connected)&&this.emit(te.Reconnected)}).on(fe.SignalResumed,()=>{this.bufferedEvents=[],(this.state===at.Reconnecting||this.isResuming)&&this.sendSyncState()}).on(fe.Restarting,this.handleRestarting).on(fe.SignalRestarted,this.handleSignalRestarted).on(fe.Offline,()=>{this.setAndEmitConnectionState(at.Reconnecting)&&this.emit(te.Reconnecting)}).on(fe.DCBufferStatusChanged,(e,t)=>{this.emit(te.DCBufferStatusChanged,e,t)}).on(fe.LocalTrackSubscribed,e=>{const t=this.localParticipant.getTrackPublications().find(n=>{let{trackSid:r}=n;return r===e});if(!t){this.log.warn("could not find local track subscription for subscribed event",this.logContext);return}this.localParticipant.emit(ae.LocalTrackSubscribed,t),this.emitWhenConnected(te.LocalTrackSubscribed,t,this.localParticipant)}).on(fe.RoomMoved,e=>{this.log.debug("room moved",e),e.room&&this.handleRoomUpdate(e.room),this.remoteParticipants.forEach((t,n)=>{this.handleParticipantDisconnected(n,t)}),this.emit(te.Moved,e.room.name),e.participant?this.handleParticipantUpdates([e.participant,...e.otherParticipants]):this.handleParticipantUpdates(e.otherParticipants)}),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine),this.outgoingDataStreamManager&&this.outgoingDataStreamManager.setupEngine(this.engine))}static getLocalDevices(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return hn.getInstance().getDevices(e,t)}prepareConnection(e,t){return L(this,void 0,void 0,function*(){if(this.state===at.Disconnected){this.log.debug("prepareConnection to ".concat(e),this.logContext);try{if(ff(new URL(e))&&t){this.regionUrlProvider=new st(e,t);const n=yield this.regionUrlProvider.getNextBestRegionUrl();n&&this.state===at.Disconnected&&(this.regionUrl=n,yield fetch(_u(n),{method:"HEAD"}),this.log.debug("prepared connection to ".concat(n),this.logContext))}else yield fetch(_u(e),{method:"HEAD"})}catch(n){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:n}))}}})}getParticipantByIdentity(e){return this.localParticipant.identity===e?this.localParticipant:this.remoteParticipants.get(e)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario(e,t){return L(this,void 0,void 0,function*(){let n=()=>L(this,void 0,void 0,function*(){}),r;switch(e){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":r=new ar({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":r=new ar({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":r=new ar({scenario:{case:"serverLeave",value:!0}});break;case"migration":r=new ar({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":n=()=>L(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),r=new ar({scenario:{case:"disconnectSignalOnResume",value:!0}});break;case"disconnect-signal-on-resume-no-messages":n=()=>L(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),r=new ar({scenario:{case:"disconnectSignalOnResumeNoMessages",value:!0}});break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":r=new ar({scenario:{case:"switchCandidateProtocol",value:e==="force-tls"?2:1}}),n=()=>L(this,void 0,void 0,function*(){const a=this.engine.client.onLeave;a&&a(new Gf({reason:Hi.CLIENT_INITIATED,action:nl.RECONNECT}))});break;case"subscriber-bandwidth":if(t===void 0||typeof t!="number")throw new Error("subscriber-bandwidth requires a number as argument");r=new ar({scenario:{case:"subscriberBandwidth",value:Os(t)}});break;case"leave-full-reconnect":r=new ar({scenario:{case:"leaveRequestFullReconnect",value:!0}})}r&&(yield this.engine.client.sendSimulateScenario(r),yield n())})}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice(e){return this.localParticipant.activeDeviceMap.get(e)}switchActiveDevice(e,t){return L(this,arguments,void 0,function(n,r){var a=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;return(function*(){var c,d,h,v,m,y,E;let T=!0,S=!1;const O=o?{exact:r}:r;if(n==="audioinput"){S=a.localParticipant.audioTrackPublications.size===0;const R=(c=a.getActiveDevice(n))!==null&&c!==void 0?c:a.options.audioCaptureDefaults.deviceId;a.options.audioCaptureDefaults.deviceId=O;const I=Array.from(a.localParticipant.audioTrackPublications.values()).filter(C=>C.source===se.Source.Microphone);try{T=(yield Promise.all(I.map(C=>{var k;return(k=C.audioTrack)===null||k===void 0?void 0:k.setDeviceId(O)}))).every(C=>C===!0)}catch(C){throw a.options.audioCaptureDefaults.deviceId=R,C}const M=I.some(C=>{var k,_;return(_=(k=C.track)===null||k===void 0?void 0:k.isMuted)!==null&&_!==void 0?_:!1});T&&M&&(S=!0)}else if(n==="videoinput"){S=a.localParticipant.videoTrackPublications.size===0;const R=(d=a.getActiveDevice(n))!==null&&d!==void 0?d:a.options.videoCaptureDefaults.deviceId;a.options.videoCaptureDefaults.deviceId=O;const I=Array.from(a.localParticipant.videoTrackPublications.values()).filter(C=>C.source===se.Source.Camera);try{T=(yield Promise.all(I.map(C=>{var k;return(k=C.videoTrack)===null||k===void 0?void 0:k.setDeviceId(O)}))).every(C=>C===!0)}catch(C){throw a.options.videoCaptureDefaults.deviceId=R,C}const M=I.some(C=>{var k,_;return(_=(k=C.track)===null||k===void 0?void 0:k.isMuted)!==null&&_!==void 0?_:!1});T&&M&&(S=!0)}else if(n==="audiooutput"){if(S=!0,!Cy()&&!a.options.webAudioMix||a.options.webAudioMix&&a.audioContext&&!("setSinkId"in a.audioContext))throw new Error("cannot switch audio output, the current browser does not support it");a.options.webAudioMix&&(r=(h=yield hn.getInstance().normalizeDeviceId("audiooutput",r))!==null&&h!==void 0?h:""),(v=(E=a.options).audioOutput)!==null&&v!==void 0||(E.audioOutput={});const R=(m=a.getActiveDevice(n))!==null&&m!==void 0?m:a.options.audioOutput.deviceId;a.options.audioOutput.deviceId=r;try{a.options.webAudioMix&&((y=a.audioContext)===null||y===void 0||y.setSinkId(r)),yield Promise.all(Array.from(a.remoteParticipants.values()).map(I=>I.setAudioOutput({deviceId:r})))}catch(I){throw a.options.audioOutput.deviceId=R,I}}return S&&(a.localParticipant.activeDeviceMap.set(n,r),a.emit(te.ActiveDeviceChanged,n,r)),T})()})}setupLocalParticipantEvents(){this.localParticipant.on(ae.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(ae.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(ae.AttributesChanged,this.onLocalAttributesChanged).on(ae.TrackMuted,this.onLocalTrackMuted).on(ae.TrackUnmuted,this.onLocalTrackUnmuted).on(ae.LocalTrackPublished,this.onLocalTrackPublished).on(ae.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(ae.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(ae.MediaDevicesError,this.onMediaDevicesError).on(ae.AudioStreamAcquired,this.startAudio).on(ae.ChatMessage,this.onLocalChatMessageSent).on(ae.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var e;(e=this.engine)===null||e===void 0||e.close(),this.engine=void 0,this.isResuming=!1,this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.bufferedEvents=[],this.maybeCreateEngine()}onTrackAdded(e,t,n){if(this.state===at.Connecting||this.state===at.Reconnecting){const m=()=>{this.log.debug("deferring on track for later",{mediaTrackId:e.id,mediaStreamId:t.id,tracksInStream:t.getTracks().map(E=>E.id)}),this.onTrackAdded(e,t,n),y()},y=()=>{this.off(te.Reconnected,m),this.off(te.Connected,m),this.off(te.Disconnected,y)};this.once(te.Reconnected,m),this.once(te.Connected,m),this.once(te.Disconnected,y);return}if(this.state===at.Disconnected){this.log.warn("skipping incoming track after Room disconnected",this.logContext);return}if(e.readyState==="ended"){this.log.info("skipping incoming track as it already ended",this.logContext);return}const r=kF(t.id),a=r[0];let o=r[1],c=e.id;if(o&&o.startsWith("TR")&&(c=o),a===this.localParticipant.sid){this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);return}const d=Array.from(this.remoteParticipants.values()).find(m=>m.sid===a);if(!d){this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(a),this.logContext);return}if(!c.startsWith("TR")){const m=this.engine.getTrackIdForReceiver(n);if(!m){this.log.error("Tried to add a track whose 'sid' could not be found for a participant, that's not present. Sid: ".concat(a),this.logContext);return}c=m}c.startsWith("TR")||this.log.warn("Tried to add a track whose 'sid' could not be determined for a participant, that's not present. Sid: ".concat(a,", streamId: ").concat(o,", trackId: ").concat(c),Object.assign(Object.assign({},this.logContext),{rpID:a,streamId:o,trackId:c}));let h;this.options.adaptiveStream&&(typeof this.options.adaptiveStream=="object"?h=this.options.adaptiveStream:h={});const v=d.addSubscribedMediaTrack(e,c,t,n,h);v?.isEncrypted&&!this.e2eeManager&&this.emit(te.EncryptionError,new Error("Encrypted ".concat(v.source," track received from participant ").concat(d.sid,", but room does not have encryption enabled!")))}handleDisconnect(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=arguments.length>1?arguments[1]:void 0;var n;if(this.clearConnectionReconcile(),this.isResuming=!1,this.bufferedEvents=[],this.transcriptionReceivedTimes.clear(),this.incomingDataStreamManager.clearControllers(),this.state!==at.Disconnected){this.regionUrl=void 0,this.regionUrlProvider&&this.regionUrlProvider.notifyDisconnected();try{this.remoteParticipants.forEach(r=>{r.trackPublications.forEach(a=>{r.unpublishTrack(a.trackSid)})}),this.localParticipant.trackPublications.forEach(r=>{var a,o,c;r.track&&this.localParticipant.unpublishTrack(r.track,e),e?((a=r.track)===null||a===void 0||a.detach(),(o=r.track)===null||o===void 0||o.stop()):(c=r.track)===null||c===void 0||c.stopMonitor()}),this.localParticipant.off(ae.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(ae.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(ae.AttributesChanged,this.onLocalAttributesChanged).off(ae.TrackMuted,this.onLocalTrackMuted).off(ae.TrackUnmuted,this.onLocalTrackUnmuted).off(ae.LocalTrackPublished,this.onLocalTrackPublished).off(ae.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(ae.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(ae.MediaDevicesError,this.onMediaDevicesError).off(ae.AudioStreamAcquired,this.startAudio).off(ae.ChatMessage,this.onLocalChatMessageSent).off(ae.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.trackPublications.clear(),this.localParticipant.videoTrackPublications.clear(),this.localParticipant.audioTrackPublications.clear(),this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.activeSpeakers=[],this.audioContext&&typeof this.options.webAudioMix=="boolean"&&(this.audioContext.close(),this.audioContext=void 0),Gn()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),(n=navigator.mediaDevices)===null||n===void 0||n.removeEventListener("devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(at.Disconnected),this.emit(te.Disconnected,t)}}}handleParticipantDisconnected(e,t){var n;this.remoteParticipants.delete(e),t&&(this.incomingDataStreamManager.validateParticipantHasNoActiveDataStreams(e),t.trackPublications.forEach(r=>{t.unpublishTrack(r.trackSid,!0)}),this.emit(te.ParticipantDisconnected,t),t.setDisconnected(),(n=this.localParticipant)===null||n===void 0||n.handleParticipantDisconnected(t.identity))}handleIncomingRpcRequest(e,t,n,r,a,o){return L(this,void 0,void 0,function*(){if(yield this.engine.publishRpcAck(e,t),o!==1){yield this.engine.publishRpcResponse(e,t,null,Ft.builtIn("UNSUPPORTED_VERSION"));return}const c=this.rpcHandlers.get(n);if(!c){yield this.engine.publishRpcResponse(e,t,null,Ft.builtIn("UNSUPPORTED_METHOD"));return}let d=null,h=null;try{const v=yield c({requestId:t,callerIdentity:e,payload:r,responseTimeout:a});qb(v)>XO?(d=Ft.builtIn("RESPONSE_PAYLOAD_TOO_LARGE"),console.warn("RPC Response payload too large for ".concat(n))):h=v}catch(v){v instanceof Ft?d=v:(console.warn("Uncaught error returned by RPC handler for ".concat(n,". Returning APPLICATION_ERROR instead."),v),d=Ft.builtIn("APPLICATION_ERROR"))}yield this.engine.publishRpcResponse(e,t,h,d)})}selectDefaultDevices(){return L(this,void 0,void 0,function*(){var e,t,n;const r=hn.getInstance().previousDevices,a=yield hn.getInstance().getDevices(void 0,!1),o=zn();if(o?.name==="Chrome"&&o.os!=="iOS")for(let d of a){const h=r.find(v=>v.deviceId===d.deviceId);h&&h.label!==""&&h.kind===d.kind&&h.label!==d.label&&this.getActiveDevice(d.kind)==="default"&&this.emit(te.ActiveDeviceChanged,d.kind,d.deviceId)}const c=["audiooutput","audioinput","videoinput"];for(let d of c){const h=HF(d),v=this.localParticipant.getTrackPublication(h);if(v&&(!((e=v.track)===null||e===void 0)&&e.isUserProvided))continue;const m=a.filter(E=>E.kind===d),y=this.getActiveDevice(d);if(y===((t=r.filter(E=>E.kind===d)[0])===null||t===void 0?void 0:t.deviceId)&&m.length>0&&((n=m[0])===null||n===void 0?void 0:n.deviceId)!==y){yield this.switchActiveDevice(d,m[0].deviceId);continue}d==="audioinput"&&!Tu()||d==="videoinput"||m.length>0&&!m.find(E=>E.deviceId===this.getActiveDevice(d))&&(d!=="audiooutput"||!Tu())&&(yield this.switchActiveDevice(d,m[0].deviceId))}})}acquireAudioContext(){return L(this,void 0,void 0,function*(){var e,t;if(typeof this.options.webAudioMix!="boolean"&&this.options.webAudioMix.audioContext?this.audioContext=this.options.webAudioMix.audioContext:(!this.audioContext||this.audioContext.state==="closed")&&(this.audioContext=(e=GO())!==null&&e!==void 0?e:void 0),this.options.webAudioMix&&this.remoteParticipants.forEach(r=>r.setAudioContext(this.audioContext)),this.localParticipant.setAudioContext(this.audioContext),this.audioContext&&this.audioContext.state==="suspended")try{yield Promise.race([this.audioContext.resume(),Tn(200)])}catch(r){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:r}))}const n=((t=this.audioContext)===null||t===void 0?void 0:t.state)==="running";n!==this.canPlaybackAudio&&(this.audioEnabled=n,this.emit(te.AudioPlaybackStatusChanged,n))})}createParticipant(e,t){var n;let r;return t?r=gf.fromParticipantInfo(this.engine.client,t,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}):r=new gf(this.engine.client,"",e,void 0,void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}),this.options.webAudioMix&&r.setAudioContext(this.audioContext),!((n=this.options.audioOutput)===null||n===void 0)&&n.deviceId&&r.setAudioOutput(this.options.audioOutput).catch(a=>this.log.warn("Could not set audio output: ".concat(a.message),this.logContext)),r}getOrCreateParticipant(e,t){if(this.remoteParticipants.has(e)){const r=this.remoteParticipants.get(e);return t&&r.updateInfo(t)&&this.sidToIdentity.set(t.sid,t.identity),r}const n=this.createParticipant(e,t);return this.remoteParticipants.set(e,n),this.sidToIdentity.set(t.sid,t.identity),this.emitWhenConnected(te.ParticipantConnected,n),n.on(ae.TrackPublished,r=>{this.emitWhenConnected(te.TrackPublished,r,n)}).on(ae.TrackSubscribed,(r,a)=>{r.kind===se.Kind.Audio?(r.on(ue.AudioPlaybackStarted,this.handleAudioPlaybackStarted),r.on(ue.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):r.kind===se.Kind.Video&&(r.on(ue.VideoPlaybackFailed,this.handleVideoPlaybackFailed),r.on(ue.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(te.TrackSubscribed,r,a,n)}).on(ae.TrackUnpublished,r=>{this.emit(te.TrackUnpublished,r,n)}).on(ae.TrackUnsubscribed,(r,a)=>{this.emit(te.TrackUnsubscribed,r,a,n)}).on(ae.TrackMuted,r=>{this.emitWhenConnected(te.TrackMuted,r,n)}).on(ae.TrackUnmuted,r=>{this.emitWhenConnected(te.TrackUnmuted,r,n)}).on(ae.ParticipantMetadataChanged,r=>{this.emitWhenConnected(te.ParticipantMetadataChanged,r,n)}).on(ae.ParticipantNameChanged,r=>{this.emitWhenConnected(te.ParticipantNameChanged,r,n)}).on(ae.AttributesChanged,r=>{this.emitWhenConnected(te.ParticipantAttributesChanged,r,n)}).on(ae.ConnectionQualityChanged,r=>{this.emitWhenConnected(te.ConnectionQualityChanged,r,n)}).on(ae.ParticipantPermissionsChanged,r=>{this.emitWhenConnected(te.ParticipantPermissionsChanged,r,n)}).on(ae.TrackSubscriptionStatusChanged,(r,a)=>{this.emitWhenConnected(te.TrackSubscriptionStatusChanged,r,a,n)}).on(ae.TrackSubscriptionFailed,(r,a)=>{this.emit(te.TrackSubscriptionFailed,r,n,a)}).on(ae.TrackSubscriptionPermissionChanged,(r,a)=>{this.emitWhenConnected(te.TrackSubscriptionPermissionChanged,r,a,n)}).on(ae.Active,()=>{this.emitWhenConnected(te.ParticipantActive,n),n.kind===gu.AGENT&&this.localParticipant.setActiveAgent(n)}),t&&n.updateInfo(t),n}sendSyncState(){const e=Array.from(this.remoteParticipants.values()).reduce((n,r)=>(n.push(...r.getTrackPublications()),n),[]),t=this.localParticipant.getTrackPublications();this.engine.sendSyncState(e,t)}updateSubscriptions(){for(const e of this.remoteParticipants.values())for(const t of e.videoTrackPublications.values())t.isSubscribed&&jF(t)&&t.emitTrackUpdate()}getRemoteParticipantBySid(e){const t=this.sidToIdentity.get(e);if(t)return this.remoteParticipants.get(t)}registerConnectionReconcile(){this.clearConnectionReconcile();let e=0;this.connectionReconcileInterval=En.setInterval(()=>{!this.engine||this.engine.isClosed||!this.engine.verifyTransport()?(e++,this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:e,engine:this.engine?{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}:void 0})),e>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,Hi.STATE_MISMATCH))):e=0},rj)}clearConnectionReconcile(){this.connectionReconcileInterval&&En.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState(e){return e===this.state?!1:(this.state=e,this.emit(te.ConnectionStateChanged,this.state),!0)}emitBufferedEvents(){this.bufferedEvents.forEach(e=>{let[t,n]=e;this.emit(t,...n)}),this.bufferedEvents=[]}emitWhenConnected(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];if(this.state===at.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect)this.bufferedEvents.push([e,n]);else if(this.state===at.Connected)return this.emit(e,...n);return!1}simulateParticipants(e){return L(this,void 0,void 0,function*(){var t,n;const r=Object.assign({audio:!0,video:!0,useRealTracks:!1},e.publish),a=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},e.participants);if(this.handleDisconnect(),this.roomInfo=new qf({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:Pt.parse(new Date().getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new js({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(te.SignalConnected),this.emit(te.Connected),this.setAndEmitConnectionState(at.Connected),r.video){const o=new Ay(se.Kind.Video,new zo({source:Xt.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:qi.AUDIO,name:"video-dummy"}),new mf(r.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:jR(160*((t=a.aspectRatios[0])!==null&&t!==void 0?t:1),160,!0,!0),void 0,!1,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(o),this.localParticipant.emit(ae.LocalTrackPublished,o)}if(r.audio){const o=new Ay(se.Kind.Audio,new zo({source:Xt.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:qi.AUDIO}),new vf(r.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:tg(),void 0,!1,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(o),this.localParticipant.emit(ae.LocalTrackPublished,o)}for(let o=0;o<a.count-1;o+=1){let c=new js({sid:Math.floor(Math.random()*1e4).toString(),identity:"simulated-".concat(o),state:tl.ACTIVE,tracks:[],joinedAt:Pt.parse(Date.now())});const d=this.getOrCreateParticipant(c.identity,c);if(a.video){const h=jR(160*((n=a.aspectRatios[o%a.aspectRatios.length])!==null&&n!==void 0?n:1),160,!1,!0),v=new zo({source:Xt.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:qi.AUDIO});d.addSubscribedMediaTrack(h,v.sid,new MediaStream([h]),new RTCRtpReceiver),c.tracks=[...c.tracks,v]}if(a.audio){const h=tg(),v=new zo({source:Xt.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:qi.AUDIO});d.addSubscribedMediaTrack(h,v.sid,new MediaStream([h]),new RTCRtpReceiver),c.tracks=[...c.tracks,v]}d.updateInfo(c)}})}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];if(e!==te.ActiveSpeakersChanged&&e!==te.TranscriptionReceived){const a=sM(n).filter(o=>o!==void 0);(e===te.TrackSubscribed||e===te.TrackUnsubscribed)&&this.log.trace("subscribe trace: ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:a})),this.log.debug("room event ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:a}))}return super.emit(e,...n)}}yl.cleanupRegistry=typeof FinalizationRegistry<"u"&&new FinalizationRegistry(i=>{i()});function sM(i){return i.map(e=>{if(e)return Array.isArray(e)?sM(e):typeof e=="object"?"logContext"in e?e.logContext:void 0:e})}var Fi;(function(i){i[i.IDLE=0]="IDLE",i[i.RUNNING=1]="RUNNING",i[i.SKIPPED=2]="SKIPPED",i[i.SUCCESS=3]="SUCCESS",i[i.FAILED=4]="FAILED"})(Fi||(Fi={}));class $a extends vr.EventEmitter{constructor(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.status=Fi.IDLE,this.logs=[],this.options={},this.url=e,this.token=t,this.name=this.constructor.name,this.room=new yl(n.roomOptions),this.connectOptions=n.connectOptions,this.options=n}run(e){return L(this,void 0,void 0,function*(){if(this.status!==Fi.IDLE)throw Error("check is running already");this.setStatus(Fi.RUNNING);try{yield this.perform()}catch(t){t instanceof Error&&(this.options.errorsAsWarnings?this.appendWarning(t.message):this.appendError(t.message))}return yield this.disconnect(),yield new Promise(t=>setTimeout(t,500)),this.status!==Fi.SKIPPED&&this.setStatus(this.isSuccess()?Fi.SUCCESS:Fi.FAILED),e&&e(),this.getInfo()})}isSuccess(){return!this.logs.some(e=>e.level==="error")}connect(e){return L(this,void 0,void 0,function*(){return this.room.state===at.Connected?this.room:(e||(e=this.url),yield this.room.connect(e,this.token,this.connectOptions),this.room)})}disconnect(){return L(this,void 0,void 0,function*(){this.room&&this.room.state!==at.Disconnected&&(yield this.room.disconnect(),yield new Promise(e=>setTimeout(e,500)))})}skip(){this.setStatus(Fi.SKIPPED)}switchProtocol(e){return L(this,void 0,void 0,function*(){let t=!1,n=!1;if(this.room.on(te.Reconnecting,()=>{t=!0}),this.room.once(te.Reconnected,()=>{n=!0}),this.room.simulateScenario("force-".concat(e)),yield new Promise(a=>setTimeout(a,1e3)),!t)return;const r=Date.now()+1e4;for(;Date.now()<r;){if(n)return;yield Tn(100)}throw new Error("Could not reconnect using ".concat(e," protocol after 10 seconds"))})}appendMessage(e){this.logs.push({level:"info",message:e}),this.emit("update",this.getInfo())}appendWarning(e){this.logs.push({level:"warning",message:e}),this.emit("update",this.getInfo())}appendError(e){this.logs.push({level:"error",message:e}),this.emit("update",this.getInfo())}setStatus(e){this.status=e,this.emit("update",this.getInfo())}get engine(){var e;return(e=this.room)===null||e===void 0?void 0:e.engine}getInfo(){return{logs:this.logs,name:this.name,status:this.status,description:this.description}}}class aj extends $a{get description(){return"Cloud regions"}perform(){return L(this,void 0,void 0,function*(){const e=new st(this.url,this.token);if(!e.isCloud()){this.skip();return}const t=[],n=new Set;for(let a=0;a<3;a++){const o=yield e.getNextBestRegionUrl();if(!o)break;if(n.has(o))continue;n.add(o);const c=yield this.checkCloudRegion(o);this.appendMessage("".concat(c.region," RTT: ").concat(c.rtt,"ms, duration: ").concat(c.duration,"ms")),t.push(c)}t.sort((a,o)=>(a.duration-o.duration)*.5+(a.rtt-o.rtt)*.5);const r=t[0];this.bestStats=r,this.appendMessage("best Cloud region: ".concat(r.region))})}getInfo(){const e=super.getInfo();return e.data=this.bestStats,e}checkCloudRegion(e){return L(this,void 0,void 0,function*(){var t,n;yield this.connect(e),this.options.protocol==="tcp"&&(yield this.switchProtocol("tcp"));const r=(t=this.room.serverInfo)===null||t===void 0?void 0:t.region;if(!r)throw new Error("Region not found");const a=yield this.room.localParticipant.streamText({topic:"test"}),o=1e3,d=1e6/o,h="A".repeat(o),v=Date.now();for(let T=0;T<d;T++)yield a.write(h);yield a.close();const m=Date.now(),y=yield(n=this.room.engine.pcManager)===null||n===void 0?void 0:n.publisher.getStats(),E={region:r,rtt:1e4,duration:m-v};return y?.forEach(T=>{T.type==="candidate-pair"&&T.nominated&&(E.rtt=T.currentRoundTripTime*1e3)}),yield this.disconnect(),E})}}const ug=1e4;class sj extends $a{get description(){return"Connection via UDP vs TCP"}perform(){return L(this,void 0,void 0,function*(){const e=yield this.checkConnectionProtocol("udp"),t=yield this.checkConnectionProtocol("tcp");this.bestStats=e,e.qualityLimitationDurations.bandwidth-t.qualityLimitationDurations.bandwidth>.5||(e.packetsLost-t.packetsLost)/e.packetsSent>.01?(this.appendMessage("best connection quality via tcp"),this.bestStats=t):this.appendMessage("best connection quality via udp");const n=this.bestStats;this.appendMessage("upstream bitrate: ".concat((n.bitrateTotal/n.count/1e3/1e3).toFixed(2)," mbps")),this.appendMessage("RTT: ".concat((n.rttTotal/n.count*1e3).toFixed(2)," ms")),this.appendMessage("jitter: ".concat((n.jitterTotal/n.count*1e3).toFixed(2)," ms")),n.packetsLost>0&&this.appendWarning("packets lost: ".concat((n.packetsLost/n.packetsSent*100).toFixed(2),"%")),n.qualityLimitationDurations.bandwidth>1&&this.appendWarning("bandwidth limited ".concat((n.qualityLimitationDurations.bandwidth/(ug/1e3)*100).toFixed(2),"%")),n.qualityLimitationDurations.cpu>0&&this.appendWarning("cpu limited ".concat((n.qualityLimitationDurations.cpu/(ug/1e3)*100).toFixed(2),"%"))})}getInfo(){const e=super.getInfo();return e.data=this.bestStats,e}checkConnectionProtocol(e){return L(this,void 0,void 0,function*(){yield this.connect(),e==="tcp"?yield this.switchProtocol("tcp"):yield this.switchProtocol("udp");const t=document.createElement("canvas");t.width=1280,t.height=720;const n=t.getContext("2d");if(!n)throw new Error("Could not get canvas context");let r=0;const a=()=>{r=(r+1)%360,n.fillStyle="hsl(".concat(r,", 100%, 50%)"),n.fillRect(0,0,t.width,t.height),requestAnimationFrame(a)};a();const c=t.captureStream(30).getVideoTracks()[0],h=(yield this.room.localParticipant.publishTrack(c,{simulcast:!1,degradationPreference:"maintain-resolution",videoEncoding:{maxBitrate:2e6}})).track,v={protocol:e,packetsLost:0,packetsSent:0,qualityLimitationDurations:{},rttTotal:0,jitterTotal:0,bitrateTotal:0,count:0},m=setInterval(()=>L(this,void 0,void 0,function*(){const y=yield h.getRTCStatsReport();y?.forEach(E=>{E.type==="outbound-rtp"?(v.packetsSent=E.packetsSent,v.qualityLimitationDurations=E.qualityLimitationDurations,v.bitrateTotal+=E.targetBitrate,v.count++):E.type==="remote-inbound-rtp"&&(v.packetsLost=E.packetsLost,v.rttTotal+=E.roundTripTime,v.jitterTotal+=E.jitter)})}),1e3);return yield new Promise(y=>setTimeout(y,ug)),clearInterval(m),c.stop(),t.remove(),yield this.disconnect(),v})}}class oj extends $a{get description(){return"Can publish audio"}perform(){return L(this,void 0,void 0,function*(){var e;const t=yield this.connect(),n=yield ej();if(yield HO(n,1e3))throw new Error("unable to detect audio from microphone");this.appendMessage("detected audio from microphone"),t.localParticipant.publishTrack(n),yield new Promise(c=>setTimeout(c,3e3));const a=yield(e=n.sender)===null||e===void 0?void 0:e.getStats();if(!a)throw new Error("Could not get RTCStats");let o=0;if(a.forEach(c=>{c.type==="outbound-rtp"&&(c.kind==="audio"||!c.kind&&c.mediaType==="audio")&&(o=c.packetsSent)}),o===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(o," audio packets"))})}}class lj extends $a{get description(){return"Can publish video"}perform(){return L(this,void 0,void 0,function*(){var e;const t=yield this.connect(),n=yield Z3();yield this.checkForVideo(n.mediaStreamTrack),t.localParticipant.publishTrack(n),yield new Promise(o=>setTimeout(o,5e3));const r=yield(e=n.sender)===null||e===void 0?void 0:e.getStats();if(!r)throw new Error("Could not get RTCStats");let a=0;if(r.forEach(o=>{o.type==="outbound-rtp"&&(o.kind==="video"||!o.kind&&o.mediaType==="video")&&(a+=o.packetsSent)}),a===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(a," video packets"))})}checkForVideo(e){return L(this,void 0,void 0,function*(){const t=new MediaStream;t.addTrack(e.clone());const n=document.createElement("video");n.srcObject=t,n.muted=!0,n.autoplay=!0,n.playsInline=!0,n.setAttribute("playsinline","true"),document.body.appendChild(n),yield new Promise(r=>{n.onplay=()=>{setTimeout(()=>{var a,o,c,d;const h=document.createElement("canvas"),v=e.getSettings(),m=(o=(a=v.width)!==null&&a!==void 0?a:n.videoWidth)!==null&&o!==void 0?o:1280,y=(d=(c=v.height)!==null&&c!==void 0?c:n.videoHeight)!==null&&d!==void 0?d:720;h.width=m,h.height=y;const E=h.getContext("2d");E.drawImage(n,0,0);const S=E.getImageData(0,0,h.width,h.height).data;let O=!0;for(let R=0;R<S.length;R+=4)if(S[R]!==0||S[R+1]!==0||S[R+2]!==0){O=!1;break}O?this.appendError("camera appears to be producing only black frames"):this.appendMessage("received video frames"),r()},1e3)},n.play()}),t.getTracks().forEach(r=>r.stop()),n.remove()})}}class cj extends $a{get description(){return"Resuming connection after interruption"}perform(){return L(this,void 0,void 0,function*(){var e;const t=yield this.connect();let n=!1,r=!1,a;const o=new Promise(h=>{setTimeout(h,5e3),a=h}),c=()=>{n=!0};t.on(te.SignalReconnecting,c).on(te.Reconnecting,c).on(te.Reconnected,()=>{r=!0,a(!0)}),(e=t.engine.client.ws)===null||e===void 0||e.close();const d=t.engine.client.onClose;if(d&&d(""),yield o,n){if(!r||t.state!==at.Connected)throw this.appendWarning("reconnection is only possible in Redis-based configurations"),new Error("Not able to reconnect")}else throw new Error("Did not attempt to reconnect")})}}class uj extends $a{get description(){return"Can connect via TURN"}perform(){return L(this,void 0,void 0,function*(){var e,t;const n=new Lb,r=yield n.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3,singlePeerConnection:!1});let a=!1,o=!1,c=!1;for(let d of r.iceServers)for(let h of d.urls)h.startsWith("turn:")?(o=!0,c=!0):h.startsWith("turns:")&&(o=!0,c=!0,a=!0),h.startsWith("stun:")&&(c=!0);c?o&&!a&&this.appendWarning("TURN is configured server side, but TURN/TLS is unavailable."):this.appendWarning("No STUN servers configured on server side."),yield n.close(),!((t=(e=this.connectOptions)===null||e===void 0?void 0:e.rtcConfig)===null||t===void 0)&&t.iceServers||o?yield this.room.connect(this.url,this.token,{rtcConfig:{iceTransportPolicy:"relay"}}):(this.appendWarning("No TURN servers configured."),this.skip(),yield new Promise(d=>setTimeout(d,0)))})}}class dj extends $a{get description(){return"Establishing WebRTC connection"}perform(){return L(this,void 0,void 0,function*(){let e=!1,t=!1;this.room.on(te.SignalConnected,()=>{var n;const r=this.room.engine.client.onTrickle;this.room.engine.client.onTrickle=(a,o)=>{if(a.candidate){const c=new RTCIceCandidate(a);let d="".concat(c.protocol," ").concat(c.address,":").concat(c.port," ").concat(c.type);c.address&&(hj(c.address)?d+=" (private)":c.protocol==="tcp"&&c.tcpType==="passive"?(e=!0,d+=" (passive)"):c.protocol==="udp"&&(t=!0)),this.appendMessage(d)}r&&r(a,o)},!((n=this.room.engine.pcManager)===null||n===void 0)&&n.subscriber&&(this.room.engine.pcManager.subscriber.onIceCandidateError=a=>{a instanceof RTCPeerConnectionIceErrorEvent&&this.appendWarning("error with ICE candidate: ".concat(a.errorCode," ").concat(a.errorText," ").concat(a.url))})});try{yield this.connect(),Fe.info("now the room is connected")}catch(n){throw this.appendWarning("ports need to be open on firewall in order to connect."),n}e||this.appendWarning("Server is not configured for ICE/TCP"),t||this.appendWarning("No public IPv4 UDP candidates were found. Your server is likely not configured correctly")})}}function hj(i){const e=i.split(".");if(e.length===4){if(e[0]==="10")return!0;if(e[0]==="192"&&e[1]==="168")return!0;if(e[0]==="172"){const t=parseInt(e[1],10);if(t>=16&&t<=31)return!0}}return!1}class fj extends $a{get description(){return"Connecting to signal connection via WebSocket"}perform(){return L(this,void 0,void 0,function*(){var e,t,n;(this.url.startsWith("ws:")||this.url.startsWith("http:"))&&this.appendWarning("Server is insecure, clients may block connections to it");let r=new Lb;const a=yield r.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3,singlePeerConnection:!1});this.appendMessage("Connected to server, version ".concat(a.serverVersion,".")),((e=a.serverInfo)===null||e===void 0?void 0:e.edition)===HI.Cloud&&(!((t=a.serverInfo)===null||t===void 0)&&t.region)&&this.appendMessage("LiveKit Cloud: ".concat((n=a.serverInfo)===null||n===void 0?void 0:n.region)),yield r.close()})}}class Gq extends vr.EventEmitter{constructor(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.options={},this.checkResults=new Map,this.url=e,this.token=t,this.options=n}getNextCheckId(){const e=this.checkResults.size;return this.checkResults.set(e,{logs:[],status:Fi.IDLE,name:"",description:""}),e}updateCheck(e,t){this.checkResults.set(e,t),this.emit("checkUpdate",e,t)}isSuccess(){return Array.from(this.checkResults.values()).every(e=>e.status!==Fi.FAILED)}getResults(){return Array.from(this.checkResults.values())}createAndRunCheck(e){return L(this,void 0,void 0,function*(){const t=this.getNextCheckId(),n=new e(this.url,this.token,this.options),r=o=>{this.updateCheck(t,o)};n.on("update",r);const a=yield n.run();return n.off("update",r),a})}checkWebsocket(){return L(this,void 0,void 0,function*(){return this.createAndRunCheck(fj)})}checkWebRTC(){return L(this,void 0,void 0,function*(){return this.createAndRunCheck(dj)})}checkTURN(){return L(this,void 0,void 0,function*(){return this.createAndRunCheck(uj)})}checkReconnect(){return L(this,void 0,void 0,function*(){return this.createAndRunCheck(cj)})}checkPublishAudio(){return L(this,void 0,void 0,function*(){return this.createAndRunCheck(oj)})}checkPublishVideo(){return L(this,void 0,void 0,function*(){return this.createAndRunCheck(lj)})}checkConnectionProtocol(){return L(this,void 0,void 0,function*(){const e=yield this.createAndRunCheck(sj);if(e.data&&"protocol"in e.data){const t=e.data;this.options.protocol=t.protocol}return e})}checkCloudRegion(){return L(this,void 0,void 0,function*(){return this.createAndRunCheck(aj)})}}function Ye(i,e,t){return(e=mj(e))in i?Object.defineProperty(i,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):i[e]=t,i}function vj(i,e){if(typeof i!="object"||!i)return i;var t=i[Symbol.toPrimitive];if(t!==void 0){var n=t.call(i,e);if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(i)}function mj(i){var e=vj(i,"string");return typeof e=="symbol"?e:e+""}new TextEncoder;new TextDecoder;class Dn extends Error{constructor(e,t){var n;super(e,t),Ye(this,"code","ERR_JOSE_GENERIC"),this.name=this.constructor.name,(n=Error.captureStackTrace)===null||n===void 0||n.call(Error,this,this.constructor)}}Ye(Dn,"code","ERR_JOSE_GENERIC");class pj extends Dn{constructor(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unspecified",r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"unspecified";super(e,{cause:{claim:n,reason:r,payload:t}}),Ye(this,"code","ERR_JWT_CLAIM_VALIDATION_FAILED"),Ye(this,"claim",void 0),Ye(this,"reason",void 0),Ye(this,"payload",void 0),this.claim=n,this.reason=r,this.payload=t}}Ye(pj,"code","ERR_JWT_CLAIM_VALIDATION_FAILED");class gj extends Dn{constructor(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unspecified",r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"unspecified";super(e,{cause:{claim:n,reason:r,payload:t}}),Ye(this,"code","ERR_JWT_EXPIRED"),Ye(this,"claim",void 0),Ye(this,"reason",void 0),Ye(this,"payload",void 0),this.claim=n,this.reason=r,this.payload=t}}Ye(gj,"code","ERR_JWT_EXPIRED");class yj extends Dn{constructor(){super(...arguments),Ye(this,"code","ERR_JOSE_ALG_NOT_ALLOWED")}}Ye(yj,"code","ERR_JOSE_ALG_NOT_ALLOWED");class bj extends Dn{constructor(){super(...arguments),Ye(this,"code","ERR_JOSE_NOT_SUPPORTED")}}Ye(bj,"code","ERR_JOSE_NOT_SUPPORTED");class Sj extends Dn{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"decryption operation failed",t=arguments.length>1?arguments[1]:void 0;super(e,t),Ye(this,"code","ERR_JWE_DECRYPTION_FAILED")}}Ye(Sj,"code","ERR_JWE_DECRYPTION_FAILED");class Ej extends Dn{constructor(){super(...arguments),Ye(this,"code","ERR_JWE_INVALID")}}Ye(Ej,"code","ERR_JWE_INVALID");class Tj extends Dn{constructor(){super(...arguments),Ye(this,"code","ERR_JWS_INVALID")}}Ye(Tj,"code","ERR_JWS_INVALID");class _j extends Dn{constructor(){super(...arguments),Ye(this,"code","ERR_JWT_INVALID")}}Ye(_j,"code","ERR_JWT_INVALID");class Cj extends Dn{constructor(){super(...arguments),Ye(this,"code","ERR_JWK_INVALID")}}Ye(Cj,"code","ERR_JWK_INVALID");class Rj extends Dn{constructor(){super(...arguments),Ye(this,"code","ERR_JWKS_INVALID")}}Ye(Rj,"code","ERR_JWKS_INVALID");class kj extends Dn{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"no applicable key found in the JSON Web Key Set",t=arguments.length>1?arguments[1]:void 0;super(e,t),Ye(this,"code","ERR_JWKS_NO_MATCHING_KEY")}}Ye(kj,"code","ERR_JWKS_NO_MATCHING_KEY");class wj extends Dn{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"multiple matching keys found in the JSON Web Key Set",t=arguments.length>1?arguments[1]:void 0;super(e,t),Ye(this,Symbol.asyncIterator,void 0),Ye(this,"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS")}}Ye(wj,"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS");class Ij extends Dn{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"request timed out",t=arguments.length>1?arguments[1]:void 0;super(e,t),Ye(this,"code","ERR_JWKS_TIMEOUT")}}Ye(Ij,"code","ERR_JWKS_TIMEOUT");class Oj extends Dn{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"signature verification failed",t=arguments.length>1?arguments[1]:void 0;super(e,t),Ye(this,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED")}}Ye(Oj,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED");function zq(i){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var t;const n=Us(i)?i.mediaStreamTrack:i,r=n.getSettings();let a={facingMode:(t=e.defaultFacingMode)!==null&&t!==void 0?t:"user",confidence:"low"};if("facingMode"in r){const o=r.facingMode;Fe.trace("rawFacingMode",{rawFacingMode:o}),o&&typeof o=="string"&&Aj(o)&&(a={facingMode:o,confidence:"high"})}if(["low","medium"].includes(a.confidence)){Fe.trace("Try to get facing mode from device label: (".concat(n.label,")"));const o=Pj(n.label);o!==void 0&&(a=o)}return a}const lk=new Map([["obs virtual camera",{facingMode:"environment",confidence:"medium"}]]),Mj=new Map([["iphone",{facingMode:"environment",confidence:"medium"}],["ipad",{facingMode:"environment",confidence:"medium"}]]);function Pj(i){var e;const t=i.trim().toLowerCase();if(t!=="")return lk.has(t)?lk.get(t):(e=Array.from(Mj.entries()).find(n=>{let[r]=n;return t.includes(r)}))===null||e===void 0?void 0:e[1]}function Aj(i){return i===void 0||["user","environment","left","right"].includes(i)}var Dj=typeof global=="object"&&global&&global.Object===Object&&global,Nj=typeof self=="object"&&self&&self.Object===Object&&self,oM=Dj||Nj||Function("return this")(),yf=oM.Symbol,lM=Object.prototype,xj=lM.hasOwnProperty,Lj=lM.toString,jc=yf?yf.toStringTag:void 0;function Uj(i){var e=xj.call(i,jc),t=i[jc];try{i[jc]=void 0;var n=!0}catch{}var r=Lj.call(i);return n&&(e?i[jc]=t:delete i[jc]),r}var Bj=Object.prototype,Fj=Bj.toString;function jj(i){return Fj.call(i)}var qj="[object Null]",Vj="[object Undefined]",ck=yf?yf.toStringTag:void 0;function Kj(i){return i==null?i===void 0?Vj:qj:ck&&ck in Object(i)?Uj(i):jj(i)}function Hj(i){return i!=null&&typeof i=="object"}var Gj="[object Symbol]";function zj(i){return typeof i=="symbol"||Hj(i)&&Kj(i)==Gj}var Wj=/\s/;function Jj(i){for(var e=i.length;e--&&Wj.test(i.charAt(e)););return e}var Yj=/^\s+/;function $j(i){return i&&i.slice(0,Jj(i)+1).replace(Yj,"")}function Dy(i){var e=typeof i;return i!=null&&(e=="object"||e=="function")}var uk=NaN,Xj=/^[-+]0x[0-9a-f]+$/i,Qj=/^0b[01]+$/i,Zj=/^0o[0-7]+$/i,e2=parseInt;function dk(i){if(typeof i=="number")return i;if(zj(i))return uk;if(Dy(i)){var e=typeof i.valueOf=="function"?i.valueOf():i;i=Dy(e)?e+"":e}if(typeof i!="string")return i===0?i:+i;i=$j(i);var t=Qj.test(i);return t||Zj.test(i)?e2(i.slice(2),t?2:8):Xj.test(i)?uk:+i}var dg=function(){return oM.Date.now()},t2="Expected a function",n2=Math.max,i2=Math.min;function Wq(i,e,t){var n,r,a,o,c,d,h=0,v=!1,m=!1,y=!0;if(typeof i!="function")throw new TypeError(t2);e=dk(e)||0,Dy(t)&&(v=!!t.leading,m="maxWait"in t,a=m?n2(dk(t.maxWait)||0,e):a,y="trailing"in t?!!t.trailing:y);function E(_){var P=n,x=r;return n=r=void 0,h=_,o=i.apply(x,P),o}function T(_){return h=_,c=setTimeout(R,e),v?E(_):o}function S(_){var P=_-d,x=_-h,U=e-P;return m?i2(U,a-x):U}function O(_){var P=_-d,x=_-h;return d===void 0||P>=e||P<0||m&&x>=a}function R(){var _=dg();if(O(_))return I(_);c=setTimeout(R,S(_))}function I(_){return c=void 0,y&&n?E(_):(n=r=void 0,o)}function M(){c!==void 0&&clearTimeout(c),h=0,n=d=r=c=void 0}function C(){return c===void 0?o:I(dg())}function k(){var _=dg(),P=O(_);if(n=arguments,r=this,d=_,P){if(c===void 0)return T(d);if(m)return clearTimeout(c),c=setTimeout(R,e),E(d)}return c===void 0&&(c=setTimeout(R,e)),o}return k.cancel=M,k.flush=C,k}var ph=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function cM(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var Ny={exports:{}},r2=Ny.exports,hk;function a2(){return hk||(hk=1,(function(i){(function(e,t){i.exports?i.exports=t():e.log=t()})(r2,function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],a={},o=null;function c(S,O){var R=S[O];if(typeof R.bind=="function")return R.bind(S);try{return Function.prototype.bind.call(R,S)}catch{return function(){return Function.prototype.apply.apply(R,[S,arguments])}}}function d(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function h(S){return S==="debug"&&(S="log"),typeof console===t?!1:S==="trace"&&n?d:console[S]!==void 0?c(console,S):console.log!==void 0?c(console,"log"):e}function v(){for(var S=this.getLevel(),O=0;O<r.length;O++){var R=r[O];this[R]=O<S?e:this.methodFactory(R,S,this.name)}if(this.log=this.debug,typeof console===t&&S<this.levels.SILENT)return"No console available for logging"}function m(S){return function(){typeof console!==t&&(v.call(this),this[S].apply(this,arguments))}}function y(S,O,R){return h(S)||m.apply(this,arguments)}function E(S,O){var R=this,I,M,C,k="loglevel";typeof S=="string"?k+=":"+S:typeof S=="symbol"&&(k=void 0);function _(K){var Z=(r[K]||"silent").toUpperCase();if(!(typeof window===t||!k)){try{window.localStorage[k]=Z;return}catch{}try{window.document.cookie=encodeURIComponent(k)+"="+Z+";"}catch{}}}function P(){var K;if(!(typeof window===t||!k)){try{K=window.localStorage[k]}catch{}if(typeof K===t)try{var Z=window.document.cookie,be=encodeURIComponent(k),Pe=Z.indexOf(be+"=");Pe!==-1&&(K=/^([^;]+)/.exec(Z.slice(Pe+be.length+1))[1])}catch{}return R.levels[K]===void 0&&(K=void 0),K}}function x(){if(!(typeof window===t||!k)){try{window.localStorage.removeItem(k)}catch{}try{window.document.cookie=encodeURIComponent(k)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function U(K){var Z=K;if(typeof Z=="string"&&R.levels[Z.toUpperCase()]!==void 0&&(Z=R.levels[Z.toUpperCase()]),typeof Z=="number"&&Z>=0&&Z<=R.levels.SILENT)return Z;throw new TypeError("log.setLevel() called with invalid level: "+K)}R.name=S,R.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},R.methodFactory=O||y,R.getLevel=function(){return C??M??I},R.setLevel=function(K,Z){return C=U(K),Z!==!1&&_(C),v.call(R)},R.setDefaultLevel=function(K){M=U(K),P()||R.setLevel(K,!1)},R.resetLevel=function(){C=null,x(),v.call(R)},R.enableAll=function(K){R.setLevel(R.levels.TRACE,K)},R.disableAll=function(K){R.setLevel(R.levels.SILENT,K)},R.rebuild=function(){if(o!==R&&(I=U(o.getLevel())),v.call(R),o===R)for(var K in a)a[K].rebuild()},I=U(o?o.getLevel():"WARN");var j=P();j!=null&&(C=U(j)),v.call(R)}o=new E,o.getLogger=function(S){if(typeof S!="symbol"&&typeof S!="string"||S==="")throw new TypeError("You must supply a name when creating a logger.");var O=a[S];return O||(O=a[S]=new E(S,o.methodFactory)),O};var T=typeof window!==t?window.log:void 0;return o.noConflict=function(){return typeof window!==t&&window.log===o&&(window.log=T),o},o.getLoggers=function(){return a},o.default=o,o})})(Ny)),Ny.exports}var s2=a2();const o2=cM(s2);var xy=function(i,e){return xy=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])},xy(i,e)};function Zr(i,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");xy(i,e);function t(){this.constructor=i}i.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function l2(i,e,t,n){function r(a){return a instanceof t?a:new t(function(o){o(a)})}return new(t||(t=Promise))(function(a,o){function c(v){try{h(n.next(v))}catch(m){o(m)}}function d(v){try{h(n.throw(v))}catch(m){o(m)}}function h(v){v.done?a(v.value):r(v.value).then(c,d)}h((n=n.apply(i,[])).next())})}function uM(i,e){var t={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},n,r,a,o=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return o.next=c(0),o.throw=c(1),o.return=c(2),typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function c(h){return function(v){return d([h,v])}}function d(h){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,h[0]&&(t=0)),t;)try{if(n=1,r&&(a=h[0]&2?r.return:h[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,h[1])).done)return a;switch(r=0,a&&(h=[h[0]&2,a.value]),h[0]){case 0:case 1:a=h;break;case 4:return t.label++,{value:h[1],done:!1};case 5:t.label++,r=h[1],h=[0];continue;case 7:h=t.ops.pop(),t.trys.pop();continue;default:if(a=t.trys,!(a=a.length>0&&a[a.length-1])&&(h[0]===6||h[0]===2)){t=0;continue}if(h[0]===3&&(!a||h[1]>a[0]&&h[1]<a[3])){t.label=h[1];break}if(h[0]===6&&t.label<a[1]){t.label=a[1],a=h;break}if(a&&t.label<a[2]){t.label=a[2],t.ops.push(h);break}a[2]&&t.ops.pop(),t.trys.pop();continue}h=e.call(i,t)}catch(v){h=[6,v],r=0}finally{n=a=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}}function bl(i){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&i[e],n=0;if(t)return t.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&n>=i.length&&(i=void 0),{value:i&&i[n++],done:!i}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function bf(i,e){var t=typeof Symbol=="function"&&i[Symbol.iterator];if(!t)return i;var n=t.call(i),r,a=[],o;try{for(;(e===void 0||e-- >0)&&!(r=n.next()).done;)a.push(r.value)}catch(c){o={error:c}}finally{try{r&&!r.done&&(t=n.return)&&t.call(n)}finally{if(o)throw o.error}}return a}function Sf(i,e,t){if(arguments.length===2)for(var n=0,r=e.length,a;n<r;n++)(a||!(n in e))&&(a||(a=Array.prototype.slice.call(e,0,n)),a[n]=e[n]);return i.concat(a||Array.prototype.slice.call(e))}function ol(i){return this instanceof ol?(this.v=i,this):new ol(i)}function c2(i,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t.apply(i,e||[]),r,a=[];return r=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),c("next"),c("throw"),c("return",o),r[Symbol.asyncIterator]=function(){return this},r;function o(E){return function(T){return Promise.resolve(T).then(E,m)}}function c(E,T){n[E]&&(r[E]=function(S){return new Promise(function(O,R){a.push([E,S,O,R])>1||d(E,S)})},T&&(r[E]=T(r[E])))}function d(E,T){try{h(n[E](T))}catch(S){y(a[0][3],S)}}function h(E){E.value instanceof ol?Promise.resolve(E.value.v).then(v,m):y(a[0][2],E)}function v(E){d("next",E)}function m(E){d("throw",E)}function y(E,T){E(T),a.shift(),a.length&&d(a[0][0],a[0][1])}}function u2(i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=i[Symbol.asyncIterator],t;return e?e.call(i):(i=typeof bl=="function"?bl(i):i[Symbol.iterator](),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(a){t[a]=i[a]&&function(o){return new Promise(function(c,d){o=i[a](o),r(c,d,o.done,o.value)})}}function r(a,o,c,d){Promise.resolve(d).then(function(h){a({value:h,done:c})},o)}}function an(i){return typeof i=="function"}function Hb(i){var e=function(n){Error.call(n),n.stack=new Error().stack},t=i(e);return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var hg=Hb(function(i){return function(e){i(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(t,n){return n+1+") "+t.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}});function Ef(i,e){if(i){var t=i.indexOf(e);0<=t&&i.splice(t,1)}}var Au=(function(){function i(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return i.prototype.unsubscribe=function(){var e,t,n,r,a;if(!this.closed){this.closed=!0;var o=this._parentage;if(o)if(this._parentage=null,Array.isArray(o))try{for(var c=bl(o),d=c.next();!d.done;d=c.next()){var h=d.value;h.remove(this)}}catch(S){e={error:S}}finally{try{d&&!d.done&&(t=c.return)&&t.call(c)}finally{if(e)throw e.error}}else o.remove(this);var v=this.initialTeardown;if(an(v))try{v()}catch(S){a=S instanceof hg?S.errors:[S]}var m=this._finalizers;if(m){this._finalizers=null;try{for(var y=bl(m),E=y.next();!E.done;E=y.next()){var T=E.value;try{fk(T)}catch(S){a=a??[],S instanceof hg?a=Sf(Sf([],bf(a)),bf(S.errors)):a.push(S)}}}catch(S){n={error:S}}finally{try{E&&!E.done&&(r=y.return)&&r.call(y)}finally{if(n)throw n.error}}}if(a)throw new hg(a)}},i.prototype.add=function(e){var t;if(e&&e!==this)if(this.closed)fk(e);else{if(e instanceof i){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(e)}},i.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},i.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},i.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&Ef(t,e)},i.prototype.remove=function(e){var t=this._finalizers;t&&Ef(t,e),e instanceof i&&e._removeParent(this)},i.EMPTY=(function(){var e=new i;return e.closed=!0,e})(),i})(),dM=Au.EMPTY;function hM(i){return i instanceof Au||i&&"closed"in i&&an(i.remove)&&an(i.add)&&an(i.unsubscribe)}function fk(i){an(i)?i():i.unsubscribe()}var d2={Promise:void 0},h2={setTimeout:function(i,e){for(var t=[],n=2;n<arguments.length;n++)t[n-2]=arguments[n];return setTimeout.apply(void 0,Sf([i,e],bf(t)))},clearTimeout:function(i){return clearTimeout(i)},delegate:void 0};function fM(i){h2.setTimeout(function(){throw i})}function vk(){}function Vh(i){i()}var Gb=(function(i){Zr(e,i);function e(t){var n=i.call(this)||this;return n.isStopped=!1,t?(n.destination=t,hM(t)&&t.add(n)):n.destination=m2,n}return e.create=function(t,n,r){return new Ly(t,n,r)},e.prototype.next=function(t){this.isStopped||this._next(t)},e.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,i.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e})(Au),f2=(function(){function i(e){this.partialObserver=e}return i.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(n){gh(n)}},i.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(n){gh(n)}else gh(e)},i.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(t){gh(t)}},i})(),Ly=(function(i){Zr(e,i);function e(t,n,r){var a=i.call(this)||this,o;return an(t)||!t?o={next:t??void 0,error:n??void 0,complete:r??void 0}:o=t,a.destination=new f2(o),a}return e})(Gb);function gh(i){fM(i)}function v2(i){throw i}var m2={closed:!0,next:vk,error:v2,complete:vk},zb=(function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"})();function vM(i){return i}function p2(i){return i.length===0?vM:i.length===1?i[0]:function(e){return i.reduce(function(t,n){return n(t)},e)}}var vi=(function(){function i(e){e&&(this._subscribe=e)}return i.prototype.lift=function(e){var t=new i;return t.source=this,t.operator=e,t},i.prototype.subscribe=function(e,t,n){var r=this,a=y2(e)?e:new Ly(e,t,n);return Vh(function(){var o=r,c=o.operator,d=o.source;a.add(c?c.call(a,d):d?r._subscribe(a):r._trySubscribe(a))}),a},i.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},i.prototype.forEach=function(e,t){var n=this;return t=mk(t),new t(function(r,a){var o=new Ly({next:function(c){try{e(c)}catch(d){a(d),o.unsubscribe()}},error:a,complete:r});n.subscribe(o)})},i.prototype._subscribe=function(e){var t;return(t=this.source)===null||t===void 0?void 0:t.subscribe(e)},i.prototype[zb]=function(){return this},i.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return p2(e)(this)},i.prototype.toPromise=function(e){var t=this;return e=mk(e),new e(function(n,r){var a;t.subscribe(function(o){return a=o},function(o){return r(o)},function(){return n(a)})})},i.create=function(e){return new i(e)},i})();function mk(i){var e;return(e=i??d2.Promise)!==null&&e!==void 0?e:Promise}function g2(i){return i&&an(i.next)&&an(i.error)&&an(i.complete)}function y2(i){return i&&i instanceof Gb||g2(i)&&hM(i)}function b2(i){return an(i?.lift)}function Du(i){return function(e){if(b2(e))return e.lift(function(t){try{return i(t,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}function Tf(i,e,t,n,r){return new S2(i,e,t,n,r)}var S2=(function(i){Zr(e,i);function e(t,n,r,a,o,c){var d=i.call(this,t)||this;return d.onFinalize=o,d.shouldUnsubscribe=c,d._next=n?function(h){try{n(h)}catch(v){t.error(v)}}:i.prototype._next,d._error=a?function(h){try{a(h)}catch(v){t.error(v)}finally{this.unsubscribe()}}:i.prototype._error,d._complete=r?function(){try{r()}catch(h){t.error(h)}finally{this.unsubscribe()}}:i.prototype._complete,d}return e.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;i.prototype.unsubscribe.call(this),!n&&((t=this.onFinalize)===null||t===void 0||t.call(this))}},e})(Gb),E2=Hb(function(i){return function(){i(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),mM=(function(i){Zr(e,i);function e(){var t=i.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return e.prototype.lift=function(t){var n=new pk(this,this);return n.operator=t,n},e.prototype._throwIfClosed=function(){if(this.closed)throw new E2},e.prototype.next=function(t){var n=this;Vh(function(){var r,a;if(n._throwIfClosed(),!n.isStopped){n.currentObservers||(n.currentObservers=Array.from(n.observers));try{for(var o=bl(n.currentObservers),c=o.next();!c.done;c=o.next()){var d=c.value;d.next(t)}}catch(h){r={error:h}}finally{try{c&&!c.done&&(a=o.return)&&a.call(o)}finally{if(r)throw r.error}}}})},e.prototype.error=function(t){var n=this;Vh(function(){if(n._throwIfClosed(),!n.isStopped){n.hasError=n.isStopped=!0,n.thrownError=t;for(var r=n.observers;r.length;)r.shift().error(t)}})},e.prototype.complete=function(){var t=this;Vh(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var n=t.observers;n.length;)n.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(t){return this._throwIfClosed(),i.prototype._trySubscribe.call(this,t)},e.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},e.prototype._innerSubscribe=function(t){var n=this,r=this,a=r.hasError,o=r.isStopped,c=r.observers;return a||o?dM:(this.currentObservers=null,c.push(t),new Au(function(){n.currentObservers=null,Ef(c,t)}))},e.prototype._checkFinalizedStatuses=function(t){var n=this,r=n.hasError,a=n.thrownError,o=n.isStopped;r?t.error(a):o&&t.complete()},e.prototype.asObservable=function(){var t=new vi;return t.source=this,t},e.create=function(t,n){return new pk(t,n)},e})(vi),pk=(function(i){Zr(e,i);function e(t,n){var r=i.call(this)||this;return r.destination=t,r.source=n,r}return e.prototype.next=function(t){var n,r;(r=(n=this.destination)===null||n===void 0?void 0:n.next)===null||r===void 0||r.call(n,t)},e.prototype.error=function(t){var n,r;(r=(n=this.destination)===null||n===void 0?void 0:n.error)===null||r===void 0||r.call(n,t)},e.prototype.complete=function(){var t,n;(n=(t=this.destination)===null||t===void 0?void 0:t.complete)===null||n===void 0||n.call(t)},e.prototype._subscribe=function(t){var n,r;return(r=(n=this.source)===null||n===void 0?void 0:n.subscribe(t))!==null&&r!==void 0?r:dM},e})(mM);(function(i){Zr(e,i);function e(t){var n=i.call(this)||this;return n._value=t,n}return Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),e.prototype._subscribe=function(t){var n=i.prototype._subscribe.call(this,t);return!n.closed&&t.next(this._value),n},e.prototype.getValue=function(){var t=this,n=t.hasError,r=t.thrownError,a=t._value;if(n)throw r;return this._throwIfClosed(),a},e.prototype.next=function(t){i.prototype.next.call(this,this._value=t)},e})(mM);var T2={now:function(){return Date.now()}},_2=(function(i){Zr(e,i);function e(t,n){return i.call(this)||this}return e.prototype.schedule=function(t,n){return this},e})(Au),gk={setInterval:function(i,e){for(var t=[],n=2;n<arguments.length;n++)t[n-2]=arguments[n];return setInterval.apply(void 0,Sf([i,e],bf(t)))},clearInterval:function(i){return clearInterval(i)},delegate:void 0},C2=(function(i){Zr(e,i);function e(t,n){var r=i.call(this,t,n)||this;return r.scheduler=t,r.work=n,r.pending=!1,r}return e.prototype.schedule=function(t,n){var r;if(n===void 0&&(n=0),this.closed)return this;this.state=t;var a=this.id,o=this.scheduler;return a!=null&&(this.id=this.recycleAsyncId(o,a,n)),this.pending=!0,this.delay=n,this.id=(r=this.id)!==null&&r!==void 0?r:this.requestAsyncId(o,this.id,n),this},e.prototype.requestAsyncId=function(t,n,r){return r===void 0&&(r=0),gk.setInterval(t.flush.bind(t,this),r)},e.prototype.recycleAsyncId=function(t,n,r){if(r===void 0&&(r=0),r!=null&&this.delay===r&&this.pending===!1)return n;n!=null&&gk.clearInterval(n)},e.prototype.execute=function(t,n){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var r=this._execute(t,n);if(r)return r;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(t,n){var r=!1,a;try{this.work(t)}catch(o){r=!0,a=o||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),a},e.prototype.unsubscribe=function(){if(!this.closed){var t=this,n=t.id,r=t.scheduler,a=r.actions;this.work=this.state=this.scheduler=null,this.pending=!1,Ef(a,this),n!=null&&(this.id=this.recycleAsyncId(r,n,null)),this.delay=null,i.prototype.unsubscribe.call(this)}},e})(_2),yk=(function(){function i(e,t){t===void 0&&(t=i.now),this.schedulerActionCtor=e,this.now=t}return i.prototype.schedule=function(e,t,n){return t===void 0&&(t=0),new this.schedulerActionCtor(this,e).schedule(n,t)},i.now=T2.now,i})(),R2=(function(i){Zr(e,i);function e(t,n){n===void 0&&(n=yk.now);var r=i.call(this,t,n)||this;return r.actions=[],r._active=!1,r}return e.prototype.flush=function(t){var n=this.actions;if(this._active){n.push(t);return}var r;this._active=!0;do if(r=t.execute(t.state,t.delay))break;while(t=n.shift());if(this._active=!1,r){for(;t=n.shift();)t.unsubscribe();throw r}},e})(yk);new R2(C2);function k2(i){return i&&an(i.schedule)}function w2(i){return i[i.length-1]}function pM(i){return k2(w2(i))?i.pop():void 0}var gM=(function(i){return i&&typeof i.length=="number"&&typeof i!="function"});function yM(i){return an(i?.then)}function bM(i){return an(i[zb])}function SM(i){return Symbol.asyncIterator&&an(i?.[Symbol.asyncIterator])}function EM(i){return new TypeError("You provided "+(i!==null&&typeof i=="object"?"an invalid object":"'"+i+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function I2(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var TM=I2();function _M(i){return an(i?.[TM])}function CM(i){return c2(this,arguments,function(){var e,t,n,r;return uM(this,function(a){switch(a.label){case 0:e=i.getReader(),a.label=1;case 1:a.trys.push([1,,9,10]),a.label=2;case 2:return[4,ol(e.read())];case 3:return t=a.sent(),n=t.value,r=t.done,r?[4,ol(void 0)]:[3,5];case 4:return[2,a.sent()];case 5:return[4,ol(n)];case 6:return[4,a.sent()];case 7:return a.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function RM(i){return an(i?.getReader)}function Nu(i){if(i instanceof vi)return i;if(i!=null){if(bM(i))return O2(i);if(gM(i))return M2(i);if(yM(i))return P2(i);if(SM(i))return kM(i);if(_M(i))return A2(i);if(RM(i))return D2(i)}throw EM(i)}function O2(i){return new vi(function(e){var t=i[zb]();if(an(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function M2(i){return new vi(function(e){for(var t=0;t<i.length&&!e.closed;t++)e.next(i[t]);e.complete()})}function P2(i){return new vi(function(e){i.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,fM)})}function A2(i){return new vi(function(e){var t,n;try{for(var r=bl(i),a=r.next();!a.done;a=r.next()){var o=a.value;if(e.next(o),e.closed)return}}catch(c){t={error:c}}finally{try{a&&!a.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}e.complete()})}function kM(i){return new vi(function(e){N2(i,e).catch(function(t){return e.error(t)})})}function D2(i){return kM(CM(i))}function N2(i,e){var t,n,r,a;return l2(this,void 0,void 0,function(){var o,c;return uM(this,function(d){switch(d.label){case 0:d.trys.push([0,5,6,11]),t=u2(i),d.label=1;case 1:return[4,t.next()];case 2:if(n=d.sent(),!!n.done)return[3,4];if(o=n.value,e.next(o),e.closed)return[2];d.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return c=d.sent(),r={error:c},[3,11];case 6:return d.trys.push([6,,9,10]),n&&!n.done&&(a=t.return)?[4,a.call(t)]:[3,8];case 7:d.sent(),d.label=8;case 8:return[3,10];case 9:if(r)throw r.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})})}function Bs(i,e,t,n,r){n===void 0&&(n=0),r===void 0&&(r=!1);var a=e.schedule(function(){t(),r?i.add(this.schedule(null,n)):this.unsubscribe()},n);if(i.add(a),!r)return a}function wM(i,e){return e===void 0&&(e=0),Du(function(t,n){t.subscribe(Tf(n,function(r){return Bs(n,i,function(){return n.next(r)},e)},function(){return Bs(n,i,function(){return n.complete()},e)},function(r){return Bs(n,i,function(){return n.error(r)},e)}))})}function IM(i,e){return e===void 0&&(e=0),Du(function(t,n){n.add(i.schedule(function(){return t.subscribe(n)},e))})}function x2(i,e){return Nu(i).pipe(IM(e),wM(e))}function L2(i,e){return Nu(i).pipe(IM(e),wM(e))}function U2(i,e){return new vi(function(t){var n=0;return e.schedule(function(){n===i.length?t.complete():(t.next(i[n++]),t.closed||this.schedule())})})}function B2(i,e){return new vi(function(t){var n;return Bs(t,e,function(){n=i[TM](),Bs(t,e,function(){var r,a,o;try{r=n.next(),a=r.value,o=r.done}catch(c){t.error(c);return}o?t.complete():t.next(a)},0,!0)}),function(){return an(n?.return)&&n.return()}})}function OM(i,e){if(!i)throw new Error("Iterable cannot be null");return new vi(function(t){Bs(t,e,function(){var n=i[Symbol.asyncIterator]();Bs(t,e,function(){n.next().then(function(r){r.done?t.complete():t.next(r.value)})},0,!0)})})}function F2(i,e){return OM(CM(i),e)}function j2(i,e){if(i!=null){if(bM(i))return x2(i,e);if(gM(i))return U2(i,e);if(yM(i))return L2(i,e);if(SM(i))return OM(i,e);if(_M(i))return B2(i,e);if(RM(i))return F2(i,e)}throw EM(i)}function q2(i,e){return e?j2(i,e):Nu(i)}Hb(function(i){return function(e){e===void 0&&(e=null),i(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=e}});function Jf(i,e){return Du(function(t,n){var r=0;t.subscribe(Tf(n,function(a){n.next(i.call(e,a,r++))}))})}function V2(i,e,t,n,r,a,o,c){var d=[],h=0,v=0,m=!1,y=function(){m&&!d.length&&!h&&e.complete()},E=function(S){return h<n?T(S):d.push(S)},T=function(S){h++;var O=!1;Nu(t(S,v++)).subscribe(Tf(e,function(R){e.next(R)},function(){O=!0},void 0,function(){if(O)try{h--;for(var R=function(){var I=d.shift();o||T(I)};d.length&&h<n;)R();y()}catch(I){e.error(I)}}))};return i.subscribe(Tf(e,E,function(){m=!0,y()})),function(){}}function MM(i,e,t){return t===void 0&&(t=1/0),an(e)?MM(function(n,r){return Jf(function(a,o){return e(n,a,r,o)})(Nu(i(n,r)))},t):(typeof e=="number"&&(t=e),Du(function(n,r){return V2(n,r,i,t)}))}function K2(i){return MM(vM,i)}function H2(){return K2(1)}function bk(){for(var i=[],e=0;e<arguments.length;e++)i[e]=arguments[e];return H2()(q2(i,pM(i)))}function Yf(){for(var i=[],e=0;e<arguments.length;e++)i[e]=arguments[e];var t=pM(i);return Du(function(n,r){(t?bk(i,n,t):bk(i,n)).subscribe(r)})}var G2="lk";function PM(i){return typeof i>"u"?!1:z2(i)||W2(i)}function z2(i){var e;return i?i.hasOwnProperty("participant")&&i.hasOwnProperty("source")&&i.hasOwnProperty("track")&&typeof((e=i.publication)==null?void 0:e.track)<"u":!1}function W2(i){return i?i.hasOwnProperty("participant")&&i.hasOwnProperty("source")&&i.hasOwnProperty("publication")&&typeof i.publication<"u":!1}var J2=[te.ConnectionStateChanged,te.RoomMetadataChanged,te.ActiveSpeakersChanged,te.ConnectionQualityChanged,te.ParticipantConnected,te.ParticipantDisconnected,te.ParticipantPermissionsChanged,te.ParticipantMetadataChanged,te.ParticipantNameChanged,te.ParticipantAttributesChanged,te.TrackMuted,te.TrackUnmuted,te.TrackPublished,te.TrackUnpublished,te.TrackStreamStateChanged,te.TrackSubscriptionFailed,te.TrackSubscriptionPermissionChanged,te.TrackSubscriptionStatusChanged],Y2=[...J2,te.LocalTrackPublished,te.LocalTrackUnpublished];ae.TrackPublished,ae.TrackUnpublished,ae.TrackMuted,ae.TrackUnmuted,ae.TrackStreamStateChanged,ae.TrackSubscribed,ae.TrackUnsubscribed,ae.TrackSubscriptionPermissionChanged,ae.TrackSubscriptionFailed,ae.LocalTrackPublished,ae.LocalTrackUnpublished;var $2=[ae.ConnectionQualityChanged,ae.IsSpeakingChanged,ae.ParticipantMetadataChanged,ae.ParticipantPermissionsChanged,ae.TrackMuted,ae.TrackUnmuted,ae.TrackPublished,ae.TrackUnpublished,ae.TrackStreamStateChanged,ae.TrackSubscriptionFailed,ae.TrackSubscriptionPermissionChanged,ae.TrackSubscriptionStatusChanged];[...$2,ae.LocalTrackPublished,ae.LocalTrackUnpublished];var Vn=o2.getLogger("lk-components-js");Vn.setDefaultLevel("WARN");var X2=(i=>(i.AgentState="lk.agent.state",i.PublishOnBehalf="lk.publish_on_behalf",i.TranscriptionFinal="lk.transcription_final",i.TranscriptionSegmentId="lk.segment_id",i.TranscribedTrackId="lk.transcribed_track_id",i))(X2||{});function Q2(i){return typeof i=="object"}function Jq(i){return Array.isArray(i)&&i.filter(Q2).length>0}function Z2(i){return`${G2}-${i}`}function eq(i){const e=Uy(i),t=iq(i.participant).pipe(Jf(()=>Uy(i)),Yf(e));return{className:Z2(i.source===se.Source.Camera||i.source===se.Source.ScreenShare?"participant-media-video":"participant-media-audio"),trackObserver:t}}function Uy(i){if(PM(i))return i.publication;{const{source:e,name:t,participant:n}=i;if(e&&t)return n.getTrackPublications().find(r=>r.source===e&&r.trackName===t);if(t)return n.getTrackPublicationByName(t);if(e)return n.getTrackPublication(e);throw new Error("At least one of source and name needs to be defined")}}function tq(i,...e){return new vi(t=>{const n=()=>{t.next(i)};return e.forEach(r=>{i.on(r,n)}),()=>{e.forEach(r=>{i.off(r,n)})}}).pipe(Yf(i))}function nq(i,...e){return new vi(t=>{const n=()=>{t.next(i)};return e.forEach(r=>{i.on(r,n)}),()=>{e.forEach(r=>{i.off(r,n)})}}).pipe(Yf(i))}function iq(i){return nq(i,ae.TrackMuted,ae.TrackUnmuted,ae.ParticipantPermissionsChanged,ae.TrackPublished,ae.TrackUnpublished,ae.LocalTrackPublished,ae.LocalTrackUnpublished,ae.MediaDevicesError,ae.TrackSubscriptionStatusChanged).pipe(Jf(e=>{const{isMicrophoneEnabled:t,isCameraEnabled:n,isScreenShareEnabled:r}=e,a=e.getTrackPublication(se.Source.Microphone),o=e.getTrackPublication(se.Source.Camera);return{isCameraEnabled:n,isMicrophoneEnabled:t,isScreenShareEnabled:r,cameraTrack:o,microphoneTrack:a,participant:e}}))}function rq(){return{className:"lk-room-container"}}function Sk(i,e,t=!0){const n=[i.localParticipant,...Array.from(i.remoteParticipants.values())],r=[];return n.forEach(a=>{e.forEach(o=>{const c=Array.from(a.trackPublications.values()).filter(d=>d.source===o&&(!t||d.track)).map(d=>({participant:a,publication:d,source:d.source}));r.push(...c)})}),{trackReferences:r,participants:n}}function Yq(i,e,t){var n,r;const a=(n=t.additionalRoomEvents)!=null?n:Y2,o=(r=t.onlySubscribed)!=null?r:!0,c=Array.from(new Set([te.ParticipantConnected,te.ParticipantDisconnected,te.ConnectionStateChanged,te.LocalTrackPublished,te.LocalTrackUnpublished,te.TrackPublished,te.TrackUnpublished,te.TrackSubscriptionStatusChanged,...a]).values());return tq(i,...c).pipe(Jf(d=>{const h=Sk(d,e,o);return Vn.debug(`TrackReference[] was updated. (length ${h.trackReferences.length})`,h),h}),Yf(Sk(i,e,o)))}_e.createContext(void 0);const aq=_e.createContext(void 0);function sq(){return _e.useContext(aq)}function AM(i){const e=sq(),t=i??e;if(!t)throw new Error("No TrackRef, make sure you are inside a TrackRefContext or pass the TrackRef explicitly");return t}_e.createContext(void 0);const DM=_e.createContext(void 0);function oq(){return _e.useContext(DM)}function $q(i){const e=oq(),t=i??e;if(!t)throw new Error("No room provided, make sure you are inside a Room context or pass the room explicitly");return t}_e.createContext(void 0);const lq=_e.createContext(void 0);function NM(i){var e,t,n="";if(typeof i=="string"||typeof i=="number")n+=i;else if(typeof i=="object")if(Array.isArray(i)){var r=i.length;for(e=0;e<r;e++)i[e]&&(t=NM(i[e]))&&(n&&(n+=" "),n+=t)}else for(t in i)i[t]&&(n&&(n+=" "),n+=t);return n}function cq(){for(var i,e,t=0,n="",r=arguments.length;t<r;t++)(i=arguments[t])&&(e=NM(i))&&(n&&(n+=" "),n+=e);return n}function uq(...i){return(...e)=>{for(const t of i)if(typeof t=="function")try{t(...e)}catch(n){console.error(n)}}}function xM(...i){const e={...i[0]};for(let t=1;t<i.length;t++){const n=i[t];for(const r in n){const a=e[r],o=n[r];typeof a=="function"&&typeof o=="function"&&r[0]==="o"&&r[1]==="n"&&r.charCodeAt(2)>=65&&r.charCodeAt(2)<=90?e[r]=uq(a,o):(r==="className"||r==="UNSAFE_className")&&typeof a=="string"&&typeof o=="string"?e[r]=cq(a,o):e[r]=o!==void 0?o:a}}return e}function dq(i){return i!==void 0}function hq(...i){return xM(...i.filter(dq))}function fq(i,e){return i==="processor"&&e&&typeof e=="object"&&"name"in e?e.name:i==="e2ee"&&e?"e2ee-enabled":e}const vq={connect:!0,audio:!1,video:!1};function mq(i){const{token:e,serverUrl:t,options:n,room:r,connectOptions:a,connect:o,audio:c,video:d,screen:h,onConnected:v,onDisconnected:m,onError:y,onMediaDeviceFailure:E,onEncryptionError:T,simulateParticipants:S,...O}={...vq,...i};n&&r&&Vn.warn("when using a manually created room, the options object will be ignored. set the desired options directly when creating the room instead.");const[R,I]=_e.useState(),M=_e.useRef(o);_e.useEffect(()=>{I(r??new yl(n))},[r,JSON.stringify(n,fq)]);const C=_e.useMemo(()=>{const{className:k}=rq();return xM(O,{className:k})},[O]);return _e.useEffect(()=>{if(!R)return;const k=()=>{const j=R.localParticipant;Vn.debug("trying to publish local tracks"),Promise.all([j.setMicrophoneEnabled(!!c,typeof c!="boolean"?c:void 0),j.setCameraEnabled(!!d,typeof d!="boolean"?d:void 0),j.setScreenShareEnabled(!!h,typeof h!="boolean"?h:void 0)]).catch(K=>{Vn.warn(K),y?.(K)})},_=(j,K)=>{const Z=Su.getFailure(j);E?.(Z,K)},P=j=>{T?.(j)},x=j=>{m?.(j)},U=()=>{v?.()};return R.on(te.SignalConnected,k).on(te.MediaDevicesError,_).on(te.EncryptionError,P).on(te.Disconnected,x).on(te.Connected,U),()=>{R.off(te.SignalConnected,k).off(te.MediaDevicesError,_).off(te.EncryptionError,P).off(te.Disconnected,x).off(te.Connected,U)}},[R,c,d,h,y,T,E,v,m]),_e.useEffect(()=>{if(R){if(S){R.simulateParticipants({participants:{count:S},publish:{audio:!0,useRealTracks:!0}});return}if(o){if(M.current=!0,Vn.debug("connecting"),!e){Vn.debug("no token yet");return}if(!t){Vn.warn("no livekit url provided"),y?.(Error("no livekit url provided"));return}R.connect(t,e,a).catch(k=>{Vn.warn(k),M.current===!0&&y?.(k)})}else Vn.debug("disconnecting because connect is false"),M.current=!1,R.disconnect()}},[o,e,JSON.stringify(a),R,y,t,S]),_e.useEffect(()=>{if(R)return()=>{Vn.info("disconnecting on onmount"),R.disconnect()}},[R]),{room:R,htmlProps:C}}const Xq=_e.forwardRef(function(i,e){const{room:t,htmlProps:n}=mq(i);return _e.createElement("div",{ref:e,...n},t&&_e.createElement(DM.Provider,{value:t},_e.createElement(lq.Provider,{value:i.featureFlags},i.children)))});function LM(i,e={}){const[t,n]=_e.useState(Uy(i)),[r,a]=_e.useState(t?.isMuted),[o,c]=_e.useState(t?.isSubscribed),[d,h]=_e.useState(t?.track),[v,m]=_e.useState("landscape"),y=_e.useRef(),{className:E,trackObserver:T}=_e.useMemo(()=>eq(i),[i.participant.sid??i.participant.identity,i.source,PM(i)&&i.publication.trackSid]);return _e.useEffect(()=>{const S=T.subscribe(O=>{Vn.debug("update track",O),n(O),a(O?.isMuted),c(O?.isSubscribed),h(O?.track)});return()=>S?.unsubscribe()},[T]),_e.useEffect(()=>{var S,O;return d&&(y.current&&d.detach(y.current),(S=e.element)!=null&&S.current&&!(i.participant.isLocal&&d?.kind==="audio")&&d.attach(e.element.current)),y.current=(O=e.element)==null?void 0:O.current,()=>{y.current&&d?.detach(y.current)}},[d,e.element]),_e.useEffect(()=>{var S,O;if(typeof((S=t?.dimensions)==null?void 0:S.width)=="number"&&typeof((O=t?.dimensions)==null?void 0:O.height)=="number"){const R=t.dimensions.width>t.dimensions.height?"landscape":"portrait";m(R)}},[t]),{publication:t,isMuted:r,isSubscribed:o,track:d,elementProps:hq(e.props,{className:E,"data-lk-local-participant":i.participant.isLocal,"data-lk-source":t?.source,...t?.kind==="video"&&{"data-lk-orientation":v}})}}var fg,Ek;function pq(){if(Ek)return fg;Ek=1;var i="Expected a function",e=NaN,t="[object Symbol]",n=/^\s+|\s+$/g,r=/^[-+]0x[0-9a-f]+$/i,a=/^0b[01]+$/i,o=/^0o[0-7]+$/i,c=parseInt,d=typeof ph=="object"&&ph&&ph.Object===Object&&ph,h=typeof self=="object"&&self&&self.Object===Object&&self,v=d||h||Function("return this")(),m=Object.prototype,y=m.toString,E=Math.max,T=Math.min,S=function(){return v.Date.now()};function O(k,_,P){var x,U,j,K,Z,be,Pe=0,ce=!1,V=!1,Q=!0;if(typeof k!="function")throw new TypeError(i);_=C(_)||0,R(P)&&(ce=!!P.leading,V="maxWait"in P,j=V?E(C(P.maxWait)||0,_):j,Q="trailing"in P?!!P.trailing:Q);function le(ke){var lt=x,He=U;return x=U=void 0,Pe=ke,K=k.apply(He,lt),K}function ve(ke){return Pe=ke,Z=setTimeout(ee,_),ce?le(ke):K}function Te(ke){var lt=ke-be,He=ke-Pe,Ji=_-lt;return V?T(Ji,j-He):Ji}function F(ke){var lt=ke-be,He=ke-Pe;return be===void 0||lt>=_||lt<0||V&&He>=j}function ee(){var ke=S();if(F(ke))return de(ke);Z=setTimeout(ee,Te(ke))}function de(ke){return Z=void 0,Q&&x?le(ke):(x=U=void 0,K)}function pe(){Z!==void 0&&clearTimeout(Z),Pe=0,x=be=U=Z=void 0}function Re(){return Z===void 0?K:de(S())}function Ae(){var ke=S(),lt=F(ke);if(x=arguments,U=this,be=ke,lt){if(Z===void 0)return ve(be);if(V)return Z=setTimeout(ee,_),le(be)}return Z===void 0&&(Z=setTimeout(ee,_)),K}return Ae.cancel=pe,Ae.flush=Re,Ae}function R(k){var _=typeof k;return!!k&&(_=="object"||_=="function")}function I(k){return!!k&&typeof k=="object"}function M(k){return typeof k=="symbol"||I(k)&&y.call(k)==t}function C(k){if(typeof k=="number")return k;if(M(k))return e;if(R(k)){var _=typeof k.valueOf=="function"?k.valueOf():k;k=R(_)?_+"":_}if(typeof k!="string")return k===0?k:+k;k=k.replace(n,"");var P=a.test(k);return P||o.test(k)?c(k.slice(2),P?2:8):r.test(k)?e:+k}return fg=O,fg}var gq=pq();const Tk=cM(gq);function yq(i){const e=_e.useRef(i);e.current=i,_e.useEffect(()=>()=>{e.current()},[])}function bq(i,e=500,t){const n=_e.useRef();yq(()=>{n.current&&n.current.cancel()});const r=_e.useMemo(()=>{const a=Tk(i,e,t),o=(...c)=>a(...c);return o.cancel=()=>{a.cancel()},o.isPending=()=>!!n.current,o.flush=()=>a.flush(),o},[i,e,t]);return _e.useEffect(()=>{n.current=Tk(i,e,t)},[i,e,t]),r}function Sq(i,e,t){const n=((h,v)=>h===v),r=i instanceof Function?i():i,[a,o]=_e.useState(r),c=_e.useRef(r),d=bq(o,e,t);return n(c.current,r)||(d(r),c.current=r),[a,d]}function Eq({threshold:i=0,root:e=null,rootMargin:t="0%",freezeOnceVisible:n=!1,initialIsIntersecting:r=!1,onChange:a}={}){var o;const[c,d]=_e.useState(null),[h,v]=_e.useState(()=>({isIntersecting:r,entry:void 0})),m=_e.useRef();m.current=a;const y=((o=h.entry)==null?void 0:o.isIntersecting)&&n;_e.useEffect(()=>{if(!c||!("IntersectionObserver"in window)||y)return;const S=new IntersectionObserver(O=>{const R=Array.isArray(S.thresholds)?S.thresholds:[S.thresholds];O.forEach(I=>{const M=I.isIntersecting&&R.some(C=>I.intersectionRatio>=C);v({isIntersecting:M,entry:I}),m.current&&m.current(M,I)})},{threshold:i,root:e,rootMargin:t});return S.observe(c),()=>{S.disconnect()}},[c,JSON.stringify(i),e,t,y,n]);const E=_e.useRef(null);_e.useEffect(()=>{var S;!c&&(S=h.entry)!=null&&S.target&&!n&&!y&&E.current!==h.entry.target&&(E.current=h.entry.target,v({isIntersecting:r,entry:void 0}))},[c,h.entry,n,y,r]);const T=[d,!!h.isIntersecting,h.entry];return T.ref=T[0],T.isIntersecting=T[1],T.entry=T[2],T}const Qq=_e.forwardRef(function({onTrackClick:i,onClick:e,onSubscriptionStatusChanged:t,trackRef:n,manageSubscription:r,...a},o){const c=AM(n),d=_e.useRef(null);_e.useImperativeHandle(o,()=>d.current);const h=Eq({root:d.current}),[v]=Sq(h,3e3);_e.useEffect(()=>{r&&c.publication instanceof pf&&v?.isIntersecting===!1&&h?.isIntersecting===!1&&c.publication.setSubscribed(!1)},[v,c,r]),_e.useEffect(()=>{r&&c.publication instanceof pf&&h?.isIntersecting===!0&&c.publication.setSubscribed(!0)},[h,c,r]);const{elementProps:m,publication:y,isSubscribed:E}=LM(c,{element:d,props:a});_e.useEffect(()=>{t?.(!!E)},[E,t]);const T=S=>{e?.(S),i?.({participant:c?.participant,track:y})};return _e.createElement("video",{ref:d,...m,muted:!0,onClick:T})}),Zq=_e.forwardRef(function({trackRef:i,onSubscriptionStatusChanged:e,volume:t,...n},r){const a=AM(i),o=_e.useRef(null);_e.useImperativeHandle(r,()=>o.current);const{elementProps:c,isSubscribed:d,track:h,publication:v}=LM(a,{element:o,props:n});return _e.useEffect(()=>{e?.(!!d)},[d,e]),_e.useEffect(()=>{h===void 0||t===void 0||(h instanceof rM?h.setVolume(t):Vn.warn("Volume can only be set on remote audio tracks."))},[t,h]),_e.useEffect(()=>{v===void 0||n.muted===void 0||(v instanceof pf?v.setEnabled(!n.muted):Vn.warn("Can only call setEnabled on remote track publications."))},[n.muted,v,h]),_e.createElement("audio",{ref:o,...c})});export{An as $,lN as A,pw as B,ye as C,Iu as D,wq as E,IL as F,CC as G,ge as H,DL as I,me as J,Ne as K,Ow as L,Dr as M,$q as N,Q2 as O,ae as P,Yq as Q,iU as R,yf as S,se as T,ci as U,HN as V,Fq as W,Vn as X,Jq as Y,X2 as Z,QD as _,oU as a,Yr as a$,Wf as a0,fq as a1,zq as a2,mf as a3,ue as a4,iM as a5,QO as a6,Qq as a7,hF as a8,ct as a9,Tq as aA,Mq as aB,A as aC,b as aD,kq as aE,Rq as aF,ox as aG,ab as aH,ln as aI,$ as aJ,xs as aK,he as aL,Of as aM,sI as aN,RL as aO,Cl as aP,hr as aQ,Nq as aR,At as aS,Pq as aT,px as aU,Wc as aV,wf as aW,Dq as aX,Aq as aY,xq as aZ,ks as a_,Ds as aa,Ss as ab,gx as ac,Ct as ad,De as ae,Mg as af,Qe as ag,Su as ah,cl as ai,Eu as aj,Nb as ak,Sy as al,WB as am,pg as an,Ns as ao,Ke as ap,at as aq,eN as ar,Hq as as,ot as at,Zq as au,oF as av,Vq as aw,Kq as ax,qq as ay,Xq as az,jq as b,LC as b0,sx as b1,Lq as b2,Uq as b3,et as b4,ul as b5,cx as b6,Dy as c,Kj as d,oM as e,Hj as f,Cf as g,Dj as h,zj as i,_q as j,Wq as k,D as l,G as m,Et as n,Ko as o,en as p,eU as q,_e as r,Fa as s,te as t,yl as u,ry as v,Ot as w,gb as x,ZL as y,rb as z};
//# sourceMappingURL=components-DuRBtGp8-CIFCdUyg.js.map
