{"version":3,"file":"popout-CQP4VAD4.js","sources":["../../src/popout.tsx"],"sourcesContent":["/*\nSPDX-License-Identifier: AGPL-3.0-only\n*/\n\n// We need to import this somewhere, once, so that the correct 'request'\n// function gets set. It needs to be not in the same file as we use\n// createClient, or the typescript transpiler gets confused about\n// dependency references.\nimport \"matrix-js-sdk/lib/browser-index\";\n\nimport { StrictMode, Suspense, useCallback, useEffect, useState, useRef } from \"react\";\nimport { createRoot } from \"react-dom/client\";\nimport { useSearchParams } from \"react-router-dom\";\nimport { logger } from \"matrix-js-sdk/lib/logger\";\nimport { VideoTrack, TrackReference, LiveKitRoom } from \"@livekit/components-react\";\nimport { RemoteParticipant, RemoteTrackPublication, Room as LivekitRoom } from \"livekit-client\";\nimport { debounce } from \"lodash-es\";\nimport { Initializer } from \"./initializer\";\nimport { SFUConfig } from \"./livekit/openIDSFU\";\n\nlogger.info(`Element Call popout ${import.meta.env.VITE_APP_VERSION || \"dev\"}`);\n\nconst root = createRoot(document.getElementById(\"root\")!);\n\nlet fatalError: Error | null = null;\n\nif (!window.isSecureContext) {\n  fatalError = new Error(\n    \"This app cannot run in an insecure context. To fix this, access the app \" +\n      \"via a local loopback address, or serve it over HTTPS.\\n\" +\n      \"https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts\",\n  );\n} else if (!navigator.mediaDevices) {\n  fatalError = new Error(\"Your browser does not support WebRTC.\");\n}\n\nif (fatalError !== null) {\n  root.render(fatalError.message);\n  throw fatalError; // Stop the app early\n}\n\nconst StyledVideoTrack = VideoTrack;\n//styled(VideoTrack, { shouldForwardProp: (prop) => prop !== 'height' })<{\n//  height: number | string;\n//}>(({ height }) => ({\n//  height,\n//  width: '100%',\n//}));\n\nconst params = new URLSearchParams(document.location.search);\n//const accessToken = params.get(\"accessToken\");\nconst mediaType = params.get(\"mediaType\");\nconst participantId = params.get(\"participantId\");\nconst displayName = params.get(\"displayName\");\n//const livekitUrl = params.get(\"livekitUrl\");\n\nconst Room = () => {\n  const [videoTrack, setVideoTrack] = useState<RemoteTrackPublication | undefined>();\n  const [participant, setParticipant] = useState<RemoteParticipant | undefined>();\n  const [windowHeight, setWindowHeight] = useState(window.innerHeight);\n  const [roomData, setRoomData] = useState<[LivekitRoom, SFUConfig] | undefined>();\n\n  if (!window.opener) {\n\t  return (<p> No parent window; this only works when opened from an existing call! </p>);\n  }\n\n  const channelRef = useRef<BroadcastChannel | null>(null);\n  useEffect(() => {\n    const channel = new window.opener.BroadcastChannel(\"popout-token-request\");\n    channelRef.current = channel;\n\n\tchannel.onmessage = event => {\n      logger.info(\"event received\", event);\n\t  if (event.data.type !== \"popout_token\") {\n\t\t  return;\n\t  }\n\n\t  const sfu = event.data.sfuConfig;\n\t  let room = new LivekitRoom();\n\t  room.connect(sfu.url, sfu.jwt).then(() => setRoomData([room, sfu]));\n\t}\n\n\tchannel.postMessage({ type: \"popout_token_request\" });\n\n\treturn () => { channel.close() }\n  }, []);\n\n  useEffect(() => {\n    let timeout = 0;\n    if (videoTrack === undefined) {\n      timeout = window.setTimeout(() => {\n        const participant = roomData?.[0].remoteParticipants.get(participantId);\n        setParticipant(participant);\n        const participantVideoTrack = participant?.getTrackPublication(mediaType);\n        setVideoTrack(participantVideoTrack);\n      }, 1000);\n    }\n    return () => {\n      if (timeout != 0) {\n        window.clearTimeout(timeout);\n      }\n    };\n  }, [mediaType, participantId, roomData, videoTrack]);\n\n  const handleResize = useCallback(() => {\n    setWindowHeight(window.innerHeight);\n  }, []);\n\n  useEffect(() => {\n    const debouncedHandleResize = debounce(handleResize);\n\n    debouncedHandleResize();\n    window.addEventListener('resize', debouncedHandleResize);\n    return () => {\n      window.removeEventListener('resize', debouncedHandleResize);\n    };\n  }, [handleResize]);\n\n  if (!roomData || !videoTrack) {\n    return <p> loading.... </p>;\n  }\n\n  const trackReference = {\n    participant: participant,\n    publication: videoTrack,\n    source: mediaType,\n  } as TrackReference;\n\n  const [room, sfu] = roomData;\n\n\n\treturn (\n        <LiveKitRoom room={room} token={sfu.jwt} serverUrl={sfu.url} video={false} audio={false}>\n\t      <StyledVideoTrack muted autoPlay trackRef={trackReference} height={windowHeight} />;\n\t    </LiveKitRoom>\n\t);\n};\n\nroot.render(\n  <StrictMode>\n    <Suspense fallback={<p>Connecting...</p>}>\n      <Room />\n    </Suspense>\n  </StrictMode>,\n);\n"],"names":["logger","root","createRoot","fatalError","StyledVideoTrack","VideoTrack","params","mediaType","participantId","Room","videoTrack","setVideoTrack","useState","participant","setParticipant","windowHeight","setWindowHeight","roomData","setRoomData","jsx","channelRef","useRef","useEffect","channel","event","sfu","room","LivekitRoom","timeout","participantVideoTrack","handleResize","useCallback","debouncedHandleResize","debounce","trackReference","jsxs","LiveKitRoom","StrictMode","Suspense"],"mappings":"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"}