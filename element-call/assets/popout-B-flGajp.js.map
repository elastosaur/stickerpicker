{"version":3,"file":"popout-B-flGajp.js","sources":["../../src/popout.tsx"],"sourcesContent":["/*\nSPDX-License-Identifier: AGPL-3.0-only\n*/\n\n// We need to import this somewhere, once, so that the correct 'request'\n// function gets set. It needs to be not in the same file as we use\n// createClient, or the typescript transpiler gets confused about\n// dependency references.\nimport \"matrix-js-sdk/lib/browser-index\";\n\nimport { StrictMode, Suspense, useCallback, useEffect, useState, use } from \"react\";\nimport { createRoot } from \"react-dom/client\";\nimport { useSearchParams } from \"react-router-dom\";\nimport { logger } from \"matrix-js-sdk/lib/logger\";\nimport { VideoTrack, TrackReference, LiveKitRoom } from \"@livekit/components-react\";\nimport { RemoteParticipant, RemoteTrackPublication, Room as LivekitRoom } from \"livekit-client\";\nimport { debounce } from \"lodash-es\";\nimport { Initializer } from \"./initializer\";\n\nlogger.info(`Element Call popout ${import.meta.env.VITE_APP_VERSION || \"dev\"}`);\n\nconst root = createRoot(document.getElementById(\"root\")!);\n\nlet fatalError: Error | null = null;\n\nif (!window.isSecureContext) {\n  fatalError = new Error(\n    \"This app cannot run in an insecure context. To fix this, access the app \" +\n      \"via a local loopback address, or serve it over HTTPS.\\n\" +\n      \"https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts\",\n  );\n} else if (!navigator.mediaDevices) {\n  fatalError = new Error(\"Your browser does not support WebRTC.\");\n}\n\nif (fatalError !== null) {\n  root.render(fatalError.message);\n  throw fatalError; // Stop the app early\n}\n\nconst StyledVideoTrack = VideoTrack;\n//styled(VideoTrack, { shouldForwardProp: (prop) => prop !== 'height' })<{\n//  height: number | string;\n//}>(({ height }) => ({\n//  height,\n//  width: '100%',\n//}));\n\nconst params = new URLSearchParams(document.location.search);\nconst accessToken = params.get(\"accessToken\");\nconst mediaType = params.get(\"mediaType\");\nconst participantId = params.get(\"participantId\");\nconst livekitUrl = params.get(\"livekitUrl\");\n\nconst room = new LivekitRoom();\nconst connected = room.connect(livekitUrl, accessToken);\n\nconst Room = () => {\n  use(connected);\n\n  const [videoTrack, setVideoTrack] = useState<RemoteTrackPublication | undefined>();\n  const [participant, setParticipant] = useState<RemoteParticipant | undefined>();\n  const [windowHeight, setWindowHeight] = useState(window.innerHeight);\n\n  useEffect(() => {\n    let timeout = 0;\n    if (videoTrack === undefined) {\n      timeout = window.setTimeout(() => {\n        const participant = room.remoteParticipants.get(participantId);\n        setParticipant(participant);\n        const participantVideoTrack = participant?.getTrackPublication(mediaType);\n        setVideoTrack(participantVideoTrack);\n      }, 1000);\n    }\n    return () => {\n      if (timeout != 0) {\n        window.clearTimeout(timeout);\n      }\n    };\n  }, [mediaType, participantId, room, videoTrack]);\n\n  const handleResize = useCallback(() => {\n    setWindowHeight(window.innerHeight);\n  }, []);\n\n  useEffect(() => {\n    const debouncedHandleResize = debounce(handleResize);\n\n    debouncedHandleResize();\n    window.addEventListener('resize', debouncedHandleResize);\n    return () => {\n      window.removeEventListener('resize', debouncedHandleResize);\n    };\n  }, [handleResize]);\n\n  if (videoTrack === undefined) {\n    return <p> loading.... </p>;\n  }\n\n  const trackReference = {\n    participant: participant,\n    publication: videoTrack,\n    source: mediaType,\n  } as TrackReference;\n\n\n\treturn (\n        <LiveKitRoom room={room} token={accessToken} serverUrl={livekitUrl} video={false} audio={false}>\n\t      <StyledVideoTrack muted autoPlay trackRef={trackReference} height={windowHeight} />;\n\t    </LiveKitRoom>\n\t);\n};\n\nroot.render(\n  <StrictMode>\n    <Suspense fallback={<p>Connecting...</p>}>\n      <Room />\n    </Suspense>\n  </StrictMode>,\n);\n"],"names":["logger","root","createRoot","fatalError","StyledVideoTrack","VideoTrack","params","accessToken","mediaType","participantId","livekitUrl","room","LivekitRoom","connected","Room","use","videoTrack","setVideoTrack","useState","participant","setParticipant","windowHeight","setWindowHeight","useEffect","timeout","participantVideoTrack","handleResize","useCallback","debouncedHandleResize","debounce","jsx","trackReference","jsxs","LiveKitRoom","StrictMode","Suspense"],"mappings":"0GAmBAA,EAAO,KAAK,yBAAkE,EAE9E,MAAMC,EAAOC,EAAAA,WAAW,SAAS,eAAe,MAAM,CAAE,EAExD,IAAIC,EAA2B,KAE1B,OAAO,gBAMA,UAAU,eACpBA,EAAa,IAAI,MAAM,uCAAuC,GAN9DA,EAAa,IAAI,MACf;AAAA,sEAAA,EAQJ,GAAIA,IAAe,KACjB,MAAAF,EAAK,OAAOE,EAAW,OAAO,EACxBA,EAGR,MAAMC,EAAmBC,EAQnBC,EAAS,IAAI,gBAAgB,SAAS,SAAS,MAAM,EACrDC,EAAcD,EAAO,IAAI,aAAa,EACtCE,EAAYF,EAAO,IAAI,WAAW,EAClCG,EAAgBH,EAAO,IAAI,eAAe,EAC1CI,EAAaJ,EAAO,IAAI,YAAY,EAEpCK,EAAO,IAAIC,EACXC,EAAYF,EAAK,QAAQD,EAAYH,CAAW,EAEhDO,EAAO,IAAM,CACjBC,EAAAA,IAAIF,CAAS,EAEb,KAAM,CAACG,EAAYC,CAAa,EAAIC,WAAA,EAC9B,CAACC,EAAaC,CAAc,EAAIF,WAAA,EAChC,CAACG,EAAcC,CAAe,EAAIJ,EAAAA,SAAS,OAAO,WAAW,EAEnEK,EAAAA,UAAU,IAAM,CACd,IAAIC,EAAU,EACd,OAAIR,IAAe,SACjBQ,EAAU,OAAO,WAAW,IAAM,CAChC,MAAML,EAAcR,EAAK,mBAAmB,IAAIF,CAAa,EAC7DW,EAAeD,CAAW,EAC1B,MAAMM,EAAwBN,GAAa,oBAAoBX,CAAS,EACxES,EAAcQ,CAAqB,CACrC,EAAG,GAAI,GAEF,IAAM,CACPD,GAAW,GACb,OAAO,aAAaA,CAAO,CAE/B,CACF,EAAG,CAAChB,EAAWC,EAAeE,EAAMK,CAAU,CAAC,EAE/C,MAAMU,EAAeC,EAAAA,YAAY,IAAM,CACrCL,EAAgB,OAAO,WAAW,CACpC,EAAG,CAAA,CAAE,EAYL,GAVAC,EAAAA,UAAU,IAAM,CACd,MAAMK,EAAwBC,EAASH,CAAY,EAEnD,OAAAE,EAAA,EACA,OAAO,iBAAiB,SAAUA,CAAqB,EAChD,IAAM,CACX,OAAO,oBAAoB,SAAUA,CAAqB,CAC5D,CACF,EAAG,CAACF,CAAY,CAAC,EAEbV,IAAe,OACjB,OAAOc,EAAAA,IAAC,KAAE,SAAA,gBAAa,EAGzB,MAAMC,EAAiB,CACrB,YAAAZ,EACA,YAAaH,EACb,OAAQR,CAAA,EAIX,OACOwB,EAAAA,KAACC,EAAA,CAAY,KAAAtB,EAAY,MAAOJ,EAAa,UAAWG,EAAY,MAAO,GAAO,MAAO,GAC1F,SAAA,CAAAoB,EAAAA,IAAC1B,EAAA,CAAiB,MAAK,GAAC,SAAQ,GAAC,SAAU2B,EAAgB,OAAQV,CAAA,CAAc,EAAE,GAAA,EACrF,CAEL,EAEApB,EAAK,OACH6B,EAAAA,IAACI,EAAAA,WAAA,CACC,eAACC,WAAA,CAAS,SAAUL,MAAC,IAAA,CAAE,SAAA,eAAA,CAAa,EAClC,SAAAA,EAAAA,IAAChB,EAAA,CAAA,CAAK,CAAA,CACR,CAAA,CACF,CACF"}