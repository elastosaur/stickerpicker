{"version":3,"file":"popout-DiFdPvvo.js","sources":["../../src/popout.tsx"],"sourcesContent":["/*\nSPDX-License-Identifier: AGPL-3.0-only\n*/\n\n// We need to import this somewhere, once, so that the correct 'request'\n// function gets set. It needs to be not in the same file as we use\n// createClient, or the typescript transpiler gets confused about\n// dependency references.\nimport \"matrix-js-sdk/lib/browser-index\";\n\nimport { StrictMode, useCallback, useEffect, useState } from \"react\";\nimport { createRoot } from \"react-dom/client\";\nimport { useParams } from \"react-router-dom\";\nimport { logger } from \"matrix-js-sdk/lib/logger\";\nimport { VideoTrack, TrackReference, LiveKitRoom } from \"@livekit/components-react\";\nimport { RemoteParticipant, RemoteTrackPublication, Room as LivekitRoom } from \"livekit-client\";\nimport { debounce } from \"lodash-es\";\n\nsetLKLogLevel(\"info\");\nlogger.info(`Element Call popout ${import.meta.env.VITE_APP_VERSION || \"dev\"}`);\n\nconst root = createRoot(document.getElementById(\"root\")!);\n\nlet fatalError: Error | null = null;\n\nif (!window.isSecureContext) {\n  fatalError = new Error(\n    \"This app cannot run in an insecure context. To fix this, access the app \" +\n      \"via a local loopback address, or serve it over HTTPS.\\n\" +\n      \"https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts\",\n  );\n} else if (!navigator.mediaDevices) {\n  fatalError = new Error(\"Your browser does not support WebRTC.\");\n}\n\nif (fatalError !== null) {\n  root.render(fatalError.message);\n  throw fatalError; // Stop the app early\n}\n\nconst StyledVideoTrack = styled(VideoTrack, { shouldForwardProp: (prop) => prop !== 'height' })<{\n  height: number | string;\n}>(({ height }) => ({\n  height,\n  width: '100%',\n}));\n\nconst Room = () => {\n  const { accessToken, mediaType, participantId, livekitUrl } = useParams();\n\n\n  //const publication = \n\n  //const room = todo!();\n\n  const [videoTrack, setVideoTrack] = useState<RemoteTrackPublication | undefined>();\n  const [participant, setParticipant] = useState<RemoteParticipant | undefined>();\n  const [windowHeight, setWindowHeight] = useState(window.innerHeight);\n\n  useEffect(() => {\n    let timeout = 0;\n    if (videoTrack === undefined) {\n      timeout = window.setTimeout(() => {\n        const participant = room.remoteParticipants.get(participantId);\n        setParticipant(participant);\n        const participantVideoTrack = participant?.getTrackPublication(mediaType);\n        setVideoTrack(participantVideoTrack);\n      }, 1000);\n    }\n    return () => {\n      if (timeout != 0) {\n        window.clearTimeout(timeout);\n      }\n    };\n  }, [mediaType, participantId, room, videoTrack]);\n\n  const handleResize = useCallback(() => {\n    setWindowHeight(window.innerHeight);\n  }, []);\n\n  useEffect(() => {\n    const debouncedHandleResize = debounce(handleResize);\n\n    debouncedHandleResize();\n    window.addEventListener('resize', debouncedHandleResize);\n    return () => {\n      window.removeEventListener('resize', debouncedHandleResize);\n    };\n  }, [handleResize]);\n\n  if (videoTrack === undefined) {\n    return <p> loading.... </p>;\n  }\n\n  const trackReference = {\n    participant: participant,\n    publication: videoTrack,\n    source: mediaType,\n  } as TrackReference;\n\n\n\treturn (\n      <LiveKitRoom room={room} token={accessToken} serverUrl={livekitUrl} video={false} audio={false}>\n\t    <StyledVideoTrack muted autoPlay trackRef={trackReference} height={windowHeight} />;\n\t  </LiveKitRoom>\n\t);\n};\n\nInitializer.initBeforeReact()\n  .then(() => {\n    root.render(\n      <StrictMode>\n        <Room />\n      </StrictMode>,\n    );\n  })\n  .catch((e) => {\n    logger.error(\"Failed to initialize app\", e);\n    root.render(e.message);\n  });\n"],"names":["logger","root","createRoot","fatalError","StyledVideoTrack","VideoTrack","prop","height","Room","accessToken","mediaType","participantId","livekitUrl","useParams","videoTrack","setVideoTrack","useState","participant","setParticipant","windowHeight","setWindowHeight","useEffect","timeout","participantVideoTrack","handleResize","useCallback","debouncedHandleResize","debounce","jsx","trackReference","jsxs","LiveKitRoom","StrictMode"],"mappings":"2GAkBA,cAAc,MAAM,EACpBA,EAAO,KAAK,yBAAkE,EAE9E,MAAMC,EAAOC,EAAAA,WAAW,SAAS,eAAe,MAAM,CAAE,EAExD,IAAIC,EAA2B,KAE1B,OAAO,gBAMA,UAAU,eACpBA,EAAa,IAAI,MAAM,uCAAuC,GAN9DA,EAAa,IAAI,MACf;AAAA,sEAAA,EAQJ,GAAIA,IAAe,KACjB,MAAAF,EAAK,OAAOE,EAAW,OAAO,EACxBA,EAGR,MAAMC,EAAmB,OAAOC,EAAY,CAAE,kBAAoBC,GAASA,IAAS,QAAA,CAAU,EAE3F,CAAC,CAAE,OAAAC,MAAc,CAClB,OAAAA,EACA,MAAO,MACT,EAAE,EAEIC,EAAO,IAAM,CACjB,KAAM,CAAE,YAAAC,EAAa,UAAAC,EAAW,cAAAC,EAAe,WAAAC,CAAA,EAAeC,EAAA,EAOxD,CAACC,EAAYC,CAAa,EAAIC,WAAA,EAC9B,CAACC,EAAaC,CAAc,EAAIF,WAAA,EAChC,CAACG,EAAcC,CAAe,EAAIJ,EAAAA,SAAS,OAAO,WAAW,EAEnEK,EAAAA,UAAU,IAAM,CACd,IAAIC,EAAU,EACd,OAAIR,IAAe,SACjBQ,EAAU,OAAO,WAAW,IAAM,CAChC,MAAML,EAAc,KAAK,mBAAmB,IAAIN,CAAa,EAC7DO,EAAeD,CAAW,EAC1B,MAAMM,EAAwBN,GAAa,oBAAoBP,CAAS,EACxEK,EAAcQ,CAAqB,CACrC,EAAG,GAAI,GAEF,IAAM,CACPD,GAAW,GACb,OAAO,aAAaA,CAAO,CAE/B,CACF,EAAG,CAACZ,EAAWC,EAAe,KAAMG,CAAU,CAAC,EAE/C,MAAMU,EAAeC,EAAAA,YAAY,IAAM,CACrCL,EAAgB,OAAO,WAAW,CACpC,EAAG,CAAA,CAAE,EAYL,GAVAC,EAAAA,UAAU,IAAM,CACd,MAAMK,EAAwBC,EAASH,CAAY,EAEnD,OAAAE,EAAA,EACA,OAAO,iBAAiB,SAAUA,CAAqB,EAChD,IAAM,CACX,OAAO,oBAAoB,SAAUA,CAAqB,CAC5D,CACF,EAAG,CAACF,CAAY,CAAC,EAEbV,IAAe,OACjB,OAAOc,EAAAA,IAAC,KAAE,SAAA,gBAAa,EAGzB,MAAMC,EAAiB,CACrB,YAAAZ,EACA,YAAaH,EACb,OAAQJ,CAAA,EAIX,OACKoB,EAAAA,KAACC,EAAA,CAAY,KAAY,MAAOtB,EAAa,UAAWG,EAAY,MAAO,GAAO,MAAO,GAC1F,SAAA,CAAAgB,EAAAA,IAACxB,EAAA,CAAiB,MAAK,GAAC,SAAQ,GAAC,SAAUyB,EAAgB,OAAQV,CAAA,CAAc,EAAE,GAAA,EACrF,CAEH,EAEA,YAAY,gBAAA,EACT,KAAK,IAAM,CACVlB,EAAK,OACH2B,EAAAA,IAACI,EAAAA,WAAA,CACC,eAACxB,EAAA,CAAA,CAAK,CAAA,CACR,CAAA,CAEJ,CAAC,EACA,MAAO,GAAM,CACZR,EAAO,MAAM,2BAA4B,CAAC,EAC1CC,EAAK,OAAO,EAAE,OAAO,CACvB,CAAC"}